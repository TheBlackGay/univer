"use strict";(self.webpackChunk_univerjs_storybook=self.webpackChunk_univerjs_storybook||[]).push([[4883],{"../../packages/engine-formula/src/index.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{hK:()=>FUNCTION_NAMES_MATH,_1:()=>FUNCTION_NAMES_STATISTICAL,OE:()=>FUNCTION_NAMES_TEXT,E1:()=>IActiveDirtyManagerService,ke:()=>IDefinedNamesService,$C:()=>IFunctionService,GM:()=>LexerTreeBuilder,y1:()=>NullValueObject,gE:()=>RemoveDefinedNameMutation,gn:()=>SetDefinedNameMutation,mJ:()=>SetDefinedNameMutationFactory,Yp:()=>SetFormulaCalculationNotificationMutation,Q:()=>SetFormulaCalculationResultMutation,LB:()=>UniverFormulaEnginePlugin,YJ:()=>deserializeRangeWithSheet,YK:()=>deserializeRangeWithSheetWithCache,h9:()=>handleNumfmtInCell,wQ:()=>isReferenceStringWithEffectiveColumn,oB:()=>isReferenceStrings,RD:()=>token_matchToken,gm:()=>operatorToken,kx:()=>sequenceNodeType,oc:()=>serializeRange,jz:()=>serializeRangeWithSheet,d9:()=>stripErrorMargin});var BooleanValue=function(BooleanValue){return BooleanValue.FALSE="FALSE",BooleanValue.TRUE="TRUE",BooleanValue}({}),AstNodePromiseType=function(AstNodePromiseType){return AstNodePromiseType[AstNodePromiseType.SUCCESS=0]="SUCCESS",AstNodePromiseType[AstNodePromiseType.ERROR=1]="ERROR",AstNodePromiseType}({}),ConcatenateType=function(ConcatenateType){return ConcatenateType[ConcatenateType.FRONT=0]="FRONT",ConcatenateType[ConcatenateType.BACK=1]="BACK",ConcatenateType}({}),error_type_ErrorType=function(ErrorType){return ErrorType.DIV_BY_ZERO="#DIV/0!",ErrorType.NAME="#NAME?",ErrorType.VALUE="#VALUE!",ErrorType.NUM="#NUM!",ErrorType.NA="#N/A",ErrorType.CYCLE="#CYCLE!",ErrorType.REF="#REF!",ErrorType.SPILL="#SPILL!",ErrorType.CALC="#CALC!",ErrorType.ERROR="#ERROR!",ErrorType.CONNECT="#GETTING_DATA",ErrorType.NULL="#NULL!",ErrorType}({});const ERROR_TYPE_SET=new Set(Object.values(error_type_ErrorType)),ERROR_TYPE_COUNT_ARRAY=[...new Set(Object.values(error_type_ErrorType).map((error=>error.length)))];var operatorToken=function(operatorToken){return operatorToken.PLUS="+",operatorToken.MINUS="-",operatorToken.MULTIPLY="*",operatorToken.DIVIDED="/",operatorToken.CONCATENATE="&",operatorToken.POWER="^",operatorToken.EQUALS="=",operatorToken.NOT_EQUAL="<>",operatorToken.GREATER_THAN=">",operatorToken.GREATER_THAN_OR_EQUAL=">=",operatorToken.LESS_THAN="<",operatorToken.LESS_THAN_OR_EQUAL="<=",operatorToken}({}),compareToken=function(compareToken){return compareToken.EQUALS="=",compareToken.NOT_EQUAL="<>",compareToken.GREATER_THAN=">",compareToken.GREATER_THAN_OR_EQUAL=">=",compareToken.LESS_THAN="<",compareToken.LESS_THAN_OR_EQUAL="<=",compareToken}({});const OPERATOR_TOKEN_PRIORITY=new Map([["<>",4],["<",4],[">=",4],["=",4],[">",4],["<=",4],["&",3],["+",2],["-",2],["/",1],["*",1],["^",0]]),OPERATOR_TOKEN_SET=new Set(OPERATOR_TOKEN_PRIORITY.keys()),OPERATOR_TOKEN_COMPARE_SET=new Set(["=","<>",">",">=","<","<="]);var token_matchToken=function(matchToken){return matchToken.OPEN_BRACKET="(",matchToken.CLOSE_BRACKET=")",matchToken.COMMA=",",matchToken.SINGLE_QUOTATION="'",matchToken.DOUBLE_QUOTATION='"',matchToken.OPEN_BRACES="{",matchToken.CLOSE_BRACES="}",matchToken.COLON=":",matchToken.OPEN_SQUARE_BRACKET="[",matchToken.CLOSE_SQUARE_BRACKET="]",matchToken}({}),suffixToken=function(suffixToken){return suffixToken.PERCENTAGE="%",suffixToken.POUND="#",suffixToken}({});const SUFFIX_TOKEN_SET=new Set(["%","#"]);var prefixToken=function(prefixToken){return prefixToken.AT="@",prefixToken.MINUS="-",prefixToken.PLUS="+",prefixToken}({});const SPACE_TOKEN=" ",FORMULA_LEXER_TOKENS=[...Object.values(compareToken),...Object.values(operatorToken),...Object.values(token_matchToken),...Object.values(suffixToken),...Object.values(prefixToken)];function isFormulaLexerToken(str){return FORMULA_LEXER_TOKENS.includes(str)}const TOKEN_CANNOT_BE_AT_END_SET=new Set([operatorToken.PLUS,operatorToken.MINUS,operatorToken.MULTIPLY,operatorToken.DIVIDED,operatorToken.CONCATENATE,operatorToken.POWER,operatorToken.EQUALS,operatorToken.NOT_EQUAL,operatorToken.GREATER_THAN,operatorToken.GREATER_THAN_OR_EQUAL,operatorToken.LESS_THAN,operatorToken.LESS_THAN_OR_EQUAL,token_matchToken.OPEN_BRACKET,token_matchToken.COMMA,token_matchToken.COLON,token_matchToken.OPEN_BRACES,token_matchToken.OPEN_SQUARE_BRACKET]);const TOKEN_CANNOT_PRECEDE_SUFFIX_TOKEN_SET=new Set([operatorToken.PLUS,operatorToken.MINUS,operatorToken.MULTIPLY,operatorToken.DIVIDED,operatorToken.CONCATENATE,operatorToken.POWER,operatorToken.EQUALS,operatorToken.NOT_EQUAL,operatorToken.GREATER_THAN,operatorToken.GREATER_THAN_OR_EQUAL,operatorToken.LESS_THAN,operatorToken.LESS_THAN_OR_EQUAL,token_matchToken.OPEN_BRACKET,token_matchToken.COMMA,token_matchToken.COLON,token_matchToken.OPEN_BRACES,token_matchToken.OPEN_SQUARE_BRACKET,suffixToken.PERCENTAGE,suffixToken.POUND]);var src=__webpack_require__("../../packages/core/src/index.ts");function convertRuntimeToUnitData(unitData){const unitPrimitiveData={};for(const unitId in unitData){const sheetData=unitData[unitId];if(null!=sheetData){null==unitPrimitiveData[unitId]&&(unitPrimitiveData[unitId]={});for(const sheetId in sheetData){const cellData=sheetData[sheetId],primitiveData={};cellData.forValue(((row,column,value)=>{void 0===primitiveData[row]&&(primitiveData[row]={}),primitiveData[row][column]=value})),unitPrimitiveData[unitId][sheetId]=primitiveData}}}return unitPrimitiveData}const UNIT_NAME_REGEX='\\[([^\\[\\]\\/?:"<>|*\\\\]+)\\]',UNIT_NAME_REGEX_PRECOMPILING=new RegExp(UNIT_NAME_REGEX),UNIT_NAME_SHEET_NAME_REGEX=`'?(${UNIT_NAME_REGEX})?(((?![\\[\\]\\/?*\\\\]).)*!)?'?`,REFERENCE_MULTIPLE_RANGE_REGEX=`^(${prefixToken.AT})?${UNIT_NAME_SHEET_NAME_REGEX}\\$?[A-Za-z]+\\$?[1-9][0-9]*\\s*?:\\s*?\\$?[A-Za-z]+\\$?[1-9][0-9]*$`,REFERENCE_MULTIPLE_RANGE_REGEX_PRECOMPILING=new RegExp(REFERENCE_MULTIPLE_RANGE_REGEX),REFERENCE_SINGLE_RANGE_REGEX=`^${UNIT_NAME_SHEET_NAME_REGEX}\\s*?\\$?[A-Za-z]+\\$?[1-9][0-9]*(${suffixToken.POUND})?$`,REFERENCE_SINGLE_RANGE_REGEX_PRECOMPILING=new RegExp(REFERENCE_SINGLE_RANGE_REGEX),REFERENCE_REGEX_ROW_PRECOMPILING=new RegExp(`^${UNIT_NAME_SHEET_NAME_REGEX}\\$?[1-9][0-9]*\\s*?:\\s*?\\$?[1-9][0-9]*$`),REFERENCE_REGEX_COLUMN_PRECOMPILING=new RegExp(`^${UNIT_NAME_SHEET_NAME_REGEX}\\$?[A-Za-z]+\\s*?:\\s*?\\$?[A-Za-z]+$`),REFERENCE_REGEX_SINGLE_ROW_PRECOMPILING=new RegExp(`^${UNIT_NAME_SHEET_NAME_REGEX}\\s*?\\$?[1-9][0-9]*$`),REFERENCE_REGEX_SINGLE_COLUMN_PRECOMPILING=new RegExp(`^${UNIT_NAME_SHEET_NAME_REGEX}\\s*?\\$?[A-Za-z]+$`),ARRAY_VALUE_REGEX_PRECOMPILING=(new RegExp("[.*?]","g"),new RegExp("{.*?}","g"));function regexTestSingeRange(token){return REFERENCE_SINGLE_RANGE_REGEX_PRECOMPILING.lastIndex=0,REFERENCE_SINGLE_RANGE_REGEX_PRECOMPILING.test(token)}function regexTestRow(token){return REFERENCE_REGEX_ROW_PRECOMPILING.lastIndex=0,REFERENCE_REGEX_ROW_PRECOMPILING.test(token)}function regexTestColumn(token){return REFERENCE_REGEX_COLUMN_PRECOMPILING.lastIndex=0,REFERENCE_REGEX_COLUMN_PRECOMPILING.test(token)}function regexTestSingleRow(token){return REFERENCE_REGEX_SINGLE_ROW_PRECOMPILING.lastIndex=0,REFERENCE_REGEX_SINGLE_ROW_PRECOMPILING.test(token)}function regexTestSingleColumn(token){return REFERENCE_REGEX_SINGLE_COLUMN_PRECOMPILING.lastIndex=0,REFERENCE_REGEX_SINGLE_COLUMN_PRECOMPILING.test(token)}function isReferenceString(refString){return regexTestSingeRange(refString)||function regexTestMultipleRange(token){return REFERENCE_MULTIPLE_RANGE_REGEX_PRECOMPILING.lastIndex=0,REFERENCE_MULTIPLE_RANGE_REGEX_PRECOMPILING.test(token)}(refString)||regexTestRow(refString)||regexTestColumn(refString)}const RegisterFunctionMutation={id:"formula.mutation.register-function",type:src.g4t.MUTATION,handler:()=>!0},SetArrayFormulaDataMutation={id:"formula.mutation.set-array-formula-data",type:src.g4t.MUTATION,handler:(accessor,params)=>!0};var Subject=__webpack_require__("../../node_modules/.pnpm/rxjs@7.8.1/node_modules/rxjs/dist/esm5/internal/Subject.js");const $ROW_REGEX=/[^0-9]/g,$COLUMN_REGEX=/[^A-Za-z]/g;function getAbsoluteRefTypeWithSingleString(singleRefString){let isColumnAbsolute="$"===singleRefString[0];const remainChar=singleRefString.substring(1);let isRowAbsolute=remainChar.indexOf("$")>-1;return src.S0q.isStringNumber(remainChar)&&isColumnAbsolute&&!isRowAbsolute&&(isColumnAbsolute=!1,isRowAbsolute=!0),isColumnAbsolute&&isRowAbsolute?src.F6v.ALL:isColumnAbsolute?src.F6v.COLUMN:isRowAbsolute?src.F6v.ROW:src.F6v.NONE}function _getAbsoluteToken(absoluteRefType=src.F6v.NONE){let rowAbsoluteString="",columnAbsoluteString="";return absoluteRefType===src.F6v.ROW?rowAbsoluteString="$":absoluteRefType===src.F6v.COLUMN?columnAbsoluteString="$":absoluteRefType===src.F6v.ALL&&(rowAbsoluteString="$",columnAbsoluteString="$"),{rowAbsoluteString,columnAbsoluteString}}function serializeRange(range){const{startColumn,startRow,endColumn,endRow,startAbsoluteRefType,endAbsoluteRefType,rangeType=src.$uV.NORMAL}=range,start=_getAbsoluteToken(startAbsoluteRefType),end=_getAbsoluteToken(endAbsoluteRefType);if(rangeType===src.$uV.ROW||rangeType===src.$uV.ALL){return`${`${start.rowAbsoluteString}${startRow+1}`}:${`${end.rowAbsoluteString}${endRow+1}`}`}if(rangeType===src.$uV.COLUMN){return`${`${start.columnAbsoluteString}${src.S0q.chatAtABC(startColumn)}`}:${`${end.columnAbsoluteString}${src.S0q.chatAtABC(endColumn)}`}`}const startStr=`${start.columnAbsoluteString}${src.S0q.chatAtABC(startColumn)}${start.rowAbsoluteString}${startRow+1}`,endStr=`${end.columnAbsoluteString}${src.S0q.chatAtABC(endColumn)}${end.rowAbsoluteString}${endRow+1}`;return startStr===endStr?startStr:`${startStr}:${endStr}`}function serializeRangeWithSheet(sheetName,range){return`${addQuotesBothSides(sheetName)}!${serializeRange(range)}`}function serializeRangeToRefString(gridRangeName){const{unitId,sheetName,range}=gridRangeName;return null!=unitId&&unitId.length>0&&null!=sheetName&&sheetName.length>0?function serializeRangeWithSpreadsheet(unit,sheetName,range){return needsQuoting(unit)||needsQuoting(sheetName)?`'[${quoteSheetName(unit)}]${quoteSheetName(sheetName)}'!${serializeRange(range)}`:`[${unit}]${sheetName}!${serializeRange(range)}`}(unitId,sheetName,range):null!=sheetName&&sheetName.length>0?serializeRangeWithSheet(sheetName,range):serializeRange(range)}function singleReferenceToGrid(refBody){return{row:Number.parseInt(refBody.replace($ROW_REGEX,""))-1,column:src.S0q.ABCatNum(refBody.replace($COLUMN_REGEX,"")),absoluteRefType:getAbsoluteRefTypeWithSingleString(refBody)}}function handleRefStringInfo(refString){const unitIdMatch=UNIT_NAME_REGEX_PRECOMPILING.exec(refString);let unitId="";null!=unitIdMatch&&(unitId=unitIdMatch[0].trim(),unitId=unquoteSheetName(unitId.slice(1,unitId.length-1)),refString=refString.replace(UNIT_NAME_REGEX_PRECOMPILING,""));const sheetNameIndex=refString.indexOf("!");let sheetName="",refBody="";return sheetNameIndex>-1?(sheetName=refString.substring(0,sheetNameIndex),"'"===sheetName[0]&&"'"===sheetName[sheetName.length-1]&&(sheetName=sheetName.substring(1,sheetName.length-1)),sheetName=unquoteSheetName(sheetName),refBody=refString.substring(sheetNameIndex+1)):refBody=refString,{refBody,sheetName,unitId}}function deserializeRangeWithSheet(refString){const{refBody,sheetName,unitId}=handleRefStringInfo(refString),colonIndex=refBody.indexOf(":");if(-1===colonIndex){const grid=singleReferenceToGrid(refBody),row=grid.row,column=grid.column,absoluteRefType=grid.absoluteRefType;return{unitId,sheetName,range:{startRow:row,startColumn:column,endRow:row,endColumn:column,startAbsoluteRefType:absoluteRefType,endAbsoluteRefType:absoluteRefType}}}const refStartString=refBody.substring(0,colonIndex),refEndString=refBody.substring(colonIndex+1),startGrid=singleReferenceToGrid(refStartString),endGrid=singleReferenceToGrid(refEndString),startRow=startGrid.row>endGrid.row?endGrid.row:startGrid.row,startColumn=startGrid.column>endGrid.column?endGrid.column:startGrid.column,endRow=startGrid.row>endGrid.row?startGrid.row:endGrid.row,endColumn=startGrid.column>endGrid.column?startGrid.column:endGrid.column;let rangeType=src.$uV.NORMAL;return Number.isNaN(startRow)&&Number.isNaN(endRow)?rangeType=src.$uV.COLUMN:Number.isNaN(startColumn)&&Number.isNaN(endColumn)&&(rangeType=src.$uV.ROW),{unitId,sheetName,range:{startRow,startColumn,endRow,endColumn,startAbsoluteRefType:startGrid.absoluteRefType,endAbsoluteRefType:endGrid.absoluteRefType,rangeType}}}const EXCEPTION_REF_STRINGS=["LOG10"];function isReferenceStringWithEffectiveColumn(refString){const noPrefixRefString=replaceRefPrefixString(refString);if(!isReferenceString(noPrefixRefString))return!1;if(EXCEPTION_REF_STRINGS.includes(noPrefixRefString.toUpperCase().trim()))return!1;const{range}=deserializeRangeWithSheet(noPrefixRefString);return!(range.endColumn>=16384)}function replaceRefPrefixString(token){const tokenArray=[];let isNotPreFix=!1;for(let i=0,len=token.length;i<len;i++){const char=token[i];if(char!==SPACE_TOKEN||isNotPreFix){if(!(isNotPreFix||char!==prefixToken.AT&&char!==prefixToken.MINUS&&char!==prefixToken.PLUS))continue;tokenArray.push(char),isNotPreFix=!0}else tokenArray.push(char)}return tokenArray.join("")}function isReferenceStrings(refString){return(refString?.split(",")||[]).every((refString=>isReferenceStringWithEffectiveColumn(refString.trim())))}function needsQuoting(name){return 0!==name.length&&(!!function includeFormulaLexerToken(str){for(const token of FORMULA_LEXER_TOKENS)if(str.indexOf(token)>-1)return!0;return!1}(name)||(!(!function isA1Notation(name){const match=name.match(/[1-9][0-9]{0,6}/);return/^[A-Z]+[1-9][0-9]{0,6}$/.test(name)&&null!==match}(name)&&!function isR1C1Notation(name){return/^(R(-?[0-9]+)?C(-?[0-9]+)?|C(-?[0-9]+)?|R(-?[0-9]+)?)$/.test(name)}(name))||(!!function startsWithNonAlphabetic(name){return!/^\p{Letter}/u.test(name.charAt(0))}(name)||!!/[\s!$%^&*()+\-=\[\]{};':"\\|,.<>\/?（）]/.test(name))))}function addQuotesBothSides(name){return needsQuoting(name)?`'${quoteSheetName(name)}'`:name}function quoteSheetName(name){return name.replace(/'/g,"''")}function unquoteSheetName(name){return name.replace(/''/g,"'")}function _ts_metadata(k,v){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(k,v)}class DefinedNamesService extends src.jGt{constructor(_univerInstanceService){super(),this._univerInstanceService=_univerInstanceService,this._definedNameMap={},this._nameCacheMap={},this._update$=new Subject.B,this.update$=this._update$.asObservable(),this._currentRange={unitId:"",sheetId:"",range:{startRow:0,endRow:0,startColumn:0,endColumn:0}},this._currentRange$=new Subject.B,this.currentRange$=this._currentRange$.asObservable(),this._focusRange$=new Subject.B,this.focusRange$=this._focusRange$.asObservable()}dispose(){super.dispose(),this._definedNameMap={},this._nameCacheMap={},this._update$.complete(),this._currentRange$.complete(),this._focusRange$.complete()}getWorksheetByRef(unitId,ref){const{sheetName}=handleRefStringInfo(ref);return this._univerInstanceService.getUnit(unitId)?.getSheetBySheetName(sheetName)}focusRange(unitId,id){const item=this.getValueById(unitId,id);void 0!==item&&this._focusRange$.next({...item,unitId})}setCurrentRange(range){this._currentRange=range,this._currentRange$.next(range)}getCurrentRange(){return this._currentRange}getCurrentRangeForString(){return serializeRange(this._currentRange.range)}registerDefinedNames(unitId,params){this._definedNameMap[unitId]=params,this._updateCache(unitId),this._update()}registerDefinedName(unitId,param){void 0===this._definedNameMap[unitId]&&(this._definedNameMap[unitId]={}),this._definedNameMap[unitId][param.id]=param,this._updateCache(unitId),this._update()}removeDefinedName(unitId,id){delete this._definedNameMap[unitId]?.[id],this._updateCache(unitId),this._update()}removeUnitDefinedName(unitId){delete this._definedNameMap[unitId],this._updateCache(unitId),this._update()}getDefinedNameMap(unitId){return this._definedNameMap[unitId]}getValueByName(unitId,name){const cachedMap=this._nameCacheMap[unitId];if(cachedMap)return cachedMap[name]||null;const nameMap=this._definedNameMap[unitId];if(void 0===nameMap)return null;let result=null;for(const item of Object.values(nameMap))if(item.name===name){result=item;break}return result&&(this._nameCacheMap[unitId]=this._nameCacheMap[unitId]||{},this._nameCacheMap[unitId][name]=result),result}getValueById(unitId,id){return this._definedNameMap[unitId]?.[id]}hasDefinedName(unitId){if(void 0===this._definedNameMap[unitId])return!1;return 0!==(Array.from(Object.values(this._definedNameMap[unitId])).length||0)}_update(){this._update$.next(null)}_updateCache(unitId){const nameMap=this._definedNameMap[unitId];if(void 0!==nameMap){this._nameCacheMap[unitId]={};for(const item of Object.values(nameMap))this._nameCacheMap[unitId][item.name]=item}else delete this._nameCacheMap[unitId]}}DefinedNamesService=function _ts_decorate(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r}([function _ts_param(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}}(0,src.HCr),_ts_metadata("design:type",Function),_ts_metadata("design:paramtypes",[void 0===src.HCr?Object:src.HCr])],DefinedNamesService);const IDefinedNamesService=(0,src.Qmd)("univer.formula.defined-names.service"),SetDefinedNameMutationFactory=(accessor,params)=>{const{unitId,id}=params;return{...accessor.get(IDefinedNamesService).getValueById(unitId,id),unitId}},SetDefinedNameMutation={id:"formula.mutation.set-defined-name",type:src.g4t.MUTATION,handler:(accessor,params)=>{if(null==params)return!1;const definedNamesService=accessor.get(IDefinedNamesService),{id,unitId,name,formulaOrRefString,comment,hidden,localSheetId}=params;return definedNamesService.registerDefinedName(unitId,{id,name:name.trim(),formulaOrRefString:formulaOrRefString.trim(),comment:comment?.trim(),hidden,localSheetId}),!0}},RemoveDefinedNameMutation={id:"formula.mutation.remove-defined-name",type:src.g4t.MUTATION,handler:(accessor,params)=>{if(null==params)return!1;const definedNamesService=accessor.get(IDefinedNamesService),{unitId,id}=params;return definedNamesService.removeDefinedName(unitId,id),!0}},SetFeatureCalculationMutation={id:"formula.mutation.set-feature-calculation",type:src.g4t.MUTATION,handler:()=>!0},RemoveFeatureCalculationMutation={id:"formula.mutation.remove-feature-calculation",type:src.g4t.MUTATION,handler:()=>!0},SetFormulaCalculationStartMutation={id:"formula.mutation.set-formula-calculation-start",type:src.g4t.MUTATION,handler:()=>!0},SetFormulaCalculationStopMutation={id:"formula.mutation.set-formula-calculation-stop",type:src.g4t.MUTATION,handler:()=>!0},SetFormulaCalculationNotificationMutation={id:"formula.mutation.set-formula-calculation-notification",type:src.g4t.MUTATION,handler:()=>!0},SetFormulaCalculationResultMutation={id:"formula.mutation.set-formula-calculation-result",type:src.g4t.MUTATION,handler:()=>!0},SetFormulaDataMutation={id:"formula.mutation.set-formula-data",type:src.g4t.MUTATION,handler:(accessor,params)=>!0},SetOtherFormulaMutation={id:"formula.mutation.set-other-formula",type:src.g4t.MUTATION,handler:()=>!0},RemoveOtherFormulaMutation={id:"formula.mutation.remove-other-formula",type:src.g4t.MUTATION,handler:()=>!0},SetSuperTableMutation={id:"formula.mutation.set-super-table",type:src.g4t.MUTATION,handler:()=>!0},RemoveSuperTableMutation={id:"formula.mutation.remove-super-table",type:src.g4t.MUTATION,handler:()=>!0},SetSuperTableOptionMutation={id:"formula.mutation.set-super-table-option",type:src.g4t.MUTATION,handler:()=>!0};class FormulaAstLRU{constructor(cacheCount){this._cache=new src.GcK(cacheCount)}set(formulaString,node){const hash=this._hash(formulaString);this._cache.set(hash,node)}get(formulaString){const hash=this._hash(formulaString);return this._cache.get(hash)}clear(){this._cache.clear()}delete(formulaString){this._cache.delete(this._hash(formulaString))}forEach(callbackfn,thisArg){this._cache.forEach(callbackfn,thisArg)}_hash(formulaString){return formulaString.length<=64?formulaString:(0,src.iFT)(formulaString).toString()}}const FORCED_RECALCULATION_FUNCTION_NAME=new Set(["RAND","RANDBETWEEN","NOW","TODAY"]),referenceToRangeCache=new FormulaAstLRU(1e5);function deserializeRangeWithSheetWithCache(refString){const refCache=referenceToRangeCache.get(refString);if(refCache)return refCache;const result=deserializeRangeWithSheet(refString);return referenceToRangeCache.set(refString,result),deserializeRangeWithSheet(refString)}var sequenceNodeType=function(sequenceNodeType){return sequenceNodeType[sequenceNodeType.NORMAL=0]="NORMAL",sequenceNodeType[sequenceNodeType.NUMBER=1]="NUMBER",sequenceNodeType[sequenceNodeType.STRING=2]="STRING",sequenceNodeType[sequenceNodeType.FUNCTION=3]="FUNCTION",sequenceNodeType[sequenceNodeType.REFERENCE=4]="REFERENCE",sequenceNodeType[sequenceNodeType.ARRAY=5]="ARRAY",sequenceNodeType[sequenceNodeType.DEFINED_NAME=6]="DEFINED_NAME",sequenceNodeType}({});function generateStringWithSequence(newSequenceNodes){let sequenceString="";for(const node of newSequenceNodes)sequenceString+="string"==typeof node?node:node.token;return sequenceString}class LexerNode{dispose(){this._children.forEach((node=>{"string"!=typeof node&&node.dispose()})),this._functionDefinitionPrivacyVar?.clear(),this._functionDefinitionPrivacyVar=null,this._children=[],this._parent=null,this._definedNames=[]}getDefinedNames(){return this._definedNames}getStartIndex(){return this._startIndex}getLambdaId(){return this._lambdaId}setLambdaId(lambdaId){this._lambdaId=lambdaId}getFunctionDefinitionPrivacyVar(){return this._functionDefinitionPrivacyVar}setLambdaPrivacyVar(lambdaPrivacyVar){this._functionDefinitionPrivacyVar=lambdaPrivacyVar}getLambdaParameter(){return this._lambdaParameter}setLambdaParameter(lambdaParameter){this._lambdaParameter=lambdaParameter}getParent(){return this._parent}setParent(lexerNode){this._parent=lexerNode}getChildren(){return this._children}setChildren(children){this._children=children}addChildren(children){this._children.push(children)}addChildrenFirst(children){this._children.unshift(children)}getToken(){return this._token}setToken(token){this._token=token}setIndex(st,ed){this._startIndex=st,this._endIndex=ed}setDefinedNames(definedNames){this._definedNames=definedNames}hasDefinedNames(){return this._definedNames.length>0}replaceChild(lexerNode,newLexerNode){const i=this._getIndexInParent(lexerNode);null!=i&&(this.getChildren().splice(i,1,newLexerNode),newLexerNode.setParent(this))}changeToParent(newParentLexerNode){const parentNode=this.getParent();parentNode&&parentNode.removeChild(this),this.setParent(newParentLexerNode);newParentLexerNode.getChildren().push(this)}removeChild(lexerNode){const i=this._getIndexInParent(lexerNode);null!=i&&this.getChildren().splice(i,1)}serialize(){const token=this.getToken(),children=this.getChildren(),childrenSerialization=[],childrenCount=children.length;for(let i=0;i<childrenCount;i++){const item=children[i];item instanceof LexerNode?childrenSerialization.push(item.serialize()):childrenSerialization.push(item)}return{token,st:this._startIndex,ed:this._endIndex,children:childrenSerialization}}_getIndexInParent(lexerNode){const childrenNode=this.getChildren(),childrenCount=childrenNode.length;for(let i=0;i<childrenCount;i++){if(childrenNode[i]===lexerNode)return i}}constructor(){this._token="R_1",this._children=[],this._lambdaParameter="",this._startIndex=-1,this._endIndex=-1,this._definedNames=[]}}const FormulaLexerNodeCache=new FormulaAstLRU(2e3),FormulaSequenceNodeCache=new FormulaAstLRU(2e3);class LexerTreeBuilder extends src.jGt{dispose(){this._resetTemp(),this._currentLexerNode.dispose(),FormulaLexerNodeCache.clear(),FormulaSequenceNodeCache.clear()}getUpLevel(){return this._upLevel}isColonClose(){return!1===this._colonState}isColonOpen(){return!0===this._colonState}isDoubleQuotationClose(){return 0===this._doubleQuotationState}isLambdaOpen(){return!0===this._lambdaState}isLambdaClose(){return!1===this._lambdaState}isSingleQuotationClose(){return 0===this._singleQuotationState}isBracesClose(){return 0===this._bracesState}isBracketClose(){return 0===this._bracketState.length}isSquareBracketClose(){return 0===this._squareBracketState}getCurrentLexerNode(){return this._currentLexerNode}getFunctionAndParameter(formulaString,strIndex){const current=this._getCurrentParamIndex(formulaString,strIndex);if(null==current||current===error_type_ErrorType.VALUE)return;const lexerNode=current[0];if("string"==typeof lexerNode)return;let parent=lexerNode.getParent(),children=lexerNode;for(;parent;){const token=parent.getToken();if("P_1"!==token&&!isFormulaLexerToken(token)&&-1!==parent.getStartIndex()){return{functionName:token,paramIndex:parent.getChildren().indexOf(children)}}children=parent,parent=parent.getParent()}}checkIfAddBracket(formulaString){let lastBracketCount=0,lastIndex=formulaString.length-1,lastString=formulaString[lastIndex];for(;(lastString===token_matchToken.CLOSE_BRACKET||" "===lastString)&&lastIndex>=0;)lastString===token_matchToken.CLOSE_BRACKET&&lastBracketCount++,lastString=formulaString[--lastIndex];const current=this._getCurrentParamIndex(formulaString,formulaString.length-2);if(null==current||current===error_type_ErrorType.VALUE)return 0;const lexerNode=current[0];if("string"==typeof lexerNode)return 0;let parent=lexerNode.getParent(),bracketCount=0;for(current[1]===token_matchToken.OPEN_BRACKET&&bracketCount++;parent;){const token=parent.getToken();"P_1"!==token&&token!==token_matchToken.COLON&&-1!==parent.getStartIndex()&&"LAMBDA"!==token.toUpperCase()&&(0===lastBracketCount?bracketCount+=1:lastBracketCount--),parent=parent.getParent()}return bracketCount}sequenceNodesBuilder(formulaString){const sequenceNodesCache=FormulaSequenceNodeCache.get(formulaString);if(sequenceNodesCache)return[...sequenceNodesCache];const sequenceArray=this._getSequenceArray(formulaString);if(0===sequenceArray.length)return;const newSequenceNodes=this.getSequenceNode(sequenceArray);return FormulaSequenceNodeCache.set(formulaString,[...newSequenceNodes]),newSequenceNodes}convertRefersToAbsolute(formulaString,startAbsoluteRefType,endAbsoluteRefType,currentSheetName=""){const nodes=this.sequenceNodesBuilder(formulaString);if(null==nodes)return formulaString;let prefixToken="";formulaString.substring(0,1)===operatorToken.EQUALS&&(prefixToken=operatorToken.EQUALS);for(let i=0,len=nodes.length;i<len;i++){const node=nodes[i];if("string"!=typeof node&&node.nodeType===sequenceNodeType.REFERENCE){const{token,endIndex}=node,sequenceGrid=deserializeRangeWithSheetWithCache(token);if(null==sequenceGrid)continue;const{range,sheetName,unitId}=sequenceGrid,newToken=serializeRangeToRefString({range:{...range,startAbsoluteRefType,endAbsoluteRefType},unitId,sheetName:sheetName||currentSheetName}),minusCount=newToken.length-token.length;nodes[i]={...node,token:newToken,endIndex:endIndex+minusCount};for(let j=i+1;j<len;j++){const nextNode=nodes[j];"string"!=typeof nextNode&&(nextNode.startIndex+=minusCount,nextNode.endIndex+=minusCount)}}}return`${prefixToken}${generateStringWithSequence(nodes)}`}moveFormulaRefOffset(formulaString,refOffsetX,refOffsetY,ignoreAbsolute=!1){const sequenceNodes=this.sequenceNodesBuilder(formulaString);if(null==sequenceNodes)return formulaString;const newSequenceNodes=[];for(let i=0,len=sequenceNodes.length;i<len;i++){const node=sequenceNodes[i];if("string"==typeof node||node.nodeType!==sequenceNodeType.REFERENCE){newSequenceNodes.push(node);continue}const{token}=node,sequenceGrid=deserializeRangeWithSheetWithCache(token),{sheetName,unitId:sequenceUnitId}=sequenceGrid;let newRange=sequenceGrid.range;if(!ignoreAbsolute&&newRange.startAbsoluteRefType===src.F6v.ALL&&newRange.endAbsoluteRefType===src.F6v.ALL){newSequenceNodes.push(node);continue}newRange=(0,src.ZTS)(newRange,refOffsetX,refOffsetY,ignoreAbsolute);let newToken="";newToken=(0,src.yZr)(newRange)?serializeRangeToRefString({range:newRange,unitId:sequenceUnitId,sheetName}):error_type_ErrorType.REF,newSequenceNodes.push({...node,token:newToken})}return`=${generateStringWithSequence(newSequenceNodes)}`}_formulaSpellCheck(){if(0===this._currentLexerNode.getChildren().length)return!0;const node=this._currentLexerNode.getChildren()[0];return node instanceof LexerNode||!(!OPERATOR_TOKEN_SET.has(node)&&!SUFFIX_TOKEN_SET.has(node)&&node!==prefixToken.AT&&node!==token_matchToken.COMMA&&node!==token_matchToken.COLON&&node!==token_matchToken.OPEN_BRACKET)}getSequenceNode(sequenceArray){const sequenceNodes=[];let maybeString=!1;for(let i=0,len=sequenceArray.length;i<len;i++){const item=sequenceArray[i],preItem=sequenceArray[i-1],{segment,currentString}=item;if(currentString===token_matchToken.DOUBLE_QUOTATION&&(maybeString=!0),(""!==segment||0===i)&&i!==len-1){sequenceNodes.push(currentString);continue}let preSegment=preItem?.segment||"";const startIndex=i-preSegment.length;let endIndex=i-1;const deleteEndIndex=i-1;if(i===len-1&&this._isLastMergeString(currentString)&&(preSegment+=currentString,endIndex+=1),""===preSegment||OPERATOR_TOKEN_PRIORITY.has(preSegment)){sequenceNodes.push(currentString);continue}const preSegmentTrim=preSegment.trim(),preSegmentNotPrefixToken=replaceRefPrefixString(preSegmentTrim);!0===maybeString&&preSegmentTrim[preSegmentTrim.length-1]===token_matchToken.DOUBLE_QUOTATION&&preSegmentTrim[0]!==token_matchToken.OPEN_BRACES?(maybeString=!1,this._processPushSequenceNode(sequenceNodes,sequenceNodeType.STRING,preSegment,startIndex,endIndex,deleteEndIndex)):regexTestSingeRange(preSegmentNotPrefixToken)&&isReferenceStringWithEffectiveColumn(preSegmentNotPrefixToken)?this._processPushSequenceNode(sequenceNodes,sequenceNodeType.REFERENCE,preSegment,startIndex,endIndex,deleteEndIndex):src.S0q.isStringNumber(preSegmentTrim)?this._processPushSequenceNode(sequenceNodes,sequenceNodeType.NUMBER,preSegment,startIndex,endIndex,deleteEndIndex):preSegmentTrim.length>0&&this._processPushSequenceNode(sequenceNodes,sequenceNodeType.FUNCTION,preSegment,startIndex,endIndex,deleteEndIndex),i===len-1&&this._isLastMergeString(currentString)||sequenceNodes.push(currentString)}return this._mergeSequenceNodeReference(sequenceNodes)}_processPushSequenceNode(sequenceNodes,nodeType,token,startIndex,endIndex,deleteEndIndex){this._pushSequenceNode(sequenceNodes,{nodeType,token,startIndex,endIndex},deleteEndIndex)}_getCurrentParamIndex(formulaString,index){return this._nodeMaker(formulaString,void 0,index)}_isLastMergeString(str){return str===token_matchToken.DOUBLE_QUOTATION||src.S0q.isStringNumber(str)||!isFormulaLexerToken(str)}_mergeSequenceNodeReference(sequenceNodes){const newSequenceNodes=[],sequenceNodesCount=sequenceNodes.length;let i=0;for(;i<sequenceNodesCount;){const node=sequenceNodes[i];if("string"==typeof node){const preNode=sequenceNodes[i-1];if(node.trim()===token_matchToken.CLOSE_BRACES&&null!=preNode&&"string"!=typeof preNode&&preNode.nodeType===sequenceNodeType.FUNCTION){if(preNode.token.trim().substring(0,1)===token_matchToken.OPEN_BRACES){preNode.nodeType=sequenceNodeType.ARRAY,preNode.token+=node,preNode.endIndex+=node.length,i++;continue}}newSequenceNodes.push(node)}else{const nextOneNode=sequenceNodes[i+1],nextTwoNode=sequenceNodes[i+2];nextOneNode===token_matchToken.COLON&&"string"!=typeof node&&null!=nextTwoNode&&"string"!=typeof nextTwoNode&&isReferenceStringWithEffectiveColumn((node.token+nextOneNode+nextTwoNode.token).trim())&&(node.nodeType=sequenceNodeType.REFERENCE,node.token+=nextOneNode+nextTwoNode.token,node.endIndex=nextTwoNode.endIndex,i+=2),newSequenceNodes.push(node)}i++}return this._minusSplitSequenceNode(newSequenceNodes)}_minusSplitSequenceNode(sequenceNodes){const finalSequenceNodes=[];for(const node of sequenceNodes){if("string"!=typeof node){const match=node.token.match(/^(\s*([-@+]\s*)+)(.*)$/);if(match){const operatorPart=match[1],referencePart=match[3];if(isReferenceStringWithEffectiveColumn(referencePart.trim())){const operatorLength=operatorPart.length,operatorStart=node.startIndex,operatorEnd=node.startIndex+operatorLength-1,operatorNode={nodeType:sequenceNodeType.NORMAL,token:operatorPart,startIndex:operatorStart,endIndex:operatorEnd},refNode={nodeType:sequenceNodeType.REFERENCE,token:referencePart,startIndex:operatorEnd+1,endIndex:node.endIndex};finalSequenceNodes.push(operatorNode),finalSequenceNodes.push(refNode);continue}}}finalSequenceNodes.push(node)}return finalSequenceNodes}_pushSequenceNode(sequenceNodes,node,deleteEndIndex){const segmentCount=deleteEndIndex-node.startIndex+1;sequenceNodes.splice(sequenceNodes.length-segmentCount,segmentCount,node)}nodeMakerTest(formulaString){return this._nodeMaker(formulaString)}treeBuilder(formulaString,transformSuffix=!0,injectDefinedName,simpleCheckDefinedName){if(!0===transformSuffix){const lexerNode=FormulaLexerNodeCache.get(formulaString),simpleCheckDefinedNameResult=simpleCheckDefinedName?.(formulaString);if(lexerNode&&!simpleCheckDefinedNameResult)return lexerNode}this._resetCurrentLexerNode(),this._currentLexerNode.setToken("R_1");const sequenceArray=[];let state=this._nodeMaker(formulaString,sequenceArray);if(state===error_type_ErrorType.VALUE||0===sequenceArray.length)return state;let currentHasDefinedName=!1,currentSequenceString="",currentDefinedNames=[];if(injectDefinedName){const{hasDefinedName,sequenceString,definedNames}=injectDefinedName(sequenceArray);currentHasDefinedName=hasDefinedName,currentSequenceString=sequenceString,currentDefinedNames=definedNames}if(currentHasDefinedName&&(this._resetCurrentLexerNode(),this._currentLexerNode.setToken("R_1"),state=this._nodeMaker(`=${currentSequenceString}`),state===error_type_ErrorType.VALUE))return state;const node=this._getTopNode(this._currentLexerNode);if(node&&(this._currentLexerNode=node),transformSuffix){if(!this._suffixExpressionHandler(this._currentLexerNode))return error_type_ErrorType.VALUE;FormulaLexerNodeCache.set(formulaString,this._currentLexerNode)}return currentHasDefinedName&&this._currentLexerNode.setDefinedNames(currentDefinedNames),this._currentLexerNode}_suffixExpressionHandler(lexerNode){const children=lexerNode.getChildren();if(!children)return!1;const childrenCount=children.length,baseStack=[],symbolStack=[];let isChildValid=!0;for(let i=0;i<childrenCount;i++){const node=children[i];if(node instanceof LexerNode)isChildValid=this._suffixExpressionHandler(node),baseStack.push(node);else{const char=node.trim();if(""===char)continue;if(OPERATOR_TOKEN_SET.has(char)){if(char===operatorToken.PLUS&&this._deletePlusForPreNode(children[i-1]))continue;if(char!==operatorToken.PLUS&&char!==operatorToken.MINUS&&this._deletePlusForPreNode(children[i-1]))return!1;for(;symbolStack.length>0;){const lastSymbol=symbolStack[symbolStack.length-1]?.trim();if(!lastSymbol||lastSymbol===token_matchToken.OPEN_BRACKET)break;const lastSymbolPriority=OPERATOR_TOKEN_PRIORITY.get(lastSymbol),charPriority=OPERATOR_TOKEN_PRIORITY.get(char);if(!lastSymbolPriority||!charPriority)break;if(!(charPriority>=lastSymbolPriority))break;baseStack.push(symbolStack.pop())}symbolStack.push(node)}else if(char===token_matchToken.OPEN_BRACKET)symbolStack.push(node);else if(char===token_matchToken.CLOSE_BRACKET)this._processSuffixExpressionCloseBracket(baseStack,symbolStack,children,i);else{if(this._checkCloseBracket(children[i-1]))return!1;baseStack.push(node)}}}return!!isChildValid&&this._processSuffixExpressionRemain(baseStack,symbolStack,lexerNode)}_processSuffixExpressionRemain(baseStack,symbolStack,lexerNode){const lastBaseStack=baseStack[baseStack.length-1];for(;symbolStack.length>0;){const symbol=symbolStack.pop();if(!(lastBaseStack instanceof LexerNode||symbol!==token_matchToken.OPEN_BRACKET&&symbol!==token_matchToken.CLOSE_BRACKET))return!1;baseStack.push(symbol)}return lexerNode.setChildren(baseStack),!0}_processSuffixExpressionCloseBracket(baseStack,symbolStack,children,i){if(this._checkOpenBracket(children[i-1]))return!1;if(this._checkOperator(children[i-1]))return!1;for(;symbolStack.length>0;){const lastSymbol=symbolStack[symbolStack.length-1]?.trim();if(!lastSymbol)break;if(lastSymbol===token_matchToken.OPEN_BRACKET){symbolStack.pop();break}baseStack.push(symbolStack.pop())}}_checkCloseBracket(node){return node===token_matchToken.CLOSE_BRACKET||node instanceof LexerNode}_checkOpenBracket(node){return node===token_matchToken.OPEN_BRACKET}_checkOperator(node){return null!=node&&(!(node instanceof LexerNode)&&OPERATOR_TOKEN_SET.has(node))}_deletePlusForPreNode(preNode){if(null==preNode)return!0;if(!(preNode instanceof LexerNode)){const preChar=preNode.trim();if(OPERATOR_TOKEN_SET.has(preChar)||preChar===token_matchToken.OPEN_BRACKET)return!0}return!1}_resetCurrentLexerNode(){this._currentLexerNode=new LexerNode}_resetSegment(){this._segment=""}_openBracket(type=0){this._bracketState.push(type)}_closeBracket(){this._bracketState.pop()}_openSquareBracket(){this._squareBracketState+=1}_closeSquareBracket(){this._squareBracketState-=1}_getCurrentBracket(){const bracketState=this._bracketState;return bracketState[bracketState.length-1]}_changeCurrentBracket(type){const bracketState=this._bracketState;bracketState[bracketState.length-1]=type}_openBraces(){this._bracesState+=1}_closeBraces(){this._bracesState-=1}_openSingleQuotation(){this._singleQuotationState+=1}_closeSingleQuotation(){this._singleQuotationState-=1}_openDoubleQuotation(){this._doubleQuotationState+=1}_closeDoubleQuotation(){this._doubleQuotationState-=1}_openLambda(){this._lambdaState=!0}_closeLambda(){this._lambdaState=!1}_openColon(upLevel){this._upLevel=upLevel,this._colonState=!0}_closeColon(){this._upLevel=0,this._colonState=!1}_isTableBracket(){return this._tableBracketState}_openTableBracket(){this._tableBracketState=!0}_closeTableBracket(){this._tableBracketState=!1}_formalErrorOccurred(){this._formulaErrorCount+=1}_hasFormalError(){return this._formulaErrorCount>0}_getLastChildCurrentLexerNode(){const children=this._currentLexerNode.getChildren();if(children&&children.length>0){const lastNode=children[children.length-1];if(lastNode instanceof LexerNode)return lastNode}return!1}_getLastChildCurrent(){const children=this._currentLexerNode.getChildren();if(children&&children.length>0){return children[children.length-1]}return!1}_setParentCurrentLexerNode(){const parent=this._currentLexerNode.getParent();return!!parent&&(this._currentLexerNode=parent,!0)}_setAncestorCurrentLexerNode(){const parent=this._currentLexerNode?.getParent();let state=!1;if(parent&&"L_1"===parent.getToken()){if(parent?.getParent()?.getParent()){const node=this._currentLexerNode.getParent()?.getParent()?.getParent();node&&(this._currentLexerNode=node),state=!0}}else if(parent?.getParent()){const node=this._currentLexerNode.getParent()?.getParent();node&&(this._currentLexerNode=node),state=!0}for(let i=0;i<this._upLevel;i++){const node=this._currentLexerNode?.getParent();node&&(this._currentLexerNode=node),state=!!this._currentLexerNode}return state}_segmentCount(){return this._segment.trim().length}_pushSegment(value){this._segment+=value}_pushNodeToChildren(valueRaw,isUnshift=!1){let value=valueRaw;if(""!==value){const children=this._currentLexerNode.getChildren();if(!(value instanceof LexerNode)&&this.isColonOpen()){const subLexerNode_ref=new LexerNode;subLexerNode_ref.setToken(value),subLexerNode_ref.setParent(this._currentLexerNode),value=subLexerNode_ref}isUnshift?children.unshift(value):children.push(value)}this.isColonOpen()&&(this._setAncestorCurrentLexerNode(),this._closeColon())}_setCurrentLexerNode(subLexerNode,isUnshift=!1){this._pushNodeToChildren(subLexerNode,isUnshift),subLexerNode.setParent(this._currentLexerNode),this._currentLexerNode=subLexerNode}_newAndPushCurrentLexerNode(token,current,isUnshift=!1){const subLexerNode=new LexerNode;subLexerNode.setToken(token),subLexerNode.setIndex(current-token.length,current-1),this._setCurrentLexerNode(subLexerNode,isUnshift)}_getTopNode(lexerNode){let parentNode=lexerNode;for(;parentNode?.getParent();)parentNode=parentNode.getParent();return parentNode}_removeLastChild(){this._currentLexerNode.getChildren().splice(-1)}_formulaErrorLastTokenCheck(formulaStringArray,indexRaw){const lastToken=this._findPreviousToken(formulaStringArray,indexRaw)||"",isFirstCheck=formulaStringArray.length-1===indexRaw;if(!isFirstCheck&&this._isOperatorToken(lastToken))return!0;if(isFirstCheck&&function isTokenCannotBeAtEnd(token){return TOKEN_CANNOT_BE_AT_END_SET.has(token)}(lastToken))return!0;if(SUFFIX_TOKEN_SET.has(lastToken)){const lastTwoToken=this._findSecondLastNonSpaceToken(formulaStringArray,indexRaw);if(null==lastTwoToken||function isTokenCannotPrecedeSuffixToken(token){return TOKEN_CANNOT_PRECEDE_SUFFIX_TOKEN_SET.has(token)}(lastTwoToken))return!0}return!1}_findPreviousToken(data,indexRaw){let index=indexRaw;for(;index>=0;){const token=data[index];if(" "!==token)return token;index--}}_findSecondLastNonSpaceToken(data,indexRaw){let index=indexRaw,nonSpaceTokenCount=0;for(;index>=0;){const token=data[index];if(" "!==token&&(nonSpaceTokenCount++,2===nonSpaceTokenCount))return token;index--}return null}_findNextToken(data,indexRaw){let index=indexRaw;for(;index>=0;){const token=data[index];if(" "!==token)return token;index++}}_unexpectedEndingTokenExcludeOperator(prevString){return prevString===token_matchToken.OPEN_BRACKET||prevString===token_matchToken.COMMA||prevString===operatorToken.EQUALS||""===prevString}_unexpectedEndingToken(prevString){return!(!this._isOperatorToken(prevString)&&!this._unexpectedEndingTokenExcludeOperator(prevString))}_isOperatorToken(prevString){return!!OPERATOR_TOKEN_SET.has(prevString)}_getSequenceArray(formulaString){const sequenceArray=[];return this._nodeMaker(formulaString,sequenceArray),sequenceArray}_resetTemp(){this._currentLexerNode=new LexerNode,this._upLevel=0,this._segment="",this._bracketState=[],this._bracesState=0,this._singleQuotationState=0,this._doubleQuotationState=0,this._lambdaState=!1,this._colonState=!1,this._formulaErrorCount=0}_checkErrorState(){return this._bracketState.length>0||(this._bracesState>0||(this._singleQuotationState>0||(this._doubleQuotationState>0||!!this._hasFormalError())))}_checkSimilarErrorToken(currentString,curRow,formulaStringArray){let cur=curRow;if(currentString!==suffixToken.POUND)return!0;let currentText=formulaStringArray[++cur];for(;" "===currentText;)currentText=formulaStringArray[++cur];return!!isFormulaLexerToken(currentText)}_checkIfErrorObject(cur,formulaStringArray){return!!this._findErrorObject(cur,formulaStringArray)}_findErrorObject(curRaw,formulaStringArray){for(let i=0;i<ERROR_TYPE_COUNT_ARRAY.length;i++){const errorTypeCount=ERROR_TYPE_COUNT_ARRAY[i],errorType=formulaStringArray.slice(curRaw,curRaw+errorTypeCount).join("").toUpperCase();if(ERROR_TYPE_SET.has(errorType))return errorType}}_nodeMaker(formulaStringRaw,sequenceArray,matchCurrentNodeIndex){let formulaString=formulaStringRaw.replace(/\r\n$/,"").replace(/\r/g," ").replace(/\n/g," ");formulaString.substring(0,1)===operatorToken.EQUALS&&(formulaString=formulaString.substring(1));const formulaStringArray=formulaString.split(""),formulaStringArrayCount=formulaStringArray.length;let cur=0;for(this._resetTemp(),this._formulaErrorLastTokenCheck(formulaStringArray,formulaStringArrayCount-1)&&this._formalErrorOccurred();cur<formulaStringArrayCount;){const currentString=formulaStringArray[cur];if(matchCurrentNodeIndex===cur)return[this._currentLexerNode,currentString];if(currentString===suffixToken.POUND&&this.isSingleQuotationClose()&&this.isDoubleQuotationClose()&&this.isBracesClose()&&this.isSquareBracketClose()&&this._checkIfErrorObject(cur,formulaStringArray)){const errorType=this._findErrorObject(cur,formulaStringArray);if(null==errorType)return error_type_ErrorType.VALUE;this._pushNodeToChildren(errorType);for(let i=0;i<errorType.length;i++){const curStr=formulaStringArray[cur];this._pushSegment(curStr),this._addSequenceArray(sequenceArray,curStr,cur),cur++}this._resetSegment()}else{if(currentString===token_matchToken.OPEN_BRACKET&&this.isSingleQuotationClose()&&this.isDoubleQuotationClose())if(this._segmentCount()>0||this.isLambdaOpen()){this.isLambdaClose()&&(this._newAndPushCurrentLexerNode(this._segment,cur),this._resetSegment()),this._openBracket(1),this._closeLambda();const nextCurrentString=formulaStringArray[cur+1];if(nextCurrentString&&nextCurrentString===token_matchToken.CLOSE_BRACKET){if(!this._setParentCurrentLexerNode()&&cur!==formulaStringArrayCount-1)return error_type_ErrorType.VALUE;this._addSequenceArray(sequenceArray,currentString,cur),cur++,this._addSequenceArray(sequenceArray,nextCurrentString,cur),cur++,this._closeBracket();continue}nextCurrentString&&this._newAndPushCurrentLexerNode("P_1",cur)}else this._pushNodeToChildren(currentString),this._openBracket(0),this._resetSegment();else if(currentString===token_matchToken.CLOSE_BRACKET&&this.isSingleQuotationClose()&&this.isDoubleQuotationClose()){this._formulaErrorLastTokenCheck(formulaStringArray,cur-1)&&this._formalErrorOccurred(),this._pushNodeToChildren(this._segment),this._resetSegment();const currentBracket=this._getCurrentBracket();if(0===currentBracket)this._pushNodeToChildren(currentString);else{if(1!==currentBracket)return error_type_ErrorType.VALUE;{const nextCurrentString=formulaStringArray[cur+1];if(nextCurrentString&&nextCurrentString===token_matchToken.OPEN_BRACKET){if(!this._setParentCurrentLexerNode()&&cur!==formulaStringArrayCount-1)return error_type_ErrorType.VALUE;this._newAndPushCurrentLexerNode("L_1",cur,!0),this._openLambda()}else if(!this._setAncestorCurrentLexerNode()&&cur!==formulaStringArrayCount-1)return error_type_ErrorType.VALUE}}this._closeBracket()}else if(currentString===token_matchToken.OPEN_BRACES&&this.isSingleQuotationClose()&&this.isDoubleQuotationClose()){if(this._pushSegment(currentString),this._openBraces(),!this._formulaSpellCheck())return error_type_ErrorType.VALUE}else if(currentString===token_matchToken.CLOSE_BRACES&&this.isSingleQuotationClose()&&this.isDoubleQuotationClose())this._pushSegment(currentString),this._pushNodeToChildren(this._segment),this._resetSegment(),this._closeBraces();else if(currentString===token_matchToken.OPEN_SQUARE_BRACKET&&this.isSingleQuotationClose()&&this.isDoubleQuotationClose())this._segment.length>0&&this._openTableBracket(),this._pushSegment(currentString),this._openSquareBracket();else if(currentString===token_matchToken.CLOSE_SQUARE_BRACKET&&this.isSingleQuotationClose()&&this.isDoubleQuotationClose())this._closeSquareBracket(),this.isSquareBracketClose()?(this._pushSegment(currentString),this._isTableBracket()&&(this._pushNodeToChildren(this._segment),this._resetSegment()),this._closeTableBracket()):this._pushSegment(currentString);else if(currentString===token_matchToken.DOUBLE_QUOTATION&&this.isSingleQuotationClose()&&this.isSquareBracketClose()){if(this.isDoubleQuotationClose())this._openDoubleQuotation();else{const nextCurrentString=formulaStringArray[cur+1];nextCurrentString&&nextCurrentString===token_matchToken.DOUBLE_QUOTATION?cur++:this._closeDoubleQuotation()}this._pushSegment(currentString)}else if(currentString===token_matchToken.SINGLE_QUOTATION&&this.isDoubleQuotationClose()){if(this.isSingleQuotationClose())this._openSingleQuotation(),0===this._segmentCount()&&this._resetSegment();else{const nextCurrentString=formulaStringArray[cur+1];if(nextCurrentString&&nextCurrentString===token_matchToken.SINGLE_QUOTATION){this._pushSegment(currentString),this._addSequenceArray(sequenceArray,currentString,cur),cur++,this._pushSegment(nextCurrentString),this._addSequenceArray(sequenceArray,nextCurrentString,cur),cur++;continue}this._closeSingleQuotation()}this._pushSegment(currentString)}else if(currentString===token_matchToken.COMMA&&this.isSingleQuotationClose()&&this.isDoubleQuotationClose()&&this.isBracesClose()&&this.isSquareBracketClose()){this._formulaErrorLastTokenCheck(formulaStringArray,cur-1)&&this._formalErrorOccurred();const currentBracket=this._getCurrentBracket();if(1===currentBracket||null==currentBracket){if(this._pushNodeToChildren(this._segment),this._resetSegment(),!this._setParentCurrentLexerNode()&&cur!==formulaStringArrayCount-1&&null!=currentBracket)return error_type_ErrorType.VALUE;this._newAndPushCurrentLexerNode("P_1",cur)}else{const cubeNode=new LexerNode;cubeNode.setToken("CUBE");const cubeParamNode=new LexerNode;cubeParamNode.setToken("P_1"),cubeParamNode.changeToParent(cubeNode);const colonNode=this._currentLexerNode.getParent();if(!colonNode||colonNode.getToken()!==token_matchToken.COLON)return error_type_ErrorType.VALUE;{const colonNodeParent=colonNode.getParent();if(!colonNodeParent)return error_type_ErrorType.VALUE;colonNode.changeToParent(cubeParamNode),colonNodeParent.setChildren([]),cubeNode.changeToParent(colonNodeParent)}this._changeCurrentBracket(1),this._pushNodeToChildren(this._segment),this._resetSegment(),this._currentLexerNode=cubeNode,this._newAndPushCurrentLexerNode("P_1",cur)}}else if(currentString===token_matchToken.COLON&&this.isSingleQuotationClose()&&this.isDoubleQuotationClose()&&this.isBracesClose()&&this.isSquareBracketClose()){const subLexerNode_op=new LexerNode;subLexerNode_op.setToken(currentString);const subLexerNode_left=new LexerNode;subLexerNode_left.setToken("P_1"),subLexerNode_left.setParent(subLexerNode_op);const subLexerNode_right=new LexerNode;subLexerNode_right.setToken("P_1"),subLexerNode_right.setParent(subLexerNode_op),subLexerNode_op.getChildren().push(subLexerNode_left,subLexerNode_right);let subLexerNode_main=subLexerNode_op,upLevel=0;if(this._segmentCount()>0){let subLexerNode_minus,subLexerNode_at,sliceLength=0;const segmentTrim=this._segment.trim(),lastString=segmentTrim[0],twoLastString=segmentTrim[1];if(lastString===prefixToken.MINUS&&(subLexerNode_minus=new LexerNode,subLexerNode_minus.setToken(prefixToken.MINUS),sliceLength++),lastString!==prefixToken.AT&&twoLastString!==prefixToken.AT||(subLexerNode_at=new LexerNode,subLexerNode_at.setToken(prefixToken.AT),subLexerNode_minus&&(subLexerNode_minus.addChildren(subLexerNode_at),subLexerNode_at.setParent(subLexerNode_minus)),sliceLength++),sliceLength>0&&(this._segment=segmentTrim.slice(sliceLength)),upLevel=sliceLength,subLexerNode_at)if(subLexerNode_at.addChildren(subLexerNode_op),subLexerNode_op.setParent(subLexerNode_at),subLexerNode_at.getParent()){const node=subLexerNode_at.getParent();node&&(subLexerNode_main=node)}else subLexerNode_main=subLexerNode_at;else subLexerNode_minus&&(subLexerNode_main=subLexerNode_minus,subLexerNode_minus.addChildren(subLexerNode_op),subLexerNode_op.setParent(subLexerNode_minus));const subLexerNode_ref=new LexerNode;subLexerNode_ref.setToken(this._segment),subLexerNode_ref.setParent(subLexerNode_left),subLexerNode_left.getChildren().push(subLexerNode_ref),this._resetSegment()}else{const lastChildNode=this._getLastChildCurrentLexerNode();lastChildNode&&lastChildNode.changeToParent(subLexerNode_left)}this._setCurrentLexerNode(subLexerNode_main),this._currentLexerNode=subLexerNode_right,this._openColon(upLevel)}else if(SUFFIX_TOKEN_SET.has(currentString)&&this._checkSimilarErrorToken(currentString,cur,formulaStringArray)&&this.isSingleQuotationClose()&&this.isDoubleQuotationClose()&&this.isSquareBracketClose()&&this.isBracesClose()){this._pushNodeToChildren(this._segment);const subLexerNode=new LexerNode;subLexerNode.setToken(currentString);const lastChildNode=this._getLastChildCurrent();lastChildNode instanceof LexerNode?lastChildNode.changeToParent(subLexerNode):!1!==lastChildNode&&(subLexerNode.getChildren().push(lastChildNode),this._removeLastChild()),this._pushNodeToChildren(subLexerNode),subLexerNode.setParent(this._currentLexerNode),this._resetSegment()}else if(OPERATOR_TOKEN_SET.has(currentString)&&this.isSingleQuotationClose()&&this.isDoubleQuotationClose()&&this.isSquareBracketClose()&&this.isBracesClose()){let trimSegment=this._segment.trim();if(currentString===operatorToken.MINUS&&""===trimSegment){const prevString=this._findPreviousToken(formulaStringArray,cur-1)||"",nextString=this._findNextToken(formulaStringArray,cur+1)||"";if(this._unexpectedEndingTokenExcludeOperator(prevString)&&this._isOperatorToken(nextString)){this._pushNodeToChildren("0"),this._pushNodeToChildren(operatorToken.MINUS),this._addSequenceArray(sequenceArray,currentString,cur),this._resetSegment(),cur++;continue}if(this._unexpectedEndingToken(prevString)){if(nextString===operatorToken.PLUS){this._pushSegment(operatorToken.MINUS),this._addSequenceArray(sequenceArray,currentString,cur),this._addSequenceArray(sequenceArray,operatorToken.PLUS,cur+1),cur+=2;continue}this._pushSegment(operatorToken.MINUS),this._addSequenceArray(sequenceArray,currentString,cur),cur++;continue}}else{if(this._segment.length>0&&this._isScientificNotation(formulaStringArray,cur,currentString)){this._pushSegment(currentString),this._addSequenceArray(sequenceArray,currentString,cur),cur++;continue}this._segment.length>0&&""===trimSegment?trimSegment=this._segment:(this._pushNodeToChildren(this._segment),trimSegment="")}if(currentString===operatorToken.LESS_THAN||currentString===operatorToken.GREATER_THAN){const nextCurrentString=formulaStringArray[cur+1];if(nextCurrentString&&OPERATOR_TOKEN_SET.has(currentString+nextCurrentString)){this._pushNodeToChildren(trimSegment+currentString+nextCurrentString),this._resetSegment(),this._addSequenceArray(sequenceArray,currentString,cur),cur++,this._addSequenceArray(sequenceArray,nextCurrentString,cur),cur++;continue}this._pushNodeToChildren(trimSegment+currentString)}else this._pushNodeToChildren(trimSegment+currentString);this._resetSegment()}else this._pushSegment(currentString);this._addSequenceArray(sequenceArray,currentString,cur),cur++}}if(this._pushNodeToChildren(this._segment),this._checkErrorState())return error_type_ErrorType.VALUE}_isScientificNotation(formulaStringArray,cur,currentString){const preTwoChar=formulaStringArray[cur-2];if(preTwoChar&&Number.isNaN(Number(preTwoChar)))return!1;if(currentString!==operatorToken.MINUS&&currentString!==operatorToken.PLUS)return!1;const nextOneChar=formulaStringArray[cur+1];if(nextOneChar&&Number.isNaN(Number(nextOneChar)))return!1;const preOneChar=formulaStringArray[cur-1];return preOneChar&&"E"===preOneChar.toUpperCase()}_addSequenceArray(sequenceArray,currentString,cur){sequenceArray?.push({segment:this._segment,currentString,cur,currentLexerNode:this._currentLexerNode})}constructor(...args){super(...args),this._currentLexerNode=new LexerNode,this._upLevel=0,this._segment="",this._bracketState=[],this._squareBracketState=0,this._bracesState=0,this._singleQuotationState=0,this._doubleQuotationState=0,this._lambdaState=!1,this._colonState=!1,this._formulaErrorCount=0,this._tableBracketState=!1}}function formula_data_model_ts_metadata(k,v){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(k,v)}function formula_data_model_ts_param(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}}class FormulaDataModel extends src.jGt{constructor(_univerInstanceService,_lexerTreeBuilder){super(),this._univerInstanceService=_univerInstanceService,this._lexerTreeBuilder=_lexerTreeBuilder,this._arrayFormulaRange={},this._arrayFormulaCellData={}}dispose(){super.dispose(),this._arrayFormulaRange={},this._arrayFormulaCellData={}}clearPreviousArrayFormulaCellData(clearArrayFormulaCellData){Object.keys(clearArrayFormulaCellData).forEach((unitId=>{const clearSheetData=clearArrayFormulaCellData[unitId];if(null==clearSheetData)return!0;Object.keys(clearSheetData).forEach((sheetId=>{const clearCellMatrixData=clearSheetData[sheetId],formulaRange=this._arrayFormulaRange?.[unitId]?.[sheetId];if(null==formulaRange)return!0;const rangeMatrix=new src.hDc(formulaRange);let arrayFormulaCellMatrixData=new src.hDc;null!=this._arrayFormulaCellData[unitId]?.[sheetId]&&(arrayFormulaCellMatrixData=new src.hDc(this._arrayFormulaCellData[unitId]?.[sheetId])),clearCellMatrixData.forValue(((row,column)=>{const range=rangeMatrix.getValue(row,column);if(null==range)return!0;const{startRow,startColumn,endRow,endColumn}=range;for(let r=startRow;r<=endRow;r++)for(let c=startColumn;c<=endColumn;c++)arrayFormulaCellMatrixData.setValue(r,c,null);rangeMatrix.realDeleteValue(row,column)})),this._arrayFormulaCellData[unitId]&&(this._arrayFormulaCellData[unitId][sheetId]=arrayFormulaCellMatrixData.getData())}))}))}mergeArrayFormulaCellData(unitData){Object.keys(unitData).forEach((unitId=>{const sheetData=unitData[unitId];if(null==sheetData)return!0;null==this._arrayFormulaRange[unitId]&&(this._arrayFormulaRange[unitId]={}),null==this._arrayFormulaCellData[unitId]&&(this._arrayFormulaCellData[unitId]={}),Object.keys(sheetData).forEach((sheetId=>{const cellMatrixData=sheetData[sheetId],arrayFormulaRangeMatrix=new src.hDc(this._arrayFormulaRange[unitId]?.[sheetId]),arrayFormulaCellMatrixData=new src.hDc(this._arrayFormulaCellData[unitId]?.[sheetId]);cellMatrixData.forValue(((row,column)=>{const arrayFormulaRange=arrayFormulaRangeMatrix?.getValue(row,column);if(null==arrayFormulaRange)return!0;const{startRow,startColumn,endRow,endColumn}=arrayFormulaRange;for(let r=startRow;r<=endRow;r++)for(let c=startColumn;c<=endColumn;c++)arrayFormulaCellMatrixData.setValue(r,c,null)})),cellMatrixData.forValue(((row,column,cellData)=>{arrayFormulaCellMatrixData.setValue(row,column,cellData)})),this._arrayFormulaCellData[unitId]&&(this._arrayFormulaCellData[unitId][sheetId]=arrayFormulaCellMatrixData.getData())}))}))}getFormulaData(){const formulaData={},allSheets=this._univerInstanceService.getAllUnitsForType(src.Zy$.UNIVER_SHEET);return 0===allSheets.length||allSheets.forEach((workbook=>{const unitId=workbook.getUnitId();formulaData[unitId]={};workbook.getSheets().forEach((worksheet=>{const cellMatrix=worksheet.getCellMatrix(),sheetId=worksheet.getSheetId();initSheetFormulaData(formulaData,unitId,sheetId,cellMatrix)}))})),formulaData}getSheetFormulaData(unitId,sheetId){const formulaData={},workbook=this._univerInstanceService.getUnit(unitId);if(null==workbook)return{};formulaData[unitId]={};const worksheet=workbook.getSheetBySheetId(sheetId);if(null==worksheet)return{};return initSheetFormulaData(formulaData,unitId,sheetId,worksheet.getCellMatrix()),formulaData[unitId][sheetId]}getArrayFormulaRange(){return this._arrayFormulaRange}setArrayFormulaRange(value){this._arrayFormulaRange=value}getArrayFormulaCellData(){return this._arrayFormulaCellData}setArrayFormulaCellData(value){this._arrayFormulaCellData=value}mergeArrayFormulaRange(formulaData){Object.keys(formulaData).forEach((unitId=>{const sheetData=formulaData[unitId];if(null==sheetData)return!0;this._arrayFormulaRange[unitId]||(this._arrayFormulaRange[unitId]={}),Object.keys(sheetData).forEach((sheetId=>{const arrayFormula=new src.hDc(sheetData[sheetId]),rangeMatrix=new src.hDc(this._arrayFormulaRange[unitId]?.[sheetId]);arrayFormula.forValue(((r,c,v)=>{rangeMatrix.setValue(r,c,v)})),this._arrayFormulaRange[unitId]&&(this._arrayFormulaRange[unitId][sheetId]=rangeMatrix.getData())}))}))}deleteArrayFormulaRange(unitId,sheetId,row,column){const cellMatrixData=this._arrayFormulaRange[unitId]?.[sheetId];if(null==cellMatrixData)return;const rangeMatrixData=new src.hDc(cellMatrixData);rangeMatrixData.getValue(row,column)&&(rangeMatrixData.realDeleteValue(row,column),this._arrayFormulaRange[unitId]&&(this._arrayFormulaRange[unitId][sheetId]=rangeMatrixData.getData()))}getCalculateData(){const unitAllSheet=this._univerInstanceService.getAllUnitsForType(src.Zy$.UNIVER_SHEET),allUnitData={},unitStylesData={},unitSheetNameMap={};for(const workbook of unitAllSheet){const unitId=workbook.getUnitId(),sheets=workbook.getSheets(),sheetData={},sheetNameMap={};for(const sheet of sheets){const sheetId=sheet.getSheetId(),sheetConfig=sheet.getConfig();sheetData[sheetId]={cellData:new src.hDc(sheetConfig.cellData),rowCount:sheetConfig.rowCount,columnCount:sheetConfig.columnCount,rowData:sheetConfig.rowData,columnData:sheetConfig.columnData,defaultRowHeight:sheetConfig.defaultRowHeight,defaultColumnWidth:sheetConfig.defaultColumnWidth},sheetNameMap[sheet.getName()]=sheet.getSheetId()}allUnitData[unitId]=sheetData,unitStylesData[unitId]=workbook.getStyles(),unitSheetNameMap[unitId]=sheetNameMap}return{allUnitData,unitStylesData,unitSheetNameMap}}getHiddenRowsFiltered(){const unitAllSheet=this._univerInstanceService.getAllUnitsForType(src.Zy$.UNIVER_SHEET),rowData={};for(const workbook of unitAllSheet){const unitId=workbook.getUnitId(),sheets=workbook.getSheets();rowData[unitId]={};for(const sheet of sheets){const sheetId=sheet.getSheetId();rowData[unitId][sheetId]={};const startRow=0,endRow=sheet.getRowCount()-1,sheetRowData={};for(let i=startRow;i<=endRow;i++)sheet.getRowVisible(i)||(sheetRowData[i]={hd:src.OdA.TRUE});rowData[unitId][sheetId]=sheetRowData}}return rowData}updateFormulaData(unitId,sheetId,cellValue){const cellMatrix=new src.hDc(cellValue),formulaIdMap=this._getSheetFormulaIdMap(unitId,sheetId),deleteFormulaIdMap=new Map,formulaData=this.getFormulaData();null==formulaData[unitId]&&(formulaData[unitId]={});const workbookFormulaData=formulaData[unitId];null==workbookFormulaData[sheetId]&&(workbookFormulaData[sheetId]={});const sheetFormulaDataMatrix=new src.hDc(workbookFormulaData[sheetId]||{}),newSheetFormulaDataMatrix=new src.hDc;return cellMatrix.forValue(((r,c,cell)=>{!function updateFormulaDataByCellValue(sheetFormulaDataMatrix,newSheetFormulaDataMatrix,formulaIdMap,deleteFormulaIdMap,r,c,cell){const formulaString=cell?.f||"",formulaId=cell?.si||"",checkFormulaString=(0,src.qGs)(formulaString),checkFormulaId=(0,src.wJp)(formulaId),currentFormulaInfo=sheetFormulaDataMatrix.getValue(r,c),f=currentFormulaInfo?.f||"",si=currentFormulaInfo?.si||"";function clearFormulaData(){if((0,src.qGs)(f)&&(0,src.wJp)(si)){const updatedFormula=formulaIdMap?.[si]?.f;updatedFormula?deleteFormulaIdMap.set(si,updatedFormula):deleteFormulaIdMap.set(si,f)}}checkFormulaString&&checkFormulaId?(si!==formulaId&&clearFormulaData(),sheetFormulaDataMatrix.setValue(r,c,{f:formulaString,si:formulaId}),formulaIdMap[formulaId]={f:formulaString,r,c},newSheetFormulaDataMatrix.setValue(r,c,{f:formulaString,si:formulaId})):checkFormulaString&&!checkFormulaId?(f!==formulaString&&clearFormulaData(),sheetFormulaDataMatrix.setValue(r,c,{f:formulaString}),newSheetFormulaDataMatrix.setValue(r,c,{f:formulaString})):!checkFormulaString&&checkFormulaId?(si!==formulaId&&clearFormulaData(),sheetFormulaDataMatrix.setValue(r,c,{f:"",si:formulaId})):checkFormulaString||checkFormulaId||!sheetFormulaDataMatrix.getValue(r,c)||(clearFormulaData(),sheetFormulaDataMatrix.realDeleteValue(r,c),newSheetFormulaDataMatrix.setValue(r,c,null))}(sheetFormulaDataMatrix,newSheetFormulaDataMatrix,formulaIdMap,deleteFormulaIdMap,r,c,cell)})),sheetFormulaDataMatrix.forValue(((r,c,cell)=>{const formulaString=cell?.f||"",formulaId=cell?.si||"";if((0,src.wJp)(formulaId)){const formulaInfo=formulaIdMap?.[formulaId],deleteFormula=deleteFormulaIdMap.get(formulaId);if(formulaInfo&&!(0,src.qGs)(formulaString)){const f=formulaInfo.f,x=c-formulaInfo.c,y=r-formulaInfo.r;sheetFormulaDataMatrix.setValue(r,c,{f,si:formulaId,x,y}),newSheetFormulaDataMatrix.setValue(r,c,{f,si:formulaId,x,y})}else if("string"==typeof deleteFormula){const x=cell?.x||0,y=cell?.y||0,offsetFormula=this._lexerTreeBuilder.moveFormulaRefOffset(deleteFormula,x,y);deleteFormulaIdMap.set(formulaId,{r,c,f:offsetFormula}),sheetFormulaDataMatrix.setValue(r,c,{f:offsetFormula,si:formulaId}),newSheetFormulaDataMatrix.setValue(r,c,{f:offsetFormula,si:formulaId})}else if("object"==typeof deleteFormula){const x=c-deleteFormula.c,y=r-deleteFormula.r;sheetFormulaDataMatrix.setValue(r,c,{f:deleteFormula.f,si:formulaId,x,y}),newSheetFormulaDataMatrix.setValue(r,c,{f:deleteFormula.f,si:formulaId,x,y})}}})),newSheetFormulaDataMatrix.getMatrix()}updateArrayFormulaRange(unitId,sheetId,cellValue){const arrayFormulaRange=this._arrayFormulaRange[unitId]?.[sheetId];if(!arrayFormulaRange)return;const arrayFormulaRangeMatrix=new src.hDc(arrayFormulaRange);new src.hDc(cellValue).forValue(((r,c,cell)=>{arrayFormulaRangeMatrix.realDeleteValue(r,c)}))}updateArrayFormulaCellData(unitId,sheetId,cellValue){const arrayFormulaRange=this._arrayFormulaRange[unitId]?.[sheetId];if(!arrayFormulaRange)return;const arrayFormulaRangeMatrix=new src.hDc(arrayFormulaRange),arrayFormulaCellData=this._arrayFormulaCellData[unitId]?.[sheetId];if(!arrayFormulaCellData)return;const arrayFormulaCellDataMatrix=new src.hDc(arrayFormulaCellData);new src.hDc(cellValue).forValue(((r,c,cell)=>{!function clearArrayFormulaCellDataByCell(arrayFormulaRangeMatrix,arrayFormulaCellDataMatrix,r,c){const arrayFormulaRangeValue=arrayFormulaRangeMatrix?.getValue(r,c);if(null==arrayFormulaRangeValue)return!0;const intersection=[];arrayFormulaRangeMatrix.forValue(((rangeRow,rangeCol,range)=>{rangeRow===r&&rangeCol===c||src.M_G.intersects(range,arrayFormulaRangeValue)&&intersection.push(range)}));const{startRow,startColumn,endRow,endColumn}=arrayFormulaRangeValue;for(let row=startRow;row<=endRow;row++)for(let col=startColumn;col<=endColumn;col++){let isOverlapping=!1;const currentCell=(0,src.PJ)(row,col);intersection.some((range=>!!src.M_G.contains(range,currentCell)&&(isOverlapping=!0,!0))),isOverlapping||arrayFormulaCellDataMatrix.realDeleteValue(row,col)}}(arrayFormulaRangeMatrix,arrayFormulaCellDataMatrix,r,c)}))}getFormulaStringByCell(row,column,sheetId,unitId){const workbook=this._univerInstanceService.getUnit(unitId);if(null==workbook)return null;const worksheet=workbook.getSheetBySheetId(sheetId);if(null==worksheet)return null;const cellMatrix=worksheet.getCellMatrix(),cell=cellMatrix.getValue(row,column);if(null==cell)return null;const{f,si}=cell;if((0,src.qGs)(f))return f;if((0,src.wJp)(si)){let formulaString=null;return cellMatrix.forValue(((r,c,cell)=>{if(null==cell)return!0;const{f,si:currentId}=cell;return(0,src.qGs)(f)&&si===currentId?(formulaString=this._lexerTreeBuilder.moveFormulaRefOffset(f,column-c,row-r),!1):void 0})),formulaString}return null}getFormulaDirtyRanges(){const formulaData=this.getFormulaData(),dirtyRanges=[];for(const unitId in formulaData){const workbook=formulaData[unitId];if(!workbook)continue;const workbookInstance=this._univerInstanceService.getUnit(unitId);if(workbookInstance)for(const sheetId in workbook){const sheet=workbook[sheetId];if(!sheet)continue;const sheetInstance=workbookInstance.getSheetBySheetId(sheetId);if(!sheetInstance)continue;const columnRanges={};for(const rowStr of Object.keys(sheet)){const row=Number(rowStr);for(const columnStr in sheet[row]){const column=Number(columnStr),currentCell=sheetInstance.getCellRaw(row,column);if(!((0,src.qGs)(currentCell?.f)||(0,src.wJp)(currentCell?.si))||!(void 0===currentCell?.v))continue;columnRanges[column]||(columnRanges[column]=[]);const lastRange=columnRanges[column].slice(-1)[0];lastRange&&lastRange.endRow===row-1?lastRange.endRow=row:columnRanges[column].push({startRow:row,endRow:row})}}for(const column in columnRanges){const currentColumnRanges=columnRanges[column];for(let i=0;i<currentColumnRanges.length;i++){const range=currentColumnRanges[i];dirtyRanges.push({unitId,sheetId,range:{rangeType:src.$uV.NORMAL,startRow:range.startRow,endRow:range.endRow,startColumn:Number(column),endColumn:Number(column)}})}}}}return dirtyRanges}_getSheetFormulaIdMap(unitId,sheetId){const formulaIdMap={},workbook=this._univerInstanceService.getUnit(unitId);if(null==workbook)return formulaIdMap;const worksheet=workbook.getSheetBySheetId(sheetId);if(null==worksheet)return formulaIdMap;return worksheet.getCellMatrix().forValue(((r,c,cell)=>{if(null==cell)return!0;const{f,si}=cell;(0,src.qGs)(f)&&(0,src.wJp)(si)&&(formulaIdMap[si]={f,r,c})})),formulaIdMap}}function initSheetFormulaData(formulaData,unitId,sheetId,cellMatrix){formulaData[unitId]||(formulaData[unitId]={}),formulaData[unitId][sheetId]||(formulaData[unitId][sheetId]={});const formulaIdMap=new Map,sheetFormulaDataMatrix=new src.hDc(formulaData[unitId][sheetId]);cellMatrix.forValue(((r,c,cell)=>{const formulaString=cell?.f||"",formulaId=cell?.si||"",checkFormulaString=(0,src.qGs)(formulaString),checkFormulaId=(0,src.wJp)(formulaId);checkFormulaString&&checkFormulaId?(sheetFormulaDataMatrix.setValue(r,c,{f:formulaString,si:formulaId}),formulaIdMap.set(formulaId,{f:formulaString,r,c})):checkFormulaString&&!checkFormulaId?sheetFormulaDataMatrix.setValue(r,c,{f:formulaString}):!checkFormulaString&&checkFormulaId&&sheetFormulaDataMatrix.setValue(r,c,{f:"",si:formulaId})})),sheetFormulaDataMatrix.forValue(((r,c,cell)=>{const formulaString=cell?.f||"",formulaId=cell?.si||"";if((0,src.wJp)(formulaId)&&!(0,src.qGs)(formulaString)){const formulaInfo=formulaIdMap.get(formulaId);if(formulaInfo){const f=formulaInfo.f,x=c-formulaInfo.c,y=r-formulaInfo.r;sheetFormulaDataMatrix.setValue(r,c,{f,si:formulaId,x,y})}else sheetFormulaDataMatrix.realDeleteValue(r,c)}}));const newSheetFormulaData=sheetFormulaDataMatrix.getMatrix();return{[unitId]:{[sheetId]:newSheetFormulaData}}}FormulaDataModel=function formula_data_model_ts_decorate(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r}([formula_data_model_ts_param(0,src.HCr),formula_data_model_ts_param(1,(0,src.y_5)(LexerTreeBuilder)),formula_data_model_ts_metadata("design:type",Function),formula_data_model_ts_metadata("design:paramtypes",[void 0===src.HCr?Object:src.HCr,void 0===LexerTreeBuilder?Object:LexerTreeBuilder])],FormulaDataModel);var main=__webpack_require__("../../node_modules/.pnpm/@flatten-js+interval-tree@1.1.3/node_modules/@flatten-js/interval-tree/dist/main.mjs");const CELL_INVERTED_INDEX_CACHE=new class InvertedIndexCache{set(unitId,sheetId,column,value,row){if(!this.shouldContinueBuildingCache(unitId,sheetId,column,row))return;let unitMap=this._cache.get(unitId);null==unitMap&&(unitMap=new Map,this._cache.set(unitId,unitMap));let sheetMap=unitMap.get(sheetId);null==sheetMap&&(sheetMap=new Map,unitMap.set(sheetId,sheetMap));let columnMap=sheetMap.get(column);null==columnMap&&(columnMap=new Map,sheetMap.set(column,columnMap));let cellList=columnMap.get(value);null==cellList&&(cellList=new Set,columnMap.set(value,cellList)),cellList.add(row)}getCellValuePositions(unitId,sheetId,column){return this._cache.get(unitId)?.get(sheetId)?.get(column)}getCellPositions(unitId,sheetId,column,value,rowsInCache){const rows=this._cache.get(unitId)?.get(sheetId)?.get(column)?.get(value);return rows&&[...rows].filter((row=>rowsInCache.some((([start,end])=>row>=start&&row<=end))))}setContinueBuildingCache(unitId,sheetId,column,startRow,endRow){if(-1===column||-1===startRow||-1===endRow)return;let unitMap=this._continueBuildingCache.get(unitId);null==unitMap&&(unitMap=new Map,this._continueBuildingCache.set(unitId,unitMap));let sheetMap=unitMap.get(sheetId);null==sheetMap&&(sheetMap=new Map,unitMap.set(sheetId,sheetMap));let columnMap=sheetMap.get(column);if(null==columnMap)return columnMap=new main.Ay,columnMap.insert([startRow,endRow]),void sheetMap.set(column,columnMap);this._handleNewInterval(columnMap,startRow,endRow)}shouldContinueBuildingCache(unitId,sheetId,column,row){if(-1===column||-1===row)return!1;const columnMap=this._continueBuildingCache.get(unitId)?.get(sheetId)?.get(column);if(!columnMap)return!0;return 0===columnMap.search([row,row]).length}canUseCache(unitId,sheetId,column,rangeStartRow,rangeEndRow){const columnMap=this._continueBuildingCache.get(unitId)?.get(sheetId)?.get(column);if(-1===column||-1===rangeStartRow||-1===rangeEndRow||!columnMap)return{rowsInCache:[],rowsNotInCache:[]};const result=columnMap.search([rangeStartRow,rangeEndRow]);if(0===result.length)return{rowsInCache:[],rowsNotInCache:[]};result.sort(((a,b)=>a[0]-b[0]));const rowsInCache=[],rowsNotInCache=[];let _rangeStartRow=rangeStartRow;for(let i=0;i<result.length;i++){const[start,end]=result[i];if(_rangeStartRow>=start){if(rangeEndRow<=end){rowsInCache.push([_rangeStartRow,rangeEndRow]);break}rowsInCache.push([_rangeStartRow,end]),_rangeStartRow=end+1,i===result.length-1&&_rangeStartRow<=rangeEndRow&&rowsNotInCache.push([_rangeStartRow,rangeEndRow])}else{if(rangeEndRow>end){rowsInCache.push([start,end]),rowsNotInCache.push([_rangeStartRow,start-1]),_rangeStartRow=end+1,i===result.length-1&&_rangeStartRow<=rangeEndRow&&rowsNotInCache.push([_rangeStartRow,rangeEndRow]);continue}rowsInCache.push([start,rangeEndRow]),rowsNotInCache.push([_rangeStartRow,start-1])}}return{rowsInCache,rowsNotInCache}}clear(){this._cache.clear(),this._continueBuildingCache.clear()}_handleNewInterval(columnMap,startRow,endRow){let result=columnMap.search([startRow,endRow]);if(0===result.length){const adjacentRange=[startRow-1<0?0:startRow-1,endRow+1];if(result=columnMap.search(adjacentRange),0===result.length)return void columnMap.insert([startRow,endRow])}let min=startRow,max=endRow;for(const interval of result)min=Math.min(min,interval[0]),max=Math.max(max,interval[1]),columnMap.remove(interval);columnMap.insert([min,max])}constructor(){this._cache=new Map,this._continueBuildingCache=new Map}},DEFAULT_CYCLE_REFERENCE_COUNT=1,defaultPluginConfig=(Symbol("engine-formula.config"),{});function current_data_service_ts_metadata(k,v){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(k,v)}function current_data_service_ts_param(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}}class FormulaCurrentConfigService extends src.jGt{constructor(_univerInstanceService,_localeService,_formulaDataModel){super(),this._univerInstanceService=_univerInstanceService,this._localeService=_localeService,this._formulaDataModel=_formulaDataModel,this._unitData={},this._unitStylesData={},this._arrayFormulaCellData={},this._arrayFormulaRange={},this._formulaData={},this._sheetNameMap={},this._forceCalculate=!1,this._clearDependencyTreeCache={},this._dirtyRanges=[],this._dirtyNameMap={},this._dirtyDefinedNameMap={},this._dirtyUnitFeatureMap={},this._dirtyUnitOtherFormulaMap={},this._sheetIdToNameMap={},this._executeUnitId="",this._executeSubUnitId=""}dispose(){super.dispose(),this._unitData={},this._unitStylesData={},this._arrayFormulaCellData={},this._arrayFormulaRange={},this._formulaData={},this._sheetNameMap={},this._clearDependencyTreeCache={},this._dirtyRanges=[],this._dirtyNameMap={},this._dirtyDefinedNameMap={},this._dirtyUnitFeatureMap={},this._dirtyUnitOtherFormulaMap={},this._excludedCell={},this._sheetIdToNameMap={}}getExecuteUnitId(){return this._executeUnitId}getExecuteSubUnitId(){return this._executeSubUnitId}setExecuteUnitId(unitId){this._executeUnitId=unitId}setExecuteSubUnitId(subUnitId){this._executeSubUnitId=subUnitId}getExcludedRange(){return this._excludedCell}getUnitData(){return this._unitData}getUnitStylesData(){return this._unitStylesData}getFormulaData(){return this._formulaData}getArrayFormulaCellData(){return this._arrayFormulaCellData}getArrayFormulaRange(){return this._arrayFormulaRange}getSheetNameMap(){return this._sheetNameMap}isForceCalculate(){return this._forceCalculate}getDirtyRanges(){return this._dirtyRanges}getDirtyNameMap(){return this._dirtyNameMap}getDirtyDefinedNameMap(){return this._dirtyDefinedNameMap}getDirtyUnitFeatureMap(){return this._dirtyUnitFeatureMap}getDirtyUnitOtherFormulaMap(){return this._dirtyUnitOtherFormulaMap}getSheetName(unitId,sheetId){return null==this._sheetIdToNameMap[unitId]?"":this._sheetIdToNameMap[unitId][sheetId]||""}getClearDependencyTreeCache(){return this._clearDependencyTreeCache}getLocale(){return this._localeService.getCurrentLocale()}getSheetsInfo(){const workbook=this._univerInstanceService.getCurrentUnitForType(src.Zy$.UNIVER_SHEET),{id,sheetOrder}=workbook.getSnapshot();return{sheetOrder,sheetNameMap:this._sheetIdToNameMap[id]}}getSheetRowColumnCount(unitId,sheetId){const workbook=this._univerInstanceService.getUnit(unitId),worksheet=workbook?.getSheetBySheetId(sheetId),snapshot=worksheet?.getSnapshot();if(!snapshot)return{rowCount:0,columnCount:0};const{rowCount,columnCount}=snapshot;return{rowCount,columnCount}}load(config){if(config.allUnitData&&config.unitSheetNameMap&&config.unitStylesData)this._unitData=config.allUnitData,this._unitStylesData=config.unitStylesData,this._sheetNameMap=config.unitSheetNameMap;else{const{allUnitData,unitSheetNameMap,unitStylesData}=this._loadSheetData();this._unitData=allUnitData,this._unitStylesData=unitStylesData,this._sheetNameMap=unitSheetNameMap}config.rowData&&this._applyUnitRowData(config.rowData),this._formulaData=config.formulaData,this._arrayFormulaCellData=function convertUnitDataToRuntime(unitData){const arrayFormulaCellData={};return Object.keys(unitData).forEach((unitId=>{const sheetData=unitData[unitId];if(null==sheetData)return!0;null==arrayFormulaCellData[unitId]&&(arrayFormulaCellData[unitId]={}),Object.keys(sheetData).forEach((sheetId=>{const cellData=sheetData[sheetId];arrayFormulaCellData[unitId][sheetId]=new src.hDc(cellData)}))})),arrayFormulaCellData}(config.arrayFormulaCellData),this._arrayFormulaRange=config.arrayFormulaRange,this._forceCalculate=config.forceCalculate,this._clearDependencyTreeCache=config.clearDependencyTreeCache||{},this._dirtyRanges=config.dirtyRanges,this._dirtyNameMap=config.dirtyNameMap,this._dirtyDefinedNameMap=config.dirtyDefinedNameMap,this._dirtyUnitFeatureMap=config.dirtyUnitFeatureMap,this._dirtyUnitOtherFormulaMap=config.dirtyUnitOtherFormulaMap,this._excludedCell=config.excludedCell,this._mergeNameMap(this._sheetNameMap,this._dirtyNameMap)}getDirtyData(){return{forceCalculation:this._forceCalculate,dirtyRanges:this._dirtyRanges,dirtyNameMap:this._dirtyNameMap,dirtyDefinedNameMap:this._dirtyDefinedNameMap,dirtyUnitFeatureMap:this._dirtyUnitFeatureMap,dirtyUnitOtherFormulaMap:this._dirtyUnitOtherFormulaMap,clearDependencyTreeCache:this._clearDependencyTreeCache}}loadDirtyRangesAndExcludedCell(dirtyRanges,excludedCell){this._dirtyRanges=dirtyRanges,this._excludedCell=excludedCell,this._dirtyNameMap={}}registerUnitData(unitData){this._unitData=unitData}registerFormulaData(formulaData){this._formulaData=formulaData}registerSheetNameMap(sheetNameMap){this._sheetNameMap=sheetNameMap}_mergeNameMap(unitSheetNameMap,dirtyNameMap){Object.keys(dirtyNameMap).forEach((unitId=>{dirtyNameMap[unitId]&&Object.keys(dirtyNameMap[unitId]).forEach((sheetId=>{null==unitSheetNameMap[unitId]&&(unitSheetNameMap[unitId]={}),unitSheetNameMap[unitId][dirtyNameMap[unitId][sheetId]]=sheetId}))})),this._sheetIdToNameMap={},Object.keys(unitSheetNameMap).forEach((unitId=>{Object.keys(unitSheetNameMap[unitId]).forEach((sheetName=>{null==this._sheetIdToNameMap[unitId]&&(this._sheetIdToNameMap[unitId]={}),this._sheetIdToNameMap[unitId][unitSheetNameMap[unitId][sheetName]]=sheetName}))}))}_loadSheetData(){const workbook=this._univerInstanceService.getCurrentUnitForType(src.Zy$.UNIVER_SHEET),worksheet=workbook?.getActiveSheet();return this._executeUnitId=workbook?.getUnitId(),this._executeSubUnitId=worksheet?.getSheetId(),this._formulaDataModel.getCalculateData()}_applyUnitRowData(rowData){for(const unitId in rowData)if(null!=rowData[unitId])for(const sheetId in rowData[unitId])null!=rowData[unitId][sheetId]&&(null==this._unitData[unitId]&&(this._unitData[unitId]={}),null==this._unitData[unitId][sheetId]&&(this._unitData[unitId][sheetId]={cellData:new src.hDc({}),rowCount:0,columnCount:0,rowData:{},columnData:{}}),this._unitData[unitId][sheetId].rowData=rowData[unitId][sheetId])}}FormulaCurrentConfigService=function current_data_service_ts_decorate(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r}([current_data_service_ts_param(0,src.HCr),current_data_service_ts_param(1,(0,src.y_5)(src.iH9)),current_data_service_ts_param(2,(0,src.y_5)(FormulaDataModel)),current_data_service_ts_metadata("design:type",Function),current_data_service_ts_metadata("design:paramtypes",[void 0===src.HCr?Object:src.HCr,void 0===src.iH9?Object:src.iH9,void 0===FormulaDataModel?Object:FormulaDataModel])],FormulaCurrentConfigService);const IFormulaCurrentConfigService=(0,src.Qmd)("univer.formula.current-data.service");function lexer_ts_metadata(k,v){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(k,v)}function lexer_ts_param(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}}class Lexer extends src.jGt{constructor(_definedNamesService,_lexerTreeBuilder,_formulaCurrentConfigService){super(),this._definedNamesService=_definedNamesService,this._lexerTreeBuilder=_lexerTreeBuilder,this._formulaCurrentConfigService=_formulaCurrentConfigService}treeBuilder(formulaString,transformSuffix=!0){return this._lexerTreeBuilder.treeBuilder(formulaString,transformSuffix,this._injectDefinedName.bind(this),this._simpleCheckDefinedName.bind(this))}_simpleCheckDefinedName(formulaString){const definedNameMap=this._formulaCurrentConfigService.getDirtyDefinedNameMap(),executeUnitId=this._formulaCurrentConfigService.getExecuteUnitId();if(null!=executeUnitId&&null!=definedNameMap[executeUnitId]){const names=Object.keys(definedNameMap[executeUnitId]);for(let i=0,len=names.length;i<len;i++){const name=names[i];if(formulaString.indexOf(name)>-1)return!0}}return!1}_checkDefinedNameDirty(token){const definedNameMap=this._formulaCurrentConfigService.getDirtyDefinedNameMap(),executeUnitId=this._formulaCurrentConfigService.getExecuteUnitId();if(null!=executeUnitId&&null!=definedNameMap[executeUnitId]){const names=Object.keys(definedNameMap[executeUnitId]);for(let i=0,len=names.length;i<len;i++){if(names[i]===token)return!0}}return!1}_injectDefinedName(sequenceArray){const unitId=this._formulaCurrentConfigService.getExecuteUnitId();if(null==unitId)return{sequenceString:"",hasDefinedName:!1,definedNames:[]};const sequenceNodes=this._lexerTreeBuilder.getSequenceNode(sequenceArray);let sequenceString="",hasDefinedName=!1;const definedNames=[];for(let i=0,len=sequenceNodes.length;i<len;i++){const node=sequenceNodes[i];if("string"==typeof node){sequenceString+=node;continue}const{nodeType,token}=node;if(nodeType===sequenceNodeType.REFERENCE||nodeType===sequenceNodeType.FUNCTION){const definedContent=this._definedNamesService.getValueByName(unitId,token);if(definedContent){let refString=definedContent.formulaOrRefString;refString.substring(0,1)===operatorToken.EQUALS&&(refString=refString.substring(1)),sequenceString+=refString,definedNames.push(definedContent.name),hasDefinedName=!0}else this._checkDefinedNameDirty(token)?(sequenceString+=error_type_ErrorType.NAME,hasDefinedName=!0,definedNames.push(token)):sequenceString+=token}else sequenceString+=token}return{sequenceString,hasDefinedName,definedNames}}}function isNullCellForFormula(cell){if(null==cell)return!0;const{v,f,si,p}=cell;return(null==v||"string"==typeof v&&0===v.length)&&(!(null!=f&&f.length>0||null!=si&&si.length>0)&&null==p)}function getRuntimeFeatureCell(row,column,sheetId,unitId,runtimeFeatureCellData){const featureKeys=Object.keys(runtimeFeatureCellData);for(const featureId of featureKeys){const data=runtimeFeatureCellData[featureId],CellData=data?.[unitId]?.[sheetId];if(null==CellData)continue;const value=CellData.getValue(row,column);if(null!=value)return value}}Lexer=function lexer_ts_decorate(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r}([lexer_ts_param(0,IDefinedNamesService),lexer_ts_param(1,(0,src.y_5)(LexerTreeBuilder)),lexer_ts_param(2,IFormulaCurrentConfigService),lexer_ts_metadata("design:type",Function),lexer_ts_metadata("design:paramtypes",[void 0===IDefinedNamesService?Object:IDefinedNamesService,void 0===LexerTreeBuilder?Object:LexerTreeBuilder,void 0===IFormulaCurrentConfigService?Object:IFormulaCurrentConfigService])],Lexer);const currencySymbols=["$","£","¥","¤","֏","؋","৳","฿","៛","₡","₦","₩","₪","₫","€","₭","₮","₱","₲","₴","₸","₹","₺","₼","₽","₾","₿"];const NumberFormatTypeMap={currency:2,date:4,datetime:5,error:11,fraction:7,general:0,grouped:11,number:1,percent:6,scientific:8,text:9,time:5,unknown:11};function handleNumfmtInCell(oldCell,cell,styles){if(null==oldCell||null==cell)return cell;const oldCellStyle=styles?.getStyleByCell(oldCell)||oldCell.s,cellStyle=styles?.getStyleByCell(cell)||cell.s;if(null==oldCellStyle||null==cellStyle||"object"!=typeof oldCellStyle||"object"!=typeof cellStyle)return cell;const oldPattern=oldCellStyle?.n?.pattern,pattern=cellStyle?.n?.pattern;if(null==oldPattern||null==pattern)return cell;const newPattern=oldPattern||pattern;return cellStyle.n.pattern=newPattern,cell}const numberFormatTypeCache=new FormulaAstLRU(1e5);function getNumberFormatType(pattern){const patternTypeCache=numberFormatTypeCache.get(pattern);if(void 0!==patternTypeCache)return patternTypeCache;const type=function getNumberFormatTypeRaw(pattern){if(function isAccounting(pattern){return!!currencySymbols.find((code=>pattern.includes(code)))&&pattern.startsWith("_(")}(pattern))return 3;const type=src.gIL.getInfo(pattern).type||"unknown";return NumberFormatTypeMap[type]}(pattern);return numberFormatTypeCache.set(pattern,type),type}function comparePatternPriority(previousPattern,nextPattern,operator){if(""===previousPattern)return nextPattern;if(""===nextPattern)return previousPattern;const previousPatternType=getNumberFormatType(previousPattern),nextPatternType=getNumberFormatType(nextPattern);return operator===operatorToken.PLUS||operator===operatorToken.MINUS?4===previousPatternType&&4===nextPatternType||11===previousPatternType&&11===nextPatternType?"":nextPattern:operator===operatorToken.MULTIPLY||operator===operatorToken.DIVIDED?6===previousPatternType&&6===nextPatternType||7===previousPatternType&&7===nextPatternType||8===previousPatternType&&8===nextPatternType||9===previousPatternType&&9===nextPatternType?nextPattern:"":previousPattern||nextPattern}const countryCurrencySymbolMap=new Map([[src.VnV.EN_US,"$"],[src.VnV.RU_RU,"₽"],[src.VnV.VI_VN,"₫"],[src.VnV.ZH_CN,"¥"],[src.VnV.ZH_TW,"NT$"]]);function getCurrencySymbol(locale){return countryCurrencySymbolMap.get(locale)||"$"}function getCurrencyFormat(locale,numberDigits=2){let _numberDigits=numberDigits;numberDigits>127&&(_numberDigits=127);let decimal="";return _numberDigits>0&&(decimal=`.${"0".repeat(_numberDigits)}`),`"${getCurrencySymbol(locale)}"#,##0${decimal}_);[Red]("${getCurrencySymbol(locale)}"#,##0${decimal})`}const stringToNumberPatternCache=new FormulaAstLRU(1e5);function setNumberPatternCache(input,value,pattern){return stringToNumberPatternCache.set(input,{value,pattern}),{isNumberPattern:!0,value,pattern}}class ObjectClassType{dispose(){}getPattern(){return this.pattern}setPattern(pattern){this.pattern=pattern}isError(){return!1}isAsyncObject(){return!1}isAsyncArrayObject(){return!1}isReferenceObject(){return!1}isArray(){return!1}isValueObject(){return!1}isEqualType(object){return!1}constructor(){this.pattern=""}}class BaseValueObject extends ObjectClassType{constructor(_rawValue){super(),this._rawValue=_rawValue}isValueObject(){return!0}toUnitRange(){return{range:{startColumn:-1,startRow:-1,endRow:-1,endColumn:-1},sheetId:"",unitId:""}}getValue(){return 0}getArrayValue(){return[]}setValue(value){}setArrayValue(value){}withCustomData(data){return this._customData=data,this}getCustomData(){return this._customData}isCube(){return!1}isString(){return!1}isNumber(){return!1}isBoolean(){return!1}isLambda(){return!1}isError(){return!1}isNull(){return!1}sum(){return ErrorValueObject.create(error_type_ErrorType.VALUE)}max(){return ErrorValueObject.create(error_type_ErrorType.VALUE)}min(){return ErrorValueObject.create(error_type_ErrorType.VALUE)}count(){return ErrorValueObject.create(error_type_ErrorType.VALUE)}countA(){return ErrorValueObject.create(error_type_ErrorType.VALUE)}countBlank(){return ErrorValueObject.create(error_type_ErrorType.VALUE)}getNegative(){return ErrorValueObject.create(error_type_ErrorType.VALUE)}getReciprocal(){return ErrorValueObject.create(error_type_ErrorType.VALUE)}plus(valueObject){return ErrorValueObject.create(error_type_ErrorType.VALUE)}minus(valueObject){return ErrorValueObject.create(error_type_ErrorType.VALUE)}multiply(valueObject){return ErrorValueObject.create(error_type_ErrorType.VALUE)}divided(valueObject){return ErrorValueObject.create(error_type_ErrorType.VALUE)}mod(valueObject){return ErrorValueObject.create(error_type_ErrorType.VALUE)}map(callbackFn){return ErrorValueObject.create(error_type_ErrorType.NAME)}mapValue(callbackFn){return ErrorValueObject.create(error_type_ErrorType.NAME)}compare(valueObject,operator,isCaseSensitive=!1){return ErrorValueObject.create(error_type_ErrorType.NAME)}isEqual(valueObject){return this.compare(valueObject,compareToken.EQUALS)}isNotEqual(valueObject){return this.compare(valueObject,compareToken.NOT_EQUAL)}isGreaterThanOrEqual(valueObject){return this.compare(valueObject,compareToken.GREATER_THAN_OR_EQUAL)}isLessThanOrEqual(valueObject){return this.compare(valueObject,compareToken.LESS_THAN_OR_EQUAL)}isLessThan(valueObject){return this.compare(valueObject,compareToken.LESS_THAN)}isGreaterThan(valueObject){return this.compare(valueObject,compareToken.GREATER_THAN)}concatenateFront(valueObject){return ErrorValueObject.create(error_type_ErrorType.NAME)}concatenateBack(valueObject){return ErrorValueObject.create(error_type_ErrorType.NAME)}plusBy(value){return ErrorValueObject.create(error_type_ErrorType.VALUE)}minusBy(value){return ErrorValueObject.create(error_type_ErrorType.VALUE)}multiplyBy(value){return ErrorValueObject.create(error_type_ErrorType.VALUE)}dividedBy(value){return ErrorValueObject.create(error_type_ErrorType.VALUE)}modInverse(valueObject){return ErrorValueObject.create(error_type_ErrorType.VALUE)}compareBy(value,operator){return ErrorValueObject.create(error_type_ErrorType.NAME)}concatenate(value,concatenateType=ConcatenateType.FRONT){let currentValue=this.getValue().toString();if("string"==typeof value)concatenateType===ConcatenateType.FRONT?currentValue=value+currentValue:currentValue+=value;else if("number"==typeof value)concatenateType===ConcatenateType.FRONT?currentValue=value.toString()+currentValue:currentValue+=value.toString();else if("boolean"==typeof value){const booleanString=value?"TRUE":"FALSE";concatenateType===ConcatenateType.FRONT?currentValue=booleanString+currentValue:currentValue+=booleanString}return currentValue}pow(valueObject){return ErrorValueObject.create(error_type_ErrorType.VALUE)}powInverse(valueObject){return ErrorValueObject.create(error_type_ErrorType.VALUE)}sqrt(){return ErrorValueObject.create(error_type_ErrorType.VALUE)}cbrt(){return ErrorValueObject.create(error_type_ErrorType.VALUE)}cos(){return ErrorValueObject.create(error_type_ErrorType.VALUE)}cosh(){return ErrorValueObject.create(error_type_ErrorType.VALUE)}acos(){return ErrorValueObject.create(error_type_ErrorType.VALUE)}acosh(){return ErrorValueObject.create(error_type_ErrorType.VALUE)}sin(){return ErrorValueObject.create(error_type_ErrorType.VALUE)}sinh(){return ErrorValueObject.create(error_type_ErrorType.VALUE)}asin(){return ErrorValueObject.create(error_type_ErrorType.VALUE)}asinh(){return ErrorValueObject.create(error_type_ErrorType.VALUE)}tan(){return ErrorValueObject.create(error_type_ErrorType.VALUE)}tanh(){return ErrorValueObject.create(error_type_ErrorType.VALUE)}atan(){return ErrorValueObject.create(error_type_ErrorType.VALUE)}atan2(valueObject){return ErrorValueObject.create(error_type_ErrorType.VALUE)}atan2Inverse(valueObject){return ErrorValueObject.create(error_type_ErrorType.VALUE)}atanh(){return ErrorValueObject.create(error_type_ErrorType.VALUE)}mean(){return this}median(){return this}var(){return this}std(){return this}log(){return ErrorValueObject.create(error_type_ErrorType.VALUE)}log10(){return ErrorValueObject.create(error_type_ErrorType.VALUE)}exp(){return ErrorValueObject.create(error_type_ErrorType.VALUE)}abs(){return ErrorValueObject.create(error_type_ErrorType.VALUE)}round(valueObject){return ErrorValueObject.create(error_type_ErrorType.VALUE)}roundInverse(valueObject){return ErrorValueObject.create(error_type_ErrorType.VALUE)}floor(valueObject){return ErrorValueObject.create(error_type_ErrorType.VALUE)}floorInverse(valueObject){return ErrorValueObject.create(error_type_ErrorType.VALUE)}ceil(valueObject){return ErrorValueObject.create(error_type_ErrorType.VALUE)}ceilInverse(valueObject){return ErrorValueObject.create(error_type_ErrorType.VALUE)}convertToNumberObjectValue(){return ErrorValueObject.create(error_type_ErrorType.VALUE)}convertToBooleanObjectValue(){return ErrorValueObject.create(error_type_ErrorType.VALUE)}}const ErrorValueObjectCache=new FormulaAstLRU(1e3);class ErrorValueObject extends BaseValueObject{static create(errorType,errorContent=""){const key=`${errorType}-${errorContent}`,cached=ErrorValueObjectCache.get(key);if(cached)return cached;const instance=new ErrorValueObject(errorType,errorContent);return ErrorValueObjectCache.set(key,instance),instance}constructor(_errorType,_errorContent=""){super(_errorType),this._errorType=_errorType,this._errorContent=_errorContent}getValue(){return this._errorType}getErrorType(){return this._errorType}getErrorContent(){return this._errorContent}isEqualType(object){return object.getErrorType()===this.getErrorType()}isError(){return!0}}var util=__webpack_require__("../../packages/engine-numfmt/src/util.ts");var ArrayBinarySearchType=function(ArrayBinarySearchType){return ArrayBinarySearchType[ArrayBinarySearchType.MIN=0]="MIN",ArrayBinarySearchType[ArrayBinarySearchType.MAX=1]="MAX",ArrayBinarySearchType}({}),ArrayOrderSearchType=function(ArrayOrderSearchType){return ArrayOrderSearchType[ArrayOrderSearchType.NORMAL=0]="NORMAL",ArrayOrderSearchType[ArrayOrderSearchType.MIN=1]="MIN",ArrayOrderSearchType[ArrayOrderSearchType.MAX=2]="MAX",ArrayOrderSearchType}({});function getCompare(){return Intl&&Intl.Collator?new Intl.Collator(void 0,{numeric:!1}).compare:(a,b)=>a.localeCompare(b)}function isMatchWildcard(currentValue,value){const pattern=function escapeRegExp(str){return str.replace(/[.+^${}()|[\]\\]/g,"\\$&")}(value).replace(/~?[*?]/g,(match=>match.startsWith("~")?`\\${match.substring(1)}`:"*"===match?".*":"?"===match?".":match));return new RegExp(`^${pattern}$`).test(currentValue)}function replaceWildcard(value){return value.replace(/~?[*?]/g,(match=>match.startsWith("~")?match.substring(1):" "))}function getMatchModeValue(matchModeValue){switch(matchModeValue){case 1:return 2;case 0:return 0;case-1:return 1;default:return 0}}function getSearchModeValue(searchModeValue){return-2===searchModeValue?1:0}function reverseCompareOperator(operator){let result;switch(operator){case compareToken.EQUALS:result=compareToken.EQUALS;break;case compareToken.GREATER_THAN:result=compareToken.LESS_THAN;break;case compareToken.GREATER_THAN_OR_EQUAL:result=compareToken.LESS_THAN_OR_EQUAL;break;case compareToken.LESS_THAN:result=compareToken.GREATER_THAN;break;case compareToken.LESS_THAN_OR_EQUAL:result=compareToken.GREATER_THAN_OR_EQUAL;break;case compareToken.NOT_EQUAL:result=compareToken.NOT_EQUAL}return result}var decimal=__webpack_require__("../../node_modules/.pnpm/decimal.js@10.4.3/node_modules/decimal.js/decimal.mjs");function multiply(a,b){const result=a*b;return Number.isSafeInteger(result)?result:new decimal.A(a).mul(b).toNumber()}function round(base,precision){const factor=10**Math.trunc(precision),epsilon=baseEpsilon(base,factor);return Math.round(multiply(base,factor)+epsilon)/factor}function floor(base,precision){const factor=10**Math.trunc(precision),epsilon=baseEpsilon(base,factor);return Math.floor(multiply(base,factor)+epsilon)/factor}function ceil(base,precision){const factor=10**Math.trunc(precision),epsilon=baseEpsilon(base,factor);return Math.ceil(multiply(base,factor)-epsilon)/factor}function baseEpsilon(base,factor){return Number.EPSILON*Math.max(1,Math.abs(multiply(base,factor)))}function mod(base,divisor){return base-divisor*Math.floor(base/divisor)}function equals(a,b){return a===b}function strip(num,precision=15){return Number.parseFloat(num.toPrecision(precision))}function stripErrorMargin(num,precision=12,tolerance=1e-10){const stripResult=strip(num,precision);return function withinErrorMargin(left,right,tolerance=Number.EPSILON){return Math.abs(left-right)<tolerance}(num,stripResult,tolerance)?stripResult:strip(num)}class NullValueObject extends BaseValueObject{static create(){return this._instance=this._instance||new NullValueObject(0),this._instance}isNull(){return!0}plus(valueObject){return NumberValueObject.create(0).plus(valueObject)}minus(valueObject){return NumberValueObject.create(0).minus(valueObject)}multiply(valueObject){return NumberValueObject.create(0).multiply(valueObject)}divided(valueObject){return NumberValueObject.create(0).divided(valueObject)}mod(valueObject){return NumberValueObject.create(0).mod(valueObject)}compare(valueObject,operator){return valueObject.isString()?StringValueObject.create("").compare(valueObject,operator):valueObject.isBoolean()?BooleanValueObject.create(!1).compare(valueObject,operator):NumberValueObject.create(0).compare(valueObject,operator)}concatenateFront(valueObject){return valueObject.isArray()?valueObject.concatenateBack(StringValueObject.create("")):StringValueObject.create(this.concatenate(valueObject.getValue(),ConcatenateType.FRONT))}concatenateBack(valueObject){return valueObject.isArray()?valueObject.concatenateFront(StringValueObject.create("")):StringValueObject.create(this.concatenate(valueObject.getValue(),ConcatenateType.BACK))}plusBy(value){return NumberValueObject.create(0).plusBy(value)}minusBy(value){return NumberValueObject.create(0).minusBy(value)}multiplyBy(value){return NumberValueObject.create(0).multiplyBy(value)}dividedBy(value){return NumberValueObject.create(0).dividedBy(value)}compareBy(value,operator){return"string"==typeof value?StringValueObject.create("").compareBy(value,operator):"boolean"==typeof value?BooleanValueObject.create(!1).compareBy(value,operator):NumberValueObject.create(0).compareBy(value,operator)}pow(valueObject){return NumberValueObject.create(0).pow(valueObject)}sqrt(){return NumberValueObject.create(0).sqrt()}cbrt(){return NumberValueObject.create(0).cbrt()}cos(){return NumberValueObject.create(0).cos()}cosh(){return NumberValueObject.create(0).cosh()}acos(){return NumberValueObject.create(0).acos()}acosh(){return NumberValueObject.create(0).acosh()}sin(){return NumberValueObject.create(0).sin()}sinh(){return NumberValueObject.create(0).sinh()}asin(){return NumberValueObject.create(0).asin()}asinh(){return NumberValueObject.create(0).asinh()}tan(){return NumberValueObject.create(0).tan()}tanh(){return NumberValueObject.create(0).tanh()}atan(){return NumberValueObject.create(0).atan()}atan2(valueObject){return NumberValueObject.create(0).atan2(valueObject)}atanh(){return NumberValueObject.create(0).atanh()}log(){return ErrorValueObject.create(error_type_ErrorType.NUM)}log10(){return ErrorValueObject.create(error_type_ErrorType.NUM)}exp(){return NumberValueObject.create(0).exp()}abs(){return NumberValueObject.create(0).abs()}round(valueObject){return NumberValueObject.create(0).round(valueObject)}floor(valueObject){return NumberValueObject.create(0).floor(valueObject)}ceil(valueObject){return NumberValueObject.create(0).ceil(valueObject)}convertToNumberObjectValue(){return NumberValueObject.create(0)}convertToBooleanObjectValue(){return BooleanValueObject.create(!1)}}class BooleanValueObject extends BaseValueObject{static create(value){return value?(this._instanceTrue=this._instanceTrue||new BooleanValueObject(!0),this._instanceTrue):(this._instanceFalse=this._instanceFalse||new BooleanValueObject(!1),this._instanceFalse)}constructor(rawValue){super(rawValue),this._value=!1,this._value=rawValue}getValue(){return this._value}isBoolean(){return!0}getNegative(){let result=0;return this.getValue()&&(result=1),NumberValueObject.create(-result)}getReciprocal(){return this.getValue()?NumberValueObject.create(1):ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO)}plus(valueObject){return this._convertToNumber().plus(valueObject)}minus(valueObject){return this._convertToNumber().minus(valueObject)}multiply(valueObject){return this._convertToNumber().multiply(valueObject)}divided(valueObject){return this._convertToNumber().divided(valueObject)}mod(valueObject){return this._convertToNumber().mod(valueObject)}compare(valueObject,operator){return valueObject.isArray()?valueObject.compare(this,reverseCompareOperator(operator)):valueObject.isNull()?this._convertToNumber().compare(valueObject,operator):this.compareBy(valueObject.getValue(),operator)}compareBy(value,operator){let result=!1;if("string"==typeof value||"number"==typeof value)result=this._compareString(operator);else if("boolean"==typeof value){const booleanNumber=NumberValueObject.create(value?1:0);return this._convertToNumber().compare(booleanNumber,operator)}return BooleanValueObject.create(result)}_compareString(operator){switch(operator){case compareToken.GREATER_THAN:case compareToken.GREATER_THAN_OR_EQUAL:return!0;case compareToken.EQUALS:case compareToken.LESS_THAN:case compareToken.LESS_THAN_OR_EQUAL:case compareToken.NOT_EQUAL:return!1}}concatenateFront(valueObject){return this._convertToNumber().concatenateFront(valueObject)}concatenateBack(valueObject){return this._convertToNumber().concatenateBack(valueObject)}_convertToNumber(){let result=0;return this.getValue()&&(result=1),NumberValueObject.create(result)}pow(valueObject){return this._convertToNumber().pow(valueObject)}sqrt(){return this._convertToNumber().sqrt()}cbrt(){return this._convertToNumber().cbrt()}cos(){return this._convertToNumber().cos()}cosh(){return this._convertToNumber().cosh()}acos(){return this._convertToNumber().acos()}acosh(){return this._convertToNumber().acosh()}sin(){return this._convertToNumber().sin()}sinh(){return this._convertToNumber().sinh()}asin(){return this._convertToNumber().asin()}asinh(){return this._convertToNumber().asinh()}tan(){return this._convertToNumber().tan()}tanh(){return this._convertToNumber().tanh()}atan(){return this._convertToNumber().atan()}atan2(valueObject){return this._convertToNumber().atan2(valueObject)}atanh(){return this._convertToNumber().atanh()}log(){return this._convertToNumber().log()}log10(){return this._convertToNumber().log10()}exp(){return this._convertToNumber().exp()}abs(){return this._convertToNumber().abs()}round(valueObject){return this._convertToNumber().round(valueObject)}floor(valueObject){return this._convertToNumber().floor(valueObject)}ceil(valueObject){return this._convertToNumber().ceil(valueObject)}convertToNumberObjectValue(){return createNumberValueObjectByRawValue(this.getValue())}convertToBooleanObjectValue(){return this}}class NumberValueObject extends BaseValueObject{static create(value,pattern=""){const instance=new NumberValueObject(value);return pattern&&instance.setPattern(pattern),instance}constructor(rawValue){super(rawValue),this._value=0,this._value=Number(rawValue)}getValue(){return this._value}setValue(value){this._value=value}isNumber(){return!0}getNegative(){return NumberValueObject.create(0).minus(this)}getReciprocal(){return NumberValueObject.create(1).divided(this)}plus(valueObject){if(valueObject.isArray())return valueObject.plus(this);let object=this.plusBy(valueObject.getValue());if(object.isError())return object;const pattern=comparePatternPriority(this.getPattern(),valueObject.getPattern(),operatorToken.PLUS);return object=NumberValueObject.create(Number(object.getValue()),pattern),object}equalZero(){return 0===this._value}minus(valueObject){if(valueObject.isArray()){const o=valueObject.getNegative();return o.isError()?o:o.plus(this)}let object=this.minusBy(valueObject.getValue());if(object.isError())return object;const pattern=comparePatternPriority(this.getPattern(),valueObject.getPattern(),operatorToken.MINUS);return object=NumberValueObject.create(Number(object.getValue()),pattern),object}multiply(valueObject){if(valueObject.isArray())return valueObject.multiply(this);let object=this.multiplyBy(valueObject.getValue());if(object.isError())return object;const pattern=comparePatternPriority(this.getPattern(),valueObject.getPattern(),operatorToken.MULTIPLY);return object=NumberValueObject.create(Number(object.getValue()),pattern),object}divided(valueObject){if(valueObject.isArray()){const o=valueObject.getReciprocal();return o.isError()?o:o.multiply(this)}let object=this.dividedBy(valueObject.getValue());if(object.isError())return object;const pattern=comparePatternPriority(this.getPattern(),valueObject.getPattern(),operatorToken.DIVIDED);return object=NumberValueObject.create(Number(object.getValue()),pattern),object}mod(valueObject){if(valueObject.isArray())return valueObject.modInverse(this);const currentValue=this.getValue(),value=valueObject.getValue();if(valueObject.isNull())return ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO);if("string"==typeof value)return ErrorValueObject.create(error_type_ErrorType.VALUE);if("number"==typeof value){if(0===value)return ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO);if(!Number.isFinite(currentValue)||!Number.isFinite(value))return ErrorValueObject.create(error_type_ErrorType.NUM);if(11259e8*Math.abs(value)<=Math.abs(currentValue))return ErrorValueObject.create(error_type_ErrorType.NUM);const result=mod(currentValue,value);return Number.isFinite(result)?NumberValueObject.create(result):ErrorValueObject.create(error_type_ErrorType.NUM)}if("boolean"==typeof value){const booleanValue=value?1:0;return 0===booleanValue?ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO):NumberValueObject.create(mod(currentValue,booleanValue))}return this}concatenateFront(valueObject){return valueObject.isArray()?valueObject.concatenateBack(this):StringValueObject.create(this.concatenate(valueObject.getValue(),ConcatenateType.FRONT))}concatenateBack(valueObject){return valueObject.isArray()?valueObject.concatenateFront(this):StringValueObject.create(this.concatenate(valueObject.getValue(),ConcatenateType.BACK))}compare(valueObject,operator){return valueObject.isArray()?valueObject.compare(this,reverseCompareOperator(operator)):this.compareBy(valueObject.getValue(),operator)}plusBy(value){const currentValue=+this.getValue(),_value=+value;if(Number.isNaN(currentValue)||Number.isNaN(_value))return ErrorValueObject.create(error_type_ErrorType.VALUE);if(!Number.isFinite(currentValue)||!Number.isFinite(_value))return ErrorValueObject.create(error_type_ErrorType.NUM);const result=function plus(a,b){const result=a+b;return Number.isSafeInteger(result)?result:new decimal.A(a).add(b).toNumber()}(currentValue,_value);return Number.isFinite(result)?NumberValueObject.create(result):ErrorValueObject.create(error_type_ErrorType.NUM)}minusBy(value){const currentValue=+this.getValue(),_value=+value;if(Number.isNaN(currentValue)||Number.isNaN(_value))return ErrorValueObject.create(error_type_ErrorType.VALUE);if(!Number.isFinite(currentValue)||!Number.isFinite(_value))return ErrorValueObject.create(error_type_ErrorType.NUM);const result=function minus(a,b){const result=a-b;return Number.isSafeInteger(result)?result:new decimal.A(a).sub(b).toNumber()}(currentValue,_value);return Number.isFinite(result)?NumberValueObject.create(result):ErrorValueObject.create(error_type_ErrorType.NUM)}multiplyBy(value){const currentValue=+this.getValue(),_value=+value;if(Number.isNaN(currentValue)||Number.isNaN(_value))return ErrorValueObject.create(error_type_ErrorType.VALUE);if(!Number.isFinite(currentValue)||!Number.isFinite(_value))return ErrorValueObject.create(error_type_ErrorType.NUM);const result=multiply(currentValue,_value);return Number.isFinite(result)?NumberValueObject.create(result):ErrorValueObject.create(error_type_ErrorType.NUM)}dividedBy(value){const currentValue=+this.getValue(),_value=+value;if(Number.isNaN(currentValue)||Number.isNaN(_value))return ErrorValueObject.create(error_type_ErrorType.VALUE);if(!Number.isFinite(currentValue)||!Number.isFinite(_value))return ErrorValueObject.create(error_type_ErrorType.NUM);if(0===_value)return ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO);const result=function divide(a,b){const result=a/b;return Number.isSafeInteger(result)?result:new decimal.A(a).div(b).toNumber()}(currentValue,_value);return Number.isFinite(result)?NumberValueObject.create(result):ErrorValueObject.create(error_type_ErrorType.NUM)}compareBy(value,operator){const currentValue=this.getValue();let result=!1;return"string"==typeof value?result=this._compareString(operator):"number"==typeof value?result=this._compareNumber(currentValue,value,operator):"boolean"==typeof value&&(result=this._compareBoolean(operator)),BooleanValueObject.create(result)}_compareString(operator){switch(operator){case compareToken.EQUALS:case compareToken.GREATER_THAN:case compareToken.GREATER_THAN_OR_EQUAL:return!1;case compareToken.LESS_THAN:case compareToken.LESS_THAN_OR_EQUAL:case compareToken.NOT_EQUAL:return!0}}_compareNumber(currentValue,value,operator){return Number.isFinite(currentValue)&&Number.isFinite(value)?this._compareFiniteNumber(currentValue,value,operator):this._compareInfinity(currentValue,value,operator)}_compareFiniteNumber(currentValue,value,operator){switch(operator){case compareToken.EQUALS:return equals(currentValue,value);case compareToken.GREATER_THAN:return function greaterThan(a,b){return a>b}(currentValue,value);case compareToken.GREATER_THAN_OR_EQUAL:return function greaterThanOrEquals(a,b){return a>=b}(currentValue,value);case compareToken.LESS_THAN:return function lessThan(a,b){return a<b}(currentValue,value);case compareToken.LESS_THAN_OR_EQUAL:return function lessThanOrEquals(a,b){return a<=b}(currentValue,value);case compareToken.NOT_EQUAL:return!equals(currentValue,value)}}_compareBoolean(operator){switch(operator){case compareToken.EQUALS:case compareToken.GREATER_THAN:case compareToken.GREATER_THAN_OR_EQUAL:return!1;case compareToken.LESS_THAN:case compareToken.LESS_THAN_OR_EQUAL:case compareToken.NOT_EQUAL:return!0}}pow(valueObject){if(valueObject.isArray())return valueObject.powInverse(this);if(this.isError())return this;const currentValue=this.getValue();let _valueObject=valueObject;if(valueObject.isString()&&(_valueObject=valueObject.convertToNumberObjectValue()),_valueObject.isError())return _valueObject;const value=+_valueObject.getValue();if(Number.isNaN(value))return ErrorValueObject.create(error_type_ErrorType.VALUE);if(!Number.isFinite(currentValue)||!Number.isFinite(value))return ErrorValueObject.create(error_type_ErrorType.NUM);if(0===currentValue)return value<0?ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO):0===value?ErrorValueObject.create(error_type_ErrorType.NUM):NumberValueObject.create(0);const result=function pow(base,exponent){return base**exponent}(currentValue,value);return Number.isFinite(result)?NumberValueObject.create(result):ErrorValueObject.create(error_type_ErrorType.NUM)}sqrt(){const currentValue=this.getValue();if(!Number.isFinite(currentValue))return ErrorValueObject.create(error_type_ErrorType.NUM);const result=function sqrt(base){return Math.sqrt(base)}(currentValue);return Number.isFinite(result)?NumberValueObject.create(result):ErrorValueObject.create(error_type_ErrorType.NUM)}cbrt(){const currentValue=this.getValue();if(!Number.isFinite(currentValue))return ErrorValueObject.create(error_type_ErrorType.NUM);const result=Math.cbrt(currentValue);return Number.isFinite(result)?NumberValueObject.create(result):ErrorValueObject.create(error_type_ErrorType.NUM)}cos(){const currentValue=this.getValue();if(!Number.isFinite(currentValue))return ErrorValueObject.create(error_type_ErrorType.NUM);const result=Math.cos(currentValue);return Number.isFinite(result)?NumberValueObject.create(result):ErrorValueObject.create(error_type_ErrorType.NUM)}cosh(){const currentValue=this.getValue();if(!Number.isFinite(currentValue))return ErrorValueObject.create(error_type_ErrorType.NUM);const result=Math.cosh(currentValue);return Number.isFinite(result)?NumberValueObject.create(result):ErrorValueObject.create(error_type_ErrorType.NUM)}acos(){const currentValue=this.getValue();if(!Number.isFinite(currentValue))return ErrorValueObject.create(error_type_ErrorType.NUM);const result=Math.acos(currentValue);return Number.isNaN(result)?ErrorValueObject.create(error_type_ErrorType.NUM):NumberValueObject.create(result)}acosh(){const currentValue=this.getValue();if(!Number.isFinite(currentValue))return ErrorValueObject.create(error_type_ErrorType.NUM);const result=Math.acosh(currentValue);return Number.isNaN(result)?ErrorValueObject.create(error_type_ErrorType.NUM):NumberValueObject.create(result)}sin(){const currentValue=this.getValue();if(!Number.isFinite(currentValue))return ErrorValueObject.create(error_type_ErrorType.NUM);const result=Math.sin(currentValue);return Number.isFinite(result)?NumberValueObject.create(result):ErrorValueObject.create(error_type_ErrorType.NUM)}sinh(){const currentValue=this.getValue();if(!Number.isFinite(currentValue))return ErrorValueObject.create(error_type_ErrorType.NUM);const result=Math.sinh(currentValue);return Number.isFinite(result)?NumberValueObject.create(result):ErrorValueObject.create(error_type_ErrorType.NUM)}asin(){const currentValue=this.getValue();if(!Number.isFinite(currentValue))return ErrorValueObject.create(error_type_ErrorType.NUM);const result=Math.asin(currentValue);return Number.isNaN(result)?ErrorValueObject.create(error_type_ErrorType.NUM):NumberValueObject.create(result)}asinh(){const currentValue=this.getValue();if(!Number.isFinite(currentValue))return ErrorValueObject.create(error_type_ErrorType.NUM);const result=Math.asinh(currentValue);return Number.isNaN(result)?ErrorValueObject.create(error_type_ErrorType.NUM):NumberValueObject.create(result)}tan(){const currentValue=this.getValue();if(!Number.isFinite(currentValue))return ErrorValueObject.create(error_type_ErrorType.NUM);const result=Math.tan(currentValue);return Number.isFinite(result)?NumberValueObject.create(result):ErrorValueObject.create(error_type_ErrorType.NUM)}tanh(){const currentValue=this.getValue();if(!Number.isFinite(currentValue))return ErrorValueObject.create(error_type_ErrorType.NUM);const result=Math.tanh(currentValue);return Number.isFinite(result)?NumberValueObject.create(result):ErrorValueObject.create(error_type_ErrorType.NUM)}atan(){const currentValue=this.getValue();if(!Number.isFinite(currentValue))return ErrorValueObject.create(error_type_ErrorType.NUM);const result=Math.atan(currentValue);return Number.isFinite(result)?NumberValueObject.create(result):ErrorValueObject.create(error_type_ErrorType.NUM)}atan2(valueObject){if(valueObject.isArray())return valueObject.atan2Inverse(this);const currentValue=this.getValue(),value=valueObject.getValue();if("string"==typeof value)return ErrorValueObject.create(error_type_ErrorType.VALUE);if("number"==typeof value){if(!Number.isFinite(currentValue)||!Number.isFinite(value))return ErrorValueObject.create(error_type_ErrorType.NUM);if(0===currentValue&&0===value)return ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO);const result=Math.atan2(currentValue,value);return Number.isFinite(result)?NumberValueObject.create(result):ErrorValueObject.create(error_type_ErrorType.NUM)}return"boolean"==typeof value?NumberValueObject.create(Math.atan2(currentValue,value?1:0)):this}atanh(){const currentValue=this.getValue();if(!Number.isFinite(currentValue))return ErrorValueObject.create(error_type_ErrorType.NUM);const result=Math.atanh(currentValue);return Number.isFinite(result)?NumberValueObject.create(result):ErrorValueObject.create(error_type_ErrorType.NUM)}log(){const currentValue=this.getValue();if("number"==typeof currentValue&&currentValue<=0)return ErrorValueObject.create(error_type_ErrorType.NUM);if(!Number.isFinite(currentValue))return ErrorValueObject.create(error_type_ErrorType.NUM);const result=Math.log(currentValue);return Number.isFinite(result)?NumberValueObject.create(result):ErrorValueObject.create(error_type_ErrorType.NUM)}log10(){const currentValue=this.getValue();if("number"==typeof currentValue&&currentValue<=0)return ErrorValueObject.create(error_type_ErrorType.NUM);if(!Number.isFinite(currentValue))return ErrorValueObject.create(error_type_ErrorType.NUM);const result=Math.log10(currentValue);return Number.isFinite(result)?NumberValueObject.create(result):ErrorValueObject.create(error_type_ErrorType.NUM)}exp(){const currentValue=this.getValue();if(!Number.isFinite(currentValue))return ErrorValueObject.create(error_type_ErrorType.NUM);const result=Math.exp(currentValue);return Number.isFinite(result)?NumberValueObject.create(result):ErrorValueObject.create(error_type_ErrorType.NUM)}abs(){const currentValue=this.getValue();if(!Number.isFinite(currentValue))return ErrorValueObject.create(error_type_ErrorType.NUM);const result=Math.abs(currentValue);return Number.isFinite(result)?NumberValueObject.create(result):ErrorValueObject.create(error_type_ErrorType.NUM)}round(valueObject){if(valueObject.isArray())return valueObject.roundInverse(this);const currentValue=this.getValue(),value=valueObject.getValue();if("string"==typeof value)return ErrorValueObject.create(error_type_ErrorType.VALUE);if("number"==typeof value){if(!Number.isFinite(currentValue)||!Number.isFinite(value))return ErrorValueObject.create(error_type_ErrorType.NUM);const result=currentValue<0?-round(Math.abs(currentValue),value):round(currentValue,value);return Number.isFinite(result)?NumberValueObject.create(result):ErrorValueObject.create(error_type_ErrorType.NUM)}return"boolean"==typeof value?NumberValueObject.create(round(currentValue,value?1:0)):this}floor(valueObject){if(valueObject.isArray())return valueObject.floorInverse(this);const currentValue=this.getValue(),value=valueObject.getValue();if("string"==typeof value)return ErrorValueObject.create(error_type_ErrorType.VALUE);if("number"==typeof value){if(!Number.isFinite(currentValue)||!Number.isFinite(value))return ErrorValueObject.create(error_type_ErrorType.NUM);const result=currentValue<0?-floor(Math.abs(currentValue),value):floor(currentValue,value);return Number.isFinite(result)?NumberValueObject.create(result):ErrorValueObject.create(error_type_ErrorType.NUM)}return"boolean"==typeof value?NumberValueObject.create(floor(currentValue,value?1:0)):this}ceil(valueObject){if(valueObject.isArray())return valueObject.ceilInverse(this);const currentValue=this.getValue(),value=valueObject.getValue();if("string"==typeof value)return ErrorValueObject.create(error_type_ErrorType.VALUE);if("number"==typeof value){if(!Number.isFinite(currentValue)||!Number.isFinite(value))return ErrorValueObject.create(error_type_ErrorType.NUM);const result=currentValue<0?-ceil(Math.abs(currentValue),value):ceil(currentValue,value);return Number.isFinite(result)?NumberValueObject.create(result):ErrorValueObject.create(error_type_ErrorType.NUM)}return"boolean"==typeof value?NumberValueObject.create(ceil(currentValue,value?1:0)):this}convertToNumberObjectValue(){return this}convertToBooleanObjectValue(){return createBooleanValueObjectByRawValue(!0)}_compareInfinity(currentValue,value,operator){let result=!1;switch(operator){case compareToken.EQUALS:result=currentValue===value;break;case compareToken.GREATER_THAN:result=currentValue>value;break;case compareToken.GREATER_THAN_OR_EQUAL:result=currentValue>=value;break;case compareToken.LESS_THAN:result=currentValue<value;break;case compareToken.LESS_THAN_OR_EQUAL:result=currentValue<=value;break;case compareToken.NOT_EQUAL:result=currentValue!==value}return result}}const StringValueObjectCache=new FormulaAstLRU(1e5);class StringValueObject extends BaseValueObject{static create(value){const cached=StringValueObjectCache.get(value);if(cached)return cached;const instance=new StringValueObject(value);return StringValueObjectCache.set(value,instance),instance}constructor(rawValue){super(rawValue),this._value=rawValue}getValue(){return this._value}isString(){return!0}concatenateFront(valueObject){return valueObject.isArray()?valueObject.concatenateBack(this):StringValueObject.create(this.concatenate(valueObject.getValue(),ConcatenateType.FRONT))}concatenateBack(valueObject){return valueObject.isArray()?valueObject.concatenateFront(this):StringValueObject.create(this.concatenate(valueObject.getValue(),ConcatenateType.BACK))}plus(valueObject){return this.convertToNumberObjectValue().plus(valueObject)}minus(valueObject){return this.convertToNumberObjectValue().minus(valueObject)}multiply(valueObject){return this.convertToNumberObjectValue().multiply(valueObject)}divided(valueObject){return this.convertToNumberObjectValue().divided(valueObject)}compare(valueObject,operator,isCaseSensitive){return valueObject.isArray()?valueObject.compare(this,reverseCompareOperator(operator),isCaseSensitive):this.compareBy(valueObject.getValue(),operator,isCaseSensitive)}compareBy(value,operator,isCaseSensitive=!1){let currentValue=this.getValue(),result=!1;if("string"==typeof value){let _value=value;if(isCaseSensitive||(currentValue=currentValue.toLocaleLowerCase(),_value=_value.toLocaleLowerCase()),function isWildcard(str){return str.indexOf("*")>-1||str.indexOf("?")>-1}(_value))return this._checkWildcard(_value,operator);result=this._compareString(currentValue,_value,operator)}else"number"==typeof value?result=this._compareNumber(operator):"boolean"==typeof value&&(result=this._compareBoolean(operator));return BooleanValueObject.create(result)}_compareString(currentValue,value,operator){switch(operator){case compareToken.EQUALS:return currentValue===value;case compareToken.GREATER_THAN:return currentValue>value;case compareToken.GREATER_THAN_OR_EQUAL:return currentValue>=value;case compareToken.LESS_THAN:return currentValue<value;case compareToken.LESS_THAN_OR_EQUAL:return currentValue<=value;case compareToken.NOT_EQUAL:return currentValue!==value}}_compareNumber(operator){switch(operator){case compareToken.NOT_EQUAL:case compareToken.GREATER_THAN:case compareToken.GREATER_THAN_OR_EQUAL:return!0;case compareToken.EQUALS:case compareToken.LESS_THAN:case compareToken.LESS_THAN_OR_EQUAL:return!1}}_compareBoolean(operator){switch(operator){case compareToken.EQUALS:case compareToken.GREATER_THAN:case compareToken.GREATER_THAN_OR_EQUAL:return!1;case compareToken.LESS_THAN:case compareToken.LESS_THAN_OR_EQUAL:case compareToken.NOT_EQUAL:return!0}}convertToNumberObjectValue(){return createNumberValueObjectByRawValue(this.getValue())}convertToBooleanObjectValue(){return BooleanValueObject.create(!0)}_checkWildcard(value,operator){const result=function compareWithWildcard(currentValue,value,operator){let result=!1;switch(operator){case compareToken.EQUALS:result=isMatchWildcard(currentValue,value);break;case compareToken.NOT_EQUAL:result=!isMatchWildcard(currentValue,value);break;case compareToken.GREATER_THAN:case compareToken.GREATER_THAN_OR_EQUAL:result=isMatchWildcard(currentValue,value)||currentValue>replaceWildcard(value);break;case compareToken.LESS_THAN:case compareToken.LESS_THAN_OR_EQUAL:result=currentValue<replaceWildcard(value)}return result}(this.getValue().toLocaleLowerCase(),value,operator);return BooleanValueObject.create(result)}}function createBooleanValueObjectByRawValue(rawValue){if("boolean"==typeof rawValue)return BooleanValueObject.create(rawValue);let value=!1;if("string"==typeof rawValue){const rawValueUpper=rawValue.toLocaleUpperCase();rawValueUpper===BooleanValue.TRUE?value=!0:rawValueUpper===BooleanValue.FALSE&&(value=!1)}else value=1===rawValue;return BooleanValueObject.create(value)}function createNumberValueObjectByRawValue(rawValue,pattern=""){if("boolean"==typeof rawValue){let result=0;return rawValue&&(result=1),NumberValueObject.create(result,pattern)}return"number"==typeof rawValue?Number.isFinite(rawValue)?NumberValueObject.create(rawValue,pattern):ErrorValueObject.create(error_type_ErrorType.NUM):(0,src.DMQ)(rawValue)?NumberValueObject.create(Number(rawValue),pattern):ErrorValueObject.create(error_type_ErrorType.VALUE)}function transformToValueObject(array=[]){const arrayValueList=[];for(let r=0;r<array.length;r++){const row=array[r];null==arrayValueList[r]&&(arrayValueList[r]=[]);for(let c=0;c<row.length;c++){const cell=row[c];arrayValueList[r][c]=ValueObjectFactory.create(cell)}}return arrayValueList}class ArrayValueObject extends BaseValueObject{static create(rawValue){return new ArrayValueObject(rawValue)}static createByArray(array){const arrayValueObjectData={calculateValueList:transformToValueObject(array),rowCount:array.length,columnCount:array[0].length||0,unitId:"",sheetId:"",row:-1,column:-1};return new ArrayValueObject(arrayValueObjectData)}constructor(rawValue){super("string"==typeof rawValue?rawValue:""),this._values=[],this._rowCount=-1,this._columnCount=-1,this._unitId="",this._sheetId="",this._currentRow=-1,this._currentColumn=-1,this._sliceCache=new Map,this._defaultValue=null,this._values=this._formatValue(rawValue)}dispose(){this._values=[],this._defaultValue=null,this._flattenPosition=null,this._clearCache()}clone(){return this.map((o=>o))}getRowCount(){return this._rowCount}setRowCount(rowCount){this._rowCount=rowCount}getColumnCount(){return this._columnCount}setColumnCount(columnCount){this._columnCount=columnCount}setCurrent(row,column){this._currentRow=row,this._currentColumn=column}setUnitId(unitId){this._unitId=unitId}getUnitId(){return this._unitId}setSheetId(sheetId){this._sheetId=sheetId}getSheetId(){return this._sheetId}getCurrentRow(){return this._currentRow}getCurrentColumn(){return this._currentColumn}getArrayValue(){return this._values}setArrayValue(value){this._clearCache(),this._values=value}isArray(){return!0}setDefaultValue(value){this._defaultValue=value}get(row,column){return this._values[row]?.[column]||this._defaultValue}getRealValue(row,column){const rowValues=this._values[row];if(null==rowValues)return null;const v=rowValues[column];return null==v?null:v}getValueOrDefault(row,column){return this.get(row,column)||this._defaultValue}set(row,column,value){if(row>=this._rowCount||column>=this._columnCount)throw new Error("Exceeding array bounds.");this._clearCache(),this._values[row][column]=value}getRangePosition(){return{startRow:0,endRow:this.getRowCount()-1,startColumn:0,endColumn:this.getColumnCount()-1}}iterator(callback){const{startRow,endRow,startColumn,endColumn}=this.getRangePosition(),valueList=this.getArrayValue();for(let r=startRow;r<=endRow;r++)for(let c=startColumn;c<=endColumn;c++)if(!1===callback(valueList[r]?.[c]||this._defaultValue,r,c))return}iteratorReverse(callback){const{startRow,endRow,startColumn,endColumn}=this.getRangePosition(),valueList=this.getArrayValue();for(let r=endRow;r>=startRow;r--)for(let c=endColumn;c>=startColumn;c--)if(!1===callback(valueList[r]?.[c]||this._defaultValue,r,c))return}getLastTruePosition(){let rangeSingle;return this.iteratorReverse(((value,rowIndex,columnIndex)=>{if(value?.isBoolean()&&!0===value.getValue())return rangeSingle={row:rowIndex,column:columnIndex},!1})),rangeSingle}getFirstTruePosition(){let rangeSingle;return this.iterator(((value,rowIndex,columnIndex)=>{if(value?.isBoolean()&&!0===value.getValue())return rangeSingle={row:rowIndex,column:columnIndex},!1})),rangeSingle}getFirstCell(){const{startRow,startColumn}=this.getRangePosition();return this.get(startRow,startColumn)||this._defaultValue||NullValueObject.create()}getLastCell(){const{endRow,endColumn}=this.getRangePosition();return this.get(endRow,endColumn)||this._defaultValue||NullValueObject.create()}pick(takeArray){const newValue=this.pickRaw(takeArray);return this._createNewArray(newValue,1,newValue[0].length)}pickRaw(takeArray){const takeArrayRowCount=takeArray.getRowCount(),takeArrayColumnCount=takeArray.getColumnCount();if(takeArrayRowCount!==this._rowCount||takeArrayColumnCount!==this._columnCount)return[[NullValueObject.create()]];const newValue=[];newValue[0]=[];for(let r=0;r<takeArrayRowCount;r++)for(let c=0;c<takeArrayColumnCount;c++){const takeCell=takeArray.get(r,c);if(null!=takeCell&&!takeCell.isError()&&!0===takeCell.getValue()){const value=this.get(r,c);newValue[0].push(value)}}return newValue}flatten(){if(null!=this._flattenCache)return this._flattenCache;const newValue=[];newValue[0]=[];for(let r=0;r<this._rowCount;r++)for(let c=0;c<this._columnCount;c++){const value=this.get(r,c);newValue[0].push(value)}const arrayV=this._createNewArray(newValue,1,newValue[0].length);return arrayV.setDefaultValue(this._defaultValue),this._flattenCache=arrayV,arrayV}flattenPosition(){if(null!=this._flattenPosition)return this._flattenPosition;const stringValue=[],numberValue=[],stringPosition=[],numberPosition=[];let index=0;for(let r=0;r<this._rowCount;r++)for(let c=0;c<this._columnCount;c++){const value=this.get(r,c);null==value||value.isError()||value.isNull()?index++:value.isString()?(stringValue.push(value),stringPosition.push(index++)):(numberValue.push(value),numberPosition.push(index++))}const result={stringArray:stringValue,numberArray:numberValue,stringPosition,numberPosition};return this._flattenPosition=result,result}slice(rowParam,columnParam){let rowStart=0,rowStop=this._rowCount,rowStep=1,columnStart=0,columnStop=this._columnCount,columnStep=1;if(null!=rowParam&&(rowStart=rowParam[0]||0,rowStop=rowParam[1]||this._rowCount,rowStep=rowParam[2]||1),null!=columnParam&&(columnStart=columnParam[0]||0,columnStop=columnParam[1]||this._columnCount,columnStep=columnParam[2]||1),rowStart>=this._rowCount||columnStart>=this._columnCount)return;const cacheKey=`${rowStart}_${rowStop}_${rowStep}_${columnStart}_${columnStop}_${columnStep}`,cache=this._sliceCache.get(cacheKey);if(null!=cache)return cache;const result=[],array=this._values;let result_row_index=0,result_column_index=0;for(let r=rowStart;r<rowStop;r+=rowStep){result_column_index=0,null==result[result_row_index]&&(result[result_row_index]=[]);for(let c=columnStart;c<columnStop;c+=columnStep){if(!array[r])return;let cell=array[r][c]||this._defaultValue;null==cell&&(cell=NullValueObject.create()),result[result_row_index][result_column_index]=cell,result_column_index++}result_row_index++}if(0===result.length||0===result[0].length)return;const startRow=rowStep>1?-1:rowStart+this._currentRow,startColumn=columnStep>1?-1:columnStart+this._currentColumn,newResultArray=this._createNewArray(result,result.length,result[0].length,startRow,startColumn);return newResultArray.setDefaultValue(this._defaultValue),this._sliceCache.set(cacheKey,newResultArray),newResultArray}sortByRow(index){const result=this._transposeArray(this._values);result.sort(this._sort(index)),this._clearCache(),this._values=this._transposeArray(result)}sortByColumn(index){this._clearCache(),this._values.sort(this._sort(index))}transpose(){const transposeArray=this._transposeArray(this._values),rowCount=this._rowCount,columnCount=this._columnCount,newArray=this._createNewArray(transposeArray,columnCount,rowCount);return newArray.setDefaultValue(this._defaultValue),newArray}orderSearch(valueObject,searchType=ArrayOrderSearchType.MIN,isDesc=!1,isFuzzyMatching=!1){let result,maxOrMin,resultPosition,maxOrMinPosition;const _handleMatch=(itemValue,row,column)=>{if(null==itemValue)return!0;let matchObject;if(matchObject=!0===isFuzzyMatching?itemValue.compare(valueObject,compareToken.EQUALS):itemValue.isEqual(valueObject),!0===matchObject?.getValue())return result=itemValue,resultPosition={row,column},!1;searchType===ArrayOrderSearchType.MAX?!0===itemValue.isGreaterThan(valueObject).getValue()&&(null!=maxOrMin&&!0!==itemValue.minus(valueObject).abs().isLessThanOrEqual(maxOrMin.minus(valueObject).abs()).getValue()||(maxOrMin=itemValue,maxOrMinPosition={row,column})):searchType===ArrayOrderSearchType.MIN&&!0===itemValue.isLessThan(valueObject).getValue()&&(null!=maxOrMin&&!0!==itemValue.minus(valueObject).abs().isLessThanOrEqual(maxOrMin.minus(valueObject).abs()).getValue()||(maxOrMin=itemValue,maxOrMinPosition={row,column}))};return isDesc?this.iteratorReverse(((itemValue,r,c)=>_handleMatch(itemValue,r,c))):this.iterator(((itemValue,r,c)=>_handleMatch(itemValue,r,c))),null!=result?resultPosition:null!=maxOrMin?maxOrMinPosition:void 0}binarySearch(valueObject,searchType=ArrayBinarySearchType.MIN,matchType=ArrayOrderSearchType.MIN){if(valueObject.isError())return;const{stringArray,stringPosition,numberArray,numberPosition}=this.flattenPosition();if(valueObject.isString())return this._binarySearch(valueObject,stringArray,stringPosition,searchType,matchType);return this._binarySearch(valueObject,numberArray,numberPosition,searchType,matchType)}_binarySearch(valueObject,searchArray,positionArray,searchType=ArrayBinarySearchType.MIN,matchType=ArrayOrderSearchType.MIN){const compareFunc=getCompare(),value=Number(valueObject.getValue()),isValueNumber=!Number.isNaN(value);let start=0,end=searchArray.length-1,exactMatchIndex=-1,nearestSmallerIndex=-1,nearestLargerIndex=-1;for(;start<=end;){const middle=Math.floor((start+end)/2),compareTo=searchArray[middle];let compareResult;if(compareTo.isNull())compareResult=searchType===ArrayBinarySearchType.MIN?1:-1;else{const compareToValue=compareTo.getValue();if(isValueNumber){const compareToNumber=Number(compareToValue);compareResult=Number.isNaN(compareToNumber)?1:Math.sign(compareToNumber-value)}else compareResult=compareFunc(compareToValue.toString().toLocaleLowerCase(),valueObject.getValue().toString().toLocaleLowerCase())}if(searchType===ArrayBinarySearchType.MAX&&(compareResult=-compareResult),0===compareResult){exactMatchIndex=middle;break}compareResult<0?(nearestSmallerIndex=middle,start=middle+1):(nearestLargerIndex=middle,end=middle-1)}return matchType===ArrayOrderSearchType.NORMAL?-1!==exactMatchIndex?positionArray[exactMatchIndex]:void 0:matchType===ArrayOrderSearchType.MIN?-1!==exactMatchIndex?positionArray[exactMatchIndex]:searchType===ArrayBinarySearchType.MIN?positionArray[nearestSmallerIndex]:positionArray[nearestLargerIndex]:matchType===ArrayOrderSearchType.MAX?-1!==exactMatchIndex?positionArray[exactMatchIndex]:searchType===ArrayBinarySearchType.MIN?positionArray[nearestLargerIndex]:positionArray[nearestSmallerIndex]:void 0}sum(){let accumulatorAll=NumberValueObject.create(0);return this.iterator((valueObject=>!!(null==valueObject||valueObject.isString()||valueObject.isBoolean()||valueObject.isNull())||(valueObject.isError()?(accumulatorAll=valueObject,!1):void(accumulatorAll=accumulatorAll.plus(valueObject))))),accumulatorAll}max(){let accumulatorAll=NumberValueObject.create(Number.NEGATIVE_INFINITY);return this.iterator((valueObject=>{if(null==valueObject)return!0;if(valueObject.isError())return accumulatorAll=valueObject,!1;if(valueObject.isString()||valueObject.isNull()||valueObject.isBoolean())return!0;accumulatorAll.isLessThan(valueObject).getValue()&&(accumulatorAll=valueObject)})),accumulatorAll}min(){let accumulatorAll=NumberValueObject.create(Number.POSITIVE_INFINITY);return this.iterator((valueObject=>{if(null==valueObject)return!0;if(valueObject.isError())return accumulatorAll=valueObject,!1;if(valueObject.isString()||valueObject.isNull()||valueObject.isBoolean())return!0;accumulatorAll.isGreaterThan(valueObject).getValue()&&(accumulatorAll=valueObject)})),accumulatorAll}count(){let accumulatorAll=NumberValueObject.create(0);return this.iterator((valueObject=>{if(null==valueObject||valueObject.isError()||valueObject.isString()||valueObject.isNull()||valueObject.isBoolean())return!0;accumulatorAll=accumulatorAll.plusBy(1)})),accumulatorAll}countA(){let accumulatorAll=NumberValueObject.create(0);return this.iterator((valueObject=>{if(null==valueObject||valueObject.isNull())return!0;accumulatorAll=accumulatorAll.plusBy(1)})),accumulatorAll}countBlank(){let accumulatorAll=NumberValueObject.create(0);return this.iterator((valueObject=>{(null==valueObject||valueObject.isNull()||""===valueObject.getValue())&&(accumulatorAll=accumulatorAll.plusBy(1))})),accumulatorAll}getNegative(){return ArrayValueObject.create("{0}").minus(this)}getReciprocal(){return ArrayValueObject.create("{1}").divided(this)}plus(valueObject){return this._batchOperator(valueObject,1)}minus(valueObject){return this._batchOperator(valueObject,0)}multiply(valueObject){return this._batchOperator(valueObject,2)}divided(valueObject){return this._batchOperator(valueObject,3)}mod(valueObject){return this._batchOperator(valueObject,4)}modInverse(valueObject){return this.map((currentValue=>currentValue.isError()?currentValue:valueObject.mod(currentValue)))}compare(valueObject,operator,isCaseSensitive){return this._batchOperator(valueObject,5,operator,isCaseSensitive)}concatenateFront(valueObject){return this._batchOperator(valueObject,6)}concatenateBack(valueObject){return this._batchOperator(valueObject,7)}map(callbackFn){return this.mapValue(((currentValue,r,c)=>null==currentValue?NullValueObject.create():currentValue.isError()?currentValue:callbackFn(currentValue,r,c)))}mapValue(callbackFn){const rowCount=this._rowCount,columnCount=this._columnCount,result=[];for(let r=0;r<rowCount;r++){const rowList=[];for(let c=0;c<columnCount;c++){const row=this._values?.[r];if(null==row)rowList[c]=ErrorValueObject.create(error_type_ErrorType.VALUE);else{const currentValue=row[c]||this._defaultValue;rowList[c]=currentValue?callbackFn(currentValue,r,c):NullValueObject.create()}}result.push(rowList)}return this._createNewArray(result,rowCount,columnCount)}pow(valueObject){return this._batchOperator(valueObject,8)}powInverse(valueObject){return this.map((currentValue=>currentValue.isError()?currentValue:valueObject.pow(currentValue)))}sqrt(){return this.map((currentValue=>currentValue.isError()?currentValue:currentValue.sqrt()))}cbrt(){return this.map((currentValue=>currentValue.isError()?currentValue:currentValue.cbrt()))}cos(){return this.map((currentValue=>currentValue.isError()?currentValue:currentValue.cos()))}cosh(){return this.map((currentValue=>currentValue.isError()?currentValue:currentValue.cosh()))}acos(){return this.map((currentValue=>currentValue.isError()?currentValue:currentValue.acos()))}acosh(){return this.map((currentValue=>currentValue.isError()?currentValue:currentValue.acosh()))}sin(){return this.map((currentValue=>currentValue.isError()?currentValue:currentValue.sin()))}sinh(){return this.map((currentValue=>currentValue.isError()?currentValue:currentValue.sinh()))}asin(){return this.map((currentValue=>currentValue.isError()?currentValue:currentValue.asin()))}asinh(){return this.map((currentValue=>currentValue.isError()?currentValue:currentValue.asinh()))}tan(){return this.map((currentValue=>currentValue.isError()?currentValue:currentValue.tan()))}tanh(){return this.map((currentValue=>currentValue.isError()?currentValue:currentValue.tanh()))}atan(){return this.map((currentValue=>currentValue.isError()?currentValue:currentValue.atan()))}atanh(){return this.map((currentValue=>currentValue.isError()?currentValue:currentValue.atanh()))}atan2(valueObject){return this._batchOperator(valueObject,12)}atan2Inverse(valueObject){return this.map((currentValue=>currentValue.isError()?currentValue:valueObject.atan2(currentValue)))}mean(ddof=0){const sum=this.sum(),count=this.count();return sum.divided(0===ddof?count:count.minusBy(1))}median(){const numberArray=this.flattenPosition().numberArray,allValue=this._createNewArray([numberArray],1,numberArray.length),count=allValue.getColumnCount();if(count<=1)return allValue.get(0,0)||NullValueObject.create();if(allValue.sortByRow(0),count%2==0){const medianRight=allValue.get(0,count/2)||NullValueObject.create(),medianLeft=allValue.get(0,count/2-1)||NullValueObject.create();return medianRight.plus(medianLeft).divided(NumberValueObject.create(2))}return allValue.get(0,(count-1)/2)||NullValueObject.create()}var(ddof=0){const mean=this.mean(),squaredDifferences=[[]];this.iterator((valueObject=>{if(null==valueObject||valueObject.isError()||valueObject.isString()||valueObject.isBoolean()||valueObject.isNull())return;const baseValueObject=valueObject.minus(mean).pow(NumberValueObject.create(2));baseValueObject.isError()||squaredDifferences[0].push(baseValueObject)}));const{_unitId,_sheetId,_currentRow,_currentColumn}=this;return ArrayValueObject.create({calculateValueList:squaredDifferences,rowCount:1,columnCount:squaredDifferences[0].length,unitId:_unitId,sheetId:_sheetId,row:_currentRow,column:_currentColumn}).mean(ddof)}std(ddof=0){const variance=this.var(ddof);return variance.isError()?variance:variance.sqrt()}log(){return this.map((currentValue=>currentValue.isError()?currentValue:currentValue.log()))}log10(){return this.map((currentValue=>currentValue.isError()?currentValue:currentValue.log10()))}exp(){return this.map((currentValue=>currentValue.isError()?currentValue:currentValue.exp()))}abs(){return this.map((currentValue=>currentValue.isError()?currentValue:currentValue.abs()))}round(valueObject){return this._batchOperator(valueObject,9)}roundInverse(valueObject){return this.map((currentValue=>currentValue.isError()?currentValue:valueObject.round(currentValue)))}floor(valueObject){return this._batchOperator(valueObject,10)}floorInverse(valueObject){return this.map((currentValue=>currentValue.isError()?currentValue:valueObject.floor(currentValue)))}ceil(valueObject){return this._batchOperator(valueObject,11)}ceilInverse(valueObject){return this.map((currentValue=>currentValue.isError()?currentValue:valueObject.ceil(currentValue)))}toValue(){return function transformToValue(array=[]){const arrayValueList=[];for(let r=0;r<array.length;r++){const row=array[r];null==arrayValueList[r]&&(arrayValueList[r]=[]);for(let c=0;c<row.length;c++){const cell=row[c];null==cell?arrayValueList[r][c]=null:cell.isError()?arrayValueList[r][c]=cell.getErrorType():arrayValueList[r][c]=cell.getValue()}}return arrayValueList}(this._values)}_clearCache(){this._flattenCache=null,this._sliceCache.clear()}_sort(index){const compare=getCompare();return(a,b)=>{const columnA=a[index],columnB=b[index];return null==columnA?1:null==columnB?-1:columnA.isError()&&columnA.isError()?0:columnA.isError()?1:columnB.isError()?-1:compare(columnA.getValue(),columnB.getValue())}}_transposeArray(array){const rows=array.length,cols=array[0].length,transposedArray=[];for(let col=0;col<cols;col++){transposedArray[col]=[];for(let row=0;row<rows;row++)transposedArray[col][row]=array[row][col]}return transposedArray}_batchOperator(valueObject,batchOperatorType,operator,isCaseSensitive){const valueList=[];let rowCount=this._rowCount,columnCount=this._columnCount;if(valueObject.isArray()){const valueRowCount=valueObject.getRowCount(),valueColumnCount=valueObject.getColumnCount();if(rowCount=Math.max(valueRowCount,rowCount),columnCount=Math.max(valueColumnCount,columnCount),1===valueRowCount&&1===valueColumnCount){const v=valueObject.getFirstCell();for(let c=0;c<columnCount;c++)valueList.push(v)}else{if(!(1===valueRowCount&&this._columnCount>1))return this._batchOperatorArray(valueObject,batchOperatorType,operator,isCaseSensitive);{const list=valueObject.getArrayValue();for(let c=0;c<columnCount;c++)valueList.push(list[0][c])}}}else for(let c=0;c<columnCount;c++)valueList.push(valueObject);const result=[];for(let c=0;c<columnCount;c++){const value=valueList[c];this._batchOperatorValue(value,c,result,batchOperatorType,operator,isCaseSensitive)}const newArray=this._createNewArray(result,rowCount,columnCount);return newArray.setDefaultValue(BooleanValueObject.create(!1)),newArray}_batchOperatorValue(valueObject,column,result,batchOperatorType,operator,isCaseSensitive){const rowCount=this._rowCount,unitId=this.getUnitId(),sheetId=this.getSheetId(),startRow=this.getCurrentRow(),startColumn=this.getCurrentColumn();if(5===batchOperatorType){const{rowsInCache,rowsNotInCache}=CELL_INVERTED_INDEX_CACHE.canUseCache(unitId,sheetId,column+startColumn,startRow,startRow+rowCount-1);if(rowsInCache.length>0){if(operator===compareToken.EQUALS){const rowPositions=CELL_INVERTED_INDEX_CACHE.getCellPositions(unitId,sheetId,column+startColumn,valueObject.getValue(),rowsInCache);null!=rowPositions&&rowPositions.forEach((row=>{if(row<startRow||row>startRow+rowCount-1)return;const r=row-startRow;null==result[r]&&(result[r]=[]),result[r][column]=BooleanValueObject.create(!0)}))}else{const rowValuePositions=CELL_INVERTED_INDEX_CACHE.getCellValuePositions(unitId,sheetId,column+startColumn);null!=rowValuePositions&&rowValuePositions.forEach(((rowPositions,rowValue)=>{let matchResult,currentValue=NullValueObject.create();ERROR_TYPE_SET.has(rowValue)?currentValue=ErrorValueObject.create(rowValue):"string"==typeof rowValue?currentValue=StringValueObject.create(rowValue):"number"==typeof rowValue?currentValue=NumberValueObject.create(rowValue):"boolean"==typeof rowValue&&(currentValue=BooleanValueObject.create(rowValue)),matchResult=currentValue.isError()?currentValue:valueObject.isError()?valueObject:currentValue.compare(valueObject,operator,isCaseSensitive),(matchResult.isError()||!0===matchResult.getValue())&&rowPositions.forEach((index=>{index>=startRow&&index<=startRow+rowCount-1&&(null==result[index-startRow]&&(result[index-startRow]=[]),result[index-startRow][column]=matchResult)}))}))}if(rowsNotInCache.length>0)for(const interval of rowsNotInCache){const[start,end]=interval;for(let r=start;r<=end;r++)this.__batchOperatorRowValue(valueObject,column,result,batchOperatorType,r-startRow,unitId,sheetId,startRow,startColumn,operator,isCaseSensitive);CELL_INVERTED_INDEX_CACHE.setContinueBuildingCache(unitId,sheetId,column+startColumn,start,end)}return}}for(let r=0;r<rowCount;r++)this.__batchOperatorRowValue(valueObject,column,result,batchOperatorType,r,unitId,sheetId,startRow,startColumn,operator,isCaseSensitive);CELL_INVERTED_INDEX_CACHE.setContinueBuildingCache(unitId,sheetId,column+startColumn,startRow,startRow+rowCount-1)}__batchOperatorRowValue(valueObject,column,result,batchOperatorType,r,unitId,sheetId,startRow,startColumn,operator,isCaseSensitive){const currentValue=this.getValueOrDefault(r,column);if(null==result[r]&&(result[r]=[]),currentValue&&valueObject)if(currentValue.isError())result[r][column]=currentValue;else if(valueObject.isError())result[r][column]=valueObject;else switch(batchOperatorType){case 1:result[r][column]=currentValue.plus(valueObject);break;case 0:result[r][column]=currentValue.minus(valueObject);break;case 2:result[r][column]=currentValue.multiply(valueObject);break;case 3:result[r][column]=currentValue.divided(valueObject);break;case 4:result[r][column]=currentValue.mod(valueObject);break;case 5:result[r][column]=operator?currentValue.compare(valueObject,operator,isCaseSensitive):ErrorValueObject.create(error_type_ErrorType.VALUE);break;case 6:result[r][column]=currentValue.concatenateFront(valueObject);break;case 7:result[r][column]=currentValue.concatenateBack(valueObject);break;case 8:result[r][column]=currentValue.pow(valueObject);break;case 9:result[r][column]=currentValue.round(valueObject);break;case 10:result[r][column]=currentValue.floor(valueObject);break;case 12:result[r][column]=currentValue.atan2(valueObject);break;case 11:result[r][column]=currentValue.ceil(valueObject)}else result[r][column]=ErrorValueObject.create(error_type_ErrorType.NA);null!=currentValue&&(currentValue.isError()?CELL_INVERTED_INDEX_CACHE.set(unitId,sheetId,column+startColumn,currentValue.getErrorType(),r+startRow):CELL_INVERTED_INDEX_CACHE.set(unitId,sheetId,column+startColumn,currentValue.getValue(),r+startRow))}_batchOperatorArray(valueObject,batchOperatorType,operator,isCaseSensitive){let rowCount=valueObject.getRowCount(),columnCount=valueObject.getColumnCount();rowCount<this._rowCount&&(rowCount=this._rowCount),columnCount<this._columnCount&&(columnCount=this._columnCount);const result=[],currentCalculateType=this._checkArrayCalculateType(this),opCalculateType=this._checkArrayCalculateType(valueObject);for(let r=0;r<rowCount;r++){const rowList=[];for(let c=0;c<columnCount;c++){let currentValue,opValue;if(currentValue=3===currentCalculateType?this.getValueOrDefault(0,0):1===currentCalculateType?this.getValueOrDefault(0,c):2===currentCalculateType?this.getValueOrDefault(r,0):this.getValueOrDefault(r,c),opValue=3===opCalculateType?valueObject.getValueOrDefault(0,0):1===opCalculateType?valueObject.getValueOrDefault(0,c):2===opCalculateType?valueObject.getValueOrDefault(r,0):valueObject.getValueOrDefault(r,c),currentValue&&opValue)if(currentValue.isError())rowList[c]=currentValue;else if(opValue.isError())rowList[c]=opValue;else switch(batchOperatorType){case 1:rowList[c]=currentValue.plus(opValue);break;case 0:rowList[c]=currentValue.minus(opValue);break;case 2:rowList[c]=currentValue.multiply(opValue);break;case 3:rowList[c]=currentValue.divided(opValue);break;case 4:rowList[c]=currentValue.mod(opValue);break;case 5:rowList[c]=operator?currentValue.compare(opValue,operator,isCaseSensitive):ErrorValueObject.create(error_type_ErrorType.VALUE);break;case 6:rowList[c]=currentValue.concatenateFront(opValue);break;case 7:rowList[c]=currentValue.concatenateBack(opValue);break;case 8:rowList[c]=currentValue.pow(opValue);break;case 9:rowList[c]=currentValue.round(opValue);break;case 12:rowList[c]=currentValue.atan2(opValue);break;case 10:rowList[c]=currentValue.floor(opValue);break;case 11:rowList[c]=currentValue.ceil(opValue)}else rowList[c]=ErrorValueObject.create(error_type_ErrorType.NA)}result.push(rowList)}return this._createNewArray(result,rowCount,columnCount)}_checkArrayCalculateType(valueObject){return 1===valueObject.getRowCount()&&1===valueObject.getColumnCount()?3:1===valueObject.getRowCount()?1:1===valueObject.getColumnCount()?2:0}_formatValue(rawValue){if("string"!=typeof rawValue)return this._rowCount=rawValue.rowCount,this._columnCount=rawValue.columnCount,this._unitId=rawValue.unitId,this._sheetId=rawValue.sheetId,this._currentRow=rawValue.row,this._currentColumn=rawValue.column,rawValue.calculateValueList;const rowArray=(rawValue=rawValue.slice(1,-1)).split(";"),rowArrayCount=rowArray.length,result=[];let maxColumnCount=0;for(let r=0;r<rowArrayCount;r++){const columnArray=rowArray[r].split(","),columnArrayCount=columnArray.length;maxColumnCount<columnArrayCount&&(maxColumnCount=columnArrayCount);const row=[];for(let c=0;c<columnArrayCount;c++){const cellRaw=columnArray[c].trim();row.push(ValueObjectFactory.create(cellRaw))}result.push(row)}return this._rowCount=rowArrayCount,this._columnCount=maxColumnCount,result}_createNewArray(result,rowCount,columnCount,row=-1,column=-1){-1!==this._currentColumn&&-1!==this._currentRow||(row=-1,column=-1);const arrayValueObjectData={calculateValueList:result,rowCount,columnCount,unitId:this.getUnitId(),sheetId:this.getSheetId(),row,column};return ArrayValueObject.create(arrayValueObjectData)}}class ValueObjectFactory{static create(rawValue){if(null==rawValue)return NullValueObject.create();if("boolean"==typeof rawValue)return BooleanValueObject.create(rawValue);if("string"==typeof rawValue){const rawValueUpper=rawValue.toLocaleUpperCase().trim();if(ERROR_TYPE_SET.has(rawValueUpper))return ErrorValueObject.create(rawValueUpper);if(rawValueUpper===BooleanValue.TRUE||rawValueUpper===BooleanValue.FALSE)return createBooleanValueObjectByRawValue(rawValue);if((0,src.DMQ)(rawValue))return NumberValueObject.create(Number(rawValue));const{isNumberPattern,value,pattern}=function stringIsNumberPattern(input){let _input=input;_input.startsWith('"')&&_input.endsWith('"')&&(_input=_input.slice(1,-1));const cacheValue=stringToNumberPatternCache.get(_input);if(cacheValue)return{isNumberPattern:!0,value:cacheValue.value,pattern:cacheValue.pattern};const numberPattern=src.gIL.parseNumber(_input);if(numberPattern&&numberPattern.z)return setNumberPatternCache(_input,numberPattern.v,numberPattern.z);const datePattern=src.gIL.parseDate(_input);if(datePattern&&datePattern.z)return setNumberPatternCache(_input,datePattern.v,datePattern.z);const timePattern=src.gIL.parseTime(_input);return timePattern&&timePattern.z?setNumberPatternCache(_input,timePattern.v,timePattern.z):{isNumberPattern:!1}}(rawValue);if(isNumberPattern)return NumberValueObject.create(value,pattern);const rawValueSingleLine=rawValue.replace(/\n/g,"").replace(/\r/g,"");return!function isStringWrappedByDoubleQuotes(input){const trimmedInput=input.trim();return trimmedInput.startsWith('"')&&trimmedInput.endsWith('"')}(rawValueSingleLine)&&function regexTestArrayValue(token){return ARRAY_VALUE_REGEX_PRECOMPILING.lastIndex=0,ARRAY_VALUE_REGEX_PRECOMPILING.test(token)}(rawValueSingleLine)?ArrayValueObject.create(rawValueSingleLine):function createStringValueObjectByRawValue(rawValue){let value=rawValue.toString();return'"'===value.charAt(0)&&'"'===value.charAt(value.length-1)&&(value=value.slice(1,-1),value=value.replace(/""/g,'"')),StringValueObject.create(value)}(rawValue)}return"number"==typeof rawValue?createNumberValueObjectByRawValue(rawValue):ErrorValueObject.create(error_type_ErrorType.VALUE)}}const FORMULA_REF_TO_ARRAY_CACHE=new FormulaAstLRU(1e4);class BaseReferenceObject extends ObjectClassType{constructor(_token){super(),this._token=_token,this._forcedSheetId="",this._forcedSheetName="",this._defaultSheetId="",this._rangeData={startColumn:-1,startRow:-1,endRow:-1,endColumn:-1},this._unitData={},this._unitStylesData={},this._defaultUnitId="",this._forcedUnitId="",this._runtimeData={},this._arrayFormulaCellData={},this._runtimeArrayFormulaCellData={},this._runtimeFeatureCellData={},this._refOffsetX=0,this._refOffsetY=0}dispose(){this._unitData={},this._unitStylesData={},this._runtimeData={}}getToken(){return this._token}setToken(token){this._token=token}isExceedRange(){const{startRow,endRow,startColumn,endColumn}=this.getRangePosition();return startRow<0||startColumn<0||endRow>=this.getActiveSheetRowCount()||endColumn>=this.getActiveSheetColumnCount()}setRefOffset(x=0,y=0){this._refOffsetX=x,this._refOffsetY=y}getRefOffset(){return{x:this._refOffsetX,y:this._refOffsetY}}getRangePosition(){let{startRow,startColumn,endRow,endColumn}=(0,src.ZTS)(this._rangeData,this._refOffsetX,this._refOffsetY);return Number.isNaN(startRow)&&(startRow=0),Number.isNaN(startColumn)&&(startColumn=0),Number.isNaN(endRow)&&(endRow=this.getActiveSheetRowCount()-1),Number.isNaN(endColumn)&&(endColumn=this.getActiveSheetColumnCount()-1),{...this._rangeData,startRow,endRow,startColumn,endColumn}}isReferenceObject(){return!0}iterator(callback){const{startRow,endRow,startColumn,endColumn}=this.getRangePosition();if(this._checkIfWorksheetMiss())return callback(ErrorValueObject.create(error_type_ErrorType.VALUE),startRow,startColumn);const unitId=this._forcedUnitId||this._defaultUnitId,sheetId=this._forcedSheetId||this._defaultSheetId;for(let r=startRow;r<=endRow;r++)for(let c=startColumn;c<=endColumn;c++){if(r<0||c<0)return callback(ErrorValueObject.create(error_type_ErrorType.REF),r,c);const cell=this.getCellData(r,c);let result=!1;if(isNullCellForFormula(cell)){result=callback(null,r,c);continue}let resultObjectValue=this.getCellValueObject(cell);if(r===startRow&&c===startColumn){const pattern=this.getCellPattern(unitId,sheetId,r,c);if(pattern&&resultObjectValue.isNumber()){const value=Number(resultObjectValue.getValue());resultObjectValue=NumberValueObject.create(value,pattern)}}if(result=callback(resultObjectValue,r,c),!1===result)return}}getFirstCell(){const{startRow,startColumn}=this.getRangePosition(),cell=this.getCellData(startRow,startColumn);if(!cell)return NumberValueObject.create(0);let cellValueObject=this.getCellValueObject(cell);const unitId=this._forcedUnitId||this._defaultUnitId,sheetId=this._forcedSheetId||this._defaultSheetId,pattern=this.getCellPattern(unitId,sheetId,startRow,startColumn);if(pattern&&cellValueObject.isNumber()){const value=Number(cellValueObject.getValue());cellValueObject=NumberValueObject.create(value,pattern)}return cellValueObject}getRangeData(){return this._rangeData}setRangeData(range){this._rangeData=range}getUnitId(){return this._forcedUnitId&&this._forcedUnitId.length>0?this._forcedUnitId:this._defaultUnitId}getSheetId(){return this._forcedSheetId&&this._forcedSheetId.length>0?this._forcedSheetId:this._defaultSheetId}setForcedUnitIdDirect(unitId){unitId.length>0&&(this._forcedUnitId=unitId)}getForcedUnitId(){return this._forcedUnitId}setForcedSheetId(sheetNameMap){this._forcedSheetId=sheetNameMap[this.getUnitId()]?.[this._forcedSheetName]}setForcedSheetIdDirect(sheetId){this._forcedSheetId=sheetId}getForcedSheetId(){return this._forcedSheetId}setForcedSheetName(sheetName){sheetName.length>0&&(this._forcedSheetName=sheetName)}getForcedSheetName(){return this._forcedSheetName}setDefaultSheetId(sheetId){this._defaultSheetId=sheetId}getDefaultSheetId(){return this._defaultSheetId}setDefaultUnitId(unitId){this._defaultUnitId=unitId}getDefaultUnitId(){return this._defaultUnitId}getUnitData(){return this._unitData}setUnitData(unitData){this._unitData=unitData}getUnitStylesData(){return this._unitStylesData}setUnitStylesData(unitStylesData){this._unitStylesData=unitStylesData}getRuntimeData(){return this._runtimeData}setRuntimeData(runtimeData){this._runtimeData=runtimeData}getArrayFormulaCellData(){return this._arrayFormulaCellData}setArrayFormulaCellData(unitData){this._arrayFormulaCellData=unitData}getRuntimeArrayFormulaCellData(){return this._runtimeArrayFormulaCellData}setRuntimeArrayFormulaCellData(unitData){this._runtimeArrayFormulaCellData=unitData}getRuntimeFeatureCellData(){return this._runtimeFeatureCellData}setRuntimeFeatureCellData(unitData){this._runtimeFeatureCellData=unitData}getActiveSheetRowCount(){return this.getCurrentActiveSheetData()?.rowCount||0}getActiveSheetColumnCount(){return this.getCurrentActiveSheetData()?.columnCount||0}getRowCount(){return this._rangeData.endRow-this._rangeData.startRow+1}getColumnCount(){return this._rangeData.endColumn-this._rangeData.startColumn+1}getRowData(){return this.getCurrentActiveSheetData()?.rowData||{}}getColumnData(){return this.getCurrentActiveSheetData()?.columnData||{}}isCell(){return!1}isColumn(){return!1}isRow(){return!1}isRange(){return!1}isTable(){return!1}unionBy(referenceObject){return ErrorValueObject.create(error_type_ErrorType.REF)}unionRange(rangeData1,rangeData2){return{startRow:-1,startColumn:-1,endRow:-1,endColumn:-1}}getCellValueObject(cell){const value=function getCellValue(cell){if(null===cell)return 0;if(cell?.p){const body=cell?.p.body;if(null==body)return 0;const data=body.dataStream;return src.Z4q.transform.getPlainText(data)}return cell?.v||0}(cell);if(ERROR_TYPE_SET.has(value))return ErrorValueObject.create(value);if(cell.t===src.scd.NUMBER){const pattern=this._getPatternByCell(cell);return(0,util.Z)(pattern)?StringValueObject.create(value.toString()):createNumberValueObjectByRawValue(value,pattern)}return cell.t===src.scd.STRING||cell.t===src.scd.FORCE_STRING?StringValueObject.create(value.toString()):cell.t===src.scd.BOOLEAN?createBooleanValueObjectByRawValue(value):ValueObjectFactory.create(value)}_getPatternByCell(cell){const styles=this._unitStylesData[this.getUnitId()];if(!styles)return"";const style=styles.getStyleByCell(cell);return style?.n?.pattern||""}getCellByRow(row){return this.getCellByPosition(row)}getCellByColumn(column){return this.getCellByPosition(void 0,column)}getCurrentActiveSheetData(){return this._unitData[this.getUnitId()]?.[this.getSheetId()]}getCurrentStylesData(){return this._unitStylesData[this.getUnitId()]}getCurrentRuntimeSheetData(){return this._runtimeData?.[this.getUnitId()]?.[this.getSheetId()]}getCurrentActiveArrayFormulaCellData(){return this._arrayFormulaCellData?.[this.getUnitId()]?.[this.getSheetId()]}getCurrentRuntimeActiveArrayFormulaCellData(){return this._runtimeArrayFormulaCellData?.[this.getUnitId()]?.[this.getSheetId()]}getCellData(row,column){const activeSheetData=this.getCurrentActiveSheetData(),activeRuntimeData=this.getCurrentRuntimeSheetData(),activeArrayFormulaCellData=this.getCurrentActiveArrayFormulaCellData(),activeRuntimeArrayFormulaCellData=this.getCurrentRuntimeActiveArrayFormulaCellData();return activeRuntimeData?.getValue(row,column)||activeRuntimeArrayFormulaCellData?.getValue(row,column)||this.getRuntimeFeatureCellValue(row,column)||activeArrayFormulaCellData?.getValue(row,column)||activeSheetData?.cellData.getValue(row,column)}getRuntimeFeatureCellValue(row,column){return getRuntimeFeatureCell(row,column,this.getSheetId(),this.getUnitId(),this._runtimeFeatureCellData)}getCellByPosition(rowRaw,columnRaw){let row=rowRaw,column=columnRaw;row||(row=this._rangeData.startRow),column||(column=this._rangeData.startColumn);const cell=this.getCellData(row,column);return cell?this.getCellValueObject(cell):ErrorValueObject.create(error_type_ErrorType.VALUE)}getCellPattern(unitId,sheetId,row,column){const currentStyles=this._unitStylesData[unitId];if(!currentStyles)return"";const currentCell=this._unitData[unitId]?.[sheetId]?.cellData?.getValue(row,column);if(!currentCell)return"";const style=currentStyles.getStyleByCell(currentCell);return style?.n?.pattern||""}toArrayValueObject(useCache=!0){const{startRow,endRow,startColumn,endColumn}=this.getRangePosition(),key=`${this.getUnitId()}_${this.getSheetId()}_${startRow}_${endRow}_${startColumn}_${endColumn}`,array=FORMULA_REF_TO_ARRAY_CACHE.get(key);if(array&&useCache)return array;const rowSize=endRow-startRow+1,columnSize=endColumn-startColumn+1;if(rowSize<0||columnSize<0)return this._getBlankArrayValueObject();const arrayValueList=new Array(rowSize);this.iterator(((valueObject,rowIndex,columnIndex)=>{const row=rowIndex-startRow,column=columnIndex-startColumn;arrayValueList[row]||(arrayValueList[row]=new Array(columnSize)),null==valueObject&&(valueObject=NullValueObject.create()),arrayValueList[row][column]=valueObject}));const arrayValueObjectData={calculateValueList:arrayValueList,rowCount:arrayValueList.length,columnCount:arrayValueList[0]?.length||0,unitId:this.getUnitId(),sheetId:this.getSheetId(),row:startRow,column:startColumn},arrayValueObject=ArrayValueObject.create(arrayValueObjectData);return useCache&&FORMULA_REF_TO_ARRAY_CACHE.set(key,arrayValueObject),arrayValueObject}toUnitRange(){return{range:this.getRangePosition(),sheetId:this.getSheetId(),unitId:this.getUnitId()}}_checkIfWorksheetMiss(){return(null==this._forcedSheetId||0===this._forcedSheetId.length)&&this._forcedSheetName.length>0}_getBlankArrayValueObject(){const arrayValueObjectData={calculateValueList:[],rowCount:0,columnCount:0,unitId:this.getUnitId(),sheetId:this.getSheetId(),row:0,column:0};return ArrayValueObject.create(arrayValueObjectData)}}class AsyncObject extends ObjectClassType{constructor(_promise){super(),this._promise=_promise}isAsyncObject(){return!0}async getValue(){return this._promise}}class AsyncArrayObject extends ObjectClassType{constructor(_promiseList){super(),this._promiseList=_promiseList}isAsyncArrayObject(){return!0}async getValue(){const variants=[];for(let r=0;r<this._promiseList.length;r++){const promiseCells=this._promiseList[r];null==variants[r]&&(variants[r]=[]);for(let c=0;c<promiseCells.length;c++){const promiseCell=promiseCells[c];promiseCell.isAsyncObject()?variants[r][c]=await promiseCell.getValue():variants[r][c]=promiseCell}}const arrayValueObjectData={calculateValueList:variants,rowCount:variants.length,columnCount:variants[0]?.length||0,unitId:"",sheetId:"",row:0,column:0};return ArrayValueObject.create(arrayValueObjectData)}}class RangeReferenceObject extends BaseReferenceObject{constructor(range,forcedSheetId,forcedUnitId){super(""),this.setRangeData(range),forcedSheetId&&this.setForcedSheetIdDirect(forcedSheetId),forcedUnitId&&this.setForcedUnitIdDirect(forcedUnitId)}isRange(){return!0}}class CellReferenceObject extends BaseReferenceObject{constructor(token){super(token);const grid=deserializeRangeWithSheetWithCache(token);this.setForcedUnitIdDirect(grid.unitId),this.setForcedSheetName(grid.sheetName),this.setRangeData(grid.range)}isCell(){return!0}unionBy(referenceObject){if(!referenceObject.isCell())return ErrorValueObject.create(error_type_ErrorType.REF);const cellReferenceObject=referenceObject,newRangeData=this.unionRange(this.getRangeData(),cellReferenceObject.getRangeData());return this._createRange(newRangeData)}unionRange(rangeData1,rangeData2){const startRow1=rangeData1.startRow,startColumn1=rangeData1.startColumn,startRow2=rangeData2.startRow,startColumn2=rangeData2.startColumn,range={startRow:-1,startColumn:-1,endRow:-1,endColumn:-1};return startRow1>startRow2?(range.startRow=startRow2,range.endRow=startRow1):(range.startRow=startRow1,range.endRow=startRow2),startColumn1>startColumn2?(range.startColumn=startColumn2,range.endColumn=startColumn1):(range.startColumn=startColumn1,range.endColumn=startColumn2),rangeData1.startAbsoluteRefType&&(range.startAbsoluteRefType=rangeData1.startAbsoluteRefType),rangeData2.startAbsoluteRefType&&(range.endAbsoluteRefType=rangeData2.startAbsoluteRefType),range}_createRange(newRangeData){const rangeReferenceObject=new RangeReferenceObject(newRangeData,this.getForcedSheetId(),this.getForcedUnitId());rangeReferenceObject.setUnitData(this.getUnitData()),rangeReferenceObject.setDefaultSheetId(this.getDefaultSheetId()),rangeReferenceObject.setDefaultUnitId(this.getDefaultUnitId()),rangeReferenceObject.setRuntimeData(this.getRuntimeData()),rangeReferenceObject.setUnitStylesData(this.getUnitStylesData()),rangeReferenceObject.setArrayFormulaCellData(this.getArrayFormulaCellData()),rangeReferenceObject.setRuntimeArrayFormulaCellData(this.getRuntimeArrayFormulaCellData()),rangeReferenceObject.setRuntimeFeatureCellData(this.getRuntimeFeatureCellData());const{x,y}=this.getRefOffset();rangeReferenceObject.setRefOffset(x,y);const forceSheetId=this.getForcedSheetId();rangeReferenceObject.setForcedSheetName(this.getForcedSheetName()),null!=forceSheetId&&rangeReferenceObject.setForcedSheetIdDirect(forceSheetId);const forcedUnitId=this.getForcedUnitId();return forcedUnitId&&rangeReferenceObject.setForcedUnitIdDirect(forcedUnitId),rangeReferenceObject}}class ColumnReferenceObject extends BaseReferenceObject{constructor(token){super(token);const grid=deserializeRangeWithSheetWithCache(token);this.setForcedUnitIdDirect(grid.unitId),this.setForcedSheetName(grid.sheetName);const range={...grid.range,startColumn:grid.range.startColumn,startRow:Number.NaN,endColumn:grid.range.endColumn,endRow:Number.NaN,rangeType:src.$uV.COLUMN};this.setRangeData(range)}isColumn(){return!0}unionBy(referenceObject){if(!referenceObject.isColumn())return ErrorValueObject.create(error_type_ErrorType.REF);const columnReferenceObject=referenceObject;if(void 0!==columnReferenceObject.getForcedSheetName()&&""!==columnReferenceObject.getForcedSheetName())return ErrorValueObject.create(error_type_ErrorType.REF);const currentRangeData=this.getRangeData(),newColumnRange=columnReferenceObject.getRangeData(),newColumn=newColumnRange.startColumn;if(newColumn>=currentRangeData.startColumn&&newColumn<=currentRangeData.endColumn)return this;const column=currentRangeData.startColumn;return newColumn>column?currentRangeData.endColumn=newColumn:(currentRangeData.startColumn=newColumn,currentRangeData.endColumn=column),newColumnRange.startAbsoluteRefType&&(currentRangeData.endAbsoluteRefType=newColumnRange.startAbsoluteRefType),currentRangeData.rangeType=src.$uV.COLUMN,this.setToken(`${this.getToken()}${token_matchToken.COLON}${columnReferenceObject.getToken()}`),this}}class RowReferenceObject extends BaseReferenceObject{constructor(token){super(token);const grid=deserializeRangeWithSheetWithCache(token);this.setForcedUnitIdDirect(grid.unitId),this.setForcedSheetName(grid.sheetName);const range={...grid.range,startColumn:Number.NaN,startRow:grid.range.startRow,endColumn:Number.NaN,endRow:grid.range.endRow,rangeType:src.$uV.ROW};this.setRangeData(range)}isRow(){return!0}unionBy(referenceObject){if(!referenceObject.isRow())return ErrorValueObject.create(error_type_ErrorType.REF);const rowReferenceObject=referenceObject;if(void 0!==rowReferenceObject.getForcedSheetName()&&""!==rowReferenceObject.getForcedSheetName())return ErrorValueObject.create(error_type_ErrorType.REF);const currentRangeData=this.getRangeData(),newRowRange=rowReferenceObject.getRangeData(),newRow=newRowRange.startRow;if(newRow>=currentRangeData.startRow&&newRow<=currentRangeData.endRow)return this;const row=currentRangeData.startRow;return newRow>row?currentRangeData.endRow=newRow:(currentRangeData.startRow=newRow,currentRangeData.endRow=row),newRowRange.startAbsoluteRefType&&(currentRangeData.endAbsoluteRefType=newRowRange.startAbsoluteRefType),currentRangeData.rangeType=src.$uV.ROW,this.setToken(`${this.getToken()}${token_matchToken.COLON}${rowReferenceObject.getToken()}`),this}}function expandArrayValueObject(rowCount,columnCount,valueObject,defaultValue){const valueRowCount=valueObject.isArray()?valueObject.getRowCount():1,valueColumnCount=valueObject.isArray()?valueObject.getColumnCount():1,result=[];for(let r=0;r<rowCount;r++){const row=[];for(let c=0;c<columnCount;c++){if(1===valueRowCount&&1===valueColumnCount){const value=valueObject.isArray()?valueObject.get(0,0):valueObject;row.push(value);continue}if(1===valueRowCount&&c<valueColumnCount){const value=valueObject.get(0,c);row.push(value);continue}if(1===valueColumnCount&&r<valueRowCount){const value=valueObject.get(r,0);row.push(value);continue}if(r>=valueRowCount||c>=valueColumnCount){row.push(defaultValue??NullValueObject.create());continue}const value=valueObject.get(r,c);row.push(value)}result.push(row)}return createNewArray(result,rowCount,columnCount)}function createNewArray(result,rowCount,columnCount,unitId="",sheetId=""){const arrayValueObjectData={calculateValueList:result,rowCount,columnCount,unitId,sheetId,row:-1,column:-1};return ArrayValueObject.create(arrayValueObjectData)}function findCompareToken(str){const comparisonTokens=[compareToken.EQUALS,compareToken.NOT_EQUAL,compareToken.GREATER_THAN_OR_EQUAL,compareToken.GREATER_THAN,compareToken.LESS_THAN_OR_EQUAL,compareToken.LESS_THAN];for(const token of comparisonTokens)if(str.startsWith(token)){const content=str.substring(token.length);return[token,ValueObjectFactory.create(content)]}return[compareToken.EQUALS,ValueObjectFactory.create(str)]}function valueObjectCompare(range,criteria,operator,isCaseSensitive){if(!operator)if(criteria.isString()){const criteriaValueString=`${criteria.getValue()}`,[token,criteriaStringObject]=findCompareToken(criteriaValueString);operator=token,criteria=criteriaStringObject}else operator=compareToken.EQUALS;return range.compare(criteria,operator,isCaseSensitive)}function booleanObjectIntersection(valueObject1,valueObject2){const maxRowLength=Math.max(valueObject1.isArray()?valueObject1.getRowCount():1,valueObject2.isArray()?valueObject2.getRowCount():1),maxColumnLength=Math.max(valueObject1.isArray()?valueObject1.getColumnCount():1,valueObject2.isArray()?valueObject2.getColumnCount():1),valueObject1Array=expandArrayValueObject(maxRowLength,maxColumnLength,valueObject1),valueObject2Array=expandArrayValueObject(maxRowLength,maxColumnLength,valueObject2);return valueObject1Array.mapValue(((valueObject1,rowIndex,columnIndex)=>{const valueObject2=valueObject2Array.get(rowIndex,columnIndex);return valueObject1?.isError()?valueObject1:valueObject2?.isError()?valueObject2:valueObject1?.isBoolean()&&valueObject2?.isBoolean()?createBooleanValueObjectByRawValue(valueObject1.getValue()&&valueObject2.getValue()):BooleanValueObject.create(!1)}))}function isSingleValueObject(valueObject){return!(!valueObject.isArray()||1!==valueObject.getRowCount()||1!==valueObject.getColumnCount())||(valueObject.isReferenceObject()?!!valueObject.isCell()||1===valueObject.getRowCount()&&1===valueObject.getColumnCount():!!(valueObject.isString()||valueObject.isNumber()||valueObject.isBoolean()||valueObject.isError()||valueObject.isNull()))}function objectValueToCellValue(objectValue){const pattern=objectValue?.getPattern();let cellWithStyle={},cellWithCustomData={};if(pattern&&(cellWithStyle={s:{n:{pattern}}}),objectValue?.getCustomData()&&(cellWithCustomData={custom:objectValue.getCustomData()}),null==objectValue)return{v:null,...cellWithStyle};if(objectValue.isError())return{v:objectValue.getErrorType(),t:src.scd.STRING,...cellWithStyle,...cellWithCustomData};if(objectValue.isValueObject()){const vo=objectValue,v=vo.getValue();return vo.isNumber()?{v,t:src.scd.NUMBER,...cellWithStyle,...cellWithCustomData}:vo.isBoolean()?{v:v?1:0,t:src.scd.BOOLEAN,...cellWithStyle,...cellWithCustomData}:vo.isString()?{v,t:src.scd.STRING,...cellWithStyle,...cellWithCustomData}:vo.isNull()?{v:null,...cellWithStyle,...cellWithCustomData}:{v,t:src.scd.STRING,...cellWithStyle,...cellWithCustomData}}}function calculateMaxDimensions(variants){let maxRowLength=0,maxColumnLength=0;return variants.forEach(((variant,i)=>{if(i%2==1)if(variant.isArray()){const arrayValue=variant;maxRowLength=Math.max(maxRowLength,arrayValue.getRowCount()),maxColumnLength=Math.max(maxColumnLength,arrayValue.getColumnCount())}else maxRowLength=Math.max(maxRowLength,1),maxColumnLength=Math.max(maxColumnLength,1)})),{maxRowLength,maxColumnLength}}function getErrorArray(variants,sumRange,maxRowLength,maxColumnLength){const sumRowLength=sumRange.getRowCount(),sumColumnLength=sumRange.getColumnCount();for(let i=0;i<variants.length;i++){if(i%2==1)continue;const range=variants[i],rangeRowLength=range.getRowCount(),rangeColumnLength=range.getColumnCount();if(rangeRowLength!==sumRowLength||rangeColumnLength!==sumColumnLength)return expandArrayValueObject(maxRowLength,maxColumnLength,ErrorValueObject.create(error_type_ErrorType.VALUE))}return null}function getBooleanResults(variants,maxRowLength,maxColumnLength,isNumberSensitive=!1){const booleanResults=[];for(let i=0;i<variants.length;i++){if(i%2==1)continue;const range=variants[i];expandArrayValueObject(maxRowLength,maxColumnLength,variants[i+1],ErrorValueObject.create(error_type_ErrorType.NA)).iterator(((criteriaValueObject,rowIndex,columnIndex)=>{if(!criteriaValueObject)return;let resultArrayObject=valueObjectCompare(range,criteriaValueObject);isNumberSensitive&&(resultArrayObject=filterSameValueObjectResult(resultArrayObject,range,criteriaValueObject)),void 0===booleanResults[rowIndex]&&(booleanResults[rowIndex]=[]),void 0!==booleanResults[rowIndex][columnIndex]?booleanResults[rowIndex][columnIndex]=booleanObjectIntersection(booleanResults[rowIndex][columnIndex],resultArrayObject):booleanResults[rowIndex][columnIndex]=resultArrayObject}))}return booleanResults}function filterSameValueObjectResult(array,range,criteria){const[operator,criteriaObject]=findCompareToken(`${criteria.getValue()}`);return array.mapValue(((valueObject,r,c)=>{const rangeValueObject=range.get(r,c);if(rangeValueObject&&function isSameValueObjectType(left,right){if(left.isNumber()&&right.isNumber())return!0;if(left.isBoolean()&&right.isBoolean())return!0;const isLeftBlank=left.isString()&&""===left.getValue(),isRightBlank=right.isString()&&""===right.getValue();if((isLeftBlank||left.isNull())&&(isRightBlank||right.isNull()))return!0;if(left.isString()&&!isLeftBlank&&right.isString()&&!isRightBlank)return!0;return!1}(rangeValueObject,criteriaObject))return valueObject;if(rangeValueObject?.isNumber()){if(criteriaObject.isString()){const criteriaNumber=criteriaObject.convertToNumberObjectValue();if(criteriaNumber.isNumber())return rangeValueObject.compare(criteriaNumber,operator)}return BooleanValueObject.create(!1)}if(criteriaObject.isNumber()){if(rangeValueObject?.isString()){const rangeNumber=rangeValueObject.convertToNumberObjectValue();if(rangeNumber.isNumber())return rangeNumber.compare(criteriaObject,operator)}return BooleanValueObject.create(!1)}return rangeValueObject?.isError()&&criteriaObject.isError()&&rangeValueObject.getValue()===criteriaObject.getValue()?BooleanValueObject.create(!0):BooleanValueObject.create(!1)}))}var ReferenceObjectType=function(ReferenceObjectType){return ReferenceObjectType[ReferenceObjectType.CELL=0]="CELL",ReferenceObjectType[ReferenceObjectType.COLUMN=1]="COLUMN",ReferenceObjectType[ReferenceObjectType.ROW=2]="ROW",ReferenceObjectType}({});function runtime_service_ts_metadata(k,v){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(k,v)}var FormulaExecuteStageType=function(FormulaExecuteStageType){return FormulaExecuteStageType[FormulaExecuteStageType.IDLE=0]="IDLE",FormulaExecuteStageType[FormulaExecuteStageType.START=1]="START",FormulaExecuteStageType[FormulaExecuteStageType.START_DEPENDENCY=2]="START_DEPENDENCY",FormulaExecuteStageType[FormulaExecuteStageType.START_CALCULATION=3]="START_CALCULATION",FormulaExecuteStageType[FormulaExecuteStageType.CURRENTLY_CALCULATING=4]="CURRENTLY_CALCULATING",FormulaExecuteStageType[FormulaExecuteStageType.START_DEPENDENCY_ARRAY_FORMULA=5]="START_DEPENDENCY_ARRAY_FORMULA",FormulaExecuteStageType[FormulaExecuteStageType.START_CALCULATION_ARRAY_FORMULA=6]="START_CALCULATION_ARRAY_FORMULA",FormulaExecuteStageType[FormulaExecuteStageType.CURRENTLY_CALCULATING_ARRAY_FORMULA=7]="CURRENTLY_CALCULATING_ARRAY_FORMULA",FormulaExecuteStageType[FormulaExecuteStageType.CALCULATION_COMPLETED=8]="CALCULATION_COMPLETED",FormulaExecuteStageType}({}),FormulaExecutedStateType=function(FormulaExecutedStateType){return FormulaExecutedStateType[FormulaExecutedStateType.INITIAL=0]="INITIAL",FormulaExecutedStateType[FormulaExecutedStateType.STOP_EXECUTION=1]="STOP_EXECUTION",FormulaExecutedStateType[FormulaExecutedStateType.NOT_EXECUTED=2]="NOT_EXECUTED",FormulaExecutedStateType[FormulaExecutedStateType.SUCCESS=3]="SUCCESS",FormulaExecutedStateType}({});class FormulaRuntimeService extends src.jGt{constructor(_currentConfigService){super(),this._currentConfigService=_currentConfigService,this._formulaExecuteStage=0,this._stopState=!1,this._currentRow=-1,this._currentColumn=-1,this._currentRowCount=Number.NEGATIVE_INFINITY,this._currentColumnCount=Number.NEGATIVE_INFINITY,this._currentSubUnitId="",this._currentUnitId="",this._runtimeData={},this._runtimeOtherData={},this._unitArrayFormulaRange={},this._runtimeArrayFormulaCellData={},this._runtimeClearArrayFormulaCellData={},this._runtimeFeatureRange={},this._runtimeFeatureCellData={},this._functionsExecutedState=0,this._functionDefinitionPrivacyVar=new Map,this._totalFormulasToCalculate=0,this._completedFormulasCount=0,this._totalArrayFormulasToCalculate=0,this._completedArrayFormulasCount=0,this._formulaCycleIndex=0,this._isCycleDependency=!1}get currentRow(){return this._currentRow}get currentColumn(){return this._currentColumn}get currentRowCount(){return this._currentRowCount}get currentColumnCount(){return this._currentColumnCount}get currentSubUnitId(){return this._currentSubUnitId}get currentUnitId(){return this._currentUnitId}dispose(){super.dispose(),this.reset(),this._runtimeFeatureCellData={},this._runtimeFeatureRange={},this.clearReferenceAndNumberformatCache()}enableCycleDependency(){this._isCycleDependency=!0}disableCycleDependency(){this._isCycleDependency=!1}isCycleDependency(){return this._isCycleDependency}setFormulaCycleIndex(index){this._formulaCycleIndex=index}getFormulaCycleIndex(){return this._formulaCycleIndex}setTotalArrayFormulasToCalculate(value){this._totalArrayFormulasToCalculate=value}getTotalArrayFormulasToCalculate(){return this._totalArrayFormulasToCalculate}setCompletedArrayFormulasCount(value){this._completedArrayFormulasCount=value}getCompletedArrayFormulasCount(){return this._completedArrayFormulasCount}setTotalFormulasToCalculate(value){this._totalFormulasToCalculate=value}getTotalFormulasToCalculate(){return this._totalFormulasToCalculate}setCompletedFormulasCount(value){this._completedFormulasCount=value}getCompletedFormulasCount(){return this._completedFormulasCount}markedAsSuccessfullyExecuted(){this._functionsExecutedState=3}markedAsNoFunctionsExecuted(){this._functionsExecutedState=2}markedAsStopFunctionsExecuted(){this._functionsExecutedState=1}markedAsInitialFunctionsExecuted(){this._functionsExecutedState=0}stopExecution(){this._stopState=!0,this.setFormulaExecuteStage(0)}isStopExecution(){return this._stopState}setFormulaExecuteStage(type){this._formulaExecuteStage=type}getFormulaExecuteStage(){return this._formulaExecuteStage}reset(){this._formulaExecuteStage=0,this._runtimeData={},this._runtimeOtherData={},this._unitArrayFormulaRange={},this._runtimeArrayFormulaCellData={},this._runtimeClearArrayFormulaCellData={},this._functionDefinitionPrivacyVar.clear(),this.markedAsInitialFunctionsExecuted(),this._stopState=!1,this._isCycleDependency=!1,this._totalFormulasToCalculate=0,this._completedFormulasCount=0,this.clearReferenceAndNumberformatCache()}clearReferenceAndNumberformatCache(){!function clearNumberFormatTypeCache(){numberFormatTypeCache.clear()}(),function clearStringToNumberPatternCache(){stringToNumberPatternCache.clear()}(),function clearReferenceToRangeCache(){referenceToRangeCache.clear()}()}setCurrent(row,column,rowCount,columnCount,sheetId,unitId){this._currentRow=row,this._currentColumn=column,this._currentRowCount=rowCount,this._currentColumnCount=columnCount,this._currentSubUnitId=sheetId,this._currentUnitId=unitId}clearFunctionDefinitionPrivacyVar(){this._functionDefinitionPrivacyVar.clear()}registerFunctionDefinitionPrivacyVar(lambdaId,lambdaVar){this._functionDefinitionPrivacyVar.set(lambdaId,lambdaVar)}getFunctionDefinitionPrivacyVar(lambdaId){return this._functionDefinitionPrivacyVar.get(lambdaId)}setRuntimeOtherData(formulaId,x,y,functionVariant){const subUnitId=this._currentSubUnitId,unitId=this._currentUnitId;void 0===this._runtimeOtherData[unitId]&&(this._runtimeOtherData[unitId]={});const unitData=this._runtimeOtherData[unitId];void 0!==unitData[subUnitId]&&null!==unitData[subUnitId]||(unitData[subUnitId]={});const subComponentData=unitData[subUnitId];let cellDatas=[];if(functionVariant.isReferenceObject()||functionVariant.isValueObject()&&functionVariant.isArray()){const objectValueRefOrArray=functionVariant,{startRow,startColumn}=objectValueRefOrArray.getRangePosition();objectValueRefOrArray.iterator(((valueObject,rowIndex,columnIndex)=>{const value=objectValueToCellValue(valueObject),row=rowIndex-startRow,column=columnIndex-startColumn;null==cellDatas[row]&&(cellDatas[row]=[]),cellDatas[row][column]=value}))}else cellDatas=[[objectValueToCellValue(functionVariant)]];void 0!==subComponentData[formulaId]&&null!==subComponentData[formulaId]||(subComponentData[formulaId]={}),void 0!==subComponentData[formulaId][y]&&null!==subComponentData[formulaId][y]||(subComponentData[formulaId][y]={}),subComponentData[formulaId][y][x]=cellDatas}setRuntimeData(functionVariant){const row=this._currentRow,column=this._currentColumn,rowCount=this._currentRowCount,columnCount=this.currentColumnCount,sheetId=this._currentSubUnitId,unitId=this._currentUnitId;null==this._runtimeData[unitId]&&(this._runtimeData[unitId]={});const unitData=this._runtimeData[unitId];null==unitData[sheetId]&&(unitData[sheetId]=new src.hDc),null==this._unitArrayFormulaRange[unitId]&&(this._unitArrayFormulaRange[unitId]={});const arrayFormulaRange=this._unitArrayFormulaRange[unitId];null!==arrayFormulaRange[sheetId]&&void 0!==arrayFormulaRange[sheetId]||(arrayFormulaRange[sheetId]={});const arrayData=new src.hDc(arrayFormulaRange[sheetId]);void 0===this._runtimeArrayFormulaCellData[unitId]&&(this._runtimeArrayFormulaCellData[unitId]={});const runtimeArrayFormulaCellData=this._runtimeArrayFormulaCellData[unitId];null==runtimeArrayFormulaCellData[sheetId]&&(runtimeArrayFormulaCellData[sheetId]=new src.hDc),void 0===this._runtimeClearArrayFormulaCellData[unitId]&&(this._runtimeClearArrayFormulaCellData[unitId]={});const clearArrayFormulaCellData=this._runtimeClearArrayFormulaCellData[unitId];null==clearArrayFormulaCellData[sheetId]&&(clearArrayFormulaCellData[sheetId]=new src.hDc);const sheetData=unitData[sheetId],runtimeArrayUnitData=runtimeArrayFormulaCellData[sheetId],clearArrayUnitData=clearArrayFormulaCellData[sheetId];if(functionVariant.isReferenceObject()||functionVariant.isValueObject()&&functionVariant.isArray()){const objectValueRefOrArray=functionVariant,{startRow,startColumn,endRow,endColumn}=objectValueRefOrArray.getRangePosition();if(startRow===endRow&&startColumn===endColumn){const valueObject=objectValueToCellValue(objectValueRefOrArray.getFirstCell());return sheetData.setValue(row,column,valueObject),void clearArrayUnitData.setValue(row,column,valueObject)}const arrayRange={startRow:row,startColumn:column,endRow:endRow-startRow+row,endColumn:endColumn-startColumn+column};if(arrayData.setValue(row,column,arrayRange),this._checkIfArrayFormulaRangeHasData(unitId,sheetId,row,column,arrayRange)||this._checkIfArrayFormulaExceeded(rowCount,columnCount,arrayRange)){const errorObject=objectValueToCellValue(ErrorValueObject.create(error_type_ErrorType.SPILL));sheetData.setValue(row,column,errorObject),clearArrayUnitData.setValue(row,column,errorObject);const unitData=this._currentConfigService.getUnitData();objectValueRefOrArray.iterator(((_,rowIndex,columnIndex)=>{const currentRow=rowIndex-startRow+row,currentColumn=columnIndex-startColumn+column,cell=unitData[unitId]?.[sheetId]?.cellData.getValue(currentRow,currentColumn);if(rowIndex===startRow&&columnIndex===startColumn)runtimeArrayUnitData.setValue(row,column,errorObject);else if(null!=cell)null==cell.v&&(cell.v=""),runtimeArrayUnitData.setValue(currentRow,currentColumn,cell);else{if(this._isInOtherArrayFormulaRange(unitId,sheetId,row,column,currentRow,currentColumn))return!0;runtimeArrayUnitData.setValue(currentRow,currentColumn,{v:""})}}))}else{const spillError=ErrorValueObject.create(error_type_ErrorType.SPILL);objectValueRefOrArray.iterator(((valueObject,rowIndex,columnIndex)=>{const value=objectValueToCellValue(valueObject);if(rowIndex===startRow&&columnIndex===startColumn){if(null!=valueObject&&valueObject.isError()&&valueObject.isEqualType(spillError))return clearArrayUnitData.setValue(row,column,{}),sheetData.setValue(row,column,{...objectValueToCellValue(spillError)}),!1;sheetData.setValue(row,column,{...value})}const currentRow=rowIndex-startRow+row,currentColumn=columnIndex-startColumn+column;runtimeArrayUnitData.setValue(currentRow,currentColumn,value)}))}}else{const valueObject=objectValueToCellValue(functionVariant);sheetData.setValue(row,column,valueObject),clearArrayUnitData.setValue(row,column,valueObject)}}getUnitData(){return this._runtimeData}getUnitArrayFormula(){return this._unitArrayFormulaRange}getRuntimeOtherData(){return this._runtimeOtherData}getRuntimeArrayFormulaCellData(){return this._runtimeArrayFormulaCellData}getRuntimeClearArrayFormulaCellData(){return this._runtimeClearArrayFormulaCellData}getRuntimeFeatureRange(){return this._runtimeFeatureRange}setRuntimeFeatureRange(featureId,featureRange){this._runtimeFeatureRange[featureId]=featureRange}getRuntimeFeatureCellData(){return this._runtimeFeatureCellData}setRuntimeFeatureCellData(featureId,featureData){this._runtimeFeatureCellData[featureId]=featureData}getAllRuntimeData(){return{unitData:this.getUnitData(),arrayFormulaRange:this.getUnitArrayFormula(),unitOtherData:this.getRuntimeOtherData(),functionsExecutedState:this._functionsExecutedState,arrayFormulaCellData:this.getRuntimeArrayFormulaCellData(),clearArrayFormulaCellData:this.getRuntimeClearArrayFormulaCellData(),runtimeFeatureRange:this.getRuntimeFeatureRange(),runtimeFeatureCellData:this.getRuntimeFeatureCellData()}}getRuntimeState(){return{totalFormulasToCalculate:this.getTotalFormulasToCalculate(),completedFormulasCount:this.getCompletedFormulasCount(),totalArrayFormulasToCalculate:this.getTotalArrayFormulasToCalculate(),completedArrayFormulasCount:this.getCompletedArrayFormulasCount(),stage:this.getFormulaExecuteStage(),formulaCycleIndex:this.getFormulaCycleIndex()}}_checkIfArrayFormulaRangeHasData(formulaUnitId,formulaSheetId,formulaRow,formulaColumn,arrayRange){const{startRow,startColumn,endRow,endColumn}=arrayRange,unitData=this._currentConfigService.getUnitData(),arrayData=this._currentConfigService.getArrayFormulaCellData();this._unitArrayFormulaRange[formulaUnitId];for(let r=startRow;r<=endRow;r++)for(let c=startColumn;c<=endColumn;c++){if(r===formulaRow&&formulaColumn===c)continue;const cell=this._runtimeData?.[formulaUnitId]?.[formulaSheetId]?.getValue(r,c),currentCell=(arrayData?.[formulaUnitId]?.[formulaSheetId]?.getValue(r,c),unitData?.[formulaUnitId]?.[formulaSheetId]?.cellData?.getValue(r,c)),featureCell=this._getRuntimeFeatureCellValue(r,c,formulaSheetId,formulaUnitId);if(!isNullCellForFormula(cell)||this._isInOtherArrayFormulaRange(formulaUnitId,formulaSheetId,formulaRow,formulaColumn,r,c)||!isNullCellForFormula(currentCell)||!isNullCellForFormula(featureCell))return!0}return!1}_getRuntimeFeatureCellValue(row,column,sheetId,unitId){return getRuntimeFeatureCell(row,column,sheetId,unitId,this._runtimeFeatureCellData)}_arrayCellHasData(cell){return null!=cell&&void 0!==cell.v}_isInOtherArrayFormulaRange(formulaUnitId,formulaSheetId,formulaRow,formulaColumn,r,c){const arrayFormulaRange=this._currentConfigService.getArrayFormulaRange()[formulaUnitId]?.[formulaSheetId];if(null==arrayFormulaRange)return!1;let isCellOverlapping=!1;return new src.hDc(arrayFormulaRange).forValue(((rangeRow,rangeCol,range)=>{if(rangeRow===formulaRow&&rangeCol===formulaColumn)return;const isOverlapping=this._isInArrayFormulaRange(range,r,c),cell=this._runtimeData[formulaUnitId]?.[formulaSheetId]?.getValue(rangeRow,rangeCol);isOverlapping&&cell?.v!==error_type_ErrorType.SPILL&&(isCellOverlapping=!0)})),isCellOverlapping}_isInArrayFormulaRange(range,r,c){if(null==range)return!1;const{startRow,startColumn,endRow,endColumn}=range;return r>=startRow&&r<=endRow&&c>=startColumn&&c<=endColumn}_checkIfArrayFormulaExceeded(rowCount,columnCount,arrayRange){return arrayRange.endRow>=rowCount||arrayRange.endColumn>=columnCount}_isInDirtyRange(unitId,sheetId,row,column){const dirtyRanges=this._currentConfigService.getDirtyRanges();return 0===dirtyRanges.length||function isInDirtyRange(dirtyRanges,unitId,sheetId,row,column){for(let i=0,len=dirtyRanges.length;i<len;i++){const dirtyRange=dirtyRanges[i];if(unitId!==dirtyRange.unitId)continue;if(sheetId!==dirtyRange.sheetId)continue;const{startRow,startColumn,endRow,endColumn}=dirtyRange.range;if(row>=startRow&&row<=endRow&&column>=startColumn&&column<=endColumn)return!0}return!1}(dirtyRanges,unitId,sheetId,row,column)}}FormulaRuntimeService=function runtime_service_ts_decorate(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r}([function runtime_service_ts_param(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}}(0,IFormulaCurrentConfigService),runtime_service_ts_metadata("design:type",Function),runtime_service_ts_metadata("design:paramtypes",[void 0===IFormulaCurrentConfigService?Object:IFormulaCurrentConfigService])],FormulaRuntimeService);const IFormulaRuntimeService=(0,src.Qmd)("univer.formula.runtime.service");var NodeType=function(NodeType){return NodeType[NodeType.REFERENCE=1]="REFERENCE",NodeType[NodeType.VALUE=2]="VALUE",NodeType[NodeType.OPERATOR=3]="OPERATOR",NodeType[NodeType.FUNCTION=4]="FUNCTION",NodeType[NodeType.LAMBDA=5]="LAMBDA",NodeType[NodeType.LAMBDA_PARAMETER=6]="LAMBDA_PARAMETER",NodeType[NodeType.ERROR=7]="ERROR",NodeType[NodeType.BASE=8]="BASE",NodeType[NodeType.ROOT=9]="ROOT",NodeType[NodeType.UNION=10]="UNION",NodeType[NodeType.PREFIX=11]="PREFIX",NodeType[NodeType.SUFFIX=12]="SUFFIX",NodeType[NodeType.NULL=13]="NULL",NodeType}({});const NODE_ORDER_MAP=new Map([[1,7],[2,9],[3,8],[4,6],[5,1],[6,2],[9,10],[10,3],[11,4],[12,5]]);class BaseAstNode{constructor(_token){this._token=_token,this._children=[],this._calculateState=!1,this._async=!1,this._address=!1,this._isForcedCalculateFunction=!1}dispose(){this._children.forEach((node=>{node.dispose()})),this._valueObject?.dispose(),this._valueObject=null,this._children=[],this._definedNames=null,this._parent=null}get nodeType(){return NodeType.BASE}isAsync(){return this._async}isAddress(){return this._address}isForcedCalculateFunction(){return this._isForcedCalculateFunction}setAsync(){this._async=!0}setAddress(){this._address=!0}getParent(){return this._parent}setParent(node){this._parent=node,node.addChildren(this)}setForcedCalculateFunction(){this._isForcedCalculateFunction=!0}getChildren(){return this._children}addChildren(...astNode){this._children.push(...astNode)}getToken(){return this._token}setValue(value){this._valueObject=value}getValue(){return this._valueObject}isCalculated(){return this._calculateState}setCalculated(){this._calculateState=!0}execute(){}setNotEmpty(state=!0){}async executeAsync(){return Promise.resolve(AstNodePromiseType.SUCCESS)}serialize(){const token=this.getToken(),children=this.getChildren(),childrenSerialization=[],childrenCount=children.length;for(let i=0;i<childrenCount;i++){const item=children[i];childrenSerialization.push(item.serialize())}const result={token,nodeType:this.nodeType};return childrenCount>0&&(result.children=childrenSerialization),result}hasDefinedName(definedName){return this._definedNames?.includes(definedName)||!1}setDefinedNames(definedNames){this._definedNames=definedNames}getDefinedNames(){return this._definedNames}}class ErrorNode extends BaseAstNode{constructor(errorType){super(errorType),this._errorValueObject=ErrorValueObject.create(errorType)}get nodeType(){return NodeType.ERROR}static create(errorType){return new ErrorNode(errorType)}getValue(){return this._errorValueObject}}class BaseAstNodeFactory{get zIndex(){return 0}dispose(){}create(param,currentRow,currentColumn){let token;return token=param instanceof LexerNode?param.getToken():param,new BaseAstNode(token)}}class AstRootNode extends BaseAstNode{get nodeType(){return NodeType.ROOT}execute(){const children=this.getChildren();if(children.length>1)return void this.setValue(ErrorValueObject.create(error_type_ErrorType.VALUE));const node=children[0];null==node?this.setValue(ErrorValueObject.create(error_type_ErrorType.VALUE)):this.setValue(node.getValue())}}class AstRootNodeFactory extends BaseAstNodeFactory{get zIndex(){return NODE_ORDER_MAP.get(NodeType.ROOT)||100}checkAndCreateNodeType(param){if(!(param instanceof LexerNode))return;return"R_1"===param.getToken()?new AstRootNode("R_1"):void 0}}const FORMULA_AST_CACHE=new FormulaAstLRU(5e3);function generateAstNode(unitId,formulaString,lexer,astTreeBuilder,currentConfigService){let astNode=FORMULA_AST_CACHE.get(`${unitId}${formulaString}`);if(astNode&&!isDirtyDefinedForNode(astNode,currentConfigService))return astNode;const lexerNode=lexer.treeBuilder(formulaString);if(ERROR_TYPE_SET.has(lexerNode))return ErrorNode.create(lexerNode);if(astNode=astTreeBuilder.parse(lexerNode),null==astNode)throw new Error("astNode is null");return FORMULA_AST_CACHE.set(`${unitId}${formulaString}`,astNode),astNode}function isDirtyDefinedForNode(node,currentConfigService){const definedNameMap=currentConfigService.getDirtyDefinedNameMap(),executeUnitId=currentConfigService.getExecuteUnitId();if(null!=executeUnitId&&null!=definedNameMap[executeUnitId]){const names=Object.keys(definedNameMap[executeUnitId]);for(let i=0,len=names.length;i<len;i++){const name=names[i];if(node.hasDefinedName(name))return!0}}return!1}const IFunctionService=(0,src.Qmd)("univer.formula-function.service");class FunctionService extends src.jGt{dispose(){super.dispose(),this._functionExecutors.clear(),this._functionDescriptions.clear()}registerExecutors(...functions){for(let i=0;i<functions.length;i++){const func=functions[i];this._functionExecutors.set(func.name,func)}}getExecutors(){return this._functionExecutors}getExecutor(functionToken){return this._functionExecutors.get(functionToken)}hasExecutor(functionToken){return this._functionExecutors.has(functionToken)}unregisterExecutors(...functionTokens){for(let i=0;i<functionTokens.length;i++){const functionToken=functionTokens[i];this._functionExecutors.delete(functionToken)}}registerDescriptions(...descriptions){for(let i=0;i<descriptions.length;i++){const description=descriptions[i];this._functionDescriptions.set(description.functionName,description)}return(0,src.saO)((()=>{for(let i=0;i<descriptions.length;i++){const description=descriptions[i];this._functionDescriptions.delete(description.functionName)}}))}getDescriptions(){return this._functionDescriptions}getDescription(functionToken){return this._functionDescriptions.get(functionToken)}hasDescription(functionToken){return this._functionDescriptions.has(functionToken)}unregisterDescriptions(...functionTokens){for(let i=0;i<functionTokens.length;i++){const functionToken=functionTokens[i];this._functionDescriptions.delete(functionToken)}}deleteFormulaAstCacheKey(...functionToken){FORMULA_AST_CACHE.forEach(((_,key)=>{functionToken.forEach((token=>{key.includes(token)&&FORMULA_AST_CACHE.delete(key)}))}))}constructor(...args){super(...args),this._functionExecutors=new Map,this._functionDescriptions=new Map}}var FUNCTION_NAMES_META=function(FUNCTION_NAMES_META){return FUNCTION_NAMES_META.COMPARE="COMPARE",FUNCTION_NAMES_META.DIVIDED="DIVIDED",FUNCTION_NAMES_META.MINUS="MINUS",FUNCTION_NAMES_META.MULTIPLY="MULTIPLY",FUNCTION_NAMES_META.PLUS="PLUS",FUNCTION_NAMES_META.UNION="UNION",FUNCTION_NAMES_META.CUBE="CUBE",FUNCTION_NAMES_META}({});function prefix_node_ts_metadata(k,v){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(k,v)}function prefix_node_ts_param(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}}class PrefixNode extends BaseAstNode{constructor(_runtimeService,_operatorString,_functionExecutor){super(_operatorString),this._runtimeService=_runtimeService,this._operatorString=_operatorString,this._functionExecutor=_functionExecutor}get nodeType(){return NodeType.PREFIX}execute(){let result,value=this.getChildren()[0].getValue();if(null==value)throw new Error("object is null");this._operatorString===prefixToken.MINUS?(value.isReferenceObject()&&(value=value.toArrayValueObject()),result=this._functionExecutor.calculate(NumberValueObject.create(0),value)):result=this._operatorString===prefixToken.AT?this._handlerAT(value):ErrorValueObject.create(error_type_ErrorType.VALUE),this.setValue(result)}_handlerAT(value){if(!value.isReferenceObject())return ErrorValueObject.create(error_type_ErrorType.VALUE);const currentValue=value;if(currentValue.isCell())return ErrorValueObject.create(error_type_ErrorType.VALUE);const runtimeService=this._runtimeService,currentRow=runtimeService.currentRow||0,currentColumn=runtimeService.currentColumn||0,rangePos=currentValue.getRangePosition(),{startRow,startColumn,endRow,endColumn}=rangePos;return endColumn!==startColumn&&endRow!==startRow||startRow===endRow&&startColumn===endColumn?ErrorValueObject.create(error_type_ErrorType.VALUE):endRow===startRow&&currentColumn>=startColumn&&currentColumn<=endColumn?currentValue.getCellByColumn(currentColumn):startColumn===endColumn&&currentRow>=startRow&&currentRow<=endRow?currentValue.getCellByRow(currentRow):currentValue.isTable()?currentValue.getCellByPosition(currentRow):ErrorValueObject.create(error_type_ErrorType.VALUE)}}class PrefixNodeFactory extends BaseAstNodeFactory{constructor(_functionService,_runtimeService){super(),this._functionService=_functionService,this._runtimeService=_runtimeService}get zIndex(){return NODE_ORDER_MAP.get(NodeType.PREFIX)||100}checkAndCreateNodeType(param){if(!(param instanceof LexerNode))return;const token=param.getToken(),tokenTrim=token.trim();if('"'===tokenTrim.charAt(0)&&'"'===tokenTrim.charAt(tokenTrim.length-1))return;let functionName="";if(tokenTrim!==prefixToken.MINUS)return tokenTrim===prefixToken.AT?new PrefixNode(this._runtimeService,tokenTrim):void 0;functionName=FUNCTION_NAMES_META.MINUS;const functionExecutor=this._functionService.getExecutor(functionName);return functionExecutor?new PrefixNode(this._runtimeService,tokenTrim,functionExecutor):(console.error(`No function ${token}`),ErrorNode.create(error_type_ErrorType.NAME))}}PrefixNodeFactory=function prefix_node_ts_decorate(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r}([prefix_node_ts_param(0,IFunctionService),prefix_node_ts_param(1,IFormulaRuntimeService),prefix_node_ts_metadata("design:type",Function),prefix_node_ts_metadata("design:paramtypes",[void 0===IFunctionService?Object:IFunctionService,void 0===IFormulaRuntimeService?Object:IFormulaRuntimeService])],PrefixNodeFactory);new RegExp(prefixToken.MINUS,"g"),new RegExp(prefixToken.AT,"g");function prefixHandler(tokenTrimParam,functionService,runtimeService){let minusPrefixNode,atPrefixNode,tokenTrim=tokenTrimParam;const prefix=tokenTrim.slice(0,2);let sliceLength=0;if(prefix[0]===prefixToken.MINUS){const functionExecutor=functionService.getExecutor(FUNCTION_NAMES_META.MINUS);minusPrefixNode=new PrefixNode(runtimeService,prefixToken.MINUS,functionExecutor),sliceLength++}return prefix[0]===prefixToken.AT&&(atPrefixNode=new PrefixNode(runtimeService,prefixToken.AT),minusPrefixNode&&atPrefixNode.setParent(minusPrefixNode),sliceLength++),sliceLength>0&&(tokenTrim=tokenTrim.slice(sliceLength)),{tokenTrim,minusPrefixNode,atPrefixNode}}function function_node_ts_metadata(k,v){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(k,v)}function function_node_ts_param(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}}class FunctionNode extends BaseAstNode{constructor(token,_functionExecutor,_currentConfigService,_runtimeService,_definedNamesService,_formulaDataModel){super(token),this._functionExecutor=_functionExecutor,this._currentConfigService=_currentConfigService,this._runtimeService=_runtimeService,this._definedNamesService=_definedNamesService,this._formulaDataModel=_formulaDataModel,this._functionExecutor.isAsync()&&this.setAsync(),this._functionExecutor.isAddress()&&this.setAddress(),this._functionExecutor.needsLocale&&this._setLocale(),this._functionExecutor.needsSheetsInfo&&this._setSheetsInfo(),this._functionExecutor.needsFormulaDataModel&&this._functionExecutor.setFormulaDataModel(this._formulaDataModel)}get nodeType(){return NodeType.FUNCTION}async executeAsync(){const variants=[],children=this.getChildren(),childrenCount=children.length;this._compatibility();for(let i=0;i<childrenCount;i++){const object=children[i].getValue();null!=object&&(object.isReferenceObject()&&!this._functionExecutor.needsReferenceObject?variants.push(object.toArrayValueObject()):variants.push(object))}const resultVariant=await this._calculateAsync(variants);let result;return result=resultVariant.isAsyncObject()||resultVariant.isAsyncArrayObject()?await resultVariant.getValue():resultVariant,this._setRefData(result),this.setValue(result),Promise.resolve(AstNodePromiseType.SUCCESS)}execute(){const variants=[],children=this.getChildren(),childrenCount=children.length;this._compatibility();for(let i=0;i<childrenCount;i++){const object=children[i].getValue();null!=object&&(object.isReferenceObject()&&!this._functionExecutor.needsReferenceObject?variants.push(object.toArrayValueObject()):variants.push(object))}const resultVariant=this._calculate(variants);this._setRefData(resultVariant),this.setValue(resultVariant)}_compatibility(){this._lookupCompatibility()}_lookupCompatibility(){const children=this.getChildren(),childrenCount=children.length;if(!this._functionExecutor.needsExpandParams||3!==childrenCount)return;const lookupVectorOrArray=children[1].getValue(),resultVector=children[2].getValue();if(!lookupVectorOrArray?.isReferenceObject()&&!resultVector?.isReferenceObject())return;let lookupCountRow,lookupCountColumn;if(lookupVectorOrArray?.isReferenceObject()){const lookupVectorOrArrayRange=lookupVectorOrArray.getRangeData(),{startRow,startColumn,endRow,endColumn}=lookupVectorOrArrayRange;lookupCountRow=endRow-startRow+1,lookupCountColumn=endColumn-startColumn+1}else lookupCountRow=lookupVectorOrArray?.isArray()?lookupVectorOrArray.getRowCount():1,lookupCountColumn=lookupVectorOrArray?.isArray()?lookupVectorOrArray.getColumnCount():1;const resultVectorRange=resultVector.getRangeData(),{startRow:reStartRow,startColumn:reStartColumn,endRow:reEndRow,endColumn:reEndColumn}=resultVectorRange,resultCountRow=reEndRow-reStartRow+1,resultCountColumn=reEndColumn-reStartColumn+1;lookupCountRow!==resultCountRow&&(resultVectorRange.endRow+=lookupCountRow-resultCountRow),lookupCountColumn!==resultCountColumn&&(resultVectorRange.endColumn+=lookupCountColumn-resultCountColumn)}_handleCustomResult(resultVariantCustom){if("object"!=typeof resultVariantCustom||null==resultVariantCustom)return ValueObjectFactory.create(resultVariantCustom);const arrayValues=transformToValueObject(resultVariantCustom);return ArrayValueObject.create({calculateValueList:arrayValues,rowCount:arrayValues.length,columnCount:arrayValues[0]?.length||0,unitId:"",sheetId:"",row:-1,column:-1})}_handleAddressFunction(){this._functionExecutor.isAddress()&&this._setDefinedNamesForFunction()}_mapVariantsToValues(variants){return variants.map((variant=>variant.isArray()?variant.toValue():variant.isLambda()?variant:variant.getValue()))}_calculate(variants){const{minParams,maxParams}=this._functionExecutor;if(-1!==minParams&&-1!==maxParams&&(variants.length<minParams||variants.length>maxParams))return ErrorValueObject.create(error_type_ErrorType.NA);let resultVariant;if(this._setRefInfo(),this._functionExecutor.isCustom()){const resultVariantCustom=this._functionExecutor.calculateCustom(...this._mapVariantsToValues(variants));resultVariant=this._handleCustomResult(resultVariantCustom)}else this._handleAddressFunction(),resultVariant=this._functionExecutor.calculate(...variants);return resultVariant}async _calculateAsync(variants){const{minParams,maxParams}=this._functionExecutor;if(-1!==minParams&&-1!==maxParams&&(variants.length<minParams||variants.length>maxParams))return ErrorValueObject.create(error_type_ErrorType.NA);let resultVariant;if(this._setRefInfo(),this._functionExecutor.isCustom()){const resultVariantCustom=await this._functionExecutor.calculateCustom(...this._mapVariantsToValues(variants));resultVariant=this._handleCustomResult(resultVariantCustom)}else this._handleAddressFunction(),resultVariant=this._functionExecutor.calculate(...variants);return resultVariant}_setDefinedNamesForFunction(){const editorUnitId=this._currentConfigService.getExecuteUnitId();if(null==editorUnitId)return;const definedNames=this._definedNamesService.getDefinedNameMap(editorUnitId);null!=definedNames&&this._functionExecutor.setDefinedNames(definedNames)}_setRefInfo(){const{currentUnitId,currentSubUnitId,currentRow,currentColumn}=this._runtimeService;if(this._functionExecutor.setRefInfo(currentUnitId,currentSubUnitId,currentRow,currentColumn),this._functionExecutor.needsSheetRowColumnCount){const{rowCount,columnCount}=this._currentConfigService.getSheetRowColumnCount(currentUnitId,currentSubUnitId);this._functionExecutor.setSheetRowColumnCount(rowCount,columnCount)}}_setRefData(variant){if(!variant.isReferenceObject())return;const referenceObject=variant;referenceObject.setForcedSheetId(this._currentConfigService.getSheetNameMap()),referenceObject.setUnitData(this._currentConfigService.getUnitData()),referenceObject.setArrayFormulaCellData(this._currentConfigService.getArrayFormulaCellData()),referenceObject.setRuntimeData(this._runtimeService.getUnitData()),referenceObject.setRuntimeArrayFormulaCellData(this._runtimeService.getRuntimeArrayFormulaCellData()),referenceObject.setRuntimeFeatureCellData(this._runtimeService.getRuntimeFeatureCellData())}_setLocale(){this._functionExecutor.setLocale(this._currentConfigService.getLocale())}_setSheetsInfo(){this._functionExecutor.setSheetsInfo(this._currentConfigService.getSheetsInfo())}}class ErrorFunctionNode extends BaseAstNode{constructor(token="Error"){super(token)}get nodeType(){return NodeType.FUNCTION}async executeAsync(){return this.setValue(ErrorValueObject.create(error_type_ErrorType.NAME)),Promise.resolve(AstNodePromiseType.SUCCESS)}execute(){this.setValue(ErrorValueObject.create(error_type_ErrorType.NAME))}}class FunctionNodeFactory extends BaseAstNodeFactory{constructor(_functionService,_currentConfigService,_runtimeService,_definedNamesService,_injector,_formulaDataModel){super(),this._functionService=_functionService,this._currentConfigService=_currentConfigService,this._runtimeService=_runtimeService,this._definedNamesService=_definedNamesService,this._injector=_injector,this._formulaDataModel=_formulaDataModel}get zIndex(){return NODE_ORDER_MAP.get(NodeType.FUNCTION)||100}create(token){const functionExecutor=this._functionService.getExecutor(token);return functionExecutor?new FunctionNode(token,functionExecutor,this._currentConfigService,this._runtimeService,this._definedNamesService,this._formulaDataModel):(console.error(`No function ${token}`),ErrorNode.create(error_type_ErrorType.NAME))}checkAndCreateNodeType(param){if("string"==typeof param)return;const token=param.getToken(),{tokenTrim,minusPrefixNode,atPrefixNode}=prefixHandler(token.trim(),this._functionService,this._runtimeService);if(!Number.isNaN(Number(tokenTrim))&&!this._isParentUnionNode(param))return ErrorNode.create(error_type_ErrorType.VALUE);const tokenTrimUpper=tokenTrim.toUpperCase();if(this._functionService.hasExecutor(tokenTrimUpper)){const functionNode=this.create(tokenTrimUpper);return atPrefixNode?functionNode.setParent(atPrefixNode):minusPrefixNode&&functionNode.setParent(minusPrefixNode),functionNode}}_isParentUnionNode(param){return param.getParent()?.getParent()?.getToken()===token_matchToken.COLON}}function interpreter_ts_metadata(k,v){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(k,v)}FunctionNodeFactory=function function_node_ts_decorate(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r}([function_node_ts_param(0,IFunctionService),function_node_ts_param(1,IFormulaCurrentConfigService),function_node_ts_param(2,IFormulaRuntimeService),function_node_ts_param(3,IDefinedNamesService),function_node_ts_param(4,(0,src.y_5)(src.zZn)),function_node_ts_param(5,(0,src.y_5)(FormulaDataModel)),function_node_ts_metadata("design:type",Function),function_node_ts_metadata("design:paramtypes",[void 0===IFunctionService?Object:IFunctionService,void 0===IFormulaCurrentConfigService?Object:IFormulaCurrentConfigService,void 0===IFormulaRuntimeService?Object:IFormulaRuntimeService,void 0===IDefinedNamesService?Object:IDefinedNamesService,void 0===src.zZn?Object:src.zZn,void 0===FormulaDataModel?Object:FormulaDataModel])],FunctionNodeFactory);class Interpreter extends src.jGt{constructor(_runtimeService){super(),this._runtimeService=_runtimeService}async executeAsync(nodeData){if(!nodeData||!nodeData.node)return Promise.resolve(ErrorValueObject.create(error_type_ErrorType.VALUE));const node=nodeData.node,refOffsetX=nodeData.refOffsetX,refOffsetY=nodeData.refOffsetY;await this._executeAsync(node,refOffsetX,refOffsetY);const value=node.getValue();return null==value?Promise.resolve(ErrorValueObject.create(error_type_ErrorType.VALUE)):Promise.resolve(value)}execute(nodeData){if(!nodeData||!nodeData.node)return ErrorValueObject.create(error_type_ErrorType.VALUE);const node=nodeData.node,refOffsetX=nodeData.refOffsetX,refOffsetY=nodeData.refOffsetY;this._execute(node,refOffsetX,refOffsetY);const value=node.getValue();return null==value?ErrorValueObject.create(error_type_ErrorType.VALUE):value}executePreCalculateNode(node){return node.execute(),node.getValue()}checkAsyncNode(node){if(null==node)return!1;const result=[];this._checkAsyncNode(node,result);for(let i=0,len=result.length;i<len;i++){if(!0===result[i])return!0}return!1}_checkAsyncNode(node,resultList){const children=node.getChildren(),childrenCount=children.length;for(let i=0;i<childrenCount;i++){const item=children[i];resultList.push(item.isAsync()),this._checkAsyncNode(item,resultList)}}async _executeAsync(node,refOffsetX=0,refOffsetY=0){if(this._runtimeService.isStopExecution())return Promise.resolve(AstNodePromiseType.ERROR);const children=node.getChildren(),childrenCount=children.length;for(let i=0;i<childrenCount;i++){const item=children[i];"LAMBDA"===item.getToken().toUpperCase()&&item.isEmptyParamFunction()?item.execute():await this._executeAsync(item,refOffsetX,refOffsetY)}return node.nodeType===NodeType.REFERENCE&&node.setRefOffset(refOffsetX,refOffsetY),node.nodeType===NodeType.FUNCTION&&node.isAsync()?await node.executeAsync():node.execute(),Promise.resolve(AstNodePromiseType.SUCCESS)}_execute(node,refOffsetX=0,refOffsetY=0){if(this._runtimeService.isStopExecution())return AstNodePromiseType.ERROR;const children=node.getChildren(),childrenCount=children.length;for(let i=0;i<childrenCount;i++){const item=children[i];"LAMBDA"===item.getToken().toUpperCase()&&item.isEmptyParamFunction()?item.execute():this._execute(item,refOffsetX,refOffsetY)}return node.nodeType===NodeType.REFERENCE&&node.setRefOffset(refOffsetX,refOffsetY),node.execute(),AstNodePromiseType.SUCCESS}}function isFirstChildParameter(lexerNode){return lexerNode instanceof LexerNode&&"L_1"===lexerNode.getToken()}function isChildRunTimeParameter(lexerNode){return lexerNode instanceof LexerNode&&"LO_1"===lexerNode.getToken()}function updateLambdaStatement(functionStatementNode,lambdaId,currentLambdaPrivacyVar){const children=functionStatementNode.getChildren(),childrenCount=children.length,firstChild=children[0];for(let i=0;i<childrenCount;i++){const node=children[i];if(!isFirstChildParameter(firstChild)||0===i)if(node instanceof LexerNode)updateLambdaStatement(node,lambdaId,currentLambdaPrivacyVar);else{const token=node.trim();if(currentLambdaPrivacyVar.has(token)){const newNode=new LexerNode;newNode.setToken("LR_1"),newNode.setLambdaId(lambdaId),newNode.setLambdaPrivacyVar(currentLambdaPrivacyVar),newNode.setLambdaParameter(token),children[i]=newNode}}}}function getAstNodeTopParent(node){let parent=node;for(;parent?.getParent();)parent=parent.getParent();return parent}function generateExecuteAstNodeData(node,refOffsetX=0,refOffsetY=0){return{node,refOffsetX,refOffsetY}}function getRootLexerHasValueNode(node){if(!node)return;if("LR_1"!==node.getToken())return node;const parameterNode=node,currentLambdaPrivacyVar=parameterNode.getCurrentLambdaPrivacyVar(),lambdaParameter=parameterNode.getLambdaParameter();if(!currentLambdaPrivacyVar)return;const chainNode=currentLambdaPrivacyVar.get(lambdaParameter);return null==chainNode&&node.getValue()?node:getRootLexerHasValueNode(chainNode)}Interpreter=function interpreter_ts_decorate(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r}([function interpreter_ts_param(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}}(0,IFormulaRuntimeService),interpreter_ts_metadata("design:type",Function),interpreter_ts_metadata("design:paramtypes",[void 0===IFormulaRuntimeService?Object:IFormulaRuntimeService])],Interpreter);class LambdaValueObjectObject extends BaseValueObject{static create(lambdaNode,interpreter,lambdaPrivacyVarKeys){return new LambdaValueObjectObject(lambdaNode,interpreter,lambdaPrivacyVarKeys)}constructor(_lambdaNode,_interpreter,_lambdaPrivacyVarKeys){super(0),this._lambdaNode=_lambdaNode,this._interpreter=_interpreter,this._lambdaPrivacyVarKeys=_lambdaPrivacyVarKeys,this._lambdaPrivacyValueMap=new Map,this._lambdaPrivacyValueMap.clear()}dispose(){this._lambdaPrivacyValueMap.clear(),this._lambdaPrivacyValueMap=new Map,this._lambdaNode=null,this._interpreter=null,this._lambdaPrivacyVarKeys=[]}isLambda(){return!0}execute(...variants){const paramCount=this._lambdaPrivacyVarKeys.length;if(variants.length!==paramCount||!this._interpreter||!this._lambdaNode)return ErrorValueObject.create(error_type_ErrorType.VALUE);let value;if(this._setLambdaPrivacyValueMap(variants),this._setLambdaNodeValue(this._lambdaNode),this._lambdaNode.setNotEmpty(!1),this._interpreter.checkAsyncNode(this._lambdaNode))value=new AsyncObject(this._interpreter.executeAsync(generateExecuteAstNodeData(this._lambdaNode)));else{const o=this._interpreter.execute(generateExecuteAstNodeData(this._lambdaNode));value=o.isReferenceObject()?o.toArrayValueObject():o}return this._lambdaNode.setNotEmpty(!0),value}executeCustom(...variants){const baseValueObjects=variants.map((variant=>ValueObjectFactory.create(variant)));return this.execute(...baseValueObjects)}_setLambdaNodeValue(node){if(!node)return;const children=node.getChildren(),childrenCount=children.length;for(let i=0;i<childrenCount;i++){const item=children[i];if("LR_1"!==item.getToken())this._setLambdaNodeValue(item);else{const lambdaParameter=item.getLambdaParameter(),value=this._lambdaPrivacyValueMap.get(lambdaParameter);if(value)item.setValue(value);else{const node=getRootLexerHasValueNode(item.getCurrentLambdaPrivacyVar().get(lambdaParameter));null!=node&&item.setValue(node.getValue())}}}}_setLambdaPrivacyValueMap(variants){for(let i=0;i<variants.length;i++){const variant=variants[i],key=this._lambdaPrivacyVarKeys[i];this._lambdaPrivacyValueMap.set(key,variant)}}getLambdaPrivacyVarKeys(){return this._lambdaPrivacyVarKeys}}function lambda_node_ts_metadata(k,v){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(k,v)}function lambda_node_ts_param(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}}class LambdaNode extends BaseAstNode{constructor(token,_lambdaId,_interpreter,_lambdaPrivacyVarKeys){super(token),this._lambdaId=_lambdaId,this._interpreter=_interpreter,this._lambdaPrivacyVarKeys=_lambdaPrivacyVarKeys,this._isNotEmpty=!0}get nodeType(){return NodeType.LAMBDA}setNotEmpty(state=!1){this._isNotEmpty=state}isEmptyParamFunction(){return this.getChildren().length<2&&this._isNotEmpty}isFunctionParameter(){return null===this._lambdaId}getLambdaId(){return this._lambdaId}execute(){if(this.isEmptyParamFunction())this.setValue(LambdaValueObjectObject.create(this,this._interpreter,this._lambdaPrivacyVarKeys));else{const children=this.getChildren(),childrenCount=children.length;this.setValue(children[childrenCount-1].getValue())}}}class LambdaNodeFactory extends BaseAstNodeFactory{constructor(_runtimeService,_interpreter){super(),this._runtimeService=_runtimeService,this._interpreter=_interpreter}get zIndex(){return NODE_ORDER_MAP.get(NodeType.LAMBDA)||100}create(param){const children=param.getChildren(),lambdaVar=children[0];let parameterArray=children.slice(1,-1);const functionStatementNode=children[children.length-1];if(!(lambdaVar instanceof LexerNode&&functionStatementNode instanceof LexerNode))return ErrorNode.create(error_type_ErrorType.NAME);if("L_1"===lambdaVar.getToken()){const lambdaVarChildren=lambdaVar.getChildren();if(parameterArray.length!==lambdaVarChildren.length)return ErrorNode.create(error_type_ErrorType.VALUE)}else parameterArray=children.slice(0,-1);const lambdaId=src.S0q.generateRandomId(8),currentLambdaPrivacyVar=new Map;for(let i=0;i<parameterArray.length;i++){const parameter=parameterArray[i];if(!(parameter instanceof LexerNode))return ErrorNode.create(error_type_ErrorType.VALUE);{const variant=parameter.getChildren()[0];parameter.setToken("LO_1"),currentLambdaPrivacyVar.set(variant.trim(),void 0)}}return this._runtimeService.registerFunctionDefinitionPrivacyVar(lambdaId,currentLambdaPrivacyVar),this._updateLambdaStatement(functionStatementNode,lambdaId,currentLambdaPrivacyVar),new LambdaNode(param.getToken(),lambdaId,this._interpreter,[...currentLambdaPrivacyVar.keys()])}checkAndCreateNodeType(param){if(!(param instanceof LexerNode))return;return"LAMBDA"===param.getToken().trim().toUpperCase()?this.create(param):void 0}_updateLambdaStatement(functionStatementNode,lambdaId,currentLambdaPrivacyVar){updateLambdaStatement(functionStatementNode,lambdaId,currentLambdaPrivacyVar)}}function getRootLexerNode(node){if(!node)return;if("LR_1"!==node.getToken())return node;const parameterNode=node,currentLambdaPrivacyVar=parameterNode.getCurrentLambdaPrivacyVar(),lambdaParameter=parameterNode.getLambdaParameter();return currentLambdaPrivacyVar?getRootLexerNode(currentLambdaPrivacyVar.get(lambdaParameter)):void 0}LambdaNodeFactory=function lambda_node_ts_decorate(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r}([lambda_node_ts_param(0,IFormulaRuntimeService),lambda_node_ts_param(1,(0,src.y_5)(Interpreter)),lambda_node_ts_metadata("design:type",Function),lambda_node_ts_metadata("design:paramtypes",[void 0===IFormulaRuntimeService?Object:IFormulaRuntimeService,void 0===Interpreter?Object:Interpreter])],LambdaNodeFactory);class LambdaParameterNode extends BaseAstNode{constructor(token,_lambdaParameter,_currentLambdaPrivacyVar){super(token),this._lambdaParameter=_lambdaParameter,this._currentLambdaPrivacyVar=_currentLambdaPrivacyVar}getLambdaParameter(){return this._lambdaParameter}getCurrentLambdaPrivacyVar(){return this._currentLambdaPrivacyVar}get nodeType(){return NodeType.LAMBDA_PARAMETER}execute(){const node=getRootLexerNode(this._currentLambdaPrivacyVar.get(this._lambdaParameter));if(node)this.setValue(node.getValue());else{const value=this.getValue();(null==value||value.isError())&&this.setValue(ErrorValueObject.create(error_type_ErrorType.NAME))}}}class LambdaParameterNodeFactory extends BaseAstNodeFactory{get zIndex(){return NODE_ORDER_MAP.get(NodeType.LAMBDA_PARAMETER)||100}create(param){const currentLambdaPrivacyVar=param.getFunctionDefinitionPrivacyVar(),lambdaParameter=param.getLambdaParameter();return currentLambdaPrivacyVar?new LambdaParameterNode(param.getToken(),lambdaParameter,currentLambdaPrivacyVar):new ErrorNode(error_type_ErrorType.NAME)}checkAndCreateNodeType(param){if(!(param instanceof LexerNode))return;return"LR_1"===param.getToken().trim()?this.create(param):void 0}}class NullNode extends BaseAstNode{constructor(_operatorString){super(_operatorString),this._operatorString=_operatorString}get nodeType(){return NodeType.NULL}execute(){this.setValue(NullValueObject.create())}}var FUNCTION_NAMES_MATH=function(FUNCTION_NAMES_MATH){return FUNCTION_NAMES_MATH.ABS="ABS",FUNCTION_NAMES_MATH.ACOS="ACOS",FUNCTION_NAMES_MATH.ACOSH="ACOSH",FUNCTION_NAMES_MATH.ACOT="ACOT",FUNCTION_NAMES_MATH.ACOTH="ACOTH",FUNCTION_NAMES_MATH.AGGREGATE="AGGREGATE",FUNCTION_NAMES_MATH.ARABIC="ARABIC",FUNCTION_NAMES_MATH.ASIN="ASIN",FUNCTION_NAMES_MATH.ASINH="ASINH",FUNCTION_NAMES_MATH.ATAN="ATAN",FUNCTION_NAMES_MATH.ATAN2="ATAN2",FUNCTION_NAMES_MATH.ATANH="ATANH",FUNCTION_NAMES_MATH.BASE="BASE",FUNCTION_NAMES_MATH.CEILING="CEILING",FUNCTION_NAMES_MATH.CEILING_MATH="CEILING.MATH",FUNCTION_NAMES_MATH.CEILING_PRECISE="CEILING.PRECISE",FUNCTION_NAMES_MATH.COMBIN="COMBIN",FUNCTION_NAMES_MATH.COMBINA="COMBINA",FUNCTION_NAMES_MATH.COS="COS",FUNCTION_NAMES_MATH.COSH="COSH",FUNCTION_NAMES_MATH.COT="COT",FUNCTION_NAMES_MATH.COTH="COTH",FUNCTION_NAMES_MATH.CSC="CSC",FUNCTION_NAMES_MATH.CSCH="CSCH",FUNCTION_NAMES_MATH.DECIMAL="DECIMAL",FUNCTION_NAMES_MATH.DEGREES="DEGREES",FUNCTION_NAMES_MATH.EVEN="EVEN",FUNCTION_NAMES_MATH.EXP="EXP",FUNCTION_NAMES_MATH.FACT="FACT",FUNCTION_NAMES_MATH.FACTDOUBLE="FACTDOUBLE",FUNCTION_NAMES_MATH.FLOOR="FLOOR",FUNCTION_NAMES_MATH.FLOOR_MATH="FLOOR.MATH",FUNCTION_NAMES_MATH.FLOOR_PRECISE="FLOOR.PRECISE",FUNCTION_NAMES_MATH.GCD="GCD",FUNCTION_NAMES_MATH.INT="INT",FUNCTION_NAMES_MATH.ISO_CEILING="ISO.CEILING",FUNCTION_NAMES_MATH.LCM="LCM",FUNCTION_NAMES_MATH.LET="LET",FUNCTION_NAMES_MATH.LN="LN",FUNCTION_NAMES_MATH.LOG="LOG",FUNCTION_NAMES_MATH.LOG10="LOG10",FUNCTION_NAMES_MATH.MDETERM="MDETERM",FUNCTION_NAMES_MATH.MINVERSE="MINVERSE",FUNCTION_NAMES_MATH.MMULT="MMULT",FUNCTION_NAMES_MATH.MOD="MOD",FUNCTION_NAMES_MATH.MROUND="MROUND",FUNCTION_NAMES_MATH.MULTINOMIAL="MULTINOMIAL",FUNCTION_NAMES_MATH.MUNIT="MUNIT",FUNCTION_NAMES_MATH.ODD="ODD",FUNCTION_NAMES_MATH.PI="PI",FUNCTION_NAMES_MATH.POWER="POWER",FUNCTION_NAMES_MATH.PRODUCT="PRODUCT",FUNCTION_NAMES_MATH.QUOTIENT="QUOTIENT",FUNCTION_NAMES_MATH.RADIANS="RADIANS",FUNCTION_NAMES_MATH.RAND="RAND",FUNCTION_NAMES_MATH.RANDARRAY="RANDARRAY",FUNCTION_NAMES_MATH.RANDBETWEEN="RANDBETWEEN",FUNCTION_NAMES_MATH.ROMAN="ROMAN",FUNCTION_NAMES_MATH.ROUND="ROUND",FUNCTION_NAMES_MATH.ROUNDBANK="ROUNDBANK",FUNCTION_NAMES_MATH.ROUNDDOWN="ROUNDDOWN",FUNCTION_NAMES_MATH.ROUNDUP="ROUNDUP",FUNCTION_NAMES_MATH.SEC="SEC",FUNCTION_NAMES_MATH.SECH="SECH",FUNCTION_NAMES_MATH.SERIESSUM="SERIESSUM",FUNCTION_NAMES_MATH.SEQUENCE="SEQUENCE",FUNCTION_NAMES_MATH.SIGN="SIGN",FUNCTION_NAMES_MATH.SIN="SIN",FUNCTION_NAMES_MATH.SINH="SINH",FUNCTION_NAMES_MATH.SQRT="SQRT",FUNCTION_NAMES_MATH.SQRTPI="SQRTPI",FUNCTION_NAMES_MATH.SUBTOTAL="SUBTOTAL",FUNCTION_NAMES_MATH.SUM="SUM",FUNCTION_NAMES_MATH.SUMIF="SUMIF",FUNCTION_NAMES_MATH.SUMIFS="SUMIFS",FUNCTION_NAMES_MATH.SUMPRODUCT="SUMPRODUCT",FUNCTION_NAMES_MATH.SUMSQ="SUMSQ",FUNCTION_NAMES_MATH.SUMX2MY2="SUMX2MY2",FUNCTION_NAMES_MATH.SUMX2PY2="SUMX2PY2",FUNCTION_NAMES_MATH.SUMXMY2="SUMXMY2",FUNCTION_NAMES_MATH.TAN="TAN",FUNCTION_NAMES_MATH.TANH="TANH",FUNCTION_NAMES_MATH.TRUNC="TRUNC",FUNCTION_NAMES_MATH}({}),FUNCTION_NAMES_TEXT=function(FUNCTION_NAMES_TEXT){return FUNCTION_NAMES_TEXT.ASC="ASC",FUNCTION_NAMES_TEXT.ARRAYTOTEXT="ARRAYTOTEXT",FUNCTION_NAMES_TEXT.BAHTTEXT="BAHTTEXT",FUNCTION_NAMES_TEXT.CHAR="CHAR",FUNCTION_NAMES_TEXT.CLEAN="CLEAN",FUNCTION_NAMES_TEXT.CODE="CODE",FUNCTION_NAMES_TEXT.CONCAT="CONCAT",FUNCTION_NAMES_TEXT.CONCATENATE="CONCATENATE",FUNCTION_NAMES_TEXT.DBCS="DBCS",FUNCTION_NAMES_TEXT.DOLLAR="DOLLAR",FUNCTION_NAMES_TEXT.EXACT="EXACT",FUNCTION_NAMES_TEXT.FIND="FIND",FUNCTION_NAMES_TEXT.FINDB="FINDB",FUNCTION_NAMES_TEXT.FIXED="FIXED",FUNCTION_NAMES_TEXT.LEFT="LEFT",FUNCTION_NAMES_TEXT.LEFTB="LEFTB",FUNCTION_NAMES_TEXT.LEN="LEN",FUNCTION_NAMES_TEXT.LENB="LENB",FUNCTION_NAMES_TEXT.LOWER="LOWER",FUNCTION_NAMES_TEXT.MID="MID",FUNCTION_NAMES_TEXT.MIDB="MIDB",FUNCTION_NAMES_TEXT.NUMBERSTRING="NUMBERSTRING",FUNCTION_NAMES_TEXT.NUMBERVALUE="NUMBERVALUE",FUNCTION_NAMES_TEXT.PHONETIC="PHONETIC",FUNCTION_NAMES_TEXT.PROPER="PROPER",FUNCTION_NAMES_TEXT.REGEXEXTRACT="REGEXEXTRACT",FUNCTION_NAMES_TEXT.REGEXMATCH="REGEXMATCH",FUNCTION_NAMES_TEXT.REGEXREPLACE="REGEXREPLACE",FUNCTION_NAMES_TEXT.REPLACE="REPLACE",FUNCTION_NAMES_TEXT.REPLACEB="REPLACEB",FUNCTION_NAMES_TEXT.REPT="REPT",FUNCTION_NAMES_TEXT.RIGHT="RIGHT",FUNCTION_NAMES_TEXT.RIGHTB="RIGHTB",FUNCTION_NAMES_TEXT.SEARCH="SEARCH",FUNCTION_NAMES_TEXT.SEARCHB="SEARCHB",FUNCTION_NAMES_TEXT.SUBSTITUTE="SUBSTITUTE",FUNCTION_NAMES_TEXT.T="T",FUNCTION_NAMES_TEXT.TEXT="TEXT",FUNCTION_NAMES_TEXT.TEXTAFTER="TEXTAFTER",FUNCTION_NAMES_TEXT.TEXTBEFORE="TEXTBEFORE",FUNCTION_NAMES_TEXT.TEXTJOIN="TEXTJOIN",FUNCTION_NAMES_TEXT.TEXTSPLIT="TEXTSPLIT",FUNCTION_NAMES_TEXT.TRIM="TRIM",FUNCTION_NAMES_TEXT.UNICHAR="UNICHAR",FUNCTION_NAMES_TEXT.UNICODE="UNICODE",FUNCTION_NAMES_TEXT.UPPER="UPPER",FUNCTION_NAMES_TEXT.VALUE="VALUE",FUNCTION_NAMES_TEXT.VALUETOTEXT="VALUETOTEXT",FUNCTION_NAMES_TEXT.CALL="CALL",FUNCTION_NAMES_TEXT.EUROCONVERT="EUROCONVERT",FUNCTION_NAMES_TEXT.REGISTER_ID="REGISTER.ID",FUNCTION_NAMES_TEXT}({});function operator_node_ts_metadata(k,v){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(k,v)}class OperatorNode extends BaseAstNode{constructor(operatorString,_functionExecutor){super(operatorString),this._functionExecutor=_functionExecutor}get nodeType(){return NodeType.OPERATOR}execute(){const children=this.getChildren();this._functionExecutor.name===FUNCTION_NAMES_META.COMPARE&&this._functionExecutor.setCompareType(this.getToken());const child1=children[0],child2=children[1];let object1=child1?.getValue(),object2=child2?.getValue();const token=this.getToken();null!=object1&&null!=object2||token===operatorToken.MINUS||token===operatorToken.PLUS?(null==object1&&(object1=NullValueObject.create()),null==object2&&(object2=NullValueObject.create()),object1.isReferenceObject()&&(object1=object1.toArrayValueObject()),object2.isReferenceObject()&&(object2=object2.toArrayValueObject()),this.setValue(this._functionExecutor.calculate(object1,object2))):this.setValue(ErrorValueObject.create(error_type_ErrorType.VALUE))}}class OperatorNodeFactory extends BaseAstNodeFactory{constructor(_functionService){super(),this._functionService=_functionService}get zIndex(){return NODE_ORDER_MAP.get(NodeType.OPERATOR)||100}create(param){let functionName="";const tokenTrim=param;tokenTrim===operatorToken.PLUS?functionName=FUNCTION_NAMES_META.PLUS:tokenTrim===operatorToken.MINUS?functionName=FUNCTION_NAMES_META.MINUS:tokenTrim===operatorToken.MULTIPLY?functionName=FUNCTION_NAMES_META.MULTIPLY:tokenTrim===operatorToken.DIVIDED?functionName=FUNCTION_NAMES_META.DIVIDED:tokenTrim===operatorToken.CONCATENATE?functionName=FUNCTION_NAMES_TEXT.CONCATENATE:tokenTrim===operatorToken.POWER?functionName=FUNCTION_NAMES_MATH.POWER:OPERATOR_TOKEN_COMPARE_SET.has(tokenTrim)&&(functionName=FUNCTION_NAMES_META.COMPARE);const functionExecutor=this._functionService.getExecutor(functionName);return functionExecutor?new OperatorNode(tokenTrim,functionExecutor):(console.error(`No function ${param}`),ErrorNode.create(error_type_ErrorType.NAME))}checkAndCreateNodeType(param){if(param instanceof LexerNode)return;const tokenTrim=param.trim();return('"'!==tokenTrim.charAt(0)||'"'!==tokenTrim.charAt(tokenTrim.length-1))&&OPERATOR_TOKEN_SET.has(tokenTrim)?this.create(tokenTrim):void 0}}function reference_node_ts_metadata(k,v){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(k,v)}function reference_node_ts_param(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}}OperatorNodeFactory=function operator_node_ts_decorate(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r}([function operator_node_ts_param(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}}(0,IFunctionService),operator_node_ts_metadata("design:type",Function),operator_node_ts_metadata("design:paramtypes",[void 0===IFunctionService?Object:IFunctionService])],OperatorNodeFactory);class ReferenceNode extends BaseAstNode{constructor(_currentConfigService,_runtimeService,operatorString,_referenceObjectType,_isPrepareMerge=!1){super(operatorString),this._currentConfigService=_currentConfigService,this._runtimeService=_runtimeService,this._referenceObjectType=_referenceObjectType,this._isPrepareMerge=_isPrepareMerge,this._refOffsetX=0,this._refOffsetY=0}get nodeType(){return NodeType.REFERENCE}execute(){const currentConfigService=this._currentConfigService,runtimeService=this._runtimeService,referenceObject=function getReferenceObjectFromCache(trimToken,type){let referenceObject;switch(type){case 0:referenceObject=new CellReferenceObject(trimToken);break;case 1:referenceObject=new ColumnReferenceObject(trimToken);break;case 2:referenceObject=new RowReferenceObject(trimToken);break;default:throw new Error("Unknown reference object type")}return referenceObject}(this.getToken(),this._referenceObjectType);referenceObject.setDefaultUnitId(runtimeService.currentUnitId),referenceObject.setDefaultSheetId(runtimeService.currentSubUnitId),referenceObject.setForcedSheetId(currentConfigService.getSheetNameMap()),referenceObject.setUnitData(currentConfigService.getUnitData()),referenceObject.setArrayFormulaCellData(currentConfigService.getArrayFormulaCellData()),referenceObject.setRuntimeData(runtimeService.getUnitData()),referenceObject.setUnitStylesData(currentConfigService.getUnitStylesData()),referenceObject.setRuntimeArrayFormulaCellData(runtimeService.getRuntimeArrayFormulaCellData()),referenceObject.setRuntimeFeatureCellData(runtimeService.getRuntimeFeatureCellData());const{x,y}=this.getRefOffset();referenceObject.setRefOffset(x,y),!this._isPrepareMerge&&referenceObject.isExceedRange()?this.setValue(ErrorValueObject.create(error_type_ErrorType.NAME)):this.setValue(referenceObject)}setRefOffset(x=0,y=0){this._refOffsetX=x,this._refOffsetY=y}getRefOffset(){return{x:this._refOffsetX,y:this._refOffsetY}}}class ReferenceNodeFactory extends BaseAstNodeFactory{constructor(_currentConfigService,_formulaRuntimeService,_functionService){super(),this._currentConfigService=_currentConfigService,this._formulaRuntimeService=_formulaRuntimeService,this._functionService=_functionService}get zIndex(){return NODE_ORDER_MAP.get(NodeType.REFERENCE)||100}checkAndCreateNodeType(param){let tokenTrimPre,isLexerNode=!1,isPrepareMerge=!1;param instanceof LexerNode?(isLexerNode=!0,tokenTrimPre=param.getToken().trim(),param.getParent()?.getParent()?.getToken().trim()===token_matchToken.COLON&&(isPrepareMerge=!0)):tokenTrimPre=param.trim();const currentConfigService=this._currentConfigService,runtimeService=this._formulaRuntimeService,{tokenTrim,minusPrefixNode,atPrefixNode}=prefixHandler(tokenTrimPre,this._functionService,runtimeService);if(!isLexerNode&&'"'===tokenTrim.charAt(0)&&'"'===tokenTrim.charAt(tokenTrim.length-1))return;let node;return regexTestSingeRange(tokenTrim)?node=new ReferenceNode(currentConfigService,runtimeService,tokenTrim,ReferenceObjectType.CELL,isPrepareMerge):isLexerNode&&this._checkParentIsUnionOperator(param)&&(regexTestSingleRow(tokenTrim)?node=new ReferenceNode(currentConfigService,runtimeService,tokenTrim,ReferenceObjectType.ROW,isPrepareMerge):regexTestSingleColumn(tokenTrim)&&(node=new ReferenceNode(currentConfigService,runtimeService,tokenTrim,ReferenceObjectType.COLUMN,isPrepareMerge))),node?(atPrefixNode?node.setParent(atPrefixNode):minusPrefixNode&&node.setParent(minusPrefixNode),node):void 0}_checkParentIsUnionOperator(param){return param.getParent()?.getParent()?.getToken().trim()===token_matchToken.COLON}}function suffix_node_ts_metadata(k,v){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(k,v)}function suffix_node_ts_param(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}}ReferenceNodeFactory=function reference_node_ts_decorate(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r}([reference_node_ts_param(0,IFormulaCurrentConfigService),reference_node_ts_param(1,IFormulaRuntimeService),reference_node_ts_param(2,IFunctionService),reference_node_ts_metadata("design:type",Function),reference_node_ts_metadata("design:paramtypes",[void 0===IFormulaCurrentConfigService?Object:IFormulaCurrentConfigService,void 0===IFormulaRuntimeService?Object:IFormulaRuntimeService,void 0===IFunctionService?Object:IFunctionService])],ReferenceNodeFactory);class SuffixNode extends BaseAstNode{constructor(_currentConfigService,_lexer,_operatorString,_functionExecutor){super(_operatorString),this._currentConfigService=_currentConfigService,this._lexer=_lexer,this._operatorString=_operatorString,this._functionExecutor=_functionExecutor}get nodeType(){return NodeType.SUFFIX}execute(){let result,value=this.getChildren()[0].getValue();if(null==value)throw new Error("object is null");if(this._operatorString===suffixToken.PERCENTAGE){if(value.isReferenceObject()&&(value=value.toArrayValueObject()),result=this._functionExecutor.calculate(value,NumberValueObject.create(100)),result.isNumber()){const value=Number(result.getValue());result=NumberValueObject.create(value,"0.00%")}}else result=this._operatorString===suffixToken.POUND?this._handlerPound(value):ErrorValueObject.create(error_type_ErrorType.VALUE);this.setValue(result)}_handlerPound(value){if(!value.isReferenceObject())return ErrorValueObject.create(error_type_ErrorType.VALUE);if(!value.isCell())return ErrorValueObject.create(error_type_ErrorType.VALUE);const cellValue=value,range=cellValue.getRangePosition(),unitId=cellValue.getUnitId(),sheetId=cellValue.getSheetId(),formulaData=this._currentConfigService.getFormulaData(),formulaString=formulaData?.[unitId]?.[sheetId]?.[range.startRow]?.[range.startColumn]?.f;if(!formulaString)return ErrorValueObject.create(error_type_ErrorType.VALUE);this._lexer.treeBuilder(formulaString);return ErrorValueObject.create(error_type_ErrorType.VALUE)}}class SuffixNodeFactory extends BaseAstNodeFactory{constructor(_functionService,_lexer,_currentConfigService){super(),this._functionService=_functionService,this._lexer=_lexer,this._currentConfigService=_currentConfigService}get zIndex(){return NODE_ORDER_MAP.get(NodeType.SUFFIX)||100}checkAndCreateNodeType(param){if(!(param instanceof LexerNode))return;const tokenTrim=param.getToken().trim();if('"'===tokenTrim.charAt(0)&&'"'===tokenTrim.charAt(tokenTrim.length-1))return;let functionName="";if(tokenTrim!==suffixToken.PERCENTAGE)return tokenTrim===suffixToken.POUND?new SuffixNode(this._currentConfigService,this._lexer,tokenTrim):void 0;functionName=FUNCTION_NAMES_META.DIVIDED;const functionExecutor=this._functionService.getExecutor(functionName);return functionExecutor?new SuffixNode(this._currentConfigService,this._lexer,tokenTrim,functionExecutor):(console.error(`No function ${param}`),ErrorNode.create(error_type_ErrorType.NAME))}}function union_node_ts_metadata(k,v){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(k,v)}SuffixNodeFactory=function suffix_node_ts_decorate(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r}([suffix_node_ts_param(0,IFunctionService),suffix_node_ts_param(1,(0,src.y_5)(Lexer)),suffix_node_ts_param(2,IFormulaCurrentConfigService),suffix_node_ts_metadata("design:type",Function),suffix_node_ts_metadata("design:paramtypes",[void 0===IFunctionService?Object:IFunctionService,void 0===Lexer?Object:Lexer,void 0===IFormulaCurrentConfigService?Object:IFormulaCurrentConfigService])],SuffixNodeFactory);class UnionNode extends BaseAstNode{constructor(operatorString){super(operatorString)}get nodeType(){return NodeType.UNION}execute(){const children=this.getChildren(),leftChild=children[0],rightChild=children[1],leftNode=leftChild.getValue(),rightNode=rightChild.getValue();if(null==leftNode||null==rightNode)throw new Error("leftNode and rightNode");let result;result=this.getToken()===token_matchToken.COLON?this._unionFunction(leftNode,rightNode):ErrorValueObject.create(error_type_ErrorType.NAME),this.setValue(result)}_unionFunction(variant1,variant2){return variant1.isError()||variant2.isError()?ErrorValueObject.create(error_type_ErrorType.REF):variant1.isReferenceObject()&&variant2.isReferenceObject()?function getRangeReferenceObjectFromCache(variant1,variant2){let referenceObject=ErrorValueObject.create(error_type_ErrorType.NAME);return(variant1.isCell()&&variant2.isCell()||variant1.isRow()&&variant2.isRow()||variant1.isColumn()&&variant2.isColumn())&&(referenceObject=variant1.unionBy(variant2)),referenceObject}(variant1,variant2):ErrorValueObject.create(error_type_ErrorType.REF)}}class UnionNodeFactory extends BaseAstNodeFactory{constructor(_functionService){super(),this._functionService=_functionService}get zIndex(){return NODE_ORDER_MAP.get(NodeType.UNION)||100}create(param){return new UnionNode(param)}checkAndCreateNodeType(param){if(!(param instanceof LexerNode))return;const tokenTrim=param.getToken().trim();return'"'===tokenTrim.charAt(0)&&'"'===tokenTrim.charAt(tokenTrim.length-1)||tokenTrim!==token_matchToken.COLON?void 0:this.create(tokenTrim)}}UnionNodeFactory=function union_node_ts_decorate(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r}([function union_node_ts_param(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}}(0,IFunctionService),union_node_ts_metadata("design:type",Function),union_node_ts_metadata("design:paramtypes",[void 0===IFunctionService?Object:IFunctionService])],UnionNodeFactory);class ValueNode extends BaseAstNode{constructor(operatorString){super(operatorString)}get nodeType(){return NodeType.VALUE}execute(){this.setValue(ValueObjectFactory.create(this.getToken()))}}class ValueNodeFactory extends BaseAstNodeFactory{get zIndex(){return NODE_ORDER_MAP.get(NodeType.VALUE)||100}_checkValueNode(token){if(!Number.isNaN(Number(token)))return this.create(token);{const tokenTrim=token.trim(),startToken=tokenTrim.charAt(0),endToken=tokenTrim.charAt(tokenTrim.length-1);if(ERROR_TYPE_SET.has(tokenTrim))return this.create(tokenTrim);if('"'===startToken&&'"'===endToken)return this.create(tokenTrim);if("{"===startToken&&"}"===endToken)return this.create(tokenTrim);const tokenTrimUpper=tokenTrim.toUpperCase();if(tokenTrimUpper===BooleanValue.TRUE||tokenTrimUpper===BooleanValue.FALSE)return this.create(tokenTrimUpper)}}create(param){return new ValueNode(param)}checkAndCreateNodeType(param){if(!(param instanceof LexerNode))return this._checkValueNode(param)}}function parser_ts_metadata(k,v){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(k,v)}function parser_ts_param(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}}class AstTreeBuilder extends src.jGt{constructor(_runtimeService,_astRootNodeFactory,_functionNodeFactory,_lambdaNodeFactory,_lambdaParameterNodeFactory,_operatorNodeFactory,_prefixNodeFactory,_referenceNodeFactory,_suffixNodeFactory,_unionNodeFactory,_valueNodeFactory){super(),this._runtimeService=_runtimeService,this._astRootNodeFactory=_astRootNodeFactory,this._functionNodeFactory=_functionNodeFactory,this._lambdaNodeFactory=_lambdaNodeFactory,this._lambdaParameterNodeFactory=_lambdaParameterNodeFactory,this._operatorNodeFactory=_operatorNodeFactory,this._prefixNodeFactory=_prefixNodeFactory,this._referenceNodeFactory=_referenceNodeFactory,this._suffixNodeFactory=_suffixNodeFactory,this._unionNodeFactory=_unionNodeFactory,this._valueNodeFactory=_valueNodeFactory,this._astNodeFactoryList=[],this._initializeAstNode()}dispose(){this._astNodeFactoryList.forEach((nodeFactory=>{nodeFactory.dispose()})),this._astNodeFactoryList=[]}parse(lexerNode){const astNode=new AstRootNode("R_1"),node=this._parse(lexerNode,astNode);return lexerNode.hasDefinedNames()&&node?.setDefinedNames(lexerNode.getDefinedNames()),node}_lambdaParameterHandler(lexerNode,parent){if(null==parent.getLambdaId)return ErrorNode.create(error_type_ErrorType.VALUE);const lambdaId=parent.getLambdaId(),parentAstNode=new AstRootNode("R_1"),currentLambdaPrivacyVar=this._runtimeService.getFunctionDefinitionPrivacyVar(lambdaId);if(!currentLambdaPrivacyVar)return!1;const currentLambdaPrivacyVarKeys=[...currentLambdaPrivacyVar.keys()],children=lexerNode.getChildren(),childrenCount=children.length;for(let i=0;i<childrenCount;i++){const item=children[i];if(!(item instanceof LexerNode))return!1;{updateLambdaStatement(item,lambdaId,currentLambdaPrivacyVar),this._parse(item,parentAstNode);const valueNode=parentAstNode.getChildren()[i];null!=valueNode&&currentLambdaPrivacyVar.set(currentLambdaPrivacyVarKeys[i],valueNode)}}return parentAstNode.setParent(parent),parent}_changeLetToLambda(letLexerNode){const letChildren=letLexerNode.getChildren(),letChildrenCount=letChildren.length;if(letChildrenCount%2!=1||0===letChildrenCount)return;const newLambdaNode=new LexerNode;newLambdaNode.setToken("LAMBDA");const newLambdaParameterNode=new LexerNode;newLambdaParameterNode.setToken("L_1");const copyChildren=[...letChildren];for(let i=0;i<letChildrenCount;i++){const child=copyChildren[i];if(!(child instanceof LexerNode))return;i%2==0?child.changeToParent(newLambdaNode):child.changeToParent(newLambdaParameterNode)}newLambdaNode.addChildrenFirst(newLambdaParameterNode),newLambdaParameterNode.setParent(newLambdaNode);const parent=letLexerNode.getParent();return parent?.replaceChild(letLexerNode,newLambdaNode),newLambdaNode}_parse(lexerNode,parent){const children=lexerNode.getChildren(),childrenCount=children.length,calculateStack=[];let currentAstNode=null;const token=lexerNode.getToken().trim().toUpperCase();if("LET"===token){const resultNode=this._changeLetToLambda(lexerNode);return null!=resultNode?this._parse(resultNode,parent):ErrorNode.create(error_type_ErrorType.ERROR)}if("P_1"===token){if(currentAstNode=parent,0===childrenCount){return new NullNode("R_1").setParent(parent),currentAstNode}}else{if("L_1"===token){let resultNode=this._lambdaParameterHandler(lexerNode,parent);return!1===resultNode&&(resultNode=ErrorNode.create(error_type_ErrorType.ERROR)),resultNode}if(currentAstNode=this._checkAstNode(lexerNode),null==currentAstNode)return ErrorNode.create(error_type_ErrorType.NAME)}const firstChild=children[0];for(let i=0;i<childrenCount;i++){const item=children[i];if(isFirstChildParameter(firstChild)){if(0!==i&&i!==childrenCount-1)continue}else if(isChildRunTimeParameter(item)&&i!==childrenCount-1)continue;let astNode=null;if(item instanceof LexerNode){if("P_1"===item.getToken()&&0===item.getChildren().length){const children=item.getParent()?.getChildren();if(children&&1===children.length)return ErrorNode.create(error_type_ErrorType.NAME)}if(astNode=this._parse(item,currentAstNode),astNode===currentAstNode)continue}else astNode=this._checkAstNode(item);if(null==astNode)return ErrorNode.create(error_type_ErrorType.NAME);if(astNode=getAstNodeTopParent(astNode),null==astNode||astNode?.nodeType===NodeType.ERROR)return astNode;switch(astNode.nodeType){case NodeType.FUNCTION:{const token=astNode.getToken().trim().toUpperCase();FORCED_RECALCULATION_FUNCTION_NAME.has(token)&&astNode.setForcedCalculateFunction(),calculateStack.push(astNode);break}case NodeType.LAMBDA:case NodeType.LAMBDA_PARAMETER:calculateStack.push(astNode);break;case NodeType.OPERATOR:{const parameterNode1=calculateStack.pop(),parameterNode2=calculateStack.pop();parameterNode2&&parameterNode2.setParent(astNode),parameterNode1&&parameterNode1.setParent(astNode),calculateStack.push(astNode);break}case NodeType.REFERENCE:case NodeType.ROOT:case NodeType.UNION:case NodeType.VALUE:case NodeType.PREFIX:case NodeType.SUFFIX:calculateStack.push(astNode)}}const calculateStackCount=calculateStack.length;for(let i=0;i<calculateStackCount;i++){calculateStack[i].setParent(currentAstNode)}return currentAstNode}_checkAstNode(item){let astNode=null;const astNodeFactoryListCount=this._astNodeFactoryList.length;for(let x=0;x<astNodeFactoryListCount;x++){if(astNode=this._astNodeFactoryList[x].checkAndCreateNodeType(item),null!=astNode)break}return null==astNode?new ErrorFunctionNode:astNode}_initializeAstNode(){this._astNodeFactoryList=[this._astRootNodeFactory,this._functionNodeFactory,this._lambdaNodeFactory,this._lambdaParameterNodeFactory,this._operatorNodeFactory,this._prefixNodeFactory,this._referenceNodeFactory,this._suffixNodeFactory,this._unionNodeFactory,this._valueNodeFactory].sort(src.YRy)}}AstTreeBuilder=function parser_ts_decorate(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r}([parser_ts_param(0,IFormulaRuntimeService),parser_ts_param(1,(0,src.y_5)(AstRootNodeFactory)),parser_ts_param(2,(0,src.y_5)(FunctionNodeFactory)),parser_ts_param(3,(0,src.y_5)(LambdaNodeFactory)),parser_ts_param(4,(0,src.y_5)(LambdaParameterNodeFactory)),parser_ts_param(5,(0,src.y_5)(OperatorNodeFactory)),parser_ts_param(6,(0,src.y_5)(PrefixNodeFactory)),parser_ts_param(7,(0,src.y_5)(ReferenceNodeFactory)),parser_ts_param(8,(0,src.y_5)(SuffixNodeFactory)),parser_ts_param(9,(0,src.y_5)(UnionNodeFactory)),parser_ts_param(10,(0,src.y_5)(ValueNodeFactory)),parser_ts_metadata("design:type",Function),parser_ts_metadata("design:paramtypes",[void 0===IFormulaRuntimeService?Object:IFormulaRuntimeService,void 0===AstRootNodeFactory?Object:AstRootNodeFactory,void 0===FunctionNodeFactory?Object:FunctionNodeFactory,void 0===LambdaNodeFactory?Object:LambdaNodeFactory,void 0===LambdaParameterNodeFactory?Object:LambdaParameterNodeFactory,void 0===OperatorNodeFactory?Object:OperatorNodeFactory,void 0===PrefixNodeFactory?Object:PrefixNodeFactory,void 0===ReferenceNodeFactory?Object:ReferenceNodeFactory,void 0===SuffixNodeFactory?Object:SuffixNodeFactory,void 0===UnionNodeFactory?Object:UnionNodeFactory,void 0===ValueNodeFactory?Object:ValueNodeFactory])],AstTreeBuilder);class DependencyManagerBaseService extends src.jGt{buildDependencyTree(shouldBeBuildTrees,dependencyTrees){throw new Error("Method not implemented.")}getTreeById(treeId){throw new Error("Method not implemented.")}getAllTree(){throw new Error("Method not implemented.")}reset(){throw new Error("Method not implemented.")}addOtherFormulaDependency(unitId,sheetId,formulaId,dependencyTree){throw new Error("Method not implemented.")}removeOtherFormulaDependency(unitId,sheetId,formulaId){throw new Error("Method not implemented.")}clearOtherFormulaDependency(unitId,sheetId){throw new Error("Method not implemented.")}addFeatureFormulaDependency(unitId,sheetId,featureId,dependencyTree){throw new Error("Method not implemented.")}removeFeatureFormulaDependency(unitId,sheetId,featureIds){throw new Error("Method not implemented.")}clearFeatureFormulaDependency(unitId,sheetId){throw new Error("Method not implemented.")}addFormulaDependency(unitId,sheetId,row,column,dependencyTree){throw new Error("Method not implemented.")}removeFormulaDependency(unitId,sheetId,row,column){throw new Error("Method not implemented.")}clearFormulaDependency(unitId,sheetId){throw new Error("Method not implemented.")}removeFormulaDependencyByDefinedName(unitId,definedName){throw new Error("Method not implemented.")}searchDependency(search,exceptTreeIds){return this._dependencyRTreeCache.bulkSearch(search,exceptTreeIds)}_restDependencyTreeId(){this._dependencyTreeIdLast=0}getOtherFormulaDependency(unitId,sheetId,formulaId){return this._otherFormulaData.get(unitId)?.get(sheetId)?.get(formulaId)}addOtherFormulaDependencyMainData(formulaId){this._otherFormulaDataMainData.add(formulaId)}hasOtherFormulaDataMainData(formulaId){return this._otherFormulaDataMainData.has(formulaId)}_removeDependencyRTreeCacheById(unitId,sheetId){this._dependencyRTreeCache.removeById(unitId,sheetId)}getFeatureFormulaDependency(unitId,sheetId,featureId){return this._featureFormulaData.get(unitId)?.get(sheetId)?.get(featureId)}getFormulaDependency(unitId,sheetId,row,column){return this._formulaData.get(unitId)?.get(sheetId)?.getValue(row,column)}addDependencyRTreeCache(tree){const searchRanges=[];for(let i=0;i<tree.rangeList.length;i++){const unitRangeWithNum=tree.rangeList[i],{unitId,sheetId,range}=unitRangeWithNum;searchRanges.push({unitId,sheetId,range,id:tree.treeId})}this._dependencyRTreeCache.bulkInsert(searchRanges),this._addAllTreeMap(tree)}getLastTreeId(){const id=this._dependencyTreeIdLast;return this._dependencyTreeIdLast++,id}_addAllTreeMap(tree){throw new Error("Method not implemented.")}_addDefinedName(unitId,definedName,treeId){this._definedNameMap.has(unitId)||this._definedNameMap.set(unitId,new Map);const unitMap=this._definedNameMap.get(unitId);unitMap.has(definedName)||unitMap.set(definedName,new Set);unitMap.get(definedName).add(treeId)}addFormulaDependencyByDefinedName(tree,node){const treeId=tree.treeId,definedNames=node?.getDefinedNames()||[];for(const definedName of definedNames)this._addDefinedName(tree.unitId,definedName,treeId)}constructor(...args){super(...args),this._otherFormulaData=new Map,this._featureFormulaData=new Map,this._formulaData=new Map,this._definedNameMap=new Map,this._otherFormulaDataMainData=new Set,this._dependencyRTreeCache=new src.hm5,this._dependencyTreeIdLast=0}}class DependencyManagerService extends DependencyManagerBaseService{dispose(){super.dispose(),this.reset()}buildDependencyTree(shouldBeBuildTrees,dependencyTrees=[]){const allTrees=this.getAllTree();return 0===shouldBeBuildTrees.length?(this._buildReverseDependency(allTrees,dependencyTrees),allTrees):(this._buildDependencyTree(allTrees,shouldBeBuildTrees),this._buildReverseDependency(allTrees,shouldBeBuildTrees),allTrees)}_buildDependencyTree(allTrees,shouldBeBuildTrees){const shouldBeBuildTreeMap=new Map;for(let i=0;i<shouldBeBuildTrees.length;i++){const tree=shouldBeBuildTrees[i];shouldBeBuildTreeMap.set(tree.treeId,tree)}for(let i=0;i<allTrees.length;i++){const tree=allTrees[i],RTreeItem=tree.toRTreeItem(),searchResults=this._dependencyRTreeCache.bulkSearch(RTreeItem);for(const id of searchResults){const shouldBeBuildTree=shouldBeBuildTreeMap.get(id);shouldBeBuildTree&&tree!==shouldBeBuildTree&&!shouldBeBuildTree.hasChildren(tree.treeId)&&shouldBeBuildTree.pushChildren(tree)}}shouldBeBuildTreeMap.clear()}_buildReverseDependency(allTrees,dependencyTrees){const allTreeMap=new Map;for(let i=0;i<allTrees.length;i++){const tree=allTrees[i];allTreeMap.set(tree.treeId,tree)}for(let i=0;i<dependencyTrees.length;i++){const tree=dependencyTrees[i],RTreeItem=tree.toRTreeItem(),searchResults=this._dependencyRTreeCache.bulkSearch(RTreeItem);for(const id of searchResults){const allTree=allTreeMap.get(id);allTree&&tree!==allTree&&!allTree.hasChildren(tree.treeId)&&allTree.pushChildren(tree)}}allTreeMap.clear()}getAllTree(){const trees=[];return this._allTreeMap.forEach((tree=>{tree.resetState(),trees.push(tree)})),trees}getTreeById(treeId){return this._allTreeMap.get(treeId)}reset(){this._otherFormulaData.clear(),this._featureFormulaData.clear(),this._formulaData.clear(),this._definedNameMap.clear(),this._otherFormulaDataMainData.clear(),this._dependencyRTreeCache.clear(),this._allTreeMap.clear(),this._restDependencyTreeId()}addOtherFormulaDependency(unitId,sheetId,formulaId,dependencyTree){this._otherFormulaData.has(unitId)||this._otherFormulaData.set(unitId,new Map);const unitMap=this._otherFormulaData.get(unitId);unitMap.has(sheetId)||unitMap.set(sheetId,new Map);const sheetMap=unitMap.get(sheetId);sheetMap.has(formulaId)||sheetMap.set(formulaId,new src.hDc);sheetMap.get(formulaId).setValue(dependencyTree.refOffsetX,dependencyTree.refOffsetY,dependencyTree.treeId),this._addAllTreeMap(dependencyTree)}removeOtherFormulaDependency(unitId,sheetId,formulaIds){const unitMap=this._otherFormulaData.get(unitId);if(unitMap&&unitMap.has(sheetId)){const sheetMap=unitMap.get(sheetId);formulaIds.forEach((formulaId=>{const treeSet=sheetMap.get(formulaId);null!=treeSet&&(treeSet.forValue(((row,column,treeId)=>{this._removeDependencyRTreeCache(treeId),this.clearDependencyForTree(this._allTreeMap.get(treeId)),this._removeAllTreeMap(treeId)})),sheetMap.delete(formulaId),this._otherFormulaDataMainData.delete(formulaId))})),0===sheetMap.size&&unitMap.delete(sheetId),0===unitMap.size&&this._otherFormulaData.delete(unitId)}}clearOtherFormulaDependency(unitId,sheetId){const unitMap=this._otherFormulaData.get(unitId);if(sheetId&&unitMap&&unitMap.has(sheetId)){const sheetMap=unitMap.get(sheetId);this._removeDependencyRTreeCacheById(unitId,sheetId);for(const formulaId of sheetMap.keys()){const formulaTreeSet=sheetMap.get(formulaId);null!=formulaTreeSet&&(formulaTreeSet.forValue(((row,column,treeId)=>{const tree=this._allTreeMap.get(treeId);tree&&(this.clearDependencyForTree(tree),this._removeAllTreeMap(treeId))})),this._otherFormulaDataMainData.delete(formulaId))}sheetMap.clear()}else if(unitMap){for(const sheetId of unitMap.keys()){const sheetMap=unitMap.get(sheetId);this._removeDependencyRTreeCacheById(unitId,sheetId);for(const formulaId of sheetMap.keys()){const formulaTreeSet=sheetMap.get(formulaId);null!=formulaTreeSet&&(formulaTreeSet.forValue(((row,column,treeId)=>{const tree=this._allTreeMap.get(treeId);tree&&(this.clearDependencyForTree(tree),this._removeAllTreeMap(treeId))})),this._otherFormulaDataMainData.delete(formulaId))}}this._otherFormulaData.delete(unitId)}}addFeatureFormulaDependency(unitId,sheetId,featureId,dependencyTree){this._featureFormulaData.has(unitId)||this._featureFormulaData.set(unitId,new Map);const unitMap=this._featureFormulaData.get(unitId);unitMap.has(sheetId)||unitMap.set(sheetId,new Map);unitMap.get(sheetId).set(featureId,dependencyTree.treeId),this._addAllTreeMap(dependencyTree)}removeFeatureFormulaDependency(unitId,sheetId,featureIds){const unitMap=this._featureFormulaData.get(unitId);if(unitMap&&unitMap.has(sheetId)){const sheetMap=unitMap.get(sheetId);featureIds.forEach((featureId=>{const deleteTreeId=sheetMap.get(featureId);null!=deleteTreeId&&(this._removeDependencyRTreeCache(deleteTreeId),sheetMap.delete(featureId),this.clearDependencyForTree(this._allTreeMap.get(deleteTreeId)),this._removeAllTreeMap(deleteTreeId))}))}}clearFeatureFormulaDependency(unitId,sheetId){const unitMap=this._featureFormulaData.get(unitId);if(sheetId&&unitMap&&unitMap.has(sheetId)){const sheetMap=unitMap.get(sheetId);this._removeDependencyRTreeCacheById(unitId,sheetId),sheetMap.forEach((featureTreeId=>{null!=featureTreeId&&(this.clearDependencyForTree(this._allTreeMap.get(featureTreeId)),this._removeAllTreeMap(featureTreeId))})),sheetMap.clear()}else unitMap&&(unitMap.forEach(((sheetMap,sheetId)=>{this._removeDependencyRTreeCacheById(unitId,sheetId),sheetMap.forEach((featureTreeId=>{null!=featureTreeId&&(this.clearDependencyForTree(this._allTreeMap.get(featureTreeId)),this._removeAllTreeMap(featureTreeId))}))})),this._featureFormulaData.delete(unitId))}addFormulaDependency(unitId,sheetId,row,column,dependencyTree){this._formulaData.has(unitId)||this._formulaData.set(unitId,new Map);const unitMap=this._formulaData.get(unitId);unitMap.has(sheetId)||unitMap.set(sheetId,new src.hDc);unitMap.get(sheetId).setValue(row,column,dependencyTree.treeId),this._addAllTreeMap(dependencyTree)}removeFormulaDependency(unitId,sheetId,row,column){const unitMap=this._formulaData.get(unitId);if(unitMap&&unitMap.has(sheetId)){const sheetMatrix=unitMap.get(sheetId),deleteTreeId=sheetMatrix.getValue(row,column);if(null==deleteTreeId)return;this._removeDependencyRTreeCache(deleteTreeId),sheetMatrix.realDeleteValue(row,column),this.clearDependencyForTree(this._allTreeMap.get(deleteTreeId)),this._removeAllTreeMap(deleteTreeId)}}clearFormulaDependency(unitId,sheetId){const unitMap=this._formulaData.get(unitId);if(sheetId&&unitMap&&unitMap.has(sheetId)){const sheetMatrix=unitMap.get(sheetId);this._removeDependencyRTreeCacheById(unitId,sheetId),sheetMatrix.forValue(((row,column,treeId)=>{if(null==treeId)return!0;this.clearDependencyForTree(this._allTreeMap.get(treeId)),this._removeAllTreeMap(treeId)})),sheetMatrix.reset()}else unitMap&&(unitMap.forEach(((sheetMatrix,sheetId)=>{this._removeDependencyRTreeCacheById(unitId,sheetId),sheetMatrix.forValue(((row,column,treeId)=>{if(null==treeId)return!0;this.clearDependencyForTree(this._allTreeMap.get(treeId)),this._removeAllTreeMap(treeId)}))})),this._formulaData.delete(unitId))}clearDependencyForTree(shouldBeClearTree){if(null==shouldBeClearTree)return;const parents=shouldBeClearTree.parents,children=shouldBeClearTree.children,allTreeMap=this._allTreeMap;for(const parentTreeId of parents){const parent=allTreeMap.get(parentTreeId);parent?.children.delete(shouldBeClearTree.treeId)}for(const childTreeId of children){const child=allTreeMap.get(childTreeId);child?.parents.delete(shouldBeClearTree.treeId)}shouldBeClearTree.dispose()}_removeDependencyRTreeCache(treeId){if(null==treeId)return;const treeRangeMap=this._allTreeMap.get(treeId);if(treeRangeMap){const searchRanges=[];for(let i=0;i<treeRangeMap.rangeList.length;i++){const unitRangeWithNum=treeRangeMap.rangeList[i],{unitId,sheetId,range}=unitRangeWithNum;searchRanges.push({unitId,sheetId,range,id:treeId})}this._dependencyRTreeCache.bulkRemove(searchRanges)}}removeFormulaDependencyByDefinedName(unitId,definedName){const unitMap=this._definedNameMap.get(unitId);if(unitMap){const treeSet=unitMap.get(definedName);if(treeSet){for(const treeId of treeSet)this._removeDependencyRTreeCache(treeId),this.clearDependencyForTree(this._allTreeMap.get(treeId)),this._removeAllTreeMap(treeId);treeSet.clear()}}}_removeAllTreeMap(treeId){null!=treeId&&this._allTreeMap.delete(treeId)}_addAllTreeMap(tree){this._allTreeMap.set(tree.treeId,tree)}constructor(...args){super(...args),this._allTreeMap=new Map}}const IDependencyManagerService=(0,src.Qmd)("univer.formula.dependency-manager.service");class FeatureCalculationManagerService extends src.jGt{dispose(){super.dispose(),this._referenceExecutorMap.clear(),this._onChanged$.complete()}remove(unitId,subUnitId,featureIds){featureIds.forEach((featureId=>{this._referenceExecutorMap.get(unitId)?.get(subUnitId)?.delete(featureId)})),this._onChanged$.next({unitId,subUnitId,featureIds})}get(unitId,subUnitId,featureId){return this._referenceExecutorMap.get(unitId)?.get(subUnitId)?.get(featureId)}has(unitId,subUnitId,featureId){return Boolean(this._referenceExecutorMap.get(unitId)?.get(subUnitId)?.has(featureId))}register(unitId,subUnitId,featureId,referenceExecutor){let unitMap=this._referenceExecutorMap.get(unitId);unitMap||(unitMap=new Map,this._referenceExecutorMap.set(unitId,unitMap));let subUnitMap=unitMap.get(subUnitId);subUnitMap||(subUnitMap=new Map,unitMap.set(subUnitId,subUnitMap)),this._onChanged$.next({unitId,subUnitId,featureIds:[featureId]}),subUnitMap.set(featureId,referenceExecutor)}getReferenceExecutorMap(){return this._referenceExecutorMap}constructor(...args){super(...args),this._referenceExecutorMap=new Map,this._onChanged$=new Subject.B,this.onChanged$=this._onChanged$.asObservable()}}const IFeatureCalculationManagerService=(0,src.Qmd)("univer.formula.feature-calculation-manager.service");class OtherFormulaManagerService extends src.jGt{dispose(){super.dispose(),this._otherFormulaData={}}remove(searchParam){const{unitId,subUnitId,formulaId}=searchParam;delete this._otherFormulaData?.[unitId]?.[subUnitId]?.[formulaId]}get(searchParam){const{unitId,subUnitId,formulaId}=searchParam;return this._otherFormulaData[unitId]?.[subUnitId]?.[formulaId]}has(searchParam){const{unitId,subUnitId,formulaId}=searchParam;return null!=this._otherFormulaData[unitId]?.[subUnitId]?.[formulaId]}register(insertParam){const{unitId,subUnitId,formulaId,item}=insertParam;this._otherFormulaData[unitId]||(this._otherFormulaData[unitId]={}),this._otherFormulaData[unitId][subUnitId]||(this._otherFormulaData[unitId][subUnitId]={}),this._otherFormulaData[unitId][subUnitId][formulaId]=item}batchRegister(formulaData){Object.keys(formulaData).forEach((unitId=>{const subUnits=formulaData[unitId];if(null==subUnits)return!0;Object.keys(subUnits).forEach((subUnitId=>{const subUnit=subUnits[subUnitId];if(null==subUnit)return!0;Object.keys(subUnit).forEach((formulaId=>{const item=subUnit[formulaId];if(null==item)return!0;this.register({unitId,subUnitId,formulaId,item})}))}))}))}batchRemove(formulaData){Object.keys(formulaData).forEach((unitId=>{const subUnits=formulaData[unitId];if(null==subUnits)return!0;Object.keys(subUnits).forEach((subUnitId=>{const subUnit=subUnits[subUnitId];if(null==subUnit)return!0;Object.keys(subUnit).forEach((formulaId=>{this.remove({unitId,subUnitId,formulaId})}))}))}))}getOtherFormulaData(){return this._otherFormulaData}constructor(...args){super(...args),this._otherFormulaData={}}}const IOtherFormulaManagerService=(0,src.Qmd)("univer.formula.other-formula-manager.service");var FormulaDependencyTreeType=function(FormulaDependencyTreeType){return FormulaDependencyTreeType[FormulaDependencyTreeType.NORMAL_FORMULA=0]="NORMAL_FORMULA",FormulaDependencyTreeType[FormulaDependencyTreeType.OTHER_FORMULA=1]="OTHER_FORMULA",FormulaDependencyTreeType[FormulaDependencyTreeType.FEATURE_FORMULA=2]="FEATURE_FORMULA",FormulaDependencyTreeType}({});class FormulaDependencyTreeCalculator{resetState(){this._state=0}setAdded(){this._state=1}isAdded(){return 1===this._state}setSkip(){this._state=2}isSkip(){return 2===this._state}pushChildren(tree){this.children.add(tree.treeId),tree._pushParent(this)}hasChildren(treeId){return this.children.has(treeId)}_pushParent(tree){this.parents.add(tree.treeId)}constructor(){this._state=0,this.children=new Set,this.parents=new Set}}class FormulaDependencyTreeVirtual extends FormulaDependencyTreeCalculator{get isVirtual(){return!0}get row(){return null==this.refTree?-1:this.refTree.row+this.refOffsetY}get column(){return null==this.refTree?-1:this.refTree.column+this.refOffsetX}get rowCount(){return null==this.refTree?0:this.refTree.rowCount}get columnCount(){return null==this.refTree?0:this.refTree.columnCount}get unitId(){return null==this.refTree?"":this.refTree.unitId}get subUnitId(){return null==this.refTree?"":this.refTree.subUnitId}get formula(){return this.refTree?.formula??""}get nodeData(){return{node:this.node,refOffsetX:this.refOffsetX,refOffsetY:this.refOffsetY}}get node(){return this.refTree?.node}dispose(){this.refTree=null}get rangeList(){const unitRangeList=[];if(null==this.refTree)return[];for(let i=0;i<this.refTree.rangeList.length;i++){const range=this.refTree.rangeList[i];unitRangeList.push({unitId:range.unitId,sheetId:range.sheetId,range:(0,src.ZTS)(range.range,this.refOffsetX,this.refOffsetY)})}return unitRangeList}toRTreeItem(){const currentRow=this.row,currentColumn=this.column;return[{unitId:this.unitId,sheetId:this.subUnitId,range:{startRow:currentRow,startColumn:currentColumn,endRow:currentRow,endColumn:currentColumn}}]}inRangeData(range){const startRow=range.startRow,startColumn=range.startColumn,endRow=range.endRow,endColumn=range.endColumn,currentRow=this.row,currentColumn=this.column;return!(currentRow<startRow||currentRow>endRow||currentColumn<startColumn||currentColumn>endColumn)}dependencySheetName(dirtyUnitSheetNameMap){return null!=this.refTree&&this.refTree.dependencySheetName(dirtyUnitSheetNameMap)}isExcludeRange(unitExcludedCell){const rangeList=this.rangeList;if(0===rangeList.length)return!1;for(let r=0,len=rangeList.length;r<len;r++){const unitRange=rangeList[r],{unitId,sheetId,range}=unitRange,excludedCell=unitExcludedCell?.[unitId]?.[sheetId];let{startRow:rangeStartRow,endRow:rangeEndRow,startColumn:rangeStartColumn,endColumn:rangeEndColumn}=range;Number.isNaN(rangeStartRow)&&(rangeStartRow=0),Number.isNaN(rangeStartColumn)&&(rangeStartColumn=0),Number.isNaN(rangeEndRow)&&(rangeEndRow=Number.POSITIVE_INFINITY),Number.isNaN(rangeEndColumn)&&(rangeEndColumn=Number.POSITIVE_INFINITY);let isInclude=!1;if(excludedCell?.forValue(((row,column)=>{if(row>=rangeStartRow&&row<=rangeEndRow&&column>=rangeStartColumn&&column<=rangeEndColumn)return isInclude=!0,!1})),isInclude)return!0}return!1}get formulaId(){return null==this.refTree?"":this.refTree.formulaId}constructor(...args){super(...args),this.refOffsetX=-1,this.refOffsetY=-1,this.isCache=!1,this.isDirty=!1,this.addressFunctionNodes=[]}}class FormulaDependencyTree extends FormulaDependencyTreeCalculator{constructor(treeId){super(),this.isCache=!1,this.featureDirtyRanges=[],this.refOffsetX=0,this.refOffsetY=0,this.type=0,this.subUnitId="",this.unitId="",this.rangeList=[],this.formula="",this.row=-1,this.column=-1,this.rowCount=Number.NEGATIVE_INFINITY,this.columnCount=Number.NEGATIVE_INFINITY,this.isDirty=!1,this.addressFunctionNodes=[],this.treeId=treeId}get isVirtual(){return!1}get nodeData(){return{node:this.node,refOffsetX:0,refOffsetY:0}}toJson(){return{formula:this.formula,refOffsetX:this.refOffsetX,refOffsetY:this.refOffsetY}}dispose(){this.featureDirtyRanges=[],this.rangeList=[],this.addressFunctionNodes=[],this.getDirtyData=null}inRangeData(range){const startRow=range.startRow,startColumn=range.startColumn,endRow=range.endRow,endColumn=range.endColumn,currentRow=this.row,currentColumn=this.column;return!(currentRow<startRow||currentRow>endRow||currentColumn<startColumn||currentColumn>endColumn)}dependencySheetName(dirtyUnitSheetNameMap){const rangeList=this.rangeList;if(0===rangeList.length||null==dirtyUnitSheetNameMap)return!1;for(let r=0,len=rangeList.length;r<len;r++){const unitRange=rangeList[r],{unitId,sheetId}=unitRange;if(null!=dirtyUnitSheetNameMap[unitId]?.[sheetId])return!0}return!1}isExcludeRange(unitExcludedCell){const rangeList=this.rangeList;if(0===rangeList.length)return!1;for(let r=0,len=rangeList.length;r<len;r++){const unitRange=rangeList[r],{unitId,sheetId,range}=unitRange,excludedCell=unitExcludedCell?.[unitId]?.[sheetId];let{startRow:rangeStartRow,endRow:rangeEndRow,startColumn:rangeStartColumn,endColumn:rangeEndColumn}=range;Number.isNaN(rangeStartRow)&&(rangeStartRow=0),Number.isNaN(rangeStartColumn)&&(rangeStartColumn=0),Number.isNaN(rangeEndRow)&&(rangeEndRow=Number.POSITIVE_INFINITY),Number.isNaN(rangeEndColumn)&&(rangeEndColumn=Number.POSITIVE_INFINITY);let isInclude=!1;if(excludedCell?.forValue(((row,column)=>{if(row>=rangeStartRow&&row<=rangeEndRow&&column>=rangeStartColumn&&column<=rangeEndColumn)return isInclude=!0,!1})),isInclude)return!0}return!1}pushRangeList(ranges){this.rangeList.push(...ranges)}shouldBePushRangeList(){return 0===this.rangeList.length&&2!==this.type}toRTreeItem(){if(null!=this.featureId)return this.featureDirtyRanges;const currentRow=this.row,currentColumn=this.column;return[{unitId:this.unitId,sheetId:this.subUnitId,range:{startRow:currentRow,startColumn:currentColumn,endRow:currentRow,endColumn:currentColumn}}]}}function formula_dependency_ts_metadata(k,v){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(k,v)}function formula_dependency_ts_param(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}}function generateRandomDependencyTreeId(dependencyManagerService){return dependencyManagerService.getLastTreeId()||0}const IFormulaDependencyGenerator=(0,src.Qmd)("engine-formula.dependency-generator");class FormulaDependencyGenerator extends src.jGt{constructor(_currentConfigService,_runtimeService,_otherFormulaManagerService,_featureCalculationManagerService,_interpreter,_astTreeBuilder,_lexer,_dependencyManagerService){super(),this._currentConfigService=_currentConfigService,this._runtimeService=_runtimeService,this._otherFormulaManagerService=_otherFormulaManagerService,this._featureCalculationManagerService=_featureCalculationManagerService,this._interpreter=_interpreter,this._astTreeBuilder=_astTreeBuilder,this._lexer=_lexer,this._dependencyManagerService=_dependencyManagerService,this._updateRangeFlattenCache=new Map,this._dependencyRTreeCacheForAddressFunction=new src.hm5,this._executedAddressFunctionNodeIds=new Set}dispose(){this._updateRangeFlattenCache.clear(),this._dependencyRTreeCacheForAddressFunction.clear(),FORMULA_AST_CACHE.clear()}async generate(){this._updateRangeFlatten();const formulaData=this._currentConfigService.getFormulaData(),otherFormulaData=this._otherFormulaManagerService.getOtherFormulaData(),clearDependencyTreeCache=this._currentConfigService.getClearDependencyTreeCache();null!=clearDependencyTreeCache&&Object.keys(clearDependencyTreeCache).forEach((unitId=>{null!=unitId&&Object.keys(clearDependencyTreeCache[unitId]).forEach((subUnitId=>{null!=subUnitId&&(this._dependencyManagerService.clearOtherFormulaDependency(unitId,subUnitId),this._dependencyManagerService.clearFeatureFormulaDependency(unitId,subUnitId),this._dependencyManagerService.clearFormulaDependency(unitId,subUnitId))}))}));const unitData=this._currentConfigService.getUnitData(),treeList=await this._generateTreeList(formulaData,otherFormulaData,unitData),updateTreeList=this._getUpdateTreeListAndMakeDependency(treeList);let finalTreeList=this._calculateRunList(updateTreeList);this._dependencyFeatureCalculation(finalTreeList)&&(finalTreeList.forEach((tree=>{tree.resetState()})),finalTreeList=this._calculateRunList(finalTreeList));return this._checkIsCycleDependency(finalTreeList)&&this._runtimeService.enableCycleDependency(),this._dependencyRTreeCacheForAddressFunction.clear(),Promise.resolve(finalTreeList)}_dependencyFeatureCalculation(newTreeList){const featureMap=this._featureCalculationManagerService.getReferenceExecutorMap();if(0===featureMap.size)return;this._clearFeatureCalculationNode(newTreeList);let hasFeatureCalculation=!1;return featureMap.forEach(((subUnitMap,_)=>{subUnitMap.forEach(((featureMap,_)=>{featureMap.forEach(((params,featureId)=>{const{unitId,subUnitId,getDirtyData}=params,allDependency=getDirtyData(this._currentConfigService.getDirtyData(),this._runtimeService.getAllRuntimeData()),dirtyRanges=this._convertDirtyRangesToUnitRange(allDependency.dirtyRanges),intersectTrees=this._intersectFeatureCalculation(dirtyRanges,newTreeList,{unitId,subUnitId,featureId});if(intersectTrees.length>0){let featureTree=this._getExistTreeList({unitId,subUnitId,featureId},newTreeList);null==featureTree&&(featureTree=this._getFeatureFormulaTree(featureId,generateRandomDependencyTreeId(this._dependencyManagerService),params),newTreeList.push(featureTree)),featureTree.parents=new Set,intersectTrees.forEach((tree=>{tree.hasChildren(featureTree.treeId)||tree.pushChildren(featureTree)})),hasFeatureCalculation=!0}}))}))})),hasFeatureCalculation}_clearFeatureCalculationNode(newTreeList){const featureMap=this._featureCalculationManagerService.getReferenceExecutorMap();newTreeList.forEach((tree=>{const newChildren=new Set;for(const childTreeId of tree.children){const child=this._dependencyManagerService.getTreeById(childTreeId);child&&(child.featureId&&featureMap.get(tree.unitId)?.get(tree.subUnitId)?.has(child.featureId)||newChildren.add(childTreeId))}tree.children=newChildren;const newParents=new Set;for(const parentTreeId of tree.parents){const parent=this._dependencyManagerService.getTreeById(parentTreeId);parent&&(parent.featureId&&featureMap.get(tree.unitId)?.get(tree.subUnitId)?.has(parent.featureId)||newParents.add(parentTreeId))}tree.parents=newParents}))}_convertDirtyRangesToUnitRange(dirtyRanges){const unitRange=[];for(const unitId in dirtyRanges){const unitMap=dirtyRanges[unitId];for(const subUnitId in unitMap){const ranges=unitMap[subUnitId];for(const range of ranges)unitRange.push({unitId,sheetId:subUnitId,range})}}return unitRange}_intersectFeatureCalculation(dirtyRanges,newTreeList,param){const dependencyTree=[],treeIds=this._dependencyManagerService.searchDependency(dirtyRanges);for(let i=0,len=newTreeList.length;i<len;i++){const tree=newTreeList[i];if(tree.unitId===param.unitId&&tree.subUnitId===param.subUnitId&&tree.featureId===param.featureId)continue;treeIds.has(tree.treeId)&&dependencyTree.push(tree)}return dependencyTree}_getExistTreeList(param,treeList){const{unitId,subUnitId,featureId}=param;for(let i=0,len=treeList.length;i<len;i++){const tree=treeList[i];if(tree.unitId===unitId&&tree.subUnitId===subUnitId&&tree.featureId===featureId)return tree}}_isCyclicUtil(treeId,visited,recursionStack){const node=this._dependencyManagerService.getTreeById(treeId);if(null==node)return!1;if(!visited.has(node.treeId)){visited.add(node.treeId),recursionStack.add(node.treeId);for(const childTreeId of node.children){if(!visited.has(childTreeId)&&this._isCyclicUtil(childTreeId,visited,recursionStack))return!0;if(recursionStack.has(childTreeId))return!0}}return recursionStack.delete(node.treeId),!1}_checkIsCycleDependency(treeList){const visited=new Set,recursionStack=new Set;for(let i=0,len=treeList.length;i<len;i++){const tree=treeList[i];if(!0===this._isCyclicUtil(tree.treeId,visited,recursionStack))return!0}return!1}async _generateTreeList(formulaData,otherFormulaData,unitData){const formulaDataKeys=Object.keys(formulaData),otherFormulaDataKeys=Object.keys(otherFormulaData),treeList=[];this._currentConfigService.isForceCalculate()&&this._dependencyManagerService.reset(),this._registerFormulas(formulaDataKeys,formulaData,unitData,treeList),this._registerOtherFormulas(otherFormulaData,otherFormulaDataKeys,treeList),this._registerFeatureFormulas(treeList);for(let i=0,len=treeList.length;i<len;i++){const tree=treeList[i];if(!tree.formula)continue;const node=this._getTreeNode(tree);tree.isDirty=this._includeTree(tree,node);const addressFunctionNodes=this._getAddressFunctionNodeList(node);if(addressFunctionNodes.length>0&&(tree.addressFunctionNodes=addressFunctionNodes),tree.isVirtual)continue;this._runtimeService.setCurrent(tree.row,tree.column,tree.rowCount,tree.columnCount,tree.subUnitId,tree.unitId);const rangeList=await this._getRangeListByNode({node,refOffsetX:tree.refOffsetX,refOffsetY:tree.refOffsetY});tree.pushRangeList(rangeList)}for(let i=0,len=treeList.length;i<len;i++){const tree=treeList[i];tree.isCache||this._dependencyManagerService.addDependencyRTreeCache(tree)}return await this._calculateListByFunctionRefNode(treeList),treeList}_registerFeatureFormulas(treeList){this._featureCalculationManagerService.getReferenceExecutorMap().forEach(((subUnitMap,_)=>{subUnitMap.forEach(((featureMap,_)=>{featureMap.forEach(((params,featureId)=>{const treeId=this._dependencyManagerService.getFeatureFormulaDependency(params.unitId,params.subUnitId,featureId);treeList.push(this._getFeatureFormulaTree(featureId,treeId,params))}))}))}))}_getFeatureFormulaTree(featureId,treeId,params){const{unitId,subUnitId,dependencyRanges,getDirtyData}=params,treeIdNum=treeId||generateRandomDependencyTreeId(this._dependencyManagerService),FDtree=new FormulaDependencyTree(treeIdNum);FDtree.unitId=unitId,FDtree.subUnitId=subUnitId,FDtree.rangeList=dependencyRanges,FDtree.getDirtyData=getDirtyData;const allDependency=getDirtyData(this._currentConfigService.getDirtyData(),this._runtimeService.getAllRuntimeData()),dirtyRanges=this._convertDirtyRangesToUnitRange(allDependency.dirtyRanges);FDtree.featureDirtyRanges=dirtyRanges,FDtree.featureId=featureId,FDtree.type=FormulaDependencyTreeType.FEATURE_FORMULA,this._dependencyManagerService.addFeatureFormulaDependency(unitId,subUnitId,featureId,FDtree);return this._dependencyManagerService.getFeatureFormulaDependency(params.unitId,params.subUnitId,featureId)&&(FDtree.isCache=!0),FDtree}_registerOtherFormulas(otherFormulaData,otherFormulaDataKeys,treeList){for(const unitId of otherFormulaDataKeys){const subComponentData=otherFormulaData[unitId];if(null==subComponentData)continue;const subComponentKeys=Object.keys(subComponentData);for(const subUnitId of subComponentKeys){const subFormulaData=subComponentData[subUnitId];if(null==subFormulaData)continue;const subFormulaDataKeys=Object.keys(subFormulaData);for(const subFormulaDataId of subFormulaDataKeys){const hasOtherFormula=this._dependencyManagerService.hasOtherFormulaDataMainData(subFormulaDataId),formulaDataItem=subFormulaData[subFormulaDataId],{f:formulaString,ranges}=formulaDataItem;let isCache=!1;hasOtherFormula&&(isCache=!0);const node=generateAstNode(unitId,formulaString,this._lexer,this._astTreeBuilder,this._currentConfigService),{firstRow,firstColumn}=this._getFirstCellOfRange(ranges),treeMatrix=this._dependencyManagerService.getOtherFormulaDependency(unitId,subUnitId,subFormulaDataId),firstTreeId=treeMatrix?.getValue(0,0)||generateRandomDependencyTreeId(this._dependencyManagerService),firstFDtree=new FormulaDependencyTree(firstTreeId);for(let i=0;i<ranges.length;i++){const range=ranges[i],{startRow,startColumn,endRow,endColumn}=range;for(let r=startRow;r<=endRow;r++)for(let c=startColumn;c<=endColumn;c++){const x=c-firstColumn,y=r-firstRow;if(0===x&&0===y){firstFDtree.node=node,firstFDtree.formula=formulaString,firstFDtree.unitId=unitId,firstFDtree.subUnitId=subUnitId,firstFDtree.formulaId=subFormulaDataId,firstFDtree.type=FormulaDependencyTreeType.OTHER_FORMULA,firstFDtree.isCache=isCache,treeList.push(firstFDtree),this._dependencyManagerService.addOtherFormulaDependency(unitId,subUnitId,subFormulaDataId,firstFDtree),this._dependencyManagerService.addFormulaDependencyByDefinedName(firstFDtree);continue}const virtual=new FormulaDependencyTreeVirtual;virtual.treeId=treeMatrix?.getValue(x,y)||generateRandomDependencyTreeId(this._dependencyManagerService),virtual.refTree=firstFDtree,virtual.refOffsetX=x,virtual.refOffsetY=y,virtual.isCache=isCache,this._dependencyManagerService.addOtherFormulaDependency(unitId,subUnitId,subFormulaDataId,virtual),this._dependencyManagerService.addFormulaDependencyByDefinedName(virtual),treeList.push(virtual)}}this._dependencyManagerService.addOtherFormulaDependencyMainData(subFormulaDataId)}}}}_getFirstCellOfRange(ranges){const range=ranges[0];return{firstRow:range.startRow,firstColumn:range.startColumn}}_registerFormulas(formulaDataKeys,formulaData,unitData,treeList){for(const unitId of formulaDataKeys){const sheetData=formulaData[unitId];if(null==sheetData)continue;const sheetDataKeys=Object.keys(sheetData);for(const sheetId of sheetDataKeys){const matrixData=new src.hDc(sheetData[sheetId]||{}),sIdCache=new Map;matrixData.forValue(((row,column,formulaDataItem)=>{if(null==formulaDataItem)return!0;const{x=0,y=0,si}=formulaDataItem;if(0!==x||0!==y||null==si)return!0;const FDtree=this._createFDtree(unitId,sheetId,row,column,unitData,formulaDataItem),treeId=this._dependencyManagerService.getFormulaDependency(unitId,sheetId,row,column);null!=treeId?FDtree.treeId=treeId:(this._dependencyManagerService.addFormulaDependency(unitId,sheetId,row,column,FDtree),this._dependencyManagerService.addFormulaDependencyByDefinedName(FDtree)),sIdCache.set(si,FDtree),treeList.push(FDtree)})),matrixData.forValue(((row,column,formulaDataItem)=>{if(null==formulaDataItem)return!0;const{x=0,y=0,si}=formulaDataItem;if(0===x&&0===y&&null!=si)return!0;let FDtree;if(si&&sIdCache.has(si)){const cache=sIdCache.get(si);FDtree=this._createVirtualFDtree(cache,formulaDataItem)}else FDtree=this._createFDtree(unitId,sheetId,row,column,unitData,formulaDataItem);const treeId=this._dependencyManagerService.getFormulaDependency(unitId,sheetId,row,column);null!=treeId?FDtree.treeId=treeId:(this._dependencyManagerService.addFormulaDependency(unitId,sheetId,row,column,FDtree),this._dependencyManagerService.addFormulaDependencyByDefinedName(FDtree)),treeList.push(FDtree)})),sIdCache.clear()}}}_createFDtree(unitId,sheetId,row,column,unitData,formulaDataItem){const{f:formulaString,x=0,y=0}=formulaDataItem,FDtree=new FormulaDependencyTree(generateRandomDependencyTreeId(this._dependencyManagerService)),sheetItem=unitData[unitId][sheetId],node=generateAstNode(unitId,formulaString,this._lexer,this._astTreeBuilder,this._currentConfigService);return FDtree.node=node,FDtree.formula=formulaString,FDtree.unitId=unitId,FDtree.subUnitId=sheetId,FDtree.row=row,FDtree.column=column,FDtree.rowCount=sheetItem.rowCount,FDtree.columnCount=sheetItem.columnCount,FDtree}_createVirtualFDtree(tree,formulaDataItem){const{x=0,y=0}=formulaDataItem,virtual=new FormulaDependencyTreeVirtual;return virtual.treeId=generateRandomDependencyTreeId(this._dependencyManagerService),virtual.refTree=tree,virtual.refOffsetX=x,virtual.refOffsetY=y,virtual}_updateRangeFlatten(){const forceCalculate=this._currentConfigService.isForceCalculate(),dirtyRanges=this._currentConfigService.getDirtyRanges();if(!forceCalculate){this._updateRangeFlattenCache.clear();for(let i=0;i<dirtyRanges.length;i++){const gridRange=dirtyRanges[i],range=gridRange.range,sheetId=gridRange.sheetId,unitId=gridRange.unitId;this._addFlattenCache(unitId,sheetId,range)}}}_addFlattenCache(unitId,sheetId,range){let unitMatrix=this._updateRangeFlattenCache.get(unitId);null==unitMatrix&&(unitMatrix=new Map,this._updateRangeFlattenCache.set(unitId,unitMatrix));let ranges=unitMatrix.get(sheetId);null==ranges&&(ranges=[],unitMatrix.set(sheetId,ranges)),ranges.push(range)}_isPreCalculateNode(node){return node.nodeType===NodeType.UNION||(node.nodeType===NodeType.PREFIX&&node.getToken()===prefixToken.AT||node.nodeType===NodeType.SUFFIX&&node.getToken()===suffixToken.POUND)}_nodeTraversalRef(node,result){const children=node.getChildren(),childrenCount=children.length;for(let i=0;i<childrenCount;i++){const item=children[i];if(this._isPreCalculateNode(item)){if(result.push(item),item.nodeType===NodeType.UNION)for(const unionChildItem of item.getChildren())unionChildItem.nodeType===NodeType.FUNCTION&&unionChildItem.isAddress()&&this._nodeTraversalRef(unionChildItem,result)}else item.nodeType===NodeType.REFERENCE&&result.push(item),this._nodeTraversalRef(item,result)}}_nodeTraversalReferenceFunction(node,result){const children=node.getChildren(),childrenCount=children.length;for(let i=0;i<childrenCount;i++){const item=children[i];item.nodeType===NodeType.FUNCTION&&item.isAddress()?result.push(item):this._nodeTraversalReferenceFunction(item,result)}}async _executeNode(node,refOffsetX=0,refOffsetY=0){let value;const nodeData={node,refOffsetX,refOffsetY};return value=this._interpreter.checkAsyncNode(node)?await this._interpreter.executeAsync(nodeData):this._interpreter.execute(nodeData),value}async _getRangeListByNode(nodeData){const preCalculateNodeList=[],refOffsetX=nodeData.refOffsetX,refOffsetY=nodeData.refOffsetY,node=nodeData.node;if(null==node)return[];this._nodeTraversalRef(node,preCalculateNodeList);const rangeList=[];for(let i=0,len=preCalculateNodeList.length;i<len;i++){const node=preCalculateNodeList[i],gridRange=(await this._executeNode(node,refOffsetX,refOffsetY)).toUnitRange();rangeList.push(gridRange),node.setValue(null)}return rangeList}_getAddressFunctionNodeList(node){const referenceFunctionList=[];return null==node?[]:(this._nodeTraversalReferenceFunction(node,referenceFunctionList),referenceFunctionList)}_getTreeNode(tree){return tree.node}async _buildDirtyRangesByAddressFunction(treeDependencyCache,tree){const addressFunctionNodes=tree.addressFunctionNodes;if(0===addressFunctionNodes.length)return;const refOffsetX=tree.refOffsetX,refOffsetY=tree.refOffsetY,addressFunctionRangeList=await this._getRangeListByFunctionRefNode(addressFunctionNodes,refOffsetX,refOffsetY);tree.addressFunctionNodes=[],this._addDependencyTreeByAddressFunction(tree,addressFunctionRangeList);const newSearchResults=treeDependencyCache.bulkSearch(addressFunctionRangeList),preCalculateTreeList=this._buildTreeNodeById(newSearchResults);0!==preCalculateTreeList.length&&await this._calculateAddressFunctionRuntimeData(treeDependencyCache,preCalculateTreeList)}async _calculateListByFunctionRefNode(treeList){const treeDependencyCache=new src.hm5;for(let i=0,len=treeList.length;i<len;i++){const tree=treeList[i];treeDependencyCache.insert({unitId:tree.unitId,sheetId:tree.subUnitId,range:{startRow:tree.row,startColumn:tree.column,endRow:tree.row,endColumn:tree.column},id:tree.treeId})}this._executedAddressFunctionNodeIds.clear();for(let i=0,len=treeList.length;i<len;i++){const tree=treeList[i];await this._calculateAddressFunction(treeDependencyCache,tree)}}async _calculateAddressFunction(treeDependencyCache,tree){const addressFunctionNodes=tree.addressFunctionNodes;if(0===addressFunctionNodes.length)return;const refOffsetX=tree.refOffsetX,refOffsetY=tree.refOffsetY;this._runtimeService.setCurrent(tree.row,tree.column,tree.rowCount,tree.columnCount,tree.subUnitId,tree.unitId);const dirtyRanges=[];for(let j=0,len=addressFunctionNodes.length;j<len;j++){const rangeList=await this._getRangeListByNode({node:addressFunctionNodes[j],refOffsetX,refOffsetY});dirtyRanges.push(...rangeList)}const newSearchResults=new Set;this._searchDependencyByAddressFunction(treeDependencyCache,dirtyRanges,newSearchResults);const preCalculateTreeList=this._buildTreeNodeById(newSearchResults);0!==preCalculateTreeList.length?(await this._calculateAddressFunctionRuntimeData(treeDependencyCache,preCalculateTreeList),await this._buildDirtyRangesByAddressFunction(treeDependencyCache,tree)):await this._buildDirtyRangesByAddressFunction(treeDependencyCache,tree)}async _calculateAddressFunctionRuntimeData(treeDependencyCache,preCalculateTreeList){for(;preCalculateTreeList.length>0;){const tree=preCalculateTreeList.pop(),nodeData={node:this._getTreeNode(tree),refOffsetX:tree.refOffsetX,refOffsetY:tree.refOffsetY};let value;await this._calculateAddressFunction(treeDependencyCache,tree),this._runtimeService.setCurrent(tree.row,tree.column,tree.rowCount,tree.columnCount,tree.subUnitId,tree.unitId),value=this._interpreter.checkAsyncNode(nodeData.node)?await this._interpreter.executeAsync(nodeData):this._interpreter.execute(nodeData),null!=tree.formulaId?this._runtimeService.setRuntimeOtherData(tree.formulaId,tree.refOffsetX,tree.refOffsetY,value):this._runtimeService.setRuntimeData(value)}}_buildTreeNodeById(treeIds){const preCalculateTreeList=[];for(const treeId of treeIds){const tree=this._getTreeById(treeId);tree&&!this._executedAddressFunctionNodeIds.has(treeId)&&(this._executedAddressFunctionNodeIds.add(treeId),preCalculateTreeList.push(tree))}return preCalculateTreeList}_searchDependencyByAddressFunction(treeDependencyCache,dirtyRanges,searchResults){const newSearchResults=treeDependencyCache.bulkSearch(dirtyRanges),addressFunctionNodes=this._dependencyRTreeCacheForAddressFunction.bulkSearch(dirtyRanges);for(const treeId of addressFunctionNodes)searchResults.has(treeId)||searchResults.add(treeId);const newDirtyRanges=[];for(const treeId of newSearchResults){const tree=this._getTreeById(treeId);tree&&!searchResults.has(treeId)&&(newDirtyRanges.push(...tree.rangeList),searchResults.add(treeId))}return newDirtyRanges.length>0&&this._searchDependencyByAddressFunction(treeDependencyCache,newDirtyRanges,searchResults),searchResults}_getTreeById(treeId){return this._dependencyManagerService.getTreeById(treeId)}_addDependencyTreeByAddressFunction(tree,addressFunctionRangeList){const searchRanges=[];for(let i=0;i<addressFunctionRangeList.length;i++){const unitRangeWithNum=addressFunctionRangeList[i],{unitId,sheetId,range}=unitRangeWithNum;searchRanges.push({unitId,sheetId,range,id:tree.treeId})}this._dependencyRTreeCacheForAddressFunction.bulkInsert(searchRanges)}async _getRangeListByFunctionRefNode(referenceFunctionList,refOffsetX,refOffsetY){const rangeList=[];for(let i=0,len=referenceFunctionList.length;i<len;i++){const node=referenceFunctionList[i],gridRange=(await this._executeNode(node,refOffsetX,refOffsetY)).toUnitRange();rangeList.push(gridRange),node.setValue(null)}return rangeList}_getUpdateTreeListAndMakeDependency(treeList){const newTreeList=[],existTree=new Set,forceCalculate=this._currentConfigService.isForceCalculate(),dirtyRanges=this._currentConfigService.getDirtyRanges(),treeIds=this._dependencyManagerService.searchDependency(dirtyRanges),addressSearchResults=this._dependencyRTreeCacheForAddressFunction.bulkSearch(dirtyRanges);for(const addressSearchResult of addressSearchResults)treeIds.add(addressSearchResult);const allTree=this._dependencyManagerService.buildDependencyTree(treeList);for(const tree of allTree){const treeId=tree.treeId;(forceCalculate||tree.isDirty||tree.dependencySheetName(this._currentConfigService.getDirtyNameMap())||treeIds.has(treeId)&&!tree.isExcludeRange(this._currentConfigService.getExcludedRange()))&&!existTree.has(treeId)&&(newTreeList.push(tree),existTree.add(treeId))}return newTreeList}_includeTreeFeature(tree){const unitId=tree.unitId,subUnitId=tree.subUnitId,featureId=tree.featureId;if(null!=featureId){const featureMap=this._currentConfigService.getDirtyUnitFeatureMap(),state=featureMap?.[unitId]?.[subUnitId]?.[featureId];if(null!=state)return!0}return!1}_includeOtherFormula(tree){const unitId=tree.unitId,subUnitId=tree.subUnitId,formulaId=tree.formulaId;if(null!=formulaId){const otherFormulaMap=this._currentConfigService.getDirtyUnitOtherFormulaMap(),state=otherFormulaMap?.[unitId]?.[subUnitId]?.[formulaId];if(null!=state)return!0}return!1}_detectForcedRecalculationNode(tree,node){return null!=node&&this._detectForcedRecalculationNodeRecursion(node)}_detectForcedRecalculationNodeRecursion(node){if(node.isForcedCalculateFunction())return!0;const children=node.getChildren();for(let i=0,len=children.length;i<len;i++){const child=children[i];if(this._detectForcedRecalculationNodeRecursion(child))return!0}return!1}_includeTree(tree,node){const unitId=tree.unitId,subUnitId=tree.subUnitId;if(!0===this._detectForcedRecalculationNode(tree,node))return!0;if(!0===this._includeTreeFeature(tree))return!0;if(!0===this._includeOtherFormula(tree))return!0;if(!0===function includeDefinedName(tree,node,currentConfigService){if(null!=node&&isDirtyDefinedForNode(node,currentConfigService))return!0;return!1}(0,node,this._currentConfigService))return!0;const excludedCell=this._currentConfigService.getExcludedRange()?.[unitId]?.[subUnitId];if(null!=excludedCell?.getValue(tree.row,tree.column))return!1;if(null!=this._currentConfigService.getDirtyNameMap()[unitId]?.[subUnitId])return!0;if(!this._updateRangeFlattenCache.has(unitId))return!1;const sheetRangeMap=this._updateRangeFlattenCache.get(unitId);if(!sheetRangeMap.has(subUnitId))return!1;const ranges=sheetRangeMap.get(subUnitId);for(const range of ranges)if(tree.inRangeData(range))return!0;return!1}_calculateRunList(treeList){const stack=treeList,formulaRunList=[],cacheStack=[];for(;stack.length>0;){const tree=stack.pop();if(void 0===tree||tree.isSkip())continue;if(tree.isAdded()){formulaRunList.push(tree),tree.setSkip();continue}cacheStack.length=0;for(const parentTreeId of tree.parents){const parentTree=this._dependencyManagerService.getTreeById(parentTreeId);if(!parentTree)throw new Error("ParentDependencyTree object is null");parentTree.isAdded()||tree.isSkip()||cacheStack.push(parentTree)}const addressSearchResults=this._dependencyRTreeCacheForAddressFunction.bulkSearch(tree.toRTreeItem());for(const parentTreeId of addressSearchResults){const parentTree=this._dependencyManagerService.getTreeById(parentTreeId);if(!parentTree)throw new Error("ParentDependencyTree object is null");parentTree.isAdded()||tree.isSkip()||cacheStack.push(parentTree)}0===cacheStack.length?(formulaRunList.push(tree),tree.setSkip()):(tree.setAdded(),stack.push(tree,...cacheStack))}return formulaRunList}}function calculate_formula_service_ts_metadata(k,v){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(k,v)}function calculate_formula_service_ts_param(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}}FormulaDependencyGenerator=function formula_dependency_ts_decorate(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r}([formula_dependency_ts_param(0,IFormulaCurrentConfigService),formula_dependency_ts_param(1,IFormulaRuntimeService),formula_dependency_ts_param(2,IOtherFormulaManagerService),formula_dependency_ts_param(3,IFeatureCalculationManagerService),formula_dependency_ts_param(4,(0,src.y_5)(Interpreter)),formula_dependency_ts_param(5,(0,src.y_5)(AstTreeBuilder)),formula_dependency_ts_param(6,(0,src.y_5)(Lexer)),formula_dependency_ts_param(7,IDependencyManagerService),formula_dependency_ts_metadata("design:type",Function),formula_dependency_ts_metadata("design:paramtypes",[void 0===IFormulaCurrentConfigService?Object:IFormulaCurrentConfigService,void 0===IFormulaRuntimeService?Object:IFormulaRuntimeService,void 0===IOtherFormulaManagerService?Object:IOtherFormulaManagerService,void 0===IFeatureCalculationManagerService?Object:IFeatureCalculationManagerService,void 0===Interpreter?Object:Interpreter,void 0===AstTreeBuilder?Object:AstTreeBuilder,void 0===Lexer?Object:Lexer,void 0===IDependencyManagerService?Object:IDependencyManagerService])],FormulaDependencyGenerator);const ICalculateFormulaService=(0,src.Qmd)("engine-formula.calculate-formula.service");class CalculateFormulaService extends src.jGt{constructor(_configService,_lexer,_currentConfigService,_runtimeService,_formulaDependencyGenerator,_interpreter,_astTreeBuilder){super(),this._configService=_configService,this._lexer=_lexer,this._currentConfigService=_currentConfigService,this._runtimeService=_runtimeService,this._formulaDependencyGenerator=_formulaDependencyGenerator,this._interpreter=_interpreter,this._astTreeBuilder=_astTreeBuilder,this._executionInProgressListener$=new Subject.B,this.executionInProgressListener$=this._executionInProgressListener$.asObservable(),this._executionCompleteListener$=new Subject.B,this.executionCompleteListener$=this._executionCompleteListener$.asObservable()}dispose(){super.dispose(),this._executionInProgressListener$.complete(),this._executionCompleteListener$.complete(),FORMULA_REF_TO_ARRAY_CACHE.clear(),CELL_INVERTED_INDEX_CACHE.clear(),ErrorValueObjectCache.clear(),StringValueObjectCache.clear()}stopFormulaExecution(){this._runtimeService.stopExecution()}setRuntimeFeatureCellData(featureId,featureData){this._runtimeService.setRuntimeFeatureCellData(featureId,featureData)}setRuntimeFeatureRange(featureId,featureRange){this._runtimeService.setRuntimeFeatureRange(featureId,featureRange)}async execute(formulaDatasetConfig){this._runtimeService.setFormulaExecuteStage(FormulaExecuteStageType.START),this._executionInProgressListener$.next(this._runtimeService.getRuntimeState()),this._currentConfigService.load(formulaDatasetConfig),this._runtimeService.reset();const cycleReferenceCount=formulaDatasetConfig.maxIteration||DEFAULT_CYCLE_REFERENCE_COUNT;for(let i=0;i<cycleReferenceCount;i++){this._runtimeService.setFormulaCycleIndex(i),await this._execute(),FORMULA_REF_TO_ARRAY_CACHE.clear();if(!this._runtimeService.isCycleDependency())break}this._runtimeService.setFormulaExecuteStage(FormulaExecuteStageType.CALCULATION_COMPLETED),this._executionInProgressListener$.next(this._runtimeService.getRuntimeState()),this._executionCompleteListener$.next(this._runtimeService.getAllRuntimeData()),CELL_INVERTED_INDEX_CACHE.clear(),this._runtimeService.reset()}async _execute(){const executeState=await this._apply();if(null==executeState)return;const{arrayFormulaRange,runtimeFeatureRange}=executeState,{dirtyRanges,excludedCell}=this._getArrayFormulaDirtyRangeAndExcludedRange(arrayFormulaRange,runtimeFeatureRange);return null==dirtyRanges||0===dirtyRanges.length||(this._currentConfigService.loadDirtyRangesAndExcludedCell(dirtyRanges,excludedCell),await this._apply(!0)),!0}_getArrayFormulaDirtyRangeAndExcludedRange(arrayFormulaRange,runtimeFeatureRange){const dirtyRanges=[],excludedCell={};return Object.keys(arrayFormulaRange).forEach((unitId=>{const sheetArrayFormulaRange=arrayFormulaRange[unitId];if(null==sheetArrayFormulaRange)return!0;Object.keys(sheetArrayFormulaRange).forEach((sheetId=>{const cellValue=new src.hDc(sheetArrayFormulaRange[sheetId]);if(null==cellValue)return!0;const newCellData=new src.hDc;cellValue.forValue(((row,column,range)=>{newCellData.setValue(row,column,!0),dirtyRanges.push({unitId,sheetId,range})})),null==excludedCell[unitId]&&(excludedCell[unitId]={}),excludedCell[unitId][sheetId]=newCellData}))})),Object.keys(runtimeFeatureRange).forEach((featureId=>{const arrayRange=runtimeFeatureRange[featureId];Object.keys(arrayRange).forEach((unitId=>{const sheetArrayFormulaRange=arrayRange[unitId];if(null==sheetArrayFormulaRange)return!0;Object.keys(sheetArrayFormulaRange).forEach((sheetId=>{const ranges=sheetArrayFormulaRange[sheetId];if(null==ranges)return!0;for(const range of ranges)dirtyRanges.push({unitId,sheetId,range})}))}))})),{dirtyRanges,excludedCell}}async _apply(isArrayFormulaState=!1){isArrayFormulaState?this._runtimeService.setFormulaExecuteStage(FormulaExecuteStageType.START_DEPENDENCY_ARRAY_FORMULA):this._runtimeService.setFormulaExecuteStage(FormulaExecuteStageType.START_DEPENDENCY),this._executionInProgressListener$.next(this._runtimeService.getRuntimeState());const treeList=(await this._formulaDependencyGenerator.generate()).reverse(),interpreter=this._interpreter;isArrayFormulaState?(this._runtimeService.setFormulaExecuteStage(FormulaExecuteStageType.START_CALCULATION_ARRAY_FORMULA),this._runtimeService.setTotalArrayFormulasToCalculate(treeList.length)):(this._runtimeService.setFormulaExecuteStage(FormulaExecuteStageType.START_CALCULATION),this._runtimeService.setTotalFormulasToCalculate(treeList.length)),this._executionInProgressListener$.next(this._runtimeService.getRuntimeState());let pendingTasks=[];const config=this._configService.getConfig("engine-formula.config"),intervalCount=config?.intervalCount||500,treeCount=treeList.length;for(let i=0;i<treeCount;i++){const tree=treeList[i],nodeData=tree.nodeData,getDirtyData=tree.getDirtyData;if(i%intervalCount==0&&(await new Promise((resolve=>{const calCancelTask=(0,src.oVm)(resolve);pendingTasks.push(calCancelTask)})),isArrayFormulaState?(this._runtimeService.setFormulaExecuteStage(FormulaExecuteStageType.CURRENTLY_CALCULATING_ARRAY_FORMULA),this._runtimeService.setCompletedArrayFormulasCount(i+1)):(this._runtimeService.setFormulaExecuteStage(FormulaExecuteStageType.CURRENTLY_CALCULATING),this._runtimeService.setCompletedFormulasCount(i+1)),this._executionInProgressListener$.next(this._runtimeService.getRuntimeState()),this._runtimeService.isStopExecution()||null==nodeData&&null==getDirtyData))return this._runtimeService.setFormulaExecuteStage(FormulaExecuteStageType.IDLE),this._runtimeService.markedAsStopFunctionsExecuted(),void this._executionCompleteListener$.next(this._runtimeService.getAllRuntimeData());let value;if(this._runtimeService.setCurrent(tree.row,tree.column,tree.rowCount,tree.columnCount,tree.subUnitId,tree.unitId),null!=getDirtyData&&null!=tree.featureId){const{runtimeCellData,dirtyRanges}=getDirtyData(this._currentConfigService.getDirtyData(),this._runtimeService.getAllRuntimeData());this._runtimeService.setRuntimeFeatureCellData(tree.featureId,runtimeCellData),this._runtimeService.setRuntimeFeatureRange(tree.featureId,dirtyRanges)}else null!=nodeData&&(value=interpreter.checkAsyncNode(nodeData.node)?await interpreter.executeAsync(nodeData):interpreter.execute(nodeData),null!=tree.formulaId?this._runtimeService.setRuntimeOtherData(tree.formulaId,tree.refOffsetX,tree.refOffsetY,value):this._runtimeService.setRuntimeData(value))}return pendingTasks.forEach((cancel=>cancel())),pendingTasks=[],treeCount>0?this._runtimeService.markedAsSuccessfullyExecuted():isArrayFormulaState||this._runtimeService.markedAsNoFunctionsExecuted(),this._runtimeService.getAllRuntimeData()}calculate(formulaString,transformSuffix=!0){const lexerNode=this._lexer.treeBuilder(formulaString,transformSuffix);if(Object.values(error_type_ErrorType).includes(lexerNode))return ErrorNode.create(lexerNode);const astNode=this._astTreeBuilder.parse(lexerNode);astNode?.serialize()}}function calculate_controller_ts_metadata(k,v){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(k,v)}function calculate_controller_ts_param(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}}CalculateFormulaService=function calculate_formula_service_ts_decorate(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r}([calculate_formula_service_ts_param(0,src.J0C),calculate_formula_service_ts_param(1,(0,src.y_5)(Lexer)),calculate_formula_service_ts_param(2,IFormulaCurrentConfigService),calculate_formula_service_ts_param(3,IFormulaRuntimeService),calculate_formula_service_ts_param(4,IFormulaDependencyGenerator),calculate_formula_service_ts_param(5,(0,src.y_5)(Interpreter)),calculate_formula_service_ts_param(6,(0,src.y_5)(AstTreeBuilder)),calculate_formula_service_ts_metadata("design:type",Function),calculate_formula_service_ts_metadata("design:paramtypes",[void 0===src.J0C?Object:src.J0C,void 0===Lexer?Object:Lexer,void 0===IFormulaCurrentConfigService?Object:IFormulaCurrentConfigService,void 0===IFormulaRuntimeService?Object:IFormulaRuntimeService,void 0===IFormulaDependencyGenerator?Object:IFormulaDependencyGenerator,void 0===Interpreter?Object:Interpreter,void 0===AstTreeBuilder?Object:AstTreeBuilder])],CalculateFormulaService);class CalculateController extends src.jGt{constructor(_commandService,_calculateFormulaService,_formulaDataModel){super(),this._commandService=_commandService,this._calculateFormulaService=_calculateFormulaService,this._formulaDataModel=_formulaDataModel,this._initialize()}_initialize(){this._commandExecutedListener(),this._initialExecuteFormulaListener()}_commandExecutedListener(){this.disposeWithMe(this._commandService.onCommandExecuted((command=>{if(command.id===SetFormulaCalculationStopMutation.id)this._calculateFormulaService.stopFormulaExecution();else if(command.id===SetFormulaCalculationStartMutation.id){const params=command.params;this._calculate(params)}else if(command.id===SetArrayFormulaDataMutation.id){const params=command.params;if(null==params)return;const{arrayFormulaRange,arrayFormulaCellData}=params;this._formulaDataModel.setArrayFormulaRange(arrayFormulaRange),this._formulaDataModel.setArrayFormulaCellData(arrayFormulaCellData)}})))}async _calculate(formulaDirtyData){const{forceCalculation:forceCalculate=!1,dirtyRanges=[],dirtyNameMap={},dirtyDefinedNameMap={},dirtyUnitFeatureMap={},dirtyUnitOtherFormulaMap={},clearDependencyTreeCache={},maxIteration=DEFAULT_CYCLE_REFERENCE_COUNT,rowData}=formulaDirtyData,formulaData=this._formulaDataModel.getFormulaData(),arrayFormulaCellData=this._formulaDataModel.getArrayFormulaCellData(),arrayFormulaRange=this._formulaDataModel.getArrayFormulaRange();this._calculateFormulaService.execute({formulaData,arrayFormulaCellData,arrayFormulaRange,forceCalculate,dirtyRanges,dirtyNameMap,dirtyDefinedNameMap,dirtyUnitFeatureMap,dirtyUnitOtherFormulaMap,clearDependencyTreeCache,maxIteration,rowData})}_initialExecuteFormulaListener(){this._calculateFormulaService.executionCompleteListener$.subscribe((data=>{const functionsExecutedState=data.functionsExecutedState;switch(functionsExecutedState){case FormulaExecutedStateType.NOT_EXECUTED:case FormulaExecutedStateType.STOP_EXECUTION:break;case FormulaExecutedStateType.SUCCESS:this._applyResult(data);case FormulaExecutedStateType.INITIAL:}this._commandService.executeCommand(SetFormulaCalculationNotificationMutation.id,{functionsExecutedState},{onlyLocal:!0})})),this._calculateFormulaService.executionInProgressListener$.subscribe((data=>{this._commandService.executeCommand(SetFormulaCalculationNotificationMutation.id,{stageInfo:data},{onlyLocal:!0})}))}async _applyResult(data){const{unitData,unitOtherData,arrayFormulaRange,arrayFormulaCellData,clearArrayFormulaCellData}=data;unitData?(arrayFormulaRange&&(this._formulaDataModel.clearPreviousArrayFormulaCellData(clearArrayFormulaCellData),this._formulaDataModel.mergeArrayFormulaCellData(arrayFormulaCellData),this._formulaDataModel.mergeArrayFormulaRange(arrayFormulaRange),this._commandService.executeCommand(SetArrayFormulaDataMutation.id,{arrayFormulaRange:this._formulaDataModel.getArrayFormulaRange(),arrayFormulaCellData:this._formulaDataModel.getArrayFormulaCellData()},{onlyLocal:!0})),this._commandService.executeCommand(SetFormulaCalculationResultMutation.id,{unitData:convertRuntimeToUnitData(unitData),unitOtherData},{onlyLocal:!0})):console.error("No sheetData from Formula Engine!")}}CalculateController=function calculate_controller_ts_decorate(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r}([calculate_controller_ts_param(0,src.wTY),calculate_controller_ts_param(1,ICalculateFormulaService),calculate_controller_ts_param(2,(0,src.y_5)(FormulaDataModel)),calculate_controller_ts_metadata("design:type",Function),calculate_controller_ts_metadata("design:paramtypes",[void 0===src.wTY?Object:src.wTY,void 0===ICalculateFormulaService?Object:ICalculateFormulaService,void 0===FormulaDataModel?Object:FormulaDataModel])],CalculateController);const $relativeRegex=/[\[\]]/g;function handleR1C1(rowOrColumnString,current){if($relativeRegex.test(rowOrColumnString)){return current+Number(rowOrColumnString.replace($relativeRegex,""))}return Number(rowOrColumnString)-1}function singleReference(refBody,currentRow=0,currentColumn=0){const refBodyArray=(refBody=refBody.toLocaleUpperCase()).split(/[RC]/),rowString=refBodyArray[1],columnString=refBodyArray[2];return{row:handleR1C1(rowString,currentRow),column:handleR1C1(columnString,currentColumn),absoluteRefType:src.F6v.NONE}}function getR1C1Ref(index,absoluteRefType=src.F6v.ALL,isRow){switch(index+=1,absoluteRefType){case src.F6v.ALL:return`${index}`;case src.F6v.ROW:return isRow?`${index}`:`[${index}]`;case src.F6v.COLUMN:return isRow?`[${index}]`:`${index}`;case src.F6v.NONE:return`[${index}]`}}function checkVariantErrorIsArray(variant){let _variant=variant;if(variant.isArray()){const rowCount=variant.getRowCount(),columnCount=variant.getColumnCount();if(rowCount>1||columnCount>1)return ErrorValueObject.create(error_type_ErrorType.VALUE);_variant=variant.get(0,0)}return _variant.isError(),_variant}function checkVariantsErrorIsArray(...variants){for(let i=0;i<variants.length;i++){const variant=checkVariantErrorIsArray(variants[i]);if(variant.isError())return{isError:!0,errorObject:variant};variants[i]=variant}return{isError:!1,variants}}function checkVariantsErrorIsArrayOrBoolean(...variants){for(let i=0;i<variants.length;i++){const variant=checkVariantErrorIsArray(variants[i]);if(variant.isError())return{isError:!0,errorObject:variant};if(variant.isBoolean())return{isError:!0,errorObject:ErrorValueObject.create(error_type_ErrorType.VALUE)};variants[i]=variant}return{isError:!1,variants}}function checkVariantsErrorIsNullorArrayOrBoolean(...variants){for(let i=0;i<variants.length;i++){let variant=variants[i];if(variant.isError())return{isError:!0,errorObject:variant};if(variant.isNull())return{isError:!0,errorObject:ErrorValueObject.create(error_type_ErrorType.NA)};if(variant=checkVariantErrorIsArray(variants[i]),variant.isError())return{isError:!0,errorObject:variant};if(variant.isBoolean())return{isError:!0,errorObject:ErrorValueObject.create(error_type_ErrorType.VALUE)};variants[i]=variant}return{isError:!1,variants}}function checkVariantsErrorIsStringToNumber(...variants){for(let i=0;i<variants.length;i++){let variant=variants[i];if(variant.isString()&&(variant=variant.convertToNumberObjectValue()),variant.isError())return{isError:!0,errorObject:variant};variants[i]=variant}return{isError:!1,variants}}class base_function_BaseFunction{constructor(_name){this._name=_name,this._row=-1,this._column=-1,this._rowCount=-1,this._columnCount=-1,this.needsExpandParams=!1,this.needsReferenceObject=!1,this.needsLocale=!1,this.needsSheetsInfo=!1,this.needsFormulaDataModel=!1,this.needsSheetRowColumnCount=!1,this.minParams=-1,this.maxParams=-1}get name(){return this._name}get unitId(){return this._unitId}get subUnitId(){return this._subUnitId}get row(){return this._row}get column(){return this._column}dispose(){}getDefinedName(name){const nameMap=this._definedNames;return null==nameMap?null:Array.from(Object.values(nameMap)).filter((value=>value.name===name))?.[0]}setDefinedNames(definedNames){this._definedNames=definedNames}getLocale(){return this._locale}setLocale(locale){this._locale=locale}getSheetsInfo(){return{sheetOrder:this._sheetOrder,sheetNameMap:this._sheetNameMap}}setSheetsInfo({sheetOrder,sheetNameMap}){this._sheetOrder=sheetOrder,this._sheetNameMap=sheetNameMap}setFormulaDataModel(_formulaDataModel){this._formulaDataModel=_formulaDataModel}setSheetRowColumnCount(rowCount,columnCount){this._rowCount=rowCount,this._columnCount=columnCount}isAsync(){return!1}isAddress(){return!1}isCustom(){return!1}setRefInfo(unitId,subUnitId,row,column){this._unitId=unitId,this._subUnitId=subUnitId,this._row=row,this._column=column}calculateCustom(...arg){return null}calculate(...arg){return ErrorValueObject.create(error_type_ErrorType.VALUE)}checkArrayType(variant){return variant.isReferenceObject()||variant.isValueObject()&&variant.isArray()}getIndexNumValue(indexNum,defaultValue=1){let _indexNum=indexNum;if(_indexNum.isArray()&&(_indexNum=_indexNum.getFirstCell()),_indexNum.isBoolean()){return!1===_indexNum.getValue()?ErrorValueObject.create(error_type_ErrorType.VALUE):defaultValue}if(_indexNum.isString()){const colIndexNumV=Number(_indexNum.getValue());return Number.isNaN(colIndexNumV)?ErrorValueObject.create(error_type_ErrorType.REF):colIndexNumV}if(_indexNum.isNumber()){return _indexNum.getValue()}return ErrorValueObject.create(error_type_ErrorType.VALUE)}getZeroOrOneByOneDefault(logicValueObject){if(null==logicValueObject)return 1;let logicValue=1;if(logicValueObject.isArray()&&(logicValueObject=logicValueObject.getFirstCell()),logicValueObject.isBoolean()){!1===logicValueObject.getValue()&&(logicValue=0)}else{if(logicValueObject.isString())return;if(logicValueObject.isNumber()){0===logicValueObject.getValue()&&(logicValue=0)}}return logicValue}getMatchTypeValue(logicValueObject){if(null==logicValueObject)return 1;let logicValue=1;if(logicValueObject.isArray()&&(logicValueObject=logicValueObject.getFirstCell()),logicValueObject.isBoolean()){!1===logicValueObject.getValue()&&(logicValue=0)}else{if(logicValueObject.isString())return;if(logicValueObject.isNumber()){const logicV=logicValueObject.getValue();logicV<=0&&(logicValue=logicV)}}return logicValue}binarySearch(value,searchArray,resultArray,searchType,matchType){const rowOrColumn=searchArray.binarySearch(value,searchType,matchType);if(null==rowOrColumn)return ErrorValueObject.create(error_type_ErrorType.NA);let resultValue;return resultValue=1===resultArray.getRowCount()?resultArray.get(0,rowOrColumn)||NullValueObject.create():resultArray.get(rowOrColumn,0)||NullValueObject.create(),resultValue.isNull()?NumberValueObject.create(0):resultValue}_getOneFirstByRaw(array){return 0===array.length?ErrorValueObject.create(error_type_ErrorType.NA):array[0][0]||ErrorValueObject.create(error_type_ErrorType.NA)}_getOneLastByRaw(array){return 0===array.length?ErrorValueObject.create(error_type_ErrorType.NA):array[array.length-1][array[0].length-1]||ErrorValueObject.create(error_type_ErrorType.NA)}equalSearch(value,searchArray,resultArray,isFirst=!0){const resultArrayValue=resultArray.pickRaw(searchArray.isEqual(value));return isFirst?this._getOneFirstByRaw(resultArrayValue):this._getOneLastByRaw(resultArrayValue)}fuzzySearch(value,searchArray,resultArray,isFirst=!0){const resultArrayValue=resultArray.pickRaw(searchArray.compare(value,compareToken.EQUALS));return isFirst?this._getOneFirstByRaw(resultArrayValue):this._getOneLastByRaw(resultArrayValue)}orderSearch(value,searchArray,resultArray,searchType=ArrayOrderSearchType.MIN,isDesc=!1){const position=searchArray.orderSearch(value,searchType,isDesc);if(null==position)return ErrorValueObject.create(error_type_ErrorType.NA);const resultValue=resultArray.get(position.row,position.column)||NullValueObject.create();return resultValue.isNull()?ErrorValueObject.create(error_type_ErrorType.NA):resultValue}binarySearchExpand(value,searchArray,resultArray,axis=0,searchType,matchType){const rowOrColumn=searchArray.binarySearch(value,searchType,matchType);return null==rowOrColumn?ErrorValueObject.create(error_type_ErrorType.NA):0===axis?resultArray.slice([rowOrColumn,rowOrColumn+1]):resultArray.slice(void 0,[rowOrColumn,rowOrColumn+1])}equalSearchExpand(value,searchArray,resultArray,isFirst=!0,axis=0){const matchObject=searchArray.isEqual(value);let position;return position=isFirst?matchObject.getFirstTruePosition():matchObject.getLastTruePosition(),null==position?ErrorValueObject.create(error_type_ErrorType.NA):0===axis?resultArray.slice([position.row,position.row+1]):resultArray.slice(void 0,[position.column,position.column+1])}fuzzySearchExpand(value,searchArray,resultArray,isFirst=!0,axis=0){const matchObject=searchArray.compare(value,compareToken.EQUALS);let position;return position=isFirst?matchObject.getFirstTruePosition():matchObject.getLastTruePosition(),null==position?ErrorValueObject.create(error_type_ErrorType.NA):0===axis?resultArray.slice([position.row,position.row+1]):resultArray.slice(void 0,[position.column,position.column+1])}orderSearchExpand(value,searchArray,resultArray,searchType=ArrayOrderSearchType.MIN,isDesc=!1,axis=0){const position=searchArray.orderSearch(value,searchType,isDesc);return null==position?ErrorValueObject.create(error_type_ErrorType.NA):0===axis?resultArray.slice([position.row,position.row+1]):resultArray.slice(void 0,[position.column,position.column+1])}flattenArray(variants,ignoreLogicalValuesAndText=!0){const flattenValues=[];flattenValues[0]=[];for(let i=0;i<variants.length;i++){let variant=variants[i];if((variant.isString()||variant.isBoolean()||variant.isNull())&&(variant=variant.convertToNumberObjectValue()),variant.isError())return variant;if(variant.isArray()){let errorValue;if(variant.iterator((valueObject=>!(null!=valueObject&&!valueObject.isNull())||(!(!ignoreLogicalValuesAndText||!valueObject.isString()&&!valueObject.isBoolean())||((valueObject=this._includingLogicalValuesAndText(valueObject)).isError()?(errorValue=valueObject,!1):void flattenValues[0].push(valueObject))))),errorValue?.isError())return errorValue}else flattenValues[0].push(variant)}return createNewArray(flattenValues,1,flattenValues[0].length)}_includingLogicalValuesAndText(valueObject){if(valueObject.isBoolean()&&(valueObject=function convertTonNumber(valueObject){let result=0;return valueObject.getValue()&&(result=1),NumberValueObject.create(result)}(valueObject)),valueObject.isString()){const value=Number(valueObject.getValue());valueObject=NumberValueObject.create(Number.isNaN(value)?0:value)}return valueObject}createReferenceObject(reference,range){const unitId=reference.getForcedUnitId(),sheetId=reference.getForcedSheetId()||"",token=serializeRangeToRefString({unitId,sheetName:reference.getForcedSheetName(),range});let referenceObject;return referenceObject=regexTestSingeRange(token)?new CellReferenceObject(token):regexTestSingleRow(token)?new RowReferenceObject(token):regexTestSingleColumn(token)?new ColumnReferenceObject(token):new RangeReferenceObject(range,sheetId,unitId),this._setReferenceDefault(reference,referenceObject)}_setReferenceDefault(reference,object){return null==this.unitId||null==this.subUnitId?ErrorValueObject.create(error_type_ErrorType.REF):(object.setDefaultUnitId(this.unitId),object.setDefaultSheetId(this.subUnitId),object.setUnitData(reference.getUnitData()),object.setRuntimeData(reference.getRuntimeData()),object.setArrayFormulaCellData(reference.getArrayFormulaCellData()),object.setRuntimeArrayFormulaCellData(reference.getRuntimeArrayFormulaCellData()),object)}}var FUNCTION_NAMES_ARRAY=function(FUNCTION_NAMES_ARRAY){return FUNCTION_NAMES_ARRAY.ARRAY_CONSTRAIN="ARRAY_CONSTRAIN",FUNCTION_NAMES_ARRAY.FLATTEN="FLATTEN",FUNCTION_NAMES_ARRAY}({});const functionArray=[[class ArrayConstrain extends base_function_BaseFunction{calculate(inputRange,numRows,numCols){if(inputRange.isError())return inputRange;const{isError,errorObject,variants}=checkVariantsErrorIsArray(numRows,numCols);if(isError)return errorObject;const{isError:_isError,errorObject:_errorObject,variants:_variants}=checkVariantsErrorIsStringToNumber(...variants);if(_isError)return _errorObject;const[numRowsObject,numColsObject]=_variants,numRowsValue=Math.floor(+numRowsObject.getValue()),numColsValue=Math.floor(+numColsObject.getValue());if(numRowsValue<0||numColsValue<0)return ErrorValueObject.create(error_type_ErrorType.NUM);if(0===numRowsValue||0===numColsValue)return ErrorValueObject.create(error_type_ErrorType.REF);const rowCount=inputRange.isArray()?inputRange.getRowCount():1,columnCount=inputRange.isArray()?inputRange.getColumnCount():1;if(1===rowCount&&1===columnCount)return inputRange.isArray()?inputRange.get(0,0):inputRange;const maxRowCount=numRowsValue>rowCount?rowCount:numRowsValue,maxColumnCount=numColsValue>columnCount?columnCount:numColsValue;return inputRange.slice([0,maxRowCount],[0,maxColumnCount])}constructor(...args){super(...args),this.minParams=3,this.maxParams=3}},FUNCTION_NAMES_ARRAY.ARRAY_CONSTRAIN],[class Flatten extends base_function_BaseFunction{calculate(...variants){const resultArray=[];for(let i=0;i<variants.length;i++){const variant=variants[i],rowCount=variant.isArray()?variant.getRowCount():1,columnCount=variant.isArray()?variant.getColumnCount():1;for(let r=0;r<rowCount;r++)for(let c=0;c<columnCount;c++){const valueObject=variant.isArray()?variant.get(r,c):variant;resultArray.push([valueObject])}}return ArrayValueObject.create({calculateValueList:resultArray,rowCount:resultArray.length,columnCount:1,unitId:this.unitId,sheetId:this.subUnitId,row:this.row,column:this.column})}constructor(...args){super(...args),this.minParams=1,this.maxParams=255}},FUNCTION_NAMES_ARRAY.FLATTEN]];function isValidBinaryNumber(number){return/^[01]{1,10}$/.test(number)}function isValidOctalNumber(number){return/^[0-7]{1,10}$/.test(number)}function isValidHexadecimalNumber(number){return/^[0-9A-Fa-f]{1,10}$/.test(number)}function erf(x){if(0===x)return 0;const cof=[-1.3026537197817094,.6419697923564902,.019476473204185836,-.00956151478680863,-.000946595344482036,.000366839497852761,42523324806907e-18,-20278578112534e-18,-1624290004647e-18,130365583558e-17,1.5626441722e-8,-8.5238095915e-8,6.529054439e-9,5.059343495e-9,-9.91364156e-10,-2.27365122e-10,96467911e-18,2394038e-18,-6886027e-18,894487e-18,313092e-18,-112708e-18,381e-18,7106e-18,-1523e-18,-94e-18,121e-18,-28e-18];let _x=x,isNeg=!1;_x<0&&(_x=-_x,isNeg=!0);const t=2/(2+_x),ty=4*t-2;let tmp,d=0,dd=0;for(let j=cof.length-1;j>0;j--)tmp=d,d=ty*d-dd+cof[j],dd=tmp;const res=t*Math.exp(-_x*_x+.5*(cof[0]+ty*d)-dd);return isNeg?res-1:1-res}function erfc(x){return 1-erf(x)}var BESSEL;function calculateFactorial(n,step=1){let _n=Math.floor(n);if(n<0)return Number.NaN;let result=1;for(;_n>1&&Number.isFinite(result);)result*=_n,_n-=step;return result}function calculateCombin(n,k){const t=Math.min(n-k,k);let result=1;for(let i=1;i<=t&&Number.isFinite(result);i++)result*=n-i+1,result/=i;return result}function calculateGcd(a,b){let _a=Math.floor(a),_b=Math.floor(b);for(;0!==_b;){const t=_b;_b=_a%_b,_a=t}return _a}function calculateLcm(a,b){const den=calculateGcd(a,b);return 0===den?0:Math.abs(a*b)/den}function calculateMdeterm(matrix){const n=matrix.length;if(1===n)return matrix[0][0];if(2===n)return matrix[0][0]*matrix[1][1]-matrix[0][1]*matrix[1][0];let det=0;for(let col=0;col<n;col++)det+=(col%2==0?1:-1)*matrix[0][col]*calculateMdeterm(minor(matrix,0,col));return det}function calculateMinverse(matrix){const det=calculateMdeterm(matrix);if(0===det)return null;if(1===matrix.length)return[[1/det]];const adjugate=function adjoint(matrix){const n=matrix.length,adj=Array.from({length:n},(()=>new Array(n).fill(0)));for(let i=0;i<n;i++)for(let j=0;j<n;j++){const sign=(i+j)%2==0?1:-1;adj[j][i]=sign*calculateMdeterm(minor(matrix,i,j))}return adj}(matrix);return adjugate.map((row=>row.map((value=>value/det))))}function minor(matrix,row,col){return matrix.filter(((_,r)=>r!==row)).map((row=>row.filter(((_,c)=>c!==col))))}function calculateMmult(matrix1,matrix2){return matrix1.map((row=>matrix2[0].map(((_,colIndex)=>row.reduce(((sum,element,rowIndex)=>sum+element*matrix2[rowIndex][colIndex]),0)))))}function matrixTranspose(matrix){return matrix[0].map(((_,colIndex)=>matrix.map((row=>row[colIndex]))))}function inverseMatrixByLUD(matrix){const{smallPivotDetected,luMatrix,permutation}=function performLUDecomposition(matrix){const decomposedMatrix=matrixTranspose(matrix),numRows=decomposedMatrix.length,numCols=decomposedMatrix[0].length;let isRowSwap=!0,smallPivotDetected=!1;const luMatrix=createMatrix(numRows,numCols,0),permutation=new Array(numCols).fill(0).map(((_,index)=>index));for(let c=0;c<numCols;c++){for(let i=0;i<c;i++){let value=decomposedMatrix[i][c];for(let k=0;k<i;k++)value-=luMatrix[i][k]*luMatrix[k][c];luMatrix[i][c]=value}let maxPivot=-1/0,pivotRow=c;for(let r=c;r<numRows;r++){let value=decomposedMatrix[r][c];for(let k=0;k<c;k++)value-=luMatrix[r][k]*luMatrix[k][c];luMatrix[r][c]=value;const absValue=Math.abs(value);absValue>maxPivot&&(maxPivot=absValue,pivotRow=r)}if(Math.abs(luMatrix[pivotRow][c])<1e-11){smallPivotDetected=!0;break}pivotRow!==c&&([luMatrix[c],luMatrix[pivotRow]]=[luMatrix[pivotRow],luMatrix[c]],[decomposedMatrix[c],decomposedMatrix[pivotRow]]=[decomposedMatrix[pivotRow],decomposedMatrix[c]],[permutation[c],permutation[pivotRow]]=[permutation[pivotRow],permutation[c]],isRowSwap=!isRowSwap);const pivotElement=luMatrix[c][c];for(let r=c+1;r<numRows;r++)luMatrix[r][c]/=pivotElement}return{rowSwap:isRowSwap,smallPivotDetected,luMatrix,permutation}}(matrix);return smallPivotDetected?null:function transformMatrix(inputMatrix,indices){const size=indices.length,identityMatrix=createMatrix(size,size,0);for(let i=0;i<size;i++)identityMatrix[i][i]=1;const resultMatrix=createMatrix(size,size,0);for(let rowIndex=0;rowIndex<size;rowIndex++){const index=indices[rowIndex];for(let colIndex=0;colIndex<size;colIndex++)resultMatrix[rowIndex][colIndex]=identityMatrix[index][colIndex]}for(let pivot=0;pivot<size;pivot++){const currentRow=resultMatrix[pivot];for(let row=pivot+1;row<size;row++){const factor=inputMatrix[row][pivot];for(let column=0;column<size;column++)resultMatrix[row][column]-=currentRow[column]*factor}}for(let row=size-1;row>=0;row--){const currentRow=resultMatrix[row],pivotElement=inputMatrix[row][row];for(let column=0;column<size;column++)currentRow[column]/=pivotElement;for(let upperRow=0;upperRow<row;upperRow++){const upperFactor=inputMatrix[upperRow][row];for(let upperCol=0;upperCol<size;upperCol++)resultMatrix[upperRow][upperCol]-=currentRow[upperCol]*upperFactor}}return resultMatrix}(luMatrix,permutation)}function createMatrix(rows,cols,initialValue){const matrix=[];for(let r=0;r<rows;r++){matrix[r]=[];for(let c=0;c<cols;c++)matrix[r].push(initialValue)}return matrix}function inverseMatrixByUSV(matrix){const matrixUSV=function getMatrixUSV(matrix){const matrixU=matrixTranspose(matrix),m=matrixU.length,n=matrixU[0].length;if(m<n)return null;const matrixF=new Array(n).fill(0),matrixS=new Array(n).fill(0),matrixV=Array.from({length:n},(()=>new Array(n).fill(0)));let EPSILON=Number.EPSILON,sqrt=0,msp=0,maxCoeffecient=0;for(let i=0;i<n;i++){if(matrixF[i]=sqrt,msp=getMatrixSumProductOfRows(matrixU,i,m,i,i),msp<=1e-64/EPSILON)sqrt=0;else{sqrt=Math.sqrt(msp),matrixU[i][i]>=0&&(sqrt=-sqrt);const temp=matrixU[i][i]*sqrt-msp;matrixU[i][i]-=sqrt;for(let j=i+1;j<n;j++){msp=getMatrixSumProductOfRows(matrixU,i,m,i,j);for(let k=i;k<m;k++)matrixU[k][j]+=msp/temp*matrixU[k][i]}}if(matrixS[i]=sqrt,msp=getMatrixSumProductOfCols(matrixU,i+1,n,i,i),msp<=1e-64/EPSILON)sqrt=0;else{sqrt=Math.sqrt(msp),matrixU[i][i+1]>=0&&(sqrt=-sqrt);const temp=matrixU[i][i+1]*sqrt-msp;matrixU[i][i+1]-=sqrt;for(let j=i+1;j<n;j++)matrixF[j]=matrixU[i][j]/temp;for(let j=i+1;j<m;j++){msp=getMatrixSumProductOfCols(matrixU,i+1,n,j,i);for(let k=i+1;k<n;k++)matrixU[j][k]+=msp*matrixF[k]}}const coefficient=Math.abs(matrixS[i])+Math.abs(matrixF[i]);coefficient>maxCoeffecient&&(maxCoeffecient=coefficient)}let o=0;for(let i=n-1;i>=0;i--){if(0!==sqrt){for(let j=o;j<n;j++)matrixV[j][i]=matrixU[i][j]/(sqrt*matrixU[i][i+1]);for(let j=o;j<n;j++){msp=0;for(let k=o;k<n;k++)msp+=matrixU[i][k]*matrixV[k][j];for(let k=o;k<n;k++)matrixV[k][j]+=msp*matrixV[k][i]}}for(let j=o;j<n;j++)matrixV[i][j]=0,matrixV[j][i]=0;matrixV[i][i]=1,sqrt=matrixF[i],o=i}for(let i=n-1;i>=0;i--){sqrt=matrixS[i];for(let j=i+1;j<n;j++)matrixU[i][j]=0;if(0!==sqrt){for(let j=i+1;j<n;j++){msp=getMatrixSumProductOfRows(matrixU,i+1,m,i,j);for(let k=i;k<m;k++)matrixU[k][j]+=msp/(matrixU[i][i]*sqrt)*matrixU[k][i]}for(let j=i;j<m;j++)matrixU[j][i]/=sqrt}else for(let j=i;j<m;j++)matrixU[j][i]=0;matrixU[i][i]+=1}EPSILON*=maxCoeffecient;let a=0,b=0,ratio=0;for(let i=n-1;i>=0;i--)for(let S=0;S<50;S++){let isNeedHandle=!1,index=i;for(;index>=0;index--){if(Math.abs(matrixF[index])<=EPSILON){isNeedHandle=!0;break}if(Math.abs(matrixS[index-1])<=EPSILON)break}if(!isNeedHandle){let temp1=0,temp2=1;for(let j=index;j<i+1&&(a=temp2*matrixF[j],b=matrixS[j],matrixF[j]*=temp1,!(Math.abs(a)<=EPSILON));j++){ratio=computeHypotenuse(a,b),matrixS[j]=ratio,temp1=b/ratio,temp2=-a/ratio;for(let k=0;k<m;k++){const value1=matrixU[k][index-1],value2=matrixU[k][j];matrixU[k][index-1]=value1*temp1+value2*temp2,matrixU[k][j]=-value1*temp2+value2*temp1}}}if(index===i){if(matrixS[i]<0){matrixS[i]=-matrixS[i];for(let j=0;j<n;j++)matrixV[j][i]=-matrixV[j][i]}break}if(S>=49)return null;let indexValue=matrixS[index];a=((matrixS[i-1]-matrixS[i])*(matrixS[i-1]+matrixS[i])+(matrixF[i-1]-matrixF[i])*(matrixF[i-1]+matrixF[i]))/(2*matrixF[i]*matrixS[i-1]),ratio=computeHypotenuse(a,1),a=a<0?((indexValue-matrixS[i])*(indexValue+matrixS[i])+matrixF[i]*(matrixS[i-1]/(a-ratio)-matrixF[i]))/indexValue:((indexValue-matrixS[i])*(indexValue+matrixS[i])+matrixF[i]*(matrixS[i-1]/(a+ratio)-matrixF[i]))/indexValue;let temp1=1,temp2=1;for(let j=index+1;j<i+1;j++){let matrixFValue=matrixF[j],matrixSValue=matrixS[j];b=temp2*matrixFValue,matrixFValue*=temp1,ratio=computeHypotenuse(a,b),matrixF[j-1]=ratio,temp1=a/ratio,temp2=b/ratio,a=indexValue*temp1+matrixFValue*temp2,b=matrixSValue*temp2,matrixFValue=-indexValue*temp2+matrixFValue*temp1,matrixSValue*=temp1;for(let k=0;k<n;k++){const value1=matrixV[k][j-1],value2=matrixV[k][j];matrixV[k][j-1]=value1*temp1+value2*temp2,matrixV[k][j]=-value1*temp2+value2*temp1}ratio=computeHypotenuse(a,b),matrixS[j-1]=ratio,temp1=a/ratio,temp2=b/ratio,a=temp1*matrixFValue+temp2*matrixSValue,indexValue=-temp2*matrixFValue+temp1*matrixSValue;for(let k=0;k<m;k++){const value1=matrixU[k][j-1],value2=matrixU[k][j];matrixU[k][j-1]=value1*temp1+value2*temp2,matrixU[k][j]=-value1*temp2+value2*temp1}}matrixF[index]=0,matrixF[i]=a,matrixS[i]=indexValue}for(let i=0;i<matrixS.length;i++)matrixS[i]<EPSILON&&(matrixS[i]=0);for(let i=0;i<n;i++)for(let j=i-1;j>=0;j--)if(matrixS[j]<matrixS[i]){const temp=matrixS[j];matrixS[j]=matrixS[i],matrixS[i]=temp;for(let k=0;k<matrixU.length;k++){const temp=matrixU[k][i];matrixU[k][i]=matrixU[k][j],matrixU[k][j]=temp}for(let k=0;k<matrixV.length;k++){const temp=matrixV[k][i];matrixV[k][i]=matrixV[k][j],matrixV[k][j]=temp}i=j}return{matrixU,matrixS,matrixV}}(matrix);if(!matrixUSV)return null;const{matrixU,matrixS,matrixV}=matrixUSV,matrixUT=matrixTranspose(matrixU),newMatrix=Array.from({length:matrixS.length},(()=>new Array(matrix[0].length).fill(0))),EPSILON=Math.max(matrix.length,matrix[0].length)*Number.EPSILON*matrixS[0];for(let i=0;i<matrixS.length;i++)Math.abs(matrixS[i])>EPSILON&&(newMatrix[i][i]=1/matrixS[i]);return calculateMmult(matrixV,calculateMmult(newMatrix,matrixUT))}function computeHypotenuse(a,b){let ratio=0;return Math.abs(a)>Math.abs(b)?(ratio=b/a,Math.abs(a)*Math.sqrt(1+ratio*ratio)):0!==b?(ratio=a/b,Math.abs(b)*Math.sqrt(1+ratio*ratio)):0}function getMatrixSumProductOfRows(matrix,startRow,endRow,col1,col2){let sum=0;for(let i=startRow;i<endRow;i++)sum+=matrix[i][col1]*matrix[i][col2];return sum}function getMatrixSumProductOfCols(matrix,startCol,endCol,row1,row2){let sum=0;for(let i=startCol;i<endCol;i++)sum+=matrix[row1][i]*matrix[row2][i];return sum}!function(BESSEL){const W=.636619772;function _horner(arr,v){let z=0;for(let i=0;i<arr.length;++i)z=v*z+arr[i];return z}function _bessel_iter(x,n,f0,f1,sign){if(0===n)return f0;if(1===n)return f1;const tdx=2/x;let _f0=f0,_f1=f1,f2=f1;for(let o=1;o<n;++o)f2=_f1*o*tdx+sign*_f0,_f0=_f1,_f1=f2;return f2}function _bessel_wrap(bessel0,bessel1,nonzero,sign){return function bessel(x,n){if(nonzero){if(0===x)return 1===nonzero?-1/0:1/0;if(x<0)return Number.NaN}if(0===n)return bessel0(x);if(1===n)return bessel1(x);if(n<0)return Number.NaN;return _bessel_iter(x,0|n,bessel0(x),bessel1(x),sign)}}BESSEL.besselj=(()=>{const b0_a1a=[-184.9052456,77392.33017,-11214424.18,651619640.7,-13362590354,57568490574],b0_a2a=[1,267.8532712,59272.64853,9494680.718,1029532985,57568490411],b0_a1b=[2.093887211e-7,-2073370639e-15,2734510407e-14,-.001098628627,1],b0_a2b=[-9.34935152e-8,7.621095161e-7,-6911147651e-15,.0001430488765,-.01562499995];function bessel0(x){let a=0,a1=0,a2=0,y=x*x;if(x<8)a1=_horner(b0_a1a,y),a2=_horner(b0_a2a,y),a=a1/a2;else{const xx=x-.785398164;y=64/y,a1=_horner(b0_a1b,y),a2=_horner(b0_a2b,y),a=Math.sqrt(W/x)*(Math.cos(xx)*a1-Math.sin(xx)*a2*8/x)}return a}const b1_a1a=[-30.16036606,15704.4826,-2972611.439,242396853.1,-7895059235,72362614232],b1_a2a=[1,376.9991397,99447.43394,18583304.74,2300535178,144725228442],b1_a1b=[-2.40337019e-7,2457520174e-15,-3516396496e-14,.00183105,1],b1_a2b=[1.05787412e-7,-8.8228987e-7,8449199096e-15,-.0002002690873,.04687499995];function bessel1(x){let a=0,a1=0,a2=0,y=x*x;const xx=Math.abs(x)-2.356194491;return Math.abs(x)<8?(a1=x*_horner(b1_a1a,y),a2=_horner(b1_a2a,y),a=a1/a2):(y=64/y,a1=_horner(b1_a1b,y),a2=_horner(b1_a2b,y),a=Math.sqrt(W/Math.abs(x))*(Math.cos(xx)*a1-Math.sin(xx)*a2*8/Math.abs(x)),x<0&&(a=-a)),a}return function besselj(x,n){const _n=Math.round(n);if(!Number.isFinite(x))return Number.isNaN(x)?x:0;if(_n<0)return(_n%2?-1:1)*besselj(x,-_n);if(x<0)return(_n%2?-1:1)*besselj(-x,_n);if(0===_n)return bessel0(x);if(1===_n)return bessel1(x);if(0===x)return 0;let ret=0;if(x>_n)ret=_bessel_iter(x,_n,bessel0(x),bessel1(x),-1);else{const m=2*Math.floor((_n+Math.floor(Math.sqrt(40*_n)))/2);let jsum=!1,bjp=0,sum=0,bj=1,bjm=0;const tox=2/x;for(let j=m;j>0;j--)if(bjm=j*tox*bj-bjp,bjp=bj,bj=bjm,Math.abs(bj)>1e10&&(bj*=1e-10,bjp*=1e-10,ret*=1e-10,sum*=1e-10),jsum&&(sum+=bj),jsum=!jsum,j===_n&&(ret=bjp),m-j>100&&0===ret)return Number.NaN;sum=2*sum-bj,ret/=sum}return ret}})(),BESSEL.bessely=(()=>{const b0_a1a=[228.4622733,-86327.92757,10879881.29,-512359803.6,7062834065,-2957821389],b0_a2a=[1,226.1030244,47447.2647,7189466.438,745249964.8,40076544269],b0_a1b=[2.093887211e-7,-2073370639e-15,2734510407e-14,-.001098628627,1],b0_a2b=[-9.34945152e-8,7.621095161e-7,-6911147651e-15,.0001430488765,-.01562499995];const b1_a1a=[8511.937935,-4237922.726,734926455.1,-51534381390,127527439e4,-4900604943e3],b1_a2a=[1,354.9632885,102042.605,22459040.02,3733650367,424441966400,249958057e5],b1_a1b=[-2.40337019e-7,2457520174e-15,-3516396496e-14,.00183105,1],b1_a2b=[1.05787412e-7,-8.8228987e-7,8449199096e-15,-.0002002690873,.04687499995];return _bessel_wrap((function bessel0(x){let a=0,a1=0,a2=0,y=x*x;const xx=x-.785398164;return x<8?(a1=_horner(b0_a1a,y),a2=_horner(b0_a2a,y),a=a1/a2+W*BESSEL.besselj(x,0)*Math.log(x)):(y=64/y,a1=_horner(b0_a1b,y),a2=_horner(b0_a2b,y),a=Math.sqrt(W/x)*(Math.sin(xx)*a1+Math.cos(xx)*a2*8/x)),a}),(function bessel1(x){let a=0,a1=0,a2=0,y=x*x;const xx=x-2.356194491;return x<8?(a1=x*_horner(b1_a1a,y),a2=_horner(b1_a2a,y),a=a1/a2+W*(BESSEL.besselj(x,1)*Math.log(x)-1/x)):(y=64/y,a1=_horner(b1_a1b,y),a2=_horner(b1_a2b,y),a=Math.sqrt(W/x)*(Math.sin(xx)*a1+Math.cos(xx)*a2*8/x)),a}),1,-1)})(),BESSEL.besseli=(()=>{const b0_a=[.0045813,.0360768,.2659732,1.2067492,3.0899424,3.5156229,1],b0_b=[.00392377,-.01647633,.02635537,-.02057706,.00916281,-.00157565,.00225319,.01328592,.39894228];const b1_a=[32411e-8,.00301532,.02658733,.15084934,.51498869,.87890594,.5],b1_b=[-.00420059,.01787654,-.02895312,.02282967,-.01031555,.00163801,-.00362018,-.03988024,.39894228];return function besseli(x,n){const _n=Math.round(n);if(0===_n)return function bessel0(x){return x<=3.75?_horner(b0_a,x*x/14.0625):Math.exp(Math.abs(x))/Math.sqrt(Math.abs(x))*_horner(b0_b,3.75/Math.abs(x))}(x);if(1===_n)return function bessel1(x){return x<3.75?x*_horner(b1_a,x*x/14.0625):(x<0?-1:1)*Math.exp(Math.abs(x))/Math.sqrt(Math.abs(x))*_horner(b1_b,3.75/Math.abs(x))}(x);if(_n<0)return Number.NaN;if(0===Math.abs(x))return 0;if(x===1/0)return 1/0;let j,ret=0;const tox=2/Math.abs(x);let bip=0,bi=1,bim=0;const m=2*Math.round((_n+Math.round(Math.sqrt(40*_n)))/2);for(j=m;j>0;j--)if(bim=j*tox*bi+bip,bip=bi,bi=bim,Math.abs(bi)>1e10&&(bi*=1e-10,bip*=1e-10,ret*=1e-10),j===_n&&(ret=bip),m-j>100&&0===ret)return Number.NaN;return ret*=besseli(x,0)/bi,x<0&&_n%2?-ret:ret}})(),BESSEL.besselk=(()=>{const b0_a=[74e-7,1075e-7,.00262698,.0348859,.23069756,.4227842,-.57721566],b0_b=[53208e-8,-.0025154,.00587872,-.01062446,.02189568,-.07832358,1.25331414];const b1_a=[-4686e-8,-.00110404,-.01919402,-.18156897,-.67278579,.15443144,1],b1_b=[-68245e-8,.00325614,-.00780353,.01504268,-.0365562,.23498619,1.25331414];return _bessel_wrap((function bessel0(x){return x<=2?-Math.log(x/2)*BESSEL.besseli(x,0)+_horner(b0_a,x*x/4):Math.exp(-x)/Math.sqrt(x)*_horner(b0_b,2/x)}),(function bessel1(x){return x<=2?Math.log(x/2)*BESSEL.besseli(x,1)+1/x*_horner(b1_a,x*x/4):Math.exp(-x)/Math.sqrt(x)*_horner(b1_b,2/x)}),2,1)})()}(BESSEL||(BESSEL={}));const romanToArabicMap=new Map([["I",1],["V",5],["X",10],["L",50],["C",100],["D",500],["M",1e3]]),arabicToRomanMap=new Map([[1,"I"],[4,"IV"],[5,"V"],[9,"IX"],[10,"X"],[40,"XL"],[45,"VL"],[49,"IL"],[50,"L"],[90,"XC"],[95,"VC"],[99,"IC"],[100,"C"],[400,"CD"],[450,"LD"],[490,"XD"],[495,"VD"],[499,"ID"],[500,"D"],[900,"CM"],[950,"LM"],[990,"XM"],[995,"VM"],[999,"IM"],[1e3,"M"]]),romanFormArray=[[1,4,5,9,10,40,50,90,100,400,500,900,1e3,4e3],[1,4,5,9,10,40,45,50,90,95,100,400,450,500,900,950,1e3,4e3],[1,4,5,9,10,40,45,49,50,90,95,99,100,400,450,490,500,900,950,990,1e3,4e3],[1,4,5,9,10,40,45,49,50,90,95,99,100,400,450,490,495,500,900,950,990,995,1e3,4e3],[1,4,5,9,10,40,45,49,50,90,95,99,100,400,450,490,495,499,500,900,950,990,995,999,1e3,4e3]];function betaCDF(x,alpha,beta){return x<=0?0:x>=1?1:incompleteBetaFunction(x,alpha,beta)}function betaINV(probability,alpha,beta){if(probability<=0)return 0;if(probability>=1)return 1;let x;if(alpha>=1&&beta>=1){const p=probability<.5?probability:1-probability,temp=Math.sqrt(-2*Math.log(p));x=(2.30753+.27061*temp)/(1+temp*(.99229+.04481*temp))-temp,probability<.5&&(x=-x);const temp1=(x*x-3)/6,temp2=2/(1/(2*alpha-1)+1/(2*beta-1)),temp3=x*Math.sqrt(temp1+temp2)/temp2-(1/(2*beta-1)-1/(2*alpha-1))*(temp1+5/6-2/(3*temp2));x=alpha/(alpha+beta*Math.exp(2*temp3))}else{const temp1=Math.exp(alpha*Math.log(alpha/(alpha+beta)))/alpha,temp3=temp1+Math.exp(beta*Math.log(beta/(alpha+beta)))/beta;x=probability<temp1/temp3?(alpha*temp3*probability)**(1/alpha):1-(beta*temp3*(1-probability))**(1/beta)}const betalnNeg=-betaFunctionNaturalLogarithm(alpha,beta);let ibeta,t,u;for(let j=0;j<10;j++){if(0===x||1===x)return x;if(ibeta=incompleteBetaFunction(x,alpha,beta)-probability,t=Math.exp((alpha-1)*Math.log(x)+(beta-1)*Math.log(1-x)+betalnNeg),u=ibeta/t,x-=t=u/(1-.5*Math.min(1,u*((alpha-1)/x-(beta-1)/(1-x)))),x<=0&&(x=.5*(x+t)),x>=1&&(x=.5*(x+t+1)),Math.abs(t)<1e-8*x&&j>0)break}return x}function incompleteBetaFunction(x,alpha,beta){const bt=0===x||1===x?0:Math.exp(gammaln(alpha+beta)-gammaln(alpha)-gammaln(beta)+alpha*Math.log(x)+beta*Math.log(1-x));return x<(alpha+1)/(alpha+beta+2)?bt*betaContinuedFraction(x,alpha,beta)/alpha:1-bt*betaContinuedFraction(1-x,beta,alpha)/beta}function betaContinuedFraction(x,alpha,beta){let d=1-(alpha+beta)*x/(alpha+1);Math.abs(d)<1e-8&&(d=1e-8),d=1/d;let c=1,h=d;for(let m=1;m<=100;m++){let temp=m*(beta-m)*x/((alpha-1+2*m)*(alpha+2*m));if(d=1+temp*d,Math.abs(d)<1e-8&&(d=1e-8),c=1+temp/c,Math.abs(c)<1e-8&&(c=1e-8),d=1/d,h*=d*c,temp=-(alpha+m)*(alpha+beta+m)*x/((alpha+2*m)*(alpha+1+2*m)),d=1+temp*d,Math.abs(d)<1e-8&&(d=1e-8),c=1+temp/c,Math.abs(c)<1e-8&&(c=1e-8),d=1/d,h*=d*c,Math.abs(d*c-1)<1e-8)break}return h}function betaFunction(alpha,beta){return alpha+beta>170?Math.exp(betaFunctionNaturalLogarithm(alpha,beta)):gamma(alpha)*gamma(beta)/gamma(alpha+beta)}function betaFunctionNaturalLogarithm(alpha,beta){return gammaln(alpha)+gammaln(beta)-gammaln(alpha+beta)}function binomialCDF(x,trials,probability){if(x<0)return 0;if(x>=trials)return 1;if(probability<0||probability>1||trials<=0)return Number.NaN;let result=0;for(let i=0;i<=x;i++)result+=binomialPDF(i,trials,probability);return result}function binomialPDF(x,trials,probability){return 0===probability||1===probability?trials*probability===x?1:0:calculateCombin(trials,x)*probability**x*(1-probability)**(trials-x)}function chisquareCDF(x,degFreedom){return x<=0?0:lowRegGamma(degFreedom/2,x/2)}function chisquareINV(probability,degFreedom){return probability<=0?0:probability>=1?1/0:2*lowRegGammaInverse(probability,degFreedom/2)}function centralFCDF(x,degFreedom1,degFreedom2){return x<0?0:incompleteBetaFunction(degFreedom1*x/(degFreedom1*x+degFreedom2),degFreedom1/2,degFreedom2/2)}function centralFINV(probability,degFreedom1,degFreedom2){return probability<=0?0:probability>=1?1/0:degFreedom2/(degFreedom1*(1/betaINV(probability,degFreedom1/2,degFreedom2/2)-1))}function forecastLinear(x,knownYs,knownXs){const n=knownYs.length;let knownYsSum=0,knownXsSum=0;for(let i=0;i<n;i++)knownYsSum+=knownYs[i],knownXsSum+=knownXs[i];const knownYsMean=knownYsSum/n,knownXsMean=knownXsSum/n;let num=0,den=0;for(let i=0;i<n;i++)num+=(knownYs[i]-knownYsMean)*(knownXs[i]-knownXsMean),den+=(knownXs[i]-knownXsMean)**2;if(0===den)return 1/0;const b=num/den;return knownYsMean-b*knownXsMean+b*x}function gamma(x){const p=[-1.716185138865495,24.76565080557592,-379.80425647094563,629.3311553128184,866.9662027904133,-31451.272968848367,-36144.413418691176,66456.14382024054],q=[-30.8402300119739,315.35062697960416,-1015.1563674902192,-3107.771671572311,22538.11842098015,4755.846277527881,-134659.9598649693,-115132.2596755535];let fact=0,y=x;if(x>171.6243769536076)return 1/0;if(y<=0){const resMod=y%1+36e-17;if(!resMod)return 1/0;fact=(1&y?-1:1)*Math.PI/Math.sin(Math.PI*resMod),y=1-y}const yi=y;let z,n=0;z=y<1?y++:(y-=n=(0|y)-1)-1;let xnum=0,xden=0;for(let i=0;i<8;++i)xnum=(xnum+p[i])*z,xden=xden*z+q[i];let res=xnum/xden+1;if(yi<y)res/=yi;else if(yi>y)for(let i=0;i<n;++i)res*=y,y++;return fact&&(res=fact/res),res}function gammaln(x){const coefficients=[76.18009172947146,-86.50532032941678,24.01409824083091,-1.231739572450155,.001208650973866179,-5395239384953e-18];let y=x,tmp=x+5.5;tmp-=(x+.5)*Math.log(tmp);let ser=1.000000000190015;for(let j=0;j<6;j++)ser+=coefficients[j]/++y;return-tmp+Math.log(2.5066282746310007*ser/x)}function lowRegGamma(a,x){if(x<0||a<=0)return Number.NaN;const MAX_ITER=-~(8.5*Math.log(a>=1?a:1/a)+.4*a+17),aln=gammaln(a),exp=Math.exp(-x+a*Math.log(x)-aln);let _a=a,sum=1/a,del=sum;if(x<a+1){if(0===exp)return 0;for(let i=1;i<=MAX_ITER&&(sum+=del*=x/++_a,!(Math.abs(del)<1e-30*Math.abs(sum)));i++);return sum*exp}if(0===exp)return 1;let b=x+1-a,c=1/1e-30,d=1/b,h=d;for(let i=1;i<=MAX_ITER;i++){const temp=-i*(i-a);if(b+=2,d=temp*d+b,Math.abs(d)<1e-30&&(d=1e-30),c=b+temp/c,Math.abs(c)<1e-30&&(c=1e-30),d=1/d,h*=d*c,Math.abs(d*c-1)<1e-30)break}return 1-h*exp}function lowRegGammaInverse(p,a){if(p<=0)return 0;if(p>=1)return Math.max(100,a+100*Math.sqrt(a));let x;if(a>1){const _p=p<.5?p:1-p,temp=Math.sqrt(-2*Math.log(_p));x=(2.30753+.27061*temp)/(1+temp*(.99229+.04481*temp))-temp,p<.5&&(x=-x),x=Math.max(.001,a*(1-1/(9*a)-x/(3*Math.sqrt(a)))**3)}else{const temp=1-a*(.253+.12*a);x=p<temp?(p/temp)**(1/a):1-Math.log(1-(p-temp)/(1-temp))}const aln=gammaln(a);let err,t;for(let j=0;j<12;j++){if(x<=0)return 0;if(err=lowRegGamma(a,x)-p,t=a>1?Math.exp((a-1)*(Math.log(a-1)-1)-aln)*Math.exp(-(x-(a-1))+(a-1)*(Math.log(x)-Math.log(a-1))):Math.exp(-x+(a-1)*Math.log(x)-aln),0!==t&&(t=err/t/(1-.5*Math.min(1,err/t*((a-1)/x-1)))),x-=t,x<=0&&(x=.5*(x+t)),Math.abs(t)<1e-8*x)break}return x}function hypergeometricPDF(x,n,M,N){return n-x>N-M?0:calculateCombin(M,x)*calculateCombin(N-M,n-x)/calculateCombin(N,n)}function lognormalCDF(x,mean,standardDev){return x<0?0:.5+.5*erf((Math.log(x)-mean)/Math.sqrt(2*standardDev*standardDev))}function negbinomialPDF(numberF,numberS,probabilityS){return numberF<0?0:calculateCombin(numberF+numberS-1,numberS-1)*probabilityS**numberS*(1-probabilityS)**numberF}function normalCDF(x,mean,standardDev){return.5*(1+erf((x-mean)/Math.sqrt(2*standardDev*standardDev)))}function normalPDF(x,mean,standardDev){return Math.exp(-.5*Math.log(2*Math.PI)-Math.log(standardDev)-(x-mean)**2/(2*standardDev*standardDev))}function normalINV(probability,mean,standardDev){return-1.4142135623730951*standardDev*function erfcINV(p){if(p>=2)return-100;if(p<=0)return 100;const _p=p<1?p:2-p,temp=Math.sqrt(-2*Math.log(_p/2));let x=-.70711*((2.30753+.27061*temp)/(1+temp*(.99229+.04481*temp))-temp);for(let j=0;j<2;j++){const err=erfc(x)-_p;x+=err/(1.1283791670955126*Math.exp(-x*x)-x*err)}return p<1?x:-x}(2*probability)+mean}function poissonPDF(x,mean){return Math.exp(-mean)*mean**x/calculateFactorial(x)}function studentTCDF(x,degFreedom){const result=.5*incompleteBetaFunction(degFreedom/(x**2+degFreedom),degFreedom/2,.5);return x<0?result:1-result}function studentTINV(probability,degFreedom){let x=betaINV(2*Math.min(probability,1-probability),.5*degFreedom,.5);return x=Math.sqrt(degFreedom*(1-x)/x),probability>.5?x:-x}function getTwoArrayNumberValues(array1,array2,count,array1ColumnCount,array2ColumnCount){const array1Values=[],array2Values=[];let noCalculate=!0;for(let i=0;i<count;i++){const array1RowIndex=Math.floor(i/array1ColumnCount),array1ColumnIndex=i%array1ColumnCount,array2RowIndex=Math.floor(i/array2ColumnCount),array2ColumnIndex=i%array2ColumnCount,array1Object=array1.isArray()?array1.get(array1RowIndex,array1ColumnIndex):array1,array2Object=array2.isArray()?array2.get(array2RowIndex,array2ColumnIndex):array2;if(array1Object.isError())return{isError:!0,errorObject:array1Object,array1Values,array2Values,noCalculate};if(array2Object.isError())return{isError:!0,errorObject:array2Object,array1Values,array2Values,noCalculate};if(array1Object.isNull()||array2Object.isNull()||array1Object.isBoolean()||array2Object.isBoolean())continue;const array1Value=array1Object.getValue(),array2Value=array2Object.getValue();(0,src.DMQ)(array1Value)&&(0,src.DMQ)(array2Value)&&(array1Values.push(+array1Value),array2Values.push(+array2Value),noCalculate=!1)}return{isError:!1,errorObject:null,array1Values,array2Values,noCalculate}}function checkKnownsArrayDimensions(knownYs,knownXs,newXs){const knownYsRowCount=knownYs.isArray()?knownYs.getRowCount():1,knownYsColumnCount=knownYs.isArray()?knownYs.getColumnCount():1;let knownXsRowCount=knownYsRowCount,knownXsColumnCount=knownYsColumnCount;if(knownXs&&!knownXs.isNull()&&(knownXsRowCount=knownXs.isArray()?knownXs.getRowCount():1,knownXsColumnCount=knownXs.isArray()?knownXs.getColumnCount():1,1===knownYsRowCount&&knownXsColumnCount!==knownYsColumnCount||1===knownYsColumnCount&&knownXsRowCount!==knownYsRowCount||1!==knownYsRowCount&&1!==knownYsColumnCount&&(knownXsRowCount!==knownYsRowCount||knownXsColumnCount!==knownYsColumnCount)))return{isError:!0,errorObject:ErrorValueObject.create(error_type_ErrorType.REF)};if(newXs&&!newXs.isNull()){const newXsRowCount=newXs.isArray()?newXs.getRowCount():1,newXsColumnCount=newXs.isArray()?newXs.getColumnCount():1;if(1===knownYsRowCount&&knownXsRowCount>1&&newXsRowCount!==knownXsRowCount||1===knownYsColumnCount&&knownXsColumnCount>1&&newXsColumnCount!==knownXsColumnCount)return{isError:!0,errorObject:ErrorValueObject.create(error_type_ErrorType.REF)}}return{isError:!1,errorObject:null}}function getKnownsArrayValues(array){const rowCount=array.isArray()?array.getRowCount():1,columnCount=array.isArray()?array.getColumnCount():1,values=[];for(let r=0;r<rowCount;r++){values[r]=[];for(let c=0;c<columnCount;c++){const valueObject=array.isArray()?array.get(r,c):array;if(valueObject.isError()||valueObject.isNull()||valueObject.isBoolean()||valueObject.isString())return ErrorValueObject.create(error_type_ErrorType.VALUE);values[r].push(+valueObject.getValue())}}return values}function getSerialNumbersByRowsColumns(rowCount,columnCount){const values=[];let n=1;for(let r=0;r<rowCount;r++){values[r]=[];for(let c=0;c<columnCount;c++)values[r].push(n++)}return values}function getSlopeAndIntercept(knownXsValues,knownYsValues,constb,isExponentialTransform){let slope,intercept,Y=knownYsValues;return isExponentialTransform&&(Y=knownYsValues.map((value=>Math.log(value)))),({slope,intercept}=constb?function getSlopeAndInterceptOfConstbIsTrue(knownXsValues,knownYsValues){const n=knownYsValues.length;let sumX=0,sumY=0,sumX2=0,sumXY=0;for(let i=0;i<n;i++)sumX+=knownXsValues[i],sumY+=knownYsValues[i],sumX2+=knownXsValues[i]*knownXsValues[i],sumXY+=knownXsValues[i]*knownYsValues[i];const slope=(n*sumXY-sumX*sumY)/(n*sumX2-sumX*sumX),intercept=1/n*sumY-slope*(1/n)*sumX;return{slope,intercept}}(knownXsValues,Y):function getSlopeAndInterceptOfConstbIsFalse(knownXsValues,knownYsValues){const matrixX=[[...knownXsValues]],matrixY=[...knownYsValues];let rowCount=matrixX.length,columnCount=matrixX[0].length,minCount=Math.min(rowCount,columnCount);const newMatrix=new Array(minCount).fill(0);for(let i=0;i<minCount;i++){const matrixXRow=matrixX[i];let sumSquare=0;for(let j=0;j<columnCount;j++)sumSquare+=matrixXRow[j]**2;const value=matrixXRow[i]<0?Math.sqrt(sumSquare):-Math.sqrt(sumSquare);if(newMatrix[i]=value,0!==value){matrixXRow[i]-=value;for(let j=i+1;j<rowCount;j++){let sum=0;for(let k=i;k<columnCount;k++)sum-=matrixX[j][k]*matrixXRow[k];sum/=value*matrixXRow[i];for(let k=i;k<columnCount;k++)matrixX[j][k]-=sum*matrixXRow[k]}}}rowCount=matrixX.length,columnCount=matrixX[0].length,minCount=Math.min(rowCount,columnCount);const result=new Array(rowCount).fill(0);for(let i=0;i<minCount;i++){const matrixXRow=matrixX[i];let sum=0;for(let j=0;j<columnCount;j++)sum+=matrixY[j]*matrixXRow[j];sum/=newMatrix[i]*matrixXRow[i];for(let j=0;j<columnCount;j++)matrixY[j]+=sum*matrixXRow[j]}for(let i=newMatrix.length-1;i>=0;i--){matrixY[i]/=newMatrix[i];const temp=matrixY[i],matrixXRow=matrixX[i];result[i]=temp;for(let j=0;j<i;j++)matrixY[j]-=temp*matrixXRow[j]}return{slope:result[0],intercept:0}}(knownXsValues,Y)),isExponentialTransform&&(slope=Math.exp(slope),intercept=Math.exp(intercept)),Number.isNaN(slope)&&!constb&&(slope=0),{slope,intercept,Y}}function getKnownsArrayCoefficients(knownYsValues,knownXsValues,newXsValues,constb,isExponentialTransform){const isOneRow=1===knownYsValues.length&&knownYsValues[0].length>1;let Y=knownYsValues;isExponentialTransform&&(Y=knownYsValues.map((row=>row.map((value=>Math.log(value))))));let X=knownXsValues,newX=newXsValues;isOneRow&&(Y=matrixTranspose(Y),X=matrixTranspose(X),newX=matrixTranspose(newX)),constb&&(X=X.map((row=>[...row,1])));const XT=matrixTranspose(X),XTX=calculateMmult(XT,X),XTY=calculateMmult(XT,Y);let XTXInverse=inverseMatrixByLUD(XTX);if(!XTXInverse&&(XTXInverse=inverseMatrixByUSV(XTX),!XTXInverse))return ErrorValueObject.create(error_type_ErrorType.NA);let coefficients=calculateMmult(XTXInverse,XTY);constb||coefficients.push([0]),coefficients=matrixTranspose(coefficients);const pop=coefficients[0].pop();if(coefficients[0].reverse(),coefficients[0].push(pop),isExponentialTransform)for(let i=0;i<coefficients[0].length;i++)coefficients[0][i]=Math.exp(coefficients[0][i]);return{coefficients,Y,X,newX,XTXInverse}}class BetaInv extends base_function_BaseFunction{calculate(probability,alpha,beta,A,B){let _A=A??NumberValueObject.create(0),_B=B??NumberValueObject.create(1);_A.isNull()&&(_A=NumberValueObject.create(0)),_B.isNull()&&(_B=NumberValueObject.create(1));const maxRowLength=Math.max(probability.isArray()?probability.getRowCount():1,alpha.isArray()?alpha.getRowCount():1,beta.isArray()?beta.getRowCount():1,_A.isArray()?_A.getRowCount():1,_B.isArray()?_B.getRowCount():1),maxColumnLength=Math.max(probability.isArray()?probability.getColumnCount():1,alpha.isArray()?alpha.getColumnCount():1,beta.isArray()?beta.getColumnCount():1,_A.isArray()?_A.getColumnCount():1,_B.isArray()?_B.getColumnCount():1),probabilityArray=expandArrayValueObject(maxRowLength,maxColumnLength,probability,ErrorValueObject.create(error_type_ErrorType.NA)),alphaArray=expandArrayValueObject(maxRowLength,maxColumnLength,alpha,ErrorValueObject.create(error_type_ErrorType.NA)),betaArray=expandArrayValueObject(maxRowLength,maxColumnLength,beta,ErrorValueObject.create(error_type_ErrorType.NA)),AArray=expandArrayValueObject(maxRowLength,maxColumnLength,_A,ErrorValueObject.create(error_type_ErrorType.NA)),BArray=expandArrayValueObject(maxRowLength,maxColumnLength,_B,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=probabilityArray.mapValue(((probabilityObject,rowIndex,columnIndex)=>{const alphaObject=alphaArray.get(rowIndex,columnIndex),betaObject=betaArray.get(rowIndex,columnIndex),AObject=AArray.get(rowIndex,columnIndex),BObject=BArray.get(rowIndex,columnIndex);return this._handleSignleObject(probabilityObject,alphaObject,betaObject,AObject,BObject)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_handleSignleObject(probabilityObject,alphaObject,betaObject,AObject,BObject){if(probabilityObject.isError())return probabilityObject;if(alphaObject.isError())return alphaObject;if(betaObject.isError())return betaObject;if(AObject.isError())return AObject;if(BObject.isError())return BObject;const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(probabilityObject,alphaObject,betaObject,AObject,BObject);if(isError)return errorObject;const[_probabilityObject,_alphaObject,_betaObject,_AObject,_BObject]=variants,probabilityValue=+_probabilityObject.getValue(),alphaValue=+_alphaObject.getValue(),betaValue=+_betaObject.getValue(),AValue=+_AObject.getValue(),BValue=+_BObject.getValue();if(alphaValue<=0||betaValue<=0||probabilityValue<=0||probabilityValue>=1||AValue>=BValue)return ErrorValueObject.create(error_type_ErrorType.NUM);const result=betaINV(probabilityValue,alphaValue,betaValue)*(BValue-AValue)+AValue;return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=3,this.maxParams=5}}class BinomDist extends base_function_BaseFunction{calculate(numberS,trials,probabilityS,cumulative){const maxRowLength=Math.max(numberS.isArray()?numberS.getRowCount():1,trials.isArray()?trials.getRowCount():1,probabilityS.isArray()?probabilityS.getRowCount():1,cumulative.isArray()?cumulative.getRowCount():1),maxColumnLength=Math.max(numberS.isArray()?numberS.getColumnCount():1,trials.isArray()?trials.getColumnCount():1,probabilityS.isArray()?probabilityS.getColumnCount():1,cumulative.isArray()?cumulative.getColumnCount():1),numberSArray=expandArrayValueObject(maxRowLength,maxColumnLength,numberS,ErrorValueObject.create(error_type_ErrorType.NA)),trialsArray=expandArrayValueObject(maxRowLength,maxColumnLength,trials,ErrorValueObject.create(error_type_ErrorType.NA)),probabilitySArray=expandArrayValueObject(maxRowLength,maxColumnLength,probabilityS,ErrorValueObject.create(error_type_ErrorType.NA)),cumulativeArray=expandArrayValueObject(maxRowLength,maxColumnLength,cumulative,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=numberSArray.mapValue(((numberSObject,rowIndex,columnIndex)=>{const trialsObject=trialsArray.get(rowIndex,columnIndex),probabilitySObject=probabilitySArray.get(rowIndex,columnIndex),cumulativeObject=cumulativeArray.get(rowIndex,columnIndex);return numberSObject.isError()?numberSObject:trialsObject.isError()?trialsObject:probabilitySObject.isError()?probabilitySObject:cumulativeObject.isError()?cumulativeObject:this._handleSignleObject(numberSObject,trialsObject,probabilitySObject,cumulativeObject)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_handleSignleObject(numberSObject,trialsObject,probabilitySObject,cumulativeObject){const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(numberSObject,trialsObject,probabilitySObject,cumulativeObject);if(isError)return errorObject;const[_numberSObject,_trialsObject,_probabilitySObject,_cumulativeObject]=variants,numberSValue=Math.floor(+_numberSObject.getValue()),trialsValue=Math.floor(+_trialsObject.getValue()),probabilitySValue=+_probabilitySObject.getValue(),cumulativeValue=+_cumulativeObject.getValue();if(numberSValue<0||numberSValue>trialsValue||probabilitySValue<0||probabilitySValue>1)return ErrorValueObject.create(error_type_ErrorType.NUM);let result;return result=cumulativeValue?binomialCDF(numberSValue,trialsValue,probabilitySValue):binomialPDF(numberSValue,trialsValue,probabilitySValue),NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=4,this.maxParams=4}}class BinomInv extends base_function_BaseFunction{calculate(trials,probabilityS,alpha){const maxRowLength=Math.max(trials.isArray()?trials.getRowCount():1,probabilityS.isArray()?probabilityS.getRowCount():1,alpha.isArray()?alpha.getRowCount():1),maxColumnLength=Math.max(trials.isArray()?trials.getColumnCount():1,probabilityS.isArray()?probabilityS.getColumnCount():1,alpha.isArray()?alpha.getColumnCount():1),trialsArray=expandArrayValueObject(maxRowLength,maxColumnLength,trials,ErrorValueObject.create(error_type_ErrorType.NA)),probabilitySArray=expandArrayValueObject(maxRowLength,maxColumnLength,probabilityS,ErrorValueObject.create(error_type_ErrorType.NA)),alphaArray=expandArrayValueObject(maxRowLength,maxColumnLength,alpha,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=trialsArray.mapValue(((trialsObject,rowIndex,columnIndex)=>{const probabilitySObject=probabilitySArray.get(rowIndex,columnIndex),alphaObject=alphaArray.get(rowIndex,columnIndex);return trialsObject.isError()?trialsObject:probabilitySObject.isError()?probabilitySObject:alphaObject.isError()?alphaObject:this._handleSignleObject(trialsObject,probabilitySObject,alphaObject)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_handleSignleObject(trialsObject,probabilitySObject,alphaObject){const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(trialsObject,probabilitySObject,alphaObject);if(isError)return errorObject;const[_trialsObject,_probabilitySObject,_alphaObject]=variants,trialsValue=Math.floor(+_trialsObject.getValue()),probabilitySValue=+_probabilitySObject.getValue(),alphaValue=+_alphaObject.getValue();if(trialsValue<0||probabilitySValue<=0||probabilitySValue>=1||alphaValue<=0||alphaValue>=1)return ErrorValueObject.create(error_type_ErrorType.NUM);let result=0;for(;result<=trialsValue&&!(binomialCDF(result,trialsValue,probabilitySValue)>=alphaValue);)result++;return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=3,this.maxParams=3}}class ChisqDistRt extends base_function_BaseFunction{calculate(x,degFreedom){const maxRowLength=Math.max(x.isArray()?x.getRowCount():1,degFreedom.isArray()?degFreedom.getRowCount():1),maxColumnLength=Math.max(x.isArray()?x.getColumnCount():1,degFreedom.isArray()?degFreedom.getColumnCount():1),xArray=expandArrayValueObject(maxRowLength,maxColumnLength,x,ErrorValueObject.create(error_type_ErrorType.NA)),degFreedomArray=expandArrayValueObject(maxRowLength,maxColumnLength,degFreedom,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=xArray.mapValue(((xObject,rowIndex,columnIndex)=>{const degFreedomObject=degFreedomArray.get(rowIndex,columnIndex);return xObject.isError()?xObject:degFreedomObject.isError()?degFreedomObject:this._handleSignleObject(xObject,degFreedomObject)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_handleSignleObject(xObject,degFreedomObject){const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(xObject,degFreedomObject);if(isError)return errorObject;const[_xObject,_degFreedomObject]=variants,xValue=+_xObject.getValue(),degFreedomValue=Math.floor(+_degFreedomObject.getValue());if(xValue<0||degFreedomValue<1||degFreedomValue>10**10)return ErrorValueObject.create(error_type_ErrorType.NUM);const result=1-chisquareCDF(xValue,degFreedomValue);return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}}class ChisqInvRt extends base_function_BaseFunction{calculate(probability,degFreedom){const maxRowLength=Math.max(probability.isArray()?probability.getRowCount():1,degFreedom.isArray()?degFreedom.getRowCount():1),maxColumnLength=Math.max(probability.isArray()?probability.getColumnCount():1,degFreedom.isArray()?degFreedom.getColumnCount():1),probabilityArray=expandArrayValueObject(maxRowLength,maxColumnLength,probability,ErrorValueObject.create(error_type_ErrorType.NA)),degFreedomArray=expandArrayValueObject(maxRowLength,maxColumnLength,degFreedom,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=probabilityArray.mapValue(((probabilityObject,rowIndex,columnIndex)=>{const degFreedomObject=degFreedomArray.get(rowIndex,columnIndex);return probabilityObject.isError()?probabilityObject:degFreedomObject.isError()?degFreedomObject:this._handleSignleObject(probabilityObject,degFreedomObject)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_handleSignleObject(probabilityObject,degFreedomObject){const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(probabilityObject,degFreedomObject);if(isError)return errorObject;const[_probabilityObject,_degFreedomObject]=variants,probabilityValue=+_probabilityObject.getValue(),degFreedomValue=Math.floor(+_degFreedomObject.getValue());if(probabilityValue<0||probabilityValue>1||degFreedomValue<1||degFreedomValue>10**10)return ErrorValueObject.create(error_type_ErrorType.NUM);const result=chisquareINV(1-probabilityValue,degFreedomValue);return Number.isNaN(result)||!Number.isFinite(result)?ErrorValueObject.create(error_type_ErrorType.NUM):NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}}class ChisqTest extends base_function_BaseFunction{calculate(actualRange,expectedRange){const actualRangeRowCount=actualRange.isArray()?actualRange.getRowCount():1,actualRangeColumnCount=actualRange.isArray()?actualRange.getColumnCount():1,expectedRangeRowCount=expectedRange.isArray()?expectedRange.getRowCount():1,expectedRangeColumnCount=expectedRange.isArray()?expectedRange.getColumnCount():1;let _actualRange=actualRange;if(actualRange.isArray()&&1===actualRangeRowCount&&1===actualRangeColumnCount&&(_actualRange=actualRange.get(0,0)),_actualRange.isError())return _actualRange;let _expectedRange=expectedRange;if(expectedRange.isArray()&&1===expectedRangeRowCount&&1===expectedRangeColumnCount&&(_expectedRange=expectedRange.get(0,0)),_expectedRange.isError())return _expectedRange;if(actualRangeRowCount*actualRangeColumnCount==1||expectedRangeRowCount*expectedRangeColumnCount==1)return _actualRange.isNull()||_expectedRange.isNull()?ErrorValueObject.create(error_type_ErrorType.VALUE):ErrorValueObject.create(error_type_ErrorType.NA);if(actualRangeRowCount*actualRangeColumnCount!=expectedRangeRowCount*expectedRangeColumnCount)return ErrorValueObject.create(error_type_ErrorType.NA);const{isError,errorObject,array1Values,array2Values,noCalculate}=getTwoArrayNumberValues(actualRange,expectedRange,actualRangeRowCount*actualRangeColumnCount,actualRangeColumnCount,expectedRangeColumnCount);return isError?errorObject:noCalculate?ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO):this._getResult(array1Values,array2Values,actualRangeRowCount,actualRangeColumnCount)}_getResult(actualRangeValues,expectedRangeValues,actualRangeRowCount,actualRangeColumnCount){let sumxmy2=0;for(let i=0;i<actualRangeValues.length;i++){if(0===expectedRangeValues[i])return ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO);sumxmy2+=(actualRangeValues[i]-expectedRangeValues[i])**2/expectedRangeValues[i]}let df=(actualRangeRowCount-1)*(actualRangeColumnCount-1);1===actualRangeRowCount?df=actualRangeColumnCount-1:1===actualRangeColumnCount&&(df=actualRangeRowCount-1);const result=1-chisquareCDF(sumxmy2,df);return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}}class ConfidenceNorm extends base_function_BaseFunction{calculate(alpha,standardDev,size){const maxRowLength=Math.max(alpha.isArray()?alpha.getRowCount():1,standardDev.isArray()?standardDev.getRowCount():1,size.isArray()?size.getRowCount():1),maxColumnLength=Math.max(alpha.isArray()?alpha.getColumnCount():1,standardDev.isArray()?standardDev.getColumnCount():1,size.isArray()?size.getColumnCount():1),alphaArray=expandArrayValueObject(maxRowLength,maxColumnLength,alpha,ErrorValueObject.create(error_type_ErrorType.NA)),standardDevArray=expandArrayValueObject(maxRowLength,maxColumnLength,standardDev,ErrorValueObject.create(error_type_ErrorType.NA)),sizeArray=expandArrayValueObject(maxRowLength,maxColumnLength,size,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=alphaArray.mapValue(((alphaObject,rowIndex,columnIndex)=>{const standardDevObject=standardDevArray.get(rowIndex,columnIndex),sizeObject=sizeArray.get(rowIndex,columnIndex);if(alphaObject.isError())return alphaObject;if(standardDevObject.isError())return standardDevObject;if(sizeObject.isError())return sizeObject;const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(alphaObject,standardDevObject,sizeObject);if(isError)return errorObject;const[_alphaObject,_standardDevObject,_sizeObject]=variants,alphaValue=+_alphaObject.getValue(),standardDevValue=+_standardDevObject.getValue(),sizeValue=Math.floor(+_sizeObject.getValue());if(alphaValue<=0||alphaValue>=1||standardDevValue<=0||sizeValue<1)return ErrorValueObject.create(error_type_ErrorType.NUM);const result=Math.abs(normalINV(alphaValue/2,0,1)*standardDevValue/Math.sqrt(sizeValue));return NumberValueObject.create(result)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}constructor(...args){super(...args),this.minParams=3,this.maxParams=3}}class CovarianceP extends base_function_BaseFunction{calculate(array1,array2){const array1RowCount=array1.isArray()?array1.getRowCount():1,array1ColumnCount=array1.isArray()?array1.getColumnCount():1,array2RowCount=array2.isArray()?array2.getRowCount():1,array2ColumnCount=array2.isArray()?array2.getColumnCount():1;let _array1=array1;if(array1.isArray()&&1===array1RowCount&&1===array1ColumnCount&&(_array1=array1.get(0,0)),_array1.isError())return _array1;let _array2=array2;if(array2.isArray()&&1===array2RowCount&&1===array2ColumnCount&&(_array2=array2.get(0,0)),_array2.isError())return _array2;if((array1RowCount*array1ColumnCount==1||array2RowCount*array2ColumnCount==1)&&(_array1.isNull()||_array2.isNull()))return ErrorValueObject.create(error_type_ErrorType.VALUE);if(array1RowCount*array1ColumnCount!=array2RowCount*array2ColumnCount)return ErrorValueObject.create(error_type_ErrorType.NA);const{isError,errorObject,array1Values,array2Values,noCalculate}=getTwoArrayNumberValues(array1,array2,array1RowCount*array1ColumnCount,array1ColumnCount,array2ColumnCount);return isError?errorObject:noCalculate?ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO):this._getResult(array1Values,array2Values)}_getResult(array1Values,array2Values){if(0===array1Values.length)return ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO);const n=array1Values.length;let array1Sum=0,array2Sum=0;for(let i=0;i<n;i++)array1Sum+=array1Values[i],array2Sum+=array2Values[i];const array1Mean=array1Sum/n,array2Mean=array2Sum/n;let numerator=0;for(let i=0;i<n;i++){numerator+=(array1Values[i]-array1Mean)*(array2Values[i]-array2Mean)}return NumberValueObject.create(numerator/n)}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}}class ExponDist extends base_function_BaseFunction{calculate(x,lambda,cumulative){const maxRowLength=Math.max(x.isArray()?x.getRowCount():1,lambda.isArray()?lambda.getRowCount():1,cumulative.isArray()?cumulative.getRowCount():1),maxColumnLength=Math.max(x.isArray()?x.getColumnCount():1,lambda.isArray()?lambda.getColumnCount():1,cumulative.isArray()?cumulative.getColumnCount():1),xArray=expandArrayValueObject(maxRowLength,maxColumnLength,x,ErrorValueObject.create(error_type_ErrorType.NA)),lambdaArray=expandArrayValueObject(maxRowLength,maxColumnLength,lambda,ErrorValueObject.create(error_type_ErrorType.NA)),cumulativeArray=expandArrayValueObject(maxRowLength,maxColumnLength,cumulative,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=xArray.mapValue(((xObject,rowIndex,columnIndex)=>{const lambdaObject=lambdaArray.get(rowIndex,columnIndex),cumulativeObject=cumulativeArray.get(rowIndex,columnIndex);return xObject.isError()?xObject:lambdaObject.isError()?lambdaObject:cumulativeObject.isError()?cumulativeObject:this._handleSignleObject(xObject,lambdaObject,cumulativeObject)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_handleSignleObject(xObject,lambdaObject,cumulativeObject){const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(xObject,lambdaObject,cumulativeObject);if(isError)return errorObject;const[_xObject,_lambdaObject,_cumulativeObject]=variants,xValue=+_xObject.getValue(),lambdaValue=+_lambdaObject.getValue(),cumulativeValue=+_cumulativeObject.getValue();if(xValue<0||lambdaValue<=0)return ErrorValueObject.create(error_type_ErrorType.NUM);let result;return result=cumulativeValue?function exponentialCDF(x,lambda){return x<0?0:1-Math.exp(-lambda*x)}(xValue,lambdaValue):function exponentialPDF(x,lambda){return x<0?0:lambda*Math.exp(-lambda*x)}(xValue,lambdaValue),NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=3,this.maxParams=3}}class FDistRt extends base_function_BaseFunction{calculate(x,degFreedom1,degFreedom2){const maxRowLength=Math.max(x.isArray()?x.getRowCount():1,degFreedom1.isArray()?degFreedom1.getRowCount():1,degFreedom2.isArray()?degFreedom2.getRowCount():1),maxColumnLength=Math.max(x.isArray()?x.getColumnCount():1,degFreedom1.isArray()?degFreedom1.getColumnCount():1,degFreedom2.isArray()?degFreedom2.getColumnCount():1),xArray=expandArrayValueObject(maxRowLength,maxColumnLength,x,ErrorValueObject.create(error_type_ErrorType.NA)),degFreedom1Array=expandArrayValueObject(maxRowLength,maxColumnLength,degFreedom1,ErrorValueObject.create(error_type_ErrorType.NA)),degFreedom2Array=expandArrayValueObject(maxRowLength,maxColumnLength,degFreedom2,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=xArray.mapValue(((xObject,rowIndex,columnIndex)=>{const degFreedom1Object=degFreedom1Array.get(rowIndex,columnIndex),degFreedom2Object=degFreedom2Array.get(rowIndex,columnIndex);return xObject.isError()?xObject:degFreedom1Object.isError()?degFreedom1Object:degFreedom2Object.isError()?degFreedom2Object:this._handleSignleObject(xObject,degFreedom1Object,degFreedom2Object)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_handleSignleObject(xObject,degFreedom1Object,degFreedom2Object){const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(xObject,degFreedom1Object,degFreedom2Object);if(isError)return errorObject;const[_xObject,_degFreedom1Object,_degFreedom2Object]=variants,xValue=+_xObject.getValue(),degFreedom1Value=Math.floor(+_degFreedom1Object.getValue()),degFreedom2Value=Math.floor(+_degFreedom2Object.getValue());if(xValue<0||degFreedom1Value<1||degFreedom1Value>10**10||degFreedom2Value<1||degFreedom2Value>10**10)return ErrorValueObject.create(error_type_ErrorType.NUM);const result=1-centralFCDF(xValue,degFreedom1Value,degFreedom2Value);return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=3,this.maxParams=3}}class FInvRt extends base_function_BaseFunction{calculate(probability,degFreedom1,degFreedom2){const maxRowLength=Math.max(probability.isArray()?probability.getRowCount():1,degFreedom1.isArray()?degFreedom1.getRowCount():1,degFreedom2.isArray()?degFreedom2.getRowCount():1),maxColumnLength=Math.max(probability.isArray()?probability.getColumnCount():1,degFreedom1.isArray()?degFreedom1.getColumnCount():1,degFreedom2.isArray()?degFreedom2.getColumnCount():1),probabilityArray=expandArrayValueObject(maxRowLength,maxColumnLength,probability,ErrorValueObject.create(error_type_ErrorType.NA)),degFreedom1Array=expandArrayValueObject(maxRowLength,maxColumnLength,degFreedom1,ErrorValueObject.create(error_type_ErrorType.NA)),degFreedom2Array=expandArrayValueObject(maxRowLength,maxColumnLength,degFreedom2,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=probabilityArray.mapValue(((probabilityObject,rowIndex,columnIndex)=>{const degFreedom1Object=degFreedom1Array.get(rowIndex,columnIndex),degFreedom2Object=degFreedom2Array.get(rowIndex,columnIndex);return probabilityObject.isError()?probabilityObject:degFreedom1Object.isError()?degFreedom1Object:degFreedom2Object.isError()?degFreedom2Object:this._handleSignleObject(probabilityObject,degFreedom1Object,degFreedom2Object)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_handleSignleObject(probabilityObject,degFreedom1Object,degFreedom2Object){const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(probabilityObject,degFreedom1Object,degFreedom2Object);if(isError)return errorObject;const[_probabilityObject,_degFreedom1Object,_degFreedom2Object]=variants,probabilityValue=+_probabilityObject.getValue(),degFreedom1Value=Math.floor(+_degFreedom1Object.getValue()),degFreedom2Value=Math.floor(+_degFreedom2Object.getValue());if(probabilityValue<0||probabilityValue>1||degFreedom1Value<1||degFreedom1Value>10**10||degFreedom2Value<1||degFreedom2Value>10**10)return ErrorValueObject.create(error_type_ErrorType.NUM);const result=centralFINV(1-probabilityValue,degFreedom1Value,degFreedom2Value);return Number.isNaN(result)||!Number.isFinite(result)?ErrorValueObject.create(error_type_ErrorType.NUM):NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=3,this.maxParams=3}}class FTest extends base_function_BaseFunction{calculate(array1,array2){const{isError:isError_array1,errorObject:errorObject_array1,variance:variance_array1,ns1:ns1_array1}=this._getValues(array1);if(isError_array1)return errorObject_array1;const{isError:isError_array2,errorObject:errorObject_array2,variance:variance_array2,ns1:ns1_array2}=this._getValues(array2);if(isError_array2)return errorObject_array2;let result=2*(1-centralFCDF(variance_array1/variance_array2,ns1_array1,ns1_array2));return result>1&&(result=2-result),NumberValueObject.create(result)}_getValues(array){let variance=0,ns1=0;const arrayRowCount=array.isArray()?array.getRowCount():1,arrayColumnCount=array.isArray()?array.getColumnCount():1;if(1===arrayRowCount&&1===arrayColumnCount){const _array=array.isArray()?array.get(0,0):array;return _array.isError()?{isError:!0,errorObject:_array,variance,ns1}:_array.isNull()?{isError:!0,errorObject:ErrorValueObject.create(error_type_ErrorType.VALUE),variance,ns1}:{isError:!0,errorObject:ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO),variance,ns1}}const values=[];let sum=0;for(let r=0;r<arrayRowCount;r++)for(let c=0;c<arrayColumnCount;c++){const valueObject=array.isArray()?array.get(r,c):array;if(valueObject.isError())return{isError:!0,errorObject:valueObject,variance,ns1};if(valueObject.isNull()||valueObject.isBoolean())continue;const value=valueObject.getValue();(0,src.DMQ)(value)&&(values.push(+value),sum+=+value)}if(values.length<=1)return{isError:!0,errorObject:ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO),variance,ns1};const mean=sum/values.length;let sumSquares=0;for(let i=0;i<values.length;i++)sumSquares+=(values[i]-mean)**2;return ns1=values.length-1,variance=sumSquares/ns1,0===variance?{isError:!0,errorObject:ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO),variance,ns1}:{isError:!1,errorObject:null,variance,ns1}}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}}class GammaDist extends base_function_BaseFunction{calculate(x,alpha,beta,cumulative){const maxRowLength=Math.max(x.isArray()?x.getRowCount():1,alpha.isArray()?alpha.getRowCount():1,beta.isArray()?beta.getRowCount():1,cumulative.isArray()?cumulative.getRowCount():1),maxColumnLength=Math.max(x.isArray()?x.getColumnCount():1,alpha.isArray()?alpha.getColumnCount():1,beta.isArray()?beta.getColumnCount():1,cumulative.isArray()?cumulative.getColumnCount():1),xArray=expandArrayValueObject(maxRowLength,maxColumnLength,x,ErrorValueObject.create(error_type_ErrorType.NA)),alphaArray=expandArrayValueObject(maxRowLength,maxColumnLength,alpha,ErrorValueObject.create(error_type_ErrorType.NA)),betaArray=expandArrayValueObject(maxRowLength,maxColumnLength,beta,ErrorValueObject.create(error_type_ErrorType.NA)),cumulativeArray=expandArrayValueObject(maxRowLength,maxColumnLength,cumulative,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=xArray.mapValue(((xObject,rowIndex,columnIndex)=>{const alphaObject=alphaArray.get(rowIndex,columnIndex),betaObject=betaArray.get(rowIndex,columnIndex),cumulativeObject=cumulativeArray.get(rowIndex,columnIndex);return xObject.isError()?xObject:alphaObject.isError()?alphaObject:betaObject.isError()?betaObject:cumulativeObject.isError()?cumulativeObject:this._handleSignleObject(xObject,alphaObject,betaObject,cumulativeObject)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_handleSignleObject(xObject,alphaObject,betaObject,cumulativeObject){const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(xObject,alphaObject,betaObject,cumulativeObject);if(isError)return errorObject;const[_xObject,_alphaObject,_betaObject,_cumulativeObject]=variants,xValue=+_xObject.getValue(),alphaValue=+_alphaObject.getValue(),betaValue=+_betaObject.getValue(),cumulativeValue=+_cumulativeObject.getValue();if(xValue<0||alphaValue<=0||betaValue<=0)return ErrorValueObject.create(error_type_ErrorType.NUM);let result;return result=cumulativeValue?function gammaCDF(x,alpha,beta){return x<=0?0:lowRegGamma(alpha,x/beta)}(xValue,alphaValue,betaValue):function gammaPDF(x,alpha,beta){return x<0?0:0===x&&1===alpha?1/beta:Math.exp((alpha-1)*Math.log(x)-x/beta-gammaln(alpha)-alpha*Math.log(beta))}(xValue,alphaValue,betaValue),NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=4,this.maxParams=4}}class GammaInv extends base_function_BaseFunction{calculate(probability,alpha,beta){const maxRowLength=Math.max(probability.isArray()?probability.getRowCount():1,alpha.isArray()?alpha.getRowCount():1,beta.isArray()?beta.getRowCount():1),maxColumnLength=Math.max(probability.isArray()?probability.getColumnCount():1,alpha.isArray()?alpha.getColumnCount():1,beta.isArray()?beta.getColumnCount():1),probabilityArray=expandArrayValueObject(maxRowLength,maxColumnLength,probability,ErrorValueObject.create(error_type_ErrorType.NA)),alphaArray=expandArrayValueObject(maxRowLength,maxColumnLength,alpha,ErrorValueObject.create(error_type_ErrorType.NA)),betaArray=expandArrayValueObject(maxRowLength,maxColumnLength,beta,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=probabilityArray.mapValue(((probabilityObject,rowIndex,columnIndex)=>{const alphaObject=alphaArray.get(rowIndex,columnIndex),betaObject=betaArray.get(rowIndex,columnIndex);return probabilityObject.isError()?probabilityObject:alphaObject.isError()?alphaObject:betaObject.isError()?betaObject:this._handleSignleObject(probabilityObject,alphaObject,betaObject)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_handleSignleObject(probabilityObject,alphaObject,betaObject){const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(probabilityObject,alphaObject,betaObject);if(isError)return errorObject;const[_probabilityObject,_alphaObject,_betaObject]=variants,probabilityValue=+_probabilityObject.getValue(),alphaValue=+_alphaObject.getValue(),betaValue=+_betaObject.getValue();if(probabilityValue<0||probabilityValue>1||alphaValue<=0||betaValue<=0)return ErrorValueObject.create(error_type_ErrorType.NUM);const result=function gammaINV(probability,alpha,beta){return probability<=0?0:probability>=1?1/0:beta*lowRegGammaInverse(probability,alpha)}(probabilityValue,alphaValue,betaValue);return Number.isNaN(result)||!Number.isFinite(result)?ErrorValueObject.create(error_type_ErrorType.NUM):NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=3,this.maxParams=3}}class LognormInv extends base_function_BaseFunction{calculate(probability,mean,standardDev){const maxRowLength=Math.max(probability.isArray()?probability.getRowCount():1,mean.isArray()?mean.getRowCount():1,standardDev.isArray()?standardDev.getRowCount():1),maxColumnLength=Math.max(probability.isArray()?probability.getColumnCount():1,mean.isArray()?mean.getColumnCount():1,standardDev.isArray()?standardDev.getColumnCount():1),probabilityArray=expandArrayValueObject(maxRowLength,maxColumnLength,probability,ErrorValueObject.create(error_type_ErrorType.NA)),meanArray=expandArrayValueObject(maxRowLength,maxColumnLength,mean,ErrorValueObject.create(error_type_ErrorType.NA)),standardDevArray=expandArrayValueObject(maxRowLength,maxColumnLength,standardDev,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=probabilityArray.mapValue(((probabilityObject,rowIndex,columnIndex)=>{const meanObject=meanArray.get(rowIndex,columnIndex),standardDevObject=standardDevArray.get(rowIndex,columnIndex);return probabilityObject.isError()?probabilityObject:meanObject.isError()?meanObject:standardDevObject.isError()?standardDevObject:this._handleSignleObject(probabilityObject,meanObject,standardDevObject)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_handleSignleObject(probabilityObject,meanObject,standardDevObject){const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(probabilityObject,meanObject,standardDevObject);if(isError)return errorObject;const[_probabilityObject,_meanObject,_standardDevObject]=variants,probabilityValue=+_probabilityObject.getValue(),meanValue=+_meanObject.getValue(),standardDevValue=+_standardDevObject.getValue();if(probabilityValue<=0||probabilityValue>=1||standardDevValue<=0)return ErrorValueObject.create(error_type_ErrorType.NUM);const result=function lognormalINV(probability,mean,standardDev){return Math.exp(normalINV(probability,mean,standardDev))}(probabilityValue,meanValue,standardDevValue);return Number.isNaN(result)||!Number.isFinite(result)?ErrorValueObject.create(error_type_ErrorType.NUM):NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=3,this.maxParams=3}}class ModeSngl extends base_function_BaseFunction{calculate(...variants){const valueMap={};let order=0,maxCount=1;for(let i=0;i<variants.length;i++){const variant=variants[i];if(variant.isError())return variant;if(variant.isString()){const _variant=variant.convertToNumberObjectValue();if(_variant.isError())return _variant}const rowCount=variant.isArray()?variant.getRowCount():1,columnCount=variant.isArray()?variant.getColumnCount():1;for(let r=0;r<rowCount;r++)for(let c=0;c<columnCount;c++){const valueObject=variant.isArray()?variant.get(r,c):variant;if(valueObject.isError())return valueObject;if(valueObject.isNull()||valueObject.isBoolean()||valueObject.isString())continue;const value=valueObject.getValue();(0,src.DMQ)(value)&&(valueMap[+value]?(valueMap[+value].count++,valueMap[+value].count>maxCount&&(maxCount=valueMap[+value].count)):valueMap[+value]={count:1,order:order++})}}return 0===order||1===maxCount?new ErrorValueObject(error_type_ErrorType.NA):this._getResult(valueMap,maxCount)}_getResult(valueMap,maxCount){const result=Object.entries(valueMap).filter((([_,{count}])=>count===maxCount)).sort(((a,b)=>a[1].order-b[1].order)).map((([value])=>+value));return NumberValueObject.create(result[0])}constructor(...args){super(...args),this.minParams=1,this.maxParams=255}}class NormDist extends base_function_BaseFunction{calculate(x,mean,standardDev,cumulative){const maxRowLength=Math.max(x.isArray()?x.getRowCount():1,mean.isArray()?mean.getRowCount():1,standardDev.isArray()?standardDev.getRowCount():1,cumulative.isArray()?cumulative.getRowCount():1),maxColumnLength=Math.max(x.isArray()?x.getColumnCount():1,mean.isArray()?mean.getColumnCount():1,standardDev.isArray()?standardDev.getColumnCount():1,cumulative.isArray()?cumulative.getColumnCount():1),xArray=expandArrayValueObject(maxRowLength,maxColumnLength,x,ErrorValueObject.create(error_type_ErrorType.NA)),meanArray=expandArrayValueObject(maxRowLength,maxColumnLength,mean,ErrorValueObject.create(error_type_ErrorType.NA)),standardDevArray=expandArrayValueObject(maxRowLength,maxColumnLength,standardDev,ErrorValueObject.create(error_type_ErrorType.NA)),cumulativeArray=expandArrayValueObject(maxRowLength,maxColumnLength,cumulative,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=xArray.mapValue(((xObject,rowIndex,columnIndex)=>{const meanObject=meanArray.get(rowIndex,columnIndex),standardDevObject=standardDevArray.get(rowIndex,columnIndex),cumulativeObject=cumulativeArray.get(rowIndex,columnIndex);return xObject.isError()?xObject:meanObject.isError()?meanObject:standardDevObject.isError()?standardDevObject:cumulativeObject.isError()?cumulativeObject:this._handleSignleObject(xObject,meanObject,standardDevObject,cumulativeObject)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_handleSignleObject(xObject,meanObject,standardDevObject,cumulativeObject){const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(xObject,meanObject,standardDevObject,cumulativeObject);if(isError)return errorObject;const[_xObject,_meanObject,_standardDevObject,_cumulativeObject]=variants,xValue=+_xObject.getValue(),meanValue=+_meanObject.getValue(),standardDevValue=+_standardDevObject.getValue(),cumulativeValue=+_cumulativeObject.getValue();if(standardDevValue<=0)return ErrorValueObject.create(error_type_ErrorType.NUM);let result;return result=cumulativeValue?normalCDF(xValue,meanValue,standardDevValue):normalPDF(xValue,meanValue,standardDevValue),NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=4,this.maxParams=4}}class NormInv extends base_function_BaseFunction{calculate(probability,mean,standardDev){const maxRowLength=Math.max(probability.isArray()?probability.getRowCount():1,mean.isArray()?mean.getRowCount():1,standardDev.isArray()?standardDev.getRowCount():1),maxColumnLength=Math.max(probability.isArray()?probability.getColumnCount():1,mean.isArray()?mean.getColumnCount():1,standardDev.isArray()?standardDev.getColumnCount():1),probabilityArray=expandArrayValueObject(maxRowLength,maxColumnLength,probability,ErrorValueObject.create(error_type_ErrorType.NA)),meanArray=expandArrayValueObject(maxRowLength,maxColumnLength,mean,ErrorValueObject.create(error_type_ErrorType.NA)),standardDevArray=expandArrayValueObject(maxRowLength,maxColumnLength,standardDev,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=probabilityArray.mapValue(((probabilityObject,rowIndex,columnIndex)=>{const meanObject=meanArray.get(rowIndex,columnIndex),standardDevObject=standardDevArray.get(rowIndex,columnIndex);return probabilityObject.isError()?probabilityObject:meanObject.isError()?meanObject:standardDevObject.isError()?standardDevObject:this._handleSignleObject(probabilityObject,meanObject,standardDevObject)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_handleSignleObject(probabilityObject,meanObject,standardDevObject){const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(probabilityObject,meanObject,standardDevObject);if(isError)return errorObject;const[_probabilityObject,_meanObject,_standardDevObject]=variants,probabilityValue=+_probabilityObject.getValue(),meanValue=+_meanObject.getValue(),standardDevValue=+_standardDevObject.getValue();if(probabilityValue<=0||probabilityValue>=1||standardDevValue<=0)return ErrorValueObject.create(error_type_ErrorType.NUM);const result=normalINV(probabilityValue,meanValue,standardDevValue);return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=3,this.maxParams=3}}class NormSInv extends base_function_BaseFunction{calculate(probability){if(probability.isArray()){const resultArray=probability.mapValue((probabilityObject=>this._handleSignleObject(probabilityObject)));return 1===probability.getRowCount()&&1===probability.getColumnCount()?resultArray.get(0,0):resultArray}return this._handleSignleObject(probability)}_handleSignleObject(probabilityObject){const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(probabilityObject);if(isError)return errorObject;const[_probabilityObject]=variants,probabilityValue=+_probabilityObject.getValue();if(probabilityValue<=0||probabilityValue>=1)return ErrorValueObject.create(error_type_ErrorType.NUM);const result=normalINV(probabilityValue,0,1);return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}}class PercentileInc extends base_function_BaseFunction{calculate(array,k){const arrayValues=this._getValues(array);if(k.isArray()){const resultArray=k.mapValue((kObject=>this._handleSingleObject(arrayValues,kObject)));return 1===resultArray.getRowCount()&&1===resultArray.getColumnCount()?resultArray.get(0,0):resultArray}return this._handleSingleObject(arrayValues,k)}_handleSingleObject(array,k){if(array instanceof ErrorValueObject)return array;const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(k);if(isError)return errorObject;const[kObject]=variants,kValue=+kObject.getValue(),n=array.length;if(kValue<0||kValue>1)return ErrorValueObject.create(error_type_ErrorType.NUM);const kValueIndex=kValue*(n-1),integerPart=Math.floor(kValueIndex),fractionPart=kValueIndex-integerPart;if(0===fractionPart)return NumberValueObject.create(array[integerPart]);const result=array[integerPart]+fractionPart*(array[integerPart+1]-array[integerPart]);return NumberValueObject.create(result)}_getValues(array){const rowCount=array.isArray()?array.getRowCount():1,columnCount=array.isArray()?array.getColumnCount():1,values=[];for(let r=0;r<rowCount;r++)for(let c=0;c<columnCount;c++){const valueObject=array.isArray()?array.get(r,c):array;if(valueObject.isError())return valueObject;if(valueObject.isNull()||valueObject.isBoolean()||valueObject.isString())continue;const value=valueObject.getValue();(0,src.DMQ)(value)&&values.push(+value)}return 0===values.length?ErrorValueObject.create(error_type_ErrorType.NUM):values.sort(((a,b)=>a-b))}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}}class PercentrankInc extends base_function_BaseFunction{calculate(array,x,significance){const arrayValues=this._getValues(array);let _significance=significance??NumberValueObject.create(3);_significance.isNull()&&(_significance=NumberValueObject.create(3));const maxRowLength=Math.max(x.isArray()?x.getRowCount():1,_significance.isArray()?_significance.getRowCount():1),maxColumnLength=Math.max(x.isArray()?x.getColumnCount():1,_significance.isArray()?_significance.getColumnCount():1),xArray=expandArrayValueObject(maxRowLength,maxColumnLength,x,ErrorValueObject.create(error_type_ErrorType.NA)),significanceArray=expandArrayValueObject(maxRowLength,maxColumnLength,_significance,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=xArray.mapValue(((xObject,rowIndex,columnIndex)=>{const significanceObject=significanceArray.get(rowIndex,columnIndex);return xObject.isError()?xObject:significanceObject.isError()?significanceObject:this._handleSingleObject(arrayValues,xObject,significanceObject)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_handleSingleObject(array,x,significance){if(array instanceof ErrorValueObject)return array;const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(x,significance);if(isError)return errorObject;const[xObject,significanceObject]=variants,xValue=+xObject.getValue(),significanceValue=Math.floor(+significanceObject.getValue()),n=array.length;if(0===n||xValue<array[0]||xValue>array[n-1])return ErrorValueObject.create(error_type_ErrorType.NA);if(1===n)return xValue===array[0]?NumberValueObject.create(1):ErrorValueObject.create(error_type_ErrorType.NA);let result=0,match=!1,i=0;for(;!match&&i<n;)xValue===array[i]?(result=i/(n-1),match=!0):xValue>array[i]&&i+1<n&&xValue<array[i+1]&&(result=(i+(xValue-array[i])/(array[i+1]-array[i]))/(n-1),match=!0),i++;return match?significanceValue<1?ErrorValueObject.create(error_type_ErrorType.NUM):(result=floor(result,significanceValue),NumberValueObject.create(result)):ErrorValueObject.create(error_type_ErrorType.NA)}_getValues(array){const rowCount=array.isArray()?array.getRowCount():1,columnCount=array.isArray()?array.getColumnCount():1,values=[];for(let r=0;r<rowCount;r++)for(let c=0;c<columnCount;c++){const valueObject=array.isArray()?array.get(r,c):array;if(valueObject.isError())return valueObject;if(valueObject.isNull()||valueObject.isBoolean())continue;const value=valueObject.getValue();(0,src.DMQ)(value)&&values.push(+value)}return values.sort(((a,b)=>a-b))}constructor(...args){super(...args),this.minParams=2,this.maxParams=3}}class PoissonDist extends base_function_BaseFunction{calculate(x,mean,cumulative){const maxRowLength=Math.max(x.isArray()?x.getRowCount():1,mean.isArray()?mean.getRowCount():1,cumulative.isArray()?cumulative.getRowCount():1),maxColumnLength=Math.max(x.isArray()?x.getColumnCount():1,mean.isArray()?mean.getColumnCount():1,cumulative.isArray()?cumulative.getColumnCount():1),xArray=expandArrayValueObject(maxRowLength,maxColumnLength,x,ErrorValueObject.create(error_type_ErrorType.NA)),meanArray=expandArrayValueObject(maxRowLength,maxColumnLength,mean,ErrorValueObject.create(error_type_ErrorType.NA)),cumulativeArray=expandArrayValueObject(maxRowLength,maxColumnLength,cumulative,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=xArray.mapValue(((xObject,rowIndex,columnIndex)=>{const meanObject=meanArray.get(rowIndex,columnIndex),cumulativeObject=cumulativeArray.get(rowIndex,columnIndex);return xObject.isError()?xObject:meanObject.isError()?meanObject:cumulativeObject.isError()?cumulativeObject:this._handleSignleObject(xObject,meanObject,cumulativeObject)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_handleSignleObject(xObject,meanObject,cumulativeObject){const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(xObject,meanObject,cumulativeObject);if(isError)return errorObject;const[_xObject,_meanObject,_cumulativeObject]=variants,xValue=Math.floor(+_xObject.getValue()),meanValue=+_meanObject.getValue(),cumulativeValue=+_cumulativeObject.getValue();if(xValue<0||meanValue<0)return ErrorValueObject.create(error_type_ErrorType.NUM);let result;return result=cumulativeValue?function poissonCDF(x,mean){let result=0;for(let i=0;i<=x;i++)result+=poissonPDF(i,mean);return result}(xValue,meanValue):poissonPDF(xValue,meanValue),NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=3,this.maxParams=3}}class QuartileInc extends base_function_BaseFunction{calculate(array,quart){const arrayValues=this._getValues(array);if(quart.isArray()){const resultArray=quart.mapValue((quartObject=>this._handleSingleObject(arrayValues,quartObject)));return 1===resultArray.getRowCount()&&1===resultArray.getColumnCount()?resultArray.get(0,0):resultArray}return this._handleSingleObject(arrayValues,quart)}_handleSingleObject(array,quart){if(array instanceof ErrorValueObject)return array;const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(quart);if(isError)return errorObject;const[quartObject]=variants,quartValue=Math.floor(+quartObject.getValue());if(quartValue<0||quartValue>4)return ErrorValueObject.create(error_type_ErrorType.NUM);const kIndex=quartValue/4*(array.length-1),integerPart=Math.floor(kIndex),fractionPart=kIndex-integerPart;if(0===fractionPart)return NumberValueObject.create(array[integerPart]);const result=array[integerPart]+fractionPart*(array[integerPart+1]-array[integerPart]);return NumberValueObject.create(result)}_getValues(array){const rowCount=array.isArray()?array.getRowCount():1,columnCount=array.isArray()?array.getColumnCount():1,values=[];for(let r=0;r<rowCount;r++)for(let c=0;c<columnCount;c++){const valueObject=array.isArray()?array.get(r,c):array;if(valueObject.isError())return valueObject;if(valueObject.isNull()||valueObject.isBoolean())continue;const value=valueObject.getValue();(0,src.DMQ)(value)&&values.push(+value)}return 0===values.length?ErrorValueObject.create(error_type_ErrorType.NUM):values.sort(((a,b)=>a-b))}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}}class StdevP extends base_function_BaseFunction{calculate(...variants){const flattenArray=this.flattenArray(variants);return flattenArray.isError()?flattenArray:flattenArray.std()}constructor(...args){super(...args),this.minParams=1,this.maxParams=255}}class StdevS extends base_function_BaseFunction{calculate(...variants){const flattenArray=this.flattenArray(variants);return flattenArray.isError()?flattenArray:flattenArray.std(1)}constructor(...args){super(...args),this.minParams=1,this.maxParams=255}}class TInv2t extends base_function_BaseFunction{calculate(probability,degFreedom){const maxRowLength=Math.max(probability.isArray()?probability.getRowCount():1,degFreedom.isArray()?degFreedom.getRowCount():1),maxColumnLength=Math.max(probability.isArray()?probability.getColumnCount():1,degFreedom.isArray()?degFreedom.getColumnCount():1),probabilityArray=expandArrayValueObject(maxRowLength,maxColumnLength,probability,ErrorValueObject.create(error_type_ErrorType.NA)),degFreedomArray=expandArrayValueObject(maxRowLength,maxColumnLength,degFreedom,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=probabilityArray.mapValue(((probabilityObject,rowIndex,columnIndex)=>{const degFreedomObject=degFreedomArray.get(rowIndex,columnIndex);return probabilityObject.isError()?probabilityObject:degFreedomObject.isError()?degFreedomObject:this._handleSignleObject(probabilityObject,degFreedomObject)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_handleSignleObject(probabilityObject,degFreedomObject){const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(probabilityObject,degFreedomObject);if(isError)return errorObject;const[_probabilityObject,_degFreedomObject]=variants,probabilityValue=+_probabilityObject.getValue(),degFreedomValue=Math.floor(+_degFreedomObject.getValue());if(probabilityValue<=0||probabilityValue>1||degFreedomValue<1||degFreedomValue>10**10)return ErrorValueObject.create(error_type_ErrorType.NUM);const result=Math.abs(studentTINV(probabilityValue/2,degFreedomValue));return Number.isNaN(result)||!Number.isFinite(result)?ErrorValueObject.create(error_type_ErrorType.NUM):NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}}class TTest extends base_function_BaseFunction{calculate(array1,array2,tails,type){const{isError:isError_sp,errorObject:errorObject_sp,array1Values:array1Values_sp,array2Values:array2Values_sp}=this._handleArray1AndArray2(array1,array2),array1Values=this._getArrayValues(array1),array2Values=this._getArrayValues(array2),maxRowLength=Math.max(tails.isArray()?tails.getRowCount():1,type.isArray()?type.getRowCount():1),maxColumnLength=Math.max(tails.isArray()?tails.getColumnCount():1,type.isArray()?type.getColumnCount():1),tailsArray=expandArrayValueObject(maxRowLength,maxColumnLength,tails,ErrorValueObject.create(error_type_ErrorType.NA)),typeArray=expandArrayValueObject(maxRowLength,maxColumnLength,type,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=tailsArray.mapValue(((tailsObject,rowIndex,columnIndex)=>{const typeObject=typeArray.get(rowIndex,columnIndex);if(array1.isError())return array1;if(array2.isError())return array2;if(tailsObject.isError())return tailsObject;if(typeObject.isError())return typeObject;const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(tailsObject,typeObject);if(isError)return errorObject;const[_tailsObject,_typeObject]=variants,tailsValue=Math.floor(+_tailsObject.getValue()),typeValue=Math.floor(+_typeObject.getValue());return[1,2].includes(tailsValue)&&[1,2,3].includes(typeValue)?1===typeValue&&isError_sp?errorObject_sp:1!==typeValue&&array1Values instanceof ErrorValueObject?array1Values:1!==typeValue&&array2Values instanceof ErrorValueObject?array2Values:this._handleSignleObject(1===typeValue?array1Values_sp:array1Values,1===typeValue?array2Values_sp:array2Values,tailsValue,typeValue):ErrorValueObject.create(error_type_ErrorType.NUM)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_handleSignleObject(array1Values,array2Values,tails,type){if(array1Values.length<2||array2Values.length<2)return ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO);const{isError,errorObject,x,degFreedom}=this._getTDistParamByArrayValues(array1Values,array2Values,type);if(isError)return errorObject;let result=studentTCDF(-x,degFreedom);return 2===tails&&(result*=2),Number.isNaN(result)||!Number.isFinite(result)?ErrorValueObject.create(error_type_ErrorType.NUM):NumberValueObject.create(result)}_getArrayValues(array){const rowCount=array.isArray()?array.getRowCount():1,columnCount=array.isArray()?array.getColumnCount():1,arrayValues=[];for(let r=0;r<rowCount;r++)for(let c=0;c<columnCount;c++){const valueObject=array.isArray()?array.get(r,c):array;if(valueObject.isError())return valueObject;if(valueObject.isNull()){if(rowCount*columnCount==1)return ErrorValueObject.create(error_type_ErrorType.VALUE)}else valueObject.isBoolean()||valueObject.isString()||arrayValues.push(+valueObject.getValue())}return arrayValues}_handleArray1AndArray2(array1,array2){const array1RowCount=array1.isArray()?array1.getRowCount():1,array1ColumnCount=array1.isArray()?array1.getColumnCount():1,array2RowCount=array2.isArray()?array2.getRowCount():1,array2ColumnCount=array2.isArray()?array2.getColumnCount():1;let _array1=array1;if(array1.isArray()&&1===array1RowCount&&1===array1ColumnCount&&(_array1=array1.get(0,0)),_array1.isError())return{isError:!0,errorObject:_array1,array1Values:[],array2Values:[]};let _array2=array2;if(array2.isArray()&&1===array2RowCount&&1===array2ColumnCount&&(_array2=array2.get(0,0)),_array2.isError())return{isError:!0,errorObject:_array2,array1Values:[],array2Values:[]};if((array1RowCount*array1ColumnCount==1||array2RowCount*array2ColumnCount==1)&&(_array1.isNull()||_array2.isNull()))return{isError:!0,errorObject:ErrorValueObject.create(error_type_ErrorType.VALUE),array1Values:[],array2Values:[]};if(array1RowCount*array1ColumnCount!=array2RowCount*array2ColumnCount)return{isError:!0,errorObject:ErrorValueObject.create(error_type_ErrorType.NA),array1Values:[],array2Values:[]};const{isError,errorObject,array1Values,array2Values,noCalculate}=getTwoArrayNumberValues(array1,array2,array1RowCount*array1ColumnCount,array1ColumnCount,array2ColumnCount);return isError?{isError:!0,errorObject,array1Values:[],array2Values:[]}:noCalculate||array1Values.length<2?{isError:!0,errorObject:ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO),array1Values:[],array2Values:[]}:{isError:!1,errorObject:null,array1Values,array2Values}}_getTDistParamByArrayValues(array1Values,array2Values,type){return 1===type?this._getTDistParamByType1(array1Values,array2Values):2===type?this._getTDistParamByType2(array1Values,array2Values):this._getTDistParamByType3(array1Values,array2Values)}_getTDistParamByType1(array1Values,array2Values){const n=array1Values.length;let sum1=0,sum2=0,sumSquareDiff=0;for(let i=0;i<n;i++)sum1+=array1Values[i],sum2+=array2Values[i],sumSquareDiff+=(array1Values[i]-array2Values[i])**2;const sumDiff=sum1-sum2,den=n*sumSquareDiff-sumDiff**2,degFreedom=n-1;if(0===den)return{isError:!0,errorObject:ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO),x:0,degFreedom};return{isError:!1,errorObject:null,x:Math.abs(sumDiff)*Math.sqrt(degFreedom/den),degFreedom}}_getTDistParamByType2(array1Values,array2Values){const array1Length=array1Values.length,array2Length=array2Values.length;let sum1=0,sumSquare1=0;for(let i=0;i<array1Length;i++)sum1+=array1Values[i],sumSquare1+=array1Values[i]**2;let sum2=0,sumSquare2=0;for(let i=0;i<array2Length;i++)sum2+=array2Values[i],sumSquare2+=array2Values[i]**2;const temp1=sumSquare1-sum1**2/array1Length,temp2=sumSquare2-sum2**2/array2Length,den=Math.sqrt(temp1+temp2);if(0===den)return{isError:!0,errorObject:ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO),x:0,degFreedom:0};const degFreedom=array1Length-1+array2Length-1,temp3=Math.sqrt(array1Length*array2Length*degFreedom/(array1Length+array2Length));return{isError:!1,errorObject:null,x:Math.abs(sum1/array1Length-sum2/array2Length)/den*temp3,degFreedom}}_getTDistParamByType3(array1Values,array2Values){const array1Length=array1Values.length,array2Length=array2Values.length;let sum1=0,sumSquare1=0;for(let i=0;i<array1Length;i++)sum1+=array1Values[i],sumSquare1+=array1Values[i]**2;let sum2=0,sumSquare2=0;for(let i=0;i<array2Length;i++)sum2+=array2Values[i],sumSquare2+=array2Values[i]**2;const temp1=(sumSquare1-sum1**2/array1Length)/(array1Length*(array1Length-1)),temp2=(sumSquare2-sum2**2/array2Length)/(array2Length*(array2Length-1));if(temp1+temp2===0)return{isError:!0,errorObject:ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO),x:0,degFreedom:0};const temp3=temp1/(temp1+temp2);return{isError:!1,errorObject:null,x:Math.abs(sum1/array1Length-sum2/array2Length)/Math.sqrt(temp1+temp2),degFreedom:1/(temp3**2/(array1Length-1)+(1-temp3)**2/(array2Length-1))}}constructor(...args){super(...args),this.minParams=4,this.maxParams=4}}class VarP extends base_function_BaseFunction{calculate(...variants){const flattenArray=this.flattenArray(variants);return flattenArray.isError()?flattenArray:flattenArray.var()}constructor(...args){super(...args),this.minParams=1,this.maxParams=255}}class VarS extends base_function_BaseFunction{calculate(...variants){const flattenArray=this.flattenArray(variants);return flattenArray.isError()?flattenArray:flattenArray.var(1)}constructor(...args){super(...args),this.minParams=1,this.maxParams=255}}class WeibullDist extends base_function_BaseFunction{calculate(x,alpha,beta,cumulative){const maxRowLength=Math.max(x.isArray()?x.getRowCount():1,alpha.isArray()?alpha.getRowCount():1,beta.isArray()?beta.getRowCount():1,cumulative.isArray()?cumulative.getRowCount():1),maxColumnLength=Math.max(x.isArray()?x.getColumnCount():1,alpha.isArray()?alpha.getColumnCount():1,beta.isArray()?beta.getColumnCount():1,cumulative.isArray()?cumulative.getColumnCount():1),xArray=expandArrayValueObject(maxRowLength,maxColumnLength,x,ErrorValueObject.create(error_type_ErrorType.NA)),alphaArray=expandArrayValueObject(maxRowLength,maxColumnLength,alpha,ErrorValueObject.create(error_type_ErrorType.NA)),betaArray=expandArrayValueObject(maxRowLength,maxColumnLength,beta,ErrorValueObject.create(error_type_ErrorType.NA)),cumulativeArray=expandArrayValueObject(maxRowLength,maxColumnLength,cumulative,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=xArray.mapValue(((xObject,rowIndex,columnIndex)=>{const alphaObject=alphaArray.get(rowIndex,columnIndex),betaObject=betaArray.get(rowIndex,columnIndex),cumulativeObject=cumulativeArray.get(rowIndex,columnIndex);return xObject.isError()?xObject:alphaObject.isError()?alphaObject:betaObject.isError()?betaObject:cumulativeObject.isError()?cumulativeObject:this._handleSignleObject(xObject,alphaObject,betaObject,cumulativeObject)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_handleSignleObject(xObject,alphaObject,betaObject,cumulativeObject){const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(xObject,alphaObject,betaObject,cumulativeObject);if(isError)return errorObject;const[_xObject,_alphaObject,_betaObject,_cumulativeObject]=variants,xValue=+_xObject.getValue(),alphaValue=+_alphaObject.getValue(),betaValue=+_betaObject.getValue(),cumulativeValue=+_cumulativeObject.getValue();if(xValue<0||alphaValue<=0||betaValue<=0)return ErrorValueObject.create(error_type_ErrorType.NUM);const exp=Math.exp(-((xValue/betaValue)**alphaValue));let result;return result=cumulativeValue?1-exp:alphaValue/betaValue**alphaValue*xValue**(alphaValue-1)*exp,Number.isNaN(result)||!Number.isFinite(result)?ErrorValueObject.create(error_type_ErrorType.NUM):NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=4,this.maxParams=4}}class ZTest extends base_function_BaseFunction{calculate(array,x,sigma){const arrayValues=this._getArrayValues(array),maxRowLength=Math.max(x.isArray()?x.getRowCount():1,sigma?.isArray()?sigma.getRowCount():1),maxColumnLength=Math.max(x.isArray()?x.getColumnCount():1,sigma?.isArray()?sigma.getColumnCount():1),xArray=expandArrayValueObject(maxRowLength,maxColumnLength,x,ErrorValueObject.create(error_type_ErrorType.NA)),sigmaArray=sigma?expandArrayValueObject(maxRowLength,maxColumnLength,sigma,ErrorValueObject.create(error_type_ErrorType.NA)):void 0,resultArray=xArray.mapValue(((xObject,rowIndex,columnIndex)=>{if(arrayValues instanceof ErrorValueObject)return arrayValues;if(xObject.isError())return xObject;const sigmaObject=sigma?sigmaArray.get(rowIndex,columnIndex):void 0;return sigmaObject?.isError()?sigmaObject:0===arrayValues.length?ErrorValueObject.create(error_type_ErrorType.NA):1===arrayValues.length?ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO):this._handleSignleObject(arrayValues,xObject,sigmaObject)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_handleSignleObject(arrayValues,x,sigma){const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(x);if(isError)return errorObject;const[xObject]=variants,xValue=+xObject.getValue(),n=arrayValues.length;let sum=0,sumSquare=0;for(let i=0;i<n;i++)sum+=arrayValues[i],sumSquare+=arrayValues[i]**2;let sigmaValue=0;if(void 0!==sigma){const{isError:_isError,errorObject:_errorObject,variants:_variants}=checkVariantsErrorIsStringToNumber(sigma);if(_isError)return _errorObject;const[sigmaObject]=_variants;sigmaValue=+sigmaObject.getValue()}else{const mean=sum/n;sigmaValue=Math.sqrt((sumSquare-2*mean*sum+n*mean**2)/(n-1))}if(sigmaValue<=0)return ErrorValueObject.create(error_type_ErrorType.NUM);const result=1-normalCDF((sum/n-xValue)/(sigmaValue/Math.sqrt(n)),0,1);return Number.isNaN(result)||!Number.isFinite(result)?ErrorValueObject.create(error_type_ErrorType.NUM):NumberValueObject.create(result)}_getArrayValues(array){const values=[],arrayRowCount=array.isArray()?array.getRowCount():1,arrayColumnCount=array.isArray()?array.getColumnCount():1;for(let r=0;r<arrayRowCount;r++)for(let c=0;c<arrayColumnCount;c++){const valueObject=array.isArray()?array.get(r,c):array;if(valueObject.isError())return valueObject;if(valueObject.isNull()||valueObject.isBoolean()||valueObject.isString())continue;const value=valueObject.getValue();(0,src.DMQ)(value)&&values.push(+value)}return values}constructor(...args){super(...args),this.minParams=2,this.maxParams=3}}var FUNCTION_NAMES_COMPATIBILITY=function(FUNCTION_NAMES_COMPATIBILITY){return FUNCTION_NAMES_COMPATIBILITY.BETADIST="BETADIST",FUNCTION_NAMES_COMPATIBILITY.BETAINV="BETAINV",FUNCTION_NAMES_COMPATIBILITY.BINOMDIST="BINOMDIST",FUNCTION_NAMES_COMPATIBILITY.CHIDIST="CHIDIST",FUNCTION_NAMES_COMPATIBILITY.CHIINV="CHIINV",FUNCTION_NAMES_COMPATIBILITY.CHITEST="CHITEST",FUNCTION_NAMES_COMPATIBILITY.CONFIDENCE="CONFIDENCE",FUNCTION_NAMES_COMPATIBILITY.COVAR="COVAR",FUNCTION_NAMES_COMPATIBILITY.CRITBINOM="CRITBINOM",FUNCTION_NAMES_COMPATIBILITY.EXPONDIST="EXPONDIST",FUNCTION_NAMES_COMPATIBILITY.FDIST="FDIST",FUNCTION_NAMES_COMPATIBILITY.FINV="FINV",FUNCTION_NAMES_COMPATIBILITY.FTEST="FTEST",FUNCTION_NAMES_COMPATIBILITY.GAMMADIST="GAMMADIST",FUNCTION_NAMES_COMPATIBILITY.GAMMAINV="GAMMAINV",FUNCTION_NAMES_COMPATIBILITY.HYPGEOMDIST="HYPGEOMDIST",FUNCTION_NAMES_COMPATIBILITY.LOGINV="LOGINV",FUNCTION_NAMES_COMPATIBILITY.LOGNORMDIST="LOGNORMDIST",FUNCTION_NAMES_COMPATIBILITY.MODE="MODE",FUNCTION_NAMES_COMPATIBILITY.NEGBINOMDIST="NEGBINOMDIST",FUNCTION_NAMES_COMPATIBILITY.NORMDIST="NORMDIST",FUNCTION_NAMES_COMPATIBILITY.NORMINV="NORMINV",FUNCTION_NAMES_COMPATIBILITY.NORMSDIST="NORMSDIST",FUNCTION_NAMES_COMPATIBILITY.NORMSINV="NORMSINV",FUNCTION_NAMES_COMPATIBILITY.PERCENTILE="PERCENTILE",FUNCTION_NAMES_COMPATIBILITY.PERCENTRANK="PERCENTRANK",FUNCTION_NAMES_COMPATIBILITY.POISSON="POISSON",FUNCTION_NAMES_COMPATIBILITY.QUARTILE="QUARTILE",FUNCTION_NAMES_COMPATIBILITY.RANK="RANK",FUNCTION_NAMES_COMPATIBILITY.STDEV="STDEV",FUNCTION_NAMES_COMPATIBILITY.STDEVP="STDEVP",FUNCTION_NAMES_COMPATIBILITY.TDIST="TDIST",FUNCTION_NAMES_COMPATIBILITY.TINV="TINV",FUNCTION_NAMES_COMPATIBILITY.TTEST="TTEST",FUNCTION_NAMES_COMPATIBILITY.VAR="VAR",FUNCTION_NAMES_COMPATIBILITY.VARP="VARP",FUNCTION_NAMES_COMPATIBILITY.WEIBULL="WEIBULL",FUNCTION_NAMES_COMPATIBILITY.ZTEST="ZTEST",FUNCTION_NAMES_COMPATIBILITY}({});const functionCompatibility=[[class Betadist extends base_function_BaseFunction{calculate(x,alpha,beta,A,B){let _A=A??NumberValueObject.create(0),_B=B??NumberValueObject.create(1);_A.isNull()&&(_A=NumberValueObject.create(0)),_B.isNull()&&(_B=NumberValueObject.create(1));const maxRowLength=Math.max(x.isArray()?x.getRowCount():1,alpha.isArray()?alpha.getRowCount():1,beta.isArray()?beta.getRowCount():1,_A.isArray()?_A.getRowCount():1,_B.isArray()?_B.getRowCount():1),maxColumnLength=Math.max(x.isArray()?x.getColumnCount():1,alpha.isArray()?alpha.getColumnCount():1,beta.isArray()?beta.getColumnCount():1,_A.isArray()?_A.getColumnCount():1,_B.isArray()?_B.getColumnCount():1),xArray=expandArrayValueObject(maxRowLength,maxColumnLength,x,ErrorValueObject.create(error_type_ErrorType.NA)),alphaArray=expandArrayValueObject(maxRowLength,maxColumnLength,alpha,ErrorValueObject.create(error_type_ErrorType.NA)),betaArray=expandArrayValueObject(maxRowLength,maxColumnLength,beta,ErrorValueObject.create(error_type_ErrorType.NA)),AArray=expandArrayValueObject(maxRowLength,maxColumnLength,_A,ErrorValueObject.create(error_type_ErrorType.NA)),BArray=expandArrayValueObject(maxRowLength,maxColumnLength,_B,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=xArray.mapValue(((xObject,rowIndex,columnIndex)=>{const alphaObject=alphaArray.get(rowIndex,columnIndex),betaObject=betaArray.get(rowIndex,columnIndex),AObject=AArray.get(rowIndex,columnIndex),BObject=BArray.get(rowIndex,columnIndex);return this._handleSignleObject(xObject,alphaObject,betaObject,AObject,BObject)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_handleSignleObject(xObject,alphaObject,betaObject,AObject,BObject){if(xObject.isError())return xObject;if(alphaObject.isError())return alphaObject;if(betaObject.isError())return betaObject;if(AObject.isError())return AObject;if(BObject.isError())return BObject;const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(xObject,alphaObject,betaObject,AObject,BObject);if(isError)return errorObject;const[_xObject,_alphaObject,_betaObject,_AObject,_BObject]=variants,xValue=+_xObject.getValue(),alphaValue=+_alphaObject.getValue(),betaValue=+_betaObject.getValue(),AValue=+_AObject.getValue(),BValue=+_BObject.getValue();if(alphaValue<=0||betaValue<=0||xValue<AValue||xValue>BValue||AValue===BValue)return ErrorValueObject.create(error_type_ErrorType.NUM);const result=betaCDF((xValue-AValue)/(BValue-AValue),alphaValue,betaValue);return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=3,this.maxParams=5}},FUNCTION_NAMES_COMPATIBILITY.BETADIST],[BetaInv,FUNCTION_NAMES_COMPATIBILITY.BETAINV],[BinomDist,FUNCTION_NAMES_COMPATIBILITY.BINOMDIST],[ChisqDistRt,FUNCTION_NAMES_COMPATIBILITY.CHIDIST],[ChisqInvRt,FUNCTION_NAMES_COMPATIBILITY.CHIINV],[ChisqTest,FUNCTION_NAMES_COMPATIBILITY.CHITEST],[ConfidenceNorm,FUNCTION_NAMES_COMPATIBILITY.CONFIDENCE],[CovarianceP,FUNCTION_NAMES_COMPATIBILITY.COVAR],[BinomInv,FUNCTION_NAMES_COMPATIBILITY.CRITBINOM],[ExponDist,FUNCTION_NAMES_COMPATIBILITY.EXPONDIST],[FDistRt,FUNCTION_NAMES_COMPATIBILITY.FDIST],[FInvRt,FUNCTION_NAMES_COMPATIBILITY.FINV],[FTest,FUNCTION_NAMES_COMPATIBILITY.FTEST],[GammaDist,FUNCTION_NAMES_COMPATIBILITY.GAMMADIST],[GammaInv,FUNCTION_NAMES_COMPATIBILITY.GAMMAINV],[class Hypgeomdist extends base_function_BaseFunction{calculate(sampleS,numberSample,populationS,numberPop){const maxRowLength=Math.max(sampleS.isArray()?sampleS.getRowCount():1,numberSample.isArray()?numberSample.getRowCount():1,populationS.isArray()?populationS.getRowCount():1,numberPop.isArray()?numberPop.getRowCount():1),maxColumnLength=Math.max(sampleS.isArray()?sampleS.getColumnCount():1,numberSample.isArray()?numberSample.getColumnCount():1,populationS.isArray()?populationS.getColumnCount():1,numberPop.isArray()?numberPop.getColumnCount():1),sampleSArray=expandArrayValueObject(maxRowLength,maxColumnLength,sampleS,ErrorValueObject.create(error_type_ErrorType.NA)),numberSampleArray=expandArrayValueObject(maxRowLength,maxColumnLength,numberSample,ErrorValueObject.create(error_type_ErrorType.NA)),populationSArray=expandArrayValueObject(maxRowLength,maxColumnLength,populationS,ErrorValueObject.create(error_type_ErrorType.NA)),numberPopArray=expandArrayValueObject(maxRowLength,maxColumnLength,numberPop,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=sampleSArray.mapValue(((sampleSObject,rowIndex,columnIndex)=>{const numberSampleObject=numberSampleArray.get(rowIndex,columnIndex),populationSObject=populationSArray.get(rowIndex,columnIndex),numberPopObject=numberPopArray.get(rowIndex,columnIndex);return sampleSObject.isError()?sampleSObject:numberSampleObject.isError()?numberSampleObject:populationSObject.isError()?populationSObject:numberPopObject.isError()?numberPopObject:this._handleSignleObject(sampleSObject,numberSampleObject,populationSObject,numberPopObject)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_handleSignleObject(sampleSObject,numberSampleObject,populationSObject,numberPopObject){const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(sampleSObject,numberSampleObject,populationSObject,numberPopObject);if(isError)return errorObject;const[_sampleSObject,_numberSampleObject,_populationSObject,_numberPopObject]=variants,sampleSValue=Math.floor(+_sampleSObject.getValue()),numberSampleValue=Math.floor(+_numberSampleObject.getValue()),populationSValue=Math.floor(+_populationSObject.getValue()),numberPopValue=Math.floor(+_numberPopObject.getValue());if(sampleSValue<0||sampleSValue>numberSampleValue||sampleSValue>populationSValue||sampleSValue<numberSampleValue-numberPopValue+populationSValue||numberSampleValue<=0||numberSampleValue>numberPopValue||populationSValue<=0||populationSValue>numberPopValue||numberPopValue<=0)return ErrorValueObject.create(error_type_ErrorType.NUM);let result=hypergeometricPDF(sampleSValue,numberSampleValue,populationSValue,numberPopValue);return Number.isNaN(result)&&(result=0),NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=4,this.maxParams=4}},FUNCTION_NAMES_COMPATIBILITY.HYPGEOMDIST],[class Lognormdist extends base_function_BaseFunction{calculate(x,mean,standardDev){const maxRowLength=Math.max(x.isArray()?x.getRowCount():1,mean.isArray()?mean.getRowCount():1,standardDev.isArray()?standardDev.getRowCount():1),maxColumnLength=Math.max(x.isArray()?x.getColumnCount():1,mean.isArray()?mean.getColumnCount():1,standardDev.isArray()?standardDev.getColumnCount():1),xArray=expandArrayValueObject(maxRowLength,maxColumnLength,x,ErrorValueObject.create(error_type_ErrorType.NA)),meanArray=expandArrayValueObject(maxRowLength,maxColumnLength,mean,ErrorValueObject.create(error_type_ErrorType.NA)),standardDevArray=expandArrayValueObject(maxRowLength,maxColumnLength,standardDev,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=xArray.mapValue(((xObject,rowIndex,columnIndex)=>{const meanObject=meanArray.get(rowIndex,columnIndex),standardDevObject=standardDevArray.get(rowIndex,columnIndex);return xObject.isError()?xObject:meanObject.isError()?meanObject:standardDevObject.isError()?standardDevObject:this._handleSignleObject(xObject,meanObject,standardDevObject)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_handleSignleObject(xObject,meanObject,standardDevObject){const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(xObject,meanObject,standardDevObject);if(isError)return errorObject;const[_xObject,_meanObject,_standardDevObject]=variants,xValue=+_xObject.getValue(),meanValue=+_meanObject.getValue(),standardDevValue=+_standardDevObject.getValue();if(xValue<=0||standardDevValue<=0)return ErrorValueObject.create(error_type_ErrorType.NUM);const result=lognormalCDF(xValue,meanValue,standardDevValue);return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=3,this.maxParams=3}},FUNCTION_NAMES_COMPATIBILITY.LOGNORMDIST],[LognormInv,FUNCTION_NAMES_COMPATIBILITY.LOGINV],[ModeSngl,FUNCTION_NAMES_COMPATIBILITY.MODE],[class Negbinomdist extends base_function_BaseFunction{calculate(numberF,numberS,probabilityS){const maxRowLength=Math.max(numberF.isArray()?numberF.getRowCount():1,numberS.isArray()?numberS.getRowCount():1,probabilityS.isArray()?probabilityS.getRowCount():1),maxColumnLength=Math.max(numberF.isArray()?numberF.getColumnCount():1,numberS.isArray()?numberS.getColumnCount():1,probabilityS.isArray()?probabilityS.getColumnCount():1),numberFArray=expandArrayValueObject(maxRowLength,maxColumnLength,numberF,ErrorValueObject.create(error_type_ErrorType.NA)),numberSArray=expandArrayValueObject(maxRowLength,maxColumnLength,numberS,ErrorValueObject.create(error_type_ErrorType.NA)),probabilitySArray=expandArrayValueObject(maxRowLength,maxColumnLength,probabilityS,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=numberFArray.mapValue(((numberFObject,rowIndex,columnIndex)=>{const numberSObject=numberSArray.get(rowIndex,columnIndex),probabilitySObject=probabilitySArray.get(rowIndex,columnIndex);return numberFObject.isError()?numberFObject:numberSObject.isError()?numberSObject:probabilitySObject.isError()?probabilitySObject:this._handleSignleObject(numberFObject,numberSObject,probabilitySObject)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_handleSignleObject(numberFObject,numberSObject,probabilitySObject){const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(numberFObject,numberSObject,probabilitySObject);if(isError)return errorObject;const[_numberFObject,_numberSObject,_probabilitySObject]=variants,numberFValue=Math.floor(+_numberFObject.getValue()),numberSValue=Math.floor(+_numberSObject.getValue()),probabilitySValue=+_probabilitySObject.getValue();if(numberFValue<0||numberSValue<1||probabilitySValue<=0||probabilitySValue>=1)return ErrorValueObject.create(error_type_ErrorType.NUM);const result=negbinomialPDF(numberFValue,numberSValue,probabilitySValue);return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=3,this.maxParams=3}},FUNCTION_NAMES_COMPATIBILITY.NEGBINOMDIST],[NormDist,FUNCTION_NAMES_COMPATIBILITY.NORMDIST],[NormInv,FUNCTION_NAMES_COMPATIBILITY.NORMINV],[class Normsdist extends base_function_BaseFunction{calculate(z){if(z.isArray()){const resultArray=z.mapValue((zObject=>this._handleSignleObject(zObject)));return 1===z.getRowCount()&&1===z.getColumnCount()?resultArray.get(0,0):resultArray}return this._handleSignleObject(z)}_handleSignleObject(zObject){const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(zObject);if(isError)return errorObject;const[_zObject]=variants,result=normalCDF(+_zObject.getValue(),0,1);return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_COMPATIBILITY.NORMSDIST],[NormSInv,FUNCTION_NAMES_COMPATIBILITY.NORMSINV],[PercentileInc,FUNCTION_NAMES_COMPATIBILITY.PERCENTILE],[PercentrankInc,FUNCTION_NAMES_COMPATIBILITY.PERCENTRANK],[PoissonDist,FUNCTION_NAMES_COMPATIBILITY.POISSON],[QuartileInc,FUNCTION_NAMES_COMPATIBILITY.QUARTILE],[class Rank extends base_function_BaseFunction{calculate(number,ref,order){let _number=number;_number.isReferenceObject()&&(_number=_number.toArrayValueObject());const{refHasError,refErrorObject,refNumbers}=this._checkRefReferenceObject(ref);let _order=order??NumberValueObject.create(0);_order.isReferenceObject()&&(_order=_order.toArrayValueObject());const maxRowLength=Math.max(_number.isArray()?_number.getRowCount():1,_order.isArray()?_order.getRowCount():1),maxColumnLength=Math.max(_number.isArray()?_number.getColumnCount():1,_order.isArray()?_order.getColumnCount():1),numberArray=expandArrayValueObject(maxRowLength,maxColumnLength,_number,ErrorValueObject.create(error_type_ErrorType.NA)),orderArray=expandArrayValueObject(maxRowLength,maxColumnLength,_order,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=numberArray.map(((numberObject,rowIndex,columnIndex)=>{const orderObject=orderArray.get(rowIndex,columnIndex);if(!number.isReferenceObject()&&number.isNull())return ErrorValueObject.create(error_type_ErrorType.NA);if(refHasError)return refErrorObject;if(orderObject.isError())return orderObject;const numberValue=+numberObject.getValue(),orderValue=+orderObject.getValue();if(Number.isNaN(numberValue)||Number.isNaN(orderValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);const result=refNumbers.sort(((a,b)=>orderValue?a-b:b-a)).indexOf(numberValue);return-1===result?ErrorValueObject.create(error_type_ErrorType.NA):NumberValueObject.create(result+1)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_checkRefReferenceObject(ref){let refHasError=!1,refErrorObject=ErrorValueObject.create(error_type_ErrorType.NA);const refNumbers=[];if(!ref.isReferenceObject())return{refHasError:!0,refErrorObject,refNumbers};return ref.toArrayValueObject().iterator((refObject=>{const _refObject=refObject;if(_refObject.isError())return refHasError=!0,refErrorObject=_refObject,!1;if(_refObject.isNull()||_refObject.isBoolean())return!0;const refValue=+_refObject.getValue();if(Number.isNaN(refValue))return!0;refNumbers.push(refValue)})),{refHasError,refErrorObject,refNumbers}}constructor(...args){super(...args),this.minParams=2,this.maxParams=3,this.needsReferenceObject=!0}},FUNCTION_NAMES_COMPATIBILITY.RANK],[StdevS,FUNCTION_NAMES_COMPATIBILITY.STDEV],[StdevP,FUNCTION_NAMES_COMPATIBILITY.STDEVP],[class Tdist extends base_function_BaseFunction{calculate(x,degFreedom,tails){const maxRowLength=Math.max(x.isArray()?x.getRowCount():1,degFreedom.isArray()?degFreedom.getRowCount():1,tails.isArray()?tails.getRowCount():1),maxColumnLength=Math.max(x.isArray()?x.getColumnCount():1,degFreedom.isArray()?degFreedom.getColumnCount():1,tails.isArray()?tails.getColumnCount():1),xArray=expandArrayValueObject(maxRowLength,maxColumnLength,x,ErrorValueObject.create(error_type_ErrorType.NA)),degFreedomArray=expandArrayValueObject(maxRowLength,maxColumnLength,degFreedom,ErrorValueObject.create(error_type_ErrorType.NA)),tailsArray=expandArrayValueObject(maxRowLength,maxColumnLength,tails,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=xArray.mapValue(((xObject,rowIndex,columnIndex)=>{const degFreedomObject=degFreedomArray.get(rowIndex,columnIndex),tailsObject=tailsArray.get(rowIndex,columnIndex);return xObject.isError()?xObject:degFreedomObject.isError()?degFreedomObject:tailsObject.isError()?tailsObject:this._handleSignleObject(xObject,degFreedomObject,tailsObject)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_handleSignleObject(xObject,degFreedomObject,tailsObject){const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(xObject,degFreedomObject,tailsObject);if(isError)return errorObject;const[_xObject,_degFreedomObject,_tailsObject]=variants,xValue=+_xObject.getValue(),degFreedomValue=Math.floor(+_degFreedomObject.getValue()),tailsValue=Math.floor(+_tailsObject.getValue());if(xValue<0||degFreedomValue<1||degFreedomValue>10**10||tailsValue<1||tailsValue>2)return ErrorValueObject.create(error_type_ErrorType.NUM);let result=studentTCDF(-xValue,degFreedomValue);return 2===tailsValue&&(result*=2),Number.isNaN(result)||!Number.isFinite(result)?ErrorValueObject.create(error_type_ErrorType.NUM):NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=3,this.maxParams=3}},FUNCTION_NAMES_COMPATIBILITY.TDIST],[TInv2t,FUNCTION_NAMES_COMPATIBILITY.TINV],[TTest,FUNCTION_NAMES_COMPATIBILITY.TTEST],[VarS,FUNCTION_NAMES_COMPATIBILITY.VAR],[VarP,FUNCTION_NAMES_COMPATIBILITY.VARP],[WeibullDist,FUNCTION_NAMES_COMPATIBILITY.WEIBULL],[ZTest,FUNCTION_NAMES_COMPATIBILITY.ZTEST]];function checkDatabase(database){const databaseValues=[];if(database.isError())return{isError:!0,errorObject:database,databaseValues};const rowCount=database.isArray()?database.getRowCount():1,columnCount=database.isArray()?database.getColumnCount():1;if(rowCount<2)return{isError:!0,errorObject:ErrorValueObject.create(error_type_ErrorType.VALUE),databaseValues};for(let r=0;r<rowCount;r++){const row=[];for(let c=0;c<columnCount;c++){const valueObject=database.get(r,c);if(valueObject.isNull()){row.push(null);continue}let value=`${valueObject.getValue()}`;valueObject.isBoolean()&&(value=value.toLocaleUpperCase()),valueObject.isNumber()||(0,src.DMQ)(value)?row.push(+value):row.push(value)}databaseValues.push(row)}return{isError:!1,errorObject:null,databaseValues}}function checkField(field,database){let fieldIndex=-1;if(field.isError())return{isError:!0,errorObject:field,fieldIndex};const rowCount=field.isArray()?field.getRowCount():1,columnCount=field.isArray()?field.getColumnCount():1;if(rowCount>1||columnCount>1)return{isError:!0,errorObject:ErrorValueObject.create(error_type_ErrorType.VALUE),fieldIndex};const fieldObject=field.isArray()?field.get(0,0):field;let fieldValue=`${fieldObject.getValue()}`;if(fieldObject.isNull()?fieldValue=0:fieldObject.isBoolean()?fieldValue=fieldObject.getValue()?1:0:(fieldObject.isNumber()||(0,src.DMQ)(fieldValue))&&(fieldValue=Math.floor(+fieldValue)),"number"==typeof fieldValue){if(fieldValue<1||fieldValue>database[0].length)return{isError:!0,errorObject:ErrorValueObject.create(error_type_ErrorType.VALUE),fieldIndex};fieldIndex=fieldValue-1}else if(fieldIndex=database[0].findIndex((value=>null!==value&&`${value}`.toLocaleLowerCase()===fieldValue.toLocaleLowerCase())),-1===fieldIndex)return{isError:!0,errorObject:ErrorValueObject.create(error_type_ErrorType.VALUE),fieldIndex};return{isError:!1,errorObject:null,fieldIndex}}function checkCriteria(criteria){const criteriaValues=[];if(criteria.isError())return{isError:!0,errorObject:criteria,criteriaValues};const rowCount=criteria.isArray()?criteria.getRowCount():1,columnCount=criteria.isArray()?criteria.getColumnCount():1;if(rowCount<2)return{isError:!0,errorObject:ErrorValueObject.create(error_type_ErrorType.VALUE),criteriaValues};for(let r=0;r<rowCount;r++){const row=[];for(let c=0;c<columnCount;c++){const valueObject=criteria.get(r,c);if(valueObject.isNull()){row.push(null);continue}const value=`${valueObject.getValue()}`;valueObject.isBoolean()?row.push(valueObject.getValue()?1:0):valueObject.isNumber()||(0,src.DMQ)(value)?row.push(+value):row.push(value)}criteriaValues.push(row)}return{isError:!1,errorObject:null,criteriaValues}}function isCriteriaMatch(criteria,database,databaseRowIndex){const rowCount=criteria.length,columnCount=criteria[0].length,criteriaTitleIndexCache={};let isMatch=!1;for(let r=1;r<rowCount;r++){let isRowMatch=!0;for(let c=0;c<columnCount;c++){const criteriaValue=criteria[r][c];if(null===criteriaValue)continue;let criteriaTitleIndex=criteriaTitleIndexCache[c];if(void 0===criteriaTitleIndex){const criteriaTitleValue=criteria[0][c];criteriaTitleIndex=database[0].findIndex((value=>null!==value&&null!==criteriaTitleValue&&`${value}`.toLocaleLowerCase()===`${criteriaTitleValue}`.toLocaleLowerCase())),criteriaTitleIndexCache[c]=criteriaTitleIndex}if(-1===criteriaTitleIndex&&("string"==typeof criteriaValue||0===criteriaValue)){isRowMatch=!1;break}if(criteriaTitleIndex>-1){const databaseValue=database[databaseRowIndex][criteriaTitleIndex];if(null===databaseValue){isRowMatch=!1;break}const[compareToken,criteriaObject]=findCompareToken(`${criteriaValue}`);if(!ValueObjectFactory.create(`${databaseValue}`).compare(criteriaObject,compareToken).getValue()){isRowMatch=!1;break}}}if(isRowMatch){isMatch=!0;break}}return isMatch}var FUNCTION_NAMES_DATABASE=function(FUNCTION_NAMES_DATABASE){return FUNCTION_NAMES_DATABASE.DAVERAGE="DAVERAGE",FUNCTION_NAMES_DATABASE.DCOUNT="DCOUNT",FUNCTION_NAMES_DATABASE.DCOUNTA="DCOUNTA",FUNCTION_NAMES_DATABASE.DGET="DGET",FUNCTION_NAMES_DATABASE.DMAX="DMAX",FUNCTION_NAMES_DATABASE.DMIN="DMIN",FUNCTION_NAMES_DATABASE.DPRODUCT="DPRODUCT",FUNCTION_NAMES_DATABASE.DSTDEV="DSTDEV",FUNCTION_NAMES_DATABASE.DSTDEVP="DSTDEVP",FUNCTION_NAMES_DATABASE.DSUM="DSUM",FUNCTION_NAMES_DATABASE.DVAR="DVAR",FUNCTION_NAMES_DATABASE.DVARP="DVARP",FUNCTION_NAMES_DATABASE}({});const functionDatabase=[[class Daverage extends base_function_BaseFunction{calculate(database,field,criteria){const{isError:databaseIsError,errorObject:databaseErrorObject,databaseValues}=checkDatabase(database);if(databaseIsError)return databaseErrorObject;const{isError:fieldIsError,errorObject:filedErrorObject,fieldIndex}=checkField(field,databaseValues);if(fieldIsError)return filedErrorObject;const{isError:criteriaIsError,errorObject:criteriaErrorObject,criteriaValues}=checkCriteria(criteria);if(criteriaIsError)return criteriaErrorObject;let sum=0,count=0;for(let r=1;r<databaseValues.length;r++){const value=databaseValues[r][fieldIndex];"number"==typeof value&&(isCriteriaMatch(criteriaValues,databaseValues,r)&&(sum+=value,count++))}return 0===count?ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO):NumberValueObject.create(sum/count)}constructor(...args){super(...args),this.minParams=3,this.maxParams=3}},FUNCTION_NAMES_DATABASE.DAVERAGE],[class Dcount extends base_function_BaseFunction{calculate(database,field,criteria){const{isError:databaseIsError,errorObject:databaseErrorObject,databaseValues}=checkDatabase(database);if(databaseIsError)return databaseErrorObject;const{isError:fieldIsError,errorObject:filedErrorObject,fieldIndex}=checkField(field,databaseValues);if(fieldIsError)return filedErrorObject;const{isError:criteriaIsError,errorObject:criteriaErrorObject,criteriaValues}=checkCriteria(criteria);if(criteriaIsError)return criteriaErrorObject;let count=0;for(let r=1;r<databaseValues.length;r++){"number"==typeof databaseValues[r][fieldIndex]&&(isCriteriaMatch(criteriaValues,databaseValues,r)&&count++)}return NumberValueObject.create(count)}constructor(...args){super(...args),this.minParams=3,this.maxParams=3}},FUNCTION_NAMES_DATABASE.DCOUNT],[class Dcounta extends base_function_BaseFunction{calculate(database,field,criteria){const{isError:databaseIsError,errorObject:databaseErrorObject,databaseValues}=checkDatabase(database);if(databaseIsError)return databaseErrorObject;const{isError:fieldIsError,errorObject:filedErrorObject,fieldIndex}=checkField(field,databaseValues);if(fieldIsError)return filedErrorObject;const{isError:criteriaIsError,errorObject:criteriaErrorObject,criteriaValues}=checkCriteria(criteria);if(criteriaIsError)return criteriaErrorObject;let count=0;for(let r=1;r<databaseValues.length;r++){const value=databaseValues[r][fieldIndex];null!=value&&(isCriteriaMatch(criteriaValues,databaseValues,r)&&count++)}return NumberValueObject.create(count)}constructor(...args){super(...args),this.minParams=3,this.maxParams=3}},FUNCTION_NAMES_DATABASE.DCOUNTA],[class Dget extends base_function_BaseFunction{calculate(database,field,criteria){const{isError:databaseIsError,errorObject:databaseErrorObject,databaseValues}=checkDatabase(database);if(databaseIsError)return databaseErrorObject;const{isError:fieldIsError,errorObject:filedErrorObject,fieldIndex}=checkField(field,databaseValues);if(fieldIsError)return filedErrorObject;const{isError:criteriaIsError,errorObject:criteriaErrorObject,criteriaValues}=checkCriteria(criteria);if(criteriaIsError)return criteriaErrorObject;let count=0,resultRowIndex=0;for(let r=1;r<databaseValues.length;r++){const value=databaseValues[r][fieldIndex];null!=value&&(isCriteriaMatch(criteriaValues,databaseValues,r)&&(count++,resultRowIndex=r))}return 0===count?ErrorValueObject.create(error_type_ErrorType.VALUE):count>1?ErrorValueObject.create(error_type_ErrorType.NUM):database.get(resultRowIndex,fieldIndex)}constructor(...args){super(...args),this.minParams=3,this.maxParams=3}},FUNCTION_NAMES_DATABASE.DGET],[class Dmax extends base_function_BaseFunction{calculate(database,field,criteria){const{isError:databaseIsError,errorObject:databaseErrorObject,databaseValues}=checkDatabase(database);if(databaseIsError)return databaseErrorObject;const{isError:fieldIsError,errorObject:filedErrorObject,fieldIndex}=checkField(field,databaseValues);if(fieldIsError)return filedErrorObject;const{isError:criteriaIsError,errorObject:criteriaErrorObject,criteriaValues}=checkCriteria(criteria);if(criteriaIsError)return criteriaErrorObject;let result=-1/0,count=0;for(let r=1;r<databaseValues.length;r++){const value=databaseValues[r][fieldIndex];"number"==typeof value&&(isCriteriaMatch(criteriaValues,databaseValues,r)&&(result=Math.max(result,value),count++))}return 0===count?NumberValueObject.create(0):NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=3,this.maxParams=3}},FUNCTION_NAMES_DATABASE.DMAX],[class Dmin extends base_function_BaseFunction{calculate(database,field,criteria){const{isError:databaseIsError,errorObject:databaseErrorObject,databaseValues}=checkDatabase(database);if(databaseIsError)return databaseErrorObject;const{isError:fieldIsError,errorObject:filedErrorObject,fieldIndex}=checkField(field,databaseValues);if(fieldIsError)return filedErrorObject;const{isError:criteriaIsError,errorObject:criteriaErrorObject,criteriaValues}=checkCriteria(criteria);if(criteriaIsError)return criteriaErrorObject;let result=1/0,count=0;for(let r=1;r<databaseValues.length;r++){const value=databaseValues[r][fieldIndex];"number"==typeof value&&(isCriteriaMatch(criteriaValues,databaseValues,r)&&(result=Math.min(result,value),count++))}return 0===count?NumberValueObject.create(0):NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=3,this.maxParams=3}},FUNCTION_NAMES_DATABASE.DMIN],[class Dproduct extends base_function_BaseFunction{calculate(database,field,criteria){const{isError:databaseIsError,errorObject:databaseErrorObject,databaseValues}=checkDatabase(database);if(databaseIsError)return databaseErrorObject;const{isError:fieldIsError,errorObject:filedErrorObject,fieldIndex}=checkField(field,databaseValues);if(fieldIsError)return filedErrorObject;const{isError:criteriaIsError,errorObject:criteriaErrorObject,criteriaValues}=checkCriteria(criteria);if(criteriaIsError)return criteriaErrorObject;let result=1,count=0;for(let r=1;r<databaseValues.length;r++){const value=databaseValues[r][fieldIndex];"number"==typeof value&&(isCriteriaMatch(criteriaValues,databaseValues,r)&&(result*=value,count++))}return 0===count?NumberValueObject.create(0):NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=3,this.maxParams=3}},FUNCTION_NAMES_DATABASE.DPRODUCT],[class Dstdev extends base_function_BaseFunction{calculate(database,field,criteria){const{isError:databaseIsError,errorObject:databaseErrorObject,databaseValues}=checkDatabase(database);if(databaseIsError)return databaseErrorObject;const{isError:fieldIsError,errorObject:filedErrorObject,fieldIndex}=checkField(field,databaseValues);if(fieldIsError)return filedErrorObject;const{isError:criteriaIsError,errorObject:criteriaErrorObject,criteriaValues}=checkCriteria(criteria);if(criteriaIsError)return criteriaErrorObject;const values=[];let sum=0,count=0;for(let r=1;r<databaseValues.length;r++){const value=databaseValues[r][fieldIndex];"number"==typeof value&&(isCriteriaMatch(criteriaValues,databaseValues,r)&&(values.push(value),sum+=value,count++))}if(count<=1)return ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO);const mean=sum/count;let sumOfSquaresDifferences=0;for(let i=0;i<count;i++)sumOfSquaresDifferences+=(values[i]-mean)**2;const result=Math.sqrt(sumOfSquaresDifferences/(count-1));return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=3,this.maxParams=3}},FUNCTION_NAMES_DATABASE.DSTDEV],[class Dstdevp extends base_function_BaseFunction{calculate(database,field,criteria){const{isError:databaseIsError,errorObject:databaseErrorObject,databaseValues}=checkDatabase(database);if(databaseIsError)return databaseErrorObject;const{isError:fieldIsError,errorObject:filedErrorObject,fieldIndex}=checkField(field,databaseValues);if(fieldIsError)return filedErrorObject;const{isError:criteriaIsError,errorObject:criteriaErrorObject,criteriaValues}=checkCriteria(criteria);if(criteriaIsError)return criteriaErrorObject;const values=[];let sum=0,count=0;for(let r=1;r<databaseValues.length;r++){const value=databaseValues[r][fieldIndex];"number"==typeof value&&(isCriteriaMatch(criteriaValues,databaseValues,r)&&(values.push(value),sum+=value,count++))}if(0===count)return ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO);const mean=sum/count;let sumOfSquaresDifferences=0;for(let i=0;i<count;i++)sumOfSquaresDifferences+=(values[i]-mean)**2;const result=Math.sqrt(sumOfSquaresDifferences/count);return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=3,this.maxParams=3}},FUNCTION_NAMES_DATABASE.DSTDEVP],[class Dsum extends base_function_BaseFunction{calculate(database,field,criteria){const{isError:databaseIsError,errorObject:databaseErrorObject,databaseValues}=checkDatabase(database);if(databaseIsError)return databaseErrorObject;const{isError:fieldIsError,errorObject:filedErrorObject,fieldIndex}=checkField(field,databaseValues);if(fieldIsError)return filedErrorObject;const{isError:criteriaIsError,errorObject:criteriaErrorObject,criteriaValues}=checkCriteria(criteria);if(criteriaIsError)return criteriaErrorObject;let result=0;for(let r=1;r<databaseValues.length;r++){const value=databaseValues[r][fieldIndex];"number"==typeof value&&(isCriteriaMatch(criteriaValues,databaseValues,r)&&(result+=value))}return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=3,this.maxParams=3}},FUNCTION_NAMES_DATABASE.DSUM],[class Dvar extends base_function_BaseFunction{calculate(database,field,criteria){const{isError:databaseIsError,errorObject:databaseErrorObject,databaseValues}=checkDatabase(database);if(databaseIsError)return databaseErrorObject;const{isError:fieldIsError,errorObject:filedErrorObject,fieldIndex}=checkField(field,databaseValues);if(fieldIsError)return filedErrorObject;const{isError:criteriaIsError,errorObject:criteriaErrorObject,criteriaValues}=checkCriteria(criteria);if(criteriaIsError)return criteriaErrorObject;const values=[];let sum=0,count=0;for(let r=1;r<databaseValues.length;r++){const value=databaseValues[r][fieldIndex];"number"==typeof value&&(isCriteriaMatch(criteriaValues,databaseValues,r)&&(values.push(value),sum+=value,count++))}if(count<=1)return ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO);const mean=sum/count;let sumOfSquaresDifferences=0;for(let i=0;i<count;i++)sumOfSquaresDifferences+=(values[i]-mean)**2;const result=sumOfSquaresDifferences/(count-1);return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=3,this.maxParams=3}},FUNCTION_NAMES_DATABASE.DVAR],[class Dvarp extends base_function_BaseFunction{calculate(database,field,criteria){const{isError:databaseIsError,errorObject:databaseErrorObject,databaseValues}=checkDatabase(database);if(databaseIsError)return databaseErrorObject;const{isError:fieldIsError,errorObject:filedErrorObject,fieldIndex}=checkField(field,databaseValues);if(fieldIsError)return filedErrorObject;const{isError:criteriaIsError,errorObject:criteriaErrorObject,criteriaValues}=checkCriteria(criteria);if(criteriaIsError)return criteriaErrorObject;const values=[];let sum=0,count=0;for(let r=1;r<databaseValues.length;r++){const value=databaseValues[r][fieldIndex];"number"==typeof value&&(isCriteriaMatch(criteriaValues,databaseValues,r)&&(values.push(value),sum+=value,count++))}if(0===count)return ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO);const mean=sum/count;let sumOfSquaresDifferences=0;for(let i=0;i<count;i++)sumOfSquaresDifferences+=(values[i]-mean)**2;const result=sumOfSquaresDifferences/count;return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=3,this.maxParams=3}},FUNCTION_NAMES_DATABASE.DVARP]];function excelDateSerial(date){const baseDate=new Date(Date.UTC(1900,0,1)),leapDayDate=new Date(Date.UTC(1900,1,28)),dateInUTC=Date.UTC(date.getFullYear(),date.getMonth(),date.getDate());let dayDifference=(dateInUTC-baseDate.getTime())/864e5;return dateInUTC>leapDayDate.getTime()&&(dayDifference+=1),Math.floor(dayDifference)+1}function excelDateTimeSerial(date){const baseDate=new Date(Date.UTC(1900,0,1,0,0,0)),leapDayDate=new Date(Date.UTC(1900,1,28,0,0,0));let dayDifference=(date.getTime()-baseDate.getTime())/864e5;return date>leapDayDate&&(dayDifference+=1),dayDifference+1}function excelSerialToDate(serial){const baseDate=new Date(Date.UTC(1900,0,1)),leapDayDate=new Date(Date.UTC(1900,1,28));let dayDifference=Math.floor(serial)-1;dayDifference>(leapDayDate.getTime()-baseDate.getTime())/864e5&&(dayDifference-=1);return new Date(baseDate.getTime()+864e5*dayDifference)}function excelSerialToDateTime(serial){const baseDate=new Date(Date.UTC(1900,0,1,0,0,0));let dayDifference=serial-1;dayDifference>(new Date(Date.UTC(1900,1,28,0,0,0)).getTime()-baseDate.getTime())/864e5&&(dayDifference-=1),dayDifference<0&&(dayDifference=serial);return new Date(baseDate.getTime()+864e5*dayDifference)}function isValidDateStr(dateStr){if(!/^\d{4}[-/](0?[1-9]|1[012])[-/](0?[1-9]|[12][0-9]|3[01])$/.test(dateStr))return!1;const normalizedDateStr=dateStr.replace(/-/g,"/").replace(/T.+/,""),dateWithTime=new Date(`${normalizedDateStr}`);if(Number.isNaN(dateWithTime.getTime()))return!1;const reconstructedDateStr=`${dateWithTime.getFullYear()}-${(dateWithTime.getMonth()+1).toString().padStart(2,"0")}-${dateWithTime.getDate().toString().padStart(2,"0")}`;return dateStr.replace(/\//g,"-").split("-").map((v=>v.padStart(2,"0"))).join("-")===reconstructedDateStr}function parseFormattedDate(value){return src.gIL.parseDate(value)}function parseFormattedValue(value){return src.gIL.parseValue(value)}function parseFormattedTime(value){return src.gIL.parseTime(value)}function isDate(format){return src.gIL.isDate(format)}const weekendNumberMap={1:[6,0],2:[0,1],3:[1,2],4:[2,3],5:[3,4],6:[4,5],7:[5,6],11:[0],12:[1],13:[2],14:[3],15:[4],16:[5],17:[6]};function isValidWeekend(weekend){return!("string"!=typeof weekend||!/^[0|1]{7}/.test(weekend))||!!weekendNumberMap[Number(weekend)]}function getWeekendArray(weekend){if(!isValidWeekend(weekend))return[];if("string"==typeof weekend&&/^[0|1]{7}/.test(weekend)){const result=[];for(let i=1;i<=weekend.length;i++)"1"==`${weekend[i-1]}`&&(i===weekend.length?result.push(0):result.push(i));return result}return weekendNumberMap[Number(weekend)]||[]}function countWorkingDays(startDateSerialNumber,endDateSerialNumber,weekend=1,holidays){const weekendArray=getWeekendArray(weekend),start=Math.floor(startDateSerialNumber),end=Math.floor(endDateSerialNumber),startSerialNumber=end>start?start:end;let workingDays=0;const daysDiff=Math.abs(Math.floor(endDateSerialNumber)-Math.floor(startDateSerialNumber))+1;for(let i=0;i<daysDiff;i++){const currentDateSerialNumber=startSerialNumber+i;if(holidays&&holidays.length>0&&holidays.some((item=>Math.floor(item)===currentDateSerialNumber)))continue;const weekDay=getWeekDayByDateSerialNumber(currentDateSerialNumber);weekendArray.includes(weekDay)||workingDays++}return end>=start?workingDays:-workingDays}function getDateSerialNumberByWorkingDays(startDateSerialNumber,workingDays,weekend=1,holidays){const weekendArray=getWeekendArray(weekend),_startDateSerialNumber=Math.floor(startDateSerialNumber);let targetDateSerialNumber=_startDateSerialNumber,days=Math.abs(workingDays);for(let i=1;i<=days;i++){const currentDateSerialNumber=workingDays<0?_startDateSerialNumber-i:_startDateSerialNumber+i;if(currentDateSerialNumber<0)return ErrorValueObject.create(error_type_ErrorType.NUM);if(holidays&&holidays.length>0&&holidays.some((item=>Math.floor(item)===currentDateSerialNumber))){days++;continue}const weekDay=getWeekDayByDateSerialNumber(currentDateSerialNumber);weekendArray.includes(weekDay)?days++:targetDateSerialNumber=currentDateSerialNumber}return targetDateSerialNumber}function getDateSerialNumberByObject(serialNumberObject){if(serialNumberObject.isError())return serialNumberObject;const dateValue=serialNumberObject.getValue();if(serialNumberObject.isString()){let dateSerial;if(parseFormattedDate(`${dateValue}`))dateSerial=parseFormattedDate(`${dateValue}`).v;else if(parseFormattedTime(`${dateValue}`))dateSerial=parseFormattedTime(`${dateValue}`).v;else{if(!(0,src.DMQ)(dateValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);dateSerial=+dateValue}return dateSerial instanceof Date&&(dateSerial=excelDateTimeSerial(dateSerial)),+dateSerial<0||+dateSerial>2958465?ErrorValueObject.create(error_type_ErrorType.NUM):+dateSerial}{const dateSerial=+serialNumberObject.getValue();return dateSerial<0||dateSerial>2958465?ErrorValueObject.create(error_type_ErrorType.NUM):dateSerial}}function getWeekDayByDateSerialNumber(dateSerialNumber){const isDate19000229=60===Math.floor(dateSerialNumber);let date=excelSerialToDate(dateSerialNumber);const dateTime=new Date(Date.UTC(date.getFullYear(),date.getMonth(),date.getDate())).getTime(),leapDayDateTime=new Date(Date.UTC(1900,1,28)).getTime();return!isDate19000229&&dateTime<=leapDayDateTime&&(date=new Date(dateTime-864e5)),new Date(Date.UTC(date.getFullYear(),date.getMonth(),date.getDate())).getUTCDay()}function getTwoDateDaysByBasis(startDateSerialNumber,endDateSerialNumber,basis){switch(basis){case 0:return function getDaysByNASD(startDateSerialNumber,endDateSerialNumber){const startDateDate=excelSerialToDate(startDateSerialNumber),startYear=startDateSerialNumber>0?startDateDate.getUTCFullYear():1900,startMonth=startDateSerialNumber>0?startDateDate.getUTCMonth()+1:1;let startDay=startDateSerialNumber>0?startDateDate.getUTCDate():0,endDateDate=excelSerialToDate(endDateSerialNumber),endYear=endDateSerialNumber>0?endDateDate.getUTCFullYear():1900,endMonth=endDateSerialNumber>0?endDateDate.getUTCMonth()+1:1,endDay=endDateSerialNumber>0?endDateDate.getUTCDate():0;if(2===startMonth){excelSerialToDate(startDateSerialNumber+1).getUTCMonth()+1===3&&(startDay=30)}else 31===startDay&&(startDay=30);31===endDay&&(startDay<30?(endDateDate=excelSerialToDate(endDateSerialNumber+1),endYear=endDateDate.getUTCFullYear(),endMonth=endDateDate.getUTCMonth()+1,endDay=endDateDate.getUTCDate()):endDay=30);const daysInYears=360*(endYear-startYear),daysInStartMonth=endDateSerialNumber>=startDateSerialNumber?30-startDay:-startDay,daysInEndMonth=endDateSerialNumber>=startDateSerialNumber?endDay:endDay-30,daysInMidMonths=30*(endDateSerialNumber>=startDateSerialNumber?endMonth-startMonth-1:endMonth-startMonth+1);return{days:Math.abs(daysInYears+daysInStartMonth+daysInEndMonth+daysInMidMonths),yearDays:360}}(startDateSerialNumber,endDateSerialNumber);case 1:return function getDaysByActual(startDateSerialNumber,endDateSerialNumber){const startDateDate=excelSerialToDate(startDateSerialNumber),startYear=startDateSerialNumber>0?startDateDate.getUTCFullYear():1900,endDateDate=excelSerialToDate(endDateSerialNumber),endYear=endDateSerialNumber>0?endDateDate.getUTCFullYear():1900,totalDays=Math.abs(endDateSerialNumber-startDateSerialNumber),totalYear=Math.abs(endYear-startYear)+1;let startYearFirstDaySerialNumber,endYearLastDaySerialNumber;if(endYear<startYear){const startYearFirstDay=new Date(Date.UTC(endYear,0,1)),endYearLastDay=new Date(Date.UTC(startYear,11,31));startYearFirstDaySerialNumber=excelDateSerial(startYearFirstDay),endYearLastDaySerialNumber=excelDateSerial(endYearLastDay),1900===endYear&&(startYearFirstDaySerialNumber+=1)}else{const startYearFirstDay=new Date(Date.UTC(startYear,0,1)),endYearLastDay=new Date(Date.UTC(endYear,11,31));startYearFirstDaySerialNumber=excelDateSerial(startYearFirstDay),endYearLastDaySerialNumber=excelDateSerial(endYearLastDay),1900===startYear&&(startYearFirstDaySerialNumber+=1)}return{days:totalDays,yearDays:(endYearLastDaySerialNumber-startYearFirstDaySerialNumber+1)/totalYear}}(startDateSerialNumber,endDateSerialNumber);case 2:return{days:Math.abs(endDateSerialNumber-startDateSerialNumber),yearDays:360};case 3:default:return{days:Math.abs(endDateSerialNumber-startDateSerialNumber),yearDays:365};case 4:return function getDaysByEuropean(startDateSerialNumber,endDateSerialNumber){const startDateDate=excelSerialToDate(startDateSerialNumber),startYear=startDateSerialNumber>0?startDateDate.getUTCFullYear():1900,startMonth=startDateSerialNumber>0?startDateDate.getUTCMonth()+1:1;let startDay=startDateSerialNumber>0?startDateDate.getUTCDate():0;const endDateDate=excelSerialToDate(endDateSerialNumber),endYear=endDateSerialNumber>0?endDateDate.getUTCFullYear():1900,endMonth=endDateSerialNumber>0?endDateDate.getUTCMonth()+1:1;let endDay=endDateSerialNumber>0?endDateDate.getUTCDate():0;31===startDay&&(startDay=30);31===endDay&&(endDay=30);const daysInYears=360*(endYear-startYear),daysInStartMonth=endDateSerialNumber>=startDateSerialNumber?30-startDay:-startDay,daysInEndMonth=endDateSerialNumber>=startDateSerialNumber?endDay:endDay-30,daysInMidMonths=30*(endDateSerialNumber>=startDateSerialNumber?endMonth-startMonth-1:endMonth-startMonth+1);return{days:Math.abs(daysInYears+daysInStartMonth+daysInEndMonth+daysInMidMonths),yearDays:360}}(startDateSerialNumber,endDateSerialNumber)}}const daysInMonthL=[31,29,31,30,31,30,31,31,30,31,30,31],daysInMonthR=[31,28,31,30,31,30,31,31,30,31,30,31];function getDaysInMonth(year,month){return function isLeapYear(year){return year%4==0&&year%100!=0||year%400==0}(year)?daysInMonthL[month]:daysInMonthR[month]}function getDaysInYear(year){return function isLeapYear1900(year){return year%4==0&&year%100!=0||year%400==0||1900===year}(year)?366:365}function getNormalYearDaysByBasis(dateSerialNumber,basis){switch(basis){case 0:case 2:case 4:return 360;case 1:return getDaysInYear(excelSerialToDate(dateSerialNumber).getUTCFullYear());case 3:return 365;default:return-1}}function lastDayOfMonth(year,month,day){return getDaysInMonth(year,month)===day}function dateAddMonths(date,months){let year=date.getUTCFullYear(),month=date.getUTCMonth();return lastDayOfMonth(year,month,date.getUTCDate())?(date.setUTCDate(1),date.setUTCMonth(date.getUTCMonth()+months),year=date.getUTCFullYear(),month=date.getUTCMonth(),date.setUTCDate(getDaysInMonth(year,month))):date.setUTCMonth(date.getUTCMonth()+months),date}var FUNCTION_NAMES_DATE=function(FUNCTION_NAMES_DATE){return FUNCTION_NAMES_DATE.DATE="DATE",FUNCTION_NAMES_DATE.DATEDIF="DATEDIF",FUNCTION_NAMES_DATE.DATEVALUE="DATEVALUE",FUNCTION_NAMES_DATE.DAY="DAY",FUNCTION_NAMES_DATE.DAYS="DAYS",FUNCTION_NAMES_DATE.DAYS360="DAYS360",FUNCTION_NAMES_DATE.EDATE="EDATE",FUNCTION_NAMES_DATE.EOMONTH="EOMONTH",FUNCTION_NAMES_DATE.EPOCHTODATE="EPOCHTODATE",FUNCTION_NAMES_DATE.HOUR="HOUR",FUNCTION_NAMES_DATE.ISOWEEKNUM="ISOWEEKNUM",FUNCTION_NAMES_DATE.MINUTE="MINUTE",FUNCTION_NAMES_DATE.MONTH="MONTH",FUNCTION_NAMES_DATE.NETWORKDAYS="NETWORKDAYS",FUNCTION_NAMES_DATE.NETWORKDAYS_INTL="NETWORKDAYS.INTL",FUNCTION_NAMES_DATE.NOW="NOW",FUNCTION_NAMES_DATE.SECOND="SECOND",FUNCTION_NAMES_DATE.TIME="TIME",FUNCTION_NAMES_DATE.TIMEVALUE="TIMEVALUE",FUNCTION_NAMES_DATE.TO_DATE="TO_DATE",FUNCTION_NAMES_DATE.TODAY="TODAY",FUNCTION_NAMES_DATE.WEEKDAY="WEEKDAY",FUNCTION_NAMES_DATE.WEEKNUM="WEEKNUM",FUNCTION_NAMES_DATE.WORKDAY="WORKDAY",FUNCTION_NAMES_DATE.WORKDAY_INTL="WORKDAY.INTL",FUNCTION_NAMES_DATE.YEAR="YEAR",FUNCTION_NAMES_DATE.YEARFRAC="YEARFRAC",FUNCTION_NAMES_DATE}({});const functionDate=[[class DateFunction extends base_function_BaseFunction{calculate(year,month,day){if(year.isError())return year;if(month.isError())return month;if(day.isError())return day;const maxRowLength=Math.max(year.isArray()?year.getRowCount():1,month.isArray()?month.getRowCount():1,day.isArray()?day.getRowCount():1),maxColumnLength=Math.max(year.isArray()?year.getColumnCount():1,month.isArray()?month.getColumnCount():1,day.isArray()?day.getColumnCount():1),yearArray=expandArrayValueObject(maxRowLength,maxColumnLength,year),monthArray=expandArrayValueObject(maxRowLength,maxColumnLength,month),dayArray=expandArrayValueObject(maxRowLength,maxColumnLength,day);return yearArray.map(((yearValueObject,rowIndex,columnIndex)=>{const monthValueObject=monthArray.get(rowIndex,columnIndex)||NullValueObject.create(),dayValueObject=dayArray.get(rowIndex,columnIndex)||NullValueObject.create();if(yearValueObject.isError())return yearValueObject;if(monthValueObject.isError())return monthValueObject;if(dayValueObject.isError())return dayValueObject;if(yearValueObject.isString()||monthValueObject.isString()||dayValueObject.isString())return ErrorValueObject.create(error_type_ErrorType.VALUE);let yearValue=+yearValueObject.getValue();const monthValue=Math.floor(+monthValueObject.getValue()),dayValue=+dayValueObject.getValue();if(yearValue<0||yearValue>9999)return ErrorValueObject.create(error_type_ErrorType.NUM);yearValue>=0&&yearValue<1899&&(yearValue+=1900);const currentSerial=excelDateSerial(new Date(yearValue,monthValue-1,dayValue));if(currentSerial<0)return ErrorValueObject.create(error_type_ErrorType.NUM);return NumberValueObject.create(currentSerial,"yyyy/mm/dd;@")}))}constructor(...args){super(...args),this.minParams=3,this.maxParams=3}},FUNCTION_NAMES_DATE.DATE],[class Datedif extends base_function_BaseFunction{calculate(startDate,endDate,unit){let _startDate=startDate,_endDate=endDate,_unit=unit;if(_startDate.isArray()&&(_startDate=_startDate.get(0,0)),_endDate.isArray()&&(_endDate=_endDate.get(0,0)),_unit.isArray()&&(_unit=_unit.get(0,0)),_startDate.isError())return _startDate;if(_endDate.isError())return _endDate;if(_unit.isError())return _unit;const startDateSerialNumber=getDateSerialNumberByObject(_startDate);if("number"!=typeof startDateSerialNumber)return startDateSerialNumber;const endDateSerialNumber=getDateSerialNumberByObject(_endDate);return"number"!=typeof endDateSerialNumber?endDateSerialNumber:endDateSerialNumber<startDateSerialNumber?ErrorValueObject.create(error_type_ErrorType.NUM):_unit.isString()?this._getResultByUnit(startDateSerialNumber,endDateSerialNumber,_unit):ErrorValueObject.create(error_type_ErrorType.NUM)}_getResultByUnit(startDateSerialNumber,endDateSerialNumber,unit){const startDateDate=excelSerialToDate(startDateSerialNumber),startYear=startDateDate.getUTCFullYear(),startMonth=startDateDate.getUTCMonth()+1,startDay=startDateDate.getUTCDate(),endDateDate=excelSerialToDate(endDateSerialNumber),endYear=endDateDate.getUTCFullYear(),endMonth=endDateDate.getUTCMonth()+1,endDay=endDateDate.getUTCDate();let newDate,diff=0;switch(`${unit.getValue()}`.toLocaleUpperCase()){case"Y":diff=endYear-startYear,(endMonth<startMonth||endMonth===startMonth&&endDay<startDay)&&(diff-=1);break;case"M":diff=12*(endYear-startYear)+endMonth-startMonth,endDay<startDay&&(diff-=1);break;case"D":diff=Math.floor(endDateSerialNumber)-Math.floor(startDateSerialNumber);break;case"MD":diff=endDay-startDay,endDay<startDay&&(newDate=new Date(Date.UTC(endYear,endMonth-1,0)),diff+=getDaysInMonth(newDate.getUTCFullYear(),newDate.getUTCMonth()));break;case"YM":diff=endMonth-startMonth,(endMonth<startMonth||endMonth===startMonth&&endDay<startDay)&&(diff+=12),endDay<startDay&&(diff-=1);break;case"YD":newDate=new Date(Date.UTC(startYear,endMonth-1,endDay)),(endMonth<startMonth||endMonth===startMonth&&endDay<startDay)&&(newDate=new Date(Date.UTC(startYear+1,endMonth-1,endDay))),diff=Math.floor(excelDateSerial(newDate))-Math.floor(startDateSerialNumber);break;default:return ErrorValueObject.create(error_type_ErrorType.NUM)}return NumberValueObject.create(diff)}constructor(...args){super(...args),this.minParams=3,this.maxParams=3}},FUNCTION_NAMES_DATE.DATEDIF],[class Datevalue extends base_function_BaseFunction{calculate(dateText){return dateText.isError()?dateText:dateText.isArray()?dateText.map((dateTextObject=>this._handleSingleObject(dateTextObject))):this._handleSingleObject(dateText)}_handleSingleObject(dateTextObject){if(dateTextObject.isString()){const parsedDate=parseFormattedValue(`${dateTextObject.getValue()}`);if(parsedDate){let{v,z}=parsedDate;if(z&&isDate(z))return v instanceof Date&&(v=excelDateTimeSerial(v)),NumberValueObject.create(Math.trunc(+v))}}return ErrorValueObject.create(error_type_ErrorType.VALUE)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_DATE.DATEVALUE],[class Day extends base_function_BaseFunction{calculate(serialNumber){return serialNumber.isError()?serialNumber:serialNumber.isArray()?serialNumber.map((serialNumberObject=>this._handleSingleObject(serialNumberObject))):this._handleSingleObject(serialNumber)}_handleSingleObject(serialNumberObject){let date;const dateValue=serialNumberObject.getValue();if(serialNumberObject.isString()){if(!isValidDateStr(`${dateValue}`))return ErrorValueObject.create(error_type_ErrorType.VALUE);date=new Date(`${dateValue}`)}else{const dateSerial=+serialNumberObject.getValue();if(dateSerial<0)return ErrorValueObject.create(error_type_ErrorType.NUM);if(0===dateSerial)return NumberValueObject.create(0);date=excelSerialToDate(dateSerial)}const month=date.getDate();return NumberValueObject.create(month)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_DATE.DAY],[class Days extends base_function_BaseFunction{calculate(endDate,startDate){if(endDate.isError())return endDate;if(startDate.isError())return startDate;const maxRowLength=Math.max(endDate.isArray()?endDate.getRowCount():1,startDate.isArray()?startDate.getRowCount():1),maxColumnLength=Math.max(endDate.isArray()?endDate.getColumnCount():1,startDate.isArray()?startDate.getColumnCount():1),endDateArray=expandArrayValueObject(maxRowLength,maxColumnLength,endDate),startDateArray=expandArrayValueObject(maxRowLength,maxColumnLength,startDate),resultArray=endDateArray.map(((endDateObject,rowIndex,columnIndex)=>{const startDateObject=startDateArray.get(rowIndex,columnIndex);if(endDateObject.isError())return endDateObject;if(startDateObject.isError())return startDateObject;const endDateSerialNumber=getDateSerialNumberByObject(endDateObject);if("number"!=typeof endDateSerialNumber)return endDateSerialNumber;const startDateSerialNumber=getDateSerialNumberByObject(startDateObject);if("number"!=typeof startDateSerialNumber)return startDateSerialNumber;const result=Math.floor(endDateSerialNumber)-Math.floor(startDateSerialNumber);return NumberValueObject.create(result)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_DATE.DAYS],[class Days360 extends base_function_BaseFunction{calculate(startDate,endDate,method){const _method=method??BooleanValueObject.create(!1);if(startDate.isError())return startDate;if(endDate.isError())return endDate;if(_method.isError())return _method;const maxRowLength=Math.max(startDate.isArray()?startDate.getRowCount():1,endDate.isArray()?endDate.getRowCount():1,_method.isArray()?_method.getRowCount():1),maxColumnLength=Math.max(startDate.isArray()?startDate.getColumnCount():1,endDate.isArray()?endDate.getColumnCount():1,_method.isArray()?_method.getColumnCount():1),startDateArray=expandArrayValueObject(maxRowLength,maxColumnLength,startDate,ErrorValueObject.create(error_type_ErrorType.NA)),endDateArray=expandArrayValueObject(maxRowLength,maxColumnLength,endDate,ErrorValueObject.create(error_type_ErrorType.NA)),methodArray=expandArrayValueObject(maxRowLength,maxColumnLength,_method,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=startDateArray.map(((startDateObject,rowIndex,columnIndex)=>{const endDateObject=endDateArray.get(rowIndex,columnIndex);let methodObject=methodArray.get(rowIndex,columnIndex);if(startDateObject.isError())return startDateObject;const startDateSerialNumber=getDateSerialNumberByObject(startDateObject);if("number"!=typeof startDateSerialNumber)return startDateSerialNumber;if(endDateObject.isError())return endDateObject;const endDateSerialNumber=getDateSerialNumberByObject(endDateObject);if("number"!=typeof endDateSerialNumber)return endDateSerialNumber;if(methodObject.isString()&&(methodObject=methodObject.convertToNumberObjectValue()),methodObject.isError())return methodObject;const methodValue=+methodObject.getValue(),{days}=getTwoDateDaysByBasis(startDateSerialNumber,endDateSerialNumber,methodValue?4:0),result=endDateSerialNumber>=startDateSerialNumber?days:-days;return NumberValueObject.create(result)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}constructor(...args){super(...args),this.minParams=2,this.maxParams=3}},FUNCTION_NAMES_DATE.DAYS360],[class Edate extends base_function_BaseFunction{calculate(startDate,months){if(startDate.isError())return startDate;if(months.isError())return months;const maxRowLength=Math.max(startDate.isArray()?startDate.getRowCount():1,months.isArray()?months.getRowCount():1),maxColumnLength=Math.max(startDate.isArray()?startDate.getColumnCount():1,months.isArray()?months.getColumnCount():1),startDateArray=expandArrayValueObject(maxRowLength,maxColumnLength,startDate),monthsArray=expandArrayValueObject(maxRowLength,maxColumnLength,months);return startDateArray.map(((startDateObject,rowIndex,columnIndex)=>{const monthsValueObject=monthsArray.get(rowIndex,columnIndex)||NullValueObject.create();if(startDateObject.isError())return startDateObject;if(monthsValueObject.isError())return monthsValueObject;if(startDateObject.isString()||startDateObject.isBoolean()||monthsValueObject.isString()||monthsValueObject.isBoolean())return ErrorValueObject.create(error_type_ErrorType.VALUE);const startDateSerial=+startDateObject.getValue();if(startDateSerial<0)return ErrorValueObject.create(error_type_ErrorType.NUM);const monthsValue=Math.floor(+monthsValueObject.getValue()),_startDate=excelSerialToDate(startDateSerial),year=_startDate.getUTCFullYear(),month=_startDate.getUTCMonth()+monthsValue,day=_startDate.getUTCDate(),currentSerial=excelDateSerial(new Date(Date.UTC(year,month,day)));return NumberValueObject.create(currentSerial,"yyyy/mm/dd;@")}))}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_DATE.EDATE],[class Eomonth extends base_function_BaseFunction{calculate(startDate,months){let _startDate=startDate,_months=months;if(_startDate.isArray()){const rowCount=_startDate.getRowCount(),columnCount=_startDate.getColumnCount();if(rowCount>1||columnCount>1)return ErrorValueObject.create(error_type_ErrorType.VALUE);_startDate=_startDate.get(0,0)}if(_months.isArray()){const rowCount=_months.getRowCount(),columnCount=_months.getColumnCount();if(rowCount>1||columnCount>1)return ErrorValueObject.create(error_type_ErrorType.VALUE);_months=_months.get(0,0)}if(_startDate.isError())return _startDate;if(_months.isError())return _months;const startDateSerialNumber=getDateSerialNumberByObject(_startDate);if("number"!=typeof startDateSerialNumber)return startDateSerialNumber;if(_months.isBoolean())return ErrorValueObject.create(error_type_ErrorType.VALUE);const startDateDate=excelSerialToDate(startDateSerialNumber),startYear=startDateSerialNumber>0?startDateDate.getUTCFullYear():1900,startMonth=startDateSerialNumber>0?startDateDate.getUTCMonth():0,monthsValue=Math.floor(+_months.getValue());if(Number.isNaN(monthsValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);const result=excelDateSerial(new Date(Date.UTC(startYear,startMonth+monthsValue+1,0)));return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_DATE.EOMONTH],[class Epochtodate extends base_function_BaseFunction{calculate(timestamp,unit){const _unit=unit??NumberValueObject.create(1),{isError,errorObject,timestampIsReferenceObject,timestampObject,unitObject}=this._checkVariants(timestamp,_unit);if(isError)return errorObject;if(timestampObject.isNull()||timestampObject.isBoolean()||timestampObject.isString())return ErrorValueObject.create(error_type_ErrorType.VALUE);if(!timestampIsReferenceObject&&timestampObject.isNumber()&&""!==timestampObject.getPattern())return ErrorValueObject.create(error_type_ErrorType.VALUE);let timestampValue=+timestampObject.getValue();const{isError:_isError,errorObject:_errorObject,variants}=checkVariantsErrorIsStringToNumber(unitObject);if(_isError)return _errorObject;const[_unitObject]=variants,unitValue=Math.floor(+_unitObject.getValue());if(timestampValue<0||unitValue<1||unitValue>3)return ErrorValueObject.create(error_type_ErrorType.NUM);1===unitValue&&(timestampValue*=1e3),3===unitValue&&(timestampValue/=1e3);const date=new Date(Date.UTC(1970,0,1,0,0,0,0)+timestampValue);if(Number.isNaN(date.getTime())){const result=25569+timestampValue/864e5;return NumberValueObject.create(result)}{const dateSerialNumber=excelDateTimeSerial(date);return NumberValueObject.create(dateSerialNumber,"yyyy-MM-dd AM/PM hh:mm:ss")}}_checkVariants(timestamp,unit){const timestampIsReferenceObject=timestamp.isReferenceObject(),unitIsReferenceObject=unit.isReferenceObject();let _timestamp=timestamp;if(timestampIsReferenceObject&&(_timestamp=timestamp.toArrayValueObject()),_timestamp.isArray()){const rowCount=_timestamp.getRowCount(),columnCount=_timestamp.getColumnCount();if(rowCount>1||columnCount>1)return{isError:!0,errorObject:ErrorValueObject.create(error_type_ErrorType.VALUE)};_timestamp=_timestamp.get(0,0)}if(_timestamp.isError())return{isError:!0,errorObject:_timestamp};let _unit=unit;if(unitIsReferenceObject&&(_unit=unit.toArrayValueObject()),_unit.isArray()){const rowCount=_unit.getRowCount(),columnCount=_unit.getColumnCount();if(rowCount>1||columnCount>1)return{isError:!0,errorObject:ErrorValueObject.create(error_type_ErrorType.VALUE)};_unit=_unit.get(0,0)}return _unit.isError()?{isError:!0,errorObject:_unit}:{isError:!1,errorObject:null,timestampIsReferenceObject,timestampObject:_timestamp,unitIsReferenceObject,unitObject:_unit}}constructor(...args){super(...args),this.minParams=1,this.maxParams=2,this.needsReferenceObject=!0}},FUNCTION_NAMES_DATE.EPOCHTODATE],[class Hour extends base_function_BaseFunction{calculate(serialNumber){return serialNumber.isError()?serialNumber:serialNumber.isArray()?serialNumber.map((serialNumberObject=>serialNumberObject.isError()?serialNumberObject:this._handleSingleObject(serialNumberObject))):this._handleSingleObject(serialNumber)}_handleSingleObject(serialNumberObject){const dateSerialNumber=getDateSerialNumberByObject(serialNumberObject);if("number"!=typeof dateSerialNumber)return dateSerialNumber;if(0===dateSerialNumber)return NumberValueObject.create(0);const hours=excelSerialToDateTime(dateSerialNumber).getUTCHours();return NumberValueObject.create(hours)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_DATE.HOUR],[class Isoweeknum extends base_function_BaseFunction{calculate(date){return date.isError()?date:date.isArray()?date.map((dateObject=>dateObject.isError()?dateObject:this._handleSingleObject(dateObject))):this._handleSingleObject(date)}_handleSingleObject(date){const dateSerialNumber=getDateSerialNumberByObject(date);if("number"!=typeof dateSerialNumber)return dateSerialNumber;const currentDate=excelSerialToDate(dateSerialNumber),currentYear=dateSerialNumber>0?currentDate.getUTCFullYear():1900;let yearWeekStartSerialNumber,yearStart=new Date(Date.UTC(currentYear,0,1)),yearStartSerialNumber=excelDateSerial(yearStart),yearStartWeekDay=getWeekDayByDateSerialNumber(yearStartSerialNumber);yearWeekStartSerialNumber=yearStartWeekDay<1?yearStartSerialNumber+1:yearStartWeekDay<=4?yearStartSerialNumber-(yearStartWeekDay-1):yearStartSerialNumber+(11-yearStartWeekDay),dateSerialNumber<yearWeekStartSerialNumber&&(yearStart=new Date(Date.UTC(currentYear-1,0,1)),yearStartSerialNumber=excelDateSerial(yearStart),yearStartWeekDay=getWeekDayByDateSerialNumber(yearStartSerialNumber),yearWeekStartSerialNumber=yearStartWeekDay<1?yearStartSerialNumber+1:yearStartWeekDay<=4?yearStartSerialNumber-(yearStartWeekDay-1):yearStartSerialNumber+(11-yearStartWeekDay));const result=Math.ceil((dateSerialNumber-yearWeekStartSerialNumber+1)/7);return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_DATE.ISOWEEKNUM],[class Minute extends base_function_BaseFunction{calculate(serialNumber){return serialNumber.isError()?serialNumber:serialNumber.isArray()?serialNumber.map((serialNumberObject=>serialNumberObject.isError()?serialNumberObject:this._handleSingleObject(serialNumberObject))):this._handleSingleObject(serialNumber)}_handleSingleObject(serialNumberObject){const dateSerialNumber=getDateSerialNumberByObject(serialNumberObject);if("number"!=typeof dateSerialNumber)return dateSerialNumber;if(0===dateSerialNumber)return NumberValueObject.create(0);const minutes=excelSerialToDateTime(dateSerialNumber).getUTCMinutes();return NumberValueObject.create(minutes)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_DATE.MINUTE],[class Month extends base_function_BaseFunction{calculate(serialNumber){return serialNumber.isArray()?serialNumber.map((serialNumberObject=>this._handleSingleObject(serialNumberObject))):this._handleSingleObject(serialNumber)}_handleSingleObject(serialNumberObject){if(serialNumberObject.isError())return serialNumberObject;let date;const dateValue=serialNumberObject.getValue();if(serialNumberObject.isString()){if(!isValidDateStr(`${dateValue}`))return ErrorValueObject.create(error_type_ErrorType.VALUE);date=new Date(`${dateValue}`)}else{const dateSerial=+serialNumberObject.getValue();if(dateSerial<0)return ErrorValueObject.create(error_type_ErrorType.NUM);if(0===dateSerial)return NumberValueObject.create(1);date=excelSerialToDate(dateSerial)}const month=date.getUTCMonth()+1;return NumberValueObject.create(month)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_DATE.MONTH],[class Networkdays extends base_function_BaseFunction{calculate(startDate,endDate,holidays){let _startDate=startDate,_endDate=endDate;if(_startDate.isArray()){const rowCount=_startDate.getRowCount(),columnCount=_startDate.getColumnCount();if(rowCount>1||columnCount>1)return ErrorValueObject.create(error_type_ErrorType.VALUE);_startDate=_startDate.get(0,0)}if(_startDate.isError())return _startDate;if(_endDate.isArray()){const rowCount=_endDate.getRowCount(),columnCount=_endDate.getColumnCount();if(rowCount>1||columnCount>1)return ErrorValueObject.create(error_type_ErrorType.VALUE);_endDate=_endDate.get(0,0)}if(_endDate.isError())return _endDate;if(holidays?.isError())return holidays;if(_startDate.isBoolean()||_endDate.isBoolean())return ErrorValueObject.create(error_type_ErrorType.VALUE);const startDateSerialNumber=getDateSerialNumberByObject(_startDate);if("number"!=typeof startDateSerialNumber)return startDateSerialNumber;const endDateSerialNumber=getDateSerialNumberByObject(_endDate);if("number"!=typeof endDateSerialNumber)return endDateSerialNumber;if(holidays)return this._getResultByHolidays(startDateSerialNumber,endDateSerialNumber,holidays);const result=countWorkingDays(startDateSerialNumber,endDateSerialNumber);return NumberValueObject.create(result)}_getResultByHolidays(startDateSerialNumber,endDateSerialNumber,holidays){const holidaysValueArray=[];if(holidays?.isArray()){const rowCount=holidays.getRowCount(),columnCount=holidays.getColumnCount();for(let r=0;r<rowCount;r++)for(let c=0;c<columnCount;c++){const cell=holidays.get(r,c);if(cell.isBoolean())return ErrorValueObject.create(error_type_ErrorType.VALUE);const holidaySerialNumber=getDateSerialNumberByObject(cell);if("number"!=typeof holidaySerialNumber)return holidaySerialNumber;holidaysValueArray.push(holidaySerialNumber)}}else{if(holidays.isBoolean())return ErrorValueObject.create(error_type_ErrorType.VALUE);const holidaySerialNumber=getDateSerialNumberByObject(holidays);if("number"!=typeof holidaySerialNumber)return holidaySerialNumber;holidaysValueArray.push(holidaySerialNumber)}const result=countWorkingDays(startDateSerialNumber,endDateSerialNumber,1,holidaysValueArray);return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=2,this.maxParams=3}},FUNCTION_NAMES_DATE.NETWORKDAYS],[class NetworkdaysIntl extends base_function_BaseFunction{calculate(startDate,endDate,weekend,holidays){return startDate.isError()?startDate:endDate.isError()?endDate:weekend?.isError()?weekend:holidays?.isError()?holidays:weekend?.isArray()?weekend.map((weekendItem=>this._handleSingleObject(startDate,endDate,weekendItem,holidays))):this._handleSingleObject(startDate,endDate,weekend,holidays)}_handleSingleObject(startDate,endDate,weekend,holidays){let _startDate=startDate,_endDate=endDate;if(_startDate.isArray()){const rowCount=_startDate.getRowCount(),columnCount=_startDate.getColumnCount();if(rowCount>1||columnCount>1)return ErrorValueObject.create(error_type_ErrorType.VALUE);_startDate=_startDate.get(0,0)}if(_startDate.isError())return _startDate;if(_endDate.isArray()){const rowCount=_endDate.getRowCount(),columnCount=_endDate.getColumnCount();if(rowCount>1||columnCount>1)return ErrorValueObject.create(error_type_ErrorType.VALUE);_endDate=_endDate.get(0,0)}if(_endDate.isError())return _endDate;let weekendValue=1;if(weekend){if(weekendValue=weekend.getValue(),weekend.isBoolean()&&(weekendValue=+weekendValue),weekend.isString()&&!isValidWeekend(weekendValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);if(!isValidWeekend(weekendValue))return ErrorValueObject.create(error_type_ErrorType.NUM)}if(_startDate.isBoolean()||_endDate.isBoolean())return ErrorValueObject.create(error_type_ErrorType.VALUE);const startDateSerialNumber=getDateSerialNumberByObject(_startDate);if("number"!=typeof startDateSerialNumber)return startDateSerialNumber;const endDateSerialNumber=getDateSerialNumberByObject(_endDate);if("number"!=typeof endDateSerialNumber)return endDateSerialNumber;if(holidays)return this._getResultByHolidays(startDateSerialNumber,endDateSerialNumber,weekendValue,holidays);const result=countWorkingDays(startDateSerialNumber,endDateSerialNumber,weekendValue);return NumberValueObject.create(result)}_getResultByHolidays(startDateSerialNumber,endDateSerialNumber,weekendValue,holidays){const holidaysValueArray=[];if(holidays?.isArray()){const rowCount=holidays.getRowCount(),columnCount=holidays.getColumnCount();for(let r=0;r<rowCount;r++)for(let c=0;c<columnCount;c++){const cell=holidays.get(r,c);if(cell.isBoolean())return ErrorValueObject.create(error_type_ErrorType.VALUE);const holidaySerialNumber=getDateSerialNumberByObject(cell);if("number"!=typeof holidaySerialNumber)return holidaySerialNumber;holidaysValueArray.push(holidaySerialNumber)}}else{if(holidays.isBoolean())return ErrorValueObject.create(error_type_ErrorType.VALUE);const holidaySerialNumber=getDateSerialNumberByObject(holidays);if("number"!=typeof holidaySerialNumber)return holidaySerialNumber;holidaysValueArray.push(holidaySerialNumber)}const result=countWorkingDays(startDateSerialNumber,endDateSerialNumber,weekendValue,holidaysValueArray);return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=2,this.maxParams=4}},FUNCTION_NAMES_DATE.NETWORKDAYS_INTL],[class Now extends base_function_BaseFunction{calculate(){const now=new Date,currentSerial=excelDateTimeSerial(new Date(Date.UTC(now.getFullYear(),now.getMonth(),now.getDate(),now.getHours(),now.getMinutes(),now.getSeconds())));return NumberValueObject.create(currentSerial,"yyyy/mm/dd hh:mm")}constructor(...args){super(...args),this.minParams=0,this.maxParams=0}},FUNCTION_NAMES_DATE.NOW],[class Second extends base_function_BaseFunction{calculate(serialNumber){return serialNumber.isError()?serialNumber:serialNumber.isArray()?serialNumber.map((serialNumberObject=>serialNumberObject.isError()?serialNumberObject:this._handleSingleObject(serialNumberObject))):this._handleSingleObject(serialNumber)}_handleSingleObject(serialNumberObject){const dateSerialNumber=getDateSerialNumberByObject(serialNumberObject);if("number"!=typeof dateSerialNumber)return dateSerialNumber;if(0===dateSerialNumber)return NumberValueObject.create(0);const seconds=excelSerialToDateTime(dateSerialNumber).getUTCSeconds();return NumberValueObject.create(seconds)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_DATE.SECOND],[class Time extends base_function_BaseFunction{calculate(hour,minute,second){if(hour.isError())return hour;if(minute.isError())return minute;if(second.isError())return second;const maxRowLength=Math.max(hour.isArray()?hour.getRowCount():1,minute.isArray()?minute.getRowCount():1,second.isArray()?second.getRowCount():1),maxColumnLength=Math.max(hour.isArray()?hour.getColumnCount():1,minute.isArray()?minute.getColumnCount():1,second.isArray()?second.getColumnCount():1),hourArray=expandArrayValueObject(maxRowLength,maxColumnLength,hour),minuteArray=expandArrayValueObject(maxRowLength,maxColumnLength,minute),secondArray=expandArrayValueObject(maxRowLength,maxColumnLength,second);return hourArray.map(((hourValueObject,rowIndex,columnIndex)=>this._calculateTime(hourValueObject,minuteArray,secondArray,rowIndex,columnIndex)))}_calculateTime(hourValueObject,minuteArray,secondArray,rowIndex,columnIndex){let _hourValueObject=hourValueObject,minuteValueObject=minuteArray.get(rowIndex,columnIndex)||NullValueObject.create(),secondValueObject=secondArray.get(rowIndex,columnIndex)||NullValueObject.create();if((_hourValueObject.isString()||_hourValueObject.isBoolean())&&(_hourValueObject=_hourValueObject.convertToNumberObjectValue()),(minuteValueObject.isString()||minuteValueObject.isBoolean())&&(minuteValueObject=minuteValueObject.convertToNumberObjectValue()),(secondValueObject.isString()||secondValueObject.isBoolean())&&(secondValueObject=secondValueObject.convertToNumberObjectValue()),_hourValueObject.isError())return _hourValueObject;if(minuteValueObject.isError())return minuteValueObject;if(secondValueObject.isError())return secondValueObject;let hourValue=Math.floor(+_hourValueObject.getValue()),minuteValue=Math.floor(+minuteValueObject.getValue()),secondValue=Math.floor(+secondValueObject.getValue());if(hourValue<0||minuteValue<0||secondValue<0||hourValue>32767||minuteValue>32767||secondValue>32767)return ErrorValueObject.create(error_type_ErrorType.NUM);minuteValue+=Math.floor(secondValue/60),secondValue%=60,hourValue+=Math.floor(minuteValue/60),minuteValue%=60,hourValue%=24;const fractionOfDay=(3600*hourValue+60*minuteValue+secondValue)/86400;return NumberValueObject.create(fractionOfDay,"h:mm A/P")}constructor(...args){super(...args),this.minParams=3,this.maxParams=3}},FUNCTION_NAMES_DATE.TIME],[class Timevalue extends base_function_BaseFunction{calculate(timeText){return timeText.isError()?timeText:timeText.isArray()?timeText.map((timeTextObject=>this._handleSingleObject(timeTextObject))):this._handleSingleObject(timeText)}_handleSingleObject(timeTextObject){if(timeTextObject.isString()){const parsedTime=parseFormattedValue(`${timeTextObject.getValue()}`);if(parsedTime){let{v,z}=parsedTime;if(z&&isDate(z))return v instanceof Date&&(v=excelDateTimeSerial(v)),NumberValueObject.create(function getFractionalPart(num){return num-Math.trunc(num)}(+v))}}return ErrorValueObject.create(error_type_ErrorType.VALUE)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_DATE.TIMEVALUE],[class ToDate extends base_function_BaseFunction{calculate(value){const isReferenceObject=value.isReferenceObject();let _value=value;if(isReferenceObject&&(_value=value.toArrayValueObject()),_value.isArray()){const rowCount=_value.getRowCount(),columnCount=_value.getColumnCount();if(rowCount>1||columnCount>1)return ErrorValueObject.create(error_type_ErrorType.VALUE);_value=_value.get(0,0)}if(_value.isError()||_value.isNull()||_value.isBoolean()||_value.isString())return _value;if(!isReferenceObject&&_value.isNumber()&&""!==_value.getPattern())return _value;const val=+_value.getValue();return NumberValueObject.create(val,"yyyy-MM-dd hh:mm:ss AM/PM")}constructor(...args){super(...args),this.minParams=1,this.maxParams=1,this.needsReferenceObject=!0}},FUNCTION_NAMES_DATE.TO_DATE],[class Today extends base_function_BaseFunction{calculate(){const currentSerial=excelDateSerial(new Date);return NumberValueObject.create(currentSerial,"yyyy/mm/dd;@")}constructor(...args){super(...args),this.minParams=0,this.maxParams=0}},FUNCTION_NAMES_DATE.TODAY],[class Weekday extends base_function_BaseFunction{calculate(serialNumber,returnType){const _returnType=returnType??NumberValueObject.create(1);if(serialNumber.isError())return serialNumber;if(_returnType.isError())return _returnType;const maxRowLength=Math.max(serialNumber.isArray()?serialNumber.getRowCount():1,_returnType.isArray()?_returnType.getRowCount():1),maxColumnLength=Math.max(serialNumber.isArray()?serialNumber.getColumnCount():1,_returnType.isArray()?_returnType.getColumnCount():1),serialNumberArray=expandArrayValueObject(maxRowLength,maxColumnLength,serialNumber,ErrorValueObject.create(error_type_ErrorType.NA)),returnTypeArray=expandArrayValueObject(maxRowLength,maxColumnLength,_returnType,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=serialNumberArray.map(((serialNumberObject,rowIndex,columnIndex)=>{const returnTypeObject=returnTypeArray.get(rowIndex,columnIndex);return this._handleSingleObject(serialNumberObject,returnTypeObject)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_handleSingleObject(serialNumberObject,returnTypeObject){let _returnTypeObject=returnTypeObject;if(serialNumberObject.isError())return serialNumberObject;if(_returnTypeObject.isError())return _returnTypeObject;const dateSerialNumber=getDateSerialNumberByObject(serialNumberObject);if("number"!=typeof dateSerialNumber)return dateSerialNumber;if(_returnTypeObject.isString()&&(_returnTypeObject=_returnTypeObject.convertToNumberObjectValue(),_returnTypeObject.isError()))return _returnTypeObject;const returnTypeValue=Math.floor(+_returnTypeObject.getValue());if(!this._returnTypeMap[returnTypeValue])return ErrorValueObject.create(error_type_ErrorType.NUM);const weekDay=getWeekDayByDateSerialNumber(dateSerialNumber),result=this._returnTypeMap[returnTypeValue][weekDay];return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=2,this._returnTypeMap={1:[1,2,3,4,5,6,7],2:[7,1,2,3,4,5,6],3:[6,0,1,2,3,4,5],11:[7,1,2,3,4,5,6],12:[6,7,1,2,3,4,5],13:[5,6,7,1,2,3,4],14:[4,5,6,7,1,2,3],15:[3,4,5,6,7,1,2],16:[2,3,4,5,6,7,1],17:[1,2,3,4,5,6,7]}}},FUNCTION_NAMES_DATE.WEEKDAY],[class Weeknum extends base_function_BaseFunction{calculate(serialNumber,returnType){let _serialNumber=serialNumber,_returnType=returnType??NumberValueObject.create(1);if(_serialNumber.isArray()){const rowCount=_serialNumber.getRowCount(),columnCount=_serialNumber.getColumnCount();if(rowCount>1||columnCount>1)return ErrorValueObject.create(error_type_ErrorType.VALUE);_serialNumber=_serialNumber.get(0,0)}if(_serialNumber.isError())return _serialNumber;if(_returnType.isArray()){const rowCount=_returnType.getRowCount(),columnCount=_returnType.getColumnCount();if(rowCount>1||columnCount>1)return ErrorValueObject.create(error_type_ErrorType.VALUE);_returnType=_returnType.get(0,0)}if(_returnType.isError())return _returnType;if(_serialNumber.isBoolean())return ErrorValueObject.create(error_type_ErrorType.VALUE);const dateSerialNumber=getDateSerialNumberByObject(_serialNumber);if("number"!=typeof dateSerialNumber)return dateSerialNumber;if(_returnType.isBoolean())return ErrorValueObject.create(error_type_ErrorType.VALUE);const returnTypeValue=Math.floor(+_returnType.getValue());return Number.isNaN(returnTypeValue)?ErrorValueObject.create(error_type_ErrorType.VALUE):returnTypeValue in this._returnTypeMap?this._getResult(dateSerialNumber,returnTypeValue):ErrorValueObject.create(error_type_ErrorType.NUM)}_getResult(dateSerialNumber,returnTypeValue){const currentDate=excelSerialToDate(dateSerialNumber),currentYear=dateSerialNumber>0?currentDate.getUTCFullYear():1900;let yearWeekStartSerialNumber,yearStart=new Date(Date.UTC(currentYear,0,1)),yearStartSerialNumber=excelDateSerial(yearStart),yearStartWeekDay=getWeekDayByDateSerialNumber(yearStartSerialNumber);if(21===returnTypeValue)yearWeekStartSerialNumber=yearStartWeekDay<1?yearStartSerialNumber+1:yearStartWeekDay<=4?yearStartSerialNumber-(yearStartWeekDay-1):yearStartSerialNumber+(11-yearStartWeekDay),dateSerialNumber<yearWeekStartSerialNumber&&(yearStart=new Date(Date.UTC(currentYear-1,0,1)),yearStartSerialNumber=excelDateSerial(yearStart),yearStartWeekDay=getWeekDayByDateSerialNumber(yearStartSerialNumber),yearWeekStartSerialNumber=yearStartWeekDay<1?yearStartSerialNumber+1:yearStartWeekDay<=4?yearStartSerialNumber-(yearStartWeekDay-1):yearStartSerialNumber+(11-yearStartWeekDay));else{const weekDay=this._returnTypeMap[returnTypeValue];yearWeekStartSerialNumber=yearStartWeekDay<weekDay?yearStartSerialNumber-(yearStartWeekDay+7-weekDay):yearStartSerialNumber-(yearStartWeekDay-weekDay)}const result=Math.ceil((dateSerialNumber-yearWeekStartSerialNumber+1)/7);return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=2,this._returnTypeMap={1:0,2:1,11:1,12:2,13:3,14:4,15:5,16:6,17:0,21:4}}},FUNCTION_NAMES_DATE.WEEKNUM],[class Workday extends base_function_BaseFunction{calculate(startDate,days,holidays){let _startDate=startDate,_days=days;if(_startDate.isArray()){const rowCount=_startDate.getRowCount(),columnCount=_startDate.getColumnCount();if(rowCount>1||columnCount>1)return ErrorValueObject.create(error_type_ErrorType.VALUE);_startDate=_startDate.get(0,0)}if(_startDate.isError())return _startDate;if(_days.isArray()){const rowCount=_days.getRowCount(),columnCount=_days.getColumnCount();if(rowCount>1||columnCount>1)return ErrorValueObject.create(error_type_ErrorType.VALUE);_days=_days.get(0,0)}if(_days.isError())return _days;if(holidays?.isError())return holidays;if(_startDate.isBoolean()||_days.isBoolean())return ErrorValueObject.create(error_type_ErrorType.VALUE);const startDateSerialNumber=getDateSerialNumberByObject(_startDate);if("number"!=typeof startDateSerialNumber)return startDateSerialNumber;const workingDays=+_days.getValue();if(Number.isNaN(workingDays))return ErrorValueObject.create(error_type_ErrorType.VALUE);if(holidays)return this._getResultByHolidays(startDateSerialNumber,workingDays,holidays);const result=getDateSerialNumberByWorkingDays(startDateSerialNumber,workingDays);return"number"!=typeof result?result:NumberValueObject.create(result)}_getResultByHolidays(startDateSerialNumber,workingDays,holidays){const holidaysValueArray=[];if(holidays?.isArray()){const rowCount=holidays.getRowCount(),columnCount=holidays.getColumnCount();for(let r=0;r<rowCount;r++)for(let c=0;c<columnCount;c++){const cell=holidays.get(r,c);if(cell.isBoolean())return ErrorValueObject.create(error_type_ErrorType.VALUE);const holidaySerialNumber=getDateSerialNumberByObject(cell);if("number"!=typeof holidaySerialNumber)return holidaySerialNumber;holidaysValueArray.push(holidaySerialNumber)}}else{if(holidays.isBoolean())return ErrorValueObject.create(error_type_ErrorType.VALUE);const holidaySerialNumber=getDateSerialNumberByObject(holidays);if("number"!=typeof holidaySerialNumber)return holidaySerialNumber;holidaysValueArray.push(holidaySerialNumber)}const result=getDateSerialNumberByWorkingDays(startDateSerialNumber,workingDays,1,holidaysValueArray);return"number"!=typeof result?result:NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=2,this.maxParams=3}},FUNCTION_NAMES_DATE.WORKDAY],[class WorkdayIntl extends base_function_BaseFunction{calculate(startDate,days,weekend,holidays){return startDate.isError()?startDate:days.isError()?days:weekend?.isError()?weekend:holidays?.isError()?holidays:weekend?.isArray()?weekend.map((weekendItem=>this._handleSingleObject(startDate,days,weekendItem,holidays))):this._handleSingleObject(startDate,days,weekend,holidays)}_handleSingleObject(startDate,days,weekend,holidays){const _weekend=weekend??NumberValueObject.create(1),_startDate=this._checkArrayError(startDate);if(_startDate.isError())return _startDate;const _days=this._checkArrayError(days);if(_days.isError())return _days;if(_startDate.isBoolean()||_days.isBoolean())return ErrorValueObject.create(error_type_ErrorType.VALUE);const startDateSerialNumber=getDateSerialNumberByObject(startDate);if("number"!=typeof startDateSerialNumber)return startDateSerialNumber;const workingDays=+days.getValue();if(Number.isNaN(workingDays))return ErrorValueObject.create(error_type_ErrorType.VALUE);let weekendValue=_weekend.getValue();if(_weekend.isBoolean()&&(weekendValue=+weekendValue),_weekend.isString()&&(!isValidWeekend(weekendValue)||"1111111"===weekendValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);if(!isValidWeekend(weekendValue))return ErrorValueObject.create(error_type_ErrorType.NUM);if(holidays)return this._getResultByHolidays(startDateSerialNumber,workingDays,weekendValue,holidays);const result=getDateSerialNumberByWorkingDays(startDateSerialNumber,workingDays,weekendValue);return"number"!=typeof result?result:NumberValueObject.create(result)}_checkArrayError(variant){let _variant=variant;if(_variant.isArray()){const rowCount=_variant.getRowCount(),columnCount=_variant.getColumnCount();if(rowCount>1||columnCount>1)return ErrorValueObject.create(error_type_ErrorType.VALUE);_variant=_variant.get(0,0)}return _variant.isError(),_variant}_getResultByHolidays(startDateSerialNumber,workingDays,weekendValue,holidays){const holidaysValueArray=[];if(holidays?.isArray()){const rowCount=holidays.getRowCount(),columnCount=holidays.getColumnCount();for(let r=0;r<rowCount;r++)for(let c=0;c<columnCount;c++){const cell=holidays.get(r,c);if(cell.isBoolean())return ErrorValueObject.create(error_type_ErrorType.VALUE);const holidaySerialNumber=getDateSerialNumberByObject(cell);if("number"!=typeof holidaySerialNumber)return holidaySerialNumber;holidaysValueArray.push(holidaySerialNumber)}}else{if(holidays.isBoolean())return ErrorValueObject.create(error_type_ErrorType.VALUE);const holidaySerialNumber=getDateSerialNumberByObject(holidays);if("number"!=typeof holidaySerialNumber)return holidaySerialNumber;holidaysValueArray.push(holidaySerialNumber)}const result=getDateSerialNumberByWorkingDays(startDateSerialNumber,workingDays,weekendValue,holidaysValueArray);return"number"!=typeof result?result:NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=2,this.maxParams=4}},FUNCTION_NAMES_DATE.WORKDAY_INTL],[class Year extends base_function_BaseFunction{calculate(serialNumber){return serialNumber.isArray()?serialNumber.map((serialNumberObject=>this._handleSingleObject(serialNumberObject))):this._handleSingleObject(serialNumber)}_handleSingleObject(serialNumberObject){if(serialNumberObject.isError())return serialNumberObject;let date;const dateValue=serialNumberObject.getValue();if(serialNumberObject.isString()){if(!isValidDateStr(`${dateValue}`))return ErrorValueObject.create(error_type_ErrorType.VALUE);date=new Date(`${dateValue}`)}else{const dateSerial=+dateValue;if(dateSerial<0)return ErrorValueObject.create(error_type_ErrorType.NUM);if(0===dateSerial)return NumberValueObject.create(1900);date=excelSerialToDate(dateSerial)}const year=date.getUTCFullYear();return NumberValueObject.create(year)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_DATE.YEAR],[class Yearfrac extends base_function_BaseFunction{calculate(startDate,endDate,basis){let _basis=basis??NumberValueObject.create(0);const _startDate=checkVariantErrorIsArray(startDate);if(_startDate.isError())return _startDate;const _endDate=checkVariantErrorIsArray(endDate);if(_endDate.isError())return _endDate;if(_basis=checkVariantErrorIsArray(_basis),_basis.isError())return _basis;if(_startDate.isBoolean()||_endDate.isBoolean()||_basis.isBoolean())return ErrorValueObject.create(error_type_ErrorType.VALUE);const startDateSerialNumber=getDateSerialNumberByObject(_startDate);if("number"!=typeof startDateSerialNumber)return startDateSerialNumber;const endDateSerialNumber=getDateSerialNumberByObject(_endDate);if("number"!=typeof endDateSerialNumber)return endDateSerialNumber;const basisValue=Math.floor(+_basis.getValue());if(Number.isNaN(basisValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);if(basisValue<0||basisValue>4)return ErrorValueObject.create(error_type_ErrorType.NUM);const{days,yearDays}=getTwoDateDaysByBasis(startDateSerialNumber,endDateSerialNumber,basisValue),result=days/yearDays;return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=2,this.maxParams=3}},FUNCTION_NAMES_DATE.YEARFRAC]];decimal.A.prototype.cos=function(){const num=this.toNumber();return new decimal.A(Math.cos(num))};class complex_Complex{static getComplex(realNum,iNum,suffix){const _realNum=new decimal.A(realNum).toSignificantDigits(15).toNumber(),_iNum=new decimal.A(iNum).toSignificantDigits(15).toNumber(),_suffix=""===suffix?"i":suffix;let result;if(0===_realNum&&0===_iNum)result=0;else if(0===_realNum)result=1===_iNum?_suffix:`${_iNum}${_suffix}`;else if(0===_iNum)result=_realNum;else{result=`${_realNum}${_iNum>0?"+":""}${1===_iNum?_suffix:`${_iNum}${_suffix}`}`}return result}static createByComplexStr(realNum,iNum,suffix){const complexStr=complex_Complex.getComplex(realNum,iNum,suffix);return new complex_Complex(complexStr)}constructor(inumber){this._inumber="",this._realNum=0,this._iNum=0,this._suffix="",this._isError=!1,""!==`${inumber}`.trim()?(this._inumber=inumber,this._getImReal(),this._getImAginary(),this._getImSuffix()):this._isError=!0}_getImReal(){if(0===this._inumber||"0"===this._inumber)return void(this._realNum=0);const inumberStr=`${this._inumber}`;if(["i","+i","1i","+1i","-i","-1i","j","+j","1j","+1j","-j","-1j"].indexOf(inumberStr)>=0)return void(this._realNum=0);let plus=inumberStr.indexOf("+"),minus=inumberStr.indexOf("-");0===plus&&(plus=inumberStr.indexOf("+",1)),0===minus&&(minus=inumberStr.indexOf("-",1));const last=inumberStr.substring(inumberStr.length-1,inumberStr.length),unit="i"===last||"j"===last;if(plus>=0||minus>=0){if(!unit)return void(this._isError=!0);plus>=0?Number.isNaN(+inumberStr.substring(0,plus))||Number.isNaN(+inumberStr.substring(plus+1,inumberStr.length-1))?this._isError=!0:this._realNum=+inumberStr.substring(0,plus):Number.isNaN(+inumberStr.substring(0,minus))||Number.isNaN(+inumberStr.substring(minus+1,inumberStr.length-1))?this._isError=!0:this._realNum=+inumberStr.substring(0,minus)}else unit?Number.isNaN(+inumberStr.substring(0,inumberStr.length-1))?this._isError=!0:this._realNum=0:Number.isNaN(+inumberStr)?this._isError=!0:this._realNum=+inumberStr}_getImAginary(){if(this._isError)return;if(0===this._inumber||"0"===this._inumber)return void(this._iNum=0);let inumberStr=`${this._inumber}`;if(["i","j"].indexOf(inumberStr)>=0)return void(this._iNum=1);inumberStr=inumberStr.replace("+i","+1i").replace("-i","-1i").replace("+j","+1j").replace("-j","-1j");let plus=inumberStr.indexOf("+"),minus=inumberStr.indexOf("-");0===plus&&(plus=inumberStr.indexOf("+",1)),0===minus&&(minus=inumberStr.indexOf("-",1));const last=inumberStr.substring(inumberStr.length-1,inumberStr.length),unit="i"===last||"j"===last;if(plus>=0||minus>=0){if(!unit)return void(this._isError=!0);plus>=0?Number.isNaN(+inumberStr.substring(0,plus))||Number.isNaN(+inumberStr.substring(plus+1,inumberStr.length-1))?this._isError=!0:this._iNum=+inumberStr.substring(plus+1,inumberStr.length-1):Number.isNaN(+inumberStr.substring(0,minus))||Number.isNaN(+inumberStr.substring(minus+1,inumberStr.length-1))?this._isError=!0:this._iNum=-+inumberStr.substring(minus+1,inumberStr.length-1)}else unit?Number.isNaN(+inumberStr.substring(0,inumberStr.length-1))?this._isError=!0:this._iNum=+inumberStr.substring(0,inumberStr.length-1):Number.isNaN(+inumberStr)?this._isError=!0:this._iNum=0}_getImSuffix(){const inumberStr=`${this._inumber}`,suffix=inumberStr.substring(inumberStr.length-1);this._suffix="i"===suffix||"j"===suffix?suffix:""}getRealNum(){return this._realNum}getINum(){return this._iNum}getSuffix(){return this._suffix}isError(){return this._isError}toString(){return complex_Complex.getComplex(this._realNum,this._iNum,this._suffix)}isDifferentSuffixes(complex2){const suffix2=complex2.getSuffix();return""!==this._suffix&&""!==suffix2&&this._suffix!==suffix2}Abs(){return decimal.A.sqrt(decimal.A.pow(this._realNum,2).add(decimal.A.pow(this._iNum,2))).toSignificantDigits(16).toNumber()}Argument(){const abs=decimal.A.sqrt(decimal.A.pow(this._realNum,2).add(decimal.A.pow(this._iNum,2)));let result=decimal.A.acos(new decimal.A(this._realNum).div(abs)).toSignificantDigits(16).toNumber();return this._iNum<0&&(result=-result),result}Conjugate(){return complex_Complex.getComplex(this._realNum,-this._iNum,this._suffix)}Cos(){if(this._iNum){const realNum=decimal.A.cos(this._realNum).mul(decimal.A.cosh(this._iNum)).toNumber(),iNum=decimal.A.sin(this._realNum).mul(decimal.A.sinh(this._iNum)).negated().toNumber();return complex_Complex.getComplex(realNum,iNum,this._suffix)}{const realNum=decimal.A.cos(this._realNum).toNumber();return complex_Complex.getComplex(realNum,this._iNum,this._suffix)}}Cosh(){if(!Number.isFinite(Math.sinh(this._realNum))||!Number.isFinite(Math.cosh(this._realNum)))return this._isError=!0,"";if(this._iNum){const realNum=decimal.A.cosh(this._realNum).mul(decimal.A.cos(this._iNum)).toNumber(),iNum=decimal.A.sinh(this._realNum).mul(decimal.A.sin(this._iNum)).toNumber();return complex_Complex.getComplex(realNum,iNum,this._suffix)}{const realNum=decimal.A.cosh(this._realNum).toNumber();return complex_Complex.getComplex(realNum,this._iNum,this._suffix)}}Cot(){if(this._iNum){const den=decimal.A.cosh(2*this._iNum).sub(decimal.A.cos(2*this._realNum)),realNum=decimal.A.sin(2*this._realNum).div(den).toNumber(),iNum=decimal.A.sinh(2*this._iNum).div(den).negated().toNumber();return complex_Complex.getComplex(realNum,iNum,this._suffix)}{const realNum=new decimal.A(1).div(decimal.A.tan(this._realNum)).toNumber();return complex_Complex.getComplex(realNum,this._iNum,this._suffix)}}Coth(){if(!Number.isFinite(Math.sinh(this._realNum))||!Number.isFinite(Math.cosh(this._realNum)))return this._isError=!0,"";if(this._iNum){const den=decimal.A.cosh(2*this._realNum).sub(decimal.A.cos(2*this._iNum)),realNum=decimal.A.sinh(2*this._realNum).div(den).toNumber(),iNum=decimal.A.sin(2*this._iNum).div(den).negated().toNumber();return complex_Complex.getComplex(realNum,iNum,this._suffix)}{const realNum=new decimal.A(1).div(decimal.A.tanh(this._realNum)).toNumber();return complex_Complex.getComplex(realNum,this._iNum,this._suffix)}}Csc(){if(this._iNum){const den=decimal.A.cosh(2*this._iNum).sub(decimal.A.cos(2*this._realNum)),realNum=decimal.A.sin(this._realNum).mul(decimal.A.cosh(this._iNum)).mul(2).div(den).toNumber(),iNum=decimal.A.cos(this._realNum).mul(decimal.A.sinh(this._iNum)).mul(-2).div(den).toNumber();return complex_Complex.getComplex(realNum,iNum,this._suffix)}{const realNum=new decimal.A(1).div(decimal.A.sin(this._realNum)).toNumber();return complex_Complex.getComplex(realNum,this._iNum,this._suffix)}}Csch(){if(!Number.isFinite(Math.sinh(this._realNum))||!Number.isFinite(Math.cosh(this._realNum)))return complex_Complex.getComplex(0,0,this._suffix);if(this._iNum){const den=decimal.A.cosh(2*this._realNum).sub(decimal.A.cos(2*this._iNum)),realNum=decimal.A.sinh(this._realNum).mul(decimal.A.cos(this._iNum)).mul(2).div(den).toNumber(),iNum=decimal.A.cosh(this._realNum).mul(decimal.A.sin(this._iNum)).mul(-2).div(den).toNumber();return complex_Complex.getComplex(realNum,iNum,this._suffix)}{const realNum=new decimal.A(1).div(decimal.A.sinh(this._realNum)).toNumber();return complex_Complex.getComplex(realNum,this._iNum,this._suffix)}}Div(complex2){const Decimal_realNum1=new decimal.A(this._realNum),Decimal_iNum1=new decimal.A(this._iNum),Decimal_realNum2=new decimal.A(complex2.getRealNum()),Decimal_iNum2=new decimal.A(complex2.getINum()),den=Decimal_realNum2.mul(Decimal_realNum2).add(Decimal_iNum2.mul(Decimal_iNum2)),realNum=Decimal_realNum1.mul(Decimal_realNum2).add(Decimal_iNum1.mul(Decimal_iNum2)).div(den).toNumber(),iNum=Decimal_iNum1.mul(Decimal_realNum2).sub(Decimal_realNum1.mul(Decimal_iNum2)).div(den).toNumber(),suffix=""===this._suffix?complex2.getSuffix():this._suffix;return complex_Complex.getComplex(realNum,iNum,suffix)}Exp(){if(!Number.isFinite(Math.exp(this._realNum)))return this._isError=!0,"";const realNum=decimal.A.exp(this._realNum).mul(decimal.A.cos(this._iNum)).toNumber(),iNum=decimal.A.exp(this._realNum).mul(decimal.A.sin(this._iNum)).toNumber();return complex_Complex.getComplex(realNum,iNum,this._suffix)}Ln(){const abs=decimal.A.sqrt(decimal.A.pow(this._realNum,2).add(decimal.A.pow(this._iNum,2))),realNum=decimal.A.ln(abs).toNumber(),iNum=decimal.A.acos(new decimal.A(this._realNum).div(abs)).toNumber();return complex_Complex.getComplex(realNum,iNum,this._suffix)}Log(base){const abs=decimal.A.sqrt(decimal.A.pow(this._realNum,2).add(decimal.A.pow(this._iNum,2))),Decimal_realNum1=decimal.A.ln(abs);let Decimal_iNum1=decimal.A.acos(new decimal.A(this._realNum).div(abs));this._iNum<0&&(Decimal_iNum1=Decimal_iNum1.negated());const Decimal_realNum2=decimal.A.ln(base),Decimal_iNum2=new decimal.A(0),den=Decimal_realNum2.mul(Decimal_realNum2).add(Decimal_iNum2.mul(Decimal_iNum2));if(den.eq(0))return this._isError=!0,"";const realNum=Decimal_realNum1.mul(Decimal_realNum2).add(Decimal_iNum1.mul(Decimal_iNum2)).div(den).toNumber(),iNum=Decimal_iNum1.mul(Decimal_realNum2).sub(Decimal_realNum1.mul(Decimal_iNum2)).div(den).toNumber();return complex_Complex.getComplex(realNum,iNum,this._suffix)}Power(number){if(0===this._realNum&&0===this._iNum)return number>0?complex_Complex.getComplex(this._realNum,this._iNum,this._suffix):(this._isError=!0,"");let power=decimal.A.sqrt(decimal.A.pow(this._realNum,2).add(decimal.A.pow(this._iNum,2))),phi=decimal.A.acos(new decimal.A(this._realNum).div(power));this._iNum<0&&(phi=phi.negated()),power=decimal.A.pow(power,number),phi=phi.mul(number);const realNum=decimal.A.cos(phi).mul(power).toNumber(),iNum=decimal.A.sin(phi).mul(power).toNumber();return Number.isFinite(realNum)&&Number.isFinite(iNum)?complex_Complex.getComplex(realNum,iNum,this._suffix):(this._isError=!0,"")}Product(complex2){const Decimal_realNum1=new decimal.A(this._realNum),Decimal_iNum1=new decimal.A(this._iNum),Decimal_realNum2=new decimal.A(complex2.getRealNum()),Decimal_iNum2=new decimal.A(complex2.getINum()),realNum=Decimal_realNum1.mul(Decimal_realNum2).sub(Decimal_iNum1.mul(Decimal_iNum2)).toNumber(),iNum=Decimal_realNum1.mul(Decimal_iNum2).add(Decimal_iNum1.mul(Decimal_realNum2)).toNumber(),suffix=""===this._suffix?complex2.getSuffix():this._suffix;return complex_Complex.getComplex(realNum,iNum,suffix)}Sec(){if(this._iNum){const den=decimal.A.cosh(2*this._iNum).add(decimal.A.cos(2*this._realNum)),realNum=decimal.A.cos(this._realNum).mul(decimal.A.cosh(this._iNum)).mul(2).div(den).toNumber(),iNum=decimal.A.sin(this._realNum).mul(decimal.A.sinh(this._iNum)).mul(2).div(den).toNumber();return complex_Complex.getComplex(realNum,iNum,this._suffix)}{const realNum=new decimal.A(1).div(decimal.A.cos(this._realNum)).toNumber();return complex_Complex.getComplex(realNum,this._iNum,this._suffix)}}Sech(){if(!Number.isFinite(Math.sinh(2*this._realNum))||!Number.isFinite(Math.cosh(2*this._realNum)))return complex_Complex.getComplex(0,0,this._suffix);if(this._iNum){const den=decimal.A.cosh(2*this._realNum).add(decimal.A.cos(2*this._iNum)),realNum=decimal.A.cosh(this._realNum).mul(decimal.A.cos(this._iNum)).mul(2).div(den).toNumber(),iNum=decimal.A.sinh(this._realNum).mul(decimal.A.sin(this._iNum)).mul(-2).div(den).toNumber();return complex_Complex.getComplex(realNum,iNum,this._suffix)}{const realNum=new decimal.A(1).div(decimal.A.cosh(this._realNum)).toNumber();return complex_Complex.getComplex(realNum,this._iNum,this._suffix)}}Sin(){if(this._iNum){const realNum=decimal.A.sin(this._realNum).mul(decimal.A.cosh(this._iNum)).toNumber(),iNum=decimal.A.cos(this._realNum).mul(decimal.A.sinh(this._iNum)).toNumber();return complex_Complex.getComplex(realNum,iNum,this._suffix)}{const realNum=decimal.A.sin(this._realNum).toNumber();return complex_Complex.getComplex(realNum,this._iNum,this._suffix)}}Sinh(){if(!Number.isFinite(Math.sinh(this._realNum))||!Number.isFinite(Math.cosh(this._realNum)))return this._isError=!0,"";if(this._iNum){const realNum=decimal.A.sinh(this._realNum).mul(decimal.A.cos(this._iNum)).toNumber(),iNum=decimal.A.cosh(this._realNum).mul(decimal.A.sin(this._iNum)).toNumber();return complex_Complex.getComplex(realNum,iNum,this._suffix)}{const realNum=decimal.A.sinh(this._realNum).toNumber();return complex_Complex.getComplex(realNum,this._iNum,this._suffix)}}Sqrt(){const abs=decimal.A.sqrt(decimal.A.pow(this._realNum,2).add(decimal.A.pow(this._iNum,2))),abs_sqrt=decimal.A.sqrt(abs);let arg=decimal.A.acos(new decimal.A(this._realNum).div(abs));this._iNum<0&&(arg=arg.negated());const realNum=abs_sqrt.mul(decimal.A.cos(arg.div(2).toNumber())).toNumber(),iNum=abs_sqrt.mul(decimal.A.sin(arg.div(2))).toNumber();return complex_Complex.getComplex(realNum,iNum,this._suffix)}Sub(complex2){const Decimal_realNum1=new decimal.A(this._realNum),Decimal_iNum1=new decimal.A(this._iNum),Decimal_realNum2=new decimal.A(complex2.getRealNum()),Decimal_iNum2=new decimal.A(complex2.getINum()),realNum=Decimal_realNum1.sub(Decimal_realNum2).toNumber(),iNum=Decimal_iNum1.sub(Decimal_iNum2).toNumber(),suffix=""===this._suffix?complex2.getSuffix():this._suffix;return complex_Complex.getComplex(realNum,iNum,suffix)}Sum(complex2){const Decimal_realNum1=new decimal.A(this._realNum),Decimal_iNum1=new decimal.A(this._iNum),Decimal_realNum2=new decimal.A(complex2.getRealNum()),Decimal_iNum2=new decimal.A(complex2.getINum()),realNum=Decimal_realNum1.add(Decimal_realNum2).toNumber(),iNum=Decimal_iNum1.add(Decimal_iNum2).toNumber(),suffix=""===this._suffix?complex2.getSuffix():this._suffix;return complex_Complex.getComplex(realNum,iNum,suffix)}Tan(){if(this._iNum){const den=decimal.A.cos(2*this._realNum).add(decimal.A.cosh(2*this._iNum)),realNum=decimal.A.sin(2*this._realNum).div(den).toNumber(),iNum=decimal.A.sinh(2*this._iNum).div(den).toNumber();return complex_Complex.getComplex(realNum,iNum,this._suffix)}{const realNum=decimal.A.tan(this._realNum).toNumber();return complex_Complex.getComplex(realNum,this._iNum,this._suffix)}}Tanh(){if(!Number.isFinite(Math.sinh(this._realNum))||!Number.isFinite(Math.cosh(this._realNum)))return this._isError=!0,"";if(this._iNum){const den=decimal.A.cosh(2*this._realNum).add(decimal.A.cos(2*this._iNum)),realNum=decimal.A.sinh(2*this._realNum).div(den).toNumber(),iNum=decimal.A.sin(2*this._iNum).div(den).toNumber();return complex_Complex.getComplex(realNum,iNum,this._suffix)}{const realNum=decimal.A.tanh(this._realNum).toNumber();return complex_Complex.getComplex(realNum,this._iNum,this._suffix)}}}var FUNCTION_NAMES_ENGINEERING=function(FUNCTION_NAMES_ENGINEERING){return FUNCTION_NAMES_ENGINEERING.BESSELI="BESSELI",FUNCTION_NAMES_ENGINEERING.BESSELJ="BESSELJ",FUNCTION_NAMES_ENGINEERING.BESSELK="BESSELK",FUNCTION_NAMES_ENGINEERING.BESSELY="BESSELY",FUNCTION_NAMES_ENGINEERING.BIN2DEC="BIN2DEC",FUNCTION_NAMES_ENGINEERING.BIN2HEX="BIN2HEX",FUNCTION_NAMES_ENGINEERING.BIN2OCT="BIN2OCT",FUNCTION_NAMES_ENGINEERING.BITAND="BITAND",FUNCTION_NAMES_ENGINEERING.BITLSHIFT="BITLSHIFT",FUNCTION_NAMES_ENGINEERING.BITOR="BITOR",FUNCTION_NAMES_ENGINEERING.BITRSHIFT="BITRSHIFT",FUNCTION_NAMES_ENGINEERING.BITXOR="BITXOR",FUNCTION_NAMES_ENGINEERING.COMPLEX="COMPLEX",FUNCTION_NAMES_ENGINEERING.CONVERT="CONVERT",FUNCTION_NAMES_ENGINEERING.DEC2BIN="DEC2BIN",FUNCTION_NAMES_ENGINEERING.DEC2HEX="DEC2HEX",FUNCTION_NAMES_ENGINEERING.DEC2OCT="DEC2OCT",FUNCTION_NAMES_ENGINEERING.DELTA="DELTA",FUNCTION_NAMES_ENGINEERING.ERF="ERF",FUNCTION_NAMES_ENGINEERING.ERF_PRECISE="ERF.PRECISE",FUNCTION_NAMES_ENGINEERING.ERFC="ERFC",FUNCTION_NAMES_ENGINEERING.ERFC_PRECISE="ERFC.PRECISE",FUNCTION_NAMES_ENGINEERING.GESTEP="GESTEP",FUNCTION_NAMES_ENGINEERING.HEX2BIN="HEX2BIN",FUNCTION_NAMES_ENGINEERING.HEX2DEC="HEX2DEC",FUNCTION_NAMES_ENGINEERING.HEX2OCT="HEX2OCT",FUNCTION_NAMES_ENGINEERING.IMABS="IMABS",FUNCTION_NAMES_ENGINEERING.IMAGINARY="IMAGINARY",FUNCTION_NAMES_ENGINEERING.IMARGUMENT="IMARGUMENT",FUNCTION_NAMES_ENGINEERING.IMCONJUGATE="IMCONJUGATE",FUNCTION_NAMES_ENGINEERING.IMCOS="IMCOS",FUNCTION_NAMES_ENGINEERING.IMCOSH="IMCOSH",FUNCTION_NAMES_ENGINEERING.IMCOT="IMCOT",FUNCTION_NAMES_ENGINEERING.IMCOTH="IMCOTH",FUNCTION_NAMES_ENGINEERING.IMCSC="IMCSC",FUNCTION_NAMES_ENGINEERING.IMCSCH="IMCSCH",FUNCTION_NAMES_ENGINEERING.IMDIV="IMDIV",FUNCTION_NAMES_ENGINEERING.IMEXP="IMEXP",FUNCTION_NAMES_ENGINEERING.IMLN="IMLN",FUNCTION_NAMES_ENGINEERING.IMLOG="IMLOG",FUNCTION_NAMES_ENGINEERING.IMLOG10="IMLOG10",FUNCTION_NAMES_ENGINEERING.IMLOG2="IMLOG2",FUNCTION_NAMES_ENGINEERING.IMPOWER="IMPOWER",FUNCTION_NAMES_ENGINEERING.IMPRODUCT="IMPRODUCT",FUNCTION_NAMES_ENGINEERING.IMREAL="IMREAL",FUNCTION_NAMES_ENGINEERING.IMSEC="IMSEC",FUNCTION_NAMES_ENGINEERING.IMSECH="IMSECH",FUNCTION_NAMES_ENGINEERING.IMSIN="IMSIN",FUNCTION_NAMES_ENGINEERING.IMSINH="IMSINH",FUNCTION_NAMES_ENGINEERING.IMSQRT="IMSQRT",FUNCTION_NAMES_ENGINEERING.IMSUB="IMSUB",FUNCTION_NAMES_ENGINEERING.IMSUM="IMSUM",FUNCTION_NAMES_ENGINEERING.IMTAN="IMTAN",FUNCTION_NAMES_ENGINEERING.IMTANH="IMTANH",FUNCTION_NAMES_ENGINEERING.OCT2BIN="OCT2BIN",FUNCTION_NAMES_ENGINEERING.OCT2DEC="OCT2DEC",FUNCTION_NAMES_ENGINEERING.OCT2HEX="OCT2HEX",FUNCTION_NAMES_ENGINEERING}({});const functionEngineering=[[class Besseli extends base_function_BaseFunction{calculate(x,n){if(x.isNull()||n.isNull())return ErrorValueObject.create(error_type_ErrorType.NA);const{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(x,n);if(isError)return errorObject;const[xObject,nObject]=variants,xValue=+xObject.getValue(),nValue=Math.floor(+nObject.getValue());if(Number.isNaN(xValue)||Number.isNaN(nValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);if(nValue<0)return ErrorValueObject.create(error_type_ErrorType.NUM);const result=BESSEL.besseli(xValue,nValue);return Number.isNaN(result)||!Number.isFinite(result)?ErrorValueObject.create(error_type_ErrorType.NUM):NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_ENGINEERING.BESSELI],[class Besselj extends base_function_BaseFunction{calculate(x,n){if(x.isNull()||n.isNull())return ErrorValueObject.create(error_type_ErrorType.NA);const{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(x,n);if(isError)return errorObject;const[xObject,nObject]=variants,xValue=+xObject.getValue(),nValue=Math.floor(+nObject.getValue());if(Number.isNaN(xValue)||Number.isNaN(nValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);if(nValue<0)return ErrorValueObject.create(error_type_ErrorType.NUM);const result=BESSEL.besselj(xValue,nValue);return Number.isNaN(result)||!Number.isFinite(result)?ErrorValueObject.create(error_type_ErrorType.NUM):NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_ENGINEERING.BESSELJ],[class Besselk extends base_function_BaseFunction{calculate(x,n){if(x.isNull()||n.isNull())return ErrorValueObject.create(error_type_ErrorType.NA);const{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(x,n);if(isError)return errorObject;const[xObject,nObject]=variants,xValue=+xObject.getValue(),nValue=Math.floor(+nObject.getValue());if(Number.isNaN(xValue)||Number.isNaN(nValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);if(nValue<0)return ErrorValueObject.create(error_type_ErrorType.NUM);const result=BESSEL.besselk(xValue,nValue);return Number.isNaN(result)||!Number.isFinite(result)?ErrorValueObject.create(error_type_ErrorType.NUM):NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_ENGINEERING.BESSELK],[class Bessely extends base_function_BaseFunction{calculate(x,n){if(x.isNull()||n.isNull())return ErrorValueObject.create(error_type_ErrorType.NA);const{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(x,n);if(isError)return errorObject;const[xObject,nObject]=variants,xValue=+xObject.getValue(),nValue=Math.floor(+nObject.getValue());if(Number.isNaN(xValue)||Number.isNaN(nValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);if(nValue<0)return ErrorValueObject.create(error_type_ErrorType.NUM);const result=BESSEL.bessely(xValue,nValue);return Number.isNaN(result)||!Number.isFinite(result)?ErrorValueObject.create(error_type_ErrorType.NUM):NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_ENGINEERING.BESSELY],[class Bin2dec extends base_function_BaseFunction{calculate(number){const{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(number);if(isError)return errorObject;const[numberObject]=variants,numberValue=`${numberObject.getValue()}`;if(!isValidBinaryNumber(numberValue))return ErrorValueObject.create(error_type_ErrorType.NUM);let result;return result=10===numberValue.length&&"1"===numberValue.substring(0,1)?Number.parseInt(numberValue.substring(1),2)-512:Number.parseInt(numberValue,2),NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_ENGINEERING.BIN2DEC],[class Bin2hex extends base_function_BaseFunction{calculate(number,places){if(number.isNull())return ErrorValueObject.create(error_type_ErrorType.NA);let placesValue=0;if(places){const{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(places);if(isError)return errorObject;const[placesObject]=variants;if(placesValue=Math.floor(+placesObject.getValue()),Number.isNaN(placesValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);if(placesValue<0||placesValue>10)return ErrorValueObject.create(error_type_ErrorType.NUM)}const{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(number);if(isError)return errorObject;const[numberObject]=variants,numberValue=`${numberObject.getValue()}`;if(!isValidBinaryNumber(numberValue))return ErrorValueObject.create(error_type_ErrorType.NUM);let result;if(10===numberValue.length&&"1"===numberValue.substring(0,1))result=(0xfffffffe00+Number.parseInt(numberValue.substring(1),2)).toString(16);else if(result=Number.parseInt(numberValue,2).toString(16),places){if(placesValue<result.length)return ErrorValueObject.create(error_type_ErrorType.NUM);result="0".repeat(placesValue-result.length)+result}return StringValueObject.create(result.toLocaleUpperCase())}constructor(...args){super(...args),this.minParams=1,this.maxParams=2}},FUNCTION_NAMES_ENGINEERING.BIN2HEX],[class Bin2oct extends base_function_BaseFunction{calculate(number,places){if(number.isNull())return ErrorValueObject.create(error_type_ErrorType.NA);let placesValue=0;if(places){const{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(places);if(isError)return errorObject;const[placesObject]=variants;if(placesValue=Math.floor(+placesObject.getValue()),Number.isNaN(placesValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);if(placesValue<0||placesValue>10)return ErrorValueObject.create(error_type_ErrorType.NUM)}const{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(number);if(isError)return errorObject;const[numberObject]=variants,numberValue=`${numberObject.getValue()}`;if(!isValidBinaryNumber(numberValue))return ErrorValueObject.create(error_type_ErrorType.NUM);let result;if(10===numberValue.length&&"1"===numberValue.substring(0,1))result=(1073741312+Number.parseInt(numberValue.substring(1),2)).toString(8);else if(result=Number.parseInt(numberValue,2).toString(8),places){if(placesValue<result.length)return ErrorValueObject.create(error_type_ErrorType.NUM);result="0".repeat(placesValue-result.length)+result}return StringValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=2}},FUNCTION_NAMES_ENGINEERING.BIN2OCT],[class Bitand extends base_function_BaseFunction{calculate(number1,number2){if(number1.isError())return number1;if(number2.isError())return number2;const maxRowLength=Math.max(number1.isArray()?number1.getRowCount():1,number2.isArray()?number2.getRowCount():1),maxColumnLength=Math.max(number1.isArray()?number1.getColumnCount():1,number2.isArray()?number2.getColumnCount():1),number1Array=expandArrayValueObject(maxRowLength,maxColumnLength,number1,ErrorValueObject.create(error_type_ErrorType.NA)),number2Array=expandArrayValueObject(maxRowLength,maxColumnLength,number2,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=number1Array.map(((itemObject,rowIndex,columnIndex)=>{let number1Object=itemObject;if(number1Object.isString()&&(number1Object=number1Object.convertToNumberObjectValue()),number1Object.isError())return number1Object;let number2Object=number2Array.get(rowIndex,columnIndex);if(number2Object.isString()&&(number2Object=number2Object.convertToNumberObjectValue()),number2Object.isError())return number2Object;const number1Value=+number1Object.getValue(),number2Value=+number2Object.getValue();if(number1Value<0||number2Value<0||Math.floor(number1Value)!==number1Value||Math.floor(number2Value)!==number2Value||number1Value>0xffffffffffff||number2Value>0xffffffffffff)return ErrorValueObject.create(error_type_ErrorType.NUM);const result=number1Value&number2Value;return NumberValueObject.create(result)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_ENGINEERING.BITAND],[class Bitlshift extends base_function_BaseFunction{calculate(number,shiftAmount){if(number.isError())return number;if(shiftAmount.isError())return shiftAmount;const maxRowLength=Math.max(number.isArray()?number.getRowCount():1,shiftAmount.isArray()?shiftAmount.getRowCount():1),maxColumnLength=Math.max(number.isArray()?number.getColumnCount():1,shiftAmount.isArray()?shiftAmount.getColumnCount():1),numberArray=expandArrayValueObject(maxRowLength,maxColumnLength,number,ErrorValueObject.create(error_type_ErrorType.NA)),shiftAmountArray=expandArrayValueObject(maxRowLength,maxColumnLength,shiftAmount,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=numberArray.map(((itemObject,rowIndex,columnIndex)=>{let numberObject=itemObject;if(numberObject.isString()&&(numberObject=numberObject.convertToNumberObjectValue()),numberObject.isError())return numberObject;let shiftAmountObject=shiftAmountArray.get(rowIndex,columnIndex);if(shiftAmountObject.isString()&&(shiftAmountObject=shiftAmountObject.convertToNumberObjectValue()),shiftAmountObject.isError())return shiftAmountObject;const numberValue=+numberObject.getValue();let shiftAmountValue=+shiftAmountObject.getValue();if(numberValue<0||Math.floor(numberValue)!==numberValue||numberValue>0xffffffffffff||Math.abs(shiftAmountValue)>53)return ErrorValueObject.create(error_type_ErrorType.NUM);shiftAmountValue=Math.trunc(shiftAmountValue);const result=Number(shiftAmountValue>=0?BigInt(numberValue)<<BigInt(shiftAmountValue):BigInt(numberValue)>>BigInt(-shiftAmountValue));return result>0xffffffffffff?ErrorValueObject.create(error_type_ErrorType.NUM):NumberValueObject.create(result)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_ENGINEERING.BITLSHIFT],[class Bitor extends base_function_BaseFunction{calculate(number1,number2){if(number1.isError())return number1;if(number2.isError())return number2;const maxRowLength=Math.max(number1.isArray()?number1.getRowCount():1,number2.isArray()?number2.getRowCount():1),maxColumnLength=Math.max(number1.isArray()?number1.getColumnCount():1,number2.isArray()?number2.getColumnCount():1),number1Array=expandArrayValueObject(maxRowLength,maxColumnLength,number1,ErrorValueObject.create(error_type_ErrorType.NA)),number2Array=expandArrayValueObject(maxRowLength,maxColumnLength,number2,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=number1Array.map(((itemObject,rowIndex,columnIndex)=>{let number1Object=itemObject;if(number1Object.isString()&&(number1Object=number1Object.convertToNumberObjectValue()),number1Object.isError())return number1Object;let number2Object=number2Array.get(rowIndex,columnIndex);if(number2Object.isString()&&(number2Object=number2Object.convertToNumberObjectValue()),number2Object.isError())return number2Object;const number1Value=+number1Object.getValue(),number2Value=+number2Object.getValue();if(number1Value<0||number2Value<0||Math.floor(number1Value)!==number1Value||Math.floor(number2Value)!==number2Value||number1Value>0xffffffffffff||number2Value>0xffffffffffff)return ErrorValueObject.create(error_type_ErrorType.NUM);const result=Number(BigInt(number1Value)|BigInt(number2Value));return NumberValueObject.create(result)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_ENGINEERING.BITOR],[class Bitrshift extends base_function_BaseFunction{calculate(number,shiftAmount){if(number.isError())return number;if(shiftAmount.isError())return shiftAmount;const maxRowLength=Math.max(number.isArray()?number.getRowCount():1,shiftAmount.isArray()?shiftAmount.getRowCount():1),maxColumnLength=Math.max(number.isArray()?number.getColumnCount():1,shiftAmount.isArray()?shiftAmount.getColumnCount():1),numberArray=expandArrayValueObject(maxRowLength,maxColumnLength,number,ErrorValueObject.create(error_type_ErrorType.NA)),shiftAmountArray=expandArrayValueObject(maxRowLength,maxColumnLength,shiftAmount,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=numberArray.map(((itemObject,rowIndex,columnIndex)=>{let numberObject=itemObject;if(numberObject.isString()&&(numberObject=numberObject.convertToNumberObjectValue()),numberObject.isError())return numberObject;let shiftAmountObject=shiftAmountArray.get(rowIndex,columnIndex);if(shiftAmountObject.isString()&&(shiftAmountObject=shiftAmountObject.convertToNumberObjectValue()),shiftAmountObject.isError())return shiftAmountObject;const numberValue=+numberObject.getValue();let shiftAmountValue=+shiftAmountObject.getValue();if(numberValue<0||Math.floor(numberValue)!==numberValue||numberValue>0xffffffffffff||Math.abs(shiftAmountValue)>53)return ErrorValueObject.create(error_type_ErrorType.NUM);shiftAmountValue=Math.trunc(shiftAmountValue);const result=Number(shiftAmountValue>=0?BigInt(numberValue)>>BigInt(shiftAmountValue):BigInt(numberValue)<<BigInt(-shiftAmountValue));return result>0xffffffffffff?ErrorValueObject.create(error_type_ErrorType.NUM):NumberValueObject.create(result)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_ENGINEERING.BITRSHIFT],[class Bitxor extends base_function_BaseFunction{calculate(number1,number2){if(number1.isError())return number1;if(number2.isError())return number2;const maxRowLength=Math.max(number1.isArray()?number1.getRowCount():1,number2.isArray()?number2.getRowCount():1),maxColumnLength=Math.max(number1.isArray()?number1.getColumnCount():1,number2.isArray()?number2.getColumnCount():1),number1Array=expandArrayValueObject(maxRowLength,maxColumnLength,number1,ErrorValueObject.create(error_type_ErrorType.NA)),number2Array=expandArrayValueObject(maxRowLength,maxColumnLength,number2,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=number1Array.map(((itemObject,rowIndex,columnIndex)=>{let number1Object=itemObject;if(number1Object.isString()&&(number1Object=number1Object.convertToNumberObjectValue()),number1Object.isError())return number1Object;let number2Object=number2Array.get(rowIndex,columnIndex);if(number2Object.isString()&&(number2Object=number2Object.convertToNumberObjectValue()),number2Object.isError())return number2Object;const number1Value=+number1Object.getValue(),number2Value=+number2Object.getValue();if(number1Value<0||number2Value<0||Math.floor(number1Value)!==number1Value||Math.floor(number2Value)!==number2Value||number1Value>0xffffffffffff||number2Value>0xffffffffffff)return ErrorValueObject.create(error_type_ErrorType.NUM);const result=number1Value^number2Value;return NumberValueObject.create(result)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_ENGINEERING.BITXOR],[class Complex extends base_function_BaseFunction{calculate(realNum,iNum,suffix){const _suffix=suffix??StringValueObject.create("i"),{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(realNum,iNum,_suffix);if(isError)return errorObject;const[realNumObject,iNumObject,suffixObject]=variants,realNumValue=+realNumObject.getValue(),iNumValue=+iNumObject.getValue(),suffixValue=`${suffixObject.getValue()}`;if(Number.isNaN(realNumValue)||Number.isNaN(iNumValue)||"i"!==suffixValue&&"j"!==suffixValue)return ErrorValueObject.create(error_type_ErrorType.VALUE);const result=complex_Complex.getComplex(realNumValue,iNumValue,suffixValue);return"number"==typeof result?NumberValueObject.create(result):StringValueObject.create(result)}constructor(...args){super(...args),this.minParams=2,this.maxParams=3}},FUNCTION_NAMES_ENGINEERING.COMPLEX],[class Convert extends base_function_BaseFunction{calculate(number,fromUnit,toUnit){const{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(number,fromUnit,toUnit);if(isError)return errorObject;const[numberObject,fromUnitObject,toUnitObject]=variants,numberValue=+numberObject.getValue(),fromUnitValue=`${fromUnitObject.getValue()}`,toUnitValue=`${toUnitObject.getValue()}`;if(Number.isNaN(numberValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);let from,to,fromMultiplier=1,toMultiplier=1;const{_from,_to}=this._lookupFromAndToUnits(fromUnitValue,toUnitValue);if(from=_from,to=_to,null===from){const{_from,_fromMultiplier}=this._lookupFromPrefix(fromUnitValue);from=_from,fromMultiplier=_fromMultiplier}if(null===to){const{_to,_toMultiplier}=this._lookupToPrefix(toUnitValue);to=_to,toMultiplier=_toMultiplier}if(null===from||null===to)return ErrorValueObject.create(error_type_ErrorType.NA);if(from[3]!==to[3])return ErrorValueObject.create(error_type_ErrorType.NA);let result;return"temperature"===from[3]?(result=this._getTemperatureConversion(numberValue,from[1],to[1]),result=+result.toFixed(2)):result=numberValue*from[6]*fromMultiplier/(to[6]*toMultiplier),NumberValueObject.create(result)}_lookupFromAndToUnits(fromUnitValue,toUnitValue){let alt,_from=null,_to=null;for(let i=0;i<this._units.length;i++)alt=null===this._units[i][2]?[]:this._units[i][2],(this._units[i][1]===fromUnitValue||alt.indexOf(fromUnitValue)>=0)&&(_from=this._units[i]),(this._units[i][1]===toUnitValue||alt.indexOf(toUnitValue)>=0)&&(_to=this._units[i]);return{_from,_to}}_lookupFromPrefix(fromUnitValue){let alt,_from=null,_fromMultiplier=1,baseFromUnit=fromUnitValue;const fromBinaryPrefix=this._binaryPrefixes[fromUnitValue.substring(0,2)];let fromUnitPrefix=this._unitPrefixes[fromUnitValue.substring(0,1)];"da"===fromUnitValue.substring(0,2)&&(fromUnitPrefix=["dekao",10,"da"]),fromBinaryPrefix?(_fromMultiplier=fromBinaryPrefix[2],baseFromUnit=fromUnitValue.substring(2)):fromUnitPrefix&&(_fromMultiplier=fromUnitPrefix[1],baseFromUnit=fromUnitValue.substring(fromUnitPrefix[2].length));for(let j=0;j<this._units.length;j++)alt=null===this._units[j][2]?[]:this._units[j][2],(this._units[j][1]===baseFromUnit||alt.indexOf(baseFromUnit)>=0)&&(_from=this._units[j]);return{_from,_fromMultiplier}}_lookupToPrefix(toUnitValue){let alt,_to=null,_toMultiplier=1,baseToUnit=toUnitValue;const toBinaryPrefix=this._binaryPrefixes[toUnitValue.substring(0,2)];let toUnitPrefix=this._unitPrefixes[toUnitValue.substring(0,1)];"da"===toUnitValue.substring(0,2)&&(toUnitPrefix=["dekao",10,"da"]),toBinaryPrefix?(_toMultiplier=toBinaryPrefix[2],baseToUnit=toUnitValue.substring(2)):toUnitPrefix&&(_toMultiplier=toUnitPrefix[1],baseToUnit=toUnitValue.substring(toUnitPrefix[2].length));for(let k=0;k<this._units.length;k++)alt=null===this._units[k][2]?[]:this._units[k][2],(this._units[k][1]===baseToUnit||alt.indexOf(baseToUnit)>=0)&&(_to=this._units[k]);return{_to,_toMultiplier}}_getTemperatureConversion(number,from,to){switch(from){case"C":return this._centigradeConversion(number,to);case"F":return this._fahrenheitConversion(number,to);case"K":return this._kelvinConversion(number,to);case"Rank":return this._rankineConversion(number,to);case"Reau":return this._reaumurConversion(number,to);default:return number}}_centigradeConversion(number,to){switch(to){case"F":return 9*number/5+32;case"K":return number+273.15;case"Rank":return 9*(number+273.15)/5;case"Reau":return 4*number/5;default:return number}}_fahrenheitConversion(number,to){switch(to){case"C":return 5*(number-32)/9;case"K":return 5*(number-32)/9+273.15;case"Rank":return number+459.67;case"Reau":return 4*(number-32)/9;default:return number}}_kelvinConversion(number,to){switch(to){case"C":return number-273.15;case"F":return 9*(number-273.15)/5+32;case"Rank":return 9*number/5;case"Reau":return 4*(number-273.15)/5;default:return number}}_rankineConversion(number,to){switch(to){case"C":return 5*(number-491.67)/9;case"F":return number-459.67;case"K":return 5*number/9;case"Reau":return 4*(number-491.67)/9;default:return number}}_reaumurConversion(number,to){switch(to){case"C":return 5*number/4;case"F":return 9*number/4+32;case"K":return 5*number/4+273.15;case"Rank":return 9*number/4+491.67;default:return number}}constructor(...args){super(...args),this.minParams=3,this.maxParams=3,this._units=[["a.u. of action","?",null,"action",!1,!1,105457168181818e-48],["a.u. of charge","e",null,"electric_charge",!1,!1,160217653141414e-33],["a.u. of energy","Eh",null,"energy",!1,!1,435974417757576e-32],["a.u. of length","a?",null,"length",!1,!1,529177210818182e-25],["a.u. of mass","m?",null,"mass",!1,!1,910938261616162e-45],["a.u. of time","?/Eh",null,"time",!1,!1,241888432650516e-31],["admiralty knot","admkn",null,"speed",!1,!0,.514773333],["ampere","A",null,"electric_current",!0,!1,1],["ampere per meter","A/m",null,"magnetic_field_intensity",!0,!1,1],["ångström","Å",["ang"],"length",!1,!0,1e-10],["are","ar",null,"area",!1,!0,100],["astronomical unit","ua",null,"length",!1,!1,149597870691667e-25],["bar","bar",null,"pressure",!1,!1,1e5],["barn","b",null,"area",!1,!1,1e-28],["becquerel","Bq",null,"radioactivity",!0,!1,1],["bit","bit",["b"],"information",!1,!0,1],["btu","BTU",["btu"],"energy",!1,!0,1055.05585262],["byte","byte",null,"information",!1,!0,8],["candela","cd",null,"luminous_intensity",!0,!1,1],["candela per square metre","cd/m?",null,"luminance",!0,!1,1],["centigrade","C",["cel"],"temperature",!0,!1,1],["cubic ångström","ang3",["ang^3"],"volume",!1,!0,1e-30],["cubic foot","ft3",["ft^3"],"volume",!1,!0,.028316846592],["cubic inch","in3",["in^3"],"volume",!1,!0,16387064e-12],["cubic light-year","ly3",["ly^3"],"volume",!1,!0,846786664623715e-61],["cubic metre","m3",["m^3"],"volume",!0,!0,1],["cubic mile","mi3",["mi^3"],"volume",!1,!0,4168181825.44058],["cubic nautical mile","Nmi3",["Nmi^3"],"volume",!1,!0,6352182208],["cubic Pica","Pica3",["Picapt3","Pica^3","Picapt^3"],"volume",!1,!0,7.58660370370369e-8],["cubic yard","yd3",["yd^3"],"volume",!1,!0,.764554857984],["cup","cup",null,"volume",!1,!0,.0002365882365],["dalton","Da",["u"],"mass",!1,!1,166053886282828e-41],["day","d",["day"],"time",!1,!0,86400],["degree","°",null,"angle",!1,!1,.0174532925199433],["dyne","dyn",["dy"],"force",!1,!0,1e-5],["electronvolt","eV",["ev"],"energy",!1,!0,1.60217656514141],["ell","ell",null,"length",!1,!0,1.143],["erg","erg",["e"],"energy",!1,!0,1e-7],["fahrenheit","F",["fah"],"temperature",!0,!1,1],["fluid ounce","oz",null,"volume",!1,!0,295735295625e-16],["foot","ft",null,"length",!1,!0,.3048],["foot-pound","flb",null,"energy",!1,!0,1.3558179483314],["gal","Gal",null,"acceleration",!1,!1,.01],["gallon","gal",null,"volume",!1,!0,.003785411784],["gauss","G",["ga"],"magnetic_flux_density",!1,!0,1],["grain","grain",null,"mass",!1,!0,647989e-10],["gram","g",null,"mass",!1,!0,.001],["gray","Gy",null,"absorbed_dose",!0,!1,1],["gross registered ton","GRT",["regton"],"volume",!1,!0,2.8316846592],["hectare","ha",null,"area",!1,!0,1e4],["henry","H",null,"inductance",!0,!1,1],["hertz","Hz",null,"frequency",!0,!1,1],["horsepower","HP",["h"],"power",!1,!0,745.69987158227],["horsepower-hour","HPh",["hh","hph"],"energy",!1,!0,2684519.538],["hour","h",["hr"],"time",!1,!0,3600],["imperial gallon (U.K.)","uk_gal",null,"volume",!1,!0,.00454609],["imperial hundredweight","lcwt",["uk_cwt","hweight"],"mass",!1,!0,50.802345],["imperial quart (U.K)","uk_qt",null,"volume",!1,!0,.0011365225],["imperial ton","brton",["uk_ton","LTON"],"mass",!1,!0,1016.046909],["inch","in",null,"length",!1,!0,.0254],["international acre","uk_acre",null,"area",!1,!0,4046.8564224],["IT calorie","cal",null,"energy",!1,!0,4.1868],["joule","J",null,"energy",!0,!0,1],["katal","kat",null,"catalytic_activity",!0,!1,1],["kelvin","K",["kel"],"temperature",!0,!0,1],["kilogram","kg",null,"mass",!0,!0,1],["knot","kn",null,"speed",!1,!0,.514444444444444],["light-year","ly",null,"length",!1,!0,9460730472580800],["litre","L",["l","lt"],"volume",!1,!0,.001],["lumen","lm",null,"luminous_flux",!0,!1,1],["lux","lx",null,"illuminance",!0,!1,1],["maxwell","Mx",null,"magnetic_flux",!1,!1,1e-18],["measurement ton","MTON",null,"volume",!1,!0,1.13267386368],["meter per hour","m/h",["m/hr"],"speed",!1,!0,.00027777777777778],["meter per second","m/s",["m/sec"],"speed",!0,!0,1],["meter per second squared","m?s??",null,"acceleration",!0,!1,1],["parsec","pc",["parsec"],"length",!1,!0,0x6da012f958ee1c],["meter squared per second","m?/s",null,"kinematic_viscosity",!0,!1,1],["metre","m",null,"length",!0,!0,1],["miles per hour","mph",null,"speed",!1,!0,.44704],["millimetre of mercury","mmHg",null,"pressure",!1,!1,133.322],["minute","?",null,"angle",!1,!1,.000290888208665722],["minute","min",["mn"],"time",!1,!0,60],["modern teaspoon","tspm",null,"volume",!1,!0,5e-6],["mole","mol",null,"amount_of_substance",!0,!1,1],["morgen","Morgen",null,"area",!1,!0,2500],["n.u. of action","?",null,"action",!1,!1,105457168181818e-48],["n.u. of mass","m?",null,"mass",!1,!1,910938261616162e-45],["n.u. of speed","c?",null,"speed",!1,!1,299792458],["n.u. of time","?/(me?c??)",null,"time",!1,!1,128808866778687e-35],["nautical mile","M",["Nmi"],"length",!1,!0,1852],["newton","N",null,"force",!0,!0,1],["œrsted","Oe ",null,"magnetic_field_intensity",!1,!1,79.5774715459477],["ohm","Ω",null,"electric_resistance",!0,!1,1],["ounce mass","ozm",null,"mass",!1,!0,.028349523125],["pascal","Pa",null,"pressure",!0,!1,1],["pascal second","Pa?s",null,"dynamic_viscosity",!0,!1,1],["pferdestärke","PS",null,"power",!1,!0,735.49875],["phot","ph",null,"illuminance",!1,!1,1e-4],["pica (1/6 inch)","pica",null,"length",!1,!0,.00035277777777778],["pica (1/72 inch)","Pica",["Picapt"],"length",!1,!0,.00423333333333333],["poise","P",null,"dynamic_viscosity",!1,!1,.1],["pond","pond",null,"force",!1,!0,.00980665],["pound force","lbf",null,"force",!1,!0,4.4482216152605],["pound mass","lbm",null,"mass",!1,!0,.45359237],["quart","qt",null,"volume",!1,!0,.000946352946],["radian","rad",null,"angle",!0,!1,1],["rankine","Rank",null,"temperature",!1,!0,1],["reaumur","Reau",null,"temperature",!1,!0,1],["second","?",null,"angle",!1,!1,484813681109536e-20],["second","s",["sec"],"time",!0,!0,1],["short hundredweight","cwt",["shweight"],"mass",!1,!0,45.359237],["siemens","S",null,"electrical_conductance",!0,!1,1],["sievert","Sv",null,"equivalent_dose",!0,!1,1],["slug","sg",null,"mass",!1,!0,14.59390294],["square ångström","ang2",["ang^2"],"area",!1,!0,1e-20],["square foot","ft2",["ft^2"],"area",!1,!0,.09290304],["square inch","in2",["in^2"],"area",!1,!0,64516e-8],["square light-year","ly2",["ly^2"],"area",!1,!0,895054210748189e17],["square meter","m?",null,"area",!0,!0,1],["square mile","mi2",["mi^2"],"area",!1,!0,2589988.110336],["square nautical mile","Nmi2",["Nmi^2"],"area",!1,!0,3429904],["square Pica","Pica2",["Picapt2","Pica^2","Picapt^2"],"area",!1,!0,1792111111111e-17],["square yard","yd2",["yd^2"],"area",!1,!0,.83612736],["statute mile","mi",null,"length",!1,!0,1609.344],["steradian","sr",null,"solid_angle",!0,!1,1],["stilb","sb",null,"luminance",!1,!1,1e-4],["stokes","St",null,"kinematic_viscosity",!1,!1,1e-4],["stone","stone",null,"mass",!1,!0,6.35029318],["tablespoon","tbs",null,"volume",!1,!0,147868e-10],["teaspoon","tsp",null,"volume",!1,!0,492892e-11],["tesla","T",null,"magnetic_flux_density",!0,!0,1],["thermodynamic calorie","c",null,"energy",!1,!0,4.184],["ton","ton",null,"mass",!1,!0,907.18474],["tonne","t",null,"mass",!1,!1,1e3],["U.K. pint","uk_pt",null,"volume",!1,!0,.00056826125],["U.S. bushel","bushel",null,"volume",!1,!0,.03523907],["U.S. oil barrel","barrel",null,"volume",!1,!0,.158987295],["U.S. pint","pt",["us_pt"],"volume",!1,!0,.000473176473],["U.S. survey mile","survey_mi",null,"length",!1,!0,1609.347219],["U.S. survey/statute acre","us_acre",null,"area",!1,!0,4046.87261],["volt","V",null,"voltage",!0,!1,1],["watt","W",null,"power",!0,!0,1],["watt-hour","Wh",["wh"],"energy",!1,!0,3600],["weber","Wb",null,"magnetic_flux",!0,!1,1],["yard","yd",null,"length",!1,!0,.9144],["year","yr",null,"time",!1,!0,31557600]],this._binaryPrefixes={Yi:["yobi",80,12089258196146292e8,"Yi","yotta"],Zi:["zebi",70,11805916207174113e5,"Zi","zetta"],Ei:["exbi",60,0x1000000000000000,"Ei","exa"],Pi:["pebi",50,0x4000000000000,"Pi","peta"],Ti:["tebi",40,1099511627776,"Ti","tera"],Gi:["gibi",30,1073741824,"Gi","giga"],Mi:["mebi",20,1048576,"Mi","mega"],ki:["kibi",10,1024,"ki","kilo"]},this._unitPrefixes={Y:["yotta",1e24,"Y"],Z:["zetta",1e21,"Z"],E:["exa",1e18,"E"],P:["peta",1e15,"P"],T:["tera",1e12,"T"],G:["giga",1e9,"G"],M:["mega",1e6,"M"],k:["kilo",1e3,"k"],h:["hecto",100,"h"],e:["dekao",10,"e"],d:["deci",.1,"d"],c:["centi",.01,"c"],m:["milli",.001,"m"],u:["micro",1e-6,"u"],n:["nano",1e-9,"n"],p:["pico",1e-12,"p"],f:["femto",1e-15,"f"],a:["atto",1e-18,"a"],z:["zepto",1e-21,"z"],y:["yocto",1e-24,"y"]}}},FUNCTION_NAMES_ENGINEERING.CONVERT],[class Dec2bin extends base_function_BaseFunction{calculate(number,places){if(number.isNull())return ErrorValueObject.create(error_type_ErrorType.NA);let placesValue=0;if(places){const{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(places);if(isError)return errorObject;const[placesObject]=variants;if(placesValue=Math.floor(+placesObject.getValue()),Number.isNaN(placesValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);if(placesValue<0||placesValue>10)return ErrorValueObject.create(error_type_ErrorType.NUM)}const{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(number);if(isError)return errorObject;const[numberObject]=variants,numberValue=Math.trunc(+numberObject.getValue());if(Number.isNaN(numberValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);if(!/^-?[0-9]{1,3}$/.test(`${numberValue}`)||numberValue<-512||numberValue>511)return ErrorValueObject.create(error_type_ErrorType.NUM);let result;if(numberValue<0){const toStr=(512+numberValue).toString(2);result=`1${"0".repeat(9-toStr.length)}${toStr}`}else if(result=Number.parseInt(`${numberValue}`,10).toString(2),places){if(placesValue<result.length)return ErrorValueObject.create(error_type_ErrorType.NUM);result="0".repeat(placesValue-result.length)+result}return StringValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=2}},FUNCTION_NAMES_ENGINEERING.DEC2BIN],[class Dec2hex extends base_function_BaseFunction{calculate(number,places){if(number.isNull())return ErrorValueObject.create(error_type_ErrorType.NA);let placesValue=0;if(places){const{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(places);if(isError)return errorObject;const[placesObject]=variants;if(placesValue=Math.floor(+placesObject.getValue()),Number.isNaN(placesValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);if(placesValue<0||placesValue>10)return ErrorValueObject.create(error_type_ErrorType.NUM)}const{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(number);if(isError)return errorObject;const[numberObject]=variants,numberValue=Math.trunc(+numberObject.getValue());if(Number.isNaN(numberValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);if(!/^-?[0-9]{1,12}$/.test(`${numberValue}`)||numberValue<-549755813888||numberValue>549755813887)return ErrorValueObject.create(error_type_ErrorType.NUM);let result;if(numberValue<0)result=(1099511627776+numberValue).toString(16);else if(result=Number.parseInt(`${numberValue}`,10).toString(16),places){if(placesValue<result.length)return ErrorValueObject.create(error_type_ErrorType.NUM);result="0".repeat(placesValue-result.length)+result}return StringValueObject.create(result.toLocaleUpperCase())}constructor(...args){super(...args),this.minParams=1,this.maxParams=2}},FUNCTION_NAMES_ENGINEERING.DEC2HEX],[class Dec2oct extends base_function_BaseFunction{calculate(number,places){if(number.isNull())return ErrorValueObject.create(error_type_ErrorType.NA);let placesValue=0;if(places){const{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(places);if(isError)return errorObject;const[placesObject]=variants;if(placesValue=Math.floor(+placesObject.getValue()),Number.isNaN(placesValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);if(placesValue<0||placesValue>10)return ErrorValueObject.create(error_type_ErrorType.NUM)}const{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(number);if(isError)return errorObject;const[numberObject]=variants,numberValue=Math.trunc(+numberObject.getValue());if(Number.isNaN(numberValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);if(!/^-?[0-9]{1,9}$/.test(`${numberValue}`)||numberValue<-536870912||numberValue>536870911)return ErrorValueObject.create(error_type_ErrorType.NUM);let result;if(numberValue<0)result=(1073741824+numberValue).toString(8);else if(result=Number.parseInt(`${numberValue}`,10).toString(8),places){if(placesValue<result.length)return ErrorValueObject.create(error_type_ErrorType.NUM);result="0".repeat(placesValue-result.length)+result}return StringValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=2}},FUNCTION_NAMES_ENGINEERING.DEC2OCT],[class Delta extends base_function_BaseFunction{calculate(number1,number2){const _number2=number2??NumberValueObject.create(0),{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(number1,_number2);if(isError)return errorObject;const[number1Object,number2Object]=variants,number1Value=+number1Object.getValue(),number2Value=+number2Object.getValue();if(Number.isNaN(number1Value)||Number.isNaN(number2Value))return ErrorValueObject.create(error_type_ErrorType.VALUE);const result=number1Value===number2Value?1:0;return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=2}},FUNCTION_NAMES_ENGINEERING.DELTA],[class Erf extends base_function_BaseFunction{calculate(lowerLimit,upperLimit){let result;if(upperLimit){const{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(lowerLimit,upperLimit);if(isError)return errorObject;const[lowerLimitObject,upperLimitObject]=variants,lowerLimitValue=+lowerLimitObject.getValue(),upperLimitValue=+upperLimitObject.getValue();if(Number.isNaN(lowerLimitValue)||Number.isNaN(upperLimitValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);result=erf(upperLimitValue)-erf(lowerLimitValue)}else{const{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(lowerLimit);if(isError)return errorObject;const[lowerLimitObject]=variants,lowerLimitValue=+lowerLimitObject.getValue();if(Number.isNaN(lowerLimitValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);result=erf(lowerLimitValue)}return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=2}},FUNCTION_NAMES_ENGINEERING.ERF],[class ErfPrecise extends base_function_BaseFunction{calculate(x){const{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(x);if(isError)return errorObject;const[xObject]=variants,xValue=+xObject.getValue();if(Number.isNaN(xValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);const result=erf(xValue);return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_ENGINEERING.ERF_PRECISE],[class Erfc extends base_function_BaseFunction{calculate(x){const{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(x);if(isError)return errorObject;const[xObject]=variants,xValue=+xObject.getValue();if(Number.isNaN(xValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);const result=erfc(xValue);return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_ENGINEERING.ERFC],[class ErfcPrecise extends base_function_BaseFunction{calculate(x){const{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(x);if(isError)return errorObject;const[xObject]=variants,xValue=+xObject.getValue();if(Number.isNaN(xValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);const result=erfc(xValue);return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_ENGINEERING.ERFC_PRECISE],[class Gestep extends base_function_BaseFunction{calculate(number,step){if(number.isNull())return ErrorValueObject.create(error_type_ErrorType.NA);const _step=step??NumberValueObject.create(0),{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(number,_step);if(isError)return errorObject;const[numberObject,stepObject]=variants,numberValue=+numberObject.getValue(),stepValue=+stepObject.getValue();if(Number.isNaN(numberValue)||Number.isNaN(stepValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);const result=numberValue>=stepValue?1:0;return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=2}},FUNCTION_NAMES_ENGINEERING.GESTEP],[class Hex2bin extends base_function_BaseFunction{calculate(number,places){if(number.isNull())return ErrorValueObject.create(error_type_ErrorType.NA);let placesValue=0;if(places){const{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(places);if(isError)return errorObject;const[placesObject]=variants;if(placesValue=Math.floor(+placesObject.getValue()),Number.isNaN(placesValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);if(placesValue<0||placesValue>10)return ErrorValueObject.create(error_type_ErrorType.NUM)}const{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(number);if(isError)return errorObject;const[numberObject]=variants,numberValue=`${numberObject.getValue()}`;if(!isValidHexadecimalNumber(numberValue))return ErrorValueObject.create(error_type_ErrorType.NUM);const negative=!(10!==numberValue.length||"F"!==numberValue.substring(0,1).toLocaleUpperCase()),decimal=negative?Number.parseInt(numberValue,16)-1099511627776:Number.parseInt(numberValue,16);if(decimal<-512||decimal>511)return ErrorValueObject.create(error_type_ErrorType.NUM);let result;if(negative){const toStr=(512+decimal).toString(2);result=`1${"0".repeat(9-toStr.length)}${toStr}`}else if(result=decimal.toString(2),places){if(placesValue<result.length)return ErrorValueObject.create(error_type_ErrorType.NUM);result="0".repeat(placesValue-result.length)+result}return StringValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=2}},FUNCTION_NAMES_ENGINEERING.HEX2BIN],[class Hex2dec extends base_function_BaseFunction{calculate(number){const{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(number);if(isError)return errorObject;const[numberObject]=variants,numberValue=`${numberObject.getValue()}`;if(!isValidHexadecimalNumber(numberValue))return ErrorValueObject.create(error_type_ErrorType.NUM);let result=Number.parseInt(numberValue,16);return result>=549755813888&&(result-=1099511627776),NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_ENGINEERING.HEX2DEC],[class Hex2oct extends base_function_BaseFunction{calculate(number,places){if(number.isNull())return ErrorValueObject.create(error_type_ErrorType.NA);let placesValue=0;if(places){const{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(places);if(isError)return errorObject;const[placesObject]=variants;if(placesValue=Math.floor(+placesObject.getValue()),Number.isNaN(placesValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);if(placesValue<0||placesValue>10)return ErrorValueObject.create(error_type_ErrorType.NUM)}const{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(number);if(isError)return errorObject;const[numberObject]=variants,numberValue=`${numberObject.getValue()}`;if(!isValidHexadecimalNumber(numberValue))return ErrorValueObject.create(error_type_ErrorType.NUM);const decimal=Number.parseInt(numberValue,16);if(decimal>536870911&&decimal<0xffe0000000)return ErrorValueObject.create(error_type_ErrorType.NUM);let result;if(decimal>=0xffe0000000)result=(decimal-0xffc0000000).toString(8);else if(result=decimal.toString(8),places){if(placesValue<result.length)return ErrorValueObject.create(error_type_ErrorType.NUM);result="0".repeat(placesValue-result.length)+result}return StringValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=2}},FUNCTION_NAMES_ENGINEERING.HEX2OCT],[class Imabs extends base_function_BaseFunction{calculate(inumber){const{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(inumber);if(isError)return errorObject;const[inumberObject]=variants,inumberValue=`${inumberObject.getValue()}`,complex=new complex_Complex(inumberValue);if(complex.isError())return ErrorValueObject.create(error_type_ErrorType.NUM);const result=complex.Abs();return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_ENGINEERING.IMABS],[class Imaginary extends base_function_BaseFunction{calculate(inumber){const{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(inumber);if(isError)return errorObject;const[inumberObject]=variants,inumberValue=`${inumberObject.getValue()}`,complex=new complex_Complex(inumberValue);if(complex.isError())return ErrorValueObject.create(error_type_ErrorType.NUM);const result=complex.getINum();return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_ENGINEERING.IMAGINARY],[class Imargument extends base_function_BaseFunction{calculate(inumber){const{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(inumber);if(isError)return errorObject;const[inumberObject]=variants,inumberValue=`${inumberObject.getValue()}`,complex=new complex_Complex(inumberValue);if(complex.isError())return ErrorValueObject.create(error_type_ErrorType.NUM);if(0===complex.getRealNum()&&0===complex.getINum())return ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO);const result=complex.Argument();return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_ENGINEERING.IMARGUMENT],[class Imconjugate extends base_function_BaseFunction{calculate(inumber){const{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(inumber);if(isError)return errorObject;const[inumberObject]=variants,inumberValue=`${inumberObject.getValue()}`,complex=new complex_Complex(inumberValue);if(complex.isError())return ErrorValueObject.create(error_type_ErrorType.NUM);const result=complex.Conjugate();return"number"==typeof result||(0,src.DMQ)(result)?NumberValueObject.create(+result):StringValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_ENGINEERING.IMCONJUGATE],[class Imcos extends base_function_BaseFunction{calculate(inumber){const{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(inumber);if(isError)return errorObject;const[inumberObject]=variants,inumberValue=`${inumberObject.getValue()}`,complex=new complex_Complex(inumberValue);if(complex.isError())return ErrorValueObject.create(error_type_ErrorType.NUM);const result=complex.Cos();return"number"==typeof result||(0,src.DMQ)(result)?NumberValueObject.create(+result):StringValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_ENGINEERING.IMCOS],[class Imcosh extends base_function_BaseFunction{calculate(inumber){const{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(inumber);if(isError)return errorObject;const[inumberObject]=variants,inumberValue=`${inumberObject.getValue()}`,complex=new complex_Complex(inumberValue);if(complex.isError())return ErrorValueObject.create(error_type_ErrorType.NUM);const result=complex.Cosh();return complex.isError()?ErrorValueObject.create(error_type_ErrorType.NUM):"number"==typeof result||(0,src.DMQ)(result)?NumberValueObject.create(+result):StringValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_ENGINEERING.IMCOSH],[class Imcot extends base_function_BaseFunction{calculate(inumber){const{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(inumber);if(isError)return errorObject;const[inumberObject]=variants,inumberValue=`${inumberObject.getValue()}`,complex=new complex_Complex(inumberValue);if(complex.isError())return ErrorValueObject.create(error_type_ErrorType.NUM);if(0===complex.getRealNum()&&0===complex.getINum())return ErrorValueObject.create(error_type_ErrorType.NUM);const result=complex.Cot();return"number"==typeof result||(0,src.DMQ)(result)?NumberValueObject.create(+result):StringValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_ENGINEERING.IMCOT],[class Imcoth extends base_function_BaseFunction{calculate(inumber){const{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(inumber);if(isError)return errorObject;const[inumberObject]=variants,inumberValue=`${inumberObject.getValue()}`,complex=new complex_Complex(inumberValue);if(complex.isError())return ErrorValueObject.create(error_type_ErrorType.NUM);if(0===complex.getRealNum()&&0===complex.getINum())return ErrorValueObject.create(error_type_ErrorType.NUM);const result=complex.Coth();return complex.isError()?ErrorValueObject.create(error_type_ErrorType.NUM):"number"==typeof result||(0,src.DMQ)(result)?NumberValueObject.create(+result):StringValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_ENGINEERING.IMCOTH],[class Imcsc extends base_function_BaseFunction{calculate(inumber){const{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(inumber);if(isError)return errorObject;const[inumberObject]=variants,inumberValue=`${inumberObject.getValue()}`,complex=new complex_Complex(inumberValue);if(complex.isError())return ErrorValueObject.create(error_type_ErrorType.NUM);if(0===complex.getRealNum()&&0===complex.getINum())return ErrorValueObject.create(error_type_ErrorType.NUM);const result=complex.Csc();return"number"==typeof result||(0,src.DMQ)(result)?NumberValueObject.create(+result):StringValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_ENGINEERING.IMCSC],[class Imcsch extends base_function_BaseFunction{calculate(inumber){const{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(inumber);if(isError)return errorObject;const[inumberObject]=variants,inumberValue=`${inumberObject.getValue()}`,complex=new complex_Complex(inumberValue);if(complex.isError())return ErrorValueObject.create(error_type_ErrorType.NUM);if(0===complex.getRealNum()&&0===complex.getINum())return ErrorValueObject.create(error_type_ErrorType.NUM);const result=complex.Csch();return"number"==typeof result||(0,src.DMQ)(result)?NumberValueObject.create(+result):StringValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_ENGINEERING.IMCSCH],[class Imdiv extends base_function_BaseFunction{calculate(inumber1,inumber2){if(inumber1.isNull()||inumber2.isNull())return ErrorValueObject.create(error_type_ErrorType.NA);const{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(inumber1,inumber2);if(isError)return errorObject;const[inumber1Object,inumber2Object]=variants,inumber1Value=`${inumber1Object.getValue()}`,inumber2Value=`${inumber2Object.getValue()}`,complex1=new complex_Complex(inumber1Value),complex2=new complex_Complex(inumber2Value);if(complex1.isError()||complex2.isError())return ErrorValueObject.create(error_type_ErrorType.NUM);if(complex1.isDifferentSuffixes(complex2))return ErrorValueObject.create(error_type_ErrorType.NUM);if(0===complex2.getRealNum()&&0===complex2.getINum())return ErrorValueObject.create(error_type_ErrorType.NUM);const result=complex1.Div(complex2);return"number"==typeof result||(0,src.DMQ)(result)?NumberValueObject.create(+result):StringValueObject.create(result)}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_ENGINEERING.IMDIV],[class Imexp extends base_function_BaseFunction{calculate(inumber){const{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(inumber);if(isError)return errorObject;const[inumberObject]=variants,inumberValue=`${inumberObject.getValue()}`,complex=new complex_Complex(inumberValue);if(complex.isError())return ErrorValueObject.create(error_type_ErrorType.NUM);const result=complex.Exp();return complex.isError()?ErrorValueObject.create(error_type_ErrorType.NUM):"number"==typeof result||(0,src.DMQ)(result)?NumberValueObject.create(+result):StringValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_ENGINEERING.IMEXP],[class Imln extends base_function_BaseFunction{calculate(inumber){const{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(inumber);if(isError)return errorObject;const[inumberObject]=variants,inumberValue=`${inumberObject.getValue()}`,complex=new complex_Complex(inumberValue);if(complex.isError())return ErrorValueObject.create(error_type_ErrorType.NUM);if(0===complex.getRealNum()&&0===complex.getINum())return ErrorValueObject.create(error_type_ErrorType.NUM);const result=complex.Ln();return"number"==typeof result||(0,src.DMQ)(result)?NumberValueObject.create(+result):StringValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_ENGINEERING.IMLN],[class Imlog extends base_function_BaseFunction{calculate(inumber,base){const{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(inumber);if(isError)return errorObject;const[inumberObject]=variants;let _base=base??NumberValueObject.create(10);if(_base.isArray()){const rowCount=_base.getRowCount(),columnCount=_base.getColumnCount();if(rowCount>1||columnCount>1)return ErrorValueObject.create(error_type_ErrorType.VALUE);_base=_base.get(0,0)}const{isError:_isError,errorObject:_errorObject,variants:_variants}=checkVariantsErrorIsStringToNumber(_base);if(_isError)return _errorObject;const[baseObject]=_variants,inumberValue=`${inumberObject.getValue()}`,baseValue=+baseObject.getValue(),complex=new complex_Complex(inumberValue);if(complex.isError())return ErrorValueObject.create(error_type_ErrorType.NUM);if(0===complex.getRealNum()&&0===complex.getINum())return ErrorValueObject.create(error_type_ErrorType.NUM);if(baseValue<=0)return ErrorValueObject.create(error_type_ErrorType.NUM);const result=complex.Log(baseValue);return complex.isError()?ErrorValueObject.create(error_type_ErrorType.NUM):"number"==typeof result||(0,src.DMQ)(result)?NumberValueObject.create(+result):StringValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=2}},FUNCTION_NAMES_ENGINEERING.IMLOG],[class Imlog10 extends base_function_BaseFunction{calculate(inumber){const{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(inumber);if(isError)return errorObject;const[inumberObject]=variants,inumberValue=`${inumberObject.getValue()}`,complex=new complex_Complex(inumberValue);if(complex.isError())return ErrorValueObject.create(error_type_ErrorType.NUM);if(0===complex.getRealNum()&&0===complex.getINum())return ErrorValueObject.create(error_type_ErrorType.NUM);const result=complex.Log(10);return"number"==typeof result||(0,src.DMQ)(result)?NumberValueObject.create(+result):StringValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_ENGINEERING.IMLOG10],[class Imlog2 extends base_function_BaseFunction{calculate(inumber){const{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(inumber);if(isError)return errorObject;const[inumberObject]=variants,inumberValue=`${inumberObject.getValue()}`,complex=new complex_Complex(inumberValue);if(complex.isError())return ErrorValueObject.create(error_type_ErrorType.NUM);if(0===complex.getRealNum()&&0===complex.getINum())return ErrorValueObject.create(error_type_ErrorType.NUM);const result=complex.Log(2);return"number"==typeof result||(0,src.DMQ)(result)?NumberValueObject.create(+result):StringValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_ENGINEERING.IMLOG2],[class Impower extends base_function_BaseFunction{calculate(inumber,number){if(inumber.isNull()||number.isNull())return ErrorValueObject.create(error_type_ErrorType.NA);const{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(inumber,number);if(isError)return errorObject;const[inumberObject,numberObject]=variants,inumberValue=`${inumberObject.getValue()}`,complex=new complex_Complex(inumberValue);if(complex.isError())return ErrorValueObject.create(error_type_ErrorType.NUM);const numberValue=+numberObject.getValue();if(Number.isNaN(numberValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);const result=complex.Power(numberValue);return complex.isError()?ErrorValueObject.create(error_type_ErrorType.NUM):"number"==typeof result||(0,src.DMQ)(result)?NumberValueObject.create(+result):StringValueObject.create(result)}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_ENGINEERING.IMPOWER],[class Improduct extends base_function_BaseFunction{calculate(...variants){let result="";for(let i=0;i<variants.length;i++){if(result instanceof ErrorValueObject)return result;const variant=variants[i];if(variant.isArray()){let errorObject,isError=!1;if(variant.iterator((valueObject=>{if(result=this._handleSingleObject(valueObject,result),result instanceof ErrorValueObject)return isError=!0,errorObject=result,!1})),isError)return errorObject}else result=this._handleSingleObject(variant,result)}return result instanceof ErrorValueObject?result:"number"==typeof result||(0,src.DMQ)(result)?NumberValueObject.create(+result):StringValueObject.create(result)}_handleSingleObject(variant,result){let _result=result;if(variant.isError())return variant;if(variant.isBoolean())return ErrorValueObject.create(error_type_ErrorType.VALUE);const value=`${variant.getValue()}`;if("number"==typeof result||result){const complex1=new complex_Complex(result),complex2=new complex_Complex(value);if(complex1.isError()||complex2.isError())return ErrorValueObject.create(error_type_ErrorType.NUM);if(complex1.isDifferentSuffixes(complex2))return ErrorValueObject.create(error_type_ErrorType.VALUE);_result=complex1.Product(complex2)}else{const complex=new complex_Complex(value);if(complex.isError())return ErrorValueObject.create(error_type_ErrorType.NUM);_result=complex.toString()}return _result}constructor(...args){super(...args),this.minParams=1,this.maxParams=255}},FUNCTION_NAMES_ENGINEERING.IMPRODUCT],[class Imreal extends base_function_BaseFunction{calculate(inumber){const{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(inumber);if(isError)return errorObject;const[inumberObject]=variants,inumberValue=`${inumberObject.getValue()}`,complex=new complex_Complex(inumberValue);if(complex.isError())return ErrorValueObject.create(error_type_ErrorType.NUM);const result=complex.getRealNum();return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_ENGINEERING.IMREAL],[class Imsec extends base_function_BaseFunction{calculate(inumber){const{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(inumber);if(isError)return errorObject;const[inumberObject]=variants,inumberValue=`${inumberObject.getValue()}`,complex=new complex_Complex(inumberValue);if(complex.isError())return ErrorValueObject.create(error_type_ErrorType.NUM);const result=complex.Sec();return"number"==typeof result||(0,src.DMQ)(result)?NumberValueObject.create(+result):StringValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_ENGINEERING.IMSEC],[class Imsech extends base_function_BaseFunction{calculate(inumber){const{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(inumber);if(isError)return errorObject;const[inumberObject]=variants,inumberValue=`${inumberObject.getValue()}`,complex=new complex_Complex(inumberValue);if(complex.isError())return ErrorValueObject.create(error_type_ErrorType.NUM);const result=complex.Sech();return"number"==typeof result||(0,src.DMQ)(result)?NumberValueObject.create(+result):StringValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_ENGINEERING.IMSECH],[class Imsin extends base_function_BaseFunction{calculate(inumber){const{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(inumber);if(isError)return errorObject;const[inumberObject]=variants,inumberValue=`${inumberObject.getValue()}`,complex=new complex_Complex(inumberValue);if(complex.isError())return ErrorValueObject.create(error_type_ErrorType.NUM);const result=complex.Sin();return"number"==typeof result||(0,src.DMQ)(result)?NumberValueObject.create(+result):StringValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_ENGINEERING.IMSIN],[class Imsinh extends base_function_BaseFunction{calculate(inumber){const{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(inumber);if(isError)return errorObject;const[inumberObject]=variants,inumberValue=`${inumberObject.getValue()}`,complex=new complex_Complex(inumberValue);if(complex.isError())return ErrorValueObject.create(error_type_ErrorType.NUM);const result=complex.Sinh();return complex.isError()?ErrorValueObject.create(error_type_ErrorType.NUM):"number"==typeof result||(0,src.DMQ)(result)?NumberValueObject.create(+result):StringValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_ENGINEERING.IMSINH],[class Imsqrt extends base_function_BaseFunction{calculate(inumber){const{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(inumber);if(isError)return errorObject;const[inumberObject]=variants,inumberValue=`${inumberObject.getValue()}`,complex=new complex_Complex(inumberValue);if(complex.isError())return ErrorValueObject.create(error_type_ErrorType.NUM);if(0===complex.getRealNum()&&0===complex.getINum())return NumberValueObject.create(0);const result=complex.Sqrt();return"number"==typeof result||(0,src.DMQ)(result)?NumberValueObject.create(+result):StringValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_ENGINEERING.IMSQRT],[class Imsub extends base_function_BaseFunction{calculate(inumber1,inumber2){if(inumber1.isNull()||inumber2.isNull())return ErrorValueObject.create(error_type_ErrorType.NA);const{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(inumber1,inumber2);if(isError)return errorObject;const[inumber1Object,inumber2Object]=variants,inumber1Value=`${inumber1Object.getValue()}`,inumber2Value=`${inumber2Object.getValue()}`,complex1=new complex_Complex(inumber1Value),complex2=new complex_Complex(inumber2Value);if(complex1.isError()||complex2.isError())return ErrorValueObject.create(error_type_ErrorType.NUM);if(complex1.isDifferentSuffixes(complex2))return ErrorValueObject.create(error_type_ErrorType.NUM);const result=complex1.Sub(complex2);return"number"==typeof result||(0,src.DMQ)(result)?NumberValueObject.create(+result):StringValueObject.create(result)}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_ENGINEERING.IMSUB],[class Imsum extends base_function_BaseFunction{calculate(...variants){let result="";for(let i=0;i<variants.length;i++){if(result instanceof ErrorValueObject)return result;const variant=variants[i];if(variant.isArray()){let errorObject,isError=!1;if(variant.iterator((valueObject=>{if(result=this._handleSingleObject(valueObject,result),result instanceof ErrorValueObject)return isError=!0,errorObject=result,!1})),isError)return errorObject}else result=this._handleSingleObject(variant,result)}return result instanceof ErrorValueObject?result:"number"==typeof result||(0,src.DMQ)(result)?NumberValueObject.create(+result):StringValueObject.create(result)}_handleSingleObject(variant,result){let _result=result;if(variant.isError())return variant;if(variant.isBoolean())return ErrorValueObject.create(error_type_ErrorType.VALUE);const value=`${variant.getValue()}`;if("number"==typeof result||result){const complex1=new complex_Complex(result),complex2=new complex_Complex(value);if(complex1.isError()||complex2.isError())return ErrorValueObject.create(error_type_ErrorType.NUM);if(complex1.isDifferentSuffixes(complex2))return ErrorValueObject.create(error_type_ErrorType.VALUE);_result=complex1.Sum(complex2)}else{const complex=new complex_Complex(value);if(complex.isError())return ErrorValueObject.create(error_type_ErrorType.NUM);_result=complex.toString()}return _result}constructor(...args){super(...args),this.minParams=1,this.maxParams=255}},FUNCTION_NAMES_ENGINEERING.IMSUM],[class Imtan extends base_function_BaseFunction{calculate(inumber){const{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(inumber);if(isError)return errorObject;const[inumberObject]=variants,inumberValue=`${inumberObject.getValue()}`,complex=new complex_Complex(inumberValue);if(complex.isError())return ErrorValueObject.create(error_type_ErrorType.NUM);const result=complex.Tan();return"number"==typeof result||(0,src.DMQ)(result)?NumberValueObject.create(+result):StringValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_ENGINEERING.IMTAN],[class Imtanh extends base_function_BaseFunction{calculate(inumber){const{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(inumber);if(isError)return errorObject;const[inumberObject]=variants,inumberValue=`${inumberObject.getValue()}`,complex=new complex_Complex(inumberValue);if(complex.isError())return ErrorValueObject.create(error_type_ErrorType.NUM);const result=complex.Tanh();return complex.isError()?ErrorValueObject.create(error_type_ErrorType.NUM):"number"==typeof result||(0,src.DMQ)(result)?NumberValueObject.create(+result):StringValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_ENGINEERING.IMTANH],[class Oct2bin extends base_function_BaseFunction{calculate(number,places){if(number.isNull())return ErrorValueObject.create(error_type_ErrorType.NA);let placesValue=0;if(places){const{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(places);if(isError)return errorObject;const[placesObject]=variants;if(placesValue=Math.floor(+placesObject.getValue()),Number.isNaN(placesValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);if(placesValue<0||placesValue>10)return ErrorValueObject.create(error_type_ErrorType.NUM)}const{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(number);if(isError)return errorObject;const[numberObject]=variants,numberValue=`${numberObject.getValue()}`;if(!isValidOctalNumber(numberValue))return ErrorValueObject.create(error_type_ErrorType.NUM);const negative=!(10!==numberValue.length||"7"!==numberValue.substring(0,1)),decimal=negative?Number.parseInt(numberValue,8)-1073741824:Number.parseInt(numberValue,8);if(decimal<-512||decimal>511)return ErrorValueObject.create(error_type_ErrorType.NUM);let result;if(negative){const toStr=(512+decimal).toString(2);result=`1${"0".repeat(9-toStr.length)}${toStr}`}else if(result=decimal.toString(2),places){if(placesValue<result.length)return ErrorValueObject.create(error_type_ErrorType.NUM);result="0".repeat(placesValue-result.length)+result}return StringValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=2}},FUNCTION_NAMES_ENGINEERING.OCT2BIN],[class Oct2dec extends base_function_BaseFunction{calculate(number){const{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(number);if(isError)return errorObject;const[numberObject]=variants,numberValue=`${numberObject.getValue()}`;if(!isValidOctalNumber(numberValue))return ErrorValueObject.create(error_type_ErrorType.NUM);let result=Number.parseInt(numberValue,8);return result>=536870912&&(result-=1073741824),NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_ENGINEERING.OCT2DEC],[class Oct2hex extends base_function_BaseFunction{calculate(number,places){if(number.isNull())return ErrorValueObject.create(error_type_ErrorType.NA);let placesValue=0;if(places){const{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(places);if(isError)return errorObject;const[placesObject]=variants;if(placesValue=Math.floor(+placesObject.getValue()),Number.isNaN(placesValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);if(placesValue<0||placesValue>10)return ErrorValueObject.create(error_type_ErrorType.NUM)}const{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(number);if(isError)return errorObject;const[numberObject]=variants,numberValue=`${numberObject.getValue()}`;if(!isValidOctalNumber(numberValue))return ErrorValueObject.create(error_type_ErrorType.NUM);const decimal=Number.parseInt(numberValue,8);let result;if(decimal>=536870912)result=`ff${(decimal+3221225472).toString(16)}`;else if(result=decimal.toString(16),places){if(placesValue<result.length)return ErrorValueObject.create(error_type_ErrorType.NUM);result="0".repeat(placesValue-result.length)+result}return StringValueObject.create(result.toLocaleUpperCase())}constructor(...args){super(...args),this.minParams=1,this.maxParams=2}},FUNCTION_NAMES_ENGINEERING.OCT2HEX]];var FUNCTION_NAMES_FINANCIAL=function(FUNCTION_NAMES_FINANCIAL){return FUNCTION_NAMES_FINANCIAL.ACCRINT="ACCRINT",FUNCTION_NAMES_FINANCIAL.ACCRINTM="ACCRINTM",FUNCTION_NAMES_FINANCIAL.AMORDEGRC="AMORDEGRC",FUNCTION_NAMES_FINANCIAL.AMORLINC="AMORLINC",FUNCTION_NAMES_FINANCIAL.COUPDAYBS="COUPDAYBS",FUNCTION_NAMES_FINANCIAL.COUPDAYS="COUPDAYS",FUNCTION_NAMES_FINANCIAL.COUPDAYSNC="COUPDAYSNC",FUNCTION_NAMES_FINANCIAL.COUPNCD="COUPNCD",FUNCTION_NAMES_FINANCIAL.COUPNUM="COUPNUM",FUNCTION_NAMES_FINANCIAL.COUPPCD="COUPPCD",FUNCTION_NAMES_FINANCIAL.CUMIPMT="CUMIPMT",FUNCTION_NAMES_FINANCIAL.CUMPRINC="CUMPRINC",FUNCTION_NAMES_FINANCIAL.DB="DB",FUNCTION_NAMES_FINANCIAL.DDB="DDB",FUNCTION_NAMES_FINANCIAL.DISC="DISC",FUNCTION_NAMES_FINANCIAL.DOLLARDE="DOLLARDE",FUNCTION_NAMES_FINANCIAL.DOLLARFR="DOLLARFR",FUNCTION_NAMES_FINANCIAL.DURATION="DURATION",FUNCTION_NAMES_FINANCIAL.EFFECT="EFFECT",FUNCTION_NAMES_FINANCIAL.FV="FV",FUNCTION_NAMES_FINANCIAL.FVSCHEDULE="FVSCHEDULE",FUNCTION_NAMES_FINANCIAL.INTRATE="INTRATE",FUNCTION_NAMES_FINANCIAL.IPMT="IPMT",FUNCTION_NAMES_FINANCIAL.IRR="IRR",FUNCTION_NAMES_FINANCIAL.ISPMT="ISPMT",FUNCTION_NAMES_FINANCIAL.MDURATION="MDURATION",FUNCTION_NAMES_FINANCIAL.MIRR="MIRR",FUNCTION_NAMES_FINANCIAL.NOMINAL="NOMINAL",FUNCTION_NAMES_FINANCIAL.NPER="NPER",FUNCTION_NAMES_FINANCIAL.NPV="NPV",FUNCTION_NAMES_FINANCIAL.ODDFPRICE="ODDFPRICE",FUNCTION_NAMES_FINANCIAL.ODDFYIELD="ODDFYIELD",FUNCTION_NAMES_FINANCIAL.ODDLPRICE="ODDLPRICE",FUNCTION_NAMES_FINANCIAL.ODDLYIELD="ODDLYIELD",FUNCTION_NAMES_FINANCIAL.PDURATION="PDURATION",FUNCTION_NAMES_FINANCIAL.PMT="PMT",FUNCTION_NAMES_FINANCIAL.PPMT="PPMT",FUNCTION_NAMES_FINANCIAL.PRICE="PRICE",FUNCTION_NAMES_FINANCIAL.PRICEDISC="PRICEDISC",FUNCTION_NAMES_FINANCIAL.PRICEMAT="PRICEMAT",FUNCTION_NAMES_FINANCIAL.PV="PV",FUNCTION_NAMES_FINANCIAL.RATE="RATE",FUNCTION_NAMES_FINANCIAL.RECEIVED="RECEIVED",FUNCTION_NAMES_FINANCIAL.RRI="RRI",FUNCTION_NAMES_FINANCIAL.SLN="SLN",FUNCTION_NAMES_FINANCIAL.SYD="SYD",FUNCTION_NAMES_FINANCIAL.TBILLEQ="TBILLEQ",FUNCTION_NAMES_FINANCIAL.TBILLPRICE="TBILLPRICE",FUNCTION_NAMES_FINANCIAL.TBILLYIELD="TBILLYIELD",FUNCTION_NAMES_FINANCIAL.VDB="VDB",FUNCTION_NAMES_FINANCIAL.XIRR="XIRR",FUNCTION_NAMES_FINANCIAL.XNPV="XNPV",FUNCTION_NAMES_FINANCIAL.YIELD="YIELD",FUNCTION_NAMES_FINANCIAL.YIELDDISC="YIELDDISC",FUNCTION_NAMES_FINANCIAL.YIELDMAT="YIELDMAT",FUNCTION_NAMES_FINANCIAL}({});function calculateCoupdaybs(settlementSerialNumber,maturitySerialNumber,frequency,basis){const coupDateSerialNumber=calculateCouppcd(settlementSerialNumber,maturitySerialNumber,frequency),{days}=getTwoDateDaysByBasis(coupDateSerialNumber,settlementSerialNumber,basis);return days}function calculateCoupdays(settlementSerialNumber,maturitySerialNumber,frequency,basis){let result;if(1===basis){const beforeSettlementDateSerialNumber=calculateCouppcd(settlementSerialNumber,maturitySerialNumber,frequency);let coupDate=excelSerialToDate(beforeSettlementDateSerialNumber);coupDate=dateAddMonths(coupDate,12/frequency);const afterSettlementDateSerialNumber=excelDateSerial(coupDate);result=beforeSettlementDateSerialNumber<0&&1===frequency?365:afterSettlementDateSerialNumber-beforeSettlementDateSerialNumber}else result=3===basis?365/frequency:360/frequency;return result}function calculateCoupncd(settlementSerialNumber,maturitySerialNumber,frequency){const settlementDate=excelSerialToDate(settlementSerialNumber);let coupDate=excelSerialToDate(maturitySerialNumber);for(coupDate.setUTCFullYear(settlementDate.getUTCFullYear()),coupDate<settlementDate&&coupDate.setUTCFullYear(coupDate.getUTCFullYear()+1);coupDate>settlementDate;)coupDate=dateAddMonths(coupDate,-12/frequency);coupDate=dateAddMonths(coupDate,12/frequency);return excelDateSerial(coupDate)}function calculateCoupnum(settlementSerialNumber,maturitySerialNumber,frequency){let result=0;const settlementDate=excelSerialToDate(settlementSerialNumber);let coupDate=excelSerialToDate(maturitySerialNumber);for(;coupDate>settlementDate;)coupDate=dateAddMonths(coupDate,-12/frequency),result++;return result}function calculateCouppcd(settlementSerialNumber,maturitySerialNumber,frequency){const settlementDate=excelSerialToDate(settlementSerialNumber);let coupDate=excelSerialToDate(maturitySerialNumber);for(coupDate.setUTCFullYear(settlementDate.getUTCFullYear()),coupDate<settlementDate&&coupDate.setUTCFullYear(coupDate.getUTCFullYear()+1);coupDate>settlementDate;)coupDate=dateAddMonths(coupDate,-12/frequency);return excelDateSerial(coupDate)}function calculateDuration(settlementSerialNumber,maturitySerialNumber,coupon,yld,frequency,basis){const coupdaybs=calculateCoupdaybs(settlementSerialNumber,maturitySerialNumber,frequency,basis),coupdays=calculateCoupdays(settlementSerialNumber,maturitySerialNumber,frequency,basis),coupnum=calculateCoupnum(settlementSerialNumber,maturitySerialNumber,frequency),coupdaysDiff=(coupdays-coupdaybs)/coupdays-1,_yld=yld/frequency+1,_coupon=100*coupon/frequency;let duration=0,den=0;for(let i=1;i<=coupnum;i++){const index=i+coupdaysDiff,num=_coupon/_yld**index;duration+=index*num,den+=num}const index=coupnum+coupdaysDiff,num=100/_yld**index;return duration+=index*num,den+=num,duration/den/frequency}function calculatePMT(rate,nper,pv,fv,type){let result;if(0===rate)result=(pv+fv)/nper;else{const term=(1+rate)**nper;result=1===type?(fv*rate/(term-1)+pv*rate/(1-1/term))/(1+rate):fv*rate/(term-1)+pv*rate/(1-1/term)}return-result}function calculateFV(rate,nper,pmt,pv,type){let result;if(0===rate)result=pv+pmt*nper;else{if(-1===rate&&0===nper)return Number.NaN;const term=(1+rate)**nper;result=1===type?pv*term+pmt*(1+rate)*(term-1)/rate:pv*term+pmt*(term-1)/rate}return-result}function calculateIPMT(rate,per,nper,pv,fv,type){const payment=calculatePMT(rate,nper,pv,fv,type);return(1===per?1===type?0:-pv:1===type?calculateFV(rate,per-2,payment,pv,1)-payment:calculateFV(rate,per-1,payment,pv,0))*rate}function calculateNpv(rate,values){let res=0;for(let i=1;i<=values.length;i++)res+=values[i-1]/(1+rate)**i;return res}function calculateOddFPrice(settlementSerialNumber,maturitySerialNumber,issueSerialNumber,firstCouponSerialNumber,rate,yld,redemption,frequency,basis){const DFC=getPositiveDaysBetween(issueSerialNumber,firstCouponSerialNumber,basis),E=calculateCoupdays(settlementSerialNumber,firstCouponSerialNumber,frequency,basis);return DFC<E?function calculateOddShortFirstCoupon(settlementSerialNumber,maturitySerialNumber,issueSerialNumber,firstCouponSerialNumber,rate,yld,redemption,frequency,basis,DFC,E){let result=0;const N=calculateCoupnum(settlementSerialNumber,maturitySerialNumber,frequency),DSC=getPositiveDaysBetween(settlementSerialNumber,firstCouponSerialNumber,basis);result+=redemption/(1+yld/frequency)**(N-1+DSC/E),result+=100*rate/frequency*DFC/E/(1+yld/frequency)**(DSC/E);for(let k=2;k<=N;k++)result+=100*rate/frequency/(1+yld/frequency)**(k-1+DSC/E);const A=getPositiveDaysBetween(issueSerialNumber,settlementSerialNumber,basis);return result-=100*rate/frequency*A/E,result}(settlementSerialNumber,maturitySerialNumber,issueSerialNumber,firstCouponSerialNumber,rate,yld,redemption,frequency,basis,DFC,E):function calculateOddLongFirstCoupon(settlementSerialNumber,maturitySerialNumber,issueSerialNumber,firstCouponSerialNumber,rate,yld,redemption,frequency,basis,E){let result=0;const N=calculateCoupnum(firstCouponSerialNumber,maturitySerialNumber,frequency),Nq=function getCouponsNumber(startDateSerialNumber,endDateSerialNumber,months,isWholeNumber){const startDate=excelSerialToDate(startDateSerialNumber),endDate=excelSerialToDate(endDateSerialNumber),startDateYear=startDate.getUTCFullYear(),startDateMonth=startDate.getUTCMonth(),startDateDay=startDate.getUTCDate(),endDateYear=endDate.getUTCFullYear(),endDateMonth=endDate.getUTCMonth(),endDateDay=endDate.getUTCDate(),endOfMonthTemp=lastDayOfMonth(startDateYear,startDateMonth,startDateDay),endOfMonth=!endOfMonthTemp&&1!==startDateMonth&&startDateDay>28&&startDateDay<getDaysInMonth(startDateYear,startDateMonth)?lastDayOfMonth(endDateYear,endDateMonth,endDateDay):endOfMonthTemp,newDateSerialNumber=getDateSerialNumberByMonths(endDateSerialNumber,0,endOfMonth);let coupons=+isWholeNumber-0+ +(endDateSerialNumber<newDateSerialNumber),frontDateSerialNumber=getDateSerialNumberByMonths(newDateSerialNumber,months,endOfMonth);for(;!(months>0?frontDateSerialNumber>=endDateSerialNumber:frontDateSerialNumber<=endDateSerialNumber);)frontDateSerialNumber=getDateSerialNumberByMonths(frontDateSerialNumber,months,endOfMonth),coupons++;return coupons}(firstCouponSerialNumber,settlementSerialNumber,12/frequency,!0);let DSC;if(2===basis||3===basis){DSC=getPositiveDaysBetween(settlementSerialNumber,calculateCoupncd(settlementSerialNumber,firstCouponSerialNumber,frequency),basis)}else{const couppcd=calculateCouppcd(settlementSerialNumber,firstCouponSerialNumber,frequency),{days}=getTwoDateDaysByBasis(couppcd,settlementSerialNumber,basis);DSC=E-days}result+=redemption/(1+yld/frequency)**(N+Nq+DSC/E);const NC=calculateCoupnum(issueSerialNumber,firstCouponSerialNumber,frequency);let lateCoupon=firstCouponSerialNumber,DCiDivNLiSum=0,AiDivNLiSum=0;for(let index=NC;index>=1;index--){const earlyCoupon=getDateSerialNumberByMonths(lateCoupon,-12/frequency,!1),NLi=1===basis?getPositiveDaysBetween(earlyCoupon,lateCoupon,basis):E;DCiDivNLiSum+=(index>1?NLi:getPositiveDaysBetween(issueSerialNumber,lateCoupon,basis))/NLi;AiDivNLiSum+=getPositiveDaysBetween(issueSerialNumber>earlyCoupon?issueSerialNumber:earlyCoupon,settlementSerialNumber<lateCoupon?settlementSerialNumber:lateCoupon,basis)/NLi,lateCoupon=earlyCoupon}result+=100*rate/frequency*DCiDivNLiSum/(1+yld/frequency)**(Nq+DSC/E);for(let k=1;k<=N;k++)result+=100*rate/frequency/(1+yld/frequency)**(k+Nq+DSC/E);return result-=100*rate/frequency*AiDivNLiSum,result}(settlementSerialNumber,maturitySerialNumber,issueSerialNumber,firstCouponSerialNumber,rate,yld,redemption,frequency,basis,E)}function getPositiveDaysBetween(startDateSerialNumber,endDateSerialNumber,basis){const{days}=getTwoDateDaysByBasis(startDateSerialNumber,endDateSerialNumber,basis);return startDateSerialNumber<endDateSerialNumber?days:0}function validDaysBetweenIsWholeFrequencyByTwoDate(date1SerialNumber,date2SerialNumber,frequency){const date1=excelSerialToDate(date1SerialNumber),date1Year=date1.getUTCFullYear(),date1Month=date1.getUTCMonth(),date1Day=date1.getUTCDate(),date1LastDayOfMonth=lastDayOfMonth(date1Year,date1Month,date1Day),date2=excelSerialToDate(date2SerialNumber),date2Year=date2.getUTCFullYear(),date2Month=date2.getUTCMonth(),date2Day=date2.getUTCDate(),date2LastDayOfMonth=lastDayOfMonth(date2Year,date2Month,date2Day);if(!(date1Day===date2Day||date1LastDayOfMonth&&date2LastDayOfMonth))return!1;return Math.abs(12*(date2Year-date1Year)+(date2Month-date1Month))%(12/frequency)==0}function validCouppcdIsGte0ByTwoDate(date1SerialNumber,date2SerialNumber,frequency){return calculateCouppcd(date1SerialNumber,date2SerialNumber,frequency)>=0}function getDateSerialNumberByMonths(serialNumber,months,returnLastDay){let date=excelSerialToDate(serialNumber);if(date=dateAddMonths(date,months),returnLastDay){const daysInMonth=getDaysInMonth(date.getUTCFullYear(),date.getUTCMonth());date.setUTCDate(daysInMonth)}return excelDateSerial(date)}function getResultByGuessIterF(guess,iterF){let xN,eps=1,nMC=0,x=guess;for(;eps>1e-7&&nMC<500;){const den=(iterF(x+1e-7)-iterF(x-1e-7))/2e-7;xN=x-iterF(x)/den,nMC++,eps=Math.abs(xN-x),x=xN}return Number.isNaN(x)||1/0===Math.abs(x)||500===nMC?function guessIsNaNorInfinity(guess,iterF){const g_Eps=1e-7,nIM=60,max=Number.MAX_VALUE,min=-1,step=1.6;let xBegin,xEnd,low=guess-.01<=min?min+g_Eps:guess-.01,high=guess+.01>=max?max-g_Eps:guess+.01,currentIter=0;if(guess<=min||guess>=max)return ErrorValueObject.create(error_type_ErrorType.NUM);for(let i=0;i<nIM;i++){xBegin=low<=min?min+g_Eps:low,xEnd=high>=max?max-g_Eps:high;const x=iterF(xBegin),y=iterF(xEnd);if(x*y<=0)break;if(!(x*y>0))return ErrorValueObject.create(error_type_ErrorType.NUM);if(low=xBegin+step*(xBegin-xEnd),high=xEnd+step*(xEnd-xBegin),i===nIM-1)return ErrorValueObject.create(error_type_ErrorType.NUM)}let fXbegin=iterF(xBegin);const fXend=iterF(xEnd);let fXi,xI;if(Math.abs(fXbegin)<g_Eps)return ErrorValueObject.create(error_type_ErrorType.NUM);if(Math.abs(fXend)<g_Eps)return ErrorValueObject.create(error_type_ErrorType.NUM);do{xI=xBegin+(xEnd-xBegin)/2,fXi=iterF(xI),fXbegin*fXi<0?xEnd=xI:xBegin=xI,fXbegin=iterF(xBegin),currentIter++}while(Math.abs(fXi)>g_Eps&&currentIter<nIM);return xI}(guess,iterF):x}function calculatePrice(settlementSerialNumber,maturitySerialNumber,rate,yld,redemption,frequency,basis){const N=calculateCoupnum(settlementSerialNumber,maturitySerialNumber,frequency),E=calculateCoupdays(settlementSerialNumber,maturitySerialNumber,frequency,basis),A=calculateCoupdaybs(settlementSerialNumber,maturitySerialNumber,frequency,basis);if(1===N){return(100*rate/frequency+redemption)/(yld/frequency*(E-A)/E+1)-100*rate/frequency*A/E}const DSC=E-A;let result=redemption/(1+yld/frequency)**(N-1+DSC/E);for(let k=1;k<=N;k++)result+=100*rate/frequency/(1+yld/frequency)**(k-1+DSC/E);return result-=100*rate/frequency*A/E,result}function calculateDDB(cost,salvage,life,period,factor){let oldCost=0,fdl=factor/life;fdl>=1?(fdl=1,oldCost=1===period?cost:0):oldCost=cost*(1-fdl)**(period-1);const newCost=cost*(1-fdl)**period;let result=0;return result=newCost<salvage?oldCost-salvage:oldCost-newCost,result<0&&(result=0),result}const functionFinancial=[[class Accrint extends base_function_BaseFunction{calculate(issue,firstInterest,settlement,rate,par,frequency,basis,calcMethod){const _basis=basis??NumberValueObject.create(0),_calcMethod=calcMethod??BooleanValueObject.create(!0),{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(issue,firstInterest,settlement,rate,par,frequency,_basis);if(isError)return errorObject;const[issueObject,firstInterestObject,settlementObject,rateObject,parObject,frequencyObject,basisObject]=variants,issueSerialNumber=getDateSerialNumberByObject(issueObject);if("number"!=typeof issueSerialNumber)return issueSerialNumber;const firstInterestSerialNumber=getDateSerialNumberByObject(firstInterestObject);if("number"!=typeof firstInterestSerialNumber)return firstInterestSerialNumber;const settlementSerialNumber=getDateSerialNumberByObject(settlementObject);if("number"!=typeof settlementSerialNumber)return settlementSerialNumber;const rateValue=+rateObject.getValue(),parValue=+parObject.getValue(),frequencyValue=Math.floor(+frequencyObject.getValue()),basisValue=Math.floor(+basisObject.getValue()),calcMethodValue=+_calcMethod.getValue();return Number.isNaN(rateValue)||Number.isNaN(parValue)||Number.isNaN(frequencyValue)||Number.isNaN(basisValue)||Number.isNaN(calcMethodValue)?ErrorValueObject.create(error_type_ErrorType.VALUE):rateValue<=0||parValue<=0||![1,2,4].includes(frequencyValue)||basisValue<0||basisValue>4||Math.floor(issueSerialNumber)>=Math.floor(settlementSerialNumber)?ErrorValueObject.create(error_type_ErrorType.NUM):this._getResult(issueSerialNumber,firstInterestSerialNumber,settlementSerialNumber,rateValue,parValue,frequencyValue,basisValue,calcMethodValue)}_getResult(issueSerialNumber,firstInterestSerialNumber,settlementSerialNumber,rateValue,parValue,frequencyValue,basisValue,calcMethodValue){let couppcd=calculateCouppcd(issueSerialNumber,firstInterestSerialNumber,frequencyValue);if(couppcd<=0)return NumberValueObject.create(0);couppcd=calculateCouppcd(settlementSerialNumber,firstInterestSerialNumber,frequencyValue);const numMonths=12/frequencyValue,firstInterestDate=excelSerialToDate(firstInterestSerialNumber),lastDayOfMonthF=lastDayOfMonth(firstInterestDate.getUTCFullYear(),firstInterestDate.getUTCMonth(),firstInterestDate.getUTCDate());let coupDateSerialNumber=getDateSerialNumberByMonths(firstInterestSerialNumber,-numMonths,lastDayOfMonthF);if(settlementSerialNumber>firstInterestSerialNumber&&calcMethodValue)for(coupDateSerialNumber=firstInterestSerialNumber;coupDateSerialNumber<settlementSerialNumber;)coupDateSerialNumber=getDateSerialNumberByMonths(coupDateSerialNumber,numMonths,lastDayOfMonthF);let firstDateSerialNumber=issueSerialNumber>coupDateSerialNumber?issueSerialNumber:coupDateSerialNumber,{days}=getTwoDateDaysByBasis(firstDateSerialNumber,settlementSerialNumber,basisValue);if(couppcd>=issueSerialNumber){const{days:DFS}=getTwoDateDaysByBasis(firstDateSerialNumber,settlementSerialNumber,basisValue?4:0);days=DFS}settlementSerialNumber<firstDateSerialNumber&&(days=-days);let coupdays=calculateCoupdays(coupDateSerialNumber,firstInterestSerialNumber,frequencyValue,basisValue),accruedDaysSum=days/coupdays,startDateSerialNumber=coupDateSerialNumber,endDateSerialNumber=issueSerialNumber;for(;startDateSerialNumber>issueSerialNumber;){endDateSerialNumber=startDateSerialNumber,startDateSerialNumber=getDateSerialNumberByMonths(startDateSerialNumber,-numMonths,lastDayOfMonthF),firstDateSerialNumber=issueSerialNumber>startDateSerialNumber?issueSerialNumber:startDateSerialNumber;const{days:DFE}=getTwoDateDaysByBasis(firstDateSerialNumber,endDateSerialNumber,basisValue);if(0===basisValue)days=endDateSerialNumber>=firstDateSerialNumber||issueSerialNumber<=startDateSerialNumber?DFE:-DFE,coupdays=calculateCoupdays(startDateSerialNumber,endDateSerialNumber,frequencyValue,basisValue);else if(days=endDateSerialNumber<firstDateSerialNumber?-DFE:DFE,3===basisValue)coupdays=365/frequencyValue;else{const{days:DSE}=getTwoDateDaysByBasis(startDateSerialNumber,endDateSerialNumber,basisValue);coupdays=endDateSerialNumber<startDateSerialNumber?-DSE:DSE}accruedDaysSum+=issueSerialNumber<=startDateSerialNumber?calcMethodValue?1:0:days/coupdays}const result=parValue*rateValue/frequencyValue*accruedDaysSum;return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=6,this.maxParams=8}},FUNCTION_NAMES_FINANCIAL.ACCRINT],[class Accrintm extends base_function_BaseFunction{calculate(issue,settlement,rate,par,basis){const _basis=basis??NumberValueObject.create(0),{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(issue,settlement,rate,par,_basis);if(isError)return errorObject;const[issueObject,settlementObject,rateObject,parObject,basisObject]=variants,issueSerialNumber=getDateSerialNumberByObject(issueObject);if("number"!=typeof issueSerialNumber)return issueSerialNumber;const settlementSerialNumber=getDateSerialNumberByObject(settlementObject);if("number"!=typeof settlementSerialNumber)return settlementSerialNumber;const rateValue=+rateObject.getValue(),parValue=+parObject.getValue(),basisValue=Math.floor(+basisObject.getValue());if(Number.isNaN(rateValue)||Number.isNaN(parValue)||Number.isNaN(basisValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);if(rateValue<=0||parValue<=0||basisValue<0||basisValue>4||Math.floor(issueSerialNumber)>Math.floor(settlementSerialNumber))return ErrorValueObject.create(error_type_ErrorType.NUM);if(Math.floor(issueSerialNumber)===Math.floor(settlementSerialNumber))return NumberValueObject.create(0);const{days,yearDays}=getTwoDateDaysByBasis(issueSerialNumber,settlementSerialNumber,basisValue),result=parValue*rateValue*days/yearDays;return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=4,this.maxParams=5}},FUNCTION_NAMES_FINANCIAL.ACCRINTM],[class Amorlinc extends base_function_BaseFunction{calculate(cost,datePurchased,firstPeriod,salvage,period,rate,basis){const _basis=basis??NumberValueObject.create(0),{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(cost,datePurchased,firstPeriod,salvage,period,rate,_basis);if(isError)return errorObject;const[costObject,datePurchasedObject,firstPeriodObject,salvageObject,periodObject,rateObject,basisObject]=variants,datePurchasedSerialNumber=getDateSerialNumberByObject(datePurchasedObject);if("number"!=typeof datePurchasedSerialNumber)return datePurchasedSerialNumber;const firstPeriodSerialNumber=getDateSerialNumberByObject(firstPeriodObject);if("number"!=typeof firstPeriodSerialNumber)return firstPeriodSerialNumber;const costValue=+costObject.getValue(),salvageValue=+salvageObject.getValue();let periodValue=+periodObject.getValue();const rateValue=+rateObject.getValue(),basisValue=Math.floor(+basisObject.getValue());return Number.isNaN(costValue)||Number.isNaN(salvageValue)||Number.isNaN(periodValue)||Number.isNaN(rateValue)||Number.isNaN(basisValue)?ErrorValueObject.create(error_type_ErrorType.VALUE):costValue<=0||salvageValue<0||costValue<salvageValue||Math.floor(datePurchasedSerialNumber)>Math.floor(firstPeriodSerialNumber)||periodValue<0||rateValue<=0||![0,1,3,4].includes(basisValue)?ErrorValueObject.create(error_type_ErrorType.NUM):(periodValue=periodValue>1?Math.floor(periodValue):Math.ceil(periodValue),this._getResult(costValue,datePurchasedSerialNumber,firstPeriodSerialNumber,salvageValue,periodValue,rateValue,basisValue))}_getResult(costValue,datePurchasedSerialNumber,firstPeriodSerialNumber,salvageValue,periodValue,rateValue,basisValue){const totalDepreciation=costValue-salvageValue,baseDepreciation=costValue*rateValue,{days,yearDays}=getTwoDateDaysByBasis(datePurchasedSerialNumber,firstPeriodSerialNumber,basisValue),firstPeriodYearsFraction=days/yearDays,life=Math.ceil(totalDepreciation/baseDepreciation-firstPeriodYearsFraction);if(life<0)return NumberValueObject.create(0);let result=baseDepreciation;return 0===periodValue?result=baseDepreciation*firstPeriodYearsFraction:periodValue===life?result=totalDepreciation-baseDepreciation*(firstPeriodYearsFraction+periodValue-1):periodValue>life&&(result=0),NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=6,this.maxParams=7}},FUNCTION_NAMES_FINANCIAL.AMORLINC],[class Coupdaybs extends base_function_BaseFunction{calculate(settlement,maturity,frequency,basis){const _basis=basis??NumberValueObject.create(0),{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(settlement,maturity,frequency,_basis);if(isError)return errorObject;const[settlementObject,maturityObject,frequencyObject,basisObject]=variants,settlementSerialNumber=getDateSerialNumberByObject(settlementObject);if("number"!=typeof settlementSerialNumber)return settlementSerialNumber;const maturitySerialNumber=getDateSerialNumberByObject(maturityObject);if("number"!=typeof maturitySerialNumber)return maturitySerialNumber;const frequencyValue=Math.floor(+frequencyObject.getValue()),basisValue=Math.floor(+basisObject.getValue());if(Number.isNaN(frequencyValue)||Number.isNaN(basisValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);if(![1,2,4].includes(frequencyValue)||basisValue<0||basisValue>4||Math.floor(settlementSerialNumber)>=Math.floor(maturitySerialNumber))return ErrorValueObject.create(error_type_ErrorType.NUM);const result=calculateCoupdaybs(settlementSerialNumber,maturitySerialNumber,frequencyValue,basisValue);return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=3,this.maxParams=4}},FUNCTION_NAMES_FINANCIAL.COUPDAYBS],[class Coupdays extends base_function_BaseFunction{calculate(settlement,maturity,frequency,basis){const _basis=basis??NumberValueObject.create(0),{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(settlement,maturity,frequency,_basis);if(isError)return errorObject;const[settlementObject,maturityObject,frequencyObject,basisObject]=variants,settlementSerialNumber=getDateSerialNumberByObject(settlementObject);if("number"!=typeof settlementSerialNumber)return settlementSerialNumber;const maturitySerialNumber=getDateSerialNumberByObject(maturityObject);if("number"!=typeof maturitySerialNumber)return maturitySerialNumber;const frequencyValue=Math.floor(+frequencyObject.getValue()),basisValue=Math.floor(+basisObject.getValue());if(Number.isNaN(frequencyValue)||Number.isNaN(basisValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);if(![1,2,4].includes(frequencyValue)||basisValue<0||basisValue>4||Math.floor(settlementSerialNumber)>=Math.floor(maturitySerialNumber))return ErrorValueObject.create(error_type_ErrorType.NUM);const result=calculateCoupdays(settlementSerialNumber,maturitySerialNumber,frequencyValue,basisValue);return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=3,this.maxParams=4}},FUNCTION_NAMES_FINANCIAL.COUPDAYS],[class Coupdaysnc extends base_function_BaseFunction{calculate(settlement,maturity,frequency,basis){const _basis=basis??NumberValueObject.create(0),{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(settlement,maturity,frequency,_basis);if(isError)return errorObject;const[settlementObject,maturityObject,frequencyObject,basisObject]=variants,settlementSerialNumber=getDateSerialNumberByObject(settlementObject);if("number"!=typeof settlementSerialNumber)return settlementSerialNumber;const maturitySerialNumber=getDateSerialNumberByObject(maturityObject);if("number"!=typeof maturitySerialNumber)return maturitySerialNumber;const frequencyValue=Math.floor(+frequencyObject.getValue()),basisValue=Math.floor(+basisObject.getValue());if(Number.isNaN(frequencyValue)||Number.isNaN(basisValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);if(![1,2,4].includes(frequencyValue)||basisValue<0||basisValue>4||Math.floor(settlementSerialNumber)>=Math.floor(maturitySerialNumber))return ErrorValueObject.create(error_type_ErrorType.NUM);const settlementDate=excelSerialToDate(settlementSerialNumber),coupDate=excelSerialToDate(maturitySerialNumber);for(coupDate.setUTCFullYear(settlementDate.getUTCFullYear()),coupDate<settlementDate&&coupDate.setUTCFullYear(coupDate.getUTCFullYear()+1);coupDate>settlementDate;)coupDate.setUTCMonth(coupDate.getUTCMonth()-12/frequencyValue);coupDate.setUTCMonth(coupDate.getUTCMonth()+12/frequencyValue);const coupDateSerialNumber=excelDateSerial(coupDate),{days}=getTwoDateDaysByBasis(settlementSerialNumber,coupDateSerialNumber,basisValue);return NumberValueObject.create(days)}constructor(...args){super(...args),this.minParams=3,this.maxParams=4}},FUNCTION_NAMES_FINANCIAL.COUPDAYSNC],[class Coupncd extends base_function_BaseFunction{calculate(settlement,maturity,frequency,basis){const _basis=basis??NumberValueObject.create(0),{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(settlement,maturity,frequency,_basis);if(isError)return errorObject;const[settlementObject,maturityObject,frequencyObject,basisObject]=variants,settlementSerialNumber=getDateSerialNumberByObject(settlementObject);if("number"!=typeof settlementSerialNumber)return settlementSerialNumber;const maturitySerialNumber=getDateSerialNumberByObject(maturityObject);if("number"!=typeof maturitySerialNumber)return maturitySerialNumber;const frequencyValue=Math.floor(+frequencyObject.getValue()),basisValue=Math.floor(+basisObject.getValue());if(Number.isNaN(frequencyValue)||Number.isNaN(basisValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);if(![1,2,4].includes(frequencyValue)||basisValue<0||basisValue>4||Math.floor(settlementSerialNumber)>=Math.floor(maturitySerialNumber))return ErrorValueObject.create(error_type_ErrorType.NUM);const result=calculateCoupncd(settlementSerialNumber,maturitySerialNumber,frequencyValue);return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=3,this.maxParams=4}},FUNCTION_NAMES_FINANCIAL.COUPNCD],[class Coupnum extends base_function_BaseFunction{calculate(settlement,maturity,frequency,basis){const _basis=basis??NumberValueObject.create(0),{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(settlement,maturity,frequency,_basis);if(isError)return errorObject;const[settlementObject,maturityObject,frequencyObject,basisObject]=variants,settlementSerialNumber=getDateSerialNumberByObject(settlementObject);if("number"!=typeof settlementSerialNumber)return settlementSerialNumber;const maturitySerialNumber=getDateSerialNumberByObject(maturityObject);if("number"!=typeof maturitySerialNumber)return maturitySerialNumber;const frequencyValue=Math.floor(+frequencyObject.getValue()),basisValue=Math.floor(+basisObject.getValue());if(Number.isNaN(frequencyValue)||Number.isNaN(basisValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);if(![1,2,4].includes(frequencyValue)||basisValue<0||basisValue>4||Math.floor(settlementSerialNumber)>=Math.floor(maturitySerialNumber))return ErrorValueObject.create(error_type_ErrorType.NUM);if(calculateCouppcd(settlementSerialNumber,maturitySerialNumber,frequencyValue)<0)return ErrorValueObject.create(error_type_ErrorType.NUM);const result=calculateCoupnum(settlementSerialNumber,maturitySerialNumber,frequencyValue);return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=3,this.maxParams=4}},FUNCTION_NAMES_FINANCIAL.COUPNUM],[class Couppcd extends base_function_BaseFunction{calculate(settlement,maturity,frequency,basis){const _basis=basis??NumberValueObject.create(0),{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(settlement,maturity,frequency,_basis);if(isError)return errorObject;const[settlementObject,maturityObject,frequencyObject,basisObject]=variants,settlementSerialNumber=getDateSerialNumberByObject(settlementObject);if("number"!=typeof settlementSerialNumber)return settlementSerialNumber;const maturitySerialNumber=getDateSerialNumberByObject(maturityObject);if("number"!=typeof maturitySerialNumber)return maturitySerialNumber;const frequencyValue=Math.floor(+frequencyObject.getValue()),basisValue=Math.floor(+basisObject.getValue());if(Number.isNaN(frequencyValue)||Number.isNaN(basisValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);if(![1,2,4].includes(frequencyValue)||basisValue<0||basisValue>4||Math.floor(settlementSerialNumber)>=Math.floor(maturitySerialNumber))return ErrorValueObject.create(error_type_ErrorType.NUM);let result=calculateCouppcd(settlementSerialNumber,maturitySerialNumber,frequencyValue);return result<0&&(result=0),NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=3,this.maxParams=4}},FUNCTION_NAMES_FINANCIAL.COUPPCD],[class Cumipmt extends base_function_BaseFunction{calculate(rate,nper,pv,startPeriod,endPeriod,type){const{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(rate,nper,pv,startPeriod,endPeriod,type);if(isError)return errorObject;const[rateObject,nperObject,pvObject,startPeriodObject,endPeriodObject,typeObject]=variants,rateValue=+rateObject.getValue(),nperValue=+nperObject.getValue(),pvValue=+pvObject.getValue(),startPeriodValue=+startPeriodObject.getValue(),endPeriodValue=+endPeriodObject.getValue(),typeValue=+typeObject.getValue();return Number.isNaN(rateValue)||Number.isNaN(nperValue)||Number.isNaN(pvValue)||Number.isNaN(startPeriodValue)||Number.isNaN(endPeriodValue)||Number.isNaN(typeValue)?ErrorValueObject.create(error_type_ErrorType.VALUE):rateValue<=0||nperValue<=0||pvValue<=0||startPeriodValue<1||endPeriodValue<1||startPeriodValue>endPeriodValue||startPeriodValue>nperValue||endPeriodValue>nperValue||![0,1].includes(typeValue)?ErrorValueObject.create(error_type_ErrorType.NUM):Math.trunc(startPeriodValue)!==startPeriodValue&&Math.trunc(endPeriodValue)!==endPeriodValue&&Math.trunc(startPeriodValue)===Math.trunc(endPeriodValue)?NumberValueObject.create(0):this._getResult(rateValue,nperValue,pvValue,startPeriodValue,endPeriodValue,typeValue)}_getResult(rateValue,nperValue,pvValue,startPeriodValue,endPeriodValue,typeValue){const payment=calculatePMT(rateValue,nperValue,pvValue,0,typeValue);let result=0,_startPeriodValue=Math.ceil(startPeriodValue);1===_startPeriodValue&&(0===typeValue&&(result=-pvValue),_startPeriodValue++);let canNotCalculate=!1;for(let i=_startPeriodValue;i<=endPeriodValue;i++){const principal=1===typeValue?calculateFV(rateValue,i-2,payment,pvValue,1):calculateFV(rateValue,i-1,payment,pvValue,0);if(0===principal){canNotCalculate=!0;break}result+=1===typeValue?principal-payment:principal}return result*=rateValue,(result<payment*(endPeriodValue-startPeriodValue+1)||canNotCalculate)&&(result=payment*(endPeriodValue-startPeriodValue+1)),NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=6,this.maxParams=6}},FUNCTION_NAMES_FINANCIAL.CUMIPMT],[class Cumprinc extends base_function_BaseFunction{calculate(rate,nper,pv,startPeriod,endPeriod,type){const{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(rate,nper,pv,startPeriod,endPeriod,type);if(isError)return errorObject;const[rateObject,nperObject,pvObject,startPeriodObject,endPeriodObject,typeObject]=variants,rateValue=+rateObject.getValue(),nperValue=+nperObject.getValue(),pvValue=+pvObject.getValue(),startPeriodValue=+startPeriodObject.getValue(),endPeriodValue=+endPeriodObject.getValue(),typeValue=+typeObject.getValue();return Number.isNaN(rateValue)||Number.isNaN(nperValue)||Number.isNaN(pvValue)||Number.isNaN(startPeriodValue)||Number.isNaN(endPeriodValue)||Number.isNaN(typeValue)?ErrorValueObject.create(error_type_ErrorType.VALUE):rateValue<=0||nperValue<=0||pvValue<=0||startPeriodValue<1||endPeriodValue<1||startPeriodValue>endPeriodValue||![0,1].includes(typeValue)?ErrorValueObject.create(error_type_ErrorType.NUM):Math.trunc(startPeriodValue)!==startPeriodValue&&Math.trunc(endPeriodValue)!==endPeriodValue&&Math.trunc(startPeriodValue)===Math.trunc(endPeriodValue)?NumberValueObject.create(0):this._getResult(rateValue,nperValue,pvValue,startPeriodValue,endPeriodValue,typeValue)}_getResult(rateValue,nperValue,pvValue,startPeriodValue,endPeriodValue,typeValue){const payment=calculatePMT(rateValue,nperValue,pvValue,0,typeValue);let result=0,_startPeriodValue=Math.ceil(startPeriodValue);1===_startPeriodValue&&(result=0===typeValue?payment+pvValue*rateValue:payment,_startPeriodValue++);for(let i=_startPeriodValue;i<=endPeriodValue;i++)result+=1===typeValue?payment-(calculateFV(rateValue,i-2,payment,pvValue,1)-payment)*rateValue:payment-calculateFV(rateValue,i-1,payment,pvValue,0)*rateValue;return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=6,this.maxParams=6}},FUNCTION_NAMES_FINANCIAL.CUMPRINC],[class Db extends base_function_BaseFunction{calculate(cost,salvage,life,period,month){let _month=month??NumberValueObject.create(12);_month.isNull()&&(_month=NumberValueObject.create(12));const maxRowLength=Math.max(cost.isArray()?cost.getRowCount():1,salvage.isArray()?salvage.getRowCount():1,life.isArray()?life.getRowCount():1,period.isArray()?period.getRowCount():1,_month.isArray()?_month.getRowCount():1),maxColumnLength=Math.max(cost.isArray()?cost.getColumnCount():1,salvage.isArray()?salvage.getColumnCount():1,life.isArray()?life.getColumnCount():1,period.isArray()?period.getColumnCount():1,_month.isArray()?_month.getColumnCount():1),costArray=expandArrayValueObject(maxRowLength,maxColumnLength,cost,ErrorValueObject.create(error_type_ErrorType.NA)),salvageArray=expandArrayValueObject(maxRowLength,maxColumnLength,salvage,ErrorValueObject.create(error_type_ErrorType.NA)),lifeArray=expandArrayValueObject(maxRowLength,maxColumnLength,life,ErrorValueObject.create(error_type_ErrorType.NA)),periodArray=expandArrayValueObject(maxRowLength,maxColumnLength,period,ErrorValueObject.create(error_type_ErrorType.NA)),monthArray=expandArrayValueObject(maxRowLength,maxColumnLength,_month,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=costArray.map(((costObject,rowIndex,columnIndex)=>{const salvageObject=salvageArray.get(rowIndex,columnIndex),lifeObject=lifeArray.get(rowIndex,columnIndex),periodObject=periodArray.get(rowIndex,columnIndex),monthObject=monthArray.get(rowIndex,columnIndex),{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(costObject,salvageObject,lifeObject,periodObject,monthObject);if(isError)return errorObject;const[_costObject,_salvageObject,_lifeObject,_periodObject,_monthObject]=variants,costValue=+_costObject.getValue(),salvageValue=+_salvageObject.getValue(),lifeValue=+_lifeObject.getValue();let periodValue=+_periodObject.getValue();const monthValue=Math.floor(+_monthObject.getValue());return costValue<0||salvageValue<0||lifeValue<=0||periodValue<=0||Math.floor(periodValue)>Math.floor(lifeValue)||monthValue<1||monthValue>12?ErrorValueObject.create(error_type_ErrorType.NUM):(periodValue<1&&(periodValue=1),periodValue=Math.floor(periodValue),this._getResult(costValue,salvageValue,lifeValue,periodValue,monthValue,rowIndex,columnIndex))}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_getResult(costValue,salvageValue,lifeValue,periodValue,monthValue,rowIndex,columnIndex){const rate=+(1-(salvageValue/costValue)**(1/lifeValue)).toFixed(3),initial=costValue*rate*monthValue/12;let total=initial,current=0;const ceiling=periodValue===lifeValue?lifeValue-1:periodValue;for(let i=2;i<=ceiling;i++)current=(costValue-total)*rate,total+=current;let result;return result=1===periodValue?initial:periodValue===lifeValue?(costValue-total)*rate:current,Number.isNaN(result)||!Number.isFinite(result)?ErrorValueObject.create(error_type_ErrorType.NUM):0===rowIndex&&0===columnIndex?NumberValueObject.create(result,getCurrencyFormat(this.getLocale())):NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=4,this.maxParams=5,this.needsLocale=!0}},FUNCTION_NAMES_FINANCIAL.DB],[class Ddb extends base_function_BaseFunction{calculate(cost,salvage,life,period,factor){let _factor=factor??NumberValueObject.create(2);_factor.isNull()&&(_factor=NumberValueObject.create(2));const maxRowLength=Math.max(cost.isArray()?cost.getRowCount():1,salvage.isArray()?salvage.getRowCount():1,life.isArray()?life.getRowCount():1,period.isArray()?period.getRowCount():1,_factor.isArray()?_factor.getRowCount():1),maxColumnLength=Math.max(cost.isArray()?cost.getColumnCount():1,salvage.isArray()?salvage.getColumnCount():1,life.isArray()?life.getColumnCount():1,period.isArray()?period.getColumnCount():1,_factor.isArray()?_factor.getColumnCount():1),costArray=expandArrayValueObject(maxRowLength,maxColumnLength,cost,ErrorValueObject.create(error_type_ErrorType.NA)),salvageArray=expandArrayValueObject(maxRowLength,maxColumnLength,salvage,ErrorValueObject.create(error_type_ErrorType.NA)),lifeArray=expandArrayValueObject(maxRowLength,maxColumnLength,life,ErrorValueObject.create(error_type_ErrorType.NA)),periodArray=expandArrayValueObject(maxRowLength,maxColumnLength,period,ErrorValueObject.create(error_type_ErrorType.NA)),factorArray=expandArrayValueObject(maxRowLength,maxColumnLength,_factor,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=costArray.map(((costObject,rowIndex,columnIndex)=>{const salvageObject=salvageArray.get(rowIndex,columnIndex),lifeObject=lifeArray.get(rowIndex,columnIndex),periodObject=periodArray.get(rowIndex,columnIndex),factorObject=factorArray.get(rowIndex,columnIndex),{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(costObject,salvageObject,lifeObject,periodObject,factorObject);if(isError)return errorObject;const[_costObject,_salvageObject,_lifeObject,_periodObject,_factorObject]=variants,costValue=+_costObject.getValue(),salvageValue=+_salvageObject.getValue(),lifeValue=+_lifeObject.getValue(),periodValue=+_periodObject.getValue(),factorValue=+_factorObject.getValue();if(costValue<0||salvageValue<0||lifeValue<=0||periodValue<=0||periodValue>lifeValue||factorValue<=0)return ErrorValueObject.create(error_type_ErrorType.NUM);const result=calculateDDB(costValue,salvageValue,lifeValue,periodValue,factorValue);return Number.isNaN(result)||!Number.isFinite(result)?ErrorValueObject.create(error_type_ErrorType.NUM):0===rowIndex&&0===columnIndex?NumberValueObject.create(result,getCurrencyFormat(this.getLocale())):NumberValueObject.create(result)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}constructor(...args){super(...args),this.minParams=4,this.maxParams=5,this.needsLocale=!0}},FUNCTION_NAMES_FINANCIAL.DDB],[class Disc extends base_function_BaseFunction{calculate(settlement,maturity,pr,redemption,basis){const _basis=basis??NumberValueObject.create(0),{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(settlement,maturity,pr,redemption,_basis);if(isError)return errorObject;const[settlementObject,maturityObject,prObject,redemptionObject,basisObject]=variants,settlementSerialNumber=getDateSerialNumberByObject(settlementObject);if("number"!=typeof settlementSerialNumber)return settlementSerialNumber;const maturitySerialNumber=getDateSerialNumberByObject(maturityObject);if("number"!=typeof maturitySerialNumber)return maturitySerialNumber;const prValue=+prObject.getValue(),redemptionValue=+redemptionObject.getValue(),basisValue=Math.floor(+basisObject.getValue());if(Number.isNaN(prValue)||Number.isNaN(redemptionValue)||Number.isNaN(basisValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);if(prValue<=0||redemptionValue<=0||basisValue<0||basisValue>4||Math.floor(settlementSerialNumber)>=Math.floor(maturitySerialNumber))return ErrorValueObject.create(error_type_ErrorType.NUM);const{days,yearDays}=getTwoDateDaysByBasis(settlementSerialNumber,maturitySerialNumber,basisValue),result=(redemptionValue-prValue)/redemptionValue*(yearDays/days);return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=4,this.maxParams=5}},FUNCTION_NAMES_FINANCIAL.DISC],[class Dollarde extends base_function_BaseFunction{calculate(fractionalDollar,fraction){const{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(fractionalDollar,fraction);if(isError)return errorObject;const[fractionalDollarObject,fractionObject]=variants,fractionalDollarValue=+fractionalDollarObject.getValue();let fractionValue=Math.floor(+fractionObject.getValue());if(Number.isNaN(fractionalDollarValue)||Number.isNaN(fractionValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);if(fractionValue<0)return ErrorValueObject.create(error_type_ErrorType.NUM);if(fractionValue>=0&&fractionValue<1)return ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO);fractionValue=Number.parseInt(`${fractionValue}`,10);let result=Number.parseInt(`${fractionalDollarValue}`,10);result+=fractionalDollarValue%1*10**Math.ceil(Math.log(fractionValue)/Math.LN10)/fractionValue;const power=10**(Math.ceil(Math.log(fractionValue)/Math.LN2)+1);return result=Math.round(result*power)/power,NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_FINANCIAL.DOLLARDE],[class Dollarfr extends base_function_BaseFunction{calculate(decimalDollar,fraction){const{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(decimalDollar,fraction);if(isError)return errorObject;const[decimalDollarObject,fractionObject]=variants,decimalDollarValue=+decimalDollarObject.getValue();let fractionValue=Math.floor(+fractionObject.getValue());if(Number.isNaN(decimalDollarValue)||Number.isNaN(fractionValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);if(fractionValue<0)return ErrorValueObject.create(error_type_ErrorType.NUM);if(fractionValue>=0&&fractionValue<1)return ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO);fractionValue=Number.parseInt(`${fractionValue}`,10);let result=Number.parseInt(`${decimalDollarValue}`,10);return result+=decimalDollarValue%1*10**-Math.ceil(Math.log(fractionValue)/Math.LN10)*fractionValue,NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_FINANCIAL.DOLLARFR],[class Duration extends base_function_BaseFunction{calculate(settlement,maturity,coupon,yld,frequency,basis){let _basis=basis??NumberValueObject.create(0);_basis.isNull()&&(_basis=NumberValueObject.create(0));const{isError,errorObject,variants}=checkVariantsErrorIsNullorArrayOrBoolean(settlement,maturity,coupon,yld,frequency,_basis);if(isError)return errorObject;const[settlementObject,maturityObject,couponObject,yldObject,frequencyObject,basisObject]=variants,settlementSerialNumber=getDateSerialNumberByObject(settlementObject);if("number"!=typeof settlementSerialNumber)return settlementSerialNumber;const maturitySerialNumber=getDateSerialNumberByObject(maturityObject);if("number"!=typeof maturitySerialNumber)return maturitySerialNumber;const couponValue=+couponObject.getValue(),yldValue=+yldObject.getValue(),frequencyValue=Math.floor(+frequencyObject.getValue()),basisValue=Math.floor(+basisObject.getValue());if(Number.isNaN(couponValue)||Number.isNaN(yldValue)||Number.isNaN(frequencyValue)||Number.isNaN(basisValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);if(couponValue<0||yldValue<0||![1,2,4].includes(frequencyValue)||basisValue<0||basisValue>4||Math.floor(settlementSerialNumber)>=Math.floor(maturitySerialNumber))return ErrorValueObject.create(error_type_ErrorType.NUM);if(settlementSerialNumber<=0||maturitySerialNumber<=366)return ErrorValueObject.create(error_type_ErrorType.NUM);const result=calculateDuration(settlementSerialNumber,maturitySerialNumber,couponValue,yldValue,frequencyValue,basisValue);return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=5,this.maxParams=6}},FUNCTION_NAMES_FINANCIAL.DURATION],[class Effect extends base_function_BaseFunction{calculate(nominalRate,npery){const{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(nominalRate,npery);if(isError)return errorObject;const[nominalRateObject,nperyObject]=variants,nominalRateValue=+nominalRateObject.getValue();let nperyValue=Math.floor(+nperyObject.getValue());if(Number.isNaN(nominalRateValue)||Number.isNaN(nperyValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);if(nominalRateValue<=0||nperyValue<1)return ErrorValueObject.create(error_type_ErrorType.NUM);nperyValue=Number.parseInt(`${nperyValue}`,10);const result=(1+nominalRateValue/nperyValue)**nperyValue-1;return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_FINANCIAL.EFFECT],[class Fv extends base_function_BaseFunction{calculate(rate,nper,pmt,pv,type){const _pv=pv??NumberValueObject.create(0),_type=type??NumberValueObject.create(0),maxRowLength=Math.max(rate.isArray()?rate.getRowCount():1,nper.isArray()?nper.getRowCount():1,pmt.isArray()?pmt.getRowCount():1,_pv.isArray()?_pv.getRowCount():1,_type.isArray()?_type.getRowCount():1),maxColumnLength=Math.max(rate.isArray()?rate.getColumnCount():1,nper.isArray()?nper.getColumnCount():1,pmt.isArray()?pmt.getColumnCount():1,_pv.isArray()?_pv.getColumnCount():1,_type.isArray()?_type.getColumnCount():1),rateArray=expandArrayValueObject(maxRowLength,maxColumnLength,rate,ErrorValueObject.create(error_type_ErrorType.NA)),nperArray=expandArrayValueObject(maxRowLength,maxColumnLength,nper,ErrorValueObject.create(error_type_ErrorType.NA)),pmtArray=expandArrayValueObject(maxRowLength,maxColumnLength,pmt,ErrorValueObject.create(error_type_ErrorType.NA)),pvArray=expandArrayValueObject(maxRowLength,maxColumnLength,_pv,ErrorValueObject.create(error_type_ErrorType.NA)),typeArray=expandArrayValueObject(maxRowLength,maxColumnLength,_type,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=rateArray.map(((rateObject,rowIndex,columnIndex)=>{const nperObject=nperArray.get(rowIndex,columnIndex),pmtObject=pmtArray.get(rowIndex,columnIndex),pvObject=pvArray.get(rowIndex,columnIndex),typeObject=typeArray.get(rowIndex,columnIndex),{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(rateObject,nperObject,pmtObject,pvObject,typeObject);if(isError)return errorObject;const[_rateObject,_nperObject,_pmtObject,_pvObject,_typeObject]=variants,result=calculateFV(+_rateObject.getValue(),+_nperObject.getValue(),+_pmtObject.getValue(),+_pvObject.getValue(),+_typeObject.getValue()?1:0);return Number.isNaN(result)||!Number.isFinite(result)?ErrorValueObject.create(error_type_ErrorType.NUM):0===rowIndex&&0===columnIndex?NumberValueObject.create(result,getCurrencyFormat(this.getLocale())):NumberValueObject.create(result)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}constructor(...args){super(...args),this.minParams=3,this.maxParams=5,this.needsLocale=!0}},FUNCTION_NAMES_FINANCIAL.FV],[class Fvschedule extends base_function_BaseFunction{calculate(principal,schedule){const{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(principal);if(isError)return errorObject;const[principalObject]=variants,principalValue=+principalObject.getValue();if(Number.isNaN(principalValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);let result=principalValue;if(schedule.isArray()){const scheduleValues=schedule.getArrayValue().flat();for(let i=0;i<scheduleValues.length;i++){const scheduleObject=scheduleValues[i];if(scheduleObject.isBoolean())return ErrorValueObject.create(error_type_ErrorType.VALUE);const scheduleValue=+scheduleObject.getValue();if(Number.isNaN(scheduleValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);result*=1+scheduleValue}}else{if(schedule.isBoolean())return ErrorValueObject.create(error_type_ErrorType.VALUE);const scheduleValue=+schedule.getValue();if(Number.isNaN(scheduleValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);result*=1+scheduleValue}return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_FINANCIAL.FVSCHEDULE],[class Intrate extends base_function_BaseFunction{calculate(settlement,maturity,investment,redemption,basis){const _basis=basis??NumberValueObject.create(0),{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(settlement,maturity,investment,redemption,_basis);if(isError)return errorObject;const[settlementObject,maturityObject,investmentObject,redemptionObject,basisObject]=variants,settlementSerialNumber=getDateSerialNumberByObject(settlementObject);if("number"!=typeof settlementSerialNumber)return settlementSerialNumber;const maturitySerialNumber=getDateSerialNumberByObject(maturityObject);if("number"!=typeof maturitySerialNumber)return maturitySerialNumber;const investmentValue=+investmentObject.getValue(),redemptionValue=+redemptionObject.getValue(),basisValue=Math.floor(+basisObject.getValue());if(Number.isNaN(investmentValue)||Number.isNaN(redemptionValue)||Number.isNaN(basisValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);if(investmentValue<=0||redemptionValue<=0||basisValue<0||basisValue>4||Math.floor(settlementSerialNumber)>=Math.floor(maturitySerialNumber))return ErrorValueObject.create(error_type_ErrorType.NUM);const{days,yearDays}=getTwoDateDaysByBasis(settlementSerialNumber,maturitySerialNumber,basisValue),result=(redemptionValue-investmentValue)/investmentValue*(yearDays/days);return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=4,this.maxParams=5}},FUNCTION_NAMES_FINANCIAL.INTRATE],[class Ipmt extends base_function_BaseFunction{calculate(rate,per,nper,pv,fv,type){const _fv=fv??NumberValueObject.create(0),_type=type??NumberValueObject.create(0),maxRowLength=Math.max(rate.isArray()?rate.getRowCount():1,per.isArray()?per.getRowCount():1,nper.isArray()?nper.getRowCount():1,pv.isArray()?pv.getRowCount():1,_fv.isArray()?_fv.getRowCount():1,_type.isArray()?_type.getRowCount():1),maxColumnLength=Math.max(rate.isArray()?rate.getColumnCount():1,per.isArray()?per.getColumnCount():1,nper.isArray()?nper.getColumnCount():1,pv.isArray()?pv.getColumnCount():1,_fv.isArray()?_fv.getColumnCount():1,_type.isArray()?_type.getColumnCount():1),rateArray=expandArrayValueObject(maxRowLength,maxColumnLength,rate,ErrorValueObject.create(error_type_ErrorType.NA)),perArray=expandArrayValueObject(maxRowLength,maxColumnLength,per,ErrorValueObject.create(error_type_ErrorType.NA)),nperArray=expandArrayValueObject(maxRowLength,maxColumnLength,nper,ErrorValueObject.create(error_type_ErrorType.NA)),pvArray=expandArrayValueObject(maxRowLength,maxColumnLength,pv,ErrorValueObject.create(error_type_ErrorType.NA)),fvArray=expandArrayValueObject(maxRowLength,maxColumnLength,_fv,ErrorValueObject.create(error_type_ErrorType.NA)),typeArray=expandArrayValueObject(maxRowLength,maxColumnLength,_type,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=rateArray.map(((rateObject,rowIndex,columnIndex)=>{const perObject=perArray.get(rowIndex,columnIndex),nperObject=nperArray.get(rowIndex,columnIndex),pvObject=pvArray.get(rowIndex,columnIndex),fvObject=fvArray.get(rowIndex,columnIndex),typeObject=typeArray.get(rowIndex,columnIndex),{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(rateObject,perObject,nperObject,pvObject,fvObject,typeObject);if(isError)return errorObject;const[_rateObject,_perObject,_nperObject,_pvObject,_fvObject,_typeObject]=variants,rateValue=+_rateObject.getValue(),perValue=+_perObject.getValue(),nperValue=+_nperObject.getValue(),pvValue=+_pvObject.getValue(),fvValue=+_fvObject.getValue(),typeValue=+_typeObject.getValue();if(perValue<1||Math.floor(perValue)>Math.ceil(nperValue))return ErrorValueObject.create(error_type_ErrorType.NUM);const result=calculateIPMT(rateValue,perValue,nperValue,pvValue,fvValue,typeValue?1:0);return Number.isNaN(result)||!Number.isFinite(result)?ErrorValueObject.create(error_type_ErrorType.NUM):0===rowIndex&&0===columnIndex?NumberValueObject.create(result,getCurrencyFormat(this.getLocale())):NumberValueObject.create(result)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}constructor(...args){super(...args),this.minParams=4,this.maxParams=6,this.needsLocale=!0}},FUNCTION_NAMES_FINANCIAL.IPMT],[class Irr extends base_function_BaseFunction{calculate(values,guess){let _guess=guess??NumberValueObject.create(.1);return _guess.isNull()&&(_guess=NumberValueObject.create(.1)),_guess.isArray()?_guess.map(((guessObject,rowIndex,columnIndex)=>this._handleSingleObject(values,guessObject,rowIndex,columnIndex))):this._handleSingleObject(values,_guess)}_handleSingleObject(values,guess,rowIndex=0,columnIndex=0){if(values.isError())return values;if(guess.isError())return guess;if(values.isNull())return ErrorValueObject.create(error_type_ErrorType.VALUE);if(!values.isArray())return ErrorValueObject.create(error_type_ErrorType.NUM);const{_values,valuesHasError}=this._getValues(values);if(valuesHasError)return ErrorValueObject.create(error_type_ErrorType.VALUE);let _guess=guess;if(_guess.isString()&&(_guess=_guess.convertToNumberObjectValue(),_guess.isError()))return _guess;const guessValue=+_guess.getValue(),{positive,negative}=this._checkValues(_values);if(!positive||!negative)return ErrorValueObject.create(error_type_ErrorType.NUM);const result=getResultByGuessIterF(guessValue,(rate=>calculateNpv(rate,_values)));return"number"!=typeof result?result:0===rowIndex&&0===columnIndex?NumberValueObject.create(result,"0%"):NumberValueObject.create(result)}_getValues(values){const _values=[];let valuesHasError=!1;return values.iterator((valueOject=>{const _valueOject=valueOject;if(_valueOject.isError())return valuesHasError=!0,!1;if(_valueOject.isNull()||_valueOject.isBoolean())return!0;const value=+_valueOject.getValue();if(Number.isNaN(value))return!0;_values.push(value)})),{_values,valuesHasError}}_checkValues(values){let positive=!1,negative=!1;for(let i=0;i<values.length;i++)values[i]>0&&(positive=!0),values[i]<0&&(negative=!0);return{positive,negative}}constructor(...args){super(...args),this.minParams=1,this.maxParams=2}},FUNCTION_NAMES_FINANCIAL.IRR],[class Ispmt extends base_function_BaseFunction{calculate(rate,per,nper,pv){const maxRowLength=Math.max(rate.isArray()?rate.getRowCount():1,per.isArray()?per.getRowCount():1,nper.isArray()?nper.getRowCount():1,pv.isArray()?pv.getRowCount():1),maxColumnLength=Math.max(rate.isArray()?rate.getColumnCount():1,per.isArray()?per.getColumnCount():1,nper.isArray()?nper.getColumnCount():1,pv.isArray()?pv.getColumnCount():1),rateArray=expandArrayValueObject(maxRowLength,maxColumnLength,rate,ErrorValueObject.create(error_type_ErrorType.NA)),perArray=expandArrayValueObject(maxRowLength,maxColumnLength,per,ErrorValueObject.create(error_type_ErrorType.NA)),nperArray=expandArrayValueObject(maxRowLength,maxColumnLength,nper,ErrorValueObject.create(error_type_ErrorType.NA)),pvArray=expandArrayValueObject(maxRowLength,maxColumnLength,pv,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=rateArray.map(((rateObject,rowIndex,columnIndex)=>{const perObject=perArray.get(rowIndex,columnIndex),nperObject=nperArray.get(rowIndex,columnIndex),pvObject=pvArray.get(rowIndex,columnIndex),{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(rateObject,perObject,nperObject,pvObject);if(isError)return errorObject;const[_rateObject,_perObject,_nperObject,_pvObject]=variants,rateValue=+_rateObject.getValue(),perValue=+_perObject.getValue(),nperValue=+_nperObject.getValue(),pvValue=+_pvObject.getValue();if(0===nperValue)return ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO);const result=pvValue*rateValue*(perValue/nperValue-1);return NumberValueObject.create(result)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}constructor(...args){super(...args),this.minParams=4,this.maxParams=4}},FUNCTION_NAMES_FINANCIAL.ISPMT],[class Mduration extends base_function_BaseFunction{calculate(settlement,maturity,coupon,yld,frequency,basis){let _basis=basis??NumberValueObject.create(0);_basis.isNull()&&(_basis=NumberValueObject.create(0));const{isError,errorObject,variants}=checkVariantsErrorIsNullorArrayOrBoolean(settlement,maturity,coupon,yld,frequency,_basis);if(isError)return errorObject;const[settlementObject,maturityObject,couponObject,yldObject,frequencyObject,basisObject]=variants,settlementSerialNumber=getDateSerialNumberByObject(settlementObject);if("number"!=typeof settlementSerialNumber)return settlementSerialNumber;const maturitySerialNumber=getDateSerialNumberByObject(maturityObject);if("number"!=typeof maturitySerialNumber)return maturitySerialNumber;const couponValue=+couponObject.getValue(),yldValue=+yldObject.getValue(),frequencyValue=Math.floor(+frequencyObject.getValue()),basisValue=Math.floor(+basisObject.getValue());if(Number.isNaN(couponValue)||Number.isNaN(yldValue)||Number.isNaN(frequencyValue)||Number.isNaN(basisValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);if(couponValue<0||yldValue<0||![1,2,4].includes(frequencyValue)||basisValue<0||basisValue>4||Math.floor(settlementSerialNumber)>=Math.floor(maturitySerialNumber))return ErrorValueObject.create(error_type_ErrorType.NUM);let result=calculateDuration(settlementSerialNumber,maturitySerialNumber,couponValue,yldValue,frequencyValue,basisValue);return result/=1+yldValue/frequencyValue,NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=5,this.maxParams=6}},FUNCTION_NAMES_FINANCIAL.MDURATION],[class Mirr extends base_function_BaseFunction{calculate(values,financeRate,reinvestRate){const{_values,numberValues,positive,negative}=this._getValues(values),maxRowLength=Math.max(financeRate.isArray()?financeRate.getRowCount():1,reinvestRate.isArray()?reinvestRate.getRowCount():1),maxColumnLength=Math.max(financeRate.isArray()?financeRate.getColumnCount():1,reinvestRate.isArray()?reinvestRate.getColumnCount():1),financeRateArray=expandArrayValueObject(maxRowLength,maxColumnLength,financeRate,ErrorValueObject.create(error_type_ErrorType.NA)),reinvestRateArray=expandArrayValueObject(maxRowLength,maxColumnLength,reinvestRate,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=financeRateArray.map(((financeRateObject,rowIndex,columnIndex)=>{const reinvestRateObject=reinvestRateArray.get(rowIndex,columnIndex);if(values.isError())return values;if(reinvestRateObject.isError())return reinvestRateObject;if(_values.isError())return _values;if(!positive||!negative)return ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO);const financeRateValue=+financeRateObject.getValue(),reinvestRateValue=+reinvestRateObject.getValue();if(Number.isNaN(financeRateValue)||Number.isNaN(reinvestRateValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);if(-1===reinvestRateValue)return ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO);const result=this._getResult(numberValues,financeRateValue,reinvestRateValue);return 0===rowIndex&&0===columnIndex?NumberValueObject.create(result,"0%"):NumberValueObject.create(result)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_getValues(values){let _values=values,_numberValues=[],_positive=!1,_negative=!1;if(!values.isError())if(values.isNull())_values=ErrorValueObject.create(error_type_ErrorType.VALUE);else if(values.isArray()){const{numberValues,valuesHasError,errorObject,positive,negative}=this._checkValues(values);valuesHasError&&(_values=errorObject),_numberValues=numberValues,_positive=positive,_negative=negative}else _values=ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO);return{_values,numberValues:_numberValues,positive:_positive,negative:_negative}}_checkValues(values){const numberValues=[];let valuesHasError=!1,errorObject=ErrorValueObject.create(error_type_ErrorType.VALUE),positive=!1,negative=!1;return values.iterator((valueOject=>{const _valueOject=valueOject;if(_valueOject.isError())return valuesHasError=!0,errorObject=_valueOject,!1;if(_valueOject.isNull()||_valueOject.isBoolean())return!0;const value=+_valueOject.getValue();if(Number.isNaN(value))return!0;value>0&&(positive=!0),value<0&&(negative=!0),numberValues.push(value)})),{numberValues,valuesHasError,errorObject,positive,negative}}_getResult(values,financeRate,reinvestRate){const n=values.length,negatives=[],positives=[];for(let i=0;i<n;i++)values[i]>0?positives.push(values[i]):values[i]<0&&negatives.push(values[i]);return(-this._npv(reinvestRate,values,"positive")*(1+reinvestRate)**n/(this._npv(financeRate,values,"negative")*(1+financeRate)))**(1/(n-1))-1}_npv(rate,values,type){let res=0;for(let i=1;i<=values.length;i++){const value=values[i-1];("positive"===type&&value>0||"negative"===type&&value<0)&&(res+=value/(1+rate)**i)}return res}constructor(...args){super(...args),this.minParams=3,this.maxParams=3}},FUNCTION_NAMES_FINANCIAL.MIRR],[class Nominal extends base_function_BaseFunction{calculate(effectRate,npery){const{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(effectRate,npery);if(isError)return errorObject;const[effectRateObject,nperyObject]=variants,effectRateValue=+effectRateObject.getValue();let nperyValue=Math.floor(+nperyObject.getValue());if(Number.isNaN(effectRateValue)||Number.isNaN(nperyValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);if(effectRateValue<=0||nperyValue<1)return ErrorValueObject.create(error_type_ErrorType.NUM);nperyValue=Number.parseInt(`${nperyValue}`,10);const result=((effectRateValue+1)**(1/nperyValue)-1)*nperyValue;return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_FINANCIAL.NOMINAL],[class Nper extends base_function_BaseFunction{calculate(rate,pmt,pv,fv,type){const _fv=fv??NumberValueObject.create(0),_type=type??NumberValueObject.create(0),maxRowLength=Math.max(rate.isArray()?rate.getRowCount():1,pmt.isArray()?pmt.getRowCount():1,pv.isArray()?pv.getRowCount():1,_fv.isArray()?_fv.getRowCount():1,_type.isArray()?_type.getRowCount():1),maxColumnLength=Math.max(rate.isArray()?rate.getColumnCount():1,pmt.isArray()?pmt.getColumnCount():1,pv.isArray()?pv.getColumnCount():1,_fv.isArray()?_fv.getColumnCount():1,_type.isArray()?_type.getColumnCount():1),rateArray=expandArrayValueObject(maxRowLength,maxColumnLength,rate,ErrorValueObject.create(error_type_ErrorType.NA)),pmtArray=expandArrayValueObject(maxRowLength,maxColumnLength,pmt,ErrorValueObject.create(error_type_ErrorType.NA)),pvArray=expandArrayValueObject(maxRowLength,maxColumnLength,pv,ErrorValueObject.create(error_type_ErrorType.NA)),fvArray=expandArrayValueObject(maxRowLength,maxColumnLength,_fv,ErrorValueObject.create(error_type_ErrorType.NA)),typeArray=expandArrayValueObject(maxRowLength,maxColumnLength,_type,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=rateArray.map(((rateObject,rowIndex,columnIndex)=>{const pmtObject=pmtArray.get(rowIndex,columnIndex),pvObject=pvArray.get(rowIndex,columnIndex),fvObject=fvArray.get(rowIndex,columnIndex),typeObject=typeArray.get(rowIndex,columnIndex),{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(rateObject,pmtObject,pvObject,fvObject,typeObject);if(isError)return errorObject;const[_rateObject,_pmtObject,_pvObject,_fvObject,_typeObject]=variants,rateValue=+_rateObject.getValue(),pmtValue=+_pmtObject.getValue(),pvValue=+_pvObject.getValue(),fvValue=+_fvObject.getValue();let result,typeValue=+_typeObject.getValue();if(typeValue=typeValue?1:0,0===rateValue&&0===pmtValue)return ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO);if(0===rateValue)result=-(pvValue+fvValue)/pmtValue;else{const num=pmtValue*(1+rateValue*typeValue)-fvValue*rateValue,den=pvValue*rateValue+pmtValue*(1+rateValue*typeValue);result=Math.log(num/den)/Math.log(1+rateValue)}return Number.isNaN(result)||!Number.isFinite(result)?ErrorValueObject.create(error_type_ErrorType.NUM):NumberValueObject.create(result)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}constructor(...args){super(...args),this.minParams=3,this.maxParams=5}},FUNCTION_NAMES_FINANCIAL.NPER],[class Npv extends base_function_BaseFunction{calculate(rate,...variants){if(rate.isError())return rate;const{isError,errorObject,values}=this._getValues(variants);return rate.isArray()?rate.map(((rateObject,rowIndex,columnIndex)=>this._handleSingleObject(rateObject,isError,errorObject,values,rowIndex,columnIndex))):this._handleSingleObject(rate,isError,errorObject,values)}_handleSingleObject(rate,isError,errorObject,values,rowIndex=0,columnIndex=0){let _rate=rate;if(_rate.isString()&&(_rate=_rate.convertToNumberObjectValue()),_rate.isError())return _rate;if(isError)return errorObject;const result=calculateNpv(+rate.getValue(),values);return Number.isNaN(result)||Math.abs(result)===1/0?ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO):0===rowIndex&&0===columnIndex?NumberValueObject.create(result,getCurrencyFormat(this.getLocale())):NumberValueObject.create(result)}_getValues(variants){const values=[];for(let i=0;i<variants.length;i++){const variant=variants[i];if(variant.isError())return{isError:!0,errorObject:variant};if(variant.isArray()){let isError=!1,errorObject=ErrorValueObject.create(error_type_ErrorType.VALUE);if(variant.iterator((variantOject=>{const _variantOject=variantOject;if(_variantOject.isError())return isError=!0,errorObject=_variantOject,!1;if(_variantOject.isNull()||_variantOject.isBoolean())return!0;const value=+_variantOject.getValue();if(Number.isNaN(value))return!0;values.push(value)})),isError)return{isError,errorObject}}else{const value=+variant.getValue();if(Number.isNaN(value))return{isError:!0,errorObject:ErrorValueObject.create(error_type_ErrorType.VALUE)};values.push(value)}}return{isError:!1,values}}constructor(...args){super(...args),this.minParams=2,this.maxParams=255,this.needsLocale=!0}},FUNCTION_NAMES_FINANCIAL.NPV],[class Oddfprice extends base_function_BaseFunction{calculate(settlement,maturity,issue,firstCoupon,rate,yld,redemption,frequency,basis){let _basis=basis??NumberValueObject.create(0);_basis.isNull()&&(_basis=NumberValueObject.create(0));const{isError,errorObject,variants}=checkVariantsErrorIsNullorArrayOrBoolean(settlement,maturity,issue,firstCoupon,rate,yld,redemption,frequency,_basis);if(isError)return errorObject;const[settlementObject,maturityObject,issueObject,firstCouponObject,rateObject,yldObject,redemptionObject,frequencyObject,basisObject]=variants,settlementSerialNumber=getDateSerialNumberByObject(settlementObject);if("number"!=typeof settlementSerialNumber)return settlementSerialNumber;const maturitySerialNumber=getDateSerialNumberByObject(maturityObject);if("number"!=typeof maturitySerialNumber)return maturitySerialNumber;const issueSerialNumber=getDateSerialNumberByObject(issueObject);if("number"!=typeof issueSerialNumber)return issueSerialNumber;const firstCouponSerialNumber=getDateSerialNumberByObject(firstCouponObject);if("number"!=typeof firstCouponSerialNumber)return firstCouponSerialNumber;const rateValue=+rateObject.getValue(),yldValue=+yldObject.getValue(),redemptionValue=+redemptionObject.getValue(),frequencyValue=Math.floor(+frequencyObject.getValue()),basisValue=Math.floor(+basisObject.getValue());if(Number.isNaN(rateValue)||Number.isNaN(yldValue)||Number.isNaN(redemptionValue)||Number.isNaN(frequencyValue)||Number.isNaN(basisValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);if(rateValue<0||yldValue<0||redemptionValue<=0||![1,2,4].includes(frequencyValue)||basisValue<0||basisValue>4||!this._validDate(maturitySerialNumber,firstCouponSerialNumber,settlementSerialNumber,issueSerialNumber,frequencyValue))return ErrorValueObject.create(error_type_ErrorType.NUM);const result=calculateOddFPrice(settlementSerialNumber,maturitySerialNumber,issueSerialNumber,firstCouponSerialNumber,rateValue,yldValue,redemptionValue,frequencyValue,basisValue);return NumberValueObject.create(result)}_validDate(maturitySerialNumber,firstCouponSerialNumber,settlementSerialNumber,issueSerialNumber,frequencyValue){return this._getDateCorrectOrder(maturitySerialNumber,firstCouponSerialNumber,settlementSerialNumber,issueSerialNumber)&&validDaysBetweenIsWholeFrequencyByTwoDate(maturitySerialNumber,firstCouponSerialNumber,frequencyValue)&&validCouppcdIsGte0ByTwoDate(issueSerialNumber,maturitySerialNumber,frequencyValue)}_getDateCorrectOrder(maturitySerialNumber,firstCouponSerialNumber,settlementSerialNumber,issueSerialNumber){return Math.floor(maturitySerialNumber)>Math.floor(firstCouponSerialNumber)&&Math.floor(firstCouponSerialNumber)>Math.floor(settlementSerialNumber)&&Math.floor(settlementSerialNumber)>Math.floor(issueSerialNumber)}constructor(...args){super(...args),this.minParams=8,this.maxParams=9}},FUNCTION_NAMES_FINANCIAL.ODDFPRICE],[class Oddfyield extends base_function_BaseFunction{calculate(settlement,maturity,issue,firstCoupon,rate,pr,redemption,frequency,basis){let _basis=basis??NumberValueObject.create(0);_basis.isNull()&&(_basis=NumberValueObject.create(0));const{isError,errorObject,variants}=checkVariantsErrorIsNullorArrayOrBoolean(settlement,maturity,issue,firstCoupon,rate,pr,redemption,frequency,_basis);if(isError)return errorObject;const[settlementObject,maturityObject,issueObject,firstCouponObject,rateObject,prObject,redemptionObject,frequencyObject,basisObject]=variants,settlementSerialNumber=getDateSerialNumberByObject(settlementObject);if("number"!=typeof settlementSerialNumber)return settlementSerialNumber;const maturitySerialNumber=getDateSerialNumberByObject(maturityObject);if("number"!=typeof maturitySerialNumber)return maturitySerialNumber;const issueSerialNumber=getDateSerialNumberByObject(issueObject);if("number"!=typeof issueSerialNumber)return issueSerialNumber;const firstCouponSerialNumber=getDateSerialNumberByObject(firstCouponObject);if("number"!=typeof firstCouponSerialNumber)return firstCouponSerialNumber;const rateValue=+rateObject.getValue(),prValue=+prObject.getValue(),redemptionValue=+redemptionObject.getValue(),frequencyValue=Math.floor(+frequencyObject.getValue()),basisValue=Math.floor(+basisObject.getValue());return Number.isNaN(rateValue)||Number.isNaN(prValue)||Number.isNaN(redemptionValue)||Number.isNaN(frequencyValue)||Number.isNaN(basisValue)?ErrorValueObject.create(error_type_ErrorType.VALUE):rateValue<0||prValue<=0||redemptionValue<=0||![1,2,4].includes(frequencyValue)||basisValue<0||basisValue>4||!this._validDate(maturitySerialNumber,firstCouponSerialNumber,settlementSerialNumber,issueSerialNumber,frequencyValue)?ErrorValueObject.create(error_type_ErrorType.NUM):this._getResult(settlementSerialNumber,maturitySerialNumber,issueSerialNumber,firstCouponSerialNumber,rateValue,prValue,redemptionValue,frequencyValue,basisValue)}_validDate(maturitySerialNumber,firstCouponSerialNumber,settlementSerialNumber,issueSerialNumber,frequencyValue){return this._getDateCorrectOrder(maturitySerialNumber,firstCouponSerialNumber,settlementSerialNumber,issueSerialNumber)&&validDaysBetweenIsWholeFrequencyByTwoDate(maturitySerialNumber,firstCouponSerialNumber,frequencyValue)&&validCouppcdIsGte0ByTwoDate(issueSerialNumber,maturitySerialNumber,frequencyValue)}_getDateCorrectOrder(maturitySerialNumber,firstCouponSerialNumber,settlementSerialNumber,issueSerialNumber){return Math.floor(maturitySerialNumber)>Math.floor(firstCouponSerialNumber)&&Math.floor(firstCouponSerialNumber)>Math.floor(settlementSerialNumber)&&Math.floor(settlementSerialNumber)>Math.floor(issueSerialNumber)}_getResult(settlementSerialNumber,maturitySerialNumber,issueSerialNumber,firstCouponSerialNumber,rate,pr,redemption,frequency,basis){const{days}=getTwoDateDaysByBasis(settlementSerialNumber,maturitySerialNumber,basis);const result=getResultByGuessIterF((rate*days*100-(pr-100))/(.25*(pr-100)*(1+2*days)+100*days),(yld=>function _iterF(yld){return pr-calculateOddFPrice(settlementSerialNumber,maturitySerialNumber,issueSerialNumber,firstCouponSerialNumber,rate,yld,redemption,frequency,basis)}(yld)));return"number"!=typeof result?result:NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=8,this.maxParams=9}},FUNCTION_NAMES_FINANCIAL.ODDFYIELD],[class Oddlprice extends base_function_BaseFunction{calculate(settlement,maturity,lastInterest,rate,yld,redemption,frequency,basis){let _basis=basis??NumberValueObject.create(0);_basis.isNull()&&(_basis=NumberValueObject.create(0));const{isError,errorObject,variants}=checkVariantsErrorIsNullorArrayOrBoolean(settlement,maturity,lastInterest,rate,yld,redemption,frequency,_basis);if(isError)return errorObject;const[settlementObject,maturityObject,lastInterestObject,rateObject,yldObject,redemptionObject,frequencyObject,basisObject]=variants,settlementSerialNumber=getDateSerialNumberByObject(settlementObject);if("number"!=typeof settlementSerialNumber)return settlementSerialNumber;const maturitySerialNumber=getDateSerialNumberByObject(maturityObject);if("number"!=typeof maturitySerialNumber)return maturitySerialNumber;const lastInterestSerialNumber=getDateSerialNumberByObject(lastInterestObject);if("number"!=typeof lastInterestSerialNumber)return lastInterestSerialNumber;const rateValue=+rateObject.getValue(),yldValue=+yldObject.getValue(),redemptionValue=+redemptionObject.getValue(),frequencyValue=Math.floor(+frequencyObject.getValue()),basisValue=Math.floor(+basisObject.getValue());if(Number.isNaN(rateValue)||Number.isNaN(yldValue)||Number.isNaN(redemptionValue)||Number.isNaN(frequencyValue)||Number.isNaN(basisValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);if(rateValue<0||yldValue<0||redemptionValue<=0||![1,2,4].includes(frequencyValue)||basisValue<0||basisValue>4||!this._validDate(maturitySerialNumber,settlementSerialNumber,lastInterestSerialNumber,frequencyValue))return ErrorValueObject.create(error_type_ErrorType.NUM);const result=this._getResult(settlementSerialNumber,maturitySerialNumber,lastInterestSerialNumber,rateValue,yldValue,redemptionValue,frequencyValue,basisValue);return NumberValueObject.create(result)}_validDate(maturitySerialNumber,settlementSerialNumber,lastInterestSerialNumber,frequencyValue){return Math.floor(maturitySerialNumber)>Math.floor(settlementSerialNumber)&&Math.floor(settlementSerialNumber)>Math.floor(lastInterestSerialNumber)&&validCouppcdIsGte0ByTwoDate(lastInterestSerialNumber,maturitySerialNumber,frequencyValue)}_getResult(settlementSerialNumber,maturitySerialNumber,lastInterestSerialNumber,rate,yld,redemption,frequency,basis){const coupDateSerialNumber=this._getCoupDate(maturitySerialNumber,lastInterestSerialNumber,frequency),fAi=this._getFrac(lastInterestSerialNumber,settlementSerialNumber,coupDateSerialNumber,frequency,basis),fDCi=this._getFrac(lastInterestSerialNumber,maturitySerialNumber,coupDateSerialNumber,frequency,basis),fDSCi=this._getFrac(settlementSerialNumber,maturitySerialNumber,coupDateSerialNumber,frequency,basis);return(redemption*frequency+100*rate*(fDCi-fAi*(1+yld*fDSCi/frequency)))/(yld*fDSCi+frequency)}_getCoupDate(maturitySerialNumber,lastInterestSerialNumber,frequency){const maturityDate=excelSerialToDate(maturitySerialNumber),coupDate=excelSerialToDate(lastInterestSerialNumber);for(coupDate.setUTCFullYear(maturityDate.getUTCFullYear()),coupDate>maturityDate&&coupDate.setUTCFullYear(coupDate.getUTCFullYear()-1);coupDate<maturityDate;)coupDate.setUTCMonth(coupDate.getUTCMonth()+12/frequency);return excelDateSerial(coupDate)}_getFrac(startDateSerialNumber,endDateSerialNumber,coupDateSerialNumber,frequency,basis){const startDate=excelSerialToDate(startDateSerialNumber),endDate=excelSerialToDate(endDateSerialNumber),coupDate=excelSerialToDate(coupDateSerialNumber);for(coupDate.setUTCFullYear(startDate.getUTCFullYear()),coupDate<startDate&&coupDate.setUTCFullYear(coupDate.getUTCFullYear()+1);coupDate>startDate;)coupDate.setUTCMonth(coupDate.getUTCMonth()-12/frequency);let earlyCouponSerialNumber=excelDateSerial(coupDate);coupDate.setUTCMonth(coupDate.getUTCMonth()+12/frequency);let lateCouponSerialNumber=excelDateSerial(coupDate);if(lateCouponSerialNumber>=endDateSerialNumber){const{days}=getTwoDateDaysByBasis(startDateSerialNumber,endDateSerialNumber,basis);return days/calculateCoupdays(earlyCouponSerialNumber,lateCouponSerialNumber,frequency,basis)}const{days:daysF}=getTwoDateDaysByBasis(startDateSerialNumber,lateCouponSerialNumber,basis);let result=daysF/calculateCoupdays(earlyCouponSerialNumber,lateCouponSerialNumber,frequency,basis);const earlyCoupon=excelSerialToDate(lateCouponSerialNumber),lateCoupon=excelSerialToDate(lateCouponSerialNumber);for(lateCoupon.setUTCMonth(lateCoupon.getUTCMonth()+12/frequency);lateCoupon<endDate;)earlyCoupon.setUTCMonth(earlyCoupon.getUTCMonth()+12/frequency),lateCoupon.setUTCMonth(lateCoupon.getUTCMonth()+12/frequency),result+=1;earlyCouponSerialNumber=excelDateSerial(earlyCoupon),lateCouponSerialNumber=excelDateSerial(lateCoupon);const{days:daysL}=getTwoDateDaysByBasis(earlyCouponSerialNumber,endDateSerialNumber,basis);return result+=daysL/calculateCoupdays(earlyCouponSerialNumber,lateCouponSerialNumber,frequency,basis),result}constructor(...args){super(...args),this.minParams=7,this.maxParams=8}},FUNCTION_NAMES_FINANCIAL.ODDLPRICE],[class Oddlyield extends base_function_BaseFunction{calculate(settlement,maturity,lastInterest,rate,pr,redemption,frequency,basis){let _basis=basis??NumberValueObject.create(0);_basis.isNull()&&(_basis=NumberValueObject.create(0));const{isError,errorObject,variants}=checkVariantsErrorIsNullorArrayOrBoolean(settlement,maturity,lastInterest,rate,pr,redemption,frequency,_basis);if(isError)return errorObject;const[settlementObject,maturityObject,lastInterestObject,rateObject,prObject,redemptionObject,frequencyObject,basisObject]=variants,settlementSerialNumber=getDateSerialNumberByObject(settlementObject);if("number"!=typeof settlementSerialNumber)return settlementSerialNumber;const maturitySerialNumber=getDateSerialNumberByObject(maturityObject);if("number"!=typeof maturitySerialNumber)return maturitySerialNumber;const lastInterestSerialNumber=getDateSerialNumberByObject(lastInterestObject);if("number"!=typeof lastInterestSerialNumber)return lastInterestSerialNumber;const rateValue=+rateObject.getValue(),prValue=+prObject.getValue(),redemptionValue=+redemptionObject.getValue(),frequencyValue=Math.floor(+frequencyObject.getValue()),basisValue=Math.floor(+basisObject.getValue());if(Number.isNaN(rateValue)||Number.isNaN(prValue)||Number.isNaN(redemptionValue)||Number.isNaN(frequencyValue)||Number.isNaN(basisValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);if(rateValue<0||prValue<=0||redemptionValue<=0||![1,2,4].includes(frequencyValue)||basisValue<0||basisValue>4||!this._validDate(maturitySerialNumber,settlementSerialNumber,lastInterestSerialNumber,frequencyValue))return ErrorValueObject.create(error_type_ErrorType.NUM);const result=this._getResult(settlementSerialNumber,maturitySerialNumber,lastInterestSerialNumber,rateValue,prValue,redemptionValue,frequencyValue,basisValue);return NumberValueObject.create(result)}_validDate(maturitySerialNumber,settlementSerialNumber,lastInterestSerialNumber,frequencyValue){return Math.floor(maturitySerialNumber)>Math.floor(settlementSerialNumber)&&Math.floor(settlementSerialNumber)>Math.floor(lastInterestSerialNumber)&&validCouppcdIsGte0ByTwoDate(lastInterestSerialNumber,maturitySerialNumber,frequencyValue)}_getResult(settlementSerialNumber,maturitySerialNumber,lastInterestSerialNumber,rate,pr,redemption,frequency,basis){const coupDateSerialNumber=this._getCoupDate(maturitySerialNumber,lastInterestSerialNumber,frequency),fAi=this._getFrac(lastInterestSerialNumber,settlementSerialNumber,coupDateSerialNumber,frequency,basis),fDCi=this._getFrac(lastInterestSerialNumber,maturitySerialNumber,coupDateSerialNumber,frequency,basis),fDSCi=this._getFrac(settlementSerialNumber,maturitySerialNumber,coupDateSerialNumber,frequency,basis);return(frequency*(redemption-pr)+100*rate*(fDCi-fAi))/(fDSCi*pr+100*rate*fAi*fDSCi/frequency)}_getCoupDate(maturitySerialNumber,lastInterestSerialNumber,frequency){const maturityDate=excelSerialToDate(maturitySerialNumber),coupDate=excelSerialToDate(lastInterestSerialNumber);for(coupDate.setUTCFullYear(maturityDate.getUTCFullYear()),coupDate>maturityDate&&coupDate.setUTCFullYear(coupDate.getUTCFullYear()-1);coupDate<maturityDate;)coupDate.setUTCMonth(coupDate.getUTCMonth()+12/frequency);return excelDateSerial(coupDate)}_getFrac(startDateSerialNumber,endDateSerialNumber,coupDateSerialNumber,frequency,basis){const startDate=excelSerialToDate(startDateSerialNumber),endDate=excelSerialToDate(endDateSerialNumber),coupDate=excelSerialToDate(coupDateSerialNumber);for(coupDate.setUTCFullYear(startDate.getUTCFullYear()),coupDate<startDate&&coupDate.setUTCFullYear(coupDate.getUTCFullYear()+1);coupDate>startDate;)coupDate.setUTCMonth(coupDate.getUTCMonth()-12/frequency);let earlyCouponSerialNumber=excelDateSerial(coupDate);coupDate.setUTCMonth(coupDate.getUTCMonth()+12/frequency);let lateCouponSerialNumber=excelDateSerial(coupDate);if(lateCouponSerialNumber>=endDateSerialNumber){const{days}=getTwoDateDaysByBasis(startDateSerialNumber,endDateSerialNumber,basis);return days/calculateCoupdays(earlyCouponSerialNumber,lateCouponSerialNumber,frequency,basis)}const{days:daysF}=getTwoDateDaysByBasis(startDateSerialNumber,lateCouponSerialNumber,basis);let result=daysF/calculateCoupdays(earlyCouponSerialNumber,lateCouponSerialNumber,frequency,basis);const earlyCoupon=excelSerialToDate(lateCouponSerialNumber),lateCoupon=excelSerialToDate(lateCouponSerialNumber);for(lateCoupon.setUTCMonth(lateCoupon.getUTCMonth()+12/frequency);lateCoupon<endDate;)earlyCoupon.setUTCMonth(earlyCoupon.getUTCMonth()+12/frequency),lateCoupon.setUTCMonth(lateCoupon.getUTCMonth()+12/frequency),result+=1;earlyCouponSerialNumber=excelDateSerial(earlyCoupon),lateCouponSerialNumber=excelDateSerial(lateCoupon);const{days:daysL}=getTwoDateDaysByBasis(earlyCouponSerialNumber,endDateSerialNumber,basis);return result+=daysL/calculateCoupdays(earlyCouponSerialNumber,lateCouponSerialNumber,frequency,basis),result}constructor(...args){super(...args),this.minParams=8,this.maxParams=9}},FUNCTION_NAMES_FINANCIAL.ODDLYIELD],[class Pduration extends base_function_BaseFunction{calculate(rate,pv,fv){const maxRowLength=Math.max(rate.isArray()?rate.getRowCount():1,pv.isArray()?pv.getRowCount():1,fv.isArray()?fv.getRowCount():1),maxColumnLength=Math.max(rate.isArray()?rate.getColumnCount():1,pv.isArray()?pv.getColumnCount():1,fv.isArray()?fv.getColumnCount():1),rateArray=expandArrayValueObject(maxRowLength,maxColumnLength,rate,ErrorValueObject.create(error_type_ErrorType.NA)),pvArray=expandArrayValueObject(maxRowLength,maxColumnLength,pv,ErrorValueObject.create(error_type_ErrorType.NA)),fvArray=expandArrayValueObject(maxRowLength,maxColumnLength,fv,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=rateArray.map(((rateObject,rowIndex,columnIndex)=>{const pvObject=pvArray.get(rowIndex,columnIndex),fvObject=fvArray.get(rowIndex,columnIndex),{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(rateObject,pvObject,fvObject);if(isError)return errorObject;const[_rateObject,_pvObject,_fvObject]=variants,rateValue=+_rateObject.getValue(),pvValue=+_pvObject.getValue(),fvValue=+_fvObject.getValue();if(rateValue<=-1)return ErrorValueObject.create(error_type_ErrorType.NUM);const result=(Math.log(fvValue)-Math.log(pvValue))/Math.log(1+rateValue);return Number.isNaN(result)||!Number.isFinite(result)?ErrorValueObject.create(error_type_ErrorType.NUM):NumberValueObject.create(result)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}constructor(...args){super(...args),this.minParams=3,this.maxParams=3}},FUNCTION_NAMES_FINANCIAL.PDURATION],[class Pmt extends base_function_BaseFunction{calculate(rate,nper,pv,fv,type){const _fv=fv??NumberValueObject.create(0),_type=type??NumberValueObject.create(0),maxRowLength=Math.max(rate.isArray()?rate.getRowCount():1,nper.isArray()?nper.getRowCount():1,pv.isArray()?pv.getRowCount():1,_fv.isArray()?_fv.getRowCount():1,_type.isArray()?_type.getRowCount():1),maxColumnLength=Math.max(rate.isArray()?rate.getColumnCount():1,nper.isArray()?nper.getColumnCount():1,pv.isArray()?pv.getColumnCount():1,_fv.isArray()?_fv.getColumnCount():1,_type.isArray()?_type.getColumnCount():1),rateArray=expandArrayValueObject(maxRowLength,maxColumnLength,rate,ErrorValueObject.create(error_type_ErrorType.NA)),nperArray=expandArrayValueObject(maxRowLength,maxColumnLength,nper,ErrorValueObject.create(error_type_ErrorType.NA)),pvArray=expandArrayValueObject(maxRowLength,maxColumnLength,pv,ErrorValueObject.create(error_type_ErrorType.NA)),fvArray=expandArrayValueObject(maxRowLength,maxColumnLength,_fv,ErrorValueObject.create(error_type_ErrorType.NA)),typeArray=expandArrayValueObject(maxRowLength,maxColumnLength,_type,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=rateArray.map(((rateObject,rowIndex,columnIndex)=>{const nperObject=nperArray.get(rowIndex,columnIndex),pvObject=pvArray.get(rowIndex,columnIndex),fvObject=fvArray.get(rowIndex,columnIndex),typeObject=typeArray.get(rowIndex,columnIndex),{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(rateObject,nperObject,pvObject,fvObject,typeObject);if(isError)return errorObject;const[_rateObject,_nperObject,_pvObject,_fvObject,_typeObject]=variants,rateValue=+_rateObject.getValue(),nperValue=+_nperObject.getValue(),pvValue=+_pvObject.getValue(),fvValue=+_fvObject.getValue(),typeValue=+_typeObject.getValue();if(rateValue<=-1)return ErrorValueObject.create(error_type_ErrorType.NUM);const result=calculatePMT(rateValue,nperValue,pvValue,fvValue,typeValue?1:0);return Number.isNaN(result)||!Number.isFinite(result)?ErrorValueObject.create(error_type_ErrorType.NUM):0===rowIndex&&0===columnIndex?NumberValueObject.create(result,getCurrencyFormat(this.getLocale())):NumberValueObject.create(result)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}constructor(...args){super(...args),this.minParams=3,this.maxParams=5,this.needsLocale=!0}},FUNCTION_NAMES_FINANCIAL.PMT],[class Ppmt extends base_function_BaseFunction{calculate(rate,per,nper,pv,fv,type){const _fv=fv??NumberValueObject.create(0),_type=type??NumberValueObject.create(0),maxRowLength=Math.max(rate.isArray()?rate.getRowCount():1,per.isArray()?per.getRowCount():1,nper.isArray()?nper.getRowCount():1,pv.isArray()?pv.getRowCount():1,_fv.isArray()?_fv.getRowCount():1,_type.isArray()?_type.getRowCount():1),maxColumnLength=Math.max(rate.isArray()?rate.getColumnCount():1,per.isArray()?per.getColumnCount():1,nper.isArray()?nper.getColumnCount():1,pv.isArray()?pv.getColumnCount():1,_fv.isArray()?_fv.getColumnCount():1,_type.isArray()?_type.getColumnCount():1),rateArray=expandArrayValueObject(maxRowLength,maxColumnLength,rate,ErrorValueObject.create(error_type_ErrorType.NA)),perArray=expandArrayValueObject(maxRowLength,maxColumnLength,per,ErrorValueObject.create(error_type_ErrorType.NA)),nperArray=expandArrayValueObject(maxRowLength,maxColumnLength,nper,ErrorValueObject.create(error_type_ErrorType.NA)),pvArray=expandArrayValueObject(maxRowLength,maxColumnLength,pv,ErrorValueObject.create(error_type_ErrorType.NA)),fvArray=expandArrayValueObject(maxRowLength,maxColumnLength,_fv,ErrorValueObject.create(error_type_ErrorType.NA)),typeArray=expandArrayValueObject(maxRowLength,maxColumnLength,_type,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=rateArray.map(((rateObject,rowIndex,columnIndex)=>{const perObject=perArray.get(rowIndex,columnIndex),nperObject=nperArray.get(rowIndex,columnIndex),pvObject=pvArray.get(rowIndex,columnIndex),fvObject=fvArray.get(rowIndex,columnIndex),typeObject=typeArray.get(rowIndex,columnIndex),{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(rateObject,perObject,nperObject,pvObject,fvObject,typeObject);if(isError)return errorObject;const[_rateObject,_perObject,_nperObject,_pvObject,_fvObject,_typeObject]=variants,rateValue=+_rateObject.getValue(),perValue=+_perObject.getValue(),nperValue=+_nperObject.getValue(),pvValue=+_pvObject.getValue(),fvValue=+_fvObject.getValue(),typeValue=+_typeObject.getValue();if(perValue<1||Math.floor(perValue)>Math.ceil(nperValue)||perValue-nperValue>=1)return ErrorValueObject.create(error_type_ErrorType.NUM);const result=calculatePMT(rateValue,nperValue,pvValue,fvValue,typeValue?1:0)-calculateIPMT(rateValue,perValue,nperValue,pvValue,fvValue,typeValue?1:0);return Number.isNaN(result)||!Number.isFinite(result)?ErrorValueObject.create(error_type_ErrorType.NUM):0===rowIndex&&0===columnIndex?NumberValueObject.create(result,getCurrencyFormat(this.getLocale())):NumberValueObject.create(result)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}constructor(...args){super(...args),this.minParams=4,this.maxParams=6,this.needsLocale=!0}},FUNCTION_NAMES_FINANCIAL.PPMT],[class Price extends base_function_BaseFunction{calculate(settlement,maturity,rate,yld,redemption,frequency,basis){let _basis=basis??NumberValueObject.create(0);_basis.isNull()&&(_basis=NumberValueObject.create(0));const{isError,errorObject,variants}=checkVariantsErrorIsNullorArrayOrBoolean(settlement,maturity,rate,yld,redemption,frequency,_basis);if(isError)return errorObject;const[settlementObject,maturityObject,rateObject,yldObject,redemptionObject,frequencyObject,basisObject]=variants,settlementSerialNumber=getDateSerialNumberByObject(settlementObject);if("number"!=typeof settlementSerialNumber)return settlementSerialNumber;const maturitySerialNumber=getDateSerialNumberByObject(maturityObject);if("number"!=typeof maturitySerialNumber)return maturitySerialNumber;const rateValue=+rateObject.getValue(),yldValue=+yldObject.getValue(),redemptionValue=+redemptionObject.getValue(),frequencyValue=Math.floor(+frequencyObject.getValue()),basisValue=Math.floor(+basisObject.getValue());if(Number.isNaN(rateValue)||Number.isNaN(yldValue)||Number.isNaN(redemptionValue)||Number.isNaN(frequencyValue)||Number.isNaN(basisValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);if(rateValue<0||yldValue<0||redemptionValue<=0||![1,2,4].includes(frequencyValue)||basisValue<0||basisValue>4||settlementSerialNumber>=maturitySerialNumber||!validCouppcdIsGte0ByTwoDate(settlementSerialNumber,maturitySerialNumber,frequencyValue))return ErrorValueObject.create(error_type_ErrorType.NUM);const result=calculatePrice(settlementSerialNumber,maturitySerialNumber,rateValue,yldValue,redemptionValue,frequencyValue,basisValue);return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=6,this.maxParams=7}},FUNCTION_NAMES_FINANCIAL.PRICE],[class Pricedisc extends base_function_BaseFunction{calculate(settlement,maturity,discount,redemption,basis){let _basis=basis??NumberValueObject.create(0);_basis.isNull()&&(_basis=NumberValueObject.create(0));const{isError,errorObject,variants}=checkVariantsErrorIsNullorArrayOrBoolean(settlement,maturity,discount,redemption,_basis);if(isError)return errorObject;const[settlementObject,maturityObject,discountObject,redemptionObject,basisObject]=variants,settlementSerialNumber=getDateSerialNumberByObject(settlementObject);if("number"!=typeof settlementSerialNumber)return settlementSerialNumber;const maturitySerialNumber=getDateSerialNumberByObject(maturityObject);if("number"!=typeof maturitySerialNumber)return maturitySerialNumber;const discountValue=+discountObject.getValue(),redemptionValue=+redemptionObject.getValue(),basisValue=Math.floor(+basisObject.getValue());if(Number.isNaN(discountValue)||Number.isNaN(redemptionValue)||Number.isNaN(basisValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);if(discountValue<=0||redemptionValue<=0||basisValue<0||basisValue>4||settlementSerialNumber>=maturitySerialNumber)return ErrorValueObject.create(error_type_ErrorType.NUM);const{days:DSM,yearDays:B}=getTwoDateDaysByBasis(settlementSerialNumber,maturitySerialNumber,basisValue),result=redemptionValue-discountValue*redemptionValue*DSM/B;return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=4,this.maxParams=5}},FUNCTION_NAMES_FINANCIAL.PRICEDISC],[class Pricemat extends base_function_BaseFunction{calculate(settlement,maturity,issue,rate,yld,basis){let _basis=basis??NumberValueObject.create(0);_basis.isNull()&&(_basis=NumberValueObject.create(0));const{isError,errorObject,variants}=checkVariantsErrorIsNullorArrayOrBoolean(settlement,maturity,issue,rate,yld,_basis);if(isError)return errorObject;const[settlementObject,maturityObject,issueObject,rateObject,yldObject,basisObject]=variants,settlementSerialNumber=getDateSerialNumberByObject(settlementObject);if("number"!=typeof settlementSerialNumber)return settlementSerialNumber;const maturitySerialNumber=getDateSerialNumberByObject(maturityObject);if("number"!=typeof maturitySerialNumber)return maturitySerialNumber;const issueSerialNumber=getDateSerialNumberByObject(issueObject);if("number"!=typeof issueSerialNumber)return issueSerialNumber;const rateValue=+rateObject.getValue(),yldValue=+yldObject.getValue(),basisValue=Math.floor(+basisObject.getValue());if(Number.isNaN(rateValue)||Number.isNaN(yldValue)||Number.isNaN(basisValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);const isCorrectOrder=this._getDateCorrectOrder(maturitySerialNumber,settlementSerialNumber,issueSerialNumber);if(rateValue<0||yldValue<0||basisValue<0||basisValue>4||!isCorrectOrder)return ErrorValueObject.create(error_type_ErrorType.NUM);const B=getNormalYearDaysByBasis(settlementSerialNumber,basisValue),{days:DSM}=getTwoDateDaysByBasis(settlementSerialNumber,maturitySerialNumber,basisValue),{days:DIM}=getTwoDateDaysByBasis(issueSerialNumber,maturitySerialNumber,basisValue),{days:A}=getTwoDateDaysByBasis(issueSerialNumber,settlementSerialNumber,basisValue),result=(100+DIM/B*rateValue*100)/(1+DSM/B*yldValue)-A/B*rateValue*100;return NumberValueObject.create(result)}_getDateCorrectOrder(maturitySerialNumber,settlementSerialNumber,issueSerialNumber){return Math.floor(maturitySerialNumber)>Math.floor(settlementSerialNumber)&&Math.floor(settlementSerialNumber)>Math.floor(issueSerialNumber)}constructor(...args){super(...args),this.minParams=5,this.maxParams=6}},FUNCTION_NAMES_FINANCIAL.PRICEMAT],[class Pv extends base_function_BaseFunction{calculate(rate,nper,pmt,fv,type){const _fv=fv??NumberValueObject.create(0),_type=type??NumberValueObject.create(0),maxRowLength=Math.max(rate.isArray()?rate.getRowCount():1,nper.isArray()?nper.getRowCount():1,pmt.isArray()?pmt.getRowCount():1,_fv.isArray()?_fv.getRowCount():1,_type.isArray()?_type.getRowCount():1),maxColumnLength=Math.max(rate.isArray()?rate.getColumnCount():1,nper.isArray()?nper.getColumnCount():1,pmt.isArray()?pmt.getColumnCount():1,_fv.isArray()?_fv.getColumnCount():1,_type.isArray()?_type.getColumnCount():1),rateArray=expandArrayValueObject(maxRowLength,maxColumnLength,rate,ErrorValueObject.create(error_type_ErrorType.NA)),nperArray=expandArrayValueObject(maxRowLength,maxColumnLength,nper,ErrorValueObject.create(error_type_ErrorType.NA)),pmtArray=expandArrayValueObject(maxRowLength,maxColumnLength,pmt,ErrorValueObject.create(error_type_ErrorType.NA)),fvArray=expandArrayValueObject(maxRowLength,maxColumnLength,_fv,ErrorValueObject.create(error_type_ErrorType.NA)),typeArray=expandArrayValueObject(maxRowLength,maxColumnLength,_type,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=rateArray.map(((rateObject,rowIndex,columnIndex)=>{const nperObject=nperArray.get(rowIndex,columnIndex),pmtObject=pmtArray.get(rowIndex,columnIndex),fvObject=fvArray.get(rowIndex,columnIndex),typeObject=typeArray.get(rowIndex,columnIndex),{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(rateObject,nperObject,pmtObject,fvObject,typeObject);if(isError)return errorObject;const[_rateObject,_nperObject,_pmtObject,_fvObject,_typeObject]=variants,rateValue=+_rateObject.getValue(),nperValue=+_nperObject.getValue(),pmtValue=+_pmtObject.getValue(),fvValue=+_fvObject.getValue();let typeValue=+_typeObject.getValue();typeValue=typeValue?1:0;const result=0===rateValue?-pmtValue*nperValue-fvValue:((1-(1+rateValue)**nperValue)/rateValue*pmtValue*(1+rateValue*typeValue)-fvValue)/(1+rateValue)**nperValue;return Number.isNaN(result)||!Number.isFinite(result)?ErrorValueObject.create(error_type_ErrorType.NUM):0===rowIndex&&0===columnIndex?NumberValueObject.create(result,getCurrencyFormat(this.getLocale())):NumberValueObject.create(result)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}constructor(...args){super(...args),this.minParams=3,this.maxParams=5,this.needsLocale=!0}},FUNCTION_NAMES_FINANCIAL.PV],[class Rate extends base_function_BaseFunction{calculate(nper,pmt,pv,fv,type,guess){const _fv=fv??NumberValueObject.create(0),_type=type??NumberValueObject.create(0),_guess=guess??NumberValueObject.create(.1),maxRowLength=Math.max(nper.isArray()?nper.getRowCount():1,pmt.isArray()?pmt.getRowCount():1,pv.isArray()?pv.getRowCount():1,_fv.isArray()?_fv.getRowCount():1,_type.isArray()?_type.getRowCount():1,_guess.isArray()?_guess.getRowCount():1),maxColumnLength=Math.max(nper.isArray()?nper.getColumnCount():1,pmt.isArray()?pmt.getColumnCount():1,pv.isArray()?pv.getColumnCount():1,_fv.isArray()?_fv.getColumnCount():1,_type.isArray()?_type.getColumnCount():1,_guess.isArray()?_guess.getColumnCount():1),nperArray=expandArrayValueObject(maxRowLength,maxColumnLength,nper,ErrorValueObject.create(error_type_ErrorType.NA)),pmtArray=expandArrayValueObject(maxRowLength,maxColumnLength,pmt,ErrorValueObject.create(error_type_ErrorType.NA)),pvArray=expandArrayValueObject(maxRowLength,maxColumnLength,pv,ErrorValueObject.create(error_type_ErrorType.NA)),fvArray=expandArrayValueObject(maxRowLength,maxColumnLength,_fv,ErrorValueObject.create(error_type_ErrorType.NA)),typeArray=expandArrayValueObject(maxRowLength,maxColumnLength,_type,ErrorValueObject.create(error_type_ErrorType.NA)),guessArray=expandArrayValueObject(maxRowLength,maxColumnLength,_guess,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=nperArray.map(((nperObject,rowIndex,columnIndex)=>{const pmtObject=pmtArray.get(rowIndex,columnIndex),pvObject=pvArray.get(rowIndex,columnIndex),fvObject=fvArray.get(rowIndex,columnIndex),typeObject=typeArray.get(rowIndex,columnIndex),guessObject=guessArray.get(rowIndex,columnIndex),{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(nperObject,pmtObject,pvObject,fvObject,typeObject,guessObject);if(isError)return errorObject;const[_nperObject,_pmtObject,_pvObject,_fvObject,_typeObject,_guessObject]=variants,nperValue=+_nperObject.getValue(),pmtValue=+_pmtObject.getValue(),pvValue=+_pvObject.getValue(),fvValue=+_fvObject.getValue();let typeValue=+_typeObject.getValue();const guessValue=+_guessObject.getValue();return typeValue=typeValue?1:0,nperValue<=0||pmtValue>=0?ErrorValueObject.create(error_type_ErrorType.NUM):this._getResult(nperValue,pmtValue,pvValue,fvValue,typeValue,guessValue,rowIndex,columnIndex)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_getResult(nperValue,pmtValue,pvValue,fvValue,typeValue,guessValue,rowIndex,columnIndex){let result=guessValue;for(let i=0;i<20;i++){if(result<=-1)return ErrorValueObject.create(error_type_ErrorType.NUM);let y,f,dy;if(Math.abs(result)<1e-10?y=pvValue*(1+nperValue*result)+pmtValue*(1+result*typeValue)*nperValue+fvValue:(f=(1+result)**nperValue,y=pvValue*f+pmtValue*(1/result+typeValue)*(f-1)+fvValue),Math.abs(y)<1e-10)break;if(Math.abs(result)<1e-10)dy=pvValue*nperValue+pmtValue*typeValue*nperValue;else{f=(1+result)**nperValue;const df=nperValue*(1+result)**(nperValue-1);dy=pvValue*df+pmtValue*(1/result+typeValue)*df+pmtValue*(-1/(result*result))*(f-1)}result-=y/dy}return 0===rowIndex&&0===columnIndex?NumberValueObject.create(result,"0%"):NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=3,this.maxParams=6}},FUNCTION_NAMES_FINANCIAL.RATE],[class Received extends base_function_BaseFunction{calculate(settlement,maturity,investment,discount,basis){let _basis=basis??NumberValueObject.create(0);_basis.isNull()&&(_basis=NumberValueObject.create(0));const{isError,errorObject,variants}=checkVariantsErrorIsNullorArrayOrBoolean(settlement,maturity,investment,discount,_basis);if(isError)return errorObject;const[settlementObject,maturityObject,investmentObject,discountObject,basisObject]=variants,settlementSerialNumber=getDateSerialNumberByObject(settlementObject);if("number"!=typeof settlementSerialNumber)return settlementSerialNumber;const maturitySerialNumber=getDateSerialNumberByObject(maturityObject);if("number"!=typeof maturitySerialNumber)return maturitySerialNumber;const investmentValue=+investmentObject.getValue(),discountValue=+discountObject.getValue(),basisValue=Math.floor(+basisObject.getValue());if(Number.isNaN(investmentValue)||Number.isNaN(discountValue)||Number.isNaN(basisValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);if(investmentValue<=0||discountValue<=0||basisValue<0||basisValue>4||settlementSerialNumber>=maturitySerialNumber)return ErrorValueObject.create(error_type_ErrorType.NUM);const{days:DSM,yearDays:B}=getTwoDateDaysByBasis(settlementSerialNumber,maturitySerialNumber,basisValue),result=investmentValue/(1-discountValue*DSM/B);return result<0?ErrorValueObject.create(error_type_ErrorType.NUM):NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=4,this.maxParams=5}},FUNCTION_NAMES_FINANCIAL.RECEIVED],[class Rri extends base_function_BaseFunction{calculate(nper,pv,fv){const maxRowLength=Math.max(nper.isArray()?nper.getRowCount():1,pv.isArray()?pv.getRowCount():1,fv.isArray()?fv.getRowCount():1),maxColumnLength=Math.max(nper.isArray()?nper.getColumnCount():1,pv.isArray()?pv.getColumnCount():1,fv.isArray()?fv.getColumnCount():1),nperArray=expandArrayValueObject(maxRowLength,maxColumnLength,nper,ErrorValueObject.create(error_type_ErrorType.NA)),pvArray=expandArrayValueObject(maxRowLength,maxColumnLength,pv,ErrorValueObject.create(error_type_ErrorType.NA)),fvArray=expandArrayValueObject(maxRowLength,maxColumnLength,fv,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=nperArray.map(((nperObject,rowIndex,columnIndex)=>{const pvObject=pvArray.get(rowIndex,columnIndex),fvObject=fvArray.get(rowIndex,columnIndex),{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(nperObject,pvObject,fvObject);if(isError)return errorObject;const[_nperObject,_pvObject,_fvObject]=variants,nperValue=+_nperObject.getValue(),pvValue=+_pvObject.getValue(),fvValue=+_fvObject.getValue();if(nperValue<=0)return ErrorValueObject.create(error_type_ErrorType.NUM);if(0===pvValue&&0===fvValue)return NumberValueObject.create(0);const result=(fvValue/pvValue)**(1/nperValue)-1;return Number.isNaN(result)||!Number.isFinite(result)||fvValue/pvValue<0?ErrorValueObject.create(error_type_ErrorType.NUM):NumberValueObject.create(result)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}constructor(...args){super(...args),this.minParams=3,this.maxParams=6}},FUNCTION_NAMES_FINANCIAL.RRI],[class Sln extends base_function_BaseFunction{calculate(cost,salvage,life){const maxRowLength=Math.max(cost.isArray()?cost.getRowCount():1,salvage.isArray()?salvage.getRowCount():1,life.isArray()?life.getRowCount():1),maxColumnLength=Math.max(cost.isArray()?cost.getColumnCount():1,salvage.isArray()?salvage.getColumnCount():1,life.isArray()?life.getColumnCount():1),costArray=expandArrayValueObject(maxRowLength,maxColumnLength,cost,ErrorValueObject.create(error_type_ErrorType.NA)),salvageArray=expandArrayValueObject(maxRowLength,maxColumnLength,salvage,ErrorValueObject.create(error_type_ErrorType.NA)),lifeArray=expandArrayValueObject(maxRowLength,maxColumnLength,life,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=costArray.map(((costObject,rowIndex,columnIndex)=>{const salvageObject=salvageArray.get(rowIndex,columnIndex),lifeObject=lifeArray.get(rowIndex,columnIndex);if(salvageObject.isError())return salvageObject;if(lifeObject.isError())return lifeObject;const costValue=+costObject.getValue(),salvageValue=+salvageObject.getValue(),lifeValue=+lifeObject.getValue();if(Number.isNaN(costValue)||Number.isNaN(salvageValue)||Number.isNaN(lifeValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);if(0===lifeValue)return ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO);const result=(costValue-salvageValue)/lifeValue;return 0===rowIndex&&0===columnIndex?NumberValueObject.create(result,getCurrencyFormat(this.getLocale())):NumberValueObject.create(result)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}constructor(...args){super(...args),this.minParams=3,this.maxParams=3,this.needsLocale=!0}},FUNCTION_NAMES_FINANCIAL.SLN],[class Syd extends base_function_BaseFunction{calculate(cost,salvage,life,per){const maxRowLength=Math.max(cost.isArray()?cost.getRowCount():1,salvage.isArray()?salvage.getRowCount():1,life.isArray()?life.getRowCount():1,per.isArray()?per.getRowCount():1),maxColumnLength=Math.max(cost.isArray()?cost.getColumnCount():1,salvage.isArray()?salvage.getColumnCount():1,life.isArray()?life.getColumnCount():1,per.isArray()?per.getColumnCount():1),costArray=expandArrayValueObject(maxRowLength,maxColumnLength,cost,ErrorValueObject.create(error_type_ErrorType.NA)),salvageArray=expandArrayValueObject(maxRowLength,maxColumnLength,salvage,ErrorValueObject.create(error_type_ErrorType.NA)),lifeArray=expandArrayValueObject(maxRowLength,maxColumnLength,life,ErrorValueObject.create(error_type_ErrorType.NA)),perArray=expandArrayValueObject(maxRowLength,maxColumnLength,per,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=costArray.map(((costObject,rowIndex,columnIndex)=>{const salvageObject=salvageArray.get(rowIndex,columnIndex),lifeObject=lifeArray.get(rowIndex,columnIndex),perObject=perArray.get(rowIndex,columnIndex);if(salvageObject.isError())return salvageObject;if(lifeObject.isError())return lifeObject;if(perObject.isError())return perObject;const costValue=+costObject.getValue(),salvageValue=+salvageObject.getValue(),lifeValue=+lifeObject.getValue(),perValue=+perObject.getValue();if(Number.isNaN(costValue)||Number.isNaN(salvageValue)||Number.isNaN(lifeValue)||Number.isNaN(perValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);if(salvageValue<0||lifeValue<=0||perValue>lifeValue)return ErrorValueObject.create(error_type_ErrorType.NUM);const result=(costValue-salvageValue)*(lifeValue-perValue+1)*2/(lifeValue*(lifeValue+1));return 0===rowIndex&&0===columnIndex?NumberValueObject.create(result,getCurrencyFormat(this.getLocale())):NumberValueObject.create(result)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}constructor(...args){super(...args),this.minParams=4,this.maxParams=4,this.needsLocale=!0}},FUNCTION_NAMES_FINANCIAL.SYD],[class Tbilleq extends base_function_BaseFunction{calculate(settlement,maturity,discount){const{isError,errorObject,variants}=checkVariantsErrorIsNullorArrayOrBoolean(settlement,maturity,discount);if(isError)return errorObject;const[settlementObject,maturityObject,discountObject]=variants,settlementSerialNumber=getDateSerialNumberByObject(settlementObject);if("number"!=typeof settlementSerialNumber)return settlementSerialNumber;const maturitySerialNumber=getDateSerialNumberByObject(maturityObject);if("number"!=typeof maturitySerialNumber)return maturitySerialNumber;const discountValue=+discountObject.getValue();if(Number.isNaN(discountValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);if(discountValue<=0||settlementSerialNumber>=maturitySerialNumber)return ErrorValueObject.create(error_type_ErrorType.NUM);const DSM=Math.floor(maturitySerialNumber)-Math.floor(settlementSerialNumber);if(DSM>getDaysInYear(excelSerialToDate(settlementSerialNumber).getUTCFullYear()))return ErrorValueObject.create(error_type_ErrorType.NUM);let result=365*discountValue/(360-discountValue*DSM);if(DSM>182){const tbillPrice=100*(1-discountValue*DSM/360),fraction=DSM/365;if(result=(-fraction+Math.sqrt(fraction*fraction-(2*fraction-1)*(1-100/tbillPrice)))/(fraction-.5),Number.isNaN(result))return ErrorValueObject.create(error_type_ErrorType.NUM)}return result<0?ErrorValueObject.create(error_type_ErrorType.NUM):NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=3,this.maxParams=3}},FUNCTION_NAMES_FINANCIAL.TBILLEQ],[class Tbillprice extends base_function_BaseFunction{calculate(settlement,maturity,discount){const{isError,errorObject,variants}=checkVariantsErrorIsNullorArrayOrBoolean(settlement,maturity,discount);if(isError)return errorObject;const[settlementObject,maturityObject,discountObject]=variants,settlementSerialNumber=getDateSerialNumberByObject(settlementObject);if("number"!=typeof settlementSerialNumber)return settlementSerialNumber;const maturitySerialNumber=getDateSerialNumberByObject(maturityObject);if("number"!=typeof maturitySerialNumber)return maturitySerialNumber;const discountValue=+discountObject.getValue();if(Number.isNaN(discountValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);if(discountValue<=0||settlementSerialNumber>=maturitySerialNumber)return ErrorValueObject.create(error_type_ErrorType.NUM);const DSM=Math.floor(maturitySerialNumber)-Math.floor(settlementSerialNumber);if(DSM>getDaysInYear(excelSerialToDate(settlementSerialNumber).getUTCFullYear()))return ErrorValueObject.create(error_type_ErrorType.NUM);const result=100*(1-discountValue*DSM/360);return result<0?ErrorValueObject.create(error_type_ErrorType.NUM):NumberValueObject.create(result,getCurrencyFormat(this.getLocale()))}constructor(...args){super(...args),this.minParams=3,this.maxParams=3,this.needsLocale=!0}},FUNCTION_NAMES_FINANCIAL.TBILLPRICE],[class Tbillyield extends base_function_BaseFunction{calculate(settlement,maturity,pr){const{isError,errorObject,variants}=checkVariantsErrorIsNullorArrayOrBoolean(settlement,maturity,pr);if(isError)return errorObject;const[settlementObject,maturityObject,prObject]=variants,settlementSerialNumber=getDateSerialNumberByObject(settlementObject);if("number"!=typeof settlementSerialNumber)return settlementSerialNumber;const maturitySerialNumber=getDateSerialNumberByObject(maturityObject);if("number"!=typeof maturitySerialNumber)return maturitySerialNumber;const prValue=+prObject.getValue();if(Number.isNaN(prValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);if(prValue<=0||settlementSerialNumber>=maturitySerialNumber)return ErrorValueObject.create(error_type_ErrorType.NUM);const DSM=Math.floor(maturitySerialNumber)-Math.floor(settlementSerialNumber);if(DSM>getDaysInYear(excelSerialToDate(settlementSerialNumber).getUTCFullYear()))return ErrorValueObject.create(error_type_ErrorType.NUM);const result=(100-prValue)/prValue*360/DSM;return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=3,this.maxParams=3}},FUNCTION_NAMES_FINANCIAL.TBILLYIELD],[class Vdb extends base_function_BaseFunction{calculate(cost,salvage,life,startPeriod,endPeriod,factor,noSwitch){let _factor=factor??NumberValueObject.create(2);_factor.isNull()&&(_factor=NumberValueObject.create(2));let _noSwitch=noSwitch??BooleanValueObject.create(!1);_noSwitch.isNull()&&(_noSwitch=BooleanValueObject.create(!1));const maxRowLength=Math.max(cost.isArray()?cost.getRowCount():1,salvage.isArray()?salvage.getRowCount():1,life.isArray()?life.getRowCount():1,startPeriod.isArray()?startPeriod.getRowCount():1,endPeriod.isArray()?endPeriod.getRowCount():1,_factor.isArray()?_factor.getRowCount():1,_noSwitch.isArray()?_noSwitch.getRowCount():1),maxColumnLength=Math.max(cost.isArray()?cost.getColumnCount():1,salvage.isArray()?salvage.getColumnCount():1,life.isArray()?life.getColumnCount():1,startPeriod.isArray()?startPeriod.getColumnCount():1,endPeriod.isArray()?endPeriod.getColumnCount():1,_factor.isArray()?_factor.getColumnCount():1,_noSwitch.isArray()?_noSwitch.getColumnCount():1),costArray=expandArrayValueObject(maxRowLength,maxColumnLength,cost,ErrorValueObject.create(error_type_ErrorType.NA)),salvageArray=expandArrayValueObject(maxRowLength,maxColumnLength,salvage,ErrorValueObject.create(error_type_ErrorType.NA)),lifeArray=expandArrayValueObject(maxRowLength,maxColumnLength,life,ErrorValueObject.create(error_type_ErrorType.NA)),startPeriodArray=expandArrayValueObject(maxRowLength,maxColumnLength,startPeriod,ErrorValueObject.create(error_type_ErrorType.NA)),endPeriodArray=expandArrayValueObject(maxRowLength,maxColumnLength,endPeriod,ErrorValueObject.create(error_type_ErrorType.NA)),factorArray=expandArrayValueObject(maxRowLength,maxColumnLength,_factor,ErrorValueObject.create(error_type_ErrorType.NA)),noSwitchArray=expandArrayValueObject(maxRowLength,maxColumnLength,_noSwitch,ErrorValueObject.create(error_type_ErrorType.NA));return this._getResultArray(costArray,salvageArray,lifeArray,startPeriodArray,endPeriodArray,factorArray,noSwitchArray,maxRowLength,maxColumnLength)}_getResultArray(costArray,salvageArray,lifeArray,startPeriodArray,endPeriodArray,factorArray,noSwitchArray,maxRowLength,maxColumnLength){const resultArray=costArray.map(((costObject,rowIndex,columnIndex)=>{const salvageObject=salvageArray.get(rowIndex,columnIndex),lifeObject=lifeArray.get(rowIndex,columnIndex),startPeriodObject=startPeriodArray.get(rowIndex,columnIndex),endPeriodObject=endPeriodArray.get(rowIndex,columnIndex),factorObject=factorArray.get(rowIndex,columnIndex),noSwitchObject=noSwitchArray.get(rowIndex,columnIndex),{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(costObject,salvageObject,lifeObject,startPeriodObject,endPeriodObject,factorObject,noSwitchObject);if(isError)return errorObject;const[_costObject,_salvageObject,_lifeObject,_startPeriodObject,_endPeriodObject,_factorObject,_noSwitchObject]=variants,costValue=+_costObject.getValue(),salvageValue=+_salvageObject.getValue(),lifeValue=+_lifeObject.getValue(),startPeriodValue=+_startPeriodObject.getValue(),endPeriodValue=+_endPeriodObject.getValue(),factorValue=+_factorObject.getValue(),noSwitchValue=+_noSwitchObject.getValue();if(costValue<0||salvageValue<0||lifeValue<0||startPeriodValue<0||endPeriodValue<0||endPeriodValue>lifeValue||startPeriodValue>endPeriodValue||factorValue<0)return ErrorValueObject.create(error_type_ErrorType.NUM);if(0===lifeValue&&0===startPeriodValue&&0===endPeriodValue)return ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO);const result=this._getResult(costValue,salvageValue,lifeValue,startPeriodValue,endPeriodValue,factorValue,noSwitchValue);return 0===rowIndex&&0===columnIndex?NumberValueObject.create(result,getCurrencyFormat(this.getLocale())):NumberValueObject.create(result)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_getResult(cost,salvage,life,startPeriod,endPeriod,factor,noSwitch){const start=Math.floor(startPeriod),end=Math.ceil(endPeriod);let result=0;if(cost<salvage){if(startPeriod>=1||noSwitch)return result;const tempMinus=Math.abs(cost-salvage);return result=tempMinus*(endPeriod-startPeriod)>tempMinus?tempMinus:tempMinus*(endPeriod-startPeriod),-result}if(noSwitch)for(let i=start+1;i<=end;i++){let ddb=calculateDDB(cost,salvage,life,i,factor);i===start+1?ddb*=Math.min(endPeriod,start+1)-startPeriod:i===end&&(ddb*=endPeriod+1-end),result+=ddb}else{const _cost=cost-this._getVdb(cost,salvage,life,life,startPeriod,factor);result=this._getVdb(_cost,salvage,life,life-startPeriod,endPeriod-startPeriod,factor)}return result}_getVdb(cost,salvage,life,startPeriod,endPeriod,factor){const end=Math.ceil(endPeriod);let result=0,rest=cost-salvage,sln=0,temp=0,flag=!1;for(let i=1;i<=end;i++){if(flag)temp=sln;else{const ddb=calculateDDB(cost,salvage,life,i,factor);sln=rest/(startPeriod-(i-1)),sln>ddb?(temp=sln,flag=!0):(temp=ddb,rest-=ddb)}i===end&&(temp*=endPeriod+1-end),result+=temp}return result}constructor(...args){super(...args),this.minParams=5,this.maxParams=7,this.needsLocale=!0}},FUNCTION_NAMES_FINANCIAL.VDB],[class Xirr extends base_function_BaseFunction{calculate(values,dates,guess){if(values.isNull()||dates.isNull())return ErrorValueObject.create(error_type_ErrorType.NA);const{isError,errorObejct,_values,_dates}=this._checkErrors(values,dates);if(isError)return errorObejct;let _guess=guess??NumberValueObject.create(.1);_guess.isNull()&&(_guess=NumberValueObject.create(.1));const{isError:_isError_guess,errorObject:_errorObject_guess,variants}=checkVariantsErrorIsArrayOrBoolean(_guess);if(_isError_guess)return _errorObject_guess;const[guessObject]=variants,guessValue=+guessObject.getValue();if(Number.isNaN(guessValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);const{positive,negative}=this._checkValues(_values);if(!positive||!negative||_values?.length!==_dates?.length||guessValue<0)return ErrorValueObject.create(error_type_ErrorType.NUM);const result=getResultByGuessIterF(guessValue,(rate=>this._iterF(_values,_dates,rate)));return"number"!=typeof result?result:NumberValueObject.create(result)}_checkErrors(values,dates){if(values.isError())return{isError:!0,errorObejct:values};if(dates.isError())return{isError:!0,errorObejct:dates};const{isError:isError_values,errorObejct:errorObejct_values,_values}=this._checkErrorValues(values);if(isError_values)return{isError:isError_values,errorObejct:errorObejct_values};const{isError:isError_dates,errorObejct:errorObejct_dates,_dates}=this._checkErrorDates(dates);return isError_dates?{isError:isError_dates,errorObejct:errorObejct_dates}:{isError:!1,_values,_dates}}_checkErrorValues(values){const _values=[];if(values.isArray()){let isError=!1,errorObejct=ErrorValueObject.create(error_type_ErrorType.VALUE);return values.iterator((valuesObject=>{const _valuesObject=valuesObject;if(_valuesObject.isError())return isError=!0,errorObejct=_valuesObject,!1;if(_valuesObject.isBoolean())return isError=!0,errorObejct=ErrorValueObject.create(error_type_ErrorType.VALUE),!1;const value=+_valuesObject.getValue();if(Number.isNaN(value))return isError=!0,errorObejct=ErrorValueObject.create(error_type_ErrorType.VALUE),!1;_values.push(value)})),isError?{isError,errorObejct}:_values.length<=1?{isError:!0,errorObejct:ErrorValueObject.create(error_type_ErrorType.NA)}:{isError,_values}}{const valuesValue=values.getValue();return values.isBoolean()||values.isString()&&!(0,src.DMQ)(valuesValue)?{isError:!0,errorObejct:ErrorValueObject.create(error_type_ErrorType.VALUE)}:{isError:!0,errorObejct:ErrorValueObject.create(error_type_ErrorType.NA)}}}_checkErrorDates(dates){const _dates=[];if(dates.isArray()){let isError=!1,errorObejct=ErrorValueObject.create(error_type_ErrorType.VALUE);return dates.iterator((datesObject=>{if(datesObject?.isError())return isError=!0,errorObejct=datesObject,!1;if(datesObject?.isBoolean())return isError=!0,errorObejct=ErrorValueObject.create(error_type_ErrorType.VALUE),!1;const datesValue=+datesObject.getValue();return Number.isNaN(datesValue)?(isError=!0,errorObejct=ErrorValueObject.create(error_type_ErrorType.VALUE),!1):datesValue<0?(isError=!0,errorObejct=ErrorValueObject.create(error_type_ErrorType.NUM),!1):void _dates.push(Math.floor(datesValue))})),isError?{isError,errorObejct}:_dates.length<=1?{isError:!0,errorObejct:ErrorValueObject.create(error_type_ErrorType.NA)}:{isError,_dates}}{const datesValue=dates.getValue();return dates.isBoolean()||dates.isString()&&!(0,src.DMQ)(datesValue)?{isError:!0,errorObejct:ErrorValueObject.create(error_type_ErrorType.VALUE)}:+datesValue<0?{isError:!0,errorObejct:ErrorValueObject.create(error_type_ErrorType.NUM)}:{isError:!0,errorObejct:ErrorValueObject.create(error_type_ErrorType.NA)}}}_checkValues(values){let positive=!1,negative=!1;for(let i=0;i<values.length;i++)values[i]>0&&(positive=!0),values[i]<0&&(negative=!0);return{positive,negative}}_iterF(values,dates,rate){return values.reduce(((total,value,index)=>total+value/(1+rate)**((dates[index]-dates[0])/365)),0)}constructor(...args){super(...args),this.minParams=2,this.maxParams=3}},FUNCTION_NAMES_FINANCIAL.XIRR],[class Xnpv extends base_function_BaseFunction{calculate(rate,values,dates){if(rate.isNull()||values.isNull()||dates.isNull())return ErrorValueObject.create(error_type_ErrorType.NA);const{isError:_isError_rate,errorObject:_errorObject_rate,variants}=checkVariantsErrorIsArrayOrBoolean(rate);if(_isError_rate)return _errorObject_rate;const[rateObject]=variants,rateValue=+rateObject.getValue();if(Number.isNaN(rateValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);let{isError,errorObejct,_values,_dates}=this._checkErrors(values,dates);if(isError)return errorObejct;if(rateValue<0||_values.length!==_dates.length)return ErrorValueObject.create(error_type_ErrorType.NUM);let result=0;const d1=_dates[0];for(let i=0;i<_dates.length;i++){const di=_dates[i];result+=_values[i]/(1+rateValue)**((di-d1)/365)}return NumberValueObject.create(result)}_checkErrors(values,dates){if(values.isError())return{isError:!0,errorObejct:values};if(dates.isError())return{isError:!0,errorObejct:dates};const{isError:isError_values,errorObejct:errorObejct_values,_values}=this._checkErrorValues(values);if(isError_values)return{isError:isError_values,errorObejct:errorObejct_values};const{isError:isError_dates,errorObejct:errorObejct_dates,_dates}=this._checkErrorDates(dates);return isError_dates?{isError:isError_dates,errorObejct:errorObejct_dates}:{isError:!1,_values,_dates}}_checkErrorValues(values){const _values=[];if(values.isArray()){let isError=!1,errorObejct=ErrorValueObject.create(error_type_ErrorType.VALUE);return values.iterator((valuesObject=>{const _valuesObject=valuesObject;if(_valuesObject.isError())return isError=!0,errorObejct=_valuesObject,!1;if(_valuesObject.isNull()||_valuesObject.isBoolean())return isError=!0,errorObejct=ErrorValueObject.create(error_type_ErrorType.VALUE),!1;const value=+_valuesObject.getValue();if(Number.isNaN(value))return isError=!0,errorObejct=ErrorValueObject.create(error_type_ErrorType.VALUE),!1;_values.push(value)})),isError?{isError,errorObejct}:_values.length<=1?{isError:!0,errorObejct:ErrorValueObject.create(error_type_ErrorType.NA)}:{isError,_values}}{const valuesValue=values.getValue();return values.isNull()||values.isBoolean()||values.isString()&&!(0,src.DMQ)(valuesValue)?{isError:!0,errorObejct:ErrorValueObject.create(error_type_ErrorType.VALUE)}:{isError:!0,errorObejct:ErrorValueObject.create(error_type_ErrorType.NA)}}}_checkErrorDates(dates){const _dates=[];if(dates.isArray()){let isError=!1,errorObejct=ErrorValueObject.create(error_type_ErrorType.VALUE);return dates.iterator((datesObject=>{const _datesObject=datesObject;if(_datesObject.isError())return isError=!0,errorObejct=_datesObject,!1;if(_datesObject.isNull()||_datesObject.isBoolean())return isError=!0,errorObejct=ErrorValueObject.create(error_type_ErrorType.VALUE),!1;const datesValue=+_datesObject.getValue();return Number.isNaN(datesValue)?(isError=!0,errorObejct=ErrorValueObject.create(error_type_ErrorType.VALUE),!1):datesValue<0?(isError=!0,errorObejct=ErrorValueObject.create(error_type_ErrorType.NUM),!1):void _dates.push(Math.floor(datesValue))})),isError?{isError,errorObejct}:_dates.length<=1?{isError:!0,errorObejct:ErrorValueObject.create(error_type_ErrorType.NA)}:{isError,_dates}}{const datesValue=dates.getValue();return dates.isNull()||dates.isBoolean()||dates.isString()&&!(0,src.DMQ)(datesValue)?{isError:!0,errorObejct:ErrorValueObject.create(error_type_ErrorType.VALUE)}:+datesValue<0?{isError:!0,errorObejct:ErrorValueObject.create(error_type_ErrorType.NUM)}:{isError:!0,errorObejct:ErrorValueObject.create(error_type_ErrorType.NA)}}}constructor(...args){super(...args),this.minParams=3,this.maxParams=3}},FUNCTION_NAMES_FINANCIAL.XNPV],[class Yield extends base_function_BaseFunction{calculate(settlement,maturity,rate,pr,redemption,frequency,basis){let _basis=basis??NumberValueObject.create(0);_basis.isNull()&&(_basis=NumberValueObject.create(0));const{isError,errorObject,variants}=checkVariantsErrorIsNullorArrayOrBoolean(settlement,maturity,rate,pr,redemption,frequency,_basis);if(isError)return errorObject;const[settlementObject,maturityObject,rateObject,prObject,redemptionObject,frequencyObject,basisObject]=variants,settlementSerialNumber=getDateSerialNumberByObject(settlementObject);if("number"!=typeof settlementSerialNumber)return settlementSerialNumber;const maturitySerialNumber=getDateSerialNumberByObject(maturityObject);if("number"!=typeof maturitySerialNumber)return maturitySerialNumber;const rateValue=+rateObject.getValue(),prValue=+prObject.getValue(),redemptionValue=+redemptionObject.getValue(),frequencyValue=Math.floor(+frequencyObject.getValue()),basisValue=Math.floor(+basisObject.getValue());if(Number.isNaN(rateValue)||Number.isNaN(prValue)||Number.isNaN(redemptionValue)||Number.isNaN(frequencyValue)||Number.isNaN(basisValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);if(rateValue<0||prValue<=0||redemptionValue<=0||![1,2,4].includes(frequencyValue)||basisValue<0||basisValue>4||settlementSerialNumber>=maturitySerialNumber||!validCouppcdIsGte0ByTwoDate(settlementSerialNumber,maturitySerialNumber,frequencyValue))return ErrorValueObject.create(error_type_ErrorType.NUM);const result=this._getResult(settlementSerialNumber,maturitySerialNumber,rateValue,prValue,redemptionValue,frequencyValue,basisValue);return NumberValueObject.create(result)}_getResult(settlementSerialNumber,maturitySerialNumber,rate,pr,redemption,frequency,basis){if(calculateCoupnum(settlementSerialNumber,maturitySerialNumber,frequency)>1){const g_Eps=1e-7;let yld=rate||.01,price=calculatePrice(settlementSerialNumber,maturitySerialNumber,rate,yld,redemption,frequency,basis),eps=price-pr;for(let i=0;i<100&&Math.abs(eps)>g_Eps;i++){price=calculatePrice(settlementSerialNumber,maturitySerialNumber,rate,1.01*yld,redemption,frequency,basis),yld+=-eps/(price-pr-eps)*yld*.01;eps=calculatePrice(settlementSerialNumber,maturitySerialNumber,rate,yld,redemption,frequency,basis)-pr}return yld}const A=calculateCoupdaybs(settlementSerialNumber,maturitySerialNumber,frequency,basis),E=calculateCoupdays(settlementSerialNumber,maturitySerialNumber,frequency,basis),{days:DSR}=getTwoDateDaysByBasis(settlementSerialNumber,maturitySerialNumber,basis),temp=pr/100+A/E*rate/frequency;return(redemption/100+rate/frequency-temp)/temp*frequency*E/DSR}constructor(...args){super(...args),this.minParams=6,this.maxParams=7}},FUNCTION_NAMES_FINANCIAL.YIELD],[class Yielddisc extends base_function_BaseFunction{calculate(settlement,maturity,pr,redemption,basis){let _basis=basis??NumberValueObject.create(0);_basis.isNull()&&(_basis=NumberValueObject.create(0));const{isError,errorObject,variants}=checkVariantsErrorIsNullorArrayOrBoolean(settlement,maturity,pr,redemption,_basis);if(isError)return errorObject;const[settlementObject,maturityObject,prObject,redemptionObject,basisObject]=variants,settlementSerialNumber=getDateSerialNumberByObject(settlementObject);if("number"!=typeof settlementSerialNumber)return settlementSerialNumber;const maturitySerialNumber=getDateSerialNumberByObject(maturityObject);if("number"!=typeof maturitySerialNumber)return maturitySerialNumber;const prValue=+prObject.getValue(),redemptionValue=+redemptionObject.getValue(),basisValue=Math.floor(+basisObject.getValue());if(Number.isNaN(prValue)||Number.isNaN(redemptionValue)||Number.isNaN(basisValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);if(prValue<=0||redemptionValue<=0||basisValue<0||basisValue>4||settlementSerialNumber>=maturitySerialNumber)return ErrorValueObject.create(error_type_ErrorType.NUM);const{days:DSM,yearDays:B}=getTwoDateDaysByBasis(settlementSerialNumber,maturitySerialNumber,basisValue),result=(redemptionValue/prValue-1)/(DSM/B);return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=4,this.maxParams=5}},FUNCTION_NAMES_FINANCIAL.YIELDDISC],[class Yieldmat extends base_function_BaseFunction{calculate(settlement,maturity,issue,rate,pr,basis){let _basis=basis??NumberValueObject.create(0);_basis.isNull()&&(_basis=NumberValueObject.create(0));const{isError,errorObject,variants}=checkVariantsErrorIsNullorArrayOrBoolean(settlement,maturity,issue,rate,pr,_basis);if(isError)return errorObject;const[settlementObject,maturityObject,issueObject,rateObject,prObject,basisObject]=variants,settlementSerialNumber=getDateSerialNumberByObject(settlementObject);if("number"!=typeof settlementSerialNumber)return settlementSerialNumber;const maturitySerialNumber=getDateSerialNumberByObject(maturityObject);if("number"!=typeof maturitySerialNumber)return maturitySerialNumber;const issueSerialNumber=getDateSerialNumberByObject(issueObject);if("number"!=typeof issueSerialNumber)return issueSerialNumber;const rateValue=+rateObject.getValue(),prValue=+prObject.getValue(),basisValue=Math.floor(+basisObject.getValue());if(Number.isNaN(rateValue)||Number.isNaN(prValue)||Number.isNaN(basisValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);const isCorrectOrder=this._getDateCorrectOrder(maturitySerialNumber,settlementSerialNumber,issueSerialNumber);if(rateValue<0||prValue<=0||basisValue<0||basisValue>4||!isCorrectOrder)return ErrorValueObject.create(error_type_ErrorType.NUM);const B=getNormalYearDaysByBasis(settlementSerialNumber,basisValue),{days:DSM}=getTwoDateDaysByBasis(settlementSerialNumber,maturitySerialNumber,basisValue),{days:DIM}=getTwoDateDaysByBasis(issueSerialNumber,maturitySerialNumber,basisValue),{days:A}=getTwoDateDaysByBasis(issueSerialNumber,settlementSerialNumber,basisValue),result=((1+DIM/B*rateValue)/(prValue/100+A/B*rateValue)-1)/(DSM/B);return NumberValueObject.create(result)}_getDateCorrectOrder(maturitySerialNumber,settlementSerialNumber,issueSerialNumber){return Math.floor(maturitySerialNumber)>Math.floor(settlementSerialNumber)&&Math.floor(settlementSerialNumber)>Math.floor(issueSerialNumber)}constructor(...args){super(...args),this.minParams=5,this.maxParams=6}},FUNCTION_NAMES_FINANCIAL.YIELDMAT]];var FUNCTION_NAMES_INFORMATION=function(FUNCTION_NAMES_INFORMATION){return FUNCTION_NAMES_INFORMATION.CELL="CELL",FUNCTION_NAMES_INFORMATION.ERROR_TYPE="ERROR.TYPE",FUNCTION_NAMES_INFORMATION.INFO="INFO",FUNCTION_NAMES_INFORMATION.ISBETWEEN="ISBETWEEN",FUNCTION_NAMES_INFORMATION.ISBLANK="ISBLANK",FUNCTION_NAMES_INFORMATION.ISDATE="ISDATE",FUNCTION_NAMES_INFORMATION.ISEMAIL="ISEMAIL",FUNCTION_NAMES_INFORMATION.ISERR="ISERR",FUNCTION_NAMES_INFORMATION.ISERROR="ISERROR",FUNCTION_NAMES_INFORMATION.ISEVEN="ISEVEN",FUNCTION_NAMES_INFORMATION.ISFORMULA="ISFORMULA",FUNCTION_NAMES_INFORMATION.ISLOGICAL="ISLOGICAL",FUNCTION_NAMES_INFORMATION.ISNA="ISNA",FUNCTION_NAMES_INFORMATION.ISNONTEXT="ISNONTEXT",FUNCTION_NAMES_INFORMATION.ISNUMBER="ISNUMBER",FUNCTION_NAMES_INFORMATION.ISODD="ISODD",FUNCTION_NAMES_INFORMATION.ISOMITTED="ISOMITTED",FUNCTION_NAMES_INFORMATION.ISREF="ISREF",FUNCTION_NAMES_INFORMATION.ISTEXT="ISTEXT",FUNCTION_NAMES_INFORMATION.ISURL="ISURL",FUNCTION_NAMES_INFORMATION.N="N",FUNCTION_NAMES_INFORMATION.NA="NA",FUNCTION_NAMES_INFORMATION.SHEET="SHEET",FUNCTION_NAMES_INFORMATION.SHEETS="SHEETS",FUNCTION_NAMES_INFORMATION.TYPE="TYPE",FUNCTION_NAMES_INFORMATION}({});const functionInformation=[[class Cell extends base_function_BaseFunction{calculate(infoType,reference){let _infoType=infoType;if(_infoType.isError())return _infoType;if(_infoType.isReferenceObject()&&(_infoType=_infoType.toArrayValueObject()),_infoType.isArray()){const rowCount=_infoType.getRowCount(),columnCount=_infoType.getColumnCount();if(1===rowCount&&1===columnCount){const infoTypeObject=_infoType.get(0,0);return this._handleSingleObject(infoTypeObject,reference)}return _infoType.map((infoTypeObject=>infoTypeObject.isError()?infoTypeObject:this._handleSingleObject(infoTypeObject,reference,!0)))}return this._handleSingleObject(_infoType,reference)}_handleSingleObject(infoType,reference,infoTypeIsArray=!1){let _reference=reference;if(_reference.isError())return _reference;if(!_reference.isReferenceObject())return ErrorValueObject.create(error_type_ErrorType.NA);const currentActiveSheetData=_reference.getCurrentActiveSheetData(),{columnData,defaultColumnWidth}=currentActiveSheetData;_reference=_reference.toArrayValueObject();const _currentRow=_reference.getCurrentRow(),_currentColumn=_reference.getCurrentColumn();_reference=_reference.getFirstCell();let result;switch(`${infoType.getValue()}`.toLocaleLowerCase()){case"address":return StringValueObject.create(`$${src.S0q.chatAtABC(_currentColumn)}$${_currentRow+1}`);case"col":return NumberValueObject.create(_currentColumn+1);case"color":case"parentheses":return NumberValueObject.create(0);case"contents":return _reference;case"filename":default:return ErrorValueObject.create(error_type_ErrorType.VALUE);case"format":return StringValueObject.create("G");case"prefix":return StringValueObject.create("");case"protect":return NumberValueObject.create(1);case"row":return NumberValueObject.create(_currentRow+1);case"type":return result="v",_reference.isNull()&&(result="b"),_reference.isString()&&(result="l"),StringValueObject.create(result);case"width":return this._getWidthResult(columnData,defaultColumnWidth,_currentColumn,infoTypeIsArray)}}_getWidthResult(columnData,defaultColumnWidth,_currentColumn,infoTypeIsArray){let result=columnData[_currentColumn]?.w;if(result||0===result||(result=defaultColumnWidth),infoTypeIsArray)return NumberValueObject.create(result);const resultArray=[[result,result===defaultColumnWidth]];return ArrayValueObject.createByArray(resultArray)}constructor(...args){super(...args),this.needsReferenceObject=!0,this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_INFORMATION.CELL],[class ErrorType extends base_function_BaseFunction{calculate(errorVal){return errorVal.isArray()?errorVal.mapValue((errorValObject=>this._handleSingleObject(errorValObject))):this._handleSingleObject(errorVal)}_handleSingleObject(errorVal){const errorValValue=errorVal.getValue(),result=this._errorTypeValueMap.get(errorValValue);return result?NumberValueObject.create(result):ErrorValueObject.create(error_type_ErrorType.NA)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1,this._errorTypeValueMap=new Map([[error_type_ErrorType.NULL,1],[error_type_ErrorType.DIV_BY_ZERO,2],[error_type_ErrorType.VALUE,3],[error_type_ErrorType.REF,4],[error_type_ErrorType.NAME,5],[error_type_ErrorType.NUM,6],[error_type_ErrorType.NA,7],[error_type_ErrorType.CONNECT,8],[error_type_ErrorType.CALC,14]])}},FUNCTION_NAMES_INFORMATION.ERROR_TYPE],[class Isbetween extends base_function_BaseFunction{calculate(valueToCompare,lowerValue,upperValue,lowerValueIsInclusive,upperValueIsInclusive){const _lowerValueIsInclusive=lowerValueIsInclusive??BooleanValueObject.create(!0),_upperValueIsInclusive=upperValueIsInclusive??BooleanValueObject.create(!0),{isError,errorObject,variants}=checkVariantsErrorIsArray(valueToCompare,lowerValue,upperValue,_lowerValueIsInclusive,_upperValueIsInclusive);if(isError)return errorObject;const[valueToCompareObject,lowerValueObject,upperValueObject,lowerValueIsInclusiveObject,upperValueIsInclusiveObject]=variants;if(lowerValueIsInclusiveObject.isString()||upperValueIsInclusiveObject.isString())return ErrorValueObject.create(error_type_ErrorType.VALUE);if(!0===lowerValueObject.compare(upperValueObject,">").getValue())return ErrorValueObject.create(error_type_ErrorType.NUM);const lowerComparisonOperator=+lowerValueIsInclusiveObject.getValue()?">=":">",upperComparisonOperator=+upperValueIsInclusiveObject.getValue()?"<=":"<";if(!1===valueToCompareObject.compare(lowerValueObject,lowerComparisonOperator).getValue())return BooleanValueObject.create(!1);return!1===valueToCompareObject.compare(upperValueObject,upperComparisonOperator).getValue()?BooleanValueObject.create(!1):BooleanValueObject.create(!0)}constructor(...args){super(...args),this.minParams=3,this.maxParams=5}},FUNCTION_NAMES_INFORMATION.ISBETWEEN],[class Isblank extends base_function_BaseFunction{calculate(value){return value.isNull()?BooleanValueObject.create(!0):value.isArray()?value.mapValue((valueObject=>valueObject.isNull()?BooleanValueObject.create(!0):BooleanValueObject.create(!1))):BooleanValueObject.create(!1)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_INFORMATION.ISBLANK],[class Isdate extends base_function_BaseFunction{calculate(value){let _value=value;if(_value.isArray()){const rowCount=_value.getRowCount(),columnCount=_value.getColumnCount();if(rowCount>1||columnCount>1)return ErrorValueObject.create(error_type_ErrorType.VALUE);_value=_value.get(0,0)}return _value.isError()?_value:_value.isNumber()&&""!==_value.getPattern()?BooleanValueObject.create(isDate(_value.getPattern())):_value.isString()&&(parseFormattedDate(`${_value.getValue()}`)||parseFormattedTime(`${_value.getValue()}`))?BooleanValueObject.create(!0):BooleanValueObject.create(!1)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_INFORMATION.ISDATE],[class Isemail extends base_function_BaseFunction{calculate(value){let _value=value;if(_value.isArray()){const rowCount=_value.getRowCount(),columnCount=_value.getColumnCount();if(rowCount>1||columnCount>1)return ErrorValueObject.create(error_type_ErrorType.VALUE);_value=_value.get(0,0)}if(_value.isError())return _value;if(_value.isNull()||_value.isBoolean()||_value.isNumber())return BooleanValueObject.create(!1);const val=`${_value.getValue()}`;if(val.length>254)return BooleanValueObject.create(!1);const topLevelDomain=src.S0q.topLevelDomainCombiningString(),reg=new RegExp(`^(?:[\\w+-]+\\.)*[\\w+-]+@[a-z0-9_-]+(?:\\.[a-z0-9_-]+)*\\.(?:${topLevelDomain})$`,"i");return BooleanValueObject.create(reg.test(val))}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_INFORMATION.ISEMAIL],[class Iserr extends base_function_BaseFunction{calculate(value){return value.getValue()===error_type_ErrorType.NA?BooleanValueObject.create(!1):value.isError()?BooleanValueObject.create(!0):value.isArray()?value.mapValue((valueObject=>valueObject.getValue()===error_type_ErrorType.NA?BooleanValueObject.create(!1):valueObject.isError()?BooleanValueObject.create(!0):BooleanValueObject.create(!1))):BooleanValueObject.create(!1)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_INFORMATION.ISERR],[class Iserror extends base_function_BaseFunction{calculate(value){return value.isError()?BooleanValueObject.create(!0):value.isArray()?value.mapValue((valueObject=>valueObject.isError()?BooleanValueObject.create(!0):BooleanValueObject.create(!1))):BooleanValueObject.create(!1)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_INFORMATION.ISERROR],[class Iseven extends base_function_BaseFunction{calculate(value){let _value=value;if(_value.isArray()){const rowCount=_value.getRowCount(),columnCount=_value.getColumnCount();if(rowCount>1||columnCount>1)return ErrorValueObject.create(error_type_ErrorType.VALUE);_value=_value.get(0,0)}if(_value.isError())return _value;if(_value.isBoolean())return ErrorValueObject.create(error_type_ErrorType.VALUE);const val=Math.trunc(+_value.getValue());if(Number.isNaN(val))return ErrorValueObject.create(error_type_ErrorType.VALUE);const result=val%2==0;return BooleanValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_INFORMATION.ISEVEN],[class Isformula extends base_function_BaseFunction{calculate(reference){if(reference.isError())return reference;if(!reference.isReferenceObject())return ErrorValueObject.create(error_type_ErrorType.NA);const cellDataMatrix=reference.getCurrentActiveSheetData()?.cellData.getMatrix(),{startRow,startColumn}=reference.getRangePosition(),_reference=reference.toArrayValueObject(),resultArray=_reference.mapValue(((valueObject,rowIndex,columnIndex)=>{const cellData=cellDataMatrix?.[startRow+rowIndex]?.[startColumn+columnIndex];return cellData?.f||cellData?.si?BooleanValueObject.create(!0):BooleanValueObject.create(!1)}));return 1===_reference.getRowCount()&&1===_reference.getColumnCount()?resultArray.get(0,0):resultArray}constructor(...args){super(...args),this.minParams=1,this.maxParams=1,this.needsReferenceObject=!0}},FUNCTION_NAMES_INFORMATION.ISFORMULA],[class Islogical extends base_function_BaseFunction{calculate(value){return value.isBoolean()?BooleanValueObject.create(!0):value.isArray()?value.mapValue((valueObject=>valueObject.isBoolean()?BooleanValueObject.create(!0):BooleanValueObject.create(!1))):BooleanValueObject.create(!1)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_INFORMATION.ISLOGICAL],[class Isna extends base_function_BaseFunction{calculate(value){return value.getValue()===error_type_ErrorType.NA?BooleanValueObject.create(!0):value.isArray()?value.mapValue((valueObject=>valueObject.getValue()===error_type_ErrorType.NA?BooleanValueObject.create(!0):BooleanValueObject.create(!1))):BooleanValueObject.create(!1)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_INFORMATION.ISNA],[class Isnontext extends base_function_BaseFunction{calculate(value){return value.isArray()||value.isString()?value.isArray()?value.mapValue((valueObject=>valueObject.isString()?BooleanValueObject.create(!1):BooleanValueObject.create(!0))):BooleanValueObject.create(!1):BooleanValueObject.create(!0)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_INFORMATION.ISNONTEXT],[class Isnumber extends base_function_BaseFunction{calculate(value){return value.isNumber()?BooleanValueObject.create(!0):value.isArray()?value.mapValue((valueObject=>valueObject.isNumber()?BooleanValueObject.create(!0):BooleanValueObject.create(!1))):BooleanValueObject.create(!1)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_INFORMATION.ISNUMBER],[class Isodd extends base_function_BaseFunction{calculate(value){let _value=value;if(_value.isArray()){const rowCount=_value.getRowCount(),columnCount=_value.getColumnCount();if(rowCount>1||columnCount>1)return ErrorValueObject.create(error_type_ErrorType.VALUE);_value=_value.get(0,0)}if(_value.isError())return _value;if(_value.isBoolean())return ErrorValueObject.create(error_type_ErrorType.VALUE);const val=Math.trunc(+_value.getValue());if(Number.isNaN(val))return ErrorValueObject.create(error_type_ErrorType.VALUE);const result=val%2!=0;return BooleanValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_INFORMATION.ISODD],[class Isref extends base_function_BaseFunction{calculate(value){return value.isReferenceObject()?BooleanValueObject.create(!0):BooleanValueObject.create(!1)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1,this.needsReferenceObject=!0}},FUNCTION_NAMES_INFORMATION.ISREF],[class Istext extends base_function_BaseFunction{calculate(value){return value.isString()?BooleanValueObject.create(!0):value.isArray()?value.mapValue((valueObject=>valueObject.isString()?BooleanValueObject.create(!0):BooleanValueObject.create(!1))):BooleanValueObject.create(!1)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_INFORMATION.ISTEXT],[class Isurl extends base_function_BaseFunction{calculate(value){let _value=value;if(_value.isArray()){const rowCount=_value.getRowCount(),columnCount=_value.getColumnCount();if(rowCount>1||columnCount>1)return ErrorValueObject.create(error_type_ErrorType.VALUE);_value=_value.get(0,0)}if(_value.isError())return _value;if(_value.isNull()||_value.isBoolean()||_value.isNumber())return BooleanValueObject.create(!1);const val=`${_value.getValue()}`.replace(/^\s+|\s+$/g,"");if(val.length>1e3)return BooleanValueObject.create(!1);const topLevelDomain=src.S0q.topLevelDomainCombiningString(),reg=new RegExp(`^(?:(?:https?|s?ftp|ftps|nfs|ssh)://+[a-z0-9_-]+(?:\\.[a-z0-9_-]+)*(?::[0-9]+)?(?:/(?:[A-Za-z0-9\\-._~!$&'()*+,;=:@]|%[A-Fa-f0-9]{2})*)*/?(?:[?#]\\S*)?|[a-z0-9_-]+(?:\\.[a-z0-9_-]+)*\\.(?:${topLevelDomain})(?::[0-9]+)?(?:/(?:[A-Za-z0-9\\-._~!$&'()*+,;=:@]|%[A-Fa-f0-9]{2})*)*/?(?:[?#]\\S*)?|mailto:(?:[\\w+-]+\\.)*[\\w+-]+@[a-z0-9_-]+(?:\\.[a-z0-9_-]+)*\\.(?:${topLevelDomain})|(?:news|aim):[%a-z0-9$_\\.+!*(),;/?#:@&~=-]+)$`,"i");return BooleanValueObject.create(reg.test(val))}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_INFORMATION.ISURL],[class N extends base_function_BaseFunction{calculate(value){let _value=value;if(value.isArray()&&(_value=value.get(0,0)),_value.isError())return _value;if(_value.isString())return NumberValueObject.create(0);const val=+_value.getValue();return NumberValueObject.create(val)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_INFORMATION.N],[class Na extends base_function_BaseFunction{calculate(){return ErrorValueObject.create(error_type_ErrorType.NA)}constructor(...args){super(...args),this.minParams=0,this.maxParams=0}},FUNCTION_NAMES_INFORMATION.NA],[class Sheet extends base_function_BaseFunction{calculate(value){if(value?.isError())return value;const{sheetOrder,sheetNameMap}=this.getSheetsInfo();if(!value){const sheetIndex=sheetOrder.findIndex((sheetId=>sheetId===this.subUnitId));return NumberValueObject.create(sheetIndex+1)}if(value.isReferenceObject()){const forcedSheetId=value.getForcedSheetId(),defaultSheetId=value.getDefaultSheetId(),sheetIndex=sheetOrder.findIndex((sheetId=>forcedSheetId?sheetId===forcedSheetId:sheetId===defaultSheetId));return NumberValueObject.create(sheetIndex+1)}if(value.isArray())return ErrorValueObject.create(error_type_ErrorType.NA);const inputValue=`${value.getValue()}`.toLocaleLowerCase(),inputSheetId=Object.entries(sheetNameMap).find((([_,name])=>name.toLocaleLowerCase()===inputValue))?.[0];if(!inputSheetId)return ErrorValueObject.create(error_type_ErrorType.NA);const sheetIndex=sheetOrder.findIndex((sheetId=>sheetId===inputSheetId));return NumberValueObject.create(sheetIndex+1)}constructor(...args){super(...args),this.minParams=0,this.maxParams=1,this.needsReferenceObject=!0,this.needsSheetsInfo=!0}},FUNCTION_NAMES_INFORMATION.SHEET],[class Sheets extends base_function_BaseFunction{calculate(){const{sheetOrder}=this.getSheetsInfo();return NumberValueObject.create(sheetOrder.length)}constructor(...args){super(...args),this.minParams=0,this.maxParams=0,this.needsSheetsInfo=!0}},FUNCTION_NAMES_INFORMATION.SHEETS],[class Type extends base_function_BaseFunction{calculate(value){if(value.isReferenceObject()){const rowCount=value.getRowCount(),columnCount=value.getColumnCount();if(1!==rowCount||1!==columnCount)return NumberValueObject.create(64);{const _value=value.getFirstCell();if(_value.isError())return NumberValueObject.create(16);if(_value.isBoolean())return NumberValueObject.create(4);if(_value.isString())return NumberValueObject.create(2);if(_value.isNumber()||_value.isNull())return NumberValueObject.create(1)}}else{if(value.isArray())return NumberValueObject.create(64);if(value.isError())return NumberValueObject.create(16);if(value.isBoolean())return NumberValueObject.create(4);if(value.isString())return NumberValueObject.create(2);if(value.isNumber()||value.isNull())return NumberValueObject.create(1)}return NumberValueObject.create(128)}constructor(...args){super(...args),this.needsReferenceObject=!0,this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_INFORMATION.TYPE]];var FUNCTION_NAMES_LOGICAL=function(FUNCTION_NAMES_LOGICAL){return FUNCTION_NAMES_LOGICAL.AND="AND",FUNCTION_NAMES_LOGICAL.BYCOL="BYCOL",FUNCTION_NAMES_LOGICAL.BYROW="BYROW",FUNCTION_NAMES_LOGICAL.FALSE="FALSE",FUNCTION_NAMES_LOGICAL.IF="IF",FUNCTION_NAMES_LOGICAL.IFERROR="IFERROR",FUNCTION_NAMES_LOGICAL.IFNA="IFNA",FUNCTION_NAMES_LOGICAL.IFS="IFS",FUNCTION_NAMES_LOGICAL.LAMBDA="LAMBDA",FUNCTION_NAMES_LOGICAL.LET="LET",FUNCTION_NAMES_LOGICAL.MAKEARRAY="MAKEARRAY",FUNCTION_NAMES_LOGICAL.MAP="MAP",FUNCTION_NAMES_LOGICAL.NOT="NOT",FUNCTION_NAMES_LOGICAL.OR="OR",FUNCTION_NAMES_LOGICAL.REDUCE="REDUCE",FUNCTION_NAMES_LOGICAL.SCAN="SCAN",FUNCTION_NAMES_LOGICAL.SWITCH="SWITCH",FUNCTION_NAMES_LOGICAL.TRUE="TRUE",FUNCTION_NAMES_LOGICAL.XOR="XOR",FUNCTION_NAMES_LOGICAL}({});const functionLogical=[[class And extends base_function_BaseFunction{calculate(...logicalValues){let result=!0,noBoolean=!0,errorValue=null;for(const logicalValue of logicalValues){if(logicalValue.isError())return logicalValue;if(logicalValue.isArray()){if(logicalValue.iterator((value=>{if(value?.isError())return errorValue=value,!1;(value?.isBoolean()||value?.isNumber())&&(result=result&&!!value.getValue(),noBoolean=!1)})),errorValue)return errorValue}else(logicalValue.isBoolean()||logicalValue.isNumber())&&(result=result&&!!logicalValue.getValue(),noBoolean=!1)}return noBoolean?ErrorValueObject.create(error_type_ErrorType.VALUE):BooleanValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=255}},FUNCTION_NAMES_LOGICAL.AND],[class Bycol extends base_function_BaseFunction{calculate(array,lambda){let _array=array,_array_reference=null;if(array.isReferenceObject()&&(_array=array.toArrayValueObject(),_array_reference=array),_array.isError())return _array;if(lambda.isError())return lambda;if(!lambda.isValueObject()||!lambda.isLambda()||1!==lambda.getLambdaPrivacyVarKeys().length)return ErrorValueObject.create(error_type_ErrorType.VALUE);const _lambda=lambda,rowCount=_array.isArray()?_array.getRowCount():1,columnCount=_array.isArray()?_array.getColumnCount():1;_array=expandArrayValueObject(rowCount,columnCount,_array);const result=[[]];for(let c=0;c<columnCount;c++){const rows=[];for(let r=0;r<rowCount;r++){const col=_array.get(r,c);rows.push([col])}let lambdaVariant=ArrayValueObject.create({calculateValueList:rows,rowCount,columnCount:1,unitId:"",sheetId:"",row:0,column:0});if(_array_reference){const{startRow,startColumn}=_array_reference.getRangePosition(),range={startRow,startColumn:startColumn+c,endRow:startRow+rowCount-1,endColumn:startColumn+c};lambdaVariant=this.createReferenceObject(_array_reference,range)}let value=_lambda.execute(lambdaVariant);if(value.isArray()){const valueRowCount=value.getRowCount(),valueColumnCount=value.getColumnCount();if(valueRowCount>1||valueColumnCount>1)return ErrorValueObject.create(error_type_ErrorType.CALC);value=value.get(0,0)}value.isNull()&&(value=NumberValueObject.create(0)),result[0].push(value)}return 1===columnCount?result[0][0]:ArrayValueObject.create({calculateValueList:result,rowCount:1,columnCount,unitId:this.unitId,sheetId:this.subUnitId,row:this.row,column:this.column})}constructor(...args){super(...args),this.minParams=2,this.maxParams=2,this.needsReferenceObject=!0}},FUNCTION_NAMES_LOGICAL.BYCOL],[class Byrow extends base_function_BaseFunction{calculate(array,lambda){let _array=array,_array_reference=null;if(array.isReferenceObject()&&(_array=array.toArrayValueObject(),_array_reference=array),_array.isError())return _array;if(lambda.isError())return lambda;if(!lambda.isValueObject()||!lambda.isLambda()||1!==lambda.getLambdaPrivacyVarKeys().length)return ErrorValueObject.create(error_type_ErrorType.VALUE);const _lambda=lambda,rowCount=_array.isArray()?_array.getRowCount():1,columnCount=_array.isArray()?_array.getColumnCount():1;_array=expandArrayValueObject(rowCount,columnCount,_array);const result=[];for(let r=0;r<rowCount;r++){const rows=[[]];for(let c=0;c<columnCount;c++){const col=_array.get(r,c);rows[0].push(col)}let lambdaVariant=ArrayValueObject.create({calculateValueList:rows,rowCount:1,columnCount,unitId:"",sheetId:"",row:0,column:0});if(_array_reference){const{startRow,startColumn}=_array_reference.getRangePosition(),range={startRow:startRow+r,startColumn,endRow:startRow+r,endColumn:startColumn+columnCount-1};lambdaVariant=this.createReferenceObject(_array_reference,range)}let value=_lambda.execute(lambdaVariant);if(value.isArray()){const valueRowCount=value.getRowCount(),valueColumnCount=value.getColumnCount();if(valueRowCount>1||valueColumnCount>1)return ErrorValueObject.create(error_type_ErrorType.CALC);value=value.get(0,0)}value.isNull()&&(value=NumberValueObject.create(0)),result.push([value])}return 1===rowCount?result[0][0]:ArrayValueObject.create({calculateValueList:result,rowCount,columnCount:1,unitId:this.unitId,sheetId:this.subUnitId,row:this.row,column:this.column})}constructor(...args){super(...args),this.minParams=2,this.maxParams=2,this.needsReferenceObject=!0}},FUNCTION_NAMES_LOGICAL.BYROW],[class False extends base_function_BaseFunction{calculate(){return BooleanValueObject.create(!1)}constructor(...args){super(...args),this.minParams=0,this.maxParams=0}},FUNCTION_NAMES_LOGICAL.FALSE],[class If extends base_function_BaseFunction{calculate(logicalTest,valueIfTrue,valueIfFalse=BooleanValueObject.create(!1)){const _logicalTest=this._getSingleValueObject(logicalTest);if(_logicalTest.isError())return _logicalTest;if(!_logicalTest.isArray())return _logicalTest.getValue()?valueIfTrue:valueIfFalse;const maxRowLength=Math.max(_logicalTest.isArray()?_logicalTest.getRowCount():1,valueIfTrue.isArray()?valueIfTrue.getRowCount():1,valueIfFalse.isArray()?valueIfFalse.getRowCount():1),maxColumnLength=Math.max(_logicalTest.isArray()?_logicalTest.getColumnCount():1,valueIfTrue.isArray()?valueIfTrue.getColumnCount():1,valueIfFalse.isArray()?valueIfFalse.getColumnCount():1),logicalTestArray=expandArrayValueObject(maxRowLength,maxColumnLength,_logicalTest),valueIfTrueArray=expandArrayValueObject(maxRowLength,maxColumnLength,valueIfTrue,ErrorValueObject.create(error_type_ErrorType.NA)),valueIfFalseArray=expandArrayValueObject(maxRowLength,maxColumnLength,valueIfFalse,ErrorValueObject.create(error_type_ErrorType.NA));return logicalTestArray.map(((logicalTestValue,rowIndex,columnIndex)=>{if(logicalTestValue.isNull())return ErrorValueObject.create(error_type_ErrorType.NA);{const valueIfTrueValue=valueIfTrueArray.get(rowIndex,columnIndex)||NullValueObject.create(),valueIfFalseValue=valueIfFalseArray.get(rowIndex,columnIndex)||NullValueObject.create();return this._calculateSingleCell(logicalTestValue,valueIfTrueValue,valueIfFalseValue)}}))}_getSingleValueObject(valueObject){return valueObject.isArray()&&1===valueObject.getRowCount()&&1===valueObject.getColumnCount()?valueObject.getFirstCell():valueObject}_calculateSingleCell(logicalTest,valueIfTrue,valueIfFalse){if(logicalTest.isNull())return ErrorValueObject.create(error_type_ErrorType.NA);return logicalTest.getValue()?valueIfTrue.isNull()?ErrorValueObject.create(error_type_ErrorType.NA):valueIfTrue:valueIfFalse.isNull()?ErrorValueObject.create(error_type_ErrorType.NA):valueIfFalse}constructor(...args){super(...args),this.minParams=2,this.maxParams=3}},FUNCTION_NAMES_LOGICAL.IF],[class Iferror extends base_function_BaseFunction{calculate(value,valueIfError){if(!value.isArray())return value.isError()?valueIfError:value;const maxRowLength=Math.max(value.isArray()?value.getRowCount():1,valueIfError.isArray()?valueIfError.getRowCount():1),maxColumnLength=Math.max(value.isArray()?value.getColumnCount():1,valueIfError.isArray()?valueIfError.getColumnCount():1),valueArray=expandArrayValueObject(maxRowLength,maxColumnLength,value),valueIfErrorArray=expandArrayValueObject(maxRowLength,maxColumnLength,valueIfError);return valueArray.iterator(((value,rowIndex,columnIndex)=>{value?.isError()&&valueArray.set(rowIndex,columnIndex,valueIfErrorArray.get(rowIndex,columnIndex))})),valueArray}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_LOGICAL.IFERROR],[class Ifna extends base_function_BaseFunction{calculate(value,valueIfNa){if(value.isError()&&value.getErrorType()!==error_type_ErrorType.NA)return value;if(valueIfNa.isError())return valueIfNa;if(!value.isArray())return value.isError()&&value.getErrorType()===error_type_ErrorType.NA?valueIfNa:value;const maxRowLength=Math.max(value.isArray()?value.getRowCount():1,valueIfNa.isArray()?valueIfNa.getRowCount():1),maxColumnLength=Math.max(value.isArray()?value.getColumnCount():1,valueIfNa.isArray()?valueIfNa.getColumnCount():1),valueArray=expandArrayValueObject(maxRowLength,maxColumnLength,value),valueIfNaArray=expandArrayValueObject(maxRowLength,maxColumnLength,valueIfNa);return valueArray.iterator(((cellValue,rowIndex,columnIndex)=>{cellValue?.isError()&&cellValue.getErrorType()===error_type_ErrorType.NA&&valueArray.set(rowIndex,columnIndex,valueIfNaArray.get(rowIndex,columnIndex))})),valueArray}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_LOGICAL.IFNA],[class Ifs extends base_function_BaseFunction{calculate(...params){if(params.length%2!=0)return ErrorValueObject.create(error_type_ErrorType.NA);for(let i=0;i<params.length;i++)if(params[i].isError())return params[i];const maxRowLength=Math.max(...params.map((param=>param.isArray()?param.getRowCount():1))),maxColumnLength=Math.max(...params.map((param=>param.isArray()?param.getColumnCount():1))),expandedParams=params.map((param=>expandArrayValueObject(maxRowLength,maxColumnLength,param,ErrorValueObject.create(error_type_ErrorType.NA)))),resultArray=expandedParams[0].map(((_,rowIndex,columnIndex)=>{for(let i=0;i<expandedParams.length;i+=2){const condition=expandedParams[i].get(rowIndex,columnIndex)||NullValueObject.create(),result=expandedParams[i+1].get(rowIndex,columnIndex)||NullValueObject.create();if(condition.isNull())continue;if(condition.isError())return condition;const conditionValue=condition.getValue();if(condition.isString()){if("TRUE"===`${conditionValue}`.toLocaleUpperCase())return result;if("FALSE"===`${conditionValue}`.toLocaleUpperCase())continue;return ErrorValueObject.create(error_type_ErrorType.VALUE)}if(+conditionValue)return result.isNull()?ErrorValueObject.create(error_type_ErrorType.NA):result}return ErrorValueObject.create(error_type_ErrorType.NA)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}constructor(...args){super(...args),this.minParams=2,this.maxParams=255}},FUNCTION_NAMES_LOGICAL.IFS],[class Lambda extends base_function_BaseFunction{calculate(...variants){return ErrorValueObject.create(error_type_ErrorType.VALUE)}constructor(...args){super(...args),this.minParams=1,this.maxParams=255}},FUNCTION_NAMES_LOGICAL.LAMBDA],[class Let extends base_function_BaseFunction{calculate(...variants){return ErrorValueObject.create(error_type_ErrorType.VALUE)}constructor(...args){super(...args),this.minParams=3,this.maxParams=255}},FUNCTION_NAMES_LOGICAL.LET],[class Makearray extends base_function_BaseFunction{calculate(...variants){const row=this.getIndexNumValue(variants[0]);if("number"!=typeof row)return row;const column=this.getIndexNumValue(variants[1]);if("number"!=typeof column)return column;if(!variants[2].isValueObject()||!variants[2].isLambda())return ErrorValueObject.create(error_type_ErrorType.VALUE);const lambda=variants[2],result=[];for(let r=0;r<row;r++){null==result[r]&&(result[r]=[]);for(let c=0;c<column;c++){let value=lambda.execute(NumberValueObject.create(r+1),NumberValueObject.create(c+1));value.isArray()&&(value=value.get(0,0)),result[r][c]=value}}return new AsyncArrayObject(result)}isAsync(){return!0}constructor(...args){super(...args),this.minParams=3,this.maxParams=3}},FUNCTION_NAMES_LOGICAL.MAKEARRAY],[class map_Map extends base_function_BaseFunction{calculate(...variants){const _variants=[];let lambda=null,maxRowLength=0,maxColumnLength=0;for(let i=0;i<variants.length;i++){const variant=variants[i];let _variant=variant;if(_variant.isReferenceObject()&&(_variant=variant.toArrayValueObject()),_variant.isError())return _variant;if(i===variants.length-1){if(!variant.isValueObject()||!variant.isLambda())return ErrorValueObject.create(error_type_ErrorType.VALUE);lambda=variant}else _variants.push(variant),maxRowLength=Math.max(maxRowLength,_variant.isArray()?_variant.getRowCount():1),maxColumnLength=Math.max(maxColumnLength,_variant.isArray()?_variant.getColumnCount():1)}const resultArray=this._getResultArray(_variants,lambda,maxRowLength,maxColumnLength);return resultArray instanceof ErrorValueObject?resultArray:1===maxRowLength&&1===maxColumnLength?resultArray[0][0]:ArrayValueObject.create({calculateValueList:resultArray,rowCount:maxRowLength,columnCount:maxColumnLength,unitId:this.unitId,sheetId:this.subUnitId,row:this.row,column:this.column})}_getResultArray(variants,lambda,maxRowLength,maxColumnLength){const resultArray=[];for(let r=0;r<maxRowLength;r++){const row=[];for(let c=0;c<maxColumnLength;c++){const lambdaVariant=[];let isRowPushed=!1;for(let i=0;i<variants.length;i++){let variant=variants[i],_variant_reference=null;if(variant.isReferenceObject()&&(_variant_reference=variant,variant=variant.toArrayValueObject()),!variant.isArray()){if(0===r&&0===c){lambdaVariant.push(_variant_reference||variant);continue}row.push(ErrorValueObject.create(error_type_ErrorType.NA)),isRowPushed=!0;break}let valueObject=variant.get(r,c);if(!valueObject){row.push(ErrorValueObject.create(error_type_ErrorType.NA)),isRowPushed=!0;break}if(_variant_reference){const{startRow,startColumn}=_variant_reference.getRangePosition(),range={startRow:startRow+r,startColumn:startColumn+c,endRow:startRow+r,endColumn:startColumn+c};valueObject=this.createReferenceObject(_variant_reference,range)}lambdaVariant.push(valueObject)}if(isRowPushed||0===lambdaVariant.length)continue;let value=lambda.execute(...lambdaVariant);if(value.isArray()){const rowCount=value.getRowCount(),columnCount=value.getColumnCount();if(rowCount>1||columnCount>1)return ErrorValueObject.create(error_type_ErrorType.CALC);value=value.get(0,0)}value.isNull()&&(value=NumberValueObject.create(0)),row.push(value)}resultArray.push(row)}return resultArray}constructor(...args){super(...args),this.minParams=2,this.maxParams=255,this.needsReferenceObject=!0}},FUNCTION_NAMES_LOGICAL.MAP],[class Not extends base_function_BaseFunction{calculate(logical){return logical.isArray()?logical.map((logicalObject=>this._handleSingleObject(logicalObject))):this._handleSingleObject(logical)}_handleSingleObject(logical){if(logical.isError())return logical;const logicalValue=+logical.getValue();return Number.isNaN(logicalValue)?ErrorValueObject.create(error_type_ErrorType.VALUE):BooleanValueObject.create(!logicalValue)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_LOGICAL.NOT],[class Or extends base_function_BaseFunction{calculate(...logicalValues){let result=!1,noBoolean=!0,errorValue=null;for(const logicalValue of logicalValues){if(logicalValue.isError())return logicalValue;if(logicalValue.isArray()){if(logicalValue.iterator((value=>{if(value?.isError())return errorValue=value,!1;(value?.isBoolean()||value?.isNumber())&&(result=result||!!value.getValue(),noBoolean=!1)})),errorValue)return errorValue}else(logicalValue.isBoolean()||logicalValue.isNumber())&&(result=result||!!logicalValue.getValue(),noBoolean=!1)}return noBoolean?new ErrorValueObject(error_type_ErrorType.VALUE):new BooleanValueObject(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=255}},FUNCTION_NAMES_LOGICAL.OR],[class Reduce extends base_function_BaseFunction{calculate(initialValue,array,lambda){let _initialValue,_initialValueReference,_array,_arrayReference;return initialValue.isReferenceObject()?(_initialValue=initialValue.toArrayValueObject(),_initialValueReference=initialValue):(_initialValue=initialValue,_initialValueReference=null),array.isReferenceObject()?(_array=array.toArrayValueObject(),_arrayReference=array):(_array=array,_arrayReference=null),_initialValue.isArray()?_initialValue.mapValue((initialValueObject=>this._handleSingleValueObject(initialValueObject,_array,lambda,_initialValueReference,_arrayReference))):this._handleSingleValueObject(_initialValue,_array,lambda,_initialValueReference,_arrayReference)}_handleSingleValueObject(initialValue,array,lambda,_initialValue_reference,_array_reference){if(initialValue.isError())return initialValue;if(array.isError())return array;if(lambda.isError())return lambda;if(!lambda.isValueObject()||!lambda.isLambda()||2!==lambda.getLambdaPrivacyVarKeys().length)return ErrorValueObject.create(error_type_ErrorType.VALUE);const _lambda=lambda,rowCount=array.isArray()?array.getRowCount():1,columnCount=array.isArray()?array.getColumnCount():1;let accumulator=initialValue;_initialValue_reference&&(accumulator=_initialValue_reference);for(let r=0;r<rowCount;r++)for(let c=0;c<columnCount;c++){let valueObject=array.isArray()?array.get(r,c):array;if(valueObject.isError())return valueObject;if(_array_reference){const{startRow,startColumn}=_array_reference.getRangePosition(),range={startRow:startRow+r,startColumn:startColumn+c,endRow:startRow+r,endColumn:startColumn+c};valueObject=this.createReferenceObject(_array_reference,range)}let value=_lambda.execute(accumulator,valueObject);if(value.isError())return value;value.isNull()&&(value=NumberValueObject.create(0)),accumulator=value}return accumulator.isReferenceObject()?accumulator.toArrayValueObject():accumulator}constructor(...args){super(...args),this.minParams=3,this.maxParams=3,this.needsReferenceObject=!0}},FUNCTION_NAMES_LOGICAL.REDUCE],[class Scan extends base_function_BaseFunction{calculate(initialValue,array,lambda){let _initialValue=initialValue,_initialValue_reference=null;initialValue.isReferenceObject()&&(_initialValue=initialValue.toArrayValueObject(),_initialValue_reference=initialValue);let _array=array,_array_reference=null;if(array.isReferenceObject()&&(_array=array.toArrayValueObject(),_array_reference=array),_initialValue.isError())return _initialValue;if(_array.isError())return _array;if(lambda.isError())return lambda;if(!lambda.isValueObject()||!lambda.isLambda()||2!==lambda.getLambdaPrivacyVarKeys().length)return ErrorValueObject.create(error_type_ErrorType.VALUE);if(_initialValue.isArray()){const rowCount=_initialValue.getRowCount(),columnCount=_initialValue.getColumnCount();if(rowCount>1||columnCount>1)return ErrorValueObject.create(error_type_ErrorType.CALC);_initialValue=_initialValue.get(0,0)}return this._getResult(_initialValue,_array,lambda,_initialValue_reference,_array_reference)}_getResult(initialValue,array,lambda,_initialValue_reference,_array_reference){const resultArray=[],rowCount=array.isArray()?array.getRowCount():1,columnCount=array.isArray()?array.getColumnCount():1;let accumulator=initialValue;_initialValue_reference&&(accumulator=_initialValue_reference);for(let r=0;r<rowCount;r++){const row=[];for(let c=0;c<columnCount;c++){if(accumulator.isError()){row.push(accumulator);continue}let valueObject=array.isArray()?array.get(r,c):array;if(valueObject.isError()){accumulator=valueObject,row.push(valueObject);continue}if(_array_reference){const{startRow,startColumn}=_array_reference.getRangePosition(),range={startRow:startRow+r,startColumn:startColumn+c,endRow:startRow+r,endColumn:startColumn+c};valueObject=this.createReferenceObject(_array_reference,range)}let value=lambda.execute(accumulator,valueObject);if(value.isArray()){const rowCount=value.getRowCount(),columnCount=value.getColumnCount();if(rowCount>1||columnCount>1)return ErrorValueObject.create(error_type_ErrorType.CALC);value=value.get(0,0)}value.isNull()&&(value=NumberValueObject.create(0)),accumulator=value,row.push(value)}resultArray.push(row)}return 1===rowCount&&1===columnCount?resultArray[0][0]:ArrayValueObject.create({calculateValueList:resultArray,rowCount,columnCount,unitId:this.unitId,sheetId:this.subUnitId,row:this.row,column:this.column})}constructor(...args){super(...args),this.minParams=3,this.maxParams=3,this.needsReferenceObject=!0}},FUNCTION_NAMES_LOGICAL.SCAN],[class Switch extends base_function_BaseFunction{calculate(expression,...args){if(expression.isError())return expression;const hasDefault=args.length%2!=0,defaultValue=hasDefault?args[args.length-1]:NullValueObject.create();return expression.isArray()||args.some((arg=>arg.isArray()))?this._handleArrayInputs(expression,args,defaultValue,hasDefault):this._handleNonArrayInputs(expression,args,defaultValue,hasDefault)}_handleNonArrayInputs(expression,args,defaultValue,hasDefault){for(let i=0;i<args.length-(hasDefault?1:0);i+=2){const switchValue=args[i],resultValue=args[i+1];if(!switchValue.isNull()){if(switchValue.isError())return switchValue;if(`${expression.getValue()}`.toLocaleLowerCase()===`${switchValue.getValue()}`.toLocaleLowerCase())return resultValue.isNull()?ErrorValueObject.create(error_type_ErrorType.NA):resultValue}}return defaultValue.isNull()?ErrorValueObject.create(error_type_ErrorType.NA):defaultValue}_handleArrayInputs(expression,args,defaultValue,hasDefault){const maxRowLength=Math.max(expression.isArray()?expression.getRowCount():1,...args.map((arg=>arg.isArray()?arg.getRowCount():1)),defaultValue.isArray()?defaultValue.getRowCount():1),maxColumnLength=Math.max(expression.isArray()?expression.getColumnCount():1,...args.map((arg=>arg.isArray()?arg.getColumnCount():1)),defaultValue.isArray()?defaultValue.getColumnCount():1),expandedExpression=expandArrayValueObject(maxRowLength,maxColumnLength,expression),expandedArgs=args.map((arg=>expandArrayValueObject(maxRowLength,maxColumnLength,arg,ErrorValueObject.create(error_type_ErrorType.NA)))),expandedDefault=expandArrayValueObject(maxRowLength,maxColumnLength,defaultValue,ErrorValueObject.create(error_type_ErrorType.NA));return expandedExpression.map(((expValue,rowIndex,columnIndex)=>{for(let i=0;i<expandedArgs.length-(hasDefault?1:0);i+=2){const switchValue=expandedArgs[i].get(rowIndex,columnIndex)||NullValueObject.create(),resultValue=expandedArgs[i+1].get(rowIndex,columnIndex)||NullValueObject.create();if(!switchValue.isNull()){if(switchValue.isError()||expValue.isError())return switchValue.isError()?switchValue:expValue;if(`${expValue.getValue()}`.toLocaleLowerCase()===`${switchValue.getValue()}`.toLocaleLowerCase())return resultValue.isNull()?ErrorValueObject.create(error_type_ErrorType.NA):resultValue}}const defaultCellValue=expandedDefault.get(rowIndex,columnIndex)||NullValueObject.create();return defaultCellValue.isNull()?ErrorValueObject.create(error_type_ErrorType.NA):defaultCellValue}))}constructor(...args){super(...args),this.minParams=3}},FUNCTION_NAMES_LOGICAL.SWITCH],[class True extends base_function_BaseFunction{calculate(){return BooleanValueObject.create(!0)}constructor(...args){super(...args),this.minParams=0,this.maxParams=0}},FUNCTION_NAMES_LOGICAL.TRUE],[class Xor extends base_function_BaseFunction{calculate(...logicalValues){let trueCount=0,noBoolean=!0,errorValue=null;for(const logicalValue of logicalValues){if(logicalValue.isError())return logicalValue;if(logicalValue.isArray()){if(logicalValue.iterator((value=>{if(value?.isError())return errorValue=value,!1;(value?.isBoolean()||value?.isNumber())&&(value.getValue()&&trueCount++,noBoolean=!1)})),errorValue)return errorValue}else(logicalValue.isBoolean()||logicalValue.isNumber())&&(logicalValue.getValue()&&trueCount++,noBoolean=!1)}return noBoolean?ErrorValueObject.create(error_type_ErrorType.VALUE):BooleanValueObject.create(trueCount%2==1)}constructor(...args){super(...args),this.minParams=1,this.maxParams=255}},FUNCTION_NAMES_LOGICAL.XOR]];var FUNCTION_NAMES_LOOKUP=function(FUNCTION_NAMES_LOOKUP){return FUNCTION_NAMES_LOOKUP.ADDRESS="ADDRESS",FUNCTION_NAMES_LOOKUP.AREAS="AREAS",FUNCTION_NAMES_LOOKUP.CHOOSE="CHOOSE",FUNCTION_NAMES_LOOKUP.CHOOSECOLS="CHOOSECOLS",FUNCTION_NAMES_LOOKUP.CHOOSEROWS="CHOOSEROWS",FUNCTION_NAMES_LOOKUP.COLUMN="COLUMN",FUNCTION_NAMES_LOOKUP.COLUMNS="COLUMNS",FUNCTION_NAMES_LOOKUP.DROP="DROP",FUNCTION_NAMES_LOOKUP.EXPAND="EXPAND",FUNCTION_NAMES_LOOKUP.FILTER="FILTER",FUNCTION_NAMES_LOOKUP.FORMULATEXT="FORMULATEXT",FUNCTION_NAMES_LOOKUP.GETPIVOTDATA="GETPIVOTDATA",FUNCTION_NAMES_LOOKUP.HLOOKUP="HLOOKUP",FUNCTION_NAMES_LOOKUP.HSTACK="HSTACK",FUNCTION_NAMES_LOOKUP.HYPERLINK="HYPERLINK",FUNCTION_NAMES_LOOKUP.IMAGE="IMAGE",FUNCTION_NAMES_LOOKUP.INDEX="INDEX",FUNCTION_NAMES_LOOKUP.INDIRECT="INDIRECT",FUNCTION_NAMES_LOOKUP.LOOKUP="LOOKUP",FUNCTION_NAMES_LOOKUP.MATCH="MATCH",FUNCTION_NAMES_LOOKUP.OFFSET="OFFSET",FUNCTION_NAMES_LOOKUP.ROW="ROW",FUNCTION_NAMES_LOOKUP.ROWS="ROWS",FUNCTION_NAMES_LOOKUP.RTD="RTD",FUNCTION_NAMES_LOOKUP.SORT="SORT",FUNCTION_NAMES_LOOKUP.SORTBY="SORTBY",FUNCTION_NAMES_LOOKUP.TAKE="TAKE",FUNCTION_NAMES_LOOKUP.TOCOL="TOCOL",FUNCTION_NAMES_LOOKUP.TOROW="TOROW",FUNCTION_NAMES_LOOKUP.TRANSPOSE="TRANSPOSE",FUNCTION_NAMES_LOOKUP.UNIQUE="UNIQUE",FUNCTION_NAMES_LOOKUP.VLOOKUP="VLOOKUP",FUNCTION_NAMES_LOOKUP.VSTACK="VSTACK",FUNCTION_NAMES_LOOKUP.WRAPCOLS="WRAPCOLS",FUNCTION_NAMES_LOOKUP.WRAPROWS="WRAPROWS",FUNCTION_NAMES_LOOKUP.XLOOKUP="XLOOKUP",FUNCTION_NAMES_LOOKUP.XMATCH="XMATCH",FUNCTION_NAMES_LOOKUP}({});const functionLookup=[[class Address extends base_function_BaseFunction{calculate(rowNumber,columnNumber,absNumber,a1,sheetText){if(rowNumber.isError())return rowNumber;if(columnNumber.isError())return columnNumber;if(absNumber?.isError())return absNumber;if(a1?.isError())return a1;if(sheetText?.isError())return sheetText;const _absNumber=absNumber??NumberValueObject.create(1),_a1=a1??BooleanValueObject.create(!0),_sheetText=sheetText??StringValueObject.create(""),maxRowLength=Math.max(rowNumber.isArray()?rowNumber.getRowCount():1,columnNumber.isArray()?columnNumber.getRowCount():1,_absNumber.isArray()?_absNumber.getRowCount():1,_a1.isArray()?_a1.getRowCount():1,_sheetText.isArray()?_sheetText.getRowCount():1),maxColumnLength=Math.max(rowNumber.isArray()?rowNumber.getColumnCount():1,columnNumber.isArray()?columnNumber.getColumnCount():1,_absNumber.isArray()?_absNumber.getColumnCount():1,_a1.isArray()?_a1.getColumnCount():1,_sheetText.isArray()?_sheetText.getColumnCount():1),rowNumArray=expandArrayValueObject(maxRowLength,maxColumnLength,rowNumber,ErrorValueObject.create(error_type_ErrorType.NA)),columnNumArray=expandArrayValueObject(maxRowLength,maxColumnLength,columnNumber,ErrorValueObject.create(error_type_ErrorType.NA)),absNumArray=expandArrayValueObject(maxRowLength,maxColumnLength,_absNumber,ErrorValueObject.create(error_type_ErrorType.NA)),a1Array=expandArrayValueObject(maxRowLength,maxColumnLength,_a1,ErrorValueObject.create(error_type_ErrorType.NA)),sheetTextArray=expandArrayValueObject(maxRowLength,maxColumnLength,_sheetText,ErrorValueObject.create(error_type_ErrorType.NA));return rowNumArray.map(((rowNumValue,rowIndex,columnIndex)=>{const columnNumValue=columnNumArray.get(rowIndex,columnIndex)||ErrorValueObject.create(error_type_ErrorType.NA),absNumValue=absNumArray.get(rowIndex,columnIndex)||ErrorValueObject.create(error_type_ErrorType.NA),a1Value=a1Array.get(rowIndex,columnIndex)||ErrorValueObject.create(error_type_ErrorType.NA),sheetTextValue=sheetTextArray.get(rowIndex,columnIndex)||ErrorValueObject.create(error_type_ErrorType.NA);return rowNumValue.isError()?rowNumValue:columnNumValue.isError()?columnNumValue:absNumValue.isError()?absNumValue:a1Value.isError()?a1Value:sheetTextValue.isError()?sheetTextValue:this._calculateSingleCell(rowNumValue,columnNumValue,absNumValue,a1Value,sheetTextValue)}))}_calculateSingleCell(rowNumber,columnNumber,absNumber,a1,sheetText){const row=Number.parseInt(""+(Number(rowNumber.getValue())-1)),column=Number.parseInt(""+(Number(columnNumber.getValue())-1)),absNumberValue=Number.parseInt(`${Number(absNumber.getValue())}`);if(Number.isNaN(row)||Number.isNaN(column)||Number.isNaN(absNumberValue)||absNumberValue<1||absNumberValue>4)return ErrorValueObject.create(error_type_ErrorType.VALUE);const absType=function transformAbsoluteRefType(number){switch(number){case 1:default:return src.F6v.ALL;case 2:return src.F6v.ROW;case 3:return src.F6v.COLUMN;case 4:return src.F6v.NONE}}(absNumberValue),a1Value=this.getZeroOrOneByOneDefault(a1),sheetName=addQuotesBothSides(`${sheetText.getValue()}`),range={startRow:row,startColumn:column,endRow:row,endColumn:column,startAbsoluteRefType:absType,endAbsoluteRefType:absType},rangeString=a1&&!a1Value?function serializeRangeToR1C1(range){const startRowRef=getR1C1Ref(range.startRow,range.startAbsoluteRefType,!0),startColumnRef=getR1C1Ref(range.startColumn,range.startAbsoluteRefType,!1),endRowRef=getR1C1Ref(range.endRow,range.endAbsoluteRefType,!0),endColumnRef=getR1C1Ref(range.endColumn,range.endAbsoluteRefType,!1);return startRowRef===endRowRef&&startColumnRef===endColumnRef?`R${startRowRef}C${startColumnRef}`:`R${startRowRef}C${startColumnRef}:R${endRowRef}C${endColumnRef}`}(range):serializeRange(range);return StringValueObject.create(""!==sheetName?`${sheetName}!${rangeString}`:rangeString)}constructor(...args){super(...args),this.minParams=2,this.maxParams=5}},FUNCTION_NAMES_LOOKUP.ADDRESS],[class Areas extends base_function_BaseFunction{calculate(reference){return reference.isReferenceObject()?NumberValueObject.create(1):ErrorValueObject.create(error_type_ErrorType.VALUE)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1,this.needsReferenceObject=!0}},FUNCTION_NAMES_LOOKUP.AREAS],[class Choose extends base_function_BaseFunction{calculate(indexNum,...variants){let _indexNum=indexNum;if(_indexNum.isError())return _indexNum;if(_indexNum.isReferenceObject()&&(_indexNum=_indexNum.toArrayValueObject()),!_indexNum.isArray()){const index=_indexNum.convertToNumberObjectValue();if(index.isError())return index;return variants[Math.trunc(+index.getValue())-1]||ErrorValueObject.create(error_type_ErrorType.VALUE)}let maxRowLength=_indexNum.isArray()?_indexNum.getRowCount():1,maxColumnLength=_indexNum.isArray()?_indexNum.getColumnCount():1;variants.forEach(((variant,i)=>{if(variant.isArray()){const arrayValue=variant;maxRowLength=Math.max(maxRowLength,arrayValue.getRowCount()),maxColumnLength=Math.max(maxColumnLength,arrayValue.getColumnCount())}else maxRowLength=Math.max(maxRowLength,1),maxColumnLength=Math.max(maxColumnLength,1)}));const indexNumArray=expandArrayValueObject(maxRowLength,maxColumnLength,_indexNum,ErrorValueObject.create(error_type_ErrorType.NA)),arrayValueObjectList=variants.map((variant=>{let _variant=variant;return _variant.isReferenceObject()&&(_variant=_variant.toArrayValueObject()),expandArrayValueObject(maxRowLength,maxColumnLength,_variant,ErrorValueObject.create(error_type_ErrorType.NA))}));return indexNumArray.map(((indexNumValue,row,column)=>{if(indexNumValue.isError())return indexNumValue;const index=indexNumValue.convertToNumberObjectValue();if(index.isError())return index;const arrayValueObject=arrayValueObjectList[Math.trunc(+index.getValue())-1];let valueObject=arrayValueObject?.get(row,column)||ErrorValueObject.create(error_type_ErrorType.VALUE);return valueObject?.isNull()&&(valueObject=NumberValueObject.create(0)),valueObject}))}constructor(...args){super(...args),this.minParams=2,this.maxParams=255,this.needsReferenceObject=!0}},FUNCTION_NAMES_LOOKUP.CHOOSE],[class Choosecols extends base_function_BaseFunction{calculate(array,...variants){if(array.isError())return array;const arrayRowCount=array.isArray()?array.getRowCount():1,arrayColumnCount=array.isArray()?array.getColumnCount():1,result=[];for(let i=0;i<variants.length;i++){let variantObject=variants[i];if(variantObject.isArray()){const variantRowCount=variantObject.getRowCount(),variantColumnCount=variantObject.getColumnCount();if(variantRowCount>1||variantColumnCount>1)return ErrorValueObject.create(error_type_ErrorType.VALUE);variantObject=variantObject.get(0,0)}if(variantObject.isString()&&(variantObject=variantObject.convertToNumberObjectValue()),variantObject.isError())return variantObject;const variantValue=Math.trunc(+variantObject.getValue());if(0===variantValue||Math.abs(variantValue)>arrayColumnCount)return ErrorValueObject.create(error_type_ErrorType.VALUE);let searchColArray=array;arrayColumnCount>1&&(searchColArray=variantValue<0?array.slice(void 0,[variantValue+arrayColumnCount,variantValue+1+arrayColumnCount]):array.slice(void 0,[variantValue-1,variantValue]));for(let r=0;r<arrayRowCount;r++)result[r]||(result[r]=[]),array.isArray()?result[r].push(searchColArray.get(r,0)):result[r].push(array)}return ArrayValueObject.create({calculateValueList:result,rowCount:result.length,columnCount:result[0].length||0,unitId:this.unitId,sheetId:this.subUnitId,row:this.row,column:this.column})}constructor(...args){super(...args),this.minParams=2,this.maxParams=255}},FUNCTION_NAMES_LOOKUP.CHOOSECOLS],[class Chooserows extends base_function_BaseFunction{calculate(array,...variants){if(array.isError())return array;const arrayRowCount=array.isArray()?array.getRowCount():1,result=[];for(let i=0;i<variants.length;i++){let variantObject=variants[i];if(variantObject.isArray()){const variantRowCount=variantObject.getRowCount(),variantColumnCount=variantObject.getColumnCount();if(variantRowCount>1||variantColumnCount>1)return ErrorValueObject.create(error_type_ErrorType.VALUE);variantObject=variantObject.get(0,0)}if(variantObject.isString()&&(variantObject=variantObject.convertToNumberObjectValue()),variantObject.isError())return variantObject;const variantValue=Math.trunc(+variantObject.getValue());if(0===variantValue||Math.abs(variantValue)>arrayRowCount)return ErrorValueObject.create(error_type_ErrorType.VALUE);let searchRowArray=array;arrayRowCount>1&&(searchRowArray=variantValue<0?array.slice([variantValue+arrayRowCount,variantValue+1+arrayRowCount]):array.slice([variantValue-1,variantValue])),array.isArray()?result.push(searchRowArray.getArrayValue()[0]):result.push([array])}return ArrayValueObject.create({calculateValueList:result,rowCount:result.length,columnCount:result[0].length||0,unitId:this.unitId,sheetId:this.subUnitId,row:this.row,column:this.column})}constructor(...args){super(...args),this.minParams=2,this.maxParams=255}},FUNCTION_NAMES_LOOKUP.CHOOSEROWS],[class Column extends base_function_BaseFunction{calculate(reference){if(null==reference)return NumberValueObject.create(this.column+1);if(reference.isError())return reference;if(!reference.isArray())return ErrorValueObject.create(error_type_ErrorType.NA);const column=reference.getCurrentColumn(),columnCount=reference.getColumnCount(),calculateValueList=[];for(let i=0;i<columnCount;i++)calculateValueList.push(NumberValueObject.create(column+i+1));const arrayValueObjectData={calculateValueList:[calculateValueList],rowCount:1,columnCount,unitId:this.unitId||"",sheetId:this.subUnitId||"",row:this.row,column:this.column};return ArrayValueObject.create(arrayValueObjectData)}constructor(...args){super(...args),this.minParams=0,this.maxParams=1}},FUNCTION_NAMES_LOOKUP.COLUMN],[class Columns extends base_function_BaseFunction{calculate(reference){if(reference.isError())return reference;if(reference.isString()||reference.isNumber()||reference.isBoolean())return NumberValueObject.create(1);if(!reference.isArray())return ErrorValueObject.create(error_type_ErrorType.NA);const columnCount=reference.getColumnCount();return NumberValueObject.create(columnCount)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_LOOKUP.COLUMNS],[class Drop extends base_function_BaseFunction{calculate(array,rows,columns){const _columns=columns??NumberValueObject.create(0),arrayRowCount=array.isArray()?array.getRowCount():1,arrayColumnCount=array.isArray()?array.getColumnCount():1,maxRowLength=Math.max(rows.isArray()?rows.getRowCount():1,_columns.isArray()?_columns.getRowCount():1),maxColumnLength=Math.max(rows.isArray()?rows.getColumnCount():1,_columns.isArray()?_columns.getColumnCount():1),rowsArray=expandArrayValueObject(maxRowLength,maxColumnLength,rows,ErrorValueObject.create(error_type_ErrorType.NA)),columnsArray=expandArrayValueObject(maxRowLength,maxColumnLength,_columns,ErrorValueObject.create(error_type_ErrorType.NA));if(maxRowLength>1||maxColumnLength>1)return rowsArray.mapValue(((rowsObject,rowIndex,columnIndex)=>{const columnsObject=columnsArray.get(rowIndex,columnIndex);if(array.isError())return array;if(array.isNull())return ErrorValueObject.create(error_type_ErrorType.VALUE);const{isError,errorObject}=this._checkRowsColumns(rowsObject,columnsObject,arrayRowCount,arrayColumnCount);return isError?errorObject:array.isArray()?ErrorValueObject.create(error_type_ErrorType.VALUE):array}));if(array.isError())return array;if(array.isNull())return ErrorValueObject.create(error_type_ErrorType.VALUE);const rowsObject=rows.isArray()?rows.get(0,0):rows,columnsObject=_columns.isArray()?_columns.get(0,0):_columns,{isError,errorObject,rowsValue,columnsValue}=this._checkRowsColumns(rowsObject,columnsObject,arrayRowCount,arrayColumnCount);return isError?errorObject:this._getResultArray(array,rowsValue,columnsValue,arrayRowCount,arrayColumnCount)}_checkRowsColumns(rowsObject,columnsObject,arrayRowCount,arrayColumnCount){if(rowsObject.isError())return{isError:!0,errorObject:rowsObject};if(columnsObject.isError())return{isError:!0,errorObject:columnsObject};const rowsValue=Math.trunc(+rowsObject.getValue()),columnsValue=Math.trunc(+columnsObject.getValue());return Number.isNaN(rowsValue)||Number.isNaN(columnsValue)?{isError:!0,errorObject:ErrorValueObject.create(error_type_ErrorType.VALUE)}:Math.abs(rowsValue)>=arrayRowCount||Math.abs(columnsValue)>=arrayColumnCount?{isError:!0,errorObject:ErrorValueObject.create(error_type_ErrorType.CALC)}:{isError:!1,rowsValue,columnsValue}}_getResultArray(array,rows,columns,arrayRowCount,arrayColumnCount){const rowParam=rows>=0?[rows,arrayRowCount]:[0,arrayRowCount+rows],columnParam=columns>=0?[columns,arrayColumnCount]:[0,arrayColumnCount+columns];let resultArray;return resultArray=0===rows&&0===columns?array:0===rows?array.slice(void 0,columnParam):0===columns?array.slice(rowParam,void 0):array.slice(rowParam,columnParam),resultArray=resultArray.map((valueObject=>valueObject.isNull()?NumberValueObject.create(0):valueObject)),arrayRowCount-rows==1&&arrayColumnCount-columns==1?resultArray.get(0,0):resultArray}constructor(...args){super(...args),this.minParams=2,this.maxParams=3}},FUNCTION_NAMES_LOOKUP.DROP],[class Expand extends base_function_BaseFunction{calculate(array,rows,columns,padWith){const arrayRowCount=array.isArray()?array.getRowCount():1,arrayColumnCount=array.isArray()?array.getColumnCount():1;let _rows=rows,_columns=columns??NumberValueObject.create(arrayColumnCount);const _padWith=padWith??ErrorValueObject.create(error_type_ErrorType.NA);rows.isNull()&&(_rows=NumberValueObject.create(arrayRowCount)),_columns.isNull()&&(_columns=NumberValueObject.create(arrayColumnCount));const maxRowLength=Math.max(_rows.isArray()?_rows.getRowCount():1,_columns.isArray()?_columns.getRowCount():1),maxColumnLength=Math.max(_rows.isArray()?_rows.getColumnCount():1,_columns.isArray()?_columns.getColumnCount():1),rowsArray=expandArrayValueObject(maxRowLength,maxColumnLength,_rows,ErrorValueObject.create(error_type_ErrorType.NA)),columnsArray=expandArrayValueObject(maxRowLength,maxColumnLength,_columns,ErrorValueObject.create(error_type_ErrorType.NA));if(maxRowLength>1||maxColumnLength>1)return rowsArray.mapValue(((rowsObject,rowIndex,columnIndex)=>{const columnsObject=columnsArray.get(rowIndex,columnIndex);if(array.isError())return array;if(array.isNull())return ErrorValueObject.create(error_type_ErrorType.VALUE);const{isError,errorObject}=this._checkRowsColumnsPadWith(rowsObject,columnsObject,_padWith,arrayRowCount,arrayColumnCount);return isError?errorObject:array.isArray()?array.get(0,0):array}));if(array.isError())return array;if(array.isNull())return ErrorValueObject.create(error_type_ErrorType.VALUE);const rowsObject=_rows.isArray()?_rows.get(0,0):_rows,columnsObject=_columns.isArray()?_columns.get(0,0):_columns,{isError,errorObject,rowsValue,columnsValue,padWithObject}=this._checkRowsColumnsPadWith(rowsObject,columnsObject,_padWith,arrayRowCount,arrayColumnCount);return isError?errorObject:this._getResultArray(array,rowsValue,columnsValue,padWithObject,arrayRowCount,arrayColumnCount)}_checkRowsColumnsPadWith(rowsObject,columnsObject,padWith,arrayRowCount,arrayColumnCount){if(rowsObject.isError())return{isError:!0,errorObject:rowsObject};if(columnsObject.isError())return{isError:!0,errorObject:columnsObject};const rowsValue=Math.trunc(+rowsObject.getValue()),columnsValue=Math.trunc(+columnsObject.getValue());if(Number.isNaN(rowsValue)||Number.isNaN(columnsValue))return{isError:!0,errorObject:ErrorValueObject.create(error_type_ErrorType.VALUE)};if(Math.abs(rowsValue)<arrayRowCount||Math.abs(columnsValue)<arrayColumnCount)return{isError:!0,errorObject:ErrorValueObject.create(error_type_ErrorType.VALUE)};let _padWith=padWith;if(padWith.isArray()){const rowCount=padWith.getRowCount(),columnCount=padWith.getColumnCount();if(rowCount>1||columnCount>1)return{isError:!0,errorObject:ErrorValueObject.create(error_type_ErrorType.VALUE)};_padWith=padWith.get(0,0)}return{isError:!1,rowsValue,columnsValue,padWithObject:_padWith}}_getResultArray(array,rows,columns,padWith,arrayRowCount,arrayColumnCount){let resultArray=[];resultArray=array.isArray()?array.map((valueObject=>valueObject.isNull()?NumberValueObject.create(0):valueObject)).getArrayValue():[[array]];const addRows=Math.max(0,rows-arrayRowCount),addColumns=Math.max(0,columns-arrayColumnCount);for(let r=0;r<addRows;r++)resultArray.push(new Array(arrayColumnCount).fill(padWith));for(let c=0;c<addColumns;c++)resultArray.forEach((row=>{row.push(padWith)}));return 1===rows&&1===columns?resultArray[0][0]:ArrayValueObject.create({calculateValueList:resultArray,rowCount:resultArray.length,columnCount:resultArray[0].length,unitId:this.unitId,sheetId:this.subUnitId,row:this.row,column:this.column})}constructor(...args){super(...args),this.minParams=2,this.maxParams=4}},FUNCTION_NAMES_LOOKUP.EXPAND],[class Filter extends base_function_BaseFunction{calculate(array,include,ifEmpty){const _ifEmpty=ifEmpty??ErrorValueObject.create(error_type_ErrorType.CALC);if(array.isError())return array;if(include.isError())return include;const arrayRowCount=array.isArray()?array.getRowCount():1,arrayColumnCount=array.isArray()?array.getColumnCount():1,includeRowCount=include.isArray()?include.getRowCount():1,includeColumnCount=include.isArray()?include.getColumnCount():1;return includeRowCount>1&&includeColumnCount>1||1===includeRowCount&&includeColumnCount!==arrayColumnCount||1===includeColumnCount&&includeRowCount!==arrayRowCount?ErrorValueObject.create(error_type_ErrorType.VALUE):1===arrayRowCount&&1===arrayColumnCount?this._getResultArrayByR1C1(array,include,_ifEmpty):1===includeRowCount?includeColumnCount!==arrayColumnCount?ErrorValueObject.create(error_type_ErrorType.VALUE):this._getResultArrayByR1(arrayRowCount,arrayColumnCount,array,include,_ifEmpty):1===includeColumnCount?includeRowCount!==arrayRowCount?ErrorValueObject.create(error_type_ErrorType.VALUE):this._getResultArrayByC1(arrayRowCount,arrayColumnCount,array,include,_ifEmpty):_ifEmpty}_getResultArrayByR1C1(array,include,ifEmpty){let _array=array,_include=include;if(_array.isArray()&&(_array=_array.get(0,0)),_include.isArray()&&(_include=_include.get(0,0)),_include.isString()&&(_include=_include.convertToNumberObjectValue()),_include.isError())return _include;return+_include.getValue()?_array:ifEmpty}_getResultArrayByR1(arrayRowCount,arrayColumnCount,array,include,ifEmpty){const resultArray=[];for(let c=0;c<arrayColumnCount;c++){let includeObject=include.get(0,c);if(includeObject.isString()&&(includeObject=includeObject.convertToNumberObjectValue()),includeObject.isError())return includeObject;if(+includeObject.getValue())for(let r=0;r<arrayRowCount;r++){resultArray[r]||(resultArray[r]=[]);const arrayObject=array.get(r,c);resultArray[r].push(arrayObject)}}return 0===resultArray.length?ifEmpty:ArrayValueObject.create({calculateValueList:resultArray,rowCount:resultArray.length,columnCount:resultArray[0].length||0,unitId:this.unitId,sheetId:this.subUnitId,row:this.row,column:this.column})}_getResultArrayByC1(arrayRowCount,arrayColumnCount,array,include,ifEmpty){const resultArray=[];for(let r=0;r<arrayRowCount;r++){let includeObject=include.get(r,0);if(includeObject.isString()&&(includeObject=includeObject.convertToNumberObjectValue()),includeObject.isError())return includeObject;if(!+includeObject.getValue())continue;const row=[];for(let c=0;c<arrayColumnCount;c++){const arrayObject=array.get(r,c);row.push(arrayObject)}resultArray.push(row)}return 0===resultArray.length?ifEmpty:ArrayValueObject.create({calculateValueList:resultArray,rowCount:resultArray.length,columnCount:resultArray[0].length||0,unitId:this.unitId,sheetId:this.subUnitId,row:this.row,column:this.column})}constructor(...args){super(...args),this.minParams=2,this.maxParams=3}},FUNCTION_NAMES_LOOKUP.FILTER],[class Formulatext extends base_function_BaseFunction{calculate(reference){if(!reference.isReferenceObject())return ErrorValueObject.create(error_type_ErrorType.NA);const unitId=reference.getUnitId(),sheetId=reference.getSheetId(),unitData=reference.getUnitData(),cellData=unitData[unitId]?.[sheetId]?.cellData,{startRow,startColumn}=reference.getRangePosition(),resultArray=reference.toArrayValueObject().mapValue(((_,rowIndex,columnIndex)=>{const cellValue=cellData.getValue(startRow+rowIndex,startColumn+columnIndex);if(cellValue?.f||cellValue?.si){const formulaString=this._formulaDataModel.getFormulaStringByCell(startRow+rowIndex,startColumn+columnIndex,sheetId,unitId);return StringValueObject.create(formulaString)}return ErrorValueObject.create(error_type_ErrorType.NA)}));return 1===resultArray.getRowCount()&&1===resultArray.getColumnCount()?resultArray.get(0,0):resultArray}constructor(...args){super(...args),this.minParams=1,this.maxParams=1,this.needsReferenceObject=!0,this.needsFormulaDataModel=!0}},FUNCTION_NAMES_LOOKUP.FORMULATEXT],[class Hlookup extends base_function_BaseFunction{calculate(lookupValue,tableArray,rowIndexNum,rangeLookup){if(lookupValue.isError())return lookupValue;if(tableArray.isError())return ErrorValueObject.create(error_type_ErrorType.REF);if(!tableArray.isArray())return ErrorValueObject.create(error_type_ErrorType.NA);if(rowIndexNum.isError())return ErrorValueObject.create(error_type_ErrorType.NA);if(rangeLookup?.isError())return ErrorValueObject.create(error_type_ErrorType.NA);const rangeLookupValue=this.getZeroOrOneByOneDefault(rangeLookup);if(null==rangeLookupValue)return ErrorValueObject.create(error_type_ErrorType.VALUE);const rowIndexNumValue=this.getIndexNumValue(rowIndexNum);if(rowIndexNumValue instanceof ErrorValueObject)return rowIndexNumValue;const searchArray=tableArray.slice([0,1]),resultArray=tableArray.slice([rowIndexNumValue-1,rowIndexNumValue]);return null==searchArray||null==resultArray?ErrorValueObject.create(error_type_ErrorType.REF):lookupValue.isArray()?lookupValue.map((value=>this._handleSingleObject(value,searchArray,resultArray,rangeLookupValue))):this._handleSingleObject(lookupValue,searchArray,resultArray,rangeLookupValue)}_handleSingleObject(value,searchArray,resultArray,rangeLookupValue){return 0===rangeLookupValue?this.equalSearch(value,searchArray,resultArray):this.binarySearch(value,searchArray,resultArray)}constructor(...args){super(...args),this.minParams=3,this.maxParams=4}},FUNCTION_NAMES_LOOKUP.HLOOKUP],[class Hstack extends base_function_BaseFunction{calculate(...variants){const maxRowLength=Math.max(...variants.map((variantObject=>variantObject.isArray()?variantObject.getRowCount():1))),result=[];for(let i=0;i<variants.length;i++){const variantObject=variants[i];if(variantObject.isError())return variantObject;const rowCount=variantObject.isArray()?variantObject.getRowCount():1,columnCount=variantObject.isArray()?variantObject.getColumnCount():1;for(let r=0;r<maxRowLength;r++){result[r]||(result[r]=[]);for(let c=0;c<columnCount;c++){let singleObject=variantObject;variantObject.isArray()&&(singleObject=variantObject.get(r,c)),r>rowCount-1||!singleObject?result[r].push(ErrorValueObject.create(error_type_ErrorType.NA)):result[r].push(singleObject)}}}return ArrayValueObject.create({calculateValueList:result,rowCount:result.length,columnCount:result[0].length||0,unitId:this.unitId,sheetId:this.subUnitId,row:this.row,column:this.column})}constructor(...args){super(...args),this.minParams=1,this.maxParams=255}},FUNCTION_NAMES_LOOKUP.HSTACK],[class Index extends base_function_BaseFunction{calculate(reference,rowNum,columnNum,areaNum){if(reference.isError())return reference;if(rowNum?.isError())return rowNum;if(columnNum?.isError())return columnNum;if(areaNum?.isError())return areaNum;let _rowNum,_columnNum,referenceRowCount=0,referenceColumnCount=0;if(reference.isValueObject())referenceRowCount=1,referenceColumnCount=1;else{if(!reference.isReferenceObject())return ErrorValueObject.create(error_type_ErrorType.VALUE);{const{startRow,endRow,startColumn,endColumn}=reference.getRangePosition();referenceRowCount=endRow-startRow+1,referenceColumnCount=endColumn-startColumn+1}}1===referenceRowCount&&referenceColumnCount>1&&null==columnNum?(_columnNum=rowNum??NumberValueObject.create(0),_rowNum=NumberValueObject.create(0)):(_rowNum=rowNum??NumberValueObject.create(0),_columnNum=columnNum??NumberValueObject.create(0));let _areaNum=areaNum??NumberValueObject.create(1);_rowNum.isReferenceObject()&&(_rowNum=_rowNum.toArrayValueObject()),_columnNum.isReferenceObject()&&(_columnNum=_columnNum.toArrayValueObject()),_areaNum.isReferenceObject()&&(_areaNum=_areaNum.toArrayValueObject());const maxRowLength=Math.max(_rowNum.isArray()?_rowNum.getRowCount():1,_columnNum.isArray()?_columnNum.getRowCount():1,_areaNum.isArray()?_areaNum.getRowCount():1),maxColumnLength=Math.max(_rowNum.isArray()?_rowNum.getColumnCount():1,_columnNum.isArray()?_columnNum.getColumnCount():1,_areaNum.isArray()?_areaNum.getColumnCount():1);if(1===maxRowLength&&1===maxColumnLength)return this._calculateSingleCell(reference,_rowNum,_columnNum,_areaNum);{const rowNumArray=expandArrayValueObject(maxRowLength,maxColumnLength,_rowNum,ErrorValueObject.create(error_type_ErrorType.NA)),columnNumArray=expandArrayValueObject(maxRowLength,maxColumnLength,_columnNum,ErrorValueObject.create(error_type_ErrorType.NA)),areaNumArray=expandArrayValueObject(maxRowLength,maxColumnLength,_areaNum,ErrorValueObject.create(error_type_ErrorType.NA));return rowNumArray.map(((rowNumValue,rowIndex,columnIndex)=>{const columnNumValue=columnNumArray.get(rowIndex,columnIndex)||NullValueObject.create(),areaNumValue=areaNumArray.get(rowIndex,columnIndex)||NullValueObject.create(),result=this._calculateSingleCell(reference,rowNumValue,columnNumValue,areaNumValue);return result.isReferenceObject()?result.toArrayValueObject().getFirstCell():result}))}}_calculateSingleCell(reference,rowNum,columnNum,areaNum){if(rowNum.isError())return rowNum;const rowNumberValue=this._getNumberValue(rowNum);if(void 0===rowNumberValue||rowNumberValue<0)return ErrorValueObject.create(error_type_ErrorType.VALUE);if(columnNum.isError())return columnNum;const columnNumberValue=this._getNumberValue(columnNum);if(void 0===columnNumberValue||columnNumberValue<0)return ErrorValueObject.create(error_type_ErrorType.VALUE);if(areaNum.isError())return areaNum;const areaNumberValue=this._getAreaNumberValue(areaNum);return void 0===areaNumberValue||areaNumberValue<1?ErrorValueObject.create(error_type_ErrorType.VALUE):reference.isReferenceObject()?this._getReferenceObject(reference,rowNumberValue,columnNumberValue,areaNumberValue):reference.isValueObject()&&1===rowNumberValue&&1===columnNumberValue?reference:ErrorValueObject.create(error_type_ErrorType.REF)}_getNumberValue(numberValueObject){if(null==numberValueObject)return 0;let logicValue=0;if(numberValueObject.isBoolean()){!0===numberValueObject.getValue()&&(logicValue=1)}else{if(numberValueObject.isString())return;numberValueObject.isNumber()?logicValue=Math.floor(numberValueObject.getValue()):numberValueObject.isNull()&&(logicValue=0)}return logicValue}_getAreaNumberValue(numberValueObject){if(null==numberValueObject)return 1;let logicValue=0;if(numberValueObject.isBoolean()){!0===numberValueObject.getValue()&&(logicValue=1)}else{if(numberValueObject.isString())return;numberValueObject.isNumber()?logicValue=Math.floor(numberValueObject.getValue()):numberValueObject.isNull()&&(logicValue=0)}return logicValue}_getReferenceObject(reference,rowNumberValue,columnNumberValue,areaNumberValue){const{startRow,endRow,startColumn,endColumn}=reference.getRangePosition();let referenceStartRow=0,referenceEndRow=0,referenceStartColumn=0,referenceEndColumn=0;if(0===rowNumberValue?(referenceStartRow=startRow,referenceEndRow=endRow):referenceStartRow=referenceEndRow=startRow+rowNumberValue-1,0===columnNumberValue?(referenceStartColumn=startColumn,referenceEndColumn=endColumn):referenceStartColumn=referenceEndColumn=startColumn+columnNumberValue-1,referenceStartRow>endRow||referenceStartColumn>endColumn)return ErrorValueObject.create(error_type_ErrorType.REF);const range={startRow:referenceStartRow,startColumn:referenceStartColumn,endRow:referenceEndRow,endColumn:referenceEndColumn};return this.createReferenceObject(reference,range)}constructor(...args){super(...args),this.minParams=1,this.maxParams=4,this.needsReferenceObject=!0}},FUNCTION_NAMES_LOOKUP.INDEX],[class Indirect extends base_function_BaseFunction{isAddress(){return!0}calculate(refText,a1){if(refText.isError())return refText;if(a1?.isError())return a1;let a1Value=this.getZeroOrOneByOneDefault(a1);null==a1Value&&(a1Value=1);let _refText=refText;if(refText.isArray()){const rowCount=refText.getRowCount(),columnCount=refText.getColumnCount();if(rowCount>1||columnCount>1)return refText.map((()=>ErrorValueObject.create(error_type_ErrorType.VALUE)));_refText=refText.getFirstCell()}return this._handleSingleObject(_refText,a1Value)}_handleSingleObject(refTextObject,a1Value){const refTextValue=`${refTextObject.getValue()}`;if(""===refTextValue.trim())return ErrorValueObject.create(error_type_ErrorType.REF);const refTextV=this._convertToDefinedName(refTextValue);if(0===a1Value){const gridRange=function deserializeRangeForR1C1(refString,currentRow=0,currentColumn=0){const{refBody,sheetName,unitId}=handleRefStringInfo(refString),colonIndex=refBody.indexOf(":");if(-1===colonIndex){const grid=singleReference(refBody,currentRow,currentColumn),row=grid.row,column=grid.column,absoluteRefType=grid.absoluteRefType;return{unitId,sheetName,range:{startRow:row,startColumn:column,endRow:row,endColumn:column,startAbsoluteRefType:absoluteRefType,endAbsoluteRefType:absoluteRefType}}}const refStartString=refBody.substring(0,colonIndex),refEndString=refBody.substring(colonIndex+1),startGrid=singleReference(refStartString,currentRow,currentColumn),endGrid=singleReference(refEndString,currentRow,currentColumn);return{unitId,sheetName,range:{startRow:startGrid.row,startColumn:startGrid.column,endRow:endGrid.row,endColumn:endGrid.column,startAbsoluteRefType:startGrid.absoluteRefType,endAbsoluteRefType:endGrid.absoluteRefType}}}(refTextV),{range,sheetName,unitId}=gridRange,rangeReferenceObject=new RangeReferenceObject(range);return rangeReferenceObject.setForcedUnitIdDirect(unitId),rangeReferenceObject.setForcedSheetName(sheetName),this._setDefault(rangeReferenceObject)}if(regexTestSingeRange(refTextV))return this._setDefault(new CellReferenceObject(refTextV));if(regexTestRow(refTextV))return this._setDefault(new RowReferenceObject(refTextV));if(regexTestColumn(refTextV))return this._setDefault(new ColumnReferenceObject(refTextV));const gridRange=deserializeRangeWithSheetWithCache(refTextV),{range,sheetName,unitId}=gridRange;if(Number.isNaN(range.startRow)||range.endRow+1>1048576||Number.isNaN(range.startColumn)||range.endColumn+1>16384)return ErrorValueObject.create(error_type_ErrorType.REF);const rangeReferenceObject=new RangeReferenceObject(range);return rangeReferenceObject.setForcedUnitIdDirect(unitId),rangeReferenceObject.setForcedSheetName(sheetName),this._setDefault(rangeReferenceObject)}_setDefault(object){return null==this.unitId||null==this.subUnitId?ErrorValueObject.create(error_type_ErrorType.REF):(object.setDefaultUnitId(this.unitId),object.setDefaultSheetId(this.subUnitId),object)}_convertToDefinedName(refText){const definedName=this.getDefinedName(refText);if(null==definedName)return refText;const formulaOrRefString=definedName.formulaOrRefString;return null==formulaOrRefString?refText:formulaOrRefString.startsWith(operatorToken.EQUALS)?formulaOrRefString.slice(1):formulaOrRefString}constructor(...args){super(...args),this.minParams=1,this.maxParams=2}},FUNCTION_NAMES_LOOKUP.INDIRECT],[class Lookup extends base_function_BaseFunction{calculate(lookupValue,lookupVectorOrArray,resultVector){return lookupValue.isError()?lookupValue:lookupVectorOrArray.isError()?ErrorValueObject.create(error_type_ErrorType.REF):lookupVectorOrArray.isArray()?resultVector?.isError()?resultVector:1===lookupVectorOrArray.getColumnCount()||1===lookupVectorOrArray.getRowCount()?null==resultVector||resultVector.isArray()?this._handleVector(lookupValue,lookupVectorOrArray,resultVector):ErrorValueObject.create(error_type_ErrorType.REF):this._handleArray(lookupValue,lookupVectorOrArray):ErrorValueObject.create(error_type_ErrorType.VALUE)}_handleVector(lookupValue,lookupVector,resultVector){let _resultVector=resultVector;if(null==_resultVector)_resultVector=lookupVector;else if(_resultVector.getRowCount()!==lookupVector.getRowCount()||_resultVector.getColumnCount()!==lookupVector.getColumnCount())return ErrorValueObject.create(error_type_ErrorType.REF);return lookupValue.isArray()?lookupValue.map((value=>this.binarySearch(value,lookupVector,_resultVector))):this.binarySearch(lookupValue,lookupVector,_resultVector)}_handleArray(lookupValue,lookupArray){const rowCount=lookupArray.getRowCount(),columnCount=lookupArray.getColumnCount();let searchArray,resultArray;return columnCount>rowCount?(searchArray=lookupArray.slice([0,1]),resultArray=lookupArray.slice([rowCount-1,rowCount])):(searchArray=lookupArray.slice(void 0,[0,1]),resultArray=lookupArray.slice(void 0,[columnCount-1,columnCount])),null==searchArray||null==resultArray?ErrorValueObject.create(error_type_ErrorType.VALUE):lookupValue.isArray()?lookupValue.map((value=>this.binarySearch(value,searchArray,resultArray))):this.binarySearch(lookupValue,searchArray,resultArray)}constructor(...args){super(...args),this.minParams=2,this.maxParams=3,this.needsExpandParams=!0}},FUNCTION_NAMES_LOOKUP.LOOKUP],[class Match extends base_function_BaseFunction{calculate(lookupValue,lookupArray,matchType){if(lookupValue.isError())return lookupValue;if(lookupArray.isError())return ErrorValueObject.create(error_type_ErrorType.REF);if(!lookupArray.isArray())return ErrorValueObject.create(error_type_ErrorType.VALUE);const rowCountLookup=lookupArray.getRowCount(),columnCountLookup=lookupArray.getColumnCount();if(1!==rowCountLookup&&1!==columnCountLookup)return ErrorValueObject.create(error_type_ErrorType.NA);if(matchType?.isError())return ErrorValueObject.create(error_type_ErrorType.NA);const matchTypeValue=this.getMatchTypeValue(matchType);return null==matchTypeValue?ErrorValueObject.create(error_type_ErrorType.VALUE):lookupValue.isArray()?lookupValue.map((value=>this._handleSingleObject(value,lookupArray,matchTypeValue))):this._handleSingleObject(lookupValue,lookupArray,matchTypeValue)}_handleSingleObject(value,searchArray,matchTypeValue){const searchType=this._getSearchModeValue(matchTypeValue),result=searchArray.orderSearch(value,searchType);if(null==result)return ErrorValueObject.create(error_type_ErrorType.NA);if(result instanceof ErrorValueObject)return result;const resultNumber=1===searchArray.getRowCount()?result.column+1:result.row+1;return NumberValueObject.create(resultNumber)}_getSearchModeValue(searchModeValue){switch(searchModeValue){case 1:return ArrayOrderSearchType.MIN;case 0:return ArrayOrderSearchType.NORMAL;case-1:return ArrayOrderSearchType.MAX}}constructor(...args){super(...args),this.minParams=2,this.maxParams=3}},FUNCTION_NAMES_LOOKUP.MATCH],[class Offset extends base_function_BaseFunction{isAddress(){return!0}calculate(reference,rows,columns,height,width){if(reference.isError())return reference;if(rows.isError())return rows;if(columns.isError())return columns;if(height?.isError())return height;if(width?.isError())return width;if(!reference.isReferenceObject())return ErrorValueObject.create(error_type_ErrorType.VALUE);const rowCount=reference.getRowCount(),columnCount=reference.getColumnCount();let _rows=rows;_rows.isReferenceObject()&&(_rows=_rows.toArrayValueObject());let _columns=columns;_columns.isReferenceObject()&&(_columns=_columns.toArrayValueObject());let _height=height??NumberValueObject.create(rowCount);_height.isReferenceObject()&&(_height=_height.toArrayValueObject()),_height.isNull()&&(_height=NumberValueObject.create(rowCount));let _width=width??NumberValueObject.create(columnCount);_width.isReferenceObject()&&(_width=_width.toArrayValueObject()),_width.isNull()&&(_width=NumberValueObject.create(columnCount));const maxRowLength=Math.max(_rows.isArray()?_rows.getRowCount():1,_columns.isArray()?_columns.getRowCount():1,_height.isArray()?_height.getRowCount():1,_width.isArray()?_width.getRowCount():1),maxColumnLength=Math.max(_rows.isArray()?_rows.getColumnCount():1,_columns.isArray()?_columns.getColumnCount():1,_height.isArray()?_height.getColumnCount():1,_width.isArray()?_width.getColumnCount():1);if(1===maxRowLength&&1===maxColumnLength)return _rows=_rows.isArray()?_rows.get(0,0):_rows,_columns=_columns.isArray()?_columns.get(0,0):_columns,_height=_height.isArray()?_height.get(0,0):_height,_width=_width.isArray()?_width.get(0,0):_width,this._handleSingleObject(reference,_rows,_columns,_height,_width);const rowsArray=expandArrayValueObject(maxRowLength,maxColumnLength,_rows,ErrorValueObject.create(error_type_ErrorType.NA)),columnsArray=expandArrayValueObject(maxRowLength,maxColumnLength,_columns,ErrorValueObject.create(error_type_ErrorType.NA)),heightArray=expandArrayValueObject(maxRowLength,maxColumnLength,_height,ErrorValueObject.create(error_type_ErrorType.NA)),widthArray=expandArrayValueObject(maxRowLength,maxColumnLength,_width,ErrorValueObject.create(error_type_ErrorType.NA));return rowsArray.mapValue(((rowsValue,rowIndex,columnIndex)=>{const columnsValue=columnsArray.get(rowIndex,columnIndex),heightValue=heightArray.get(rowIndex,columnIndex),widthValue=widthArray.get(rowIndex,columnIndex);return rowsValue.isError()?rowsValue:columnsValue.isError()?columnsValue:heightValue.isError()?heightValue:widthValue.isError()?widthValue:this._handleSingleObject(reference,rowsValue,columnsValue,heightValue,widthValue,!0)}))}_handleSingleObject(reference,rowsValue,columnsValue,heightValue,widthValue,isReportError=!1){const{startRow:referenceStartRow,startColumn:referenceStartColumn}=reference.getRangePosition();let _rowsValue=rowsValue;if(_rowsValue.isString()&&(_rowsValue=_rowsValue.convertToNumberObjectValue()),_rowsValue.isError())return _rowsValue;let _columnsValue=columnsValue;if(_columnsValue.isString()&&(_columnsValue=_columnsValue.convertToNumberObjectValue()),_columnsValue.isError())return _columnsValue;const rowOffset=+_rowsValue.getValue(),columnOffset=+_columnsValue.getValue();if("number"!=typeof rowOffset||"number"!=typeof columnOffset)return ErrorValueObject.create(error_type_ErrorType.VALUE);const targetRow=referenceStartRow+rowOffset,targetColumn=referenceStartColumn+columnOffset;if(targetRow<0||targetColumn<0)return ErrorValueObject.create(error_type_ErrorType.REF);const heightCount=this.getIndexNumValue(heightValue),widthCount=this.getIndexNumValue(widthValue);if("number"!=typeof heightCount||"number"!=typeof widthCount)return ErrorValueObject.create(error_type_ErrorType.VALUE);if(0===heightCount||0===widthCount)return ErrorValueObject.create(error_type_ErrorType.REF);const targetRowWithHeight=heightCount>0?targetRow+heightCount-1:targetRow+heightCount+1,targetColumnWithWidth=widthCount>0?targetColumn+widthCount-1:targetColumn+widthCount+1;if(targetRowWithHeight<0||targetColumnWithWidth<0)return ErrorValueObject.create(error_type_ErrorType.REF);if(isReportError)return ErrorValueObject.create(error_type_ErrorType.VALUE);const range={startRow:targetRow<targetRowWithHeight?targetRow:targetRowWithHeight,startColumn:targetColumn<targetColumnWithWidth?targetColumn:targetColumnWithWidth,endRow:targetRow>targetRowWithHeight?targetRow:targetRowWithHeight,endColumn:targetColumn>targetColumnWithWidth?targetColumn:targetColumnWithWidth};return this.createReferenceObject(reference,range)}constructor(...args){super(...args),this.minParams=3,this.maxParams=5,this.needsReferenceObject=!0}},FUNCTION_NAMES_LOOKUP.OFFSET],[class Row extends base_function_BaseFunction{calculate(reference){if(null==reference)return NumberValueObject.create(this.row+1);if(reference.isError())return reference;if(!reference.isArray())return ErrorValueObject.create(error_type_ErrorType.NA);const row=reference.getCurrentRow(),rowCount=reference.getRowCount(),calculateValueList=[];for(let i=0;i<rowCount;i++)calculateValueList.push([NumberValueObject.create(row+i+1)]);const arrayValueObjectData={calculateValueList,rowCount,columnCount:1,unitId:this.unitId||"",sheetId:this.subUnitId||"",row:this.row,column:this.column};return ArrayValueObject.create(arrayValueObjectData)}constructor(...args){super(...args),this.minParams=0,this.maxParams=1}},FUNCTION_NAMES_LOOKUP.ROW],[class Rows extends base_function_BaseFunction{calculate(reference){if(reference.isError())return reference;if(reference.isString()||reference.isNumber()||reference.isBoolean())return NumberValueObject.create(1);if(!reference.isArray())return ErrorValueObject.create(error_type_ErrorType.NA);const rowCount=reference.getRowCount();return NumberValueObject.create(rowCount)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_LOOKUP.ROWS],[class Sort extends base_function_BaseFunction{calculate(array,sortIndex,sortOrder,byCol){const _sortIndex=sortIndex??NumberValueObject.create(1),_sortOrder=sortOrder??NumberValueObject.create(1),_byCol=byCol??BooleanValueObject.create(!1);if(_byCol.isArray()){const byColRowCount=_byCol.getRowCount(),byColColumnCount=_byCol.getColumnCount();if(1===byColRowCount&&1===byColColumnCount){const byColObject=_byCol.get(0,0);return this._handleSingleObject(array,_sortIndex,_sortOrder,byColObject)}return _byCol.map((byColObject=>{const result=this._handleSingleObject(array,_sortIndex,_sortOrder,byColObject);return result.isArray()?result.get(0,0):result}))}return this._handleSingleObject(array,_sortIndex,_sortOrder,_byCol)}_handleSingleObject(array,sortIndex,sortOrder,byCol){if(array.isError())return array;const arrayRowCount=array.isArray()?array.getRowCount():1,arrayColumnCount=array.isArray()?array.getColumnCount():1,_sortIndex=this._checkArrayError(sortIndex);if(_sortIndex.isError())return _sortIndex;const sortIndexValue=Math.floor(+_sortIndex.getValue());if(sortIndexValue<1)return ErrorValueObject.create(error_type_ErrorType.VALUE);const _sortOrder=this._checkArrayError(sortOrder);if(_sortOrder.isError())return _sortOrder;const sortOrderValue=Math.floor(+_sortOrder.getValue());if(-1!==sortOrderValue&&1!==sortOrderValue)return ErrorValueObject.create(error_type_ErrorType.VALUE);let _byCol=byCol;if(_byCol.isString()&&(_byCol=_byCol.convertToNumberObjectValue()),_byCol.isError())return _byCol;if(!array.isArray()||1===arrayRowCount&&1===arrayColumnCount)return array;const byColValue=+_byCol.getValue();return this._getResult(array,sortIndexValue,sortOrderValue,byColValue,arrayRowCount,arrayColumnCount)}_checkArrayError(variant){let _variant=variant;if(_variant.isArray()){const rowCount=_variant.getRowCount(),columnCount=_variant.getColumnCount();if(rowCount>1||columnCount>1)return ErrorValueObject.create(error_type_ErrorType.VALUE);_variant=_variant.get(0,0)}return _variant.isString()&&(_variant=_variant.convertToNumberObjectValue()),_variant}_getResult(array,sortIndexValue,sortOrderValue,byColValue,arrayRowCount,arrayColumnCount){if(byColValue){if(sortIndexValue>arrayRowCount)return ErrorValueObject.create(error_type_ErrorType.VALUE);const arrayValue=array.transpose().getArrayValue();arrayValue.sort(this._sort(sortIndexValue-1,sortOrderValue));return ArrayValueObject.create({calculateValueList:arrayValue,rowCount:arrayValue.length,columnCount:arrayValue[0].length||0,unitId:this.unitId,sheetId:this.subUnitId,row:this.row,column:this.column}).transpose()}{if(sortIndexValue>arrayColumnCount)return ErrorValueObject.create(error_type_ErrorType.VALUE);const arrayValue=array.getArrayValue();return arrayValue.sort(this._sort(sortIndexValue-1,sortOrderValue)),ArrayValueObject.create({calculateValueList:arrayValue,rowCount:arrayValue.length,columnCount:arrayValue[0].length||0,unitId:this.unitId,sheetId:this.subUnitId,row:this.row,column:this.column})}}_sort(sortIndex,sortOrder=1){const compare=getCompare();return 1===sortOrder?this._sortAsc(sortIndex,compare):this._sortDesc(sortIndex,compare)}_sortAsc(sortIndex,compare){return(a,b)=>{const columnA=a[sortIndex],columnB=b[sortIndex];if(null==columnA||columnA.isNull())return 1;if(null==columnB||columnB.isNull())return-1;if(columnA.isError()&&columnB.isError())return 0;if(columnA.isError())return 1;if(columnB.isError())return-1;const columnAValue=columnA.getValue(),columnBValue=columnB.getValue();return columnA.isBoolean()&&!0===columnAValue?1:columnB.isBoolean()&&!0===columnBValue?-1:columnA.isBoolean()&&!1===columnAValue?1:columnB.isBoolean()&&!1===columnBValue?-1:columnA.isNumber()&&columnB.isNumber()?+columnAValue-+columnBValue:compare(columnAValue,columnBValue)}}_sortDesc(sortIndex,compare){return(a,b)=>{const columnA=a[sortIndex],columnB=b[sortIndex];if(null==columnA||columnA.isNull())return 1;if(null==columnB||columnB.isNull())return-1;if(columnA.isError()&&columnB.isError())return 0;if(columnA.isError())return-1;if(columnB.isError())return 1;const columnAValue=columnA.getValue(),columnBValue=columnB.getValue();return columnA.isBoolean()&&!0===columnAValue?-1:columnB.isBoolean()&&!0===columnBValue?1:columnA.isBoolean()&&!1===columnAValue?-1:columnB.isBoolean()&&!1===columnBValue?1:columnA.isNumber()&&columnB.isNumber()?+columnBValue-+columnAValue:compare(columnBValue,columnAValue)}}constructor(...args){super(...args),this.minParams=1,this.maxParams=4}},FUNCTION_NAMES_LOOKUP.SORT],[class Sortby extends base_function_BaseFunction{calculate(array,...variants){1===variants.length&&variants.push(NumberValueObject.create(1));const variantsError=this._getVariantsError(array,...variants),{maxRowLength,maxColumnLength}=calculateMaxDimensions(variants);if(variantsError.isError()){const expandArray=expandArrayValueObject(maxRowLength,maxColumnLength,variantsError);return 1===maxRowLength&&1===maxColumnLength?expandArray.get(0,0):expandArray}const _variants=variants.map(((variant,index)=>{if(index%2==0)return variant;return expandArrayValueObject(maxRowLength,maxColumnLength,variant,ErrorValueObject.create(error_type_ErrorType.NA))})),resultArray=this._getResultArray(array,_variants,maxRowLength,maxColumnLength);return 1===maxRowLength&&1===maxColumnLength?resultArray[0][0]:ArrayValueObject.create({calculateValueList:resultArray,rowCount:resultArray.length,columnCount:resultArray[0].length||0,unitId:this.unitId,sheetId:this.subUnitId,row:this.row,column:this.column})}_getVariantsError(array,...variants){if(array.isError())return array;for(let i=0;i<variants.length;i++){const variant=variants[i];if(variant.isError())return variant}if(variants.length<2||variants.length%2!=0)return ErrorValueObject.create(error_type_ErrorType.VALUE);const arrayRowCount=array.isArray()?array.getRowCount():1,arrayColumnCount=array.isArray()?array.getColumnCount():1,byArray1RowCount=variants[0].isArray()?variants[0].getRowCount():1,byArray1ColumnCount=variants[0].isArray()?variants[0].getColumnCount():1;if(byArray1RowCount>1||byArray1ColumnCount>1){if(byArray1RowCount>1&&byArray1ColumnCount>1)return ErrorValueObject.create(error_type_ErrorType.VALUE);if(1===byArray1RowCount&&byArray1ColumnCount!==arrayColumnCount)return ErrorValueObject.create(error_type_ErrorType.VALUE);if(1===byArray1ColumnCount&&byArray1RowCount!==arrayRowCount)return ErrorValueObject.create(error_type_ErrorType.VALUE)}for(let i=2;i<variants.length;i++){if(i%2==1)continue;const byArrayRowCount=variants[i].isArray()?variants[i].getRowCount():1,byArrayColumnCount=variants[i].isArray()?variants[i].getColumnCount():1;if(byArrayRowCount!==byArray1RowCount||byArrayColumnCount!==byArray1ColumnCount)return ErrorValueObject.create(error_type_ErrorType.VALUE)}return BooleanValueObject.create(!0)}_getResultArray(array,variants,maxRowLength,maxColumnLength){const arrayRowCount=array.isArray()?array.getRowCount():1,arrayColumnCount=array.isArray()?array.getColumnCount():1,byArray1RowCount=variants[0].isArray()?variants[0].getRowCount():1,byArray1ColumnCount=variants[0].isArray()?variants[0].getColumnCount():1,resultArray=[];for(let r=0;r<maxRowLength;r++){resultArray[r]=[];for(let c=0;c<maxColumnLength;c++){const{isError,errorObject,byArrays,sortOrders}=this._getByArraysAndSortOrders(variants,r,c,byArray1ColumnCount);if(isError){resultArray[r].push(errorObject);continue}if(!array.isArray()||1===arrayRowCount&&1===arrayColumnCount){resultArray[r].push(array);continue}let arrayValue=array.getArrayValue();1===byArray1RowCount&&1===byArray1ColumnCount||(1===byArray1RowCount?(arrayValue=arrayValue.concat(byArrays),arrayValue=this._transposeArray(arrayValue),arrayValue.sort(this._sort(arrayRowCount,sortOrders)),arrayValue=this._transposeArray(arrayValue).slice(0,arrayRowCount)):1===byArray1ColumnCount&&(arrayValue=this._transposeArray(arrayValue),arrayValue=arrayValue.concat(byArrays),arrayValue=this._transposeArray(arrayValue),arrayValue.sort(this._sort(arrayColumnCount,sortOrders)),arrayValue=arrayValue.map((row=>row.slice(0,arrayColumnCount)))));const result=ArrayValueObject.create({calculateValueList:arrayValue,rowCount:arrayValue.length,columnCount:arrayValue[0].length||0,unitId:this.unitId,sheetId:this.subUnitId,row:this.row,column:this.column});maxRowLength>1||maxColumnLength>1?resultArray[r].push(result.get(0,0)):resultArray[r].push(result)}}return resultArray}_getByArraysAndSortOrders(variants,r,c,byArray1ColumnCount){const byArrays=[],sortOrders=[];let isError=!1,errorObject=null;for(let i=0;i<variants.length;i++){if(i%2==1)continue;const byArray=variants[i];let sortOrder=variants[i+1].get(r,c);if(sortOrder.isString()&&(sortOrder=sortOrder.convertToNumberObjectValue()),sortOrder.isError()){isError=!0,errorObject=sortOrder;break}const sortOrderValue=Math.floor(+sortOrder.getValue());if(-1!==sortOrderValue&&1!==sortOrderValue){isError=!0,errorObject=ErrorValueObject.create(error_type_ErrorType.VALUE);break}if(sortOrders.push(sortOrderValue),byArray.isArray()){let byArrayValue=byArray.getArrayValue();1===byArray1ColumnCount&&(byArrayValue=this._transposeArray(byArrayValue)),byArrays.push(byArrayValue[0])}else byArrays.push([byArray])}return{isError,errorObject,byArrays,sortOrders}}_transposeArray(array){const rows=array.length,cols=array[0].length,transposedArray=[];for(let col=0;col<cols;col++){transposedArray[col]=[];for(let row=0;row<rows;row++)transposedArray[col][row]=array[row][col]}return transposedArray}_sort(sortIndex,sortOrders){const compare=getCompare();return(a,b)=>{let columnA=a[sortIndex],columnB=b[sortIndex],result=this._compare(columnA,columnB,sortOrders[0],compare);if(0===result&&sortOrders.length>1)for(let i=1;i<sortOrders.length;i++)if(columnA=a[sortIndex+i],columnB=b[sortIndex+i],result=this._compare(columnA,columnB,sortOrders[i],compare),0!==result)return result;return result}}_compare(columnA,columnB,sortOrder,compare){return 1===sortOrder?this._asc(columnA,columnB,compare):this._desc(columnA,columnB,compare)}_asc(columnA,columnB,compare){if(null==columnA||columnA.isNull())return 1;if(null==columnB||columnB.isNull())return-1;if(columnA.isError()&&columnB.isError())return 0;if(columnA.isError())return 1;if(columnB.isError())return-1;const columnAValue=columnA.getValue(),columnBValue=columnB.getValue();return columnA.isBoolean()&&!0===columnAValue?1:columnB.isBoolean()&&!0===columnBValue?-1:columnA.isBoolean()&&!1===columnAValue?1:columnB.isBoolean()&&!1===columnBValue?-1:columnA.isNumber()&&columnB.isNumber()?+columnAValue-+columnBValue:compare(columnAValue,columnBValue)}_desc(columnA,columnB,compare){if(null==columnA||columnA.isNull())return 1;if(null==columnB||columnB.isNull())return-1;if(columnA.isError()&&columnB.isError())return 0;if(columnA.isError())return-1;if(columnB.isError())return 1;const columnAValue=columnA.getValue(),columnBValue=columnB.getValue();return columnA.isBoolean()&&!0===columnAValue?-1:columnB.isBoolean()&&!0===columnBValue?1:columnA.isBoolean()&&!1===columnAValue?-1:columnB.isBoolean()&&!1===columnBValue?1:columnA.isNumber()&&columnB.isNumber()?+columnBValue-+columnAValue:compare(columnBValue,columnAValue)}constructor(...args){super(...args),this.minParams=2,this.maxParams=255}},FUNCTION_NAMES_LOOKUP.SORTBY],[class Take extends base_function_BaseFunction{calculate(array,rows,columns){const arrayRowCount=array.isArray()?array.getRowCount():1,arrayColumnCount=array.isArray()?array.getColumnCount():1;let _rows=rows,_columns=columns??NumberValueObject.create(arrayColumnCount);rows.isNull()&&(_rows=NumberValueObject.create(arrayRowCount)),_columns.isNull()&&(_columns=NumberValueObject.create(arrayColumnCount));const maxRowLength=Math.max(_rows.isArray()?_rows.getRowCount():1,_columns.isArray()?_columns.getRowCount():1),maxColumnLength=Math.max(_rows.isArray()?_rows.getColumnCount():1,_columns.isArray()?_columns.getColumnCount():1),rowsArray=expandArrayValueObject(maxRowLength,maxColumnLength,_rows,ErrorValueObject.create(error_type_ErrorType.NA)),columnsArray=expandArrayValueObject(maxRowLength,maxColumnLength,_columns,ErrorValueObject.create(error_type_ErrorType.NA));if(maxRowLength>1||maxColumnLength>1)return rowsArray.mapValue(((rowsObject,rowIndex,columnIndex)=>{const columnsObject=columnsArray.get(rowIndex,columnIndex);if(array.isError())return array;if(array.isNull())return ErrorValueObject.create(error_type_ErrorType.VALUE);const{isError,errorObject}=this._checkRowsColumns(rowsObject,columnsObject,arrayRowCount,arrayColumnCount);return isError?errorObject:array.isArray()?ErrorValueObject.create(error_type_ErrorType.VALUE):array}));if(array.isError())return array;if(array.isNull())return ErrorValueObject.create(error_type_ErrorType.VALUE);const rowsObject=_rows.isArray()?_rows.get(0,0):_rows,columnsObject=_columns.isArray()?_columns.get(0,0):_columns,{isError,errorObject,rowsValue,columnsValue}=this._checkRowsColumns(rowsObject,columnsObject,arrayRowCount,arrayColumnCount);return isError?errorObject:this._getResultArray(array,rowsValue,columnsValue,arrayRowCount,arrayColumnCount)}_checkRowsColumns(rowsObject,columnsObject,arrayRowCount,arrayColumnCount){if(rowsObject.isError())return{isError:!0,errorObject:rowsObject};if(columnsObject.isError())return{isError:!0,errorObject:columnsObject};let rowsValue=Math.trunc(+rowsObject.getValue()),columnsValue=Math.trunc(+columnsObject.getValue());return Number.isNaN(rowsValue)||Number.isNaN(columnsValue)?{isError:!0,errorObject:ErrorValueObject.create(error_type_ErrorType.VALUE)}:0===Math.abs(rowsValue)||0===Math.abs(columnsValue)?{isError:!0,errorObject:ErrorValueObject.create(error_type_ErrorType.CALC)}:(rowsValue>arrayRowCount&&(rowsValue=arrayRowCount),columnsValue>arrayColumnCount&&(columnsValue=arrayColumnCount),{isError:!1,rowsValue,columnsValue})}_getResultArray(array,rows,columns,arrayRowCount,arrayColumnCount){if(!array.isArray())return array;const rowParam=rows>=0?[0,rows]:[arrayRowCount+rows,arrayRowCount],columnParam=columns>=0?[0,columns]:[arrayColumnCount+columns,arrayColumnCount];let resultArray;return resultArray=rows===arrayRowCount&&columns===arrayColumnCount?array:rows===arrayRowCount?array.slice(void 0,columnParam):columns===arrayColumnCount?array.slice(rowParam,void 0):array.slice(rowParam,columnParam),resultArray=resultArray.map((valueObject=>valueObject.isNull()?NumberValueObject.create(0):valueObject)),1===rows&&1===columns?resultArray.get(0,0):resultArray}constructor(...args){super(...args),this.minParams=2,this.maxParams=3}},FUNCTION_NAMES_LOOKUP.TAKE],[class Tocol extends base_function_BaseFunction{calculate(array,ignore,scanByColumn){const _ignore=ignore??NumberValueObject.create(0),_scanByColumn=scanByColumn??BooleanValueObject.create(!1),maxRowLength=Math.max(_ignore.isArray()?_ignore.getRowCount():1,_scanByColumn.isArray()?_scanByColumn.getRowCount():1),maxColumnLength=Math.max(_ignore.isArray()?_ignore.getColumnCount():1,_scanByColumn.isArray()?_scanByColumn.getColumnCount():1),ignoreArray=expandArrayValueObject(maxRowLength,maxColumnLength,_ignore,ErrorValueObject.create(error_type_ErrorType.NA)),scanByColumnArray=expandArrayValueObject(maxRowLength,maxColumnLength,_scanByColumn,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=ignoreArray.mapValue(((ignoreObject,rowIndex,columnIndex)=>{const scanByColumnObject=scanByColumnArray.get(rowIndex,columnIndex);if(array.isError())return array;if(array.isNull())return ErrorValueObject.create(error_type_ErrorType.VALUE);if(ignoreObject.isError())return ignoreObject;if(scanByColumnObject.isError())return scanByColumnObject;const ignoreValue=Math.trunc(+ignoreObject.getValue()),scanByColumnValue=+scanByColumnObject.getValue();if(Number.isNaN(ignoreValue)||ignoreValue<0||ignoreValue>3||Number.isNaN(scanByColumnValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);if(!array.isArray())return array;let result=[];return result=scanByColumnValue?this._getArrayValueByColumn(array,ignoreValue):this._getArrayValueByRow(array,ignoreValue),0===result.length?ErrorValueObject.create(error_type_ErrorType.CALC):maxRowLength>1||maxColumnLength>1||1===result.length?result[0]:ArrayValueObject.create({calculateValueList:result.map((valueObject=>[valueObject])),rowCount:result.length,columnCount:1,unitId:this.unitId,sheetId:this.subUnitId,row:this.row,column:this.column})}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_getArrayValueByColumn(array,ignore){const _array=array,arrayRowCount=_array.getRowCount(),arrayColumnCount=_array.getColumnCount(),result=[];for(let c=0;c<arrayColumnCount;c++)for(let r=0;r<arrayRowCount;r++){const valueObject=_array.get(r,c);this._isIgnore(valueObject,ignore)||result.push(valueObject.isNull()?NumberValueObject.create(0):valueObject)}return result}_getArrayValueByRow(array,ignore){const _array=array,arrayRowCount=_array.getRowCount(),arrayColumnCount=_array.getColumnCount(),result=[];for(let r=0;r<arrayRowCount;r++)for(let c=0;c<arrayColumnCount;c++){const valueObject=_array.get(r,c);this._isIgnore(valueObject,ignore)||result.push(valueObject.isNull()?NumberValueObject.create(0):valueObject)}return result}_isIgnore(valueObject,ignore){switch(ignore){case 0:default:return!1;case 1:return valueObject.isNull();case 2:return valueObject.isError();case 3:return valueObject.isNull()||valueObject.isError()}}constructor(...args){super(...args),this.minParams=1,this.maxParams=3}},FUNCTION_NAMES_LOOKUP.TOCOL],[class Torow extends base_function_BaseFunction{calculate(array,ignore,scanByColumn){const _ignore=ignore??NumberValueObject.create(0),_scanByColumn=scanByColumn??BooleanValueObject.create(!1),maxRowLength=Math.max(_ignore.isArray()?_ignore.getRowCount():1,_scanByColumn.isArray()?_scanByColumn.getRowCount():1),maxColumnLength=Math.max(_ignore.isArray()?_ignore.getColumnCount():1,_scanByColumn.isArray()?_scanByColumn.getColumnCount():1),ignoreArray=expandArrayValueObject(maxRowLength,maxColumnLength,_ignore,ErrorValueObject.create(error_type_ErrorType.NA)),scanByColumnArray=expandArrayValueObject(maxRowLength,maxColumnLength,_scanByColumn,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=ignoreArray.mapValue(((ignoreObject,rowIndex,columnIndex)=>{const scanByColumnObject=scanByColumnArray.get(rowIndex,columnIndex);if(array.isError())return array;if(ignoreObject.isError())return ignoreObject;if(scanByColumnObject.isError())return scanByColumnObject;const ignoreValue=Math.trunc(+ignoreObject.getValue()),scanByColumnValue=+scanByColumnObject.getValue();if(Number.isNaN(ignoreValue)||ignoreValue<0||ignoreValue>3||Number.isNaN(scanByColumnValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);if(array.isNull())return ErrorValueObject.create(error_type_ErrorType.VALUE);if(!array.isArray())return array;let result=[];return result=scanByColumnValue?this._getArrayValueByColumn(array,ignoreValue):this._getArrayValueByRow(array,ignoreValue),0===result.length?ErrorValueObject.create(error_type_ErrorType.CALC):maxRowLength>1||maxColumnLength>1||1===result.length?result[0]:ArrayValueObject.create({calculateValueList:[result],rowCount:1,columnCount:result.length,unitId:this.unitId,sheetId:this.subUnitId,row:this.row,column:this.column})}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_getArrayValueByColumn(array,ignore){const _array=array,arrayRowCount=_array.getRowCount(),arrayColumnCount=_array.getColumnCount(),result=[];for(let c=0;c<arrayColumnCount;c++)for(let r=0;r<arrayRowCount;r++){const valueObject=_array.get(r,c);this._isIgnore(valueObject,ignore)||result.push(valueObject.isNull()?NumberValueObject.create(0):valueObject)}return result}_getArrayValueByRow(array,ignore){const _array=array,arrayRowCount=_array.getRowCount(),arrayColumnCount=_array.getColumnCount(),result=[];for(let r=0;r<arrayRowCount;r++)for(let c=0;c<arrayColumnCount;c++){const valueObject=_array.get(r,c);this._isIgnore(valueObject,ignore)||result.push(valueObject.isNull()?NumberValueObject.create(0):valueObject)}return result}_isIgnore(valueObject,ignore){switch(ignore){case 0:default:return!1;case 1:return valueObject.isNull();case 2:return valueObject.isError();case 3:return valueObject.isNull()||valueObject.isError()}}constructor(...args){super(...args),this.minParams=1,this.maxParams=3}},FUNCTION_NAMES_LOOKUP.TOROW],[class Transpose extends base_function_BaseFunction{calculate(array){if(array.isError())return array;if(array.isArray()){const rowCount=array.getRowCount(),columnCount=array.getColumnCount();return 1===rowCount&&1===columnCount?array.get(0,0):array.transpose()}return array}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_LOOKUP.TRANSPOSE],[class Unique extends base_function_BaseFunction{calculate(array,byCol,exactlyOnce){const _byCol=byCol??BooleanValueObject.create(!1),_exactlyOnce=exactlyOnce??BooleanValueObject.create(!1),arrayRowCount=array.isArray()?array.getRowCount():1,arrayColumnCount=array.isArray()?array.getColumnCount():1,maxRowLength=Math.max(_byCol.isArray()?_byCol.getRowCount():1,_exactlyOnce.isArray()?_exactlyOnce.getRowCount():1),maxColumnLength=Math.max(_byCol.isArray()?_byCol.getColumnCount():1,_exactlyOnce.isArray()?_exactlyOnce.getColumnCount():1),byColArray=expandArrayValueObject(maxRowLength,maxColumnLength,_byCol,ErrorValueObject.create(error_type_ErrorType.NA)),exactlyOnceArray=expandArrayValueObject(maxRowLength,maxColumnLength,_exactlyOnce,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=byColArray.map(((byColObject,rowIndex,columnIndex)=>{let _byColObject=byColObject,exactlyOnceObject=exactlyOnceArray.get(rowIndex,columnIndex);if(array.isError())return array;if(_byColObject.isString()&&(_byColObject=_byColObject.convertToNumberObjectValue()),_byColObject.isError())return _byColObject;if(exactlyOnceObject.isString()&&(exactlyOnceObject=exactlyOnceObject.convertToNumberObjectValue()),exactlyOnceObject.isError())return exactlyOnceObject;const byColValue=+_byColObject.getValue(),exactlyOnceValue=+exactlyOnceObject.getValue();let result;return result=!byColValue&&1===arrayRowCount||byColValue&&1===arrayColumnCount?array:this._getResult(array,byColValue,exactlyOnceValue),(maxRowLength>1||maxColumnLength>1)&&result?.isArray()?result.get(0,0):result}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_getResult(array,byColValue,exactlyOnceValue){const arrayRowCount=array.isArray()?array.getRowCount():1,arrayColumnCount=array.isArray()?array.getColumnCount():1;let arrayValue=array.getArrayValue(),arrayRows=arrayRowCount,arrayColumns=arrayColumnCount;byColValue&&(arrayValue=this._transposeArray(arrayValue),arrayRows=arrayColumnCount,arrayColumns=arrayRowCount);const repeatRows=this._getRepeatRows(arrayValue,arrayRows,arrayColumns);if(repeatRows.length>0){const spliceRows=[];repeatRows.forEach((rows=>{rows.forEach(((r,index)=>{(0!==index||exactlyOnceValue)&&spliceRows.push(r)}))})),arrayValue=arrayValue.filter(((row,rowIndex)=>!spliceRows.includes(rowIndex)))}return 0===arrayValue.length?ErrorValueObject.create(error_type_ErrorType.CALC):(byColValue&&(arrayValue=this._transposeArray(arrayValue)),ArrayValueObject.create({calculateValueList:arrayValue,rowCount:arrayValue.length,columnCount:arrayValue[0].length||0,unitId:this.unitId,sheetId:this.subUnitId,row:this.row,column:this.column}))}_getRepeatRows(arrayValue,arrayRows,arrayColumns){let repeatRows=[];for(let c=0;c<arrayColumns;c++)if(0===c){const objects=new Array(arrayRows).fill(null).map(((item,index)=>({r:index,valueObject:arrayValue[index][c]})));repeatRows=this._getRepeatRowsByObjects(objects)}else{if(0===repeatRows.length)break;let newRepeatRows=[];repeatRows.forEach((item=>{const objects=item.map((r=>({r,valueObject:arrayValue[r][c]}))),_repeatRows=this._getRepeatRowsByObjects(objects);newRepeatRows=newRepeatRows.concat(_repeatRows)})),repeatRows=newRepeatRows}return repeatRows}_getRepeatRowsByObjects(objects){const valueMap=new Map;return objects.forEach((item=>{const r=item.r,valueObject=item.valueObject;let value=valueObject.getValue();if(valueObject.isNull()?value=null:valueObject.isString()&&(0,src.DMQ)(value)&&(value=+value),valueMap.has(value)){const valueMapItem=valueMap.get(value);valueMapItem.push(r),valueMap.set(value,valueMapItem)}else valueMap.set(value,[r])})),Array.from(valueMap.values()).filter((item=>item.length>1))}_transposeArray(array){const rows=array.length,cols=array[0].length,transposedArray=[];for(let col=0;col<cols;col++){transposedArray[col]=[];for(let row=0;row<rows;row++)transposedArray[col][row]=array[row][col]}return transposedArray}constructor(...args){super(...args),this.minParams=1,this.maxParams=3}},FUNCTION_NAMES_LOOKUP.UNIQUE],[class Vlookup extends base_function_BaseFunction{calculate(lookupValue,tableArray,colIndexNum,rangeLookup){if(lookupValue.isError())return lookupValue;if(tableArray.isError())return tableArray;if(!tableArray.isArray())return ErrorValueObject.create(error_type_ErrorType.VALUE);if(colIndexNum.isError())return colIndexNum;if(rangeLookup?.isError())return rangeLookup;const _rangeLookup=rangeLookup??BooleanValueObject.create(!0);return isSingleValueObject(lookupValue)&&isSingleValueObject(_rangeLookup)&&colIndexNum.isArray()?this._handleArrayColIndexNum(lookupValue,tableArray,colIndexNum,_rangeLookup):this._handleNonArrayColIndexNum(lookupValue,tableArray,colIndexNum,_rangeLookup)}_handleArrayColIndexNum(lookupValue,tableArray,colIndexNum,rangeLookup){const _lookupValue=lookupValue.isArray()?lookupValue.getFirstCell():lookupValue,rangeLookupValue=this.getZeroOrOneByOneDefault(rangeLookup);if(null==rangeLookupValue)return ErrorValueObject.create(error_type_ErrorType.VALUE);let errorValue;const result=[];return colIndexNum.iterator(((colIndexNumValueObject,rowIndex,columnIndex)=>{if(null==colIndexNumValueObject)return errorValue=ErrorValueObject.create(error_type_ErrorType.VALUE),!1;const searchObject=this._handleTableArray(_lookupValue,tableArray,colIndexNumValueObject,rangeLookupValue);if(searchObject.isError())return errorValue=searchObject,!1;void 0===result[rowIndex]&&(result[rowIndex]=[]),result[rowIndex][columnIndex]=searchObject})),errorValue||createNewArray(result,result.length,result[0].length,this.unitId||"",this.subUnitId||"")}_handleNonArrayColIndexNum(lookupValue,tableArray,colIndexNum,rangeLookup){const maxRowLength=Math.max(lookupValue.isArray()?lookupValue.getRowCount():1,rangeLookup.isArray()?rangeLookup.getRowCount():1),maxColumnLength=Math.max(lookupValue.isArray()?lookupValue.getColumnCount():1,rangeLookup.isArray()?rangeLookup.getColumnCount():1),lookupValueArray=expandArrayValueObject(maxRowLength,maxColumnLength,lookupValue),rangeLookupArray=expandArrayValueObject(maxRowLength,maxColumnLength,rangeLookup);return lookupValueArray.map(((lookupValue,rowIndex,columnIndex)=>{if(lookupValue.isError())return lookupValue;const rangeLookupValueObject=rangeLookupArray.get(rowIndex,columnIndex);if(null==rangeLookupValueObject)return ErrorValueObject.create(error_type_ErrorType.VALUE);if(rangeLookupValueObject.isError())return rangeLookupValueObject;const rangeLookupValue=this.getZeroOrOneByOneDefault(rangeLookupValueObject);return null==rangeLookupValue?ErrorValueObject.create(error_type_ErrorType.VALUE):this._handleTableArray(lookupValue,tableArray,colIndexNum,rangeLookupValue)}))}_handleTableArray(lookupValue,tableArray,colIndexNum,rangeLookupValue){let colIndexNumValue=this.getIndexNumValue(colIndexNum);if(colIndexNumValue instanceof ErrorValueObject)return colIndexNumValue;if(colIndexNumValue=Math.floor(colIndexNumValue),colIndexNumValue<1)return ErrorValueObject.create(error_type_ErrorType.VALUE);const searchArray=tableArray.slice(void 0,[0,1]);if(null==searchArray)return ErrorValueObject.create(error_type_ErrorType.VALUE);const resultArray=tableArray.slice(void 0,[colIndexNumValue-1,colIndexNumValue]);return null==resultArray?ErrorValueObject.create(error_type_ErrorType.REF):this._handleSingleObject(lookupValue,searchArray,resultArray,rangeLookupValue)}_handleSingleObject(value,searchArray,resultArray,rangeLookupValue){return 0===rangeLookupValue?this.equalSearch(value,searchArray,resultArray):this.binarySearch(value,searchArray,resultArray)}constructor(...args){super(...args),this.minParams=3,this.maxParams=4}},FUNCTION_NAMES_LOOKUP.VLOOKUP],[class Vstack extends base_function_BaseFunction{calculate(...variants){const maxColumnLength=Math.max(...variants.map((variantObject=>variantObject.isArray()?variantObject.getColumnCount():1))),result=[];for(let i=0;i<variants.length;i++){const variantObject=variants[i];if(variantObject.isError())return variantObject;const rowCount=variantObject.isArray()?variantObject.getRowCount():1,columnCount=variantObject.isArray()?variantObject.getColumnCount():1;for(let r=0;r<rowCount;r++){const row=[];for(let c=0;c<maxColumnLength;c++){let singleObject=variantObject;variantObject.isArray()&&(singleObject=variantObject.get(r,c)),c>columnCount-1||!singleObject?row.push(ErrorValueObject.create(error_type_ErrorType.NA)):row.push(singleObject)}result.push(row)}}return ArrayValueObject.create({calculateValueList:result,rowCount:result.length,columnCount:result[0].length||0,unitId:this.unitId,sheetId:this.subUnitId,row:this.row,column:this.column})}constructor(...args){super(...args),this.minParams=1,this.maxParams=255}},FUNCTION_NAMES_LOOKUP.VSTACK],[class Wrapcols extends base_function_BaseFunction{calculate(vector,wrapCount,padWith){let _padWith=padWith??ErrorValueObject.create(error_type_ErrorType.NA);_padWith.isNull()&&(_padWith=ErrorValueObject.create(error_type_ErrorType.NA));const vectorRowCount=vector.isArray()?vector.getRowCount():1,vectorColumnCount=vector.isArray()?vector.getColumnCount():1,maxRowLength=Math.max(wrapCount.isArray()?wrapCount.getRowCount():1,_padWith.isArray()?_padWith.getRowCount():1),maxColumnLength=Math.max(wrapCount.isArray()?wrapCount.getColumnCount():1,_padWith.isArray()?_padWith.getColumnCount():1),wrapCountArray=expandArrayValueObject(maxRowLength,maxColumnLength,wrapCount,ErrorValueObject.create(error_type_ErrorType.NA)),padWithArray=expandArrayValueObject(maxRowLength,maxColumnLength,_padWith,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=wrapCountArray.mapValue(((wrapCountObject,rowIndex,columnIndex)=>{const padWithObject=padWithArray.get(rowIndex,columnIndex);if(vector.isError())return vector;if(vector.isNull())return ErrorValueObject.create(error_type_ErrorType.VALUE);if(wrapCountObject.isError())return wrapCountObject;const wrapCountValue=Math.trunc(+wrapCountObject.getValue());if(vectorRowCount>1&&vectorColumnCount>1||Number.isNaN(wrapCountValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);if(wrapCountValue<1)return ErrorValueObject.create(error_type_ErrorType.NUM);const vectorArray=vector.isArray()?vector.getArrayValue().flat():[vector],result=this._getWrapArray(vectorArray,wrapCountValue,padWithObject);return maxRowLength>1||maxColumnLength>1||1===result.length&&1===result[0].length?result[0][0]:ArrayValueObject.create({calculateValueList:result,rowCount:result.length,columnCount:result[0].length,unitId:this.unitId,sheetId:this.subUnitId,row:this.row,column:this.column})}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_getWrapArray(vectorArray,wrapCount,padWith){const columns=Math.ceil(vectorArray.length/wrapCount),_wrapCount=columns>1?wrapCount:vectorArray.length,result=[];for(let c=0;c<columns;c++)for(let r=0;r<_wrapCount;r++){result[r]||(result[r]=[]);const index=c*_wrapCount+r;index<vectorArray.length?result[r].push(vectorArray[index].isNull()?NumberValueObject.create(0):vectorArray[index]):result[r].push(padWith)}return result}constructor(...args){super(...args),this.minParams=2,this.maxParams=3}},FUNCTION_NAMES_LOOKUP.WRAPCOLS],[class Wraprows extends base_function_BaseFunction{calculate(vector,wrapCount,padWith){let _padWith=padWith??ErrorValueObject.create(error_type_ErrorType.NA);_padWith.isNull()&&(_padWith=ErrorValueObject.create(error_type_ErrorType.NA));const vectorRowCount=vector.isArray()?vector.getRowCount():1,vectorColumnCount=vector.isArray()?vector.getColumnCount():1,maxRowLength=Math.max(wrapCount.isArray()?wrapCount.getRowCount():1,_padWith.isArray()?_padWith.getRowCount():1),maxColumnLength=Math.max(wrapCount.isArray()?wrapCount.getColumnCount():1,_padWith.isArray()?_padWith.getColumnCount():1),wrapCountArray=expandArrayValueObject(maxRowLength,maxColumnLength,wrapCount,ErrorValueObject.create(error_type_ErrorType.NA)),padWithArray=expandArrayValueObject(maxRowLength,maxColumnLength,_padWith,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=wrapCountArray.mapValue(((wrapCountObject,rowIndex,columnIndex)=>{const padWithObject=padWithArray.get(rowIndex,columnIndex);if(vector.isError())return vector;if(vector.isNull())return ErrorValueObject.create(error_type_ErrorType.VALUE);if(wrapCountObject.isError())return wrapCountObject;const wrapCountValue=Math.trunc(+wrapCountObject.getValue());if(vectorRowCount>1&&vectorColumnCount>1||Number.isNaN(wrapCountValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);if(wrapCountValue<1)return ErrorValueObject.create(error_type_ErrorType.NUM);const vectorArray=vector.isArray()?vector.getArrayValue().flat():[vector],result=this._getWrapArray(vectorArray,wrapCountValue,padWithObject);return maxRowLength>1||maxColumnLength>1||1===result.length&&1===result[0].length?result[0][0]:ArrayValueObject.create({calculateValueList:result,rowCount:result.length,columnCount:result[0].length,unitId:this.unitId,sheetId:this.subUnitId,row:this.row,column:this.column})}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_getWrapArray(vectorArray,wrapCount,padWith){const rows=Math.ceil(vectorArray.length/wrapCount),_wrapCount=rows>1?wrapCount:vectorArray.length,result=[];for(let r=0;r<rows;r++){const row=[];for(let c=0;c<_wrapCount;c++){const index=r*_wrapCount+c;index<vectorArray.length?row.push(vectorArray[index].isNull()?NumberValueObject.create(0):vectorArray[index]):row.push(padWith)}result.push(row)}return result}constructor(...args){super(...args),this.minParams=2,this.maxParams=3}},FUNCTION_NAMES_LOOKUP.WRAPROWS],[class Xlookup extends base_function_BaseFunction{calculate(lookupValue,lookupArray,returnArray,ifNotFound,matchMode,searchMode){let _ifNotFound=ifNotFound??ErrorValueObject.create(error_type_ErrorType.NA);ifNotFound?.isNull()&&(_ifNotFound=ErrorValueObject.create(error_type_ErrorType.NA));let _matchMode=matchMode??NumberValueObject.create(0);matchMode?.isNull()&&(_matchMode=NumberValueObject.create(0));let _searchMode=searchMode??NumberValueObject.create(1);if(searchMode?.isNull()&&(_searchMode=NumberValueObject.create(1)),lookupValue.isError())return lookupValue;if(lookupArray.isError()||returnArray.isError())return ErrorValueObject.create(error_type_ErrorType.REF);if(!lookupArray.isArray()||!returnArray.isArray())return ErrorValueObject.create(error_type_ErrorType.VALUE);const rowCountLookup=lookupArray.getRowCount(),columnCountLookup=lookupArray.getColumnCount(),rowCountReturn=returnArray.getRowCount(),columnCountReturn=returnArray.getColumnCount();if(1!==rowCountLookup&&1!==columnCountLookup||1===rowCountLookup&&columnCountLookup>1&&columnCountLookup!==columnCountReturn||1===columnCountLookup&&rowCountLookup>1&&rowCountLookup!==rowCountReturn)return ErrorValueObject.create(error_type_ErrorType.VALUE);if(_matchMode.isError())return _matchMode;if(_searchMode.isError())return _searchMode;const matchModeValue=this.getIndexNumValue(_matchMode);if(matchModeValue instanceof ErrorValueObject)return matchModeValue;const searchModeValue=this.getIndexNumValue(_searchMode);return searchModeValue instanceof ErrorValueObject?searchModeValue:this._getResult(lookupValue,lookupArray,returnArray,_ifNotFound,matchModeValue,searchModeValue,rowCountLookup,columnCountLookup,rowCountReturn,columnCountReturn)}_getResult(lookupValue,lookupArray,returnArray,ifNotFound,matchModeValue,searchModeValue,rowCountLookup,columnCountLookup,rowCountReturn,columnCountReturn){const lookupValueRowCount=lookupValue.isArray()?lookupValue.getRowCount():1,lookupValueColumnCount=lookupValue.isArray()?lookupValue.getColumnCount():1;if(lookupValueRowCount>1||lookupValueColumnCount>1){let resultArray;return resultArray=1===rowCountLookup?returnArray.slice([0,1]):returnArray.slice(void 0,[0,1]),null==resultArray?ErrorValueObject.create(error_type_ErrorType.NA):lookupValue.map((value=>{const checkErrorCombination=this._checkErrorCombination(matchModeValue,searchModeValue);if(checkErrorCombination)return checkErrorCombination;const result=this._handleSingleObject(value,lookupArray,resultArray,matchModeValue,searchModeValue);return result.isError()?ifNotFound:result}))}const _lookupValue=lookupValue.isArray()?lookupValue.get(0,0):lookupValue;if(columnCountLookup===columnCountReturn&&rowCountLookup===rowCountReturn){const checkErrorCombination=this._checkErrorCombination(matchModeValue,searchModeValue);if(checkErrorCombination)return checkErrorCombination;const result=this._handleSingleObject(_lookupValue,lookupArray,returnArray,matchModeValue,searchModeValue);return result.isError()?ifNotFound:result}let axis=0;columnCountLookup===columnCountReturn&&(axis=1);const resultArray=this._handleExpandObject(_lookupValue,lookupArray,returnArray,matchModeValue,searchModeValue,axis);return null==resultArray?ErrorValueObject.create(error_type_ErrorType.NA):resultArray}_handleExpandObject(value,searchArray,resultArray,matchModeValue,searchModeValue,axis=0){if((2===searchModeValue||-2===searchModeValue)&&2!==matchModeValue){const searchType=getSearchModeValue(searchModeValue),matchType=getMatchModeValue(matchModeValue);return this.binarySearchExpand(value,searchArray,resultArray,axis,searchType,matchType)}return 2===matchModeValue?this.fuzzySearchExpand(value,searchArray,resultArray,-1!==searchModeValue,axis):-1===matchModeValue||1===matchModeValue?this.orderSearchExpand(value,searchArray,resultArray,1===matchModeValue?ArrayOrderSearchType.MAX:ArrayOrderSearchType.MIN,-1===searchModeValue,axis):this.equalSearchExpand(value,searchArray,resultArray,-1!==searchModeValue,axis)}_handleSingleObject(value,searchArray,resultArray,matchModeValue,searchModeValue){if((2===searchModeValue||-2===searchModeValue)&&2!==matchModeValue){const searchType=getSearchModeValue(searchModeValue),matchType=getMatchModeValue(matchModeValue);return this.binarySearch(value,searchArray,resultArray,searchType,matchType)}return 2===matchModeValue?this.fuzzySearch(value,searchArray,resultArray,-1!==searchModeValue):-1===matchModeValue||1===matchModeValue?this.orderSearch(value,searchArray,resultArray,1===matchModeValue?ArrayOrderSearchType.MAX:ArrayOrderSearchType.MIN,-1===searchModeValue):this.equalSearch(value,searchArray,resultArray,-1!==searchModeValue)}_checkErrorCombination(matchModeValue,searchModeValue){return 2!==matchModeValue||-2!==searchModeValue&&2!==searchModeValue?null:ErrorValueObject.create(error_type_ErrorType.VALUE)}constructor(...args){super(...args),this.minParams=3,this.maxParams=6}},FUNCTION_NAMES_LOOKUP.XLOOKUP],[class Xmatch extends base_function_BaseFunction{calculate(lookupValue,lookupArray,matchMode,searchMode){if(lookupValue.isError())return lookupValue;if(lookupArray.isError())return ErrorValueObject.create(error_type_ErrorType.REF);if(!lookupArray.isArray())return ErrorValueObject.create(error_type_ErrorType.VALUE);const rowCountLookup=lookupArray.getRowCount(),columnCountLookup=lookupArray.getColumnCount();if(1!==rowCountLookup&&1!==columnCountLookup)return ErrorValueObject.create(error_type_ErrorType.VALUE);if(matchMode?.isError())return ErrorValueObject.create(error_type_ErrorType.NA);if(searchMode?.isError())return ErrorValueObject.create(error_type_ErrorType.NA);const matchModeValue=this.getIndexNumValue(matchMode||NumberValueObject.create(0));if(matchModeValue instanceof ErrorValueObject)return matchModeValue;const searchModeValue=this.getIndexNumValue(searchMode||NumberValueObject.create(1));return searchModeValue instanceof ErrorValueObject?searchModeValue:lookupValue.isArray()?lookupValue.map((value=>this._handleSingleObject(value,lookupArray,matchModeValue,searchModeValue))):this._handleSingleObject(lookupValue,lookupArray,matchModeValue,searchModeValue)}_handleSingleObject(value,searchArray,matchModeValue,searchModeValue){let rowOrColumn;if(2!==searchModeValue&&-2!==searchModeValue||2===matchModeValue)if(2===matchModeValue){const matchObject=searchArray.compare(value,compareToken.EQUALS);let position;if(position=-1!==searchModeValue?matchObject.getFirstTruePosition():matchObject.getLastTruePosition(),null==position)return ErrorValueObject.create(error_type_ErrorType.NA);rowOrColumn=1===searchArray.getRowCount()?position.column:position.row}else if(-1===matchModeValue||1===matchModeValue){const position=searchArray.orderSearch(value,1===matchModeValue?ArrayOrderSearchType.MAX:ArrayOrderSearchType.MIN,-1===searchModeValue);if(null==position)return ErrorValueObject.create(error_type_ErrorType.NA);if(position instanceof ErrorValueObject)return position;rowOrColumn=1===searchArray.getRowCount()?position.column:position.row}else{const matchObject=searchArray.isEqual(value);let position;if(position=-1!==searchModeValue?matchObject.getFirstTruePosition():matchObject.getLastTruePosition(),null==position)return ErrorValueObject.create(error_type_ErrorType.NA);rowOrColumn=1===searchArray.getRowCount()?position.column:position.row}else{const searchType=getSearchModeValue(searchModeValue),matchType=getMatchModeValue(matchModeValue);rowOrColumn=searchArray.binarySearch(value,searchType,matchType)}return null==rowOrColumn?ErrorValueObject.create(error_type_ErrorType.NA):NumberValueObject.create(rowOrColumn+1)}constructor(...args){super(...args),this.minParams=2,this.maxParams=4}},FUNCTION_NAMES_LOOKUP.XMATCH]];function acot(num){let currentValue=num.getValue();if(num.isBoolean()&&(currentValue=currentValue?1:0),!Number.isFinite(currentValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);currentValue=Number(currentValue);let result=Math.atan(1/currentValue);return currentValue<0&&(result+=Math.PI),Number.isNaN(result)?ErrorValueObject.create(error_type_ErrorType.VALUE):NumberValueObject.create(result)}function acoth(num){let currentValue=num.getValue();if(num.isBoolean()&&(currentValue=currentValue?1:0),!Number.isFinite(currentValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);if(currentValue=Number(currentValue),Math.abs(currentValue)<=1)return ErrorValueObject.create(error_type_ErrorType.NUM);const result=.5*Math.log((currentValue+1)/(currentValue-1));return Number.isNaN(result)?ErrorValueObject.create(error_type_ErrorType.VALUE):NumberValueObject.create(result)}const functionMath=[[class Abs extends base_function_BaseFunction{calculate(variant){let _variant=variant;return _variant.isString()&&(_variant=_variant.convertToNumberObjectValue()),_variant.isError()?_variant:_variant.abs()}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_MATH.ABS],[class Acos extends base_function_BaseFunction{calculate(variant){let _variant=variant;return _variant.isString()&&(_variant=_variant.convertToNumberObjectValue()),_variant.isError()?_variant:_variant.acos()}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_MATH.ACOS],[class Acosh extends base_function_BaseFunction{calculate(variant){let _variant=variant;return _variant.isString()&&(_variant=_variant.convertToNumberObjectValue()),_variant.isError()?_variant:_variant.acosh()}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_MATH.ACOSH],[class Acot extends base_function_BaseFunction{calculate(variant){let _variant=variant;return _variant.isString()&&(_variant=_variant.convertToNumberObjectValue()),_variant.isError()?_variant:_variant.isArray()?_variant.map((currentValue=>currentValue.isError()?currentValue:acot(currentValue))):acot(_variant)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_MATH.ACOT],[class Acoth extends base_function_BaseFunction{calculate(variant){let _variant=variant;return _variant.isString()&&(_variant=_variant.convertToNumberObjectValue()),_variant.isError()?_variant:_variant.isArray()?_variant.map((currentValue=>currentValue.isError()?currentValue:acoth(currentValue))):acoth(_variant)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_MATH.ACOTH],[class Arabic extends base_function_BaseFunction{calculate(text){if(text.isArray()){const resultArray=text.mapValue((textObject=>this._handleSingleObject(textObject)));return 1===resultArray.getRowCount()&&1===resultArray.getColumnCount()?resultArray.get(0,0):resultArray}return this._handleSingleObject(text)}_handleSingleObject(text){if(text.isError())return text;if(text.isNull())return NumberValueObject.create(0);if(text.isBoolean()||text.isNumber())return ErrorValueObject.create(error_type_ErrorType.VALUE);let textValue=text.getValue().toLocaleString().toLocaleUpperCase();if(textValue.length>255)return ErrorValueObject.create(error_type_ErrorType.VALUE);const isNegtive=textValue.startsWith("-");isNegtive&&(textValue=textValue.slice(1));let result=0;for(let i=0;i<textValue.length;i++){const currentCharValue=romanToArabicMap.get(textValue[i])||0,nextCharValue=romanToArabicMap.get(textValue[i+1])||0,nextnextCharValue=romanToArabicMap.get(textValue[i+2])||0,nextnextnextCharValue=romanToArabicMap.get(textValue[i+3])||0;if(!currentCharValue||nextnextCharValue>=nextCharValue&&nextnextCharValue>currentCharValue||currentCharValue===nextCharValue&&currentCharValue===nextnextCharValue&&currentCharValue===nextnextnextCharValue||currentCharValue===nextCharValue/2)return ErrorValueObject.create(error_type_ErrorType.VALUE);currentCharValue<nextCharValue?result-=currentCharValue:result+=currentCharValue}return NumberValueObject.create(isNegtive?-result:result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_MATH.ARABIC],[class Asin extends base_function_BaseFunction{calculate(variant){let _variant=variant;return _variant.isString()&&(_variant=_variant.convertToNumberObjectValue()),_variant.isError()?_variant:_variant.asin()}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_MATH.ASIN],[class Asinh extends base_function_BaseFunction{calculate(variant){let _variant=variant;return _variant.isString()&&(_variant=_variant.convertToNumberObjectValue()),_variant.isError()?_variant:_variant.asinh()}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_MATH.ASINH],[class Atan extends base_function_BaseFunction{calculate(variant){let _variant=variant;return _variant.isString()&&(_variant=_variant.convertToNumberObjectValue()),_variant.isError()?_variant:_variant.atan()}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_MATH.ATAN],[class Atan2 extends base_function_BaseFunction{calculate(xNum,yNum){let _xNum=xNum,_yNum=yNum;return _xNum.isString()&&(_xNum=_xNum.convertToNumberObjectValue()),_xNum.isError()?_xNum:(_yNum.isString()&&(_yNum=_yNum.convertToNumberObjectValue()),_yNum.isError()?_yNum:_yNum.atan2(_xNum))}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_MATH.ATAN2],[class Atanh extends base_function_BaseFunction{calculate(variant){let _variant=variant;return _variant.isString()&&(_variant=_variant.convertToNumberObjectValue()),_variant.isError()?_variant:_variant.atanh()}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_MATH.ATANH],[class Base extends base_function_BaseFunction{calculate(number,radix,minLength){const _minLength=minLength??NumberValueObject.create(0);if(number.isError())return number;if(radix.isError())return radix;if(_minLength.isError())return _minLength;const maxRowLength=Math.max(number.isArray()?number.getRowCount():1,radix.isArray()?radix.getRowCount():1,_minLength.isArray()?_minLength.getRowCount():1),maxColumnLength=Math.max(number.isArray()?number.getColumnCount():1,radix.isArray()?radix.getColumnCount():1,_minLength.isArray()?_minLength.getColumnCount():1),numberArray=expandArrayValueObject(maxRowLength,maxColumnLength,number,ErrorValueObject.create(error_type_ErrorType.NA)),radixArray=expandArrayValueObject(maxRowLength,maxColumnLength,radix,ErrorValueObject.create(error_type_ErrorType.NA)),minLengthArray=expandArrayValueObject(maxRowLength,maxColumnLength,_minLength,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=numberArray.map(((numberObject,rowIndex,columnIndex)=>{const radixObject=radixArray.get(rowIndex,columnIndex),minLengthObject=minLengthArray.get(rowIndex,columnIndex);return this._handleSingleObject(numberObject,radixObject,minLengthObject)}));return 1===resultArray.getRowCount()&&1===resultArray.getColumnCount()?resultArray.getArrayValue()[0][0]:resultArray}_handleSingleObject(numberObject,radixObject,minLengthObject){let _numberObject=numberObject;if(_numberObject.isString()&&(_numberObject=_numberObject.convertToNumberObjectValue()),_numberObject.isError())return _numberObject;let _radixObject=radixObject;if(_radixObject.isString()&&(_radixObject=_radixObject.convertToNumberObjectValue()),_radixObject.isError())return _radixObject;let _minLengthObject=minLengthObject;if(_minLengthObject.isString()&&(_minLengthObject=_minLengthObject.convertToNumberObjectValue()),_minLengthObject.isError())return _minLengthObject;const numberValue=Math.floor(+_numberObject.getValue()),radixValue=Math.floor(+_radixObject.getValue()),minLengthValue=Math.floor(+_minLengthObject.getValue());if(numberValue<0||numberValue>=2**53)return ErrorValueObject.create(error_type_ErrorType.NUM);if(radixValue<2||radixValue>36)return ErrorValueObject.create(error_type_ErrorType.NUM);if(minLengthValue<0)return ErrorValueObject.create(error_type_ErrorType.NUM);let result=numberValue.toString(radixValue);return result.length<minLengthValue&&(result=new Array(minLengthValue-result.length+1).join("0")+result),StringValueObject.create(result.toLocaleUpperCase())}constructor(...args){super(...args),this.minParams=2,this.maxParams=3}},FUNCTION_NAMES_MATH.BASE],[class Ceiling extends base_function_BaseFunction{calculate(number,significance){if(number.isError())return number;if(significance.isError())return significance;const maxRowLength=Math.max(number.isArray()?number.getRowCount():1,significance.isArray()?significance.getRowCount():1),maxColumnLength=Math.max(number.isArray()?number.getColumnCount():1,significance.isArray()?significance.getColumnCount():1),numberArray=expandArrayValueObject(maxRowLength,maxColumnLength,number,ErrorValueObject.create(error_type_ErrorType.NA)),significanceArray=expandArrayValueObject(maxRowLength,maxColumnLength,significance,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=numberArray.map(((numberObject,rowIndex,columnIndex)=>{let _numberObject=numberObject,significanceObject=significanceArray.get(rowIndex,columnIndex);if(_numberObject.isString()&&(_numberObject=_numberObject.convertToNumberObjectValue()),_numberObject.isError())return _numberObject;if(significanceObject.isString()&&(significanceObject=significanceObject.convertToNumberObjectValue()),significanceObject.isError())return significanceObject;const numberValue=+_numberObject.getValue(),significanceValue=+significanceObject.getValue();if(numberValue>0&&significanceValue<0)return ErrorValueObject.create(error_type_ErrorType.NUM);if(0===numberValue||0===significanceValue)return NumberValueObject.create(0);const result=ceil(numberValue/significanceValue,0)*significanceValue;return NumberValueObject.create(result)}));return 1===resultArray.getRowCount()&&1===resultArray.getColumnCount()?resultArray.getArrayValue()[0][0]:resultArray}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_MATH.CEILING],[class CeilingMath extends base_function_BaseFunction{calculate(number,significance,mode){const _significance=significance??NumberValueObject.create(1),_mode=mode??NumberValueObject.create(0);if(number.isError())return number;if(_significance.isError())return _significance;if(_mode.isError())return _mode;const maxRowLength=Math.max(number.isArray()?number.getRowCount():1,_significance.isArray()?_significance.getRowCount():1,_mode.isArray()?_mode.getRowCount():1),maxColumnLength=Math.max(number.isArray()?number.getColumnCount():1,_significance.isArray()?_significance.getColumnCount():1,_mode.isArray()?_mode.getColumnCount():1),numberArray=expandArrayValueObject(maxRowLength,maxColumnLength,number,ErrorValueObject.create(error_type_ErrorType.NA)),significanceArray=expandArrayValueObject(maxRowLength,maxColumnLength,_significance,ErrorValueObject.create(error_type_ErrorType.NA)),modeArray=expandArrayValueObject(maxRowLength,maxColumnLength,_mode,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=numberArray.map(((numberObject,rowIndex,columnIndex)=>{let _numberObject=numberObject,significanceObject=significanceArray.get(rowIndex,columnIndex),modeObject=modeArray.get(rowIndex,columnIndex);if(_numberObject.isString()&&(_numberObject=_numberObject.convertToNumberObjectValue()),_numberObject.isError())return _numberObject;if(significanceObject.isString()&&(significanceObject=significanceObject.convertToNumberObjectValue()),significanceObject.isError())return significanceObject;if(modeObject.isString()&&(modeObject=modeObject.convertToNumberObjectValue()),modeObject.isError())return modeObject;const numberValue=+_numberObject.getValue(),significanceValue=+significanceObject.getValue(),modeValue=+modeObject.getValue();return 0===numberValue||0===significanceValue?NumberValueObject.create(0):this._getResult(numberValue,significanceValue,modeValue)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_getResult(numberValue,significanceValue,modeValue){let result;return result=numberValue<0&&0!==modeValue?(significanceValue<0?ceil(Math.abs(numberValue)/Math.abs(significanceValue),0):-ceil(Math.abs(numberValue)/significanceValue,0))*significanceValue:(significanceValue<0?-ceil(numberValue/Math.abs(significanceValue),0):ceil(numberValue/significanceValue,0))*significanceValue,NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=3}},FUNCTION_NAMES_MATH.CEILING_MATH],[class CeilingPrecise extends base_function_BaseFunction{calculate(number,significance){const _significance=significance??NumberValueObject.create(1);if(number.isError())return number;if(_significance.isError())return _significance;const maxRowLength=Math.max(number.isArray()?number.getRowCount():1,_significance.isArray()?_significance.getRowCount():1),maxColumnLength=Math.max(number.isArray()?number.getColumnCount():1,_significance.isArray()?_significance.getColumnCount():1),numberArray=expandArrayValueObject(maxRowLength,maxColumnLength,number,ErrorValueObject.create(error_type_ErrorType.NA)),significanceArray=expandArrayValueObject(maxRowLength,maxColumnLength,_significance,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=numberArray.map(((numberObject,rowIndex,columnIndex)=>{let significanceObject=significanceArray.get(rowIndex,columnIndex),_numberObject=numberObject;if(_numberObject.isString()&&(_numberObject=_numberObject.convertToNumberObjectValue()),_numberObject.isError())return _numberObject;if(significanceObject.isString()&&(significanceObject=significanceObject.convertToNumberObjectValue()),significanceObject.isError())return significanceObject;const numberValue=+_numberObject.getValue(),significanceValue=+significanceObject.getValue();if(0===numberValue||0===significanceValue)return NumberValueObject.create(0);const result=(significanceValue<0?-ceil(numberValue/Math.abs(significanceValue),0):ceil(numberValue/significanceValue,0))*significanceValue;return NumberValueObject.create(result)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}constructor(...args){super(...args),this.minParams=1,this.maxParams=2}},FUNCTION_NAMES_MATH.CEILING_PRECISE],[class Combin extends base_function_BaseFunction{calculate(number,numberChosen){const maxRowLength=Math.max(number.isArray()?number.getRowCount():1,numberChosen.isArray()?numberChosen.getRowCount():1),maxColumnLength=Math.max(number.isArray()?number.getColumnCount():1,numberChosen.isArray()?numberChosen.getColumnCount():1),numberArray=expandArrayValueObject(maxRowLength,maxColumnLength,number,ErrorValueObject.create(error_type_ErrorType.NA)),numberChosenArray=expandArrayValueObject(maxRowLength,maxColumnLength,numberChosen,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=numberArray.mapValue(((numberObject,rowIndex,columnIndex)=>{let _numberObject=numberObject,numberChosenObject=numberChosenArray.get(rowIndex,columnIndex);if(_numberObject.isString()&&(_numberObject=_numberObject.convertToNumberObjectValue()),numberChosenObject.isString()&&(numberChosenObject=numberChosenObject.convertToNumberObjectValue()),_numberObject.isError())return _numberObject;if(numberChosenObject.isError())return numberChosenObject;const numberValue=Math.floor(+_numberObject.getValue()),numberChosenValue=Math.floor(+numberChosenObject.getValue());if(numberValue<0||numberChosenValue<0||numberValue<numberChosenValue)return ErrorValueObject.create(error_type_ErrorType.NUM);const result=calculateCombin(numberValue,numberChosenValue);return Number.isNaN(result)||!Number.isFinite(result)?ErrorValueObject.create(error_type_ErrorType.NUM):NumberValueObject.create(result)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_MATH.COMBIN],[class Combina extends base_function_BaseFunction{calculate(number,numberChosen){const maxRowLength=Math.max(number.isArray()?number.getRowCount():1,numberChosen.isArray()?numberChosen.getRowCount():1),maxColumnLength=Math.max(number.isArray()?number.getColumnCount():1,numberChosen.isArray()?numberChosen.getColumnCount():1),numberArray=expandArrayValueObject(maxRowLength,maxColumnLength,number,ErrorValueObject.create(error_type_ErrorType.NA)),numberChosenArray=expandArrayValueObject(maxRowLength,maxColumnLength,numberChosen,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=numberArray.mapValue(((numberObject,rowIndex,columnIndex)=>{let _numberObject=numberObject,numberChosenObject=numberChosenArray.get(rowIndex,columnIndex);if(_numberObject.isString()&&(_numberObject=_numberObject.convertToNumberObjectValue()),numberChosenObject.isString()&&(numberChosenObject=numberChosenObject.convertToNumberObjectValue()),_numberObject.isError())return _numberObject;if(numberChosenObject.isError())return numberChosenObject;const numberValue=Math.floor(+_numberObject.getValue()),numberChosenValue=Math.floor(+numberChosenObject.getValue());if(numberValue<0||numberChosenValue<0||0===numberValue&&numberValue<numberChosenValue)return ErrorValueObject.create(error_type_ErrorType.NUM);const result=calculateCombin(numberValue+numberChosenValue-1,numberValue-1);return Number.isNaN(result)||!Number.isFinite(result)?ErrorValueObject.create(error_type_ErrorType.NUM):NumberValueObject.create(result)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_MATH.COMBINA],[class Cos extends base_function_BaseFunction{calculate(variant){let _variant=variant;return _variant.isString()&&(_variant=_variant.convertToNumberObjectValue()),_variant.isError()?_variant:_variant.cos()}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_MATH.COS],[class Cosh extends base_function_BaseFunction{calculate(number){let _number=number;return _number.isString()&&(_number=_number.convertToNumberObjectValue()),_number.isError()?_number:_number.cosh()}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_MATH.COSH],[class Cot extends base_function_BaseFunction{calculate(variant){return variant.isArray()?variant.map((numberObject=>this._handleSingleObject(numberObject))):this._handleSingleObject(variant)}_handleSingleObject(number){let numberObject=number;if(numberObject.isString()&&(numberObject=numberObject.convertToNumberObjectValue()),numberObject.isError())return numberObject;const numberValue=+numberObject.getValue();return Math.abs(numberValue)>=2**27?ErrorValueObject.create(error_type_ErrorType.NUM):0===numberValue?ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO):numberObject.tan().getReciprocal()}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_MATH.COT],[class Coth extends base_function_BaseFunction{calculate(variant){return variant.isArray()?variant.map((numberObject=>this._handleSingleObject(numberObject))):this._handleSingleObject(variant)}_handleSingleObject(number){let numberObject=number;if(numberObject.isString()&&(numberObject=numberObject.convertToNumberObjectValue()),numberObject.isError())return numberObject;return 0===+numberObject.getValue()?ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO):numberObject.tanh().getReciprocal()}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_MATH.COTH],[class Csc extends base_function_BaseFunction{calculate(variant){return variant.isArray()?variant.map((numberObject=>this._handleSingleObject(numberObject))):this._handleSingleObject(variant)}_handleSingleObject(number){let numberObject=number;if(numberObject.isString()&&(numberObject=numberObject.convertToNumberObjectValue()),numberObject.isError())return numberObject;const numberValue=+numberObject.getValue();return Math.abs(numberValue)>=2**27?ErrorValueObject.create(error_type_ErrorType.NUM):0===numberValue?ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO):numberObject.sin().getReciprocal()}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_MATH.CSC],[class Csch extends base_function_BaseFunction{calculate(variant){return variant.isArray()?variant.map((numberObject=>this._handleSingleObject(numberObject))):this._handleSingleObject(variant)}_handleSingleObject(number){let numberObject=number;if(numberObject.isString()&&(numberObject=numberObject.convertToNumberObjectValue()),numberObject.isError())return numberObject;const numberValue=+numberObject.getValue();return 0===numberValue?ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO):Number.isNaN(numberValue)||Number.isFinite(Math.sinh(numberValue))?numberObject.sinh().getReciprocal():NumberValueObject.create(0)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_MATH.CSCH],[class Decimal extends base_function_BaseFunction{calculate(text,radix){if(text.isError())return text;if(radix.isError())return radix;const maxRowLength=Math.max(text.isArray()?text.getRowCount():1,radix.isArray()?radix.getRowCount():1),maxColumnLength=Math.max(text.isArray()?text.getColumnCount():1,radix.isArray()?radix.getColumnCount():1),textArray=expandArrayValueObject(maxRowLength,maxColumnLength,text,ErrorValueObject.create(error_type_ErrorType.NA)),radixArray=expandArrayValueObject(maxRowLength,maxColumnLength,radix,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=textArray.map(((textObject,rowIndex,columnIndex)=>{if(textObject.isError())return textObject;let radixObject=radixArray.get(rowIndex,columnIndex);if(radixObject.isString()&&(radixObject=radixObject.convertToNumberObjectValue()),radixObject.isError())return radixObject;const textValue=`${textObject.getValue()}`,radixValue=Math.floor(+radixObject.getValue());if((0,src.DMQ)(textValue)&&(+textValue<0||+textValue>=2**53||!Number.isInteger(+textValue)))return ErrorValueObject.create(error_type_ErrorType.NUM);if("true"===textValue.toLocaleLowerCase()||"false"===textValue.toLocaleLowerCase())return ErrorValueObject.create(error_type_ErrorType.NUM);if(radixValue<2||radixValue>36)return ErrorValueObject.create(error_type_ErrorType.NUM);if(""===textValue.replace(/\s/g,""))return NumberValueObject.create(0);if(!this._isValidCharForRadix(textValue,radixValue))return ErrorValueObject.create(error_type_ErrorType.NUM);const result=Number.parseInt(textValue,radixValue);return Number.isNaN(result)?ErrorValueObject.create(error_type_ErrorType.NUM):NumberValueObject.create(result)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_isValidCharForRadix(text,radix){for(const char of text){const charCode=char.toUpperCase().charCodeAt(0);if(radix<=10&&!(charCode>=48&&charCode<48+radix))return!1;if(radix>10&&!(charCode>=48&&charCode<58||charCode>=65&&charCode<65+radix-10))return!1}return!0}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_MATH.DECIMAL],[class Degrees extends base_function_BaseFunction{calculate(angle){return angle.isArray()?angle.map((angleObject=>this._handleSingleObject(angleObject))):this._handleSingleObject(angle)}_handleSingleObject(angle){let angleObject=angle;if(angleObject.isString()&&(angleObject=angleObject.convertToNumberObjectValue()),angleObject.isError())return angleObject;const angleValue=+angleObject.getValue();if(!Number.isFinite(angleValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);const result=angleValue*(180/Math.PI);return Number.isNaN(result)?ErrorValueObject.create(error_type_ErrorType.VALUE):NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_MATH.DEGREES],[class Even extends base_function_BaseFunction{calculate(number){return number.isArray()?number.map((numberObject=>this._handleSingleObject(numberObject))):this._handleSingleObject(number)}_handleSingleObject(number){let numberObject=number;if(numberObject.isString()&&(numberObject=numberObject.convertToNumberObjectValue()),numberObject.isError())return numberObject;const numberValue=+numberObject.getValue();if(!Number.isFinite(numberValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);const result=2*(numberValue<0?-ceil(Math.abs(numberValue)/2,0):ceil(numberValue/2,0));return Number.isNaN(result)?ErrorValueObject.create(error_type_ErrorType.VALUE):0===result?NumberValueObject.create(0):NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_MATH.EVEN],[class Exp extends base_function_BaseFunction{calculate(variant){let _variant=variant;return _variant.isString()&&(_variant=_variant.convertToNumberObjectValue()),_variant.isError()?_variant:_variant.exp()}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_MATH.EXP],[class Fact extends base_function_BaseFunction{calculate(number){return number.isArray()?number.mapValue((numberObject=>this._handleSingleObject(numberObject))):this._handleSingleObject(number)}_handleSingleObject(number){let _number=number;if(_number.isString()&&(_number=_number.convertToNumberObjectValue()),_number.isError())return _number;const result=calculateFactorial(Math.floor(+_number.getValue()));return Number.isNaN(result)||!Number.isFinite(result)?ErrorValueObject.create(error_type_ErrorType.NUM):NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_MATH.FACT],[class Factdouble extends base_function_BaseFunction{calculate(number){let _number=number;if(number.isArray()){const rowCount=number.getRowCount(),columnCount=number.getColumnCount();if(rowCount>1||columnCount>1)return ErrorValueObject.create(error_type_ErrorType.VALUE);_number=number.get(0,0)}return this._handleSingleObject(_number)}_handleSingleObject(number){let _number=number;if(_number.isString()&&(_number=_number.convertToNumberObjectValue()),_number.isError())return _number;const result=calculateFactorial(Math.floor(+_number.getValue()),2);return Number.isNaN(result)||!Number.isFinite(result)?ErrorValueObject.create(error_type_ErrorType.NUM):NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_MATH.FACTDOUBLE],[class Floor extends base_function_BaseFunction{calculate(number,significance){if(number.isError())return number;if(significance.isError())return significance;const maxRowLength=Math.max(number.isArray()?number.getRowCount():1,significance.isArray()?significance.getRowCount():1),maxColumnLength=Math.max(number.isArray()?number.getColumnCount():1,significance.isArray()?significance.getColumnCount():1),numberArray=expandArrayValueObject(maxRowLength,maxColumnLength,number,ErrorValueObject.create(error_type_ErrorType.NA)),significanceArray=expandArrayValueObject(maxRowLength,maxColumnLength,significance,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=numberArray.map(((numberObject,rowIndex,columnIndex)=>{let significanceObject=significanceArray.get(rowIndex,columnIndex),_numberObject=numberObject;if(_numberObject.isString()&&(_numberObject=_numberObject.convertToNumberObjectValue()),_numberObject.isError())return _numberObject;if(significanceObject.isString()&&(significanceObject=significanceObject.convertToNumberObjectValue()),significanceObject.isError())return significanceObject;const numberValue=+_numberObject.getValue(),significanceValue=+significanceObject.getValue();if(numberValue>0&&significanceValue<0)return ErrorValueObject.create(error_type_ErrorType.NUM);if(0===numberValue)return NumberValueObject.create(0);if(0===significanceValue)return ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO);const result=floor(numberValue/significanceValue,0)*significanceValue;return NumberValueObject.create(result)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_MATH.FLOOR],[class FloorMath extends base_function_BaseFunction{calculate(number,significance,mode){const _significance=significance??NumberValueObject.create(1),_mode=mode??NumberValueObject.create(0),maxRowLength=Math.max(number.isArray()?number.getRowCount():1,_significance.isArray()?_significance.getRowCount():1,_mode.isArray()?_mode.getRowCount():1),maxColumnLength=Math.max(number.isArray()?number.getColumnCount():1,_significance.isArray()?_significance.getColumnCount():1,_mode.isArray()?_mode.getColumnCount():1),numberArray=expandArrayValueObject(maxRowLength,maxColumnLength,number,ErrorValueObject.create(error_type_ErrorType.NA)),significanceArray=expandArrayValueObject(maxRowLength,maxColumnLength,_significance,ErrorValueObject.create(error_type_ErrorType.NA)),modeArray=expandArrayValueObject(maxRowLength,maxColumnLength,_mode,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=numberArray.map(((numberObject,rowIndex,columnIndex)=>{let _numberObject=numberObject,significanceObject=significanceArray.get(rowIndex,columnIndex),modeObject=modeArray.get(rowIndex,columnIndex);if(_numberObject.isString()&&(_numberObject=_numberObject.convertToNumberObjectValue()),_numberObject.isError())return _numberObject;if(significanceObject.isString()&&(significanceObject=significanceObject.convertToNumberObjectValue()),significanceObject.isError())return significanceObject;if(modeObject.isString()&&(modeObject=modeObject.convertToNumberObjectValue()),modeObject.isError())return modeObject;const numberValue=+_numberObject.getValue(),significanceValue=+significanceObject.getValue(),modeValue=+modeObject.getValue();if(0===numberValue||0===significanceValue)return NumberValueObject.create(0);let result;return result=numberValue<0&&0!==modeValue?(significanceValue<0?floor(Math.abs(numberValue)/Math.abs(significanceValue),0):-floor(Math.abs(numberValue)/significanceValue,0))*significanceValue:(significanceValue<0?-floor(numberValue/Math.abs(significanceValue),0):floor(numberValue/significanceValue,0))*significanceValue,NumberValueObject.create(result)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}constructor(...args){super(...args),this.minParams=1,this.maxParams=3}},FUNCTION_NAMES_MATH.FLOOR_MATH],[class FloorPrecise extends base_function_BaseFunction{calculate(number,significance){const _significance=significance??NumberValueObject.create(1);if(number.isError())return number;if(_significance.isError())return _significance;const maxRowLength=Math.max(number.isArray()?number.getRowCount():1,_significance.isArray()?_significance.getRowCount():1),maxColumnLength=Math.max(number.isArray()?number.getColumnCount():1,_significance.isArray()?_significance.getColumnCount():1),numberArray=expandArrayValueObject(maxRowLength,maxColumnLength,number,ErrorValueObject.create(error_type_ErrorType.NA)),significanceArray=expandArrayValueObject(maxRowLength,maxColumnLength,_significance,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=numberArray.map(((numberObject,rowIndex,columnIndex)=>{let significanceObject=significanceArray.get(rowIndex,columnIndex),_numberObject=numberObject;if(_numberObject.isString()&&(_numberObject=_numberObject.convertToNumberObjectValue()),_numberObject.isError())return _numberObject;if(significanceObject.isString()&&(significanceObject=significanceObject.convertToNumberObjectValue()),significanceObject.isError())return significanceObject;const numberValue=+_numberObject.getValue(),significanceValue=+significanceObject.getValue();if(0===numberValue||0===significanceValue)return NumberValueObject.create(0);const result=(significanceValue<0?-floor(numberValue/Math.abs(significanceValue),0):floor(numberValue/significanceValue,0))*significanceValue;return NumberValueObject.create(result)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}constructor(...args){super(...args),this.minParams=1,this.maxParams=2}},FUNCTION_NAMES_MATH.FLOOR_PRECISE],[class Gcd extends base_function_BaseFunction{calculate(...variants){let result=0;for(let i=0;i<variants.length;i++){const variant=variants[i];if(!variant.isNull())if(variant.isArray()){let isError=!1,errorObject=ErrorValueObject.create(error_type_ErrorType.VALUE);if(variant.iterator((valueObject=>{if(valueObject?.isNull())return!0;const{isError:_isError,errorObject:_errorObject,number}=this._handleSingleObject(valueObject);if(_isError)return isError=!0,errorObject=_errorObject,!1;result=calculateGcd(result,number)})),isError)return errorObject}else{const{isError,errorObject,number}=this._handleSingleObject(variant);if(isError)return errorObject;result=calculateGcd(result,number)}}return NumberValueObject.create(result)}_handleSingleObject(number){if(number.isBoolean())return{isError:!0,errorObject:ErrorValueObject.create(error_type_ErrorType.VALUE),number:null};let _number=number;if(number.isString()&&(_number=_number.convertToNumberObjectValue()),_number.isError())return{isError:!0,errorObject:_number,number:null};const numberValue=Math.floor(+_number.getValue());return numberValue<0||numberValue>=2**53?{isError:!0,errorObject:ErrorValueObject.create(error_type_ErrorType.NUM),number:null}:{isError:!1,errorObject:null,number:numberValue}}constructor(...args){super(...args),this.minParams=1,this.maxParams=255}},FUNCTION_NAMES_MATH.GCD],[class Int extends base_function_BaseFunction{calculate(number){return number.isArray()?number.mapValue((numberObject=>this._handleSingleObject(numberObject))):this._handleSingleObject(number)}_handleSingleObject(number){let _number=number;if(_number.isString()&&(_number=_number.convertToNumberObjectValue()),_number.isError())return _number;const numberValue=Math.floor(+_number.getValue());return NumberValueObject.create(numberValue)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_MATH.INT],[class Lcm extends base_function_BaseFunction{calculate(...variants){let result=1,noCalculate=!0;for(let i=0;i<variants.length;i++){const variant=variants[i];if(!variant.isNull())if(variant.isArray()){let isError=!1,errorObject=ErrorValueObject.create(error_type_ErrorType.VALUE);if(variant.iterator((valueObject=>{if(valueObject?.isNull())return!0;const{isError:_isError,errorObject:_errorObject,number}=this._handleSingleObject(valueObject);if(_isError)return isError=!0,errorObject=_errorObject,!1;result=calculateLcm(result,number),noCalculate=!1})),isError)return errorObject}else{const{isError,errorObject,number}=this._handleSingleObject(variant);if(isError)return errorObject;result=calculateLcm(result,number),noCalculate=!1}}return noCalculate?NumberValueObject.create(0):Number.isNaN(result)||!Number.isFinite(result)||result>=2**53?ErrorValueObject.create(error_type_ErrorType.VALUE):NumberValueObject.create(result)}_handleSingleObject(number){if(number.isBoolean())return{isError:!0,errorObject:ErrorValueObject.create(error_type_ErrorType.VALUE),number:null};let _number=number;if(number.isString()&&(_number=_number.convertToNumberObjectValue()),_number.isError())return{isError:!0,errorObject:_number,number:null};const numberValue=Math.floor(+_number.getValue());return numberValue<0?{isError:!0,errorObject:ErrorValueObject.create(error_type_ErrorType.NUM),number:null}:{isError:!1,errorObject:null,number:numberValue}}constructor(...args){super(...args),this.minParams=1,this.maxParams=255}},FUNCTION_NAMES_MATH.LCM],[class Ln extends base_function_BaseFunction{calculate(variant){let _variant=variant;return _variant.isString()&&(_variant=_variant.convertToNumberObjectValue()),_variant.isError()?_variant:_variant.log()}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_MATH.LN],[class Log extends base_function_BaseFunction{calculate(number,base){const _base=base??NumberValueObject.create(10);if(number.isError())return number;if(_base.isError())return _base;const maxRowLength=Math.max(number.isArray()?number.getRowCount():1,_base.isArray()?_base.getRowCount():1),maxColumnLength=Math.max(number.isArray()?number.getColumnCount():1,_base.isArray()?_base.getColumnCount():1),numberArray=expandArrayValueObject(maxRowLength,maxColumnLength,number,ErrorValueObject.create(error_type_ErrorType.NA)),baseArray=expandArrayValueObject(maxRowLength,maxColumnLength,_base,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=numberArray.map(((numberObject,rowIndex,columnIndex)=>{let baseObject=baseArray.get(rowIndex,columnIndex),_numberObject=numberObject;if(_numberObject.isString()&&(_numberObject=_numberObject.convertToNumberObjectValue()),_numberObject.isError())return _numberObject;if(baseObject.isString()&&(baseObject=baseObject.convertToNumberObjectValue()),baseObject.isError())return baseObject;const numberValue=+_numberObject.getValue(),baseValue=+baseObject.getValue();if(numberValue<=0||baseValue<=0)return ErrorValueObject.create(error_type_ErrorType.NUM);const baseLog=Math.log(baseValue);if(0===baseLog)return ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO);const result=Math.log(numberValue)/baseLog;return NumberValueObject.create(result)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}constructor(...args){super(...args),this.minParams=1,this.maxParams=2}},FUNCTION_NAMES_MATH.LOG],[class Log10 extends base_function_BaseFunction{calculate(variant){let _variant=variant;return _variant.isString()&&(_variant=_variant.convertToNumberObjectValue()),_variant.isError()?_variant:_variant.log10()}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_MATH.LOG10],[class Mdeterm extends base_function_BaseFunction{calculate(array){const arrayRowCount=array.isArray()?array.getRowCount():1,arrayColumnCount=array.isArray()?array.getColumnCount():1,matrix=[];for(let r=0;r<arrayRowCount;r++){const row=[];for(let c=0;c<arrayColumnCount;c++){let valueObject=array.isArray()?array.get(r,c):array;if(valueObject.isError())return valueObject;if(valueObject.isNull()||valueObject.isBoolean())return ErrorValueObject.create(error_type_ErrorType.VALUE);if(valueObject.isString()&&(valueObject=valueObject.convertToNumberObjectValue()),valueObject.isError())return valueObject;const value=+valueObject.getValue();row.push(value)}matrix.push(row)}if(arrayRowCount!==arrayColumnCount)return ErrorValueObject.create(error_type_ErrorType.VALUE);const result=calculateMdeterm(matrix);return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_MATH.MDETERM],[class Minverse extends base_function_BaseFunction{calculate(array){const arrayRowCount=array.isArray()?array.getRowCount():1,arrayColumnCount=array.isArray()?array.getColumnCount():1,matrix=[];for(let r=0;r<arrayRowCount;r++){const row=[];for(let c=0;c<arrayColumnCount;c++){let valueObject=array.isArray()?array.get(r,c):array;if(valueObject.isError())return valueObject;if(valueObject.isNull()||valueObject.isBoolean())return ErrorValueObject.create(error_type_ErrorType.VALUE);if(valueObject.isString()&&(valueObject=valueObject.convertToNumberObjectValue()),valueObject.isError())return valueObject;const value=+valueObject.getValue();row.push(value)}matrix.push(row)}if(arrayRowCount!==arrayColumnCount)return ErrorValueObject.create(error_type_ErrorType.VALUE);const result=calculateMinverse(matrix);return null===result?ErrorValueObject.create(error_type_ErrorType.NUM):ArrayValueObject.createByArray(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_MATH.MINVERSE],[class Mmult extends base_function_BaseFunction{calculate(array1,array2){const array1RowCount=array1.isArray()?array1.getRowCount():1,array1ColumnCount=array1.isArray()?array1.getColumnCount():1,array2RowCount=array2.isArray()?array2.getRowCount():1,array2ColumnCount=array2.isArray()?array2.getColumnCount():1;if(array1ColumnCount!==array2RowCount)return ErrorValueObject.create(error_type_ErrorType.VALUE);const matrix1=this._getMatrix(array1,array1RowCount,array1ColumnCount),matrix2=this._getMatrix(array2,array2RowCount,array2ColumnCount);if(matrix1 instanceof ErrorValueObject)return matrix1;if(matrix2 instanceof ErrorValueObject)return matrix2;const result=calculateMmult(matrix1,matrix2);return ArrayValueObject.createByArray(result)}_getMatrix(array,rowCount,columnCount){const matrix=[];for(let r=0;r<rowCount;r++){const row=[];for(let c=0;c<columnCount;c++){let valueObject=array.isArray()?array.get(r,c):array;if(valueObject.isError())return valueObject;if(valueObject.isNull()||valueObject.isBoolean())return ErrorValueObject.create(error_type_ErrorType.VALUE);if(valueObject.isString()&&(valueObject=valueObject.convertToNumberObjectValue()),valueObject.isError())return valueObject;const value=+valueObject.getValue();row.push(value)}matrix.push(row)}return matrix}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_MATH.MMULT],[class Mod extends base_function_BaseFunction{calculate(number,divisor){let _number=number;if(_number.isString()&&(_number=_number.convertToNumberObjectValue()),_number.isError())return _number;let _divisor=divisor;return _divisor.isString()&&(_divisor=_divisor.convertToNumberObjectValue()),_divisor.isError()?_divisor:_number.mod(_divisor)}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_MATH.MOD],[class Mround extends base_function_BaseFunction{calculate(number,multiple){let _number=number;if(_number.isArray()){const rowCount=_number.getRowCount(),columnCount=_number.getColumnCount();if(rowCount>1||columnCount>1)return ErrorValueObject.create(error_type_ErrorType.VALUE);_number=_number.get(0,0)}if(_number.isError())return _number;let _multiple=multiple;if(_multiple.isArray()){const rowCount=_multiple.getRowCount(),columnCount=_multiple.getColumnCount();if(rowCount>1||columnCount>1)return ErrorValueObject.create(error_type_ErrorType.VALUE);_multiple=_multiple.get(0,0)}if(_multiple.isError())return _multiple;if(_number.isBoolean()||_multiple.isBoolean())return ErrorValueObject.create(error_type_ErrorType.VALUE);const numberValue=+_number.getValue(),multipleValue=+_multiple.getValue();if(Number.isNaN(numberValue)||Number.isNaN(multipleValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);if(0===multipleValue)return NumberValueObject.create(0);if(numberValue>0&&multipleValue<0||numberValue<0&&multipleValue>0)return ErrorValueObject.create(error_type_ErrorType.NUM);const result=round(numberValue/multipleValue,0)*multipleValue;return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_MATH.MROUND],[class Multinomial extends base_function_BaseFunction{calculate(...variants){let sum=0,den=1;for(let i=0;i<variants.length;i++){const variant=variants[i];if(!variant.isNull())if(variant.isArray()){let isError=!1,errorObject=ErrorValueObject.create(error_type_ErrorType.VALUE);if(variant.iterator((valueObject=>{if(valueObject?.isNull())return!0;const{isError:_isError,errorObject:_errorObject,number}=this._handleSingleObject(valueObject);return _isError?(isError=!0,errorObject=_errorObject,!1):(sum+=number,sum>170?(isError=!0,errorObject=ErrorValueObject.create(error_type_ErrorType.NUM),!1):void(den*=calculateFactorial(number)))})),isError)return errorObject}else{const{isError,errorObject,number}=this._handleSingleObject(variant);if(isError)return errorObject;if(sum+=number,sum>170)return ErrorValueObject.create(error_type_ErrorType.NUM);den*=calculateFactorial(number)}}const result=calculateFactorial(sum)/den;return NumberValueObject.create(result)}_handleSingleObject(number){if(number.isBoolean())return{isError:!0,errorObject:ErrorValueObject.create(error_type_ErrorType.VALUE),number:null};let _number=number;if(number.isString()&&(_number=_number.convertToNumberObjectValue()),_number.isError())return{isError:!0,errorObject:_number,number:null};const numberValue=Math.floor(+_number.getValue());return numberValue<0?{isError:!0,errorObject:ErrorValueObject.create(error_type_ErrorType.NUM),number:null}:{isError:!1,errorObject:null,number:numberValue}}constructor(...args){super(...args),this.minParams=1,this.maxParams=255}},FUNCTION_NAMES_MATH.MULTINOMIAL],[class Munit extends base_function_BaseFunction{calculate(dimension){if(dimension.isArray()){const rowCount=dimension.getRowCount(),columnCount=dimension.getColumnCount(),resultArray=dimension.mapValue((dimensionObject=>{const result=this._handleSingleObject(dimensionObject);return result.isError()?result:rowCount>1||columnCount>1?result.get(0,0):result}));return 1===rowCount&&1===columnCount?resultArray.get(0,0):resultArray}return this._handleSingleObject(dimension)}_handleSingleObject(dimension){let _dimension=dimension;if(_dimension.isString()&&(_dimension=_dimension.convertToNumberObjectValue()),_dimension.isError())return _dimension;const dimensionValue=Math.floor(+_dimension.getValue());if(dimensionValue<=0)return ErrorValueObject.create(error_type_ErrorType.VALUE);const result=[];for(let r=0;r<dimensionValue;r++){result[r]=[];for(let c=0;c<dimensionValue;c++)result[r][c]=r===c?1:0}return ArrayValueObject.createByArray(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_MATH.MUNIT],[class Odd extends base_function_BaseFunction{calculate(number){return number.isArray()?number.map((numberObject=>this._handleSingleObject(numberObject))):this._handleSingleObject(number)}_handleSingleObject(number){let numberObject=number;if(numberObject.isString()&&(numberObject=numberObject.convertToNumberObjectValue()),numberObject.isError())return numberObject;const numberValue=+numberObject.getValue();if(!Number.isFinite(numberValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);let result=numberValue<0?-ceil(Math.abs(numberValue),0):ceil(numberValue,0);return Number.isNaN(result)?ErrorValueObject.create(error_type_ErrorType.VALUE):(Math.abs(result)%2==0&&(numberValue<0?result--:result++),NumberValueObject.create(result))}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_MATH.ODD],[class Pi extends base_function_BaseFunction{calculate(){return NumberValueObject.create(Math.PI)}constructor(...args){super(...args),this.minParams=0,this.maxParams=0}},FUNCTION_NAMES_MATH.PI],[class Power extends base_function_BaseFunction{calculate(number,power){let _number=number;if(_number.isString()&&(_number=_number.convertToNumberObjectValue()),_number.isError())return _number;let _power=power;return _power.isString()&&(_power=_power.convertToNumberObjectValue()),_power.isError()?_power:_number.pow(_power)}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_MATH.POWER],[class Product extends base_function_BaseFunction{calculate(...variants){let accumulatorAll=NumberValueObject.create(1),noCalculate=!0;for(let i=0;i<variants.length;i++){let variant=variants[i];if(variant.isError())return variant;if(variant.isArray()){let isError=!1,errorObject=null;if(variant.iterator((valueObject=>valueObject?.isError()?(isError=!0,errorObject=valueObject,!1):!(valueObject&&!valueObject.isNull()&&!valueObject.isString()&&!valueObject.isBoolean())||(accumulatorAll=accumulatorAll.multiply(valueObject),void(noCalculate=!1)))),isError)return errorObject}else{if(variant.isNull())continue;if(variant.isString()&&(variant=variant.convertToNumberObjectValue()),variant.isError())return variant;accumulatorAll=accumulatorAll.multiply(variant),noCalculate=!1}if(accumulatorAll.isError())return accumulatorAll}return noCalculate?NumberValueObject.create(0):accumulatorAll}constructor(...args){super(...args),this.minParams=1,this.maxParams=255}},FUNCTION_NAMES_MATH.PRODUCT],[class Quotient extends base_function_BaseFunction{calculate(numerator,denominator){const{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(numerator,denominator);if(isError)return errorObject;const[numeratorObject,denominatorObject]=variants,numeratorValue=+numeratorObject.getValue(),denominatorValue=+denominatorObject.getValue();if(Number.isNaN(numeratorValue)||Number.isNaN(denominatorValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);if(0===denominatorValue)return ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO);const result=Math.trunc(numeratorValue/denominatorValue);return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_MATH.QUOTIENT],[class Radians extends base_function_BaseFunction{calculate(angle){return angle.isArray()?angle.map((angleObject=>this._handleSingleObject(angleObject))):this._handleSingleObject(angle)}_handleSingleObject(angle){let angleObject=angle;if(angleObject.isString()&&(angleObject=angleObject.convertToNumberObjectValue()),angleObject.isError())return angleObject;const angleValue=+angleObject.getValue();if(!Number.isFinite(angleValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);const result=angleValue*(Math.PI/180);return Number.isNaN(result)?ErrorValueObject.create(error_type_ErrorType.VALUE):NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_MATH.RADIANS],[class Rand extends base_function_BaseFunction{calculate(){return NumberValueObject.create(Math.random())}constructor(...args){super(...args),this.minParams=0,this.maxParams=0}},FUNCTION_NAMES_MATH.RAND],[class Randarray extends base_function_BaseFunction{calculate(rows,columns,min,max,wholeNumber){if(rows?.isError())return rows;if(columns?.isError())return columns;if(min?.isError())return min;if(max?.isError())return max;if(wholeNumber?.isError())return wholeNumber;const _rows=rows??NumberValueObject.create(1),_columns=columns??NumberValueObject.create(1),_min=min??NumberValueObject.create(0),_max=max??NumberValueObject.create(1),_wholeNumber=wholeNumber??NumberValueObject.create(0);return this._calculateResult(_rows,_columns,_min,_max,_wholeNumber)}_calculateResult(rows,columns,min,max,wholeNumber){const maxRowLength=Math.max(rows.isArray()?rows.getRowCount():1,columns.isArray()?columns.getRowCount():1,min.isArray()?min.getRowCount():1,max.isArray()?max.getRowCount():1,wholeNumber.isArray()?wholeNumber.getRowCount():1),maxColumnLength=Math.max(rows.isArray()?rows.getColumnCount():1,columns.isArray()?columns.getColumnCount():1,min.isArray()?min.getColumnCount():1,max.isArray()?max.getColumnCount():1,wholeNumber.isArray()?wholeNumber.getColumnCount():1);if(1===maxRowLength&&1===maxColumnLength)return this._calculateSingleCell(rows,columns,min,max,wholeNumber);const rowsArray=expandArrayValueObject(maxRowLength,maxColumnLength,rows,ErrorValueObject.create(error_type_ErrorType.NA)),columnsArray=expandArrayValueObject(maxRowLength,maxColumnLength,columns,ErrorValueObject.create(error_type_ErrorType.NA)),minArray=expandArrayValueObject(maxRowLength,maxColumnLength,min,ErrorValueObject.create(error_type_ErrorType.NA)),maxArray=expandArrayValueObject(maxRowLength,maxColumnLength,max,ErrorValueObject.create(error_type_ErrorType.NA)),wholeNumberArray=expandArrayValueObject(maxRowLength,maxColumnLength,wholeNumber,ErrorValueObject.create(error_type_ErrorType.NA));return rowsArray.map(((rowsObject,rowIndex,columnIndex)=>{const columnsObject=columnsArray.get(rowIndex,columnIndex),minObject=minArray.get(rowIndex,columnIndex),maxObject=maxArray.get(rowIndex,columnIndex),wholeNumberObject=wholeNumberArray.get(rowIndex,columnIndex),_handleError=this._handleError(rowsObject,columnsObject,minObject,maxObject,wholeNumberObject);if(_handleError.errorObject)return _handleError.errorObject;let result,{minValue,maxValue,wholeNumberValue}=_handleError;return wholeNumberValue?(minValue=Math.ceil(minValue),maxValue=Math.floor(maxValue),result=Math.floor(Math.random()*(maxValue-minValue+1))+minValue):result=Math.random()*(maxValue-minValue)+minValue,result<minValue||result>maxValue?ErrorValueObject.create(error_type_ErrorType.VALUE):NumberValueObject.create(result)}))}_calculateSingleCell(rows,columns,min,max,wholeNumber){let _rows=rows;_rows.isArray()&&(_rows=_rows.get(0,0));let _columns=columns;_columns.isArray()&&(_columns=_columns.get(0,0));let _min=min;_min.isArray()&&(_min=_min.get(0,0));let _max=max;_max.isArray()&&(_max=_max.get(0,0));let _wholeNumber=wholeNumber;_wholeNumber.isArray()&&(_wholeNumber=_wholeNumber.get(0,0));const _handleError=this._handleError(_rows,_columns,_min,_max,_wholeNumber);if(_handleError.errorObject)return _handleError.errorObject;let{rowsValue,columnsValue,minValue,maxValue,wholeNumberValue}=_handleError;if(wholeNumberValue&&(minValue=Math.ceil(minValue),maxValue=Math.floor(maxValue),minValue>maxValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);const result=[];for(let r=0;r<rowsValue;r++){const row=[];for(let c=0;c<columnsValue;c++)wholeNumberValue?row.push(Math.floor(Math.random()*(maxValue-minValue+1))+minValue):row.push(Math.random()*(maxValue-minValue)+minValue);result.push(row)}return 1===rowsValue&&1===columnsValue?NumberValueObject.create(result[0][0]):ArrayValueObject.createByArray(result)}_handleError(rowsObject,columnsObject,minObject,maxObject,wholeNumberObject){let _rowsObject=rowsObject;if(_rowsObject.isString()&&(_rowsObject=_rowsObject.convertToNumberObjectValue()),_rowsObject.isError())return{errorObject:_rowsObject};let _columnsObject=columnsObject;if(_columnsObject.isString()&&(_columnsObject=_columnsObject.convertToNumberObjectValue()),_columnsObject.isError())return{errorObject:_columnsObject};let _minObject=minObject;if(_minObject.isString()&&(_minObject=_minObject.convertToNumberObjectValue()),_minObject.isError())return{errorObject:_minObject};let _maxObject=maxObject;if(_maxObject.isString()&&(_maxObject=_maxObject.convertToNumberObjectValue()),_maxObject.isError())return{errorObject:_maxObject};let _wholeNumberObject=wholeNumberObject;return _wholeNumberObject.isString()&&(_wholeNumberObject=_wholeNumberObject.convertToNumberObjectValue()),_wholeNumberObject.isError()?{errorObject:_wholeNumberObject}:this._getValue(_rowsObject,_columnsObject,_minObject,_maxObject,_wholeNumberObject)}_getValue(rowsObject,columnsObject,minObject,maxObject,wholeNumberObject){const rowsValue=Math.floor(+rowsObject.getValue()),columnsValue=Math.floor(+columnsObject.getValue());if(0===rowsValue||0===columnsValue)return{errorObject:ErrorValueObject.create(error_type_ErrorType.CALC)};const maxRows=this._rowCount-this.row,maxColumns=this._columnCount-this.column;if(rowsValue<0||columnsValue<0||rowsValue*columnsValue>10**7)return{errorObject:ErrorValueObject.create(error_type_ErrorType.VALUE)};if(rowsValue>maxRows||columnsValue>maxColumns)return{errorObject:ErrorValueObject.create(error_type_ErrorType.REF)};const minValue=+minObject.getValue(),maxValue=+maxObject.getValue(),wholeNumberValue=+wholeNumberObject.getValue();return minValue>maxValue?{errorObject:ErrorValueObject.create(error_type_ErrorType.VALUE)}:!wholeNumberValue||Number.isInteger(minValue)&&Number.isInteger(maxValue)?{rowsValue,columnsValue,minValue,maxValue,wholeNumberValue}:{errorObject:ErrorValueObject.create(error_type_ErrorType.VALUE)}}constructor(...args){super(...args),this.minParams=0,this.maxParams=5,this.needsSheetRowColumnCount=!0}},FUNCTION_NAMES_MATH.RANDARRAY],[class Randbetween extends base_function_BaseFunction{calculate(bottom,top){let _bottom=bottom;if(_bottom.isArray()){const rowCount=_bottom.getRowCount(),columnCount=_bottom.getColumnCount();if(rowCount>1||columnCount>1)return ErrorValueObject.create(error_type_ErrorType.VALUE);_bottom=_bottom.get(0,0)}if(_bottom.isError())return _bottom;let _top=top;if(_top.isArray()){const rowCount=_top.getRowCount(),columnCount=_top.getColumnCount();if(rowCount>1||columnCount>1)return ErrorValueObject.create(error_type_ErrorType.VALUE);_top=_top.get(0,0)}if(_top.isError())return _top;if(_bottom.isBoolean()||_top.isBoolean())return ErrorValueObject.create(error_type_ErrorType.VALUE);let bottomValue=+_bottom.getValue(),topValue=+_top.getValue();if(Number.isNaN(bottomValue)||Number.isNaN(topValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);if(bottomValue>topValue)return ErrorValueObject.create(error_type_ErrorType.NUM);bottomValue=Math.ceil(bottomValue),topValue=Math.floor(topValue);const result=Math.floor(Math.random()*(topValue-bottomValue+1))+bottomValue;return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_MATH.RANDBETWEEN],[class Roman extends base_function_BaseFunction{calculate(number,form){const _form=form??NumberValueObject.create(0),maxRowLength=Math.max(number.isArray()?number.getRowCount():1,_form.isArray()?_form.getRowCount():1),maxColumnLength=Math.max(number.isArray()?number.getColumnCount():1,_form.isArray()?_form.getColumnCount():1),numberArray=expandArrayValueObject(maxRowLength,maxColumnLength,number,ErrorValueObject.create(error_type_ErrorType.NA)),formArray=expandArrayValueObject(maxRowLength,maxColumnLength,_form,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=numberArray.mapValue(((numberObject,rowIndex,columnIndex)=>{const formObject=formArray.get(rowIndex,columnIndex);return numberObject.isError()?numberObject:formObject.isError()?formObject:this._handleSingleObject(numberObject,formObject)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_handleSingleObject(number,form){const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(number);if(isError)return errorObject;const[numberObject]=variants;let numberValue=Math.floor(+numberObject.getValue()),_form=form;if(_form.isString()&&(_form=_form.convertToNumberObjectValue(),_form.isError()))return _form;let formValue=Math.floor(+_form.getValue());if(_form.isBoolean()&&(formValue=_form.getValue()?0:4),numberValue<0||numberValue>3999||formValue<0||formValue>4)return ErrorValueObject.create(error_type_ErrorType.VALUE);const formArray=romanFormArray[formValue];let index=formArray.length-1,result="";for(;numberValue>0;){index=this._binarySearch(numberValue,0,index,formArray);const number=formArray[index];numberValue-=number,result+=arabicToRomanMap.get(number)}return StringValueObject.create(result)}_binarySearch(target,left,right,array){let _left=left,_right=right;for(;_right-_left>1;){const mid=Math.floor((_left+_right)/2),midValue=array[mid];if(midValue===target)return mid;midValue>target?_right=mid:_left=mid}return _left!==_right&&array[_right]<=target?_right:_left}constructor(...args){super(...args),this.minParams=1,this.maxParams=2}},FUNCTION_NAMES_MATH.ROMAN],[class Round extends base_function_BaseFunction{calculate(number,numDigits){let _number=number;if(_number.isString()&&(_number=_number.convertToNumberObjectValue()),_number.isError())return _number;let _numDigits=numDigits;return _numDigits.isString()&&(_numDigits=_numDigits.convertToNumberObjectValue()),_numDigits.isError()?_numDigits:_number.round(_numDigits)}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_MATH.ROUND],[class Roundbank extends base_function_BaseFunction{calculate(number,numDigits){const maxRowLength=Math.max(number.isArray()?number.getRowCount():1,numDigits.isArray()?numDigits.getRowCount():1),maxColumnLength=Math.max(number.isArray()?number.getColumnCount():1,numDigits.isArray()?numDigits.getColumnCount():1),numberArray=expandArrayValueObject(maxRowLength,maxColumnLength,number,ErrorValueObject.create(error_type_ErrorType.NA)),numDigitsArray=expandArrayValueObject(maxRowLength,maxColumnLength,numDigits,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=numberArray.mapValue(((numberObject,rowIndex,columnIndex)=>{const numDigitsObject=numDigitsArray.get(rowIndex,columnIndex);if(numberObject.isError())return numberObject;if(numDigitsObject.isError())return numDigitsObject;const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(numberObject,numDigitsObject);if(isError)return errorObject;const[_numberObject,_numDigitsObject]=variants,numberValue=+_numberObject.getValue(),numDigitsValue=Math.trunc(+_numDigitsObject.getValue()),result=this._roundBank(numberValue,numDigitsValue);return NumberValueObject.create(result)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_roundBank(number,numDigits){if(numDigits>16)return number;if(numDigits<-16)return 0;const multiplier=10**numDigits,adjustedNum=+(number*multiplier).toFixed(8),integerPart=Math.floor(adjustedNum),decimalPart=adjustedNum-integerPart;let result=Math.round(adjustedNum);return decimalPart>.5-1e-8&&decimalPart<.5+1e-8&&(result=integerPart%2==0?integerPart:integerPart+1),numDigits?result/multiplier:result}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_MATH.ROUNDBANK],[class Rounddown extends base_function_BaseFunction{calculate(number,numDigits){let _number=number;if(_number.isString()&&(_number=_number.convertToNumberObjectValue()),_number.isError())return _number;let _numDigits=numDigits;return _numDigits.isString()&&(_numDigits=_numDigits.convertToNumberObjectValue()),_numDigits.isError()?_numDigits:_number.floor(_numDigits)}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_MATH.ROUNDDOWN],[class Roundup extends base_function_BaseFunction{calculate(number,numDigits){let _number=number;if(_number.isString()&&(_number=_number.convertToNumberObjectValue()),_number.isError())return _number;let _numDigits=numDigits;return _numDigits.isString()&&(_numDigits=_numDigits.convertToNumberObjectValue()),_numDigits.isError()?_numDigits:_number.ceil(_numDigits)}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_MATH.ROUNDUP],[class Sec extends base_function_BaseFunction{calculate(number){return number.isArray()?number.map((numberObject=>this._handleSingleObject(numberObject))):this._handleSingleObject(number)}_handleSingleObject(number){let numberObject=number;if(numberObject.isString()&&(numberObject=numberObject.convertToNumberObjectValue()),numberObject.isError())return numberObject;const numberValue=+numberObject.getValue();return Math.abs(numberValue)>=2**27?ErrorValueObject.create(error_type_ErrorType.NUM):numberObject.cos().getReciprocal()}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_MATH.SEC],[class Sech extends base_function_BaseFunction{calculate(number){return number.isArray()?number.map((numberObject=>this._handleSingleObject(numberObject))):this._handleSingleObject(number)}_handleSingleObject(number){let numberObject=number;if(numberObject.isString()&&(numberObject=numberObject.convertToNumberObjectValue()),numberObject.isError())return numberObject;const numberValue=+numberObject.getValue();return Number.isFinite(Math.cosh(numberValue))?Math.abs(numberValue)>=2**27?ErrorValueObject.create(error_type_ErrorType.NUM):numberObject.cosh().getReciprocal():NumberValueObject.create(0)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_MATH.SECH],[class Seriessum extends base_function_BaseFunction{calculate(x,n,m,coefficients){if(x.isNull()||n.isNull()||m.isNull()||coefficients.isNull())return ErrorValueObject.create(error_type_ErrorType.NA);const{isError,errorObject,variants}=checkVariantsErrorIsArrayOrBoolean(x,n,m);if(isError)return errorObject;const{isError:isError2,errorObject:errorObject2,variants:variants2}=checkVariantsErrorIsStringToNumber(...variants);if(isError2)return errorObject2;const[xObject,nObject,mObject]=variants2,xValue=+xObject.getValue(),nValue=+nObject.getValue(),mValue=+mObject.getValue(),coefficientsArray=[];if(coefficients.isArray()){let isError_coefficients=!1,errorObject_coefficients=ErrorValueObject.create(error_type_ErrorType.VALUE);if(coefficients.iterator((coefficientsObject=>{const{isError:_isError,errorObject:_errorObject,coefficientsObject:_coefficientsObject}=this._handleSingleObject(coefficientsObject);if(_isError)return isError_coefficients=!0,errorObject_coefficients=_errorObject,!1;const coefficientsValue=+_coefficientsObject.getValue();coefficientsArray.push(coefficientsValue)})),isError_coefficients)return errorObject_coefficients}else{const{isError:_isError,errorObject:_errorObject,coefficientsObject:_coefficientsObject}=this._handleSingleObject(coefficients);if(_isError)return _errorObject;const coefficientsValue=+_coefficientsObject.getValue();coefficientsArray.push(coefficientsValue)}let result=0;for(let i=0;i<coefficientsArray.length;i++)result+=coefficientsArray[i]*xValue**(nValue+i*mValue);return Number.isNaN(result)||!Number.isFinite(result)?ErrorValueObject.create(error_type_ErrorType.NUM):NumberValueObject.create(result)}_handleSingleObject(coefficientsObject){if(coefficientsObject.isError())return{isError:!0,errorObject:coefficientsObject,coefficientsObject:null};if(coefficientsObject?.isBoolean())return{isError:!0,errorObject:ErrorValueObject.create(error_type_ErrorType.VALUE),coefficientsObject:null};let _coefficientsObject=coefficientsObject;return _coefficientsObject.isString()&&(_coefficientsObject=_coefficientsObject.convertToNumberObjectValue()),_coefficientsObject.isError()?{isError:!0,errorObject:_coefficientsObject,coefficientsObject:null}:{isError:!1,errorObject:null,coefficientsObject:_coefficientsObject}}constructor(...args){super(...args),this.minParams=4,this.maxParams=4}},FUNCTION_NAMES_MATH.SERIESSUM],[class Sequence extends base_function_BaseFunction{calculate(rows,columns,start,step){let _rows=rows,_columns=columns??NumberValueObject.create(1),_start=start??NumberValueObject.create(1),_step=step??NumberValueObject.create(1);_rows.isNull()&&(_rows=NumberValueObject.create(1)),_columns.isNull()&&(_columns=NumberValueObject.create(1)),_start.isNull()&&(_start=NumberValueObject.create(1)),_step.isNull()&&(_step=NumberValueObject.create(1));const maxRowLength=Math.max(_rows.isArray()?_rows.getRowCount():1,_columns.isArray()?_columns.getRowCount():1,_start.isArray()?_start.getRowCount():1,_step.isArray()?_step.getRowCount():1),maxColumnLength=Math.max(_rows.isArray()?_rows.getColumnCount():1,_columns.isArray()?_columns.getColumnCount():1,_start.isArray()?_start.getColumnCount():1,_step.isArray()?_step.getColumnCount():1),rowsArray=expandArrayValueObject(maxRowLength,maxColumnLength,_rows,ErrorValueObject.create(error_type_ErrorType.NA)),columnsArray=expandArrayValueObject(maxRowLength,maxColumnLength,_columns,ErrorValueObject.create(error_type_ErrorType.NA)),startArray=expandArrayValueObject(maxRowLength,maxColumnLength,_start,ErrorValueObject.create(error_type_ErrorType.NA)),stepArray=expandArrayValueObject(maxRowLength,maxColumnLength,_step,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=rowsArray.mapValue(((rowsObject,rowIndex,columnIndex)=>{const columnsObject=columnsArray.get(rowIndex,columnIndex),startObject=startArray.get(rowIndex,columnIndex),stepObject=stepArray.get(rowIndex,columnIndex);return rowsObject.isError()?rowsObject:columnsObject.isError()?columnsObject:startObject.isError()?startObject:stepObject.isError()?stepObject:this._getResult(rowsObject,columnsObject,startObject,stepObject,maxRowLength,maxColumnLength)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_getResult(rowsObject,columnsObject,startObject,stepObject,maxRowLength,maxColumnLength){const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(rowsObject,columnsObject,startObject,stepObject);if(isError)return errorObject;const[_rowsObject,_columnsObject,_startObject,_stepObject]=variants,rowsValue=Math.floor(+_rowsObject.getValue()),columnsValue=Math.floor(+_columnsObject.getValue()),startValue=+_startObject.getValue(),stepValue=+_stepObject.getValue();if(rowsValue<0||columnsValue<0||rowsValue*columnsValue>10**7)return ErrorValueObject.create(error_type_ErrorType.VALUE);if(0===rowsValue||0===columnsValue)return ErrorValueObject.create(error_type_ErrorType.CALC);const maxRows=this._rowCount-this.row,maxColumns=this._columnCount-this.column;if(rowsValue>maxRows||columnsValue>maxColumns)return ErrorValueObject.create(error_type_ErrorType.REF);const result=[];for(let r=0;r<rowsValue;r++){result[r]=[];for(let c=0;c<columnsValue;c++)result[r][c]=startValue+(r*columnsValue+c)*stepValue}return maxRowLength>1||maxColumnLength>1?NumberValueObject.create(result[0][0]):ArrayValueObject.createByArray(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=4,this.needsSheetRowColumnCount=!0}},FUNCTION_NAMES_MATH.SEQUENCE],[class Sign extends base_function_BaseFunction{calculate(number){if(number.isArray()){const resultArray=number.mapValue((numberObject=>this._handleSingleObject(numberObject)));return 1===resultArray.getRowCount()&&1===resultArray.getColumnCount()?resultArray.get(0,0):resultArray}return this._handleSingleObject(number)}_handleSingleObject(number){if(number.isError())return number;const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(number);if(isError)return errorObject;const[numberObject]=variants,numberValue=+numberObject.getValue();return numberValue>0?NumberValueObject.create(1):numberValue<0?NumberValueObject.create(-1):NumberValueObject.create(0)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_MATH.SIGN],[class Sin extends base_function_BaseFunction{calculate(variant){let _variant=variant;return _variant.isString()&&(_variant=_variant.convertToNumberObjectValue()),_variant.isError()?_variant:_variant.sin()}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_MATH.SIN],[class Sinh extends base_function_BaseFunction{calculate(variant){let _variant=variant;return _variant.isString()&&(_variant=_variant.convertToNumberObjectValue()),_variant.isError()?_variant:_variant.sinh()}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_MATH.SINH],[class Sqrt extends base_function_BaseFunction{calculate(number){let _number=number;return _number.isString()&&(_number=_number.convertToNumberObjectValue()),_number.isError()?_number:_number.sqrt()}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_MATH.SQRT],[class Sqrtpi extends base_function_BaseFunction{calculate(number){let _number=number;if(_number.isArray()){const rowCount=_number.getRowCount(),columnCount=_number.getColumnCount();if(rowCount>1||columnCount>1)return ErrorValueObject.create(error_type_ErrorType.VALUE);_number=_number.get(0,0)}if(_number.isString()&&(_number=_number.convertToNumberObjectValue()),_number.isError())return _number;const numberValue=+_number.getValue();if(numberValue<0)return ErrorValueObject.create(error_type_ErrorType.NUM);const result=Math.sqrt(numberValue*Math.PI);return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_MATH.SQRTPI],[class Subtotal extends base_function_BaseFunction{calculate(functionNum,...refs){if(functionNum.isError())return functionNum;if(functionNum.isReferenceObject()){const result=[];return functionNum.iterator(((valueObject,rowIndex,columnIndex)=>{null==result[rowIndex]&&(result[rowIndex]=[]),result[rowIndex][columnIndex]=this._handleSingleObject(valueObject,...refs)})),createNewArray(result,result.length,result[0].length)}return this._handleSingleObject(functionNum,...refs)}_handleSingleObject(functionNum,...refs){const indexNum=this._getIndexNumValue(functionNum);let result;if(indexNum instanceof ErrorValueObject)return indexNum;switch(indexNum){case 1:result=this._average(!1,...refs);break;case 2:result=this._count(!1,...refs);break;case 3:result=this._counta(!1,...refs);break;case 4:result=this._max(!1,...refs);break;case 5:result=this._min(!1,...refs);break;case 6:result=this._product(!1,...refs);break;case 7:result=this._stdev(!1,...refs);break;case 8:result=this._stdevp(!1,...refs);break;case 9:result=this._sum(!1,...refs);break;case 10:result=this._var(!1,...refs);break;case 11:result=this._varp(!1,...refs);break;case 101:result=this._average(!0,...refs);break;case 102:result=this._count(!0,...refs);break;case 103:result=this._counta(!0,...refs);break;case 104:result=this._max(!0,...refs);break;case 105:result=this._min(!0,...refs);break;case 106:result=this._product(!0,...refs);break;case 107:result=this._stdev(!0,...refs);break;case 108:result=this._stdevp(!0,...refs);break;case 109:result=this._sum(!0,...refs);break;case 110:result=this._var(!0,...refs);break;case 111:result=this._varp(!0,...refs);break;default:result=ErrorValueObject.create(error_type_ErrorType.VALUE)}return result}_getIndexNumValue(indexNum){const indexNumValue=indexNum?Number(indexNum.getValue()):0;if(Number.isNaN(indexNumValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);const indexNumValueInt=Math.floor(indexNumValue);return indexNumValueInt>=1&&indexNumValueInt<=11||indexNumValueInt>=101&&indexNumValueInt<=111?indexNumValueInt:ErrorValueObject.create(error_type_ErrorType.VALUE)}_average(ignoreHidden,...refs){const flattenArray=this._flattenRefArray(ignoreHidden,...refs);return flattenArray.isError()?flattenArray:flattenArray.mean()}_count(ignoreHidden,...refs){let accumulatorAll=NumberValueObject.create(0);for(let i=0;i<refs.length;i++){const variant=refs[i];if(!variant.isReferenceObject())return ErrorValueObject.create(error_type_ErrorType.VALUE);const rowData=variant.getRowData();variant.iterator(((valueObject,rowIndex)=>{if(ignoreHidden&&this._isRowHidden(rowData,rowIndex))return!0;valueObject?.isNumber()&&(accumulatorAll=accumulatorAll.plusBy(1))}))}return accumulatorAll}_counta(ignoreHidden,...refs){let accumulatorAll=NumberValueObject.create(0);for(let i=0;i<refs.length;i++){const variant=refs[i];if(!variant.isReferenceObject())return ErrorValueObject.create(error_type_ErrorType.VALUE);const rowData=variant.getRowData();variant.iterator(((valueObject,rowIndex)=>!(!ignoreHidden||!this._isRowHidden(rowData,rowIndex))||(!(null!=valueObject&&!valueObject.isNull())||void(accumulatorAll=accumulatorAll.plusBy(1)))))}return accumulatorAll}_max(ignoreHidden,...refs){const flattenArray=this._flattenRefArray(ignoreHidden,...refs);return flattenArray.isError()?flattenArray:this._isBlankArrayObject(flattenArray)?NumberValueObject.create(0):flattenArray.max()}_min(ignoreHidden,...refs){const flattenArray=this._flattenRefArray(ignoreHidden,...refs);return flattenArray.isError()?flattenArray:this._isBlankArrayObject(flattenArray)?NumberValueObject.create(0):flattenArray.min()}_product(ignoreHidden,...refs){const flattenArray=this._flattenRefArray(ignoreHidden,...refs);if(flattenArray.isError())return flattenArray;if(this._isBlankArrayObject(flattenArray))return NumberValueObject.create(0);let result=NumberValueObject.create(1);return flattenArray.iterator((valueObject=>{result=result.multiply(valueObject)})),result}_stdev(ignoreHidden,...refs){const flattenArray=this._flattenRefArray(ignoreHidden,...refs);return flattenArray.isError()?flattenArray:this._isBlankArrayObject(flattenArray)?ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO):flattenArray.std(1)}_stdevp(ignoreHidden,...refs){const flattenArray=this._flattenRefArray(ignoreHidden,...refs);return flattenArray.isError()?flattenArray:this._isBlankArrayObject(flattenArray)?ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO):flattenArray.std()}_sum(ignoreHidden,...refs){const flattenArray=this._flattenRefArray(ignoreHidden,...refs);return flattenArray.isError()?flattenArray:flattenArray.sum()}_var(ignoreHidden,...refs){const flattenArray=this._flattenRefArray(ignoreHidden,...refs);return flattenArray.isError()?flattenArray:this._isBlankArrayObject(flattenArray)?ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO):flattenArray.var(1)}_varp(ignoreHidden,...refs){const flattenArray=this._flattenRefArray(ignoreHidden,...refs);return flattenArray.isError()?flattenArray:this._isBlankArrayObject(flattenArray)?ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO):flattenArray.var()}_flattenRefArray(ignoreHidden,...variants){const flattenValues=[];flattenValues[0]=[];for(let i=0;i<variants.length;i++){const variant=variants[i];if(variant.isError())return variant;if(!variant.isReferenceObject())return ErrorValueObject.create(error_type_ErrorType.VALUE);const rowData=variant.getRowData();let errorValue;if(variant.iterator(((valueObject,rowIndex)=>!(!ignoreHidden||!this._isRowHidden(rowData,rowIndex))||(!!(null==valueObject||valueObject.isNull()||valueObject.isString()||valueObject.isBoolean())||(valueObject.isError()?(errorValue=valueObject,!1):void flattenValues[0].push(valueObject))))),errorValue?.isError())return errorValue}return createNewArray(flattenValues,1,flattenValues[0].length)}_isRowHidden(rowData,rowIndex){const row=rowData[rowIndex];return!!row&&row.hd===src.OdA.TRUE}_isBlankArrayObject(arrayObject){return 0===arrayObject.getArrayValue()[0].length}constructor(...args){super(...args),this.minParams=2,this.maxParams=255,this.needsReferenceObject=!0}},FUNCTION_NAMES_MATH.SUBTOTAL],[class Sum extends base_function_BaseFunction{calculate(...variants){let accumulatorAll=NumberValueObject.create(0);for(let i=0;i<variants.length;i++){let variant=variants[i];if(variant.isString()&&(variant=variant.convertToNumberObjectValue()),variant.isError())return variant;if(variant.isArray()&&(variant=variant.sum()),variant.isError())return variant;if(accumulatorAll=accumulatorAll.plus(variant),accumulatorAll.isError())return accumulatorAll}return accumulatorAll}constructor(...args){super(...args),this.minParams=1,this.maxParams=255}},FUNCTION_NAMES_MATH.SUM],[class Sumif extends base_function_BaseFunction{calculate(range,criteria,sumRange){let _criteria=criteria;if(criteria.isReferenceObject()&&(_criteria=criteria.toArrayValueObject()),_criteria.isArray()){const resultArray=_criteria.mapValue((criteriaObject=>this._handleSingleObject(range,criteriaObject,sumRange)));return 1===resultArray.getRowCount()&&1===resultArray.getColumnCount()?resultArray.get(0,0):resultArray}return this._handleSingleObject(range,_criteria,sumRange)}_handleSingleObject(range,criteria,sumRange){if(range.isError())return range;if(criteria.isError())return criteria;if(sumRange?.isError())return sumRange;if(!range.isReferenceObject()||sumRange&&!sumRange.isReferenceObject())return ErrorValueObject.create(error_type_ErrorType.VALUE);const _range=range.toArrayValueObject();let resultArrayObject=valueObjectCompare(_range,criteria);resultArrayObject=filterSameValueObjectResult(resultArrayObject,_range,criteria);const rangeRowCount=_range.getRowCount(),rangeColumnCount=_range.getColumnCount();let _sumRange=_range;if(sumRange){_sumRange=sumRange.toArrayValueObject();const sumRangeRowCount=_sumRange.getRowCount(),sumRangeColumnCount=_sumRange.getColumnCount();if(rangeRowCount!==sumRangeRowCount||rangeColumnCount!==sumRangeColumnCount){const rangeData=sumRange.getRangeData();rangeData.endRow=rangeData.startRow+rangeRowCount-1,rangeData.endColumn=rangeData.startColumn+rangeColumnCount-1,sumRange.setRangeData(rangeData),_sumRange=sumRange.toArrayValueObject()}}return _sumRange.pick(resultArrayObject).sum()}constructor(...args){super(...args),this.minParams=2,this.maxParams=3,this.needsReferenceObject=!0}},FUNCTION_NAMES_MATH.SUMIF],[class Sumifs extends base_function_BaseFunction{calculate(sumRange,...variants){if(sumRange.isError())return sumRange;if(!sumRange.isArray())return ErrorValueObject.create(error_type_ErrorType.VALUE);if(variants.length<2||variants.length%2!=0)return ErrorValueObject.create(error_type_ErrorType.VALUE);if(variants.some(((variant,i)=>i%2==0&&!variant.isArray())))return ErrorValueObject.create(error_type_ErrorType.VALUE);const{maxRowLength,maxColumnLength}=calculateMaxDimensions(variants),errorArray=getErrorArray(variants,sumRange,maxRowLength,maxColumnLength);if(errorArray)return errorArray;const booleanResults=getBooleanResults(variants,maxRowLength,maxColumnLength,!0);return this._aggregateResults(sumRange,booleanResults)}_aggregateResults(sumRange,booleanResults){const sumResults=booleanResults.map((row=>row.map((booleanResult=>sumRange.pick(booleanResult).sum())))),arrayValueObjectData={calculateValueList:sumResults,rowCount:sumResults.length,columnCount:sumResults[0].length,unitId:this.unitId||"",sheetId:this.subUnitId||"",row:this.row,column:this.column};return ArrayValueObject.create(arrayValueObjectData)}constructor(...args){super(...args),this.minParams=3,this.maxParams=255}},FUNCTION_NAMES_MATH.SUMIFS],[class Sumproduct extends base_function_BaseFunction{calculate(array1,...variants){if(array1.isError())return array1;const _array1=this._initArray1(array1);if(variants.length>0){const rowCount=_array1.getRowCount(),columnCount=_array1.getColumnCount();let resultArray=this._getResultArrayByArray1(rowCount,columnCount,_array1);if(resultArray instanceof ErrorValueObject)return resultArray;for(let i=0;i<variants.length;i++){if(variants[i].isError())return variants[i];let variantRowCount=1,variantColumnCount=1;if(variants[i].isArray()&&(variantRowCount=variants[i].getRowCount(),variantColumnCount=variants[i].getColumnCount()),variantRowCount!==rowCount||variantColumnCount!==columnCount)return ErrorValueObject.create(error_type_ErrorType.VALUE);for(let r=0;r<rowCount;r++){const row=[];for(let c=0;c<columnCount;c++){let variantValueObject=variants[i];if(variants[i].isArray()&&(variantValueObject=variants[i].get(r,c)),variantValueObject.isError())return variantValueObject;const variantValue=variantValueObject.getValue();variantValue&&(0,src.DMQ)(variantValue)?row.push(+variantValue*resultArray[r][c]):row.push(0)}resultArray[r]=row}}const result=resultArray.reduce(((acc,cur)=>acc.concat(cur))).reduce(((acc,cur)=>acc+cur),0);return NumberValueObject.create(result)}return _array1.sum()}_initArray1(array1){let _array1=array1;return _array1.isArray()||(_array1=ArrayValueObject.create({calculateValueList:[[_array1]],rowCount:1,columnCount:1,unitId:"",sheetId:"",row:0,column:0})),_array1}_getResultArrayByArray1(rowCount,columnCount,array1){const resultArray=[];for(let r=0;r<rowCount;r++){const row=[];for(let c=0;c<columnCount;c++){const array1ValueObject=array1.get(r,c);if(array1ValueObject.isError())return array1ValueObject;const array1Value=array1ValueObject.getValue();array1Value&&(0,src.DMQ)(array1Value)?row.push(+array1Value):row.push(0)}resultArray.push(row)}return resultArray}constructor(...args){super(...args),this.minParams=1,this.maxParams=255}},FUNCTION_NAMES_MATH.SUMPRODUCT],[class Sumsq extends base_function_BaseFunction{calculate(...variants){let accumulatorAll=NumberValueObject.create(0);const exponent=NumberValueObject.create(2);for(let i=0;i<variants.length;i++){let variant=variants[i];if(variant.isString()&&(variant=variant.convertToNumberObjectValue()),variant.isError())return variant;if(variant.isArray()?variant.iterator((valueObject=>!!(null==valueObject||valueObject.isString()||valueObject.isBoolean()||valueObject.isNull())||(valueObject.isError()?(accumulatorAll=valueObject,!1):void(accumulatorAll=accumulatorAll.plus(valueObject.pow(exponent)))))):accumulatorAll=accumulatorAll.plus(variant.pow(exponent)),accumulatorAll.isError())return accumulatorAll}return accumulatorAll}constructor(...args){super(...args),this.minParams=1,this.maxParams=255}},FUNCTION_NAMES_MATH.SUMSQ],[class Sumx2my2 extends base_function_BaseFunction{calculate(arrayX,arrayY){if(arrayX.isError())return arrayX;if(arrayY.isError())return arrayY;const arrayXCount=(arrayX.isArray()?arrayX.getRowCount():1)*(arrayX.isArray()?arrayX.getColumnCount():1);if(arrayXCount!==(arrayY.isArray()?arrayY.getRowCount():1)*(arrayY.isArray()?arrayY.getColumnCount():1))return ErrorValueObject.create(error_type_ErrorType.NA);if(1===arrayXCount)return this._calculateSingleCell(arrayX,arrayY);{const arrayXFlatten=arrayX.flatten(),arrayYFlatten=arrayY.flatten();let errorObject=NullValueObject.create();const arrayXValidValue=[],arrayYValidValue=[];let result=0;return arrayXFlatten.iterator(((arrayXObject,rowIndex,columnIndex)=>{const arrayYObject=arrayYFlatten.get(rowIndex,columnIndex);if(null==arrayXObject||arrayXObject.isString()||arrayXObject.isBoolean()||arrayXObject.isNull())return!0;if(arrayXObject?.isError())return errorObject=arrayXObject,!1;if(null==arrayYObject||arrayYObject.isString()||arrayYObject.isBoolean()||arrayYObject.isNull())return!0;if(arrayYObject?.isError())return errorObject=arrayYObject,!1;const arrayXValue=+arrayXObject.getValue(),arrayYValue=+arrayYObject.getValue();arrayXValidValue.push(arrayXValue),arrayYValidValue.push(arrayYValue),result+=arrayXValue**2-arrayYValue**2})),errorObject.isError()?errorObject:0===arrayXValidValue.length||0===arrayYValidValue.length?ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO):NumberValueObject.create(result)}}_calculateSingleCell(arrayX,arrayY){let _arrayX=arrayX;if(_arrayX.isArray()&&(_arrayX=_arrayX.get(0,0)),_arrayX.isError())return _arrayX;let _arrayY=arrayY;if(_arrayY.isArray()&&(_arrayY=_arrayY.get(0,0)),_arrayY.isError())return _arrayY;if(_arrayX.isNull()||_arrayY.isNull())return ErrorValueObject.create(error_type_ErrorType.VALUE);const arrayXValue=+_arrayX.getValue(),arrayYValue=+_arrayY.getValue();if(_arrayX.isString()&&!(0,src.DMQ)(arrayXValue)||_arrayX.isBoolean()||_arrayY.isString()&&!(0,src.DMQ)(arrayYValue)||_arrayY.isBoolean())return ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO);const result=arrayXValue**2-arrayYValue**2;return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_MATH.SUMX2MY2],[class Sumx2py2 extends base_function_BaseFunction{calculate(arrayX,arrayY){if(arrayX.isError())return arrayX;if(arrayY.isError())return arrayY;const arrayXCount=(arrayX.isArray()?arrayX.getRowCount():1)*(arrayX.isArray()?arrayX.getColumnCount():1);if(arrayXCount!==(arrayY.isArray()?arrayY.getRowCount():1)*(arrayY.isArray()?arrayY.getColumnCount():1))return ErrorValueObject.create(error_type_ErrorType.NA);if(1===arrayXCount)return this._calculateSingleCell(arrayX,arrayY);{const arrayXFlatten=arrayX.flatten(),arrayYFlatten=arrayY.flatten();let errorObject=NullValueObject.create();const arrayXValidValue=[],arrayYValidValue=[];let result=0;return arrayXFlatten.iterator(((arrayXObject,rowIndex,columnIndex)=>{const arrayYObject=arrayYFlatten.get(rowIndex,columnIndex);if(null==arrayXObject||arrayXObject.isString()||arrayXObject.isBoolean()||arrayXObject.isNull())return!0;if(arrayXObject?.isError())return errorObject=arrayXObject,!1;if(null==arrayYObject||arrayYObject.isString()||arrayYObject.isBoolean()||arrayYObject.isNull())return!0;if(arrayYObject?.isError())return errorObject=arrayYObject,!1;const arrayXValue=+arrayXObject.getValue(),arrayYValue=+arrayYObject.getValue();arrayXValidValue.push(arrayXValue),arrayYValidValue.push(arrayYValue),result+=arrayXValue**2+arrayYValue**2})),errorObject.isError()?errorObject:0===arrayXValidValue.length||0===arrayYValidValue.length?ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO):NumberValueObject.create(result)}}_calculateSingleCell(arrayX,arrayY){let _arrayX=arrayX;if(_arrayX.isArray()&&(_arrayX=_arrayX.get(0,0)),_arrayX.isError())return _arrayX;let _arrayY=arrayY;if(_arrayY.isArray()&&(_arrayY=_arrayY.get(0,0)),_arrayY.isError())return _arrayY;if(_arrayX.isNull()||_arrayY.isNull())return ErrorValueObject.create(error_type_ErrorType.VALUE);const arrayXValue=+_arrayX.getValue(),arrayYValue=+_arrayY.getValue();if(_arrayX.isString()&&!(0,src.DMQ)(arrayXValue)||_arrayX.isBoolean()||_arrayY.isString()&&!(0,src.DMQ)(arrayYValue)||_arrayY.isBoolean())return ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO);const result=arrayXValue**2+arrayYValue**2;return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_MATH.SUMX2PY2],[class Sumxmy2 extends base_function_BaseFunction{calculate(arrayX,arrayY){if(arrayX.isError())return arrayX;if(arrayY.isError())return arrayY;const arrayXCount=(arrayX.isArray()?arrayX.getRowCount():1)*(arrayX.isArray()?arrayX.getColumnCount():1);if(arrayXCount!==(arrayY.isArray()?arrayY.getRowCount():1)*(arrayY.isArray()?arrayY.getColumnCount():1))return ErrorValueObject.create(error_type_ErrorType.NA);if(1===arrayXCount)return this._calculateSingleCell(arrayX,arrayY);{const arrayXFlatten=arrayX.flatten(),arrayYFlatten=arrayY.flatten();let errorObject=NullValueObject.create();const arrayXValidValue=[],arrayYValidValue=[];let result=0;return arrayXFlatten.iterator(((arrayXObject,rowIndex,columnIndex)=>{const arrayYObject=arrayYFlatten.get(rowIndex,columnIndex);if(null==arrayXObject||arrayXObject.isString()||arrayXObject.isBoolean()||arrayXObject.isNull())return!0;if(arrayXObject?.isError())return errorObject=arrayXObject,!1;if(null==arrayYObject||arrayYObject.isString()||arrayYObject.isBoolean()||arrayYObject.isNull())return!0;if(arrayYObject?.isError())return errorObject=arrayYObject,!1;const arrayXValue=+arrayXObject.getValue(),arrayYValue=+arrayYObject.getValue();arrayXValidValue.push(arrayXValue),arrayYValidValue.push(arrayYValue),result+=(arrayXValue-arrayYValue)**2})),errorObject.isError()?errorObject:0===arrayXValidValue.length||0===arrayYValidValue.length?ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO):NumberValueObject.create(result)}}_calculateSingleCell(arrayX,arrayY){let _arrayX=arrayX;if(_arrayX.isArray()&&(_arrayX=_arrayX.get(0,0)),_arrayX.isError())return _arrayX;let _arrayY=arrayY;if(_arrayY.isArray()&&(_arrayY=_arrayY.get(0,0)),_arrayY.isError())return _arrayY;if(_arrayX.isNull()||_arrayY.isNull())return ErrorValueObject.create(error_type_ErrorType.VALUE);const arrayXValue=+_arrayX.getValue(),arrayYValue=+_arrayY.getValue();if(_arrayX.isString()&&!(0,src.DMQ)(arrayXValue)||_arrayX.isBoolean()||_arrayY.isString()&&!(0,src.DMQ)(arrayYValue)||_arrayY.isBoolean())return ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO);const result=(arrayXValue-arrayYValue)**2;return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_MATH.SUMXMY2],[class Tan extends base_function_BaseFunction{calculate(variant){let _variant=variant;return _variant.isString()&&(_variant=_variant.convertToNumberObjectValue()),_variant.isError()?_variant:_variant.tan()}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_MATH.TAN],[class Tanh extends base_function_BaseFunction{calculate(variant){let _variant=variant;return _variant.isString()&&(_variant=_variant.convertToNumberObjectValue()),_variant.isError()?_variant:_variant.tanh()}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_MATH.TANH],[class Trunc extends base_function_BaseFunction{calculate(number,numDigits){const _numDigits=numDigits??NumberValueObject.create(0),maxRowLength=Math.max(number.isArray()?number.getRowCount():1,_numDigits.isArray()?_numDigits.getRowCount():1),maxColumnLength=Math.max(number.isArray()?number.getColumnCount():1,_numDigits.isArray()?_numDigits.getColumnCount():1),numberArray=expandArrayValueObject(maxRowLength,maxColumnLength,number,ErrorValueObject.create(error_type_ErrorType.NA)),numDigitsArray=expandArrayValueObject(maxRowLength,maxColumnLength,_numDigits,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=numberArray.map(((numberObject,rowIndex,columnIndex)=>{let numDigitsObject=numDigitsArray.get(rowIndex,columnIndex),_numberObject=numberObject;if(_numberObject.isString()&&(_numberObject=_numberObject.convertToNumberObjectValue()),_numberObject.isError())return _numberObject;if(numDigitsObject.isString()&&(numDigitsObject=numDigitsObject.convertToNumberObjectValue()),numDigitsObject.isError())return numDigitsObject;const numberValue=+_numberObject.getValue(),numDigitsValue=+numDigitsObject.getValue(),factor=10**Math.trunc(numDigitsValue),epsilon=baseEpsilon(numberValue,factor),result=Math.trunc(multiply(numberValue,factor)+epsilon)/factor;return NumberValueObject.create(result)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}constructor(...args){super(...args),this.minParams=1,this.maxParams=2}},FUNCTION_NAMES_MATH.TRUNC]];class CubeValueObject extends BaseValueObject{static create(values){return new CubeValueObject(values)}isCube(){return!0}constructor(values){super(""),this._values=[],this._values=values}dispose(){this._values.forEach((value=>{value.dispose()})),this._values=[]}sum(){const result=NumberValueObject.create(0);return this._values.forEach((arr=>{result.plus(arr.sum())})),result}max(){let result=NumberValueObject.create(Number.NEGATIVE_INFINITY);return this._values.forEach((arr=>{const compare=arr.max();result.isLessThan(compare)&&(result=compare)})),result}min(){let result=NumberValueObject.create(Number.POSITIVE_INFINITY);return this._values.forEach((arr=>{const compare=arr.max();result.isGreaterThan(compare)&&(result=compare)})),result}count(){const count=NumberValueObject.create(0);return this._values.forEach((arr=>{count.plus(arr.count())})),count}countA(){const count=NumberValueObject.create(0);return this._values.forEach((arr=>{count.plus(arr.countA())})),count}countBlank(){const count=NumberValueObject.create(0);return this._values.forEach((arr=>{count.plus(arr.countBlank())})),count}}const functionMeta=[[class Compare extends base_function_BaseFunction{setCompareType(token){this._compareType=token}calculate(variant1,variant2){return variant1.isError()?variant1:variant2.isError()?variant2:variant1.compare(variant2,this._compareType)}constructor(...args){super(...args),this.minParams=2,this.maxParams=2,this._compareType=compareToken.EQUALS}},FUNCTION_NAMES_META.COMPARE],[class Divided extends base_function_BaseFunction{calculate(variant1,variant2){return variant1.isError()?variant1:variant2.isError()?variant2:variant2.isArray()||0!==variant2.getValue()?variant1.divided(variant2):ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO)}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_META.DIVIDED],[class Minus extends base_function_BaseFunction{calculate(variant1,variant2){return variant1.isError()?variant1:variant2.isError()?variant2:variant1.minus(variant2)}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_META.MINUS],[class Multiply extends base_function_BaseFunction{calculate(variant1,variant2){return variant1.isError()?variant1:variant2.isError()?variant2:variant1.multiply(variant2)}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_META.MULTIPLY],[class Plus extends base_function_BaseFunction{calculate(variant1,variant2){return variant1.isError()?variant1:variant2.isError()?variant2:variant1.plus(variant2)}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_META.PLUS],[class Cube extends base_function_BaseFunction{calculate(...variants){const values=[];for(let i=0;i<variants.length;i++){const variant=variants[i];if(variant.isError())return variant;if(!variant.isArray())return ErrorValueObject.create(error_type_ErrorType.VALUE);values.push(variant)}return CubeValueObject.create(values)}constructor(...args){super(...args),this.minParams=1,this.maxParams=255}},FUNCTION_NAMES_META.CUBE]];function filterNumberValueObject(array){const newArray=[];newArray[0]=[];let isError=null;return array.iterator(((valueObject,_rowIndex,_columnIndex)=>{if(valueObject?.isError())return isError=valueObject,!1;valueObject?.isNumber()&&newArray[0].push(valueObject)})),isError||createNewArray(newArray,1,newArray[0].length)}class Forecast extends base_function_BaseFunction{calculate(x,knownYs,knownXs){const knownYsRowCount=knownYs.isArray()?knownYs.getRowCount():1,knownYsColumnCount=knownYs.isArray()?knownYs.getColumnCount():1,knownXsRowCount=knownXs.isArray()?knownXs.getRowCount():1,knownXsColumnCount=knownXs.isArray()?knownXs.getColumnCount():1;let _knownYs=knownYs;knownYs.isArray()&&1===knownYsRowCount&&1===knownYsColumnCount&&(_knownYs=knownYs.get(0,0));let _knownXs=knownXs;return knownXs.isArray()&&1===knownXsRowCount&&1===knownXsColumnCount&&(_knownXs=knownXs.get(0,0)),x.isArray()?x.mapValue((xObject=>this._handleSignleObject(xObject,_knownYs,_knownXs,knownYsRowCount,knownYsColumnCount,knownXsRowCount,knownXsColumnCount))):this._handleSignleObject(x,_knownYs,_knownXs,knownYsRowCount,knownYsColumnCount,knownXsRowCount,knownXsColumnCount)}_handleSignleObject(x,knownYs,knownXs,knownYsRowCount,knownYsColumnCount,knownXsRowCount,knownXsColumnCount){if(x.isError())return x;if(knownYs.isError())return knownYs;if(knownXs.isError())return knownXs;let _x=x;if(x.isString()&&(_x=x.convertToNumberObjectValue()),_x.isError())return _x;const xValue=+_x.getValue();if((knownYsRowCount*knownYsColumnCount==1||knownXsRowCount*knownXsColumnCount==1)&&(knownYs.isNull()||knownXs.isNull()))return ErrorValueObject.create(error_type_ErrorType.VALUE);if(knownYsRowCount*knownYsColumnCount!=knownXsRowCount*knownXsColumnCount)return ErrorValueObject.create(error_type_ErrorType.NA);const{isError,errorObject,array1Values,array2Values,noCalculate}=getTwoArrayNumberValues(knownYs,knownXs,knownYsRowCount*knownYsColumnCount,knownYsColumnCount,knownXsColumnCount);if(isError)return errorObject;if(noCalculate)return ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO);const result=forecastLinear(xValue,array1Values,array2Values);return Number.isFinite(result)?NumberValueObject.create(result):ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO)}constructor(...args){super(...args),this.minParams=3,this.maxParams=3}}var FUNCTION_NAMES_STATISTICAL=function(FUNCTION_NAMES_STATISTICAL){return FUNCTION_NAMES_STATISTICAL.AVEDEV="AVEDEV",FUNCTION_NAMES_STATISTICAL.AVERAGE="AVERAGE",FUNCTION_NAMES_STATISTICAL.AVERAGE_WEIGHTED="AVERAGE.WEIGHTED",FUNCTION_NAMES_STATISTICAL.AVERAGEA="AVERAGEA",FUNCTION_NAMES_STATISTICAL.AVERAGEIF="AVERAGEIF",FUNCTION_NAMES_STATISTICAL.AVERAGEIFS="AVERAGEIFS",FUNCTION_NAMES_STATISTICAL.BETA_DIST="BETA.DIST",FUNCTION_NAMES_STATISTICAL.BETA_INV="BETA.INV",FUNCTION_NAMES_STATISTICAL.BINOM_DIST="BINOM.DIST",FUNCTION_NAMES_STATISTICAL.BINOM_DIST_RANGE="BINOM.DIST.RANGE",FUNCTION_NAMES_STATISTICAL.BINOM_INV="BINOM.INV",FUNCTION_NAMES_STATISTICAL.CHISQ_DIST="CHISQ.DIST",FUNCTION_NAMES_STATISTICAL.CHISQ_DIST_RT="CHISQ.DIST.RT",FUNCTION_NAMES_STATISTICAL.CHISQ_INV="CHISQ.INV",FUNCTION_NAMES_STATISTICAL.CHISQ_INV_RT="CHISQ.INV.RT",FUNCTION_NAMES_STATISTICAL.CHISQ_TEST="CHISQ.TEST",FUNCTION_NAMES_STATISTICAL.CONFIDENCE_NORM="CONFIDENCE.NORM",FUNCTION_NAMES_STATISTICAL.CONFIDENCE_T="CONFIDENCE.T",FUNCTION_NAMES_STATISTICAL.CORREL="CORREL",FUNCTION_NAMES_STATISTICAL.COUNT="COUNT",FUNCTION_NAMES_STATISTICAL.COUNTA="COUNTA",FUNCTION_NAMES_STATISTICAL.COUNTBLANK="COUNTBLANK",FUNCTION_NAMES_STATISTICAL.COUNTIF="COUNTIF",FUNCTION_NAMES_STATISTICAL.COUNTIFS="COUNTIFS",FUNCTION_NAMES_STATISTICAL.COVARIANCE_P="COVARIANCE.P",FUNCTION_NAMES_STATISTICAL.COVARIANCE_S="COVARIANCE.S",FUNCTION_NAMES_STATISTICAL.DEVSQ="DEVSQ",FUNCTION_NAMES_STATISTICAL.EXPON_DIST="EXPON.DIST",FUNCTION_NAMES_STATISTICAL.F_DIST="F.DIST",FUNCTION_NAMES_STATISTICAL.F_DIST_RT="F.DIST.RT",FUNCTION_NAMES_STATISTICAL.F_INV="F.INV",FUNCTION_NAMES_STATISTICAL.F_INV_RT="F.INV.RT",FUNCTION_NAMES_STATISTICAL.F_TEST="F.TEST",FUNCTION_NAMES_STATISTICAL.FISHER="FISHER",FUNCTION_NAMES_STATISTICAL.FISHERINV="FISHERINV",FUNCTION_NAMES_STATISTICAL.FORECAST="FORECAST",FUNCTION_NAMES_STATISTICAL.FORECAST_ETS="FORECAST.ETS",FUNCTION_NAMES_STATISTICAL.FORECAST_ETS_CONFINT="FORECAST.ETS.CONFINT",FUNCTION_NAMES_STATISTICAL.FORECAST_ETS_SEASONALITY="FORECAST.ETS.SEASONALITY",FUNCTION_NAMES_STATISTICAL.FORECAST_ETS_STAT="FORECAST.ETS.STAT",FUNCTION_NAMES_STATISTICAL.FORECAST_LINEAR="FORECAST.LINEAR",FUNCTION_NAMES_STATISTICAL.FREQUENCY="FREQUENCY",FUNCTION_NAMES_STATISTICAL.GAMMA="GAMMA",FUNCTION_NAMES_STATISTICAL.GAMMA_DIST="GAMMA.DIST",FUNCTION_NAMES_STATISTICAL.GAMMA_INV="GAMMA.INV",FUNCTION_NAMES_STATISTICAL.GAMMALN="GAMMALN",FUNCTION_NAMES_STATISTICAL.GAMMALN_PRECISE="GAMMALN.PRECISE",FUNCTION_NAMES_STATISTICAL.GAUSS="GAUSS",FUNCTION_NAMES_STATISTICAL.GEOMEAN="GEOMEAN",FUNCTION_NAMES_STATISTICAL.GROWTH="GROWTH",FUNCTION_NAMES_STATISTICAL.HARMEAN="HARMEAN",FUNCTION_NAMES_STATISTICAL.HYPGEOM_DIST="HYPGEOM.DIST",FUNCTION_NAMES_STATISTICAL.INTERCEPT="INTERCEPT",FUNCTION_NAMES_STATISTICAL.KURT="KURT",FUNCTION_NAMES_STATISTICAL.LARGE="LARGE",FUNCTION_NAMES_STATISTICAL.LINEST="LINEST",FUNCTION_NAMES_STATISTICAL.LOGEST="LOGEST",FUNCTION_NAMES_STATISTICAL.LOGNORM_DIST="LOGNORM.DIST",FUNCTION_NAMES_STATISTICAL.LOGNORM_INV="LOGNORM.INV",FUNCTION_NAMES_STATISTICAL.MARGINOFERROR="MARGINOFERROR",FUNCTION_NAMES_STATISTICAL.MAX="MAX",FUNCTION_NAMES_STATISTICAL.MAXA="MAXA",FUNCTION_NAMES_STATISTICAL.MAXIFS="MAXIFS",FUNCTION_NAMES_STATISTICAL.MEDIAN="MEDIAN",FUNCTION_NAMES_STATISTICAL.MIN="MIN",FUNCTION_NAMES_STATISTICAL.MINA="MINA",FUNCTION_NAMES_STATISTICAL.MINIFS="MINIFS",FUNCTION_NAMES_STATISTICAL.MODE_MULT="MODE.MULT",FUNCTION_NAMES_STATISTICAL.MODE_SNGL="MODE.SNGL",FUNCTION_NAMES_STATISTICAL.NEGBINOM_DIST="NEGBINOM.DIST",FUNCTION_NAMES_STATISTICAL.NORM_DIST="NORM.DIST",FUNCTION_NAMES_STATISTICAL.NORM_INV="NORM.INV",FUNCTION_NAMES_STATISTICAL.NORM_S_DIST="NORM.S.DIST",FUNCTION_NAMES_STATISTICAL.NORM_S_INV="NORM.S.INV",FUNCTION_NAMES_STATISTICAL.PEARSON="PEARSON",FUNCTION_NAMES_STATISTICAL.PERCENTILE_EXC="PERCENTILE.EXC",FUNCTION_NAMES_STATISTICAL.PERCENTILE_INC="PERCENTILE.INC",FUNCTION_NAMES_STATISTICAL.PERCENTRANK_EXC="PERCENTRANK.EXC",FUNCTION_NAMES_STATISTICAL.PERCENTRANK_INC="PERCENTRANK.INC",FUNCTION_NAMES_STATISTICAL.PERMUT="PERMUT",FUNCTION_NAMES_STATISTICAL.PERMUTATIONA="PERMUTATIONA",FUNCTION_NAMES_STATISTICAL.PHI="PHI",FUNCTION_NAMES_STATISTICAL.POISSON_DIST="POISSON.DIST",FUNCTION_NAMES_STATISTICAL.PROB="PROB",FUNCTION_NAMES_STATISTICAL.QUARTILE_EXC="QUARTILE.EXC",FUNCTION_NAMES_STATISTICAL.QUARTILE_INC="QUARTILE.INC",FUNCTION_NAMES_STATISTICAL.RANK_AVG="RANK.AVG",FUNCTION_NAMES_STATISTICAL.RANK_EQ="RANK.EQ",FUNCTION_NAMES_STATISTICAL.RSQ="RSQ",FUNCTION_NAMES_STATISTICAL.SKEW="SKEW",FUNCTION_NAMES_STATISTICAL.SKEW_P="SKEW.P",FUNCTION_NAMES_STATISTICAL.SLOPE="SLOPE",FUNCTION_NAMES_STATISTICAL.SMALL="SMALL",FUNCTION_NAMES_STATISTICAL.STANDARDIZE="STANDARDIZE",FUNCTION_NAMES_STATISTICAL.STDEV_P="STDEV.P",FUNCTION_NAMES_STATISTICAL.STDEV_S="STDEV.S",FUNCTION_NAMES_STATISTICAL.STDEVA="STDEVA",FUNCTION_NAMES_STATISTICAL.STDEVPA="STDEVPA",FUNCTION_NAMES_STATISTICAL.STEYX="STEYX",FUNCTION_NAMES_STATISTICAL.T_DIST="T.DIST",FUNCTION_NAMES_STATISTICAL.T_DIST_2T="T.DIST.2T",FUNCTION_NAMES_STATISTICAL.T_DIST_RT="T.DIST.RT",FUNCTION_NAMES_STATISTICAL.T_INV="T.INV",FUNCTION_NAMES_STATISTICAL.T_INV_2T="T.INV.2T",FUNCTION_NAMES_STATISTICAL.T_TEST="T.TEST",FUNCTION_NAMES_STATISTICAL.TREND="TREND",FUNCTION_NAMES_STATISTICAL.TRIMMEAN="TRIMMEAN",FUNCTION_NAMES_STATISTICAL.VAR_P="VAR.P",FUNCTION_NAMES_STATISTICAL.VAR_S="VAR.S",FUNCTION_NAMES_STATISTICAL.VARA="VARA",FUNCTION_NAMES_STATISTICAL.VARPA="VARPA",FUNCTION_NAMES_STATISTICAL.WEIBULL_DIST="WEIBULL.DIST",FUNCTION_NAMES_STATISTICAL.Z_TEST="Z.TEST",FUNCTION_NAMES_STATISTICAL}({});class Gammaln extends base_function_BaseFunction{calculate(x){if(x.isArray()){const resultArray=x.mapValue((xObject=>this._handleSingleObject(xObject)));return 1===resultArray.getRowCount()&&1===resultArray.getColumnCount()?resultArray.get(0,0):resultArray}return this._handleSingleObject(x)}_handleSingleObject(x){const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(x);if(isError)return errorObject;const[xObject]=variants,xValue=+xObject.getValue();if(xValue<=0)return ErrorValueObject.create(error_type_ErrorType.NUM);const result=gammaln(xValue);return Math.abs(result)<1e-15?NumberValueObject.create(0):NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}}const functionStatistical=[[class Avedev extends base_function_BaseFunction{calculate(...variants){let accumulatorSum=NumberValueObject.create(0),accumulatorCount=NumberValueObject.create(0);for(let i=0;i<variants.length;i++){let variant=variants[i];if(variant.isString()&&(variant=variant.convertToNumberObjectValue()),variant.isError())return variant;if(variant.isArray()){if(variant=filterNumberValueObject(variant),variant.isError())return variant;if(variants[i]=variant,accumulatorSum=accumulatorSum.plus(variant.sum()),accumulatorSum.isError())return accumulatorSum;accumulatorCount=accumulatorCount.plus(variant.count())}else variant.isNull()||(accumulatorSum=accumulatorSum.plus(variant),accumulatorCount=accumulatorCount.plus(NumberValueObject.create(1)))}if(0===accumulatorCount.getValue())return ErrorValueObject.create(error_type_ErrorType.NUM);const average=accumulatorSum.divided(accumulatorCount);if(average.isError())return average;let accumulatorAveDev=NumberValueObject.create(0);for(let i=0;i<variants.length;i++){let variant=variants[i];if(variant.isString()&&(variant=variant.convertToNumberObjectValue()),variant.isError())return variant;if(variant.isArray()){if(accumulatorAveDev=accumulatorAveDev.plus(variant.minus(average).abs().sum()),accumulatorAveDev.isError())return accumulatorAveDev}else variant.isNull()||(accumulatorAveDev=accumulatorAveDev.plus(variant.minus(average).abs()))}return accumulatorAveDev.divided(accumulatorCount)}constructor(...args){super(...args),this.minParams=1,this.maxParams=255}},FUNCTION_NAMES_STATISTICAL.AVEDEV],[class Average extends base_function_BaseFunction{calculate(...variants){let accumulatorSum=NumberValueObject.create(0),accumulatorCount=NumberValueObject.create(0);for(let i=0;i<variants.length;i++){let variant=variants[i];if((variant.isString()||variant.isBoolean())&&(variant=variant.convertToNumberObjectValue()),variant.isError())return variant;if(variant.isArray()){if(accumulatorSum=accumulatorSum.plus(variant.sum()),accumulatorSum.isError())return accumulatorSum;accumulatorCount=accumulatorCount.plus(variant.count())}else variant.isNull()||(accumulatorSum=accumulatorSum.plus(variant),accumulatorCount=accumulatorCount.plus(NumberValueObject.create(1)))}return accumulatorSum.divided(accumulatorCount)}constructor(...args){super(...args),this.minParams=1,this.maxParams=255}},FUNCTION_NAMES_STATISTICAL.AVERAGE],[class AverageWeighted extends base_function_BaseFunction{calculate(...variants){let otherErrorObject,isOtherError=!1;variants.length%2!=0&&(isOtherError=!0,otherErrorObject=ErrorValueObject.create(error_type_ErrorType.NA));const values=[],weights=[];for(let i=0;i<variants.length;i+=2){const valueObject=variants[i],valueObjectRowCount=valueObject.isArray()?valueObject.getRowCount():1,valueObjectColumnCount=valueObject.isArray()?valueObject.getColumnCount():1;for(let r=0;r<valueObjectRowCount;r++)for(let c=0;c<valueObjectColumnCount;c++){const obj=valueObject.isArray()?valueObject.get(r,c):valueObject;if(obj.isError())return obj;if(isOtherError)continue;const value=obj.isNull()?"":obj.getValue();values.push(value)}if(i+1>=variants.length)continue;const weightObject=variants[i+1],weightObjectRowCount=weightObject.isArray()?weightObject.getRowCount():1,weightObjectColumnCount=weightObject.isArray()?weightObject.getColumnCount():1;weightObjectRowCount===valueObjectRowCount&&weightObjectColumnCount===valueObjectColumnCount||(isOtherError=!0,otherErrorObject=ErrorValueObject.create(error_type_ErrorType.VALUE));for(let r=0;r<weightObjectRowCount;r++)for(let c=0;c<weightObjectColumnCount;c++){const obj=weightObject.isArray()?weightObject.get(r,c):weightObject;if(obj.isError())return obj;if(isOtherError)continue;const weight=obj.isNull()?"":obj.getValue();weights.push(weight)}}return isOtherError?otherErrorObject:this._getResult(values,weights)}_getResult(values,weights){const n=values.length;let sum=0,sumWeight=0;for(let i=0;i<n;i++){const value=values[i],weight=weights[i];if("number"==typeof value||"number"==typeof weight){if("number"!=typeof value||"number"!=typeof weight||weight<0)return ErrorValueObject.create(error_type_ErrorType.VALUE);sum+=value*weight,sumWeight+=weight}}if(0===sumWeight)return ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO);const result=sum/sumWeight;return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=2,this.maxParams=254}},FUNCTION_NAMES_STATISTICAL.AVERAGE_WEIGHTED],[class Averagea extends base_function_BaseFunction{calculate(...variants){let accumulatorSum=NumberValueObject.create(0),accumulatorCount=NumberValueObject.create(0);for(let i=0;i<variants.length;i++){let variant=variants[i];if((variant.isString()||variant.isBoolean())&&(variant=variant.convertToNumberObjectValue()),variant.isError())return variant;if(variant.isArray()){if(variant.iterator((valueObject=>{if(null==valueObject||valueObject.isNull())return!0;let _valueObject=valueObject;if(_valueObject.isString()&&(_valueObject=_valueObject.convertToNumberObjectValue(),_valueObject.isError()&&(_valueObject=NumberValueObject.create(0))),_valueObject.isBoolean()&&(_valueObject=_valueObject.convertToNumberObjectValue()),_valueObject.isError())return accumulatorSum=_valueObject,!1;accumulatorSum=accumulatorSum.plus(_valueObject),accumulatorCount=accumulatorCount.plus(NumberValueObject.create(1))})),accumulatorSum.isError())return accumulatorSum}else variant.isNull()||(accumulatorSum=accumulatorSum.plus(variant),accumulatorCount=accumulatorCount.plus(NumberValueObject.create(1)))}return accumulatorSum.divided(accumulatorCount)}constructor(...args){super(...args),this.minParams=1,this.maxParams=255}},FUNCTION_NAMES_STATISTICAL.AVERAGEA],[class Averageif extends base_function_BaseFunction{calculate(range,criteria,averageRange){if(range.isError())return range;if(criteria.isError())return criteria;if(averageRange?.isError())return averageRange;let _range=range;_range.isReferenceObject()&&(_range=_range.toArrayValueObject()),_range.isArray()||(_range=createNewArray([[_range]],1,1));let _criteria=criteria;return _criteria.isReferenceObject()&&(_criteria=_criteria.toArrayValueObject()),averageRange&&!averageRange?.isReferenceObject()?ErrorValueObject.create(error_type_ErrorType.NA):_criteria.isArray()?_criteria.map((criteriaItem=>this._handleSingleObject(_range,criteriaItem,averageRange))):this._handleSingleObject(_range,_criteria,averageRange)}_handleSingleObject(range,criteria,averageRange){let resultArrayObject=valueObjectCompare(range,criteria);resultArrayObject=filterSameValueObjectResult(resultArrayObject,range,criteria);let averageRangeArray=averageRange?this._createRangeReferenceObject(averageRange,range):range;if(!averageRangeArray)return ErrorValueObject.create(error_type_ErrorType.VALUE);if(averageRangeArray.isError())return averageRangeArray;averageRangeArray.isReferenceObject()&&(averageRangeArray=averageRangeArray.toArrayValueObject());const picked=averageRangeArray.pick(resultArrayObject),sum=picked.sum(),count=picked.count();return sum.divided(count)}_createRangeReferenceObject(averageRange,range){const averageRangeRow=averageRange.getRowCount(),averageRangeColumn=averageRange.getColumnCount(),rowCount=range.isArray()?range.getRowCount():1,columnCount=range.isArray()?range.getColumnCount():1;if(averageRangeRow===rowCount&&averageRangeColumn===columnCount)return averageRange;const{startRow,startColumn}=averageRange.getRangePosition(),rangeData={startRow,startColumn,endRow:startRow+rowCount-1,endColumn:startColumn+columnCount-1};return this.createReferenceObject(averageRange,rangeData)}constructor(...args){super(...args),this.minParams=2,this.maxParams=3,this.needsReferenceObject=!0}},FUNCTION_NAMES_STATISTICAL.AVERAGEIF],[class Averageifs extends base_function_BaseFunction{calculate(averageRange,...variants){if(averageRange.isError())return ErrorValueObject.create(error_type_ErrorType.NA);if(!averageRange.isArray())return ErrorValueObject.create(error_type_ErrorType.VALUE);if(variants.length%2!=0)return ErrorValueObject.create(error_type_ErrorType.VALUE);if(variants.some(((variant,i)=>i%2==0&&!variant.isArray())))return ErrorValueObject.create(error_type_ErrorType.VALUE);const{maxRowLength,maxColumnLength}=calculateMaxDimensions(variants),errorArray=getErrorArray(variants,averageRange,maxRowLength,maxColumnLength);if(errorArray)return errorArray;const booleanResults=getBooleanResults(variants,maxRowLength,maxColumnLength,!0);return this._aggregateResults(averageRange,booleanResults)}_aggregateResults(averageRange,booleanResults){const maxResults=booleanResults.map((row=>row.map((booleanResult=>{const picked=averageRange.pick(booleanResult),sum=picked.sum(),count=picked.count();return sum.divided(count)})))),arrayValueObjectData={calculateValueList:maxResults,rowCount:maxResults.length,columnCount:maxResults[0].length,unitId:this.unitId||"",sheetId:this.subUnitId||"",row:this.row,column:this.column};return ArrayValueObject.create(arrayValueObjectData)}constructor(...args){super(...args),this.minParams=3,this.maxParams=255}},FUNCTION_NAMES_STATISTICAL.AVERAGEIFS],[class BetaDist extends base_function_BaseFunction{calculate(x,alpha,beta,cumulative,A,B){let _A=A??NumberValueObject.create(0),_B=B??NumberValueObject.create(1);_A.isNull()&&(_A=NumberValueObject.create(0)),_B.isNull()&&(_B=NumberValueObject.create(1));const maxRowLength=Math.max(x.isArray()?x.getRowCount():1,alpha.isArray()?alpha.getRowCount():1,beta.isArray()?beta.getRowCount():1,cumulative.isArray()?cumulative.getRowCount():1,_A.isArray()?_A.getRowCount():1,_B.isArray()?_B.getRowCount():1),maxColumnLength=Math.max(x.isArray()?x.getColumnCount():1,alpha.isArray()?alpha.getColumnCount():1,beta.isArray()?beta.getColumnCount():1,cumulative.isArray()?cumulative.getColumnCount():1,_A.isArray()?_A.getColumnCount():1,_B.isArray()?_B.getColumnCount():1),xArray=expandArrayValueObject(maxRowLength,maxColumnLength,x,ErrorValueObject.create(error_type_ErrorType.NA)),alphaArray=expandArrayValueObject(maxRowLength,maxColumnLength,alpha,ErrorValueObject.create(error_type_ErrorType.NA)),betaArray=expandArrayValueObject(maxRowLength,maxColumnLength,beta,ErrorValueObject.create(error_type_ErrorType.NA)),cumulativeArray=expandArrayValueObject(maxRowLength,maxColumnLength,cumulative,ErrorValueObject.create(error_type_ErrorType.NA)),AArray=expandArrayValueObject(maxRowLength,maxColumnLength,_A,ErrorValueObject.create(error_type_ErrorType.NA)),BArray=expandArrayValueObject(maxRowLength,maxColumnLength,_B,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=xArray.mapValue(((xObject,rowIndex,columnIndex)=>{const alphaObject=alphaArray.get(rowIndex,columnIndex),betaObject=betaArray.get(rowIndex,columnIndex),cumulativeObject=cumulativeArray.get(rowIndex,columnIndex),AObject=AArray.get(rowIndex,columnIndex),BObject=BArray.get(rowIndex,columnIndex);return this._handleSignleObject(xObject,alphaObject,betaObject,cumulativeObject,AObject,BObject)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_handleSignleObject(xObject,alphaObject,betaObject,cumulativeObject,AObject,BObject){if(xObject.isError())return xObject;if(alphaObject.isError())return alphaObject;if(betaObject.isError())return betaObject;if(cumulativeObject.isError())return cumulativeObject;if(AObject.isError())return AObject;if(BObject.isError())return BObject;const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(xObject,alphaObject,betaObject,cumulativeObject,AObject,BObject);if(isError)return errorObject;const[_xObject,_alphaObject,_betaObject,_cumulativeObject,_AObject,_BObject]=variants,xValue=+_xObject.getValue(),alphaValue=+_alphaObject.getValue(),betaValue=+_betaObject.getValue(),cumulativeValue=+_cumulativeObject.getValue(),AValue=+_AObject.getValue(),BValue=+_BObject.getValue();if(alphaValue<=0||betaValue<=0||xValue<AValue||xValue>BValue||AValue===BValue)return ErrorValueObject.create(error_type_ErrorType.NUM);let result;return result=cumulativeValue?betaCDF((xValue-AValue)/(BValue-AValue),alphaValue,betaValue):function betaPDF(x,alpha,beta){return x<=0||x>=1?0:1===alpha&&1===beta?1:alpha<512&&beta<512?x**(alpha-1)*(1-x)**(beta-1)/betaFunction(alpha,beta):Math.exp((alpha-1)*Math.log(x)+(beta-1)*Math.log(1-x)-betaFunctionNaturalLogarithm(alpha,beta))}((xValue-AValue)/(BValue-AValue),alphaValue,betaValue)/(BValue-AValue),NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=4,this.maxParams=6}},FUNCTION_NAMES_STATISTICAL.BETA_DIST],[BetaInv,FUNCTION_NAMES_STATISTICAL.BETA_INV],[BinomDist,FUNCTION_NAMES_STATISTICAL.BINOM_DIST],[class BinomDistRange extends base_function_BaseFunction{calculate(trials,probabilityS,numberS,numberS2){let _numberS2=numberS2??numberS;_numberS2.isNull()&&(_numberS2=numberS);const maxRowLength=Math.max(trials.isArray()?trials.getRowCount():1,probabilityS.isArray()?probabilityS.getRowCount():1,numberS.isArray()?numberS.getRowCount():1,_numberS2.isArray()?_numberS2.getRowCount():1),maxColumnLength=Math.max(trials.isArray()?trials.getColumnCount():1,probabilityS.isArray()?probabilityS.getColumnCount():1,numberS.isArray()?numberS.getColumnCount():1,_numberS2.isArray()?_numberS2.getColumnCount():1),trialsArray=expandArrayValueObject(maxRowLength,maxColumnLength,trials,ErrorValueObject.create(error_type_ErrorType.NA)),probabilitySArray=expandArrayValueObject(maxRowLength,maxColumnLength,probabilityS,ErrorValueObject.create(error_type_ErrorType.NA)),numberSArray=expandArrayValueObject(maxRowLength,maxColumnLength,numberS,ErrorValueObject.create(error_type_ErrorType.NA)),numberS2Array=expandArrayValueObject(maxRowLength,maxColumnLength,_numberS2,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=trialsArray.mapValue(((trialsObject,rowIndex,columnIndex)=>{const probabilitySObject=probabilitySArray.get(rowIndex,columnIndex),numberSObject=numberSArray.get(rowIndex,columnIndex),numberS2Object=numberS2Array.get(rowIndex,columnIndex);return trialsObject.isError()?trialsObject:probabilitySObject.isError()?probabilitySObject:numberSObject.isError()?numberSObject:numberS2Object.isError()?numberS2Object:this._handleSignleObject(trialsObject,probabilitySObject,numberSObject,numberS2Object)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_handleSignleObject(trialsObject,probabilitySObject,numberSObject,numberS2Object){const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(trialsObject,probabilitySObject,numberSObject,numberS2Object);if(isError)return errorObject;const[_trialsObject,_probabilitySObject,_numberSObject,_numberS2Object]=variants,trialsValue=Math.floor(+_trialsObject.getValue()),probabilitySValue=+_probabilitySObject.getValue(),numberSValue=Math.floor(+_numberSObject.getValue()),numberS2Value=Math.floor(+_numberS2Object.getValue());if(trialsValue<0||probabilitySValue<0||probabilitySValue>1||numberSValue<0||numberSValue>trialsValue||numberS2Value<0||numberS2Value<numberSValue||numberS2Value>trialsValue)return ErrorValueObject.create(error_type_ErrorType.NUM);let result=0;for(let i=numberSValue;i<=numberS2Value;i++)result+=binomialPDF(i,trialsValue,probabilitySValue);return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=3,this.maxParams=4}},FUNCTION_NAMES_STATISTICAL.BINOM_DIST_RANGE],[BinomInv,FUNCTION_NAMES_STATISTICAL.BINOM_INV],[class ChisqDist extends base_function_BaseFunction{calculate(x,degFreedom,cumulative){const maxRowLength=Math.max(x.isArray()?x.getRowCount():1,degFreedom.isArray()?degFreedom.getRowCount():1,cumulative.isArray()?cumulative.getRowCount():1),maxColumnLength=Math.max(x.isArray()?x.getColumnCount():1,degFreedom.isArray()?degFreedom.getColumnCount():1,cumulative.isArray()?cumulative.getColumnCount():1),xArray=expandArrayValueObject(maxRowLength,maxColumnLength,x,ErrorValueObject.create(error_type_ErrorType.NA)),degFreedomArray=expandArrayValueObject(maxRowLength,maxColumnLength,degFreedom,ErrorValueObject.create(error_type_ErrorType.NA)),cumulativeArray=expandArrayValueObject(maxRowLength,maxColumnLength,cumulative,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=xArray.mapValue(((xObject,rowIndex,columnIndex)=>{const degFreedomObject=degFreedomArray.get(rowIndex,columnIndex),cumulativeObject=cumulativeArray.get(rowIndex,columnIndex);return xObject.isError()?xObject:degFreedomObject.isError()?degFreedomObject:cumulativeObject.isError()?cumulativeObject:this._handleSignleObject(xObject,degFreedomObject,cumulativeObject)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_handleSignleObject(xObject,degFreedomObject,cumulativeObject){const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(xObject,degFreedomObject,cumulativeObject);if(isError)return errorObject;const[_xObject,_degFreedomObject,_cumulativeObject]=variants,xValue=+_xObject.getValue(),degFreedomValue=Math.floor(+_degFreedomObject.getValue()),cumulativeValue=+_cumulativeObject.getValue();if(xValue<0||degFreedomValue<1||degFreedomValue>10**10)return ErrorValueObject.create(error_type_ErrorType.NUM);let result;return result=cumulativeValue?chisquareCDF(xValue,degFreedomValue):function chisquarePDF(x,degFreedom){return x<0?0:0===x&&2===degFreedom?.5:Math.exp((degFreedom/2-1)*Math.log(x)-x/2-degFreedom/2*Math.log(2)-gammaln(degFreedom/2))}(xValue,degFreedomValue),NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=3,this.maxParams=3}},FUNCTION_NAMES_STATISTICAL.CHISQ_DIST],[ChisqDistRt,FUNCTION_NAMES_STATISTICAL.CHISQ_DIST_RT],[class ChisqInv extends base_function_BaseFunction{calculate(probability,degFreedom){const maxRowLength=Math.max(probability.isArray()?probability.getRowCount():1,degFreedom.isArray()?degFreedom.getRowCount():1),maxColumnLength=Math.max(probability.isArray()?probability.getColumnCount():1,degFreedom.isArray()?degFreedom.getColumnCount():1),probabilityArray=expandArrayValueObject(maxRowLength,maxColumnLength,probability,ErrorValueObject.create(error_type_ErrorType.NA)),degFreedomArray=expandArrayValueObject(maxRowLength,maxColumnLength,degFreedom,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=probabilityArray.mapValue(((probabilityObject,rowIndex,columnIndex)=>{const degFreedomObject=degFreedomArray.get(rowIndex,columnIndex);return probabilityObject.isError()?probabilityObject:degFreedomObject.isError()?degFreedomObject:this._handleSignleObject(probabilityObject,degFreedomObject)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_handleSignleObject(probabilityObject,degFreedomObject){const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(probabilityObject,degFreedomObject);if(isError)return errorObject;const[_probabilityObject,_degFreedomObject]=variants,probabilityValue=+_probabilityObject.getValue(),degFreedomValue=Math.floor(+_degFreedomObject.getValue());if(probabilityValue<0||probabilityValue>1||degFreedomValue<1||degFreedomValue>10**10)return ErrorValueObject.create(error_type_ErrorType.NUM);const result=chisquareINV(probabilityValue,degFreedomValue);return Number.isNaN(result)||!Number.isFinite(result)?ErrorValueObject.create(error_type_ErrorType.NUM):NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_STATISTICAL.CHISQ_INV],[ChisqInvRt,FUNCTION_NAMES_STATISTICAL.CHISQ_INV_RT],[ChisqTest,FUNCTION_NAMES_STATISTICAL.CHISQ_TEST],[ConfidenceNorm,FUNCTION_NAMES_STATISTICAL.CONFIDENCE_NORM],[class ConfidenceT extends base_function_BaseFunction{calculate(alpha,standardDev,size){const maxRowLength=Math.max(alpha.isArray()?alpha.getRowCount():1,standardDev.isArray()?standardDev.getRowCount():1,size.isArray()?size.getRowCount():1),maxColumnLength=Math.max(alpha.isArray()?alpha.getColumnCount():1,standardDev.isArray()?standardDev.getColumnCount():1,size.isArray()?size.getColumnCount():1),alphaArray=expandArrayValueObject(maxRowLength,maxColumnLength,alpha,ErrorValueObject.create(error_type_ErrorType.NA)),standardDevArray=expandArrayValueObject(maxRowLength,maxColumnLength,standardDev,ErrorValueObject.create(error_type_ErrorType.NA)),sizeArray=expandArrayValueObject(maxRowLength,maxColumnLength,size,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=alphaArray.mapValue(((alphaObject,rowIndex,columnIndex)=>{const standardDevObject=standardDevArray.get(rowIndex,columnIndex),sizeObject=sizeArray.get(rowIndex,columnIndex);if(alphaObject.isError())return alphaObject;if(standardDevObject.isError())return standardDevObject;if(sizeObject.isError())return sizeObject;const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(alphaObject,standardDevObject,sizeObject);if(isError)return errorObject;const[_alphaObject,_standardDevObject,_sizeObject]=variants,alphaValue=+_alphaObject.getValue(),standardDevValue=+_standardDevObject.getValue(),sizeValue=Math.floor(+_sizeObject.getValue());if(alphaValue<=0||alphaValue>=1||standardDevValue<=0||sizeValue<1)return ErrorValueObject.create(error_type_ErrorType.NUM);if(1===sizeValue)return ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO);const result=Math.abs(studentTINV(alphaValue/2,sizeValue-1)*standardDevValue/Math.sqrt(sizeValue));return NumberValueObject.create(result)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}constructor(...args){super(...args),this.minParams=3,this.maxParams=3}},FUNCTION_NAMES_STATISTICAL.CONFIDENCE_T],[class Correl extends base_function_BaseFunction{calculate(array1,array2){const array1RowCount=array1.isArray()?array1.getRowCount():1,array1ColumnCount=array1.isArray()?array1.getColumnCount():1,array2RowCount=array2.isArray()?array2.getRowCount():1,array2ColumnCount=array2.isArray()?array2.getColumnCount():1;let _array1=array1;if(array1.isArray()&&1===array1RowCount&&1===array1ColumnCount&&(_array1=array1.get(0,0)),_array1.isError())return _array1;let _array2=array2;if(array2.isArray()&&1===array2RowCount&&1===array2ColumnCount&&(_array2=array2.get(0,0)),_array2.isError())return _array2;if(array1RowCount*array1ColumnCount==1||array2RowCount*array2ColumnCount==1)return _array1.isNull()||_array2.isNull()?ErrorValueObject.create(error_type_ErrorType.VALUE):ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO);if(array1RowCount*array1ColumnCount!=array2RowCount*array2ColumnCount)return ErrorValueObject.create(error_type_ErrorType.NA);const{isError,errorObject,array1Values,array2Values,noCalculate}=getTwoArrayNumberValues(array1,array2,array1RowCount*array1ColumnCount,array1ColumnCount,array2ColumnCount);return isError?errorObject:noCalculate?ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO):this._getResult(array1Values,array2Values)}_getResult(array1Values,array2Values){const n=array1Values.length;let array1Sum=0,array2Sum=0;for(let i=0;i<n;i++)array1Sum+=array1Values[i],array2Sum+=array2Values[i];const array1Mean=array1Sum/n,array2Mean=array2Sum/n;let numerator=0,array1DiffSum=0,array2DiffSum=0;for(let i=0;i<n;i++){const array1Diff=array1Values[i]-array1Mean,array2Diff=array2Values[i]-array2Mean;numerator+=array1Diff*array2Diff,array1DiffSum+=array1Diff**2,array2DiffSum+=array2Diff**2}const denominator=Math.sqrt(array1DiffSum*array2DiffSum);return 0===denominator?ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO):NumberValueObject.create(numerator/denominator)}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_STATISTICAL.CORREL],[class Count extends base_function_BaseFunction{calculate(...variants){let accumulatorAll=NumberValueObject.create(0);for(let i=0;i<variants.length;i++){const variant=variants[i];variant.isError()||(variant.isArray()?accumulatorAll=accumulatorAll.plus(variant.count()):variant.isString()?variant.convertToNumberObjectValue().isError()||(accumulatorAll=accumulatorAll.plus(NumberValueObject.create(1))):variant.isNull()||(accumulatorAll=accumulatorAll.plus(NumberValueObject.create(1))))}return accumulatorAll}constructor(...args){super(...args),this.minParams=1,this.maxParams=255}},FUNCTION_NAMES_STATISTICAL.COUNT],[class Counta extends base_function_BaseFunction{calculate(...variants){let accumulatorAll=NumberValueObject.create(0);for(let i=0;i<variants.length;i++){let variant=variants[i];variant.isError()?accumulatorAll=accumulatorAll.plus(NumberValueObject.create(1)):variant.isArray()?(variant=variant.countA(),accumulatorAll=accumulatorAll.plus(variant)):variant.isNull()||(accumulatorAll=accumulatorAll.plus(NumberValueObject.create(1)))}return accumulatorAll}constructor(...args){super(...args),this.minParams=1,this.maxParams=255}},FUNCTION_NAMES_STATISTICAL.COUNTA],[class Countblank extends base_function_BaseFunction{calculate(variant){return variant.isError()?variant:""===variant.getValue()||variant.isNull()?NumberValueObject.create(1):variant.isArray()?variant.countBlank():NumberValueObject.create(0)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_STATISTICAL.COUNTBLANK],[class Countif extends base_function_BaseFunction{calculate(range,criteria){return range.isError()||criteria.isError()?ErrorValueObject.create(error_type_ErrorType.NA):range.isArray()?criteria.isArray()?criteria.mapValue((criteriaItem=>this._handleSingleObject(range,criteriaItem))):this._handleSingleObject(range,criteria):ErrorValueObject.create(error_type_ErrorType.VALUE)}_handleSingleObject(range,criteria){let resultArrayObject=valueObjectCompare(range,criteria);resultArrayObject=filterSameValueObjectResult(resultArrayObject,range,criteria);const picked=range.pick(resultArrayObject);return this._countA(picked)}_countA(array){let accumulatorAll=NumberValueObject.create(0);return array.iterator((valueObject=>{if(null==valueObject)return!0;accumulatorAll=accumulatorAll.plusBy(1)})),accumulatorAll}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_STATISTICAL.COUNTIF],[class Countifs extends base_function_BaseFunction{calculate(...variants){if(variants.length%2!=0)return ErrorValueObject.create(error_type_ErrorType.VALUE);if(variants.some(((variant,i)=>i%2==0&&!variant.isArray())))return ErrorValueObject.create(error_type_ErrorType.VALUE);const{maxRowLength,maxColumnLength}=calculateMaxDimensions(variants),errorArray=getErrorArray(variants,variants[0],maxRowLength,maxColumnLength);if(errorArray)return errorArray;const booleanResults=getBooleanResults(variants,maxRowLength,maxColumnLength,!0);return this._aggregateResults(booleanResults)}_aggregateResults(booleanResults){const maxResults=booleanResults.map((row=>row.map((booleanResult=>function countTrueValue(array){let count=0;return array.iterator((value=>{value?.isBoolean()&&!0===value.getValue()&&count++})),NumberValueObject.create(count)}(booleanResult))))),arrayValueObjectData={calculateValueList:maxResults,rowCount:maxResults.length,columnCount:maxResults[0].length,unitId:this.unitId||"",sheetId:this.subUnitId||"",row:this.row,column:this.column};return ArrayValueObject.create(arrayValueObjectData)}constructor(...args){super(...args),this.minParams=2,this.maxParams=255}},FUNCTION_NAMES_STATISTICAL.COUNTIFS],[CovarianceP,FUNCTION_NAMES_STATISTICAL.COVARIANCE_P],[class CovarianceS extends base_function_BaseFunction{calculate(array1,array2){const array1RowCount=array1.isArray()?array1.getRowCount():1,array1ColumnCount=array1.isArray()?array1.getColumnCount():1,array2RowCount=array2.isArray()?array2.getRowCount():1,array2ColumnCount=array2.isArray()?array2.getColumnCount():1;let _array1=array1;if(array1.isArray()&&1===array1RowCount&&1===array1ColumnCount&&(_array1=array1.get(0,0)),_array1.isError())return _array1;let _array2=array2;if(array2.isArray()&&1===array2RowCount&&1===array2ColumnCount&&(_array2=array2.get(0,0)),_array2.isError())return _array2;if((array1RowCount*array1ColumnCount==1||array2RowCount*array2ColumnCount==1)&&(_array1.isNull()||_array2.isNull()))return ErrorValueObject.create(error_type_ErrorType.VALUE);if(array1RowCount*array1ColumnCount!=array2RowCount*array2ColumnCount)return ErrorValueObject.create(error_type_ErrorType.NA);const{isError,errorObject,array1Values,array2Values,noCalculate}=getTwoArrayNumberValues(array1,array2,array1RowCount*array1ColumnCount,array1ColumnCount,array2ColumnCount);return isError?errorObject:noCalculate?ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO):this._getResult(array1Values,array2Values)}_getResult(array1Values,array2Values){if(array1Values.length<=1)return ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO);const n=array1Values.length;let array1Sum=0,array2Sum=0;for(let i=0;i<n;i++)array1Sum+=array1Values[i],array2Sum+=array2Values[i];const array1Mean=array1Sum/n,array2Mean=array2Sum/n;let numerator=0;for(let i=0;i<n;i++){numerator+=(array1Values[i]-array1Mean)*(array2Values[i]-array2Mean)}return NumberValueObject.create(numerator/(n-1))}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_STATISTICAL.COVARIANCE_S],[class Devsq extends base_function_BaseFunction{calculate(...variants){const values=[];let sum=0,noCalculate=!0;for(let i=0;i<variants.length;i++){const variant=variants[i];if(variant.isArray()){let isError=!1,errorObject=ErrorValueObject.create(error_type_ErrorType.VALUE);if(variant.iterator((valueObject=>{const _valueObject=this._handleSingleObject(valueObject);if(_valueObject.isError())return isError=!0,errorObject=_valueObject,!1;if(_valueObject.isNull())return!0;const value=_valueObject.getValue();values.push(value),sum+=value,noCalculate=!1})),isError)return errorObject}else{const _variant=this._handleSingleObject(variant);if(_variant.isError())return _variant;if(_variant.isNull())continue;const value=_variant.getValue();values.push(value),sum+=value,noCalculate=!1}}if(noCalculate)return ErrorValueObject.create(error_type_ErrorType.NUM);const mean=sum/values.length;let result=0;for(let i=0;i<values.length;i++)result+=(values[i]-mean)**2;return NumberValueObject.create(result)}_handleSingleObject(variant){if(variant.isError())return variant;if(variant.isNull()||variant.isBoolean())return NullValueObject.create();const value=variant.getValue();return(0,src.DMQ)(value)?NumberValueObject.create(+value):NullValueObject.create()}constructor(...args){super(...args),this.minParams=1,this.maxParams=255}},FUNCTION_NAMES_STATISTICAL.DEVSQ],[ExponDist,FUNCTION_NAMES_STATISTICAL.EXPON_DIST],[class FDist extends base_function_BaseFunction{calculate(x,degFreedom1,degFreedom2,cumulative){const maxRowLength=Math.max(x.isArray()?x.getRowCount():1,degFreedom1.isArray()?degFreedom1.getRowCount():1,degFreedom2.isArray()?degFreedom2.getRowCount():1,cumulative.isArray()?cumulative.getRowCount():1),maxColumnLength=Math.max(x.isArray()?x.getColumnCount():1,degFreedom1.isArray()?degFreedom1.getColumnCount():1,degFreedom2.isArray()?degFreedom2.getColumnCount():1,cumulative.isArray()?cumulative.getColumnCount():1),xArray=expandArrayValueObject(maxRowLength,maxColumnLength,x,ErrorValueObject.create(error_type_ErrorType.NA)),degFreedom1Array=expandArrayValueObject(maxRowLength,maxColumnLength,degFreedom1,ErrorValueObject.create(error_type_ErrorType.NA)),degFreedom2Array=expandArrayValueObject(maxRowLength,maxColumnLength,degFreedom2,ErrorValueObject.create(error_type_ErrorType.NA)),cumulativeArray=expandArrayValueObject(maxRowLength,maxColumnLength,cumulative,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=xArray.mapValue(((xObject,rowIndex,columnIndex)=>{const degFreedom1Object=degFreedom1Array.get(rowIndex,columnIndex),degFreedom2Object=degFreedom2Array.get(rowIndex,columnIndex),cumulativeObject=cumulativeArray.get(rowIndex,columnIndex);return xObject.isError()?xObject:degFreedom1Object.isError()?degFreedom1Object:degFreedom2Object.isError()?degFreedom2Object:cumulativeObject.isError()?cumulativeObject:this._handleSignleObject(xObject,degFreedom1Object,degFreedom2Object,cumulativeObject)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_handleSignleObject(xObject,degFreedom1Object,degFreedom2Object,cumulativeObject){const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(xObject,degFreedom1Object,degFreedom2Object,cumulativeObject);if(isError)return errorObject;const[_xObject,_degFreedom1Object,_degFreedom2Object,_cumulativeObject]=variants,xValue=+_xObject.getValue(),degFreedom1Value=Math.floor(+_degFreedom1Object.getValue()),degFreedom2Value=Math.floor(+_degFreedom2Object.getValue()),cumulativeValue=+_cumulativeObject.getValue();if(xValue<0||degFreedom1Value<1||degFreedom1Value>10**10||degFreedom2Value<1||degFreedom2Value>10**10)return ErrorValueObject.create(error_type_ErrorType.NUM);let result;return result=cumulativeValue?centralFCDF(xValue,degFreedom1Value,degFreedom2Value):function centralFPDF(x,degFreedom1,degFreedom2){if(x<0)return 0;if(0===x&&degFreedom1<2)return 1/0;if(0===x&&2===degFreedom1)return 1;let result=1/betaFunction(degFreedom1/2,degFreedom2/2);return result*=(degFreedom1/degFreedom2)**(degFreedom1/2),result*=x**(degFreedom1/2-1),result*=(1+degFreedom1/degFreedom2*x)**(-(degFreedom1+degFreedom2)/2),result}(xValue,degFreedom1Value,degFreedom2Value),Number.isNaN(result)||!Number.isFinite(result)?ErrorValueObject.create(error_type_ErrorType.NUM):NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=4,this.maxParams=4}},FUNCTION_NAMES_STATISTICAL.F_DIST],[FDistRt,FUNCTION_NAMES_STATISTICAL.F_DIST_RT],[class FInv extends base_function_BaseFunction{calculate(probability,degFreedom1,degFreedom2){const maxRowLength=Math.max(probability.isArray()?probability.getRowCount():1,degFreedom1.isArray()?degFreedom1.getRowCount():1,degFreedom2.isArray()?degFreedom2.getRowCount():1),maxColumnLength=Math.max(probability.isArray()?probability.getColumnCount():1,degFreedom1.isArray()?degFreedom1.getColumnCount():1,degFreedom2.isArray()?degFreedom2.getColumnCount():1),probabilityArray=expandArrayValueObject(maxRowLength,maxColumnLength,probability,ErrorValueObject.create(error_type_ErrorType.NA)),degFreedom1Array=expandArrayValueObject(maxRowLength,maxColumnLength,degFreedom1,ErrorValueObject.create(error_type_ErrorType.NA)),degFreedom2Array=expandArrayValueObject(maxRowLength,maxColumnLength,degFreedom2,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=probabilityArray.mapValue(((probabilityObject,rowIndex,columnIndex)=>{const degFreedom1Object=degFreedom1Array.get(rowIndex,columnIndex),degFreedom2Object=degFreedom2Array.get(rowIndex,columnIndex);return probabilityObject.isError()?probabilityObject:degFreedom1Object.isError()?degFreedom1Object:degFreedom2Object.isError()?degFreedom2Object:this._handleSignleObject(probabilityObject,degFreedom1Object,degFreedom2Object)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_handleSignleObject(probabilityObject,degFreedom1Object,degFreedom2Object){const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(probabilityObject,degFreedom1Object,degFreedom2Object);if(isError)return errorObject;const[_probabilityObject,_degFreedom1Object,_degFreedom2Object]=variants,probabilityValue=+_probabilityObject.getValue(),degFreedom1Value=Math.floor(+_degFreedom1Object.getValue()),degFreedom2Value=Math.floor(+_degFreedom2Object.getValue());if(probabilityValue<0||probabilityValue>1||degFreedom1Value<1||degFreedom1Value>10**10||degFreedom2Value<1||degFreedom2Value>10**10)return ErrorValueObject.create(error_type_ErrorType.NUM);const result=centralFINV(probabilityValue,degFreedom1Value,degFreedom2Value);return Number.isNaN(result)||!Number.isFinite(result)?ErrorValueObject.create(error_type_ErrorType.NUM):NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=3,this.maxParams=3}},FUNCTION_NAMES_STATISTICAL.F_INV],[FInvRt,FUNCTION_NAMES_STATISTICAL.F_INV_RT],[FTest,FUNCTION_NAMES_STATISTICAL.F_TEST],[class Fisher extends base_function_BaseFunction{calculate(x){return x.isArray()?x.mapValue((xObject=>this._handleSingleObject(xObject))):this._handleSingleObject(x)}_handleSingleObject(x){const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(x);if(isError)return errorObject;const[xObject]=variants,xValue=xObject.getValue();if(xValue<=-1||xValue>=1)return ErrorValueObject.create(error_type_ErrorType.NUM);const result=Math.log((1+xValue)/(1-xValue))/2;return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_STATISTICAL.FISHER],[class Fisherinv extends base_function_BaseFunction{calculate(y){return y.isArray()?y.mapValue((yObject=>this._handleSingleObject(yObject))):this._handleSingleObject(y)}_handleSingleObject(y){const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(y);if(isError)return errorObject;const[yObject]=variants,yValue=+yObject.getValue(),num=Math.exp(2*yValue)-1,den=Math.exp(2*yValue)+1;return!Number.isFinite(num)&&num>0&&!Number.isFinite(den)&&den>0?NumberValueObject.create(1):NumberValueObject.create(num/den)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_STATISTICAL.FISHERINV],[Forecast,FUNCTION_NAMES_STATISTICAL.FORECAST],[Forecast,FUNCTION_NAMES_STATISTICAL.FORECAST_LINEAR],[class Frequency extends base_function_BaseFunction{calculate(dataArray,binsArray){const{isError,errorObject,values:dataArrayValues}=this._getValues(dataArray);if(isError)return errorObject;if(dataArray.isNull()||binsArray.isNull())return ErrorValueObject.create(error_type_ErrorType.VALUE);let{values:binsArrayValues}=this._getValues(binsArray,!0);0===binsArrayValues.length&&(binsArrayValues=[0]);const newBinsArrayValues=this._getNewBinsArrayValues(binsArrayValues),result=new Array(newBinsArrayValues.length).fill(0);for(let i=0;i<dataArrayValues.length;i++){const value=dataArrayValues[i];result[newBinsArrayValues.findIndex((item=>value>item.start&&value<=item.end))]++}return ArrayValueObject.createByArray(result.map((item=>[item])))}_getValues(array,isIgnoreError=!1){const values=[],arrayRowCount=array.isArray()?array.getRowCount():1,arrayColumnCount=array.isArray()?array.getColumnCount():1;for(let r=0;r<arrayRowCount;r++)for(let c=0;c<arrayColumnCount;c++){const valueObject=array.isArray()?array.get(r,c):array;if(valueObject.isError()){if(!isIgnoreError)return{isError:!0,errorObject:valueObject,values};continue}if(valueObject.isNull()||valueObject.isBoolean())continue;const value=valueObject.getValue();(0,src.DMQ)(value)&&values.push(+value)}return{isError:!1,errorObject:null,values}}_getNewBinsArrayValues(binsArrayValues){const _binsArrayValues=binsArrayValues.map(((value,index)=>({value,index}))).sort(((a,b)=>a.value-b.value)),newBinsArrayValues=[];for(let i=0;i<_binsArrayValues.length;i++){const index=_binsArrayValues[i].index;0!==i?newBinsArrayValues[index]={start:_binsArrayValues[i-1].value,end:_binsArrayValues[i].value}:newBinsArrayValues[index]={start:-1/0,end:_binsArrayValues[i].value}}return newBinsArrayValues.push({start:_binsArrayValues[_binsArrayValues.length-1].value,end:1/0}),newBinsArrayValues}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_STATISTICAL.FREQUENCY],[class Gamma extends base_function_BaseFunction{calculate(number){if(number.isArray()){const resultArray=number.mapValue((numberObject=>this._handleSingleObject(numberObject)));return 1===resultArray.getRowCount()&&1===resultArray.getColumnCount()?resultArray.get(0,0):resultArray}return this._handleSingleObject(number)}_handleSingleObject(number){const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(number);if(isError)return errorObject;const[numberObject]=variants,numberValue=+numberObject.getValue();if(0===numberValue||numberValue<0&&numberValue%1==0)return ErrorValueObject.create(error_type_ErrorType.NUM);const result=gamma(numberValue);return Number.isNaN(result)||!Number.isFinite(result)?ErrorValueObject.create(error_type_ErrorType.NUM):NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_STATISTICAL.GAMMA],[GammaDist,FUNCTION_NAMES_STATISTICAL.GAMMA_DIST],[GammaInv,FUNCTION_NAMES_STATISTICAL.GAMMA_INV],[Gammaln,FUNCTION_NAMES_STATISTICAL.GAMMALN],[Gammaln,FUNCTION_NAMES_STATISTICAL.GAMMALN_PRECISE],[class Gauss extends base_function_BaseFunction{calculate(z){if(z.isArray()){const resultArray=z.mapValue((zObject=>this._handleSingleObject(zObject)));return 1===resultArray.getRowCount()&&1===resultArray.getColumnCount()?resultArray.get(0,0):resultArray}return this._handleSingleObject(z)}_handleSingleObject(z){const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(z);if(isError)return errorObject;const[zObject]=variants,result=normalCDF(+zObject.getValue(),0,1)-.5;return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_STATISTICAL.GAUSS],[class Geomean extends base_function_BaseFunction{calculate(...variants){let sum=1,len=0,isNonPositive=!1;for(let i=0;i<variants.length;i++){const variant=variants[i];if(variant.isArray()){let isError=!1,errorObject=ErrorValueObject.create(error_type_ErrorType.VALUE);if(variant.iterator((valueObject=>{if(valueObject?.isError())return isError=!0,errorObject=valueObject,!1;if(valueObject?.isNull()||valueObject?.isBoolean())return!0;const value=valueObject.getValue();if(!(0,src.DMQ)(value))return!0;+value<=0&&(isNonPositive=!0),sum*=+value,len++})),isError)return errorObject}else{if(variant.isError())return variant;if(variant.isString()){const _variant=variant.convertToNumberObjectValue();if(_variant.isError())return _variant}if(variant.isNull()||variant.isBoolean())continue;const value=variant.getValue();if(!(0,src.DMQ)(value))continue;+value<=0&&(isNonPositive=!0),sum*=+value,len++}}if(0===len||isNonPositive)return ErrorValueObject.create(error_type_ErrorType.NUM);const result=sum**(1/len);return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=255}},FUNCTION_NAMES_STATISTICAL.GEOMEAN],[class Growth extends base_function_BaseFunction{calculate(knownYs,knownXs,newXs,constb){const{isError,errorObject}=checkKnownsArrayDimensions(knownYs,knownXs,newXs);if(isError)return errorObject;const knownYsValues=getKnownsArrayValues(knownYs);if(knownYsValues instanceof ErrorValueObject)return knownYsValues;const knownXsValues=this._getKnownXsValues(knownYsValues,knownXs);if(knownXsValues instanceof ErrorValueObject)return knownXsValues;const newXsValues=this._getNewXsValues(knownXsValues,newXs);if(newXsValues instanceof ErrorValueObject)return newXsValues;let _constb=constb??BooleanValueObject.create(!0);if(_constb.isArray()&&(_constb=_constb.get(0,0)),_constb.isString()&&(_constb=_constb.convertToNumberObjectValue()),_constb.isError())return _constb;const constbValue=+_constb.getValue();return this._getResult(knownYsValues,knownXsValues,newXsValues,constbValue)}_getResult(knownYsValues,knownXsValues,newXsValues,constb){if(1===knownYsValues.length&&knownXsValues.length>1||1===knownYsValues[0].length&&knownXsValues[0].length>1){if(1===knownYsValues.length&&knownXsValues.length>1){if((constb?knownXsValues.length+1:knownXsValues.length)>knownYsValues[0].length)return ErrorValueObject.create(error_type_ErrorType.NA)}if(1===knownYsValues[0].length&&knownXsValues[0].length>1){if((constb?knownXsValues[0].length+1:knownXsValues[0].length)>knownYsValues.length)return ErrorValueObject.create(error_type_ErrorType.NA)}return this._getResultByMultipleVariables(knownYsValues,knownXsValues,newXsValues,constb)}return this._getResultBySimpleVariables(knownYsValues,knownXsValues,newXsValues,constb)}_getResultByMultipleVariables(knownYsValues,knownXsValues,newXsValues,constb){const isOneRow=1===knownYsValues.length&&knownYsValues[0].length>1,_coefficients=getKnownsArrayCoefficients(knownYsValues,knownXsValues,newXsValues,constb,!0);if(_coefficients instanceof ErrorValueObject)return _coefficients;const{coefficients,newX}=_coefficients,cl=coefficients[0].length,b=coefficients[0][cl-1];let result=[];for(let i=0;i<newX.length;i++){result[i]=[];let value=b;for(let j=cl-2;j>=0;j--)value*=coefficients[0][cl-2-j]**newX[i][j];result[i].push(value)}return isOneRow&&(result=matrixTranspose(result)),ArrayValueObject.createByArray(result)}_getResultBySimpleVariables(knownYsValues,knownXsValues,newXsValues,constb){const knownYsValuesFlat=knownYsValues.flat(),knownXsValuesFlat=knownXsValues.flat(),{slope,intercept}=getSlopeAndIntercept(knownXsValuesFlat,knownYsValuesFlat,constb,!0),result=newXsValues.map((row=>row.map((value=>intercept*slope**value))));return ArrayValueObject.createByArray(result)}_getKnownXsValues(knownYsValues,knownXs){return!knownXs||knownXs.isNull()?getSerialNumbersByRowsColumns(knownYsValues.length,knownYsValues[0].length):getKnownsArrayValues(knownXs)}_getNewXsValues(knownXsValues,newXs){return!newXs||newXs.isNull()?knownXsValues:getKnownsArrayValues(newXs)}constructor(...args){super(...args),this.minParams=1,this.maxParams=4}},FUNCTION_NAMES_STATISTICAL.GROWTH],[class Harmean extends base_function_BaseFunction{calculate(...variants){let sum=0,len=0,isNonPositive=!1;for(let i=0;i<variants.length;i++){const variant=variants[i];if(variant.isArray()){let isError=!1,errorObject=ErrorValueObject.create(error_type_ErrorType.VALUE);if(variant.iterator((valueObject=>{if(valueObject?.isError())return isError=!0,errorObject=valueObject,!1;if(valueObject?.isNull()||valueObject?.isBoolean())return!0;const value=valueObject.getValue();if(!(0,src.DMQ)(value))return!0;+value<=0&&(isNonPositive=!0),sum+=1/+value,len++})),isError)return errorObject}else{if(variant.isError())return variant;if(variant.isString()){const _variant=variant.convertToNumberObjectValue();if(_variant.isError())return _variant}if(variant.isNull()||variant.isBoolean())continue;const value=variant.getValue();if(!(0,src.DMQ)(value))continue;+value<=0&&(isNonPositive=!0),sum+=1/+value,len++}}if(0===len)return ErrorValueObject.create(error_type_ErrorType.NA);if(isNonPositive)return ErrorValueObject.create(error_type_ErrorType.NUM);const result=len/sum;return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=255}},FUNCTION_NAMES_STATISTICAL.HARMEAN],[class HypgeomDist extends base_function_BaseFunction{calculate(sampleS,numberSample,populationS,numberPop,cumulative){const maxRowLength=Math.max(sampleS.isArray()?sampleS.getRowCount():1,numberSample.isArray()?numberSample.getRowCount():1,populationS.isArray()?populationS.getRowCount():1,numberPop.isArray()?numberPop.getRowCount():1,cumulative.isArray()?cumulative.getRowCount():1),maxColumnLength=Math.max(sampleS.isArray()?sampleS.getColumnCount():1,numberSample.isArray()?numberSample.getColumnCount():1,populationS.isArray()?populationS.getColumnCount():1,numberPop.isArray()?numberPop.getColumnCount():1,cumulative.isArray()?cumulative.getColumnCount():1),sampleSArray=expandArrayValueObject(maxRowLength,maxColumnLength,sampleS,ErrorValueObject.create(error_type_ErrorType.NA)),numberSampleArray=expandArrayValueObject(maxRowLength,maxColumnLength,numberSample,ErrorValueObject.create(error_type_ErrorType.NA)),populationSArray=expandArrayValueObject(maxRowLength,maxColumnLength,populationS,ErrorValueObject.create(error_type_ErrorType.NA)),numberPopArray=expandArrayValueObject(maxRowLength,maxColumnLength,numberPop,ErrorValueObject.create(error_type_ErrorType.NA)),cumulativeArray=expandArrayValueObject(maxRowLength,maxColumnLength,cumulative,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=sampleSArray.mapValue(((sampleSObject,rowIndex,columnIndex)=>{const numberSampleObject=numberSampleArray.get(rowIndex,columnIndex),populationSObject=populationSArray.get(rowIndex,columnIndex),numberPopObject=numberPopArray.get(rowIndex,columnIndex),cumulativeObject=cumulativeArray.get(rowIndex,columnIndex);return sampleSObject.isError()?sampleSObject:numberSampleObject.isError()?numberSampleObject:populationSObject.isError()?populationSObject:numberPopObject.isError()?numberPopObject:cumulativeObject.isError()?cumulativeObject:this._handleSignleObject(sampleSObject,numberSampleObject,populationSObject,numberPopObject,cumulativeObject)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_handleSignleObject(sampleSObject,numberSampleObject,populationSObject,numberPopObject,cumulativeObject){const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(sampleSObject,numberSampleObject,populationSObject,numberPopObject,cumulativeObject);if(isError)return errorObject;const[_sampleSObject,_numberSampleObject,_populationSObject,_numberPopObject,_cumulativeObject]=variants,sampleSValue=Math.floor(+_sampleSObject.getValue()),numberSampleValue=Math.floor(+_numberSampleObject.getValue()),populationSValue=Math.floor(+_populationSObject.getValue()),numberPopValue=Math.floor(+_numberPopObject.getValue()),cumulativeValue=+_cumulativeObject.getValue();if(sampleSValue<0||sampleSValue>numberSampleValue||sampleSValue>populationSValue||sampleSValue<numberSampleValue-numberPopValue+populationSValue||numberSampleValue<=0||numberSampleValue>numberPopValue||populationSValue<=0||populationSValue>numberPopValue||numberPopValue<=0)return ErrorValueObject.create(error_type_ErrorType.NUM);let result;return result=cumulativeValue?function hypergeometricCDF(x,n,M,N){let result=0;for(let i=0;i<=x;i++)result+=hypergeometricPDF(i,n,M,N);return result}(sampleSValue,numberSampleValue,populationSValue,numberPopValue):hypergeometricPDF(sampleSValue,numberSampleValue,populationSValue,numberPopValue),Number.isNaN(result)&&(result=0),NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=5,this.maxParams=5}},FUNCTION_NAMES_STATISTICAL.HYPGEOM_DIST],[class Intercept extends base_function_BaseFunction{calculate(knownYs,knownXs){const knownYsRowCount=knownYs.isArray()?knownYs.getRowCount():1,knownYsColumnCount=knownYs.isArray()?knownYs.getColumnCount():1,knownXsRowCount=knownXs.isArray()?knownXs.getRowCount():1,knownXsColumnCount=knownXs.isArray()?knownXs.getColumnCount():1;let _knownYs=knownYs;if(knownYs.isArray()&&1===knownYsRowCount&&1===knownYsColumnCount&&(_knownYs=knownYs.get(0,0)),_knownYs.isError())return _knownYs;let _knownXs=knownXs;if(knownXs.isArray()&&1===knownXsRowCount&&1===knownXsColumnCount&&(_knownXs=knownXs.get(0,0)),_knownXs.isError())return _knownXs;if(knownYsRowCount*knownYsColumnCount==1||knownXsRowCount*knownXsColumnCount==1)return _knownYs.isNull()||_knownXs.isNull()?ErrorValueObject.create(error_type_ErrorType.VALUE):ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO);if(knownYsRowCount*knownYsColumnCount!=knownXsRowCount*knownXsColumnCount)return ErrorValueObject.create(error_type_ErrorType.NA);const{isError,errorObject,array1Values,array2Values,noCalculate}=getTwoArrayNumberValues(knownYs,knownXs,knownYsRowCount*knownYsColumnCount,knownYsColumnCount,knownXsColumnCount);return isError?errorObject:noCalculate?ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO):this._getResult(array1Values,array2Values)}_getResult(knownYs,knownXs){const result=forecastLinear(0,knownYs,knownXs);return Number.isFinite(result)?NumberValueObject.create(result):ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO)}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_STATISTICAL.INTERCEPT],[class Kurt extends base_function_BaseFunction{calculate(...variants){const values=[];let sum=0;for(let i=0;i<variants.length;i++){const variant=variants[i];if(variant.isError())return variant;if(variant.isString()){const _variant=variant.convertToNumberObjectValue();if(_variant.isError())return _variant}const rowCount=variant.isArray()?variant.getRowCount():1,columnCount=variant.isArray()?variant.getColumnCount():1;for(let r=0;r<rowCount;r++)for(let c=0;c<columnCount;c++){const valueObject=variant.isArray()?variant.get(r,c):variant;if(valueObject.isError())return valueObject;if(valueObject.isNull()||valueObject.isBoolean())continue;const value=valueObject.getValue();(0,src.DMQ)(value)&&(values.push(+value),sum+=+value)}}return values.length<=3?ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO):this._getResult(values,sum)}_getResult(values,sum){const n=values.length,mean=sum/n;let sum2=0;for(let i=0;i<n;i++)sum2+=(values[i]-mean)**2;const stdev=Math.sqrt(sum2/(n-1));if(0===stdev)return ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO);let sum3=0;for(let i=0;i<n;i++)sum3+=((values[i]-mean)/stdev)**4;const result=n*(n+1)/((n-1)*(n-2)*(n-3))*sum3-3*(n-1)**2/((n-2)*(n-3));return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=255}},FUNCTION_NAMES_STATISTICAL.KURT],[class Large extends base_function_BaseFunction{calculate(array,k){const arrayValues=this._getValues(array);if(k.isArray()){const resultArray=k.mapValue((kObject=>this._handleSingleObject(arrayValues,kObject)));return 1===resultArray.getRowCount()&&1===resultArray.getColumnCount()?resultArray.get(0,0):resultArray}return this._handleSingleObject(arrayValues,k)}_handleSingleObject(array,k){if(array instanceof ErrorValueObject)return array;const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(k);if(isError)return errorObject;const[kObject]=variants;let kValue=+kObject.getValue();return kValue<1||kValue>array.length?ErrorValueObject.create(error_type_ErrorType.NUM):(kValue=Math.ceil(kValue),NumberValueObject.create(array[kValue-1]))}_getValues(array){const rowCount=array.isArray()?array.getRowCount():1,columnCount=array.isArray()?array.getColumnCount():1,values=[];for(let r=0;r<rowCount;r++)for(let c=0;c<columnCount;c++){const valueObject=array.isArray()?array.get(r,c):array;if(valueObject.isError())return valueObject;if(valueObject.isNull()||valueObject.isBoolean()||valueObject.isString())continue;const value=valueObject.getValue();(0,src.DMQ)(value)&&values.push(+value)}return 0===values.length?ErrorValueObject.create(error_type_ErrorType.NUM):values.sort(((a,b)=>b-a))}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_STATISTICAL.LARGE],[class Linest extends base_function_BaseFunction{calculate(knownYs,knownXs,constb,stats){const{isError,errorObject}=checkKnownsArrayDimensions(knownYs,knownXs);if(isError)return errorObject;const knownYsValues=getKnownsArrayValues(knownYs);if(knownYsValues instanceof ErrorValueObject)return knownYsValues;const knownXsValues=this._getKnownXsValues(knownYsValues,knownXs);if(knownXsValues instanceof ErrorValueObject)return knownXsValues;let _constb=constb??BooleanValueObject.create(!0);_constb.isArray()&&(_constb=_constb.get(0,0));let _stats=stats??BooleanValueObject.create(!1);_stats.isArray()&&(_stats=_stats.get(0,0));const{isError:_isError,errorObject:_errorObject,variants}=checkVariantsErrorIsStringToNumber(_constb,_stats);if(_isError)return _errorObject;const[constbObject,statsObject]=variants;return this._getResult(knownYsValues,knownXsValues,+constbObject.getValue(),+statsObject.getValue())}_getResult(knownYsValues,knownXsValues,constb,stats){if(1===knownYsValues.length&&knownXsValues.length>1||1===knownYsValues[0].length&&knownXsValues[0].length>1){if(1===knownYsValues.length&&knownXsValues.length>1){if((constb?knownXsValues.length+1:knownXsValues.length)>knownYsValues[0].length)return ErrorValueObject.create(error_type_ErrorType.NA)}if(1===knownYsValues[0].length&&knownXsValues[0].length>1){if((constb?knownXsValues[0].length+1:knownXsValues[0].length)>knownYsValues.length)return ErrorValueObject.create(error_type_ErrorType.NA)}return this._getResultByMultipleVariables(knownYsValues,knownXsValues,constb,stats)}return this._getResultBySimpleVariables(knownYsValues,knownXsValues,constb,stats)}_getResultByMultipleVariables(knownYsValues,knownXsValues,constb,stats){const _coefficients=getKnownsArrayCoefficients(knownYsValues,knownXsValues,knownXsValues,constb,!1);if(_coefficients instanceof ErrorValueObject)return _coefficients;const{coefficients,X,XTXInverse}=_coefficients;let result=[];if(stats){const _knownYsValues=knownYsValues.flat(),n=_knownYsValues.length,meanY=constb?_knownYsValues.reduce(((acc,value)=>acc+value),0)/n:0,k=XTXInverse.length,df=n-k,cl=coefficients[0].length,fillNa=new Array(cl-2).fill(error_type_ErrorType.NA),b=coefficients[0][cl-1],newY=[];for(let i=0;i<X.length;i++){let value=b;for(let j=cl-2;j>=0;j--)value+=coefficients[0][cl-2-j]*X[i][j];newY.push(value)}let sstotal=0,ssresid=0;for(let i=0;i<n;i++)sstotal+=(_knownYsValues[i]-meanY)**2,ssresid+=(_knownYsValues[i]-newY[i])**2;const ssreg=sstotal-ssresid,r2=0===sstotal?0:ssreg/sstotal,seList=[];for(let i=k-1;i>=0;i--){const se=df>0?Math.sqrt(ssresid/df*XTXInverse[i][i]):0;seList.push(se)}if(constb){const seb=seList.shift();seList.push(seb)}else seList.push(error_type_ErrorType.NA);const sey=df>0?Math.sqrt(ssresid/df):0,F=df>0?ssreg/(cl-1)/(ssresid/df):error_type_ErrorType.NUM;result=[coefficients[0],[...seList],[r2,sey,...fillNa],[F,df,...fillNa],[ssreg,ssresid,...fillNa]]}else result=[coefficients[0]];return ArrayValueObject.createByArray(result)}_getResultBySimpleVariables(knownYsValues,knownXsValues,constb,stats){const knownYsValuesFlat=knownYsValues.flat(),knownXsValuesFlat=knownXsValues.flat(),{slope:m,intercept:b}=getSlopeAndIntercept(knownXsValuesFlat,knownYsValuesFlat,constb,!1);if(Number.isNaN(m))return ErrorValueObject.create(error_type_ErrorType.NA);let result=[];if(stats){const n=knownYsValuesFlat.length;let meanY=0,meanX=0,df=n-1;if(constb){let sumY=0,sumX=0;for(let i=0;i<n;i++)sumY+=knownYsValuesFlat[i],sumX+=knownXsValuesFlat[i];meanY=sumY/n,meanX=sumX/n,df=n-2}let sstotal=0,ssresid=0,ssx=0;for(let i=0;i<n;i++)sstotal+=(knownYsValuesFlat[i]-meanY)**2,ssresid+=(knownYsValuesFlat[i]-(m*knownXsValuesFlat[i]+b))**2,ssx+=(knownXsValuesFlat[i]-meanX)**2;const ssreg=sstotal-ssresid,r2=ssreg===sstotal?1:ssreg/sstotal;let se=0,seb=0,sey=0;df>0&&(ssx>0&&(se=Math.sqrt(ssresid/df/ssx),seb=Math.sqrt(ssresid/df*(1/n+meanX**2/ssx))),sey=Math.sqrt(ssresid/df));const F=df>0?ssreg/1/(ssresid/df):error_type_ErrorType.NUM;constb||(seb=error_type_ErrorType.NA),result=[[m,b],[se,seb],[r2,sey],[F,df],[ssreg,ssresid]]}else result=[[m,b]];return ArrayValueObject.createByArray(result)}_getKnownXsValues(knownYsValues,knownXs){return!knownXs||knownXs.isNull()?getSerialNumbersByRowsColumns(knownYsValues.length,knownYsValues[0].length):getKnownsArrayValues(knownXs)}constructor(...args){super(...args),this.minParams=1,this.maxParams=4}},FUNCTION_NAMES_STATISTICAL.LINEST],[class Logest extends base_function_BaseFunction{calculate(knownYs,knownXs,constb,stats){const{isError,errorObject}=checkKnownsArrayDimensions(knownYs,knownXs);if(isError)return errorObject;const knownYsValues=getKnownsArrayValues(knownYs);if(knownYsValues instanceof ErrorValueObject)return knownYsValues;const knownXsValues=this._getKnownXsValues(knownYsValues,knownXs);if(knownXsValues instanceof ErrorValueObject)return knownXsValues;let _constb=constb??BooleanValueObject.create(!0);_constb.isArray()&&(_constb=_constb.get(0,0));let _stats=stats??BooleanValueObject.create(!1);_stats.isArray()&&(_stats=_stats.get(0,0));const{isError:_isError,errorObject:_errorObject,variants}=checkVariantsErrorIsStringToNumber(_constb,_stats);if(_isError)return _errorObject;const[constbObject,statsObject]=variants;return this._getResult(knownYsValues,knownXsValues,+constbObject.getValue(),+statsObject.getValue())}_getResult(knownYsValues,knownXsValues,constb,stats){if(1===knownYsValues.length&&knownXsValues.length>1||1===knownYsValues[0].length&&knownXsValues[0].length>1){if(1===knownYsValues.length&&knownXsValues.length>1){if((constb?knownXsValues.length+1:knownXsValues.length)>knownYsValues[0].length)return ErrorValueObject.create(error_type_ErrorType.NA)}if(1===knownYsValues[0].length&&knownXsValues[0].length>1){if((constb?knownXsValues[0].length+1:knownXsValues[0].length)>knownYsValues.length)return ErrorValueObject.create(error_type_ErrorType.NA)}return this._getResultByMultipleVariables(knownYsValues,knownXsValues,constb,stats)}return this._getResultBySimpleVariables(knownYsValues,knownXsValues,constb,stats)}_getResultByMultipleVariables(knownYsValues,knownXsValues,constb,stats){const _coefficients=getKnownsArrayCoefficients(knownYsValues,knownXsValues,knownXsValues,constb,!0);if(_coefficients instanceof ErrorValueObject)return _coefficients;const{coefficients,Y,X,XTXInverse}=_coefficients;let result=[];if(stats){const _knownYsValues=Y.flat(),n=_knownYsValues.length,meanY=constb?_knownYsValues.reduce(((acc,value)=>acc+value),0)/n:0,k=XTXInverse.length,df=n-k,cl=coefficients[0].length,fillNa=new Array(cl-2).fill(error_type_ErrorType.NA),b=coefficients[0][cl-1],newY=[];for(let i=0;i<X.length;i++){let value=b;for(let j=cl-2;j>=0;j--)value*=coefficients[0][cl-2-j]**X[i][j];newY.push(Math.log(value))}let sstotal=0,ssresid=0;for(let i=0;i<n;i++)sstotal+=(_knownYsValues[i]-meanY)**2,(constb||Number.isFinite(newY[i]))&&(ssresid+=(_knownYsValues[i]-newY[i])**2);Number.isFinite(ssresid)||(ssresid=0);const ssreg=sstotal-ssresid,r2=0===sstotal?0:ssreg/sstotal,seList=[];for(let i=k-1;i>=0;i--){const se=df>0?Math.sqrt(ssresid/df*XTXInverse[i][i]):0;seList.push(se)}if(constb){const seb=seList.shift();seList.push(seb)}else seList.push(error_type_ErrorType.NA);const sey=df>0?Math.sqrt(ssresid/df):0,F=df>0?ssreg/(cl-1)/(ssresid/df):error_type_ErrorType.NUM;result=[coefficients[0],[...seList],[r2,sey,...fillNa],[F,df,...fillNa],[ssreg,ssresid,...fillNa]]}else result=[coefficients[0]];return ArrayValueObject.createByArray(result)}_getResultBySimpleVariables(knownYsValues,knownXsValues,constb,stats){const knownYsValuesFlat=knownYsValues.flat(),knownXsValuesFlat=knownXsValues.flat(),{slope:m,intercept:b,Y}=getSlopeAndIntercept(knownXsValuesFlat,knownYsValuesFlat,constb,!0);if(Number.isNaN(m))return ErrorValueObject.create(error_type_ErrorType.NA);let result=[];if(stats){const n=Y.length;let meanY=0,meanX=0,df=n-1;if(constb){let sumY=0,sumX=0;for(let i=0;i<n;i++)sumY+=Y[i],sumX+=knownXsValuesFlat[i];meanY=sumY/n,meanX=sumX/n,df=n-2}let sstotal=0,ssresid=0,ssx=0;for(let i=0;i<n;i++)sstotal+=(Y[i]-meanY)**2,ssresid+=(Y[i]-Math.log(b*m**knownXsValuesFlat[i]))**2,ssx+=(knownXsValuesFlat[i]-meanX)**2;const ssreg=sstotal-ssresid,r2=0===sstotal?0:ssreg/sstotal;let se=0,seb=0,sey=0,F=0;df>0&&(ssx>0&&(se=Math.sqrt(ssresid/df/ssx),seb=Math.sqrt(ssresid/df*(1/n+meanX**2/ssx))),sey=Math.sqrt(ssresid/df),F=ssreg/1/(ssresid/df)),constb||(seb=error_type_ErrorType.NA),result=[[m,b],[se,seb],[r2,sey],[F,df],[ssreg,ssresid]]}else result=[[m,b]];return ArrayValueObject.createByArray(result)}_getKnownXsValues(knownYsValues,knownXs){return!knownXs||knownXs.isNull()?getSerialNumbersByRowsColumns(knownYsValues.length,knownYsValues[0].length):getKnownsArrayValues(knownXs)}constructor(...args){super(...args),this.minParams=1,this.maxParams=4}},FUNCTION_NAMES_STATISTICAL.LOGEST],[class LognormDist extends base_function_BaseFunction{calculate(x,mean,standardDev,cumulative){const maxRowLength=Math.max(x.isArray()?x.getRowCount():1,mean.isArray()?mean.getRowCount():1,standardDev.isArray()?standardDev.getRowCount():1,cumulative.isArray()?cumulative.getRowCount():1),maxColumnLength=Math.max(x.isArray()?x.getColumnCount():1,mean.isArray()?mean.getColumnCount():1,standardDev.isArray()?standardDev.getColumnCount():1,cumulative.isArray()?cumulative.getColumnCount():1),xArray=expandArrayValueObject(maxRowLength,maxColumnLength,x,ErrorValueObject.create(error_type_ErrorType.NA)),meanArray=expandArrayValueObject(maxRowLength,maxColumnLength,mean,ErrorValueObject.create(error_type_ErrorType.NA)),standardDevArray=expandArrayValueObject(maxRowLength,maxColumnLength,standardDev,ErrorValueObject.create(error_type_ErrorType.NA)),cumulativeArray=expandArrayValueObject(maxRowLength,maxColumnLength,cumulative,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=xArray.mapValue(((xObject,rowIndex,columnIndex)=>{const meanObject=meanArray.get(rowIndex,columnIndex),standardDevObject=standardDevArray.get(rowIndex,columnIndex),cumulativeObject=cumulativeArray.get(rowIndex,columnIndex);return xObject.isError()?xObject:meanObject.isError()?meanObject:standardDevObject.isError()?standardDevObject:cumulativeObject.isError()?cumulativeObject:this._handleSignleObject(xObject,meanObject,standardDevObject,cumulativeObject)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_handleSignleObject(xObject,meanObject,standardDevObject,cumulativeObject){const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(xObject,meanObject,standardDevObject,cumulativeObject);if(isError)return errorObject;const[_xObject,_meanObject,_standardDevObject,_cumulativeObject]=variants,xValue=+_xObject.getValue(),meanValue=+_meanObject.getValue(),standardDevValue=+_standardDevObject.getValue(),cumulativeValue=+_cumulativeObject.getValue();if(xValue<=0||standardDevValue<=0)return ErrorValueObject.create(error_type_ErrorType.NUM);let result;return result=cumulativeValue?lognormalCDF(xValue,meanValue,standardDevValue):function lognormalPDF(x,mean,standardDev){return x<=0?0:Math.exp(-Math.log(x)-.5*Math.log(2*Math.PI)-Math.log(standardDev)-(Math.log(x)-mean)**2/(2*standardDev*standardDev))}(xValue,meanValue,standardDevValue),NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=4,this.maxParams=4}},FUNCTION_NAMES_STATISTICAL.LOGNORM_DIST],[LognormInv,FUNCTION_NAMES_STATISTICAL.LOGNORM_INV],[class Marginoferror extends base_function_BaseFunction{calculate(range,confidence){const rangeValues=this._getRangeValues(range);if(rangeValues instanceof ErrorValueObject)return rangeValues;const _confidence=checkVariantErrorIsArray(confidence);if(_confidence.isError())return _confidence;const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(_confidence);if(isError)return errorObject;const[confidenceObject]=variants,confidenceValue=+confidenceObject.getValue();if(confidenceValue<=0||confidenceValue>=1)return ErrorValueObject.create(error_type_ErrorType.NUM);if(rangeValues.length<2)return ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO);const alpha=1-confidenceValue,size=rangeValues.length,mean=rangeValues.reduce(((acc,value)=>acc+value),0)/size,variance=rangeValues.reduce(((acc,value)=>acc+(value-mean)**2),0)/(size-1),standardDev=Math.sqrt(variance);if(standardDev<=0)return ErrorValueObject.create(error_type_ErrorType.NUM);const result=Math.abs(studentTINV(alpha/2,size-1)*standardDev/Math.sqrt(size));return NumberValueObject.create(result)}_getRangeValues(range){const rangeValues=[],rowCount=range.isArray()?range.getRowCount():1,columnCount=range.isArray()?range.getColumnCount():1;for(let r=0;r<rowCount;r++)for(let c=0;c<columnCount;c++){const valueObject=range.isArray()?range.get(r,c):range;if(valueObject.isError())return valueObject;valueObject.isNull()||valueObject.isBoolean()||valueObject.isString()||rangeValues.push(+valueObject.getValue())}return rangeValues}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_STATISTICAL.MARGINOFERROR],[class Max extends base_function_BaseFunction{calculate(...variants){let accumulatorAll=NumberValueObject.create(Number.NEGATIVE_INFINITY);for(let i=0;i<variants.length;i++){let variant=variants[i];if(!variant.isNull()){if((variant.isString()||variant.isBoolean())&&(variant=variant.convertToNumberObjectValue()),variant.isArray()&&(variant=variant.max()),variant.isError())return variant;accumulatorAll=this._validator(accumulatorAll,variant)}}return accumulatorAll.getValue()===Number.NEGATIVE_INFINITY?NumberValueObject.create(0):accumulatorAll}_validator(accumulatorAll,valueObject){const validator=accumulatorAll.isLessThan(valueObject);let _accumulatorAll=accumulatorAll;return validator.getValue()&&(_accumulatorAll=valueObject),_accumulatorAll}constructor(...args){super(...args),this.minParams=1,this.maxParams=255}},FUNCTION_NAMES_STATISTICAL.MAX],[class Maxa extends base_function_BaseFunction{calculate(...variants){let accumulatorAll=NumberValueObject.create(Number.NEGATIVE_INFINITY);for(let i=0;i<variants.length;i++){let variant=variants[i];if(!variant.isNull()){if((variant.isString()||variant.isBoolean())&&(variant=variant.convertToNumberObjectValue()),variant.isError())return variant;if(variant.isArray()&&variant.iterator((valueObject=>{let _valueObject=valueObject;if((null==_valueObject||_valueObject.isNull()||_valueObject.isString())&&(_valueObject=NumberValueObject.create(0)),_valueObject.isBoolean()&&(_valueObject=_valueObject.convertToNumberObjectValue()),_valueObject.isError())return accumulatorAll=_valueObject,!1;accumulatorAll=this._validator(accumulatorAll,_valueObject)})),accumulatorAll.isError())return accumulatorAll;accumulatorAll=this._validator(accumulatorAll,variant)}}return accumulatorAll.getValue()===Number.NEGATIVE_INFINITY?NumberValueObject.create(0):accumulatorAll}_validator(accumulatorAll,valueObject){const validator=accumulatorAll.isLessThan(valueObject);let _accumulatorAll=accumulatorAll;return validator.getValue()&&(_accumulatorAll=valueObject),_accumulatorAll}constructor(...args){super(...args),this.minParams=1,this.maxParams=255}},FUNCTION_NAMES_STATISTICAL.MAXA],[class Maxifs extends base_function_BaseFunction{calculate(maxRange,...variants){if(maxRange.isError())return ErrorValueObject.create(error_type_ErrorType.NA);if(!maxRange.isArray())return ErrorValueObject.create(error_type_ErrorType.VALUE);if(variants.length%2!=0)return ErrorValueObject.create(error_type_ErrorType.VALUE);if(variants.some(((variant,i)=>i%2==0&&!variant.isArray())))return ErrorValueObject.create(error_type_ErrorType.VALUE);const{maxRowLength,maxColumnLength}=calculateMaxDimensions(variants),errorArray=getErrorArray(variants,maxRange,maxRowLength,maxColumnLength);if(errorArray)return errorArray;const booleanResults=getBooleanResults(variants,maxRowLength,maxColumnLength,!0);return this._aggregateResults(maxRange,booleanResults)}_aggregateResults(maxRange,booleanResults){const maxResults=booleanResults.map((row=>row.map((booleanResult=>{const picked=maxRange.pick(booleanResult);return 0===picked.getColumnCount()?ArrayValueObject.create("0"):picked.max()})))),arrayValueObjectData={calculateValueList:maxResults,rowCount:maxResults.length,columnCount:maxResults[0].length,unitId:this.unitId||"",sheetId:this.subUnitId||"",row:this.row,column:this.column};return ArrayValueObject.create(arrayValueObjectData)}constructor(...args){super(...args),this.minParams=3,this.maxParams=255}},FUNCTION_NAMES_STATISTICAL.MAXIFS],[class Median extends base_function_BaseFunction{calculate(...variants){const values=[];for(let i=0;i<variants.length;i++){const variant=variants[i];if(variant.isArray()){let isError=!1,errorObject=ErrorValueObject.create(error_type_ErrorType.VALUE);if(variant.iterator((valueObject=>{if(valueObject?.isError())return isError=!0,errorObject=valueObject,!1;if(valueObject?.isNull()||valueObject?.isBoolean())return!0;const value=valueObject.getValue();if(!(0,src.DMQ)(value))return!0;values.push(+value)})),isError)return errorObject}else{if(variant.isError())return variant;if(variant.isNull()||variant.isBoolean())continue;if(variant.isString()){const _variant=variant.convertToNumberObjectValue();if(_variant.isError())return _variant}const value=variant.getValue();if(!(0,src.DMQ)(value))continue;values.push(+value)}}return 0===values.length?ErrorValueObject.create(error_type_ErrorType.NUM):this._getResult(values.sort(((a,b)=>a-b)))}_getResult(values){const n=values.length;let result;if(n%2==0){const mid=n/2;result=(values[mid-1]+values[mid])/2}else result=values[Math.floor(n/2)];return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=255}},FUNCTION_NAMES_STATISTICAL.MEDIAN],[class Min extends base_function_BaseFunction{calculate(...variants){let accumulatorAll=NumberValueObject.create(Number.POSITIVE_INFINITY);for(let i=0;i<variants.length;i++){let variant=variants[i];if(!variant.isNull()){if((variant.isString()||variant.isBoolean())&&(variant=variant.convertToNumberObjectValue()),variant.isArray()&&(variant=variant.min()),variant.isError())return variant;accumulatorAll=this._validator(accumulatorAll,variant)}}return accumulatorAll.getValue()===Number.POSITIVE_INFINITY?NumberValueObject.create(0):accumulatorAll}_validator(accumulatorAll,valueObject){const validator=accumulatorAll.isGreaterThan(valueObject);let _accumulatorAll=accumulatorAll;return validator.getValue()&&(_accumulatorAll=valueObject),_accumulatorAll}constructor(...args){super(...args),this.minParams=1,this.maxParams=255}},FUNCTION_NAMES_STATISTICAL.MIN],[class Mina extends base_function_BaseFunction{calculate(...variants){let accumulatorAll=NumberValueObject.create(Number.POSITIVE_INFINITY);for(let i=0;i<variants.length;i++){let variant=variants[i];if(!variant.isNull()){if((variant.isString()||variant.isBoolean())&&(variant=variant.convertToNumberObjectValue()),variant.isError())return variant;if(variant.isArray()&&variant.iterator((valueObject=>{let _valueObject=valueObject;if((null==_valueObject||_valueObject.isNull()||_valueObject.isString())&&(_valueObject=NumberValueObject.create(0)),_valueObject.isBoolean()&&(_valueObject=_valueObject.convertToNumberObjectValue()),_valueObject.isError())return accumulatorAll=_valueObject,!1;accumulatorAll=this._validator(accumulatorAll,_valueObject)})),accumulatorAll.isError())return accumulatorAll;accumulatorAll=this._validator(accumulatorAll,variant)}}return accumulatorAll.getValue()===Number.POSITIVE_INFINITY?NumberValueObject.create(0):accumulatorAll}_validator(accumulatorAll,valueObject){const validator=accumulatorAll.isGreaterThan(valueObject);let _accumulatorAll=accumulatorAll;return validator.getValue()&&(_accumulatorAll=valueObject),_accumulatorAll}constructor(...args){super(...args),this.minParams=1,this.maxParams=255}},FUNCTION_NAMES_STATISTICAL.MINA],[class Minifs extends base_function_BaseFunction{calculate(minRange,...variants){if(minRange.isError())return ErrorValueObject.create(error_type_ErrorType.NA);if(!minRange.isArray())return ErrorValueObject.create(error_type_ErrorType.VALUE);if(variants.length%2!=0)return ErrorValueObject.create(error_type_ErrorType.VALUE);if(variants.some(((variant,i)=>i%2==0&&!variant.isArray())))return ErrorValueObject.create(error_type_ErrorType.VALUE);const{maxRowLength,maxColumnLength}=calculateMaxDimensions(variants),errorArray=getErrorArray(variants,minRange,maxRowLength,maxColumnLength);if(errorArray)return errorArray;const booleanResults=getBooleanResults(variants,maxRowLength,maxColumnLength,!0);return this._aggregateResults(minRange,booleanResults)}_aggregateResults(minRange,booleanResults){const maxResults=booleanResults.map((row=>row.map((booleanResult=>{const picked=minRange.pick(booleanResult);return 0===picked.getColumnCount()?ArrayValueObject.create("0"):picked.min()})))),arrayValueObjectData={calculateValueList:maxResults,rowCount:maxResults.length,columnCount:maxResults[0].length,unitId:this.unitId||"",sheetId:this.subUnitId||"",row:this.row,column:this.column};return ArrayValueObject.create(arrayValueObjectData)}constructor(...args){super(...args),this.minParams=3,this.maxParams=255}},FUNCTION_NAMES_STATISTICAL.MINIFS],[class ModeMult extends base_function_BaseFunction{calculate(...variants){const valueMap={};let order=0,maxCount=1;for(let i=0;i<variants.length;i++){const variant=variants[i];if(variant.isError())return variant;if(variant.isString()){const _variant=variant.convertToNumberObjectValue();if(_variant.isError())return _variant}const rowCount=variant.isArray()?variant.getRowCount():1,columnCount=variant.isArray()?variant.getColumnCount():1;for(let r=0;r<rowCount;r++)for(let c=0;c<columnCount;c++){const valueObject=variant.isArray()?variant.get(r,c):variant;if(valueObject.isError())return valueObject;if(valueObject.isNull()||valueObject.isBoolean()||valueObject.isString())continue;const value=valueObject.getValue();(0,src.DMQ)(value)&&(valueMap[+value]?(valueMap[+value].count++,valueMap[+value].count>maxCount&&(maxCount=valueMap[+value].count)):valueMap[+value]={count:1,order:order++})}}return 0===order||1===maxCount?new ErrorValueObject(error_type_ErrorType.NA):this._getResult(valueMap,maxCount)}_getResult(valueMap,maxCount){const result=Object.entries(valueMap).filter((([_,{count}])=>count===maxCount)).sort(((a,b)=>a[1].order-b[1].order)).map((([value])=>+value));return 1===result.length?NumberValueObject.create(result[0]):ArrayValueObject.createByArray(result.map((value=>[value])))}constructor(...args){super(...args),this.minParams=1,this.maxParams=255}},FUNCTION_NAMES_STATISTICAL.MODE_MULT],[ModeSngl,FUNCTION_NAMES_STATISTICAL.MODE_SNGL],[class NegbinomDist extends base_function_BaseFunction{calculate(numberF,numberS,probabilityS,cumulative){const maxRowLength=Math.max(numberF.isArray()?numberF.getRowCount():1,numberS.isArray()?numberS.getRowCount():1,probabilityS.isArray()?probabilityS.getRowCount():1,cumulative.isArray()?cumulative.getRowCount():1),maxColumnLength=Math.max(numberF.isArray()?numberF.getColumnCount():1,numberS.isArray()?numberS.getColumnCount():1,probabilityS.isArray()?probabilityS.getColumnCount():1,cumulative.isArray()?cumulative.getColumnCount():1),numberFArray=expandArrayValueObject(maxRowLength,maxColumnLength,numberF,ErrorValueObject.create(error_type_ErrorType.NA)),numberSArray=expandArrayValueObject(maxRowLength,maxColumnLength,numberS,ErrorValueObject.create(error_type_ErrorType.NA)),probabilitySArray=expandArrayValueObject(maxRowLength,maxColumnLength,probabilityS,ErrorValueObject.create(error_type_ErrorType.NA)),cumulativeArray=expandArrayValueObject(maxRowLength,maxColumnLength,cumulative,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=numberFArray.mapValue(((numberFObject,rowIndex,columnIndex)=>{const numberSObject=numberSArray.get(rowIndex,columnIndex),probabilitySObject=probabilitySArray.get(rowIndex,columnIndex),cumulativeObject=cumulativeArray.get(rowIndex,columnIndex);return numberFObject.isError()?numberFObject:numberSObject.isError()?numberSObject:probabilitySObject.isError()?probabilitySObject:cumulativeObject.isError()?cumulativeObject:this._handleSignleObject(numberFObject,numberSObject,probabilitySObject,cumulativeObject)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_handleSignleObject(numberFObject,numberSObject,probabilitySObject,cumulativeObject){const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(numberFObject,numberSObject,probabilitySObject,cumulativeObject);if(isError)return errorObject;const[_numberFObject,_numberSObject,_probabilitySObject,_cumulativeObject]=variants,numberFValue=Math.floor(+_numberFObject.getValue()),numberSValue=Math.floor(+_numberSObject.getValue()),probabilitySValue=+_probabilitySObject.getValue(),cumulativeValue=+_cumulativeObject.getValue();if(numberFValue<0||numberSValue<1||probabilitySValue<=0||probabilitySValue>=1)return ErrorValueObject.create(error_type_ErrorType.NUM);let result;return result=cumulativeValue?function negbinomialCDF(numberF,numberS,probabilityS){if(numberF<0)return 0;let result=0;for(let i=0;i<=numberF;i++)result+=negbinomialPDF(i,numberS,probabilityS);return result}(numberFValue,numberSValue,probabilitySValue):negbinomialPDF(numberFValue,numberSValue,probabilitySValue),NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=4,this.maxParams=4}},FUNCTION_NAMES_STATISTICAL.NEGBINOM_DIST],[NormDist,FUNCTION_NAMES_STATISTICAL.NORM_DIST],[NormInv,FUNCTION_NAMES_STATISTICAL.NORM_INV],[class NormSDist extends base_function_BaseFunction{calculate(z,cumulative){const maxRowLength=Math.max(z.isArray()?z.getRowCount():1,cumulative.isArray()?cumulative.getRowCount():1),maxColumnLength=Math.max(z.isArray()?z.getColumnCount():1,cumulative.isArray()?cumulative.getColumnCount():1),zArray=expandArrayValueObject(maxRowLength,maxColumnLength,z,ErrorValueObject.create(error_type_ErrorType.NA)),cumulativeArray=expandArrayValueObject(maxRowLength,maxColumnLength,cumulative,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=zArray.mapValue(((zObject,rowIndex,columnIndex)=>{const cumulativeObject=cumulativeArray.get(rowIndex,columnIndex);return zObject.isError()?zObject:cumulativeObject.isError()?cumulativeObject:this._handleSignleObject(zObject,cumulativeObject)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_handleSignleObject(zObject,cumulativeObject){const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(zObject,cumulativeObject);if(isError)return errorObject;const[_zObject,_cumulativeObject]=variants,zValue=+_zObject.getValue();let result;return result=+_cumulativeObject.getValue()?normalCDF(zValue,0,1):normalPDF(zValue,0,1),NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_STATISTICAL.NORM_S_DIST],[NormSInv,FUNCTION_NAMES_STATISTICAL.NORM_S_INV],[class Pearson extends base_function_BaseFunction{calculate(array1,array2){const array1RowCount=array1.isArray()?array1.getRowCount():1,array1ColumnCount=array1.isArray()?array1.getColumnCount():1,array2RowCount=array2.isArray()?array2.getRowCount():1,array2ColumnCount=array2.isArray()?array2.getColumnCount():1;let _array1=array1;if(array1.isArray()&&1===array1RowCount&&1===array1ColumnCount&&(_array1=array1.get(0,0)),_array1.isError())return _array1;let _array2=array2;if(array2.isArray()&&1===array2RowCount&&1===array2ColumnCount&&(_array2=array2.get(0,0)),_array2.isError())return _array2;if(array1RowCount*array1ColumnCount==1||array2RowCount*array2ColumnCount==1)return _array1.isNull()||_array2.isNull()?ErrorValueObject.create(error_type_ErrorType.VALUE):ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO);if(array1RowCount*array1ColumnCount!=array2RowCount*array2ColumnCount)return ErrorValueObject.create(error_type_ErrorType.NA);const{isError,errorObject,array1Values,array2Values,noCalculate}=getTwoArrayNumberValues(array1,array2,array1RowCount*array1ColumnCount,array1ColumnCount,array2ColumnCount);return isError?errorObject:noCalculate?ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO):this._getResult(array1Values,array2Values)}_getResult(array1,array2){const n=array1.length;let sumX=0,sumY=0;for(let i=0;i<n;i++)sumX+=array1[i],sumY+=array2[i];const meanX=sumX/n,meanY=sumY/n;let num=0,den1=0,den2=0;for(let i=0;i<n;i++)num+=(array1[i]-meanX)*(array2[i]-meanY),den1+=(array1[i]-meanX)**2,den2+=(array2[i]-meanY)**2;if(0===den1||0===den2)return ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO);const result=num/Math.sqrt(den1*den2);return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_STATISTICAL.PEARSON],[class PercentileExc extends base_function_BaseFunction{calculate(array,k){const arrayValues=this._getValues(array);if(k.isArray()){const resultArray=k.mapValue((kObject=>this._handleSingleObject(arrayValues,kObject)));return 1===resultArray.getRowCount()&&1===resultArray.getColumnCount()?resultArray.get(0,0):resultArray}return this._handleSingleObject(arrayValues,k)}_handleSingleObject(array,k){if(array instanceof ErrorValueObject)return array;const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(k);if(isError)return errorObject;const[kObject]=variants,kValue=+kObject.getValue(),n=array.length;if(kValue<1/(n+1)||kValue>1-1/(n+1))return ErrorValueObject.create(error_type_ErrorType.NUM);const kValueIndex=kValue*(n+1)-1,integerPart=Math.floor(kValueIndex),fractionPart=kValueIndex-integerPart;if(0===fractionPart)return NumberValueObject.create(array[integerPart]);const result=array[integerPart]+fractionPart*(array[integerPart+1]-array[integerPart]);return NumberValueObject.create(result)}_getValues(array){const rowCount=array.isArray()?array.getRowCount():1,columnCount=array.isArray()?array.getColumnCount():1,values=[];for(let r=0;r<rowCount;r++)for(let c=0;c<columnCount;c++){const valueObject=array.isArray()?array.get(r,c):array;if(valueObject.isError())return valueObject;if(valueObject.isNull()||valueObject.isBoolean()||valueObject.isString())continue;const value=valueObject.getValue();(0,src.DMQ)(value)&&values.push(+value)}return 0===values.length?ErrorValueObject.create(error_type_ErrorType.NUM):values.sort(((a,b)=>a-b))}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_STATISTICAL.PERCENTILE_EXC],[PercentileInc,FUNCTION_NAMES_STATISTICAL.PERCENTILE_INC],[class PercentrankExc extends base_function_BaseFunction{calculate(array,x,significance){const arrayValues=this._getValues(array);let _significance=significance??NumberValueObject.create(3);_significance.isNull()&&(_significance=NumberValueObject.create(3));const maxRowLength=Math.max(x.isArray()?x.getRowCount():1,_significance.isArray()?_significance.getRowCount():1),maxColumnLength=Math.max(x.isArray()?x.getColumnCount():1,_significance.isArray()?_significance.getColumnCount():1),xArray=expandArrayValueObject(maxRowLength,maxColumnLength,x,ErrorValueObject.create(error_type_ErrorType.NA)),significanceArray=expandArrayValueObject(maxRowLength,maxColumnLength,_significance,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=xArray.mapValue(((xObject,rowIndex,columnIndex)=>{const significanceObject=significanceArray.get(rowIndex,columnIndex);return xObject.isError()?xObject:significanceObject.isError()?significanceObject:this._handleSingleObject(arrayValues,xObject,significanceObject)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_handleSingleObject(array,x,significance){if(array instanceof ErrorValueObject)return array;const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(x,significance);if(isError)return errorObject;const[xObject,significanceObject]=variants,xValue=+xObject.getValue(),significanceValue=Math.floor(+significanceObject.getValue()),n=array.length;if(0===n||xValue<array[0]||xValue>array[n-1])return ErrorValueObject.create(error_type_ErrorType.NA);if(1===n)return xValue===array[0]?NumberValueObject.create(1):ErrorValueObject.create(error_type_ErrorType.NA);let result=0,match=!1,i=0;for(;!match&&i<n;)xValue===array[i]?(result=(i+1)/(n+1),match=!0):xValue>array[i]&&i+1<n&&xValue<array[i+1]&&(result=(i+1+(xValue-array[i])/(array[i+1]-array[i]))/(n+1),match=!0),i++;return match?significanceValue<1?ErrorValueObject.create(error_type_ErrorType.NUM):(result=floor(result,significanceValue),NumberValueObject.create(result)):ErrorValueObject.create(error_type_ErrorType.NA)}_getValues(array){const rowCount=array.isArray()?array.getRowCount():1,columnCount=array.isArray()?array.getColumnCount():1,values=[];for(let r=0;r<rowCount;r++)for(let c=0;c<columnCount;c++){const valueObject=array.isArray()?array.get(r,c):array;if(valueObject.isError())return valueObject;if(valueObject.isNull()||valueObject.isBoolean())continue;const value=valueObject.getValue();(0,src.DMQ)(value)&&values.push(+value)}return values.sort(((a,b)=>a-b))}constructor(...args){super(...args),this.minParams=2,this.maxParams=3}},FUNCTION_NAMES_STATISTICAL.PERCENTRANK_EXC],[PercentrankInc,FUNCTION_NAMES_STATISTICAL.PERCENTRANK_INC],[class Permut extends base_function_BaseFunction{calculate(number,numberChosen){const maxRowLength=Math.max(number.isArray()?number.getRowCount():1,numberChosen.isArray()?numberChosen.getRowCount():1),maxColumnLength=Math.max(number.isArray()?number.getColumnCount():1,numberChosen.isArray()?numberChosen.getColumnCount():1),numberArray=expandArrayValueObject(maxRowLength,maxColumnLength,number,ErrorValueObject.create(error_type_ErrorType.NA)),numberChosenArray=expandArrayValueObject(maxRowLength,maxColumnLength,numberChosen,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=numberArray.mapValue(((numberObject,rowIndex,columnIndex)=>{const numberChosenObject=numberChosenArray.get(rowIndex,columnIndex);if(numberObject.isError())return numberObject;if(numberChosenObject.isError())return numberChosenObject;const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(numberObject,numberChosenObject);if(isError)return errorObject;const[_numberObject,_numberChosenObject]=variants,numberValue=Math.floor(+_numberObject.getValue()),numberChosenValue=Math.floor(+_numberChosenObject.getValue());if(numberValue<0||numberValue>=2147483647||numberChosenValue<0||numberValue<numberChosenValue)return ErrorValueObject.create(error_type_ErrorType.NUM);let result=1;for(let i=numberValue-numberChosenValue+1;i<=numberValue;i++)result*=i;return Number.isFinite(result)?NumberValueObject.create(result):ErrorValueObject.create(error_type_ErrorType.NUM)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_STATISTICAL.PERMUT],[class Permutationa extends base_function_BaseFunction{calculate(number,numberChosen){const maxRowLength=Math.max(number.isArray()?number.getRowCount():1,numberChosen.isArray()?numberChosen.getRowCount():1),maxColumnLength=Math.max(number.isArray()?number.getColumnCount():1,numberChosen.isArray()?numberChosen.getColumnCount():1),numberArray=expandArrayValueObject(maxRowLength,maxColumnLength,number,ErrorValueObject.create(error_type_ErrorType.NA)),numberChosenArray=expandArrayValueObject(maxRowLength,maxColumnLength,numberChosen,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=numberArray.mapValue(((numberObject,rowIndex,columnIndex)=>{const numberChosenObject=numberChosenArray.get(rowIndex,columnIndex);if(numberObject.isError())return numberObject;if(numberChosenObject.isError())return numberChosenObject;const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(numberObject,numberChosenObject);if(isError)return errorObject;const[_numberObject,_numberChosenObject]=variants,numberValue=Math.floor(+_numberObject.getValue()),numberChosenValue=Math.floor(+_numberChosenObject.getValue());if(numberValue<0||numberValue>=2147483647||numberChosenValue<0)return ErrorValueObject.create(error_type_ErrorType.NUM);if(0===numberValue)return 0===numberChosenValue?NumberValueObject.create(1):NumberValueObject.create(0);const result=numberValue**numberChosenValue;return Number.isFinite(result)?NumberValueObject.create(result):ErrorValueObject.create(error_type_ErrorType.NUM)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_STATISTICAL.PERMUTATIONA],[class Phi extends base_function_BaseFunction{calculate(x){if(x.isArray()){const resultArray=x.mapValue((xObject=>this._handleSingleObject(xObject)));return 1===resultArray.getRowCount()&&1===resultArray.getColumnCount()?resultArray.get(0,0):resultArray}return this._handleSingleObject(x)}_handleSingleObject(x){const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(x);if(isError)return errorObject;const[xObject]=variants,xValue=+xObject.getValue(),result=Math.exp(-.5*xValue*xValue)/Math.sqrt(2*Math.PI);return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_STATISTICAL.PHI],[PoissonDist,FUNCTION_NAMES_STATISTICAL.POISSON_DIST],[class Prob extends base_function_BaseFunction{calculate(xRange,probRange,lowerLimit,upperLimit){const{isError,errorObject,xRangeValues,probRangeValues}=this._handleXRangeAndProbRange(xRange,probRange);let _upperLimit=upperLimit??lowerLimit;upperLimit?.isNull()&&(_upperLimit=lowerLimit);const maxRowLength=Math.max(lowerLimit.isArray()?lowerLimit.getRowCount():1,_upperLimit.isArray()?_upperLimit.getRowCount():1),maxColumnLength=Math.max(lowerLimit.isArray()?lowerLimit.getColumnCount():1,_upperLimit.isArray()?_upperLimit.getColumnCount():1),lowerLimitArray=expandArrayValueObject(maxRowLength,maxColumnLength,lowerLimit,ErrorValueObject.create(error_type_ErrorType.NA)),upperLimitArray=expandArrayValueObject(maxRowLength,maxColumnLength,_upperLimit,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=lowerLimitArray.mapValue(((lowerLimitObject,rowIndex,columnIndex)=>{const upperLimitObject=upperLimitArray.get(rowIndex,columnIndex);return xRange.isError()?xRange:probRange.isError()?probRange:lowerLimitObject.isError()?lowerLimitObject:upperLimitObject.isError()?upperLimitObject:isError?errorObject:this._handleSignleObject(xRangeValues,probRangeValues,lowerLimitObject,upperLimitObject)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_handleSignleObject(xRangeValues,probRangeValues,lowerLimit,upperLimit){const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(lowerLimit,upperLimit);if(isError)return errorObject;const[lowerLimitObject,upperLimitObject]=variants,lowerLimitValue=+lowerLimitObject.getValue(),upperLimitValue=+upperLimitObject.getValue();if(1!==probRangeValues.reduce(((acc,val)=>acc+val),0))return ErrorValueObject.create(error_type_ErrorType.NUM);let sum=0;for(let i=0;i<xRangeValues.length;i++)xRangeValues[i]>=lowerLimitValue&&xRangeValues[i]<=upperLimitValue&&(sum+=probRangeValues[i]);return NumberValueObject.create(sum)}_handleXRangeAndProbRange(xRange,probRange){const xRangeRowCount=xRange.isArray()?xRange.getRowCount():1,xRangeColumnCount=xRange.isArray()?xRange.getColumnCount():1,probRangeRowCount=probRange.isArray()?probRange.getRowCount():1,probRangeColumnCount=probRange.isArray()?probRange.getColumnCount():1;let _xRange=xRange;if(xRange.isArray()&&1===xRangeRowCount&&1===xRangeColumnCount&&(_xRange=xRange.get(0,0)),_xRange.isError())return{isError:!0,errorObject:_xRange,xRangeValues:[],probRangeValues:[]};let _probRange=probRange;if(probRange.isArray()&&1===probRangeRowCount&&1===probRangeColumnCount&&(_probRange=probRange.get(0,0)),_probRange.isError())return{isError:!0,errorObject:_probRange,xRangeValues:[],probRangeValues:[]};if((xRangeRowCount*xRangeColumnCount==1||probRangeRowCount*probRangeColumnCount==1)&&(_xRange.isNull()||_probRange.isNull()))return{isError:!0,errorObject:ErrorValueObject.create(error_type_ErrorType.VALUE),xRangeValues:[],probRangeValues:[]};if(xRangeRowCount*xRangeColumnCount!=probRangeRowCount*probRangeColumnCount)return{isError:!0,errorObject:ErrorValueObject.create(error_type_ErrorType.NA),xRangeValues:[],probRangeValues:[]};const{isError,errorObject,array1Values:xRangeValues,array2Values:probRangeValues,noCalculate}=getTwoArrayNumberValues(xRange,probRange,xRangeRowCount*xRangeColumnCount,xRangeColumnCount,probRangeColumnCount);return isError?{isError:!0,errorObject,xRangeValues:[],probRangeValues:[]}:noCalculate?{isError:!0,errorObject:ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO),xRangeValues:[],probRangeValues:[]}:{isError:!1,errorObject:null,xRangeValues,probRangeValues}}constructor(...args){super(...args),this.minParams=3,this.maxParams=4}},FUNCTION_NAMES_STATISTICAL.PROB],[class QuartileExc extends base_function_BaseFunction{calculate(array,quart){const arrayValues=this._getValues(array);if(quart.isArray()){const resultArray=quart.mapValue((quartObject=>this._handleSingleObject(arrayValues,quartObject)));return 1===resultArray.getRowCount()&&1===resultArray.getColumnCount()?resultArray.get(0,0):resultArray}return this._handleSingleObject(arrayValues,quart)}_handleSingleObject(array,quart){if(array instanceof ErrorValueObject)return array;const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(quart);if(isError)return errorObject;const[quartObject]=variants,quartValue=Math.floor(+quartObject.getValue());if(quartValue<=0||quartValue>=4)return ErrorValueObject.create(error_type_ErrorType.NUM);const k=quartValue/4,n=array.length;if(k<1/(n+1)||k>1-1/(n+1))return ErrorValueObject.create(error_type_ErrorType.NUM);const kIndex=k*(n+1)-1,integerPart=Math.floor(kIndex),fractionPart=kIndex-integerPart;if(0===fractionPart)return NumberValueObject.create(array[integerPart]);const result=array[integerPart]+fractionPart*(array[integerPart+1]-array[integerPart]);return NumberValueObject.create(result)}_getValues(array){const rowCount=array.isArray()?array.getRowCount():1,columnCount=array.isArray()?array.getColumnCount():1,values=[];for(let r=0;r<rowCount;r++)for(let c=0;c<columnCount;c++){const valueObject=array.isArray()?array.get(r,c):array;if(valueObject.isError())return valueObject;if(valueObject.isNull()||valueObject.isBoolean())continue;const value=valueObject.getValue();(0,src.DMQ)(value)&&values.push(+value)}return 0===values.length?ErrorValueObject.create(error_type_ErrorType.NUM):values.sort(((a,b)=>a-b))}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_STATISTICAL.QUARTILE_EXC],[QuartileInc,FUNCTION_NAMES_STATISTICAL.QUARTILE_INC],[class RankAvg extends base_function_BaseFunction{calculate(number,ref,order){let _number=number;_number.isReferenceObject()&&(_number=_number.toArrayValueObject());const{refHasError,refErrorObject,refNumbers}=this._checkRefReferenceObject(ref);let _order=order??NumberValueObject.create(0);_order.isReferenceObject()&&(_order=_order.toArrayValueObject());const maxRowLength=Math.max(_number.isArray()?_number.getRowCount():1,_order.isArray()?_order.getRowCount():1),maxColumnLength=Math.max(_number.isArray()?_number.getColumnCount():1,_order.isArray()?_order.getColumnCount():1),numberArray=expandArrayValueObject(maxRowLength,maxColumnLength,_number,ErrorValueObject.create(error_type_ErrorType.NA)),orderArray=expandArrayValueObject(maxRowLength,maxColumnLength,_order,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=numberArray.map(((numberObject,rowIndex,columnIndex)=>{const orderObject=orderArray.get(rowIndex,columnIndex);if(!number.isReferenceObject()&&number.isNull())return ErrorValueObject.create(error_type_ErrorType.NA);if(refHasError)return refErrorObject;if(orderObject.isError())return orderObject;const numberValue=+numberObject.getValue(),orderValue=+orderObject.getValue();return Number.isNaN(numberValue)||Number.isNaN(orderValue)?ErrorValueObject.create(error_type_ErrorType.VALUE):this._getResult(numberValue,orderValue,refNumbers)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_getResult(numberValue,orderValue,refNumbers){const refOrderNumbers=refNumbers.sort(((a,b)=>orderValue?a-b:b-a));let index=refOrderNumbers.indexOf(numberValue);const results=[];for(;index>=0;){const start=index+1;results.push(start),index=refOrderNumbers.indexOf(numberValue,start)}if(0===results.length)return ErrorValueObject.create(error_type_ErrorType.NA);const result=results.reduce(((acc,cur)=>acc+cur),0)/results.length;return NumberValueObject.create(result)}_checkRefReferenceObject(ref){let refHasError=!1,refErrorObject=ErrorValueObject.create(error_type_ErrorType.NA);const refNumbers=[];if(!ref.isReferenceObject())return{refHasError:!0,refErrorObject,refNumbers};return ref.toArrayValueObject().iterator((refObject=>{const _refObject=refObject;if(_refObject.isError())return refHasError=!0,refErrorObject=_refObject,!1;if(_refObject.isNull()||_refObject.isBoolean())return!0;const refValue=+_refObject.getValue();if(Number.isNaN(refValue))return!0;refNumbers.push(refValue)})),{refHasError,refErrorObject,refNumbers}}constructor(...args){super(...args),this.minParams=2,this.maxParams=3,this.needsReferenceObject=!0}},FUNCTION_NAMES_STATISTICAL.RANK_AVG],[class RankEq extends base_function_BaseFunction{calculate(number,ref,order){let _number=number;_number.isReferenceObject()&&(_number=_number.toArrayValueObject());const{refHasError,refErrorObject,refNumbers}=this._checkRefReferenceObject(ref);let _order=order??NumberValueObject.create(0);_order.isReferenceObject()&&(_order=_order.toArrayValueObject());const maxRowLength=Math.max(_number.isArray()?_number.getRowCount():1,_order.isArray()?_order.getRowCount():1),maxColumnLength=Math.max(_number.isArray()?_number.getColumnCount():1,_order.isArray()?_order.getColumnCount():1),numberArray=expandArrayValueObject(maxRowLength,maxColumnLength,_number,ErrorValueObject.create(error_type_ErrorType.NA)),orderArray=expandArrayValueObject(maxRowLength,maxColumnLength,_order,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=numberArray.map(((numberObject,rowIndex,columnIndex)=>{const orderObject=orderArray.get(rowIndex,columnIndex);if(!number.isReferenceObject()&&number.isNull())return ErrorValueObject.create(error_type_ErrorType.NA);if(refHasError)return refErrorObject;if(orderObject.isError())return orderObject;const numberValue=+numberObject.getValue(),orderValue=+orderObject.getValue();if(Number.isNaN(numberValue)||Number.isNaN(orderValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);const result=refNumbers.sort(((a,b)=>orderValue?a-b:b-a)).indexOf(numberValue);return-1===result?ErrorValueObject.create(error_type_ErrorType.NA):NumberValueObject.create(result+1)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_checkRefReferenceObject(ref){let refHasError=!1,refErrorObject=ErrorValueObject.create(error_type_ErrorType.NA);const refNumbers=[];if(!ref.isReferenceObject())return{refHasError:!0,refErrorObject,refNumbers};return ref.toArrayValueObject().iterator((refObject=>{const _refObject=refObject;if(_refObject.isError())return refHasError=!0,refErrorObject=_refObject,!1;if(_refObject.isNull()||_refObject.isBoolean())return!0;const refValue=+_refObject.getValue();if(Number.isNaN(refValue))return!0;refNumbers.push(refValue)})),{refHasError,refErrorObject,refNumbers}}constructor(...args){super(...args),this.minParams=2,this.maxParams=3,this.needsReferenceObject=!0}},FUNCTION_NAMES_STATISTICAL.RANK_EQ],[class Rsq extends base_function_BaseFunction{calculate(array1,array2){const array1RowCount=array1.isArray()?array1.getRowCount():1,array1ColumnCount=array1.isArray()?array1.getColumnCount():1,array2RowCount=array2.isArray()?array2.getRowCount():1,array2ColumnCount=array2.isArray()?array2.getColumnCount():1;let _array1=array1;if(array1.isArray()&&1===array1RowCount&&1===array1ColumnCount&&(_array1=array1.get(0,0)),_array1.isError())return _array1;let _array2=array2;if(array2.isArray()&&1===array2RowCount&&1===array2ColumnCount&&(_array2=array2.get(0,0)),_array2.isError())return _array2;if((array1RowCount*array1ColumnCount==1||array2RowCount*array2ColumnCount==1)&&(_array1.isNull()||_array2.isNull()))return ErrorValueObject.create(error_type_ErrorType.VALUE);if(array1RowCount*array1ColumnCount!=array2RowCount*array2ColumnCount)return ErrorValueObject.create(error_type_ErrorType.NA);const{isError,errorObject,array1Values,array2Values,noCalculate}=getTwoArrayNumberValues(array1,array2,array1RowCount*array1ColumnCount,array1ColumnCount,array2ColumnCount);return isError?errorObject:noCalculate?ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO):this._getResult(array1Values,array2Values)}_getResult(array1,array2){if(0===array1.length)return ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO);const n=array1.length;let sumX=0,sumY=0;for(let i=0;i<n;i++)sumX+=array1[i],sumY+=array2[i];const meanX=sumX/n,meanY=sumY/n;let num=0,den1=0,den2=0;for(let i=0;i<n;i++)num+=(array1[i]-meanX)*(array2[i]-meanY),den1+=(array1[i]-meanX)**2,den2+=(array2[i]-meanY)**2;if(0===den1||0===den2)return ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO);const result=(num/Math.sqrt(den1*den2))**2;return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_STATISTICAL.RSQ],[class Skew extends base_function_BaseFunction{calculate(...variants){const values=[];let sum=0;for(let i=0;i<variants.length;i++){const variant=variants[i];if(variant.isError())return variant;if(variant.isString()){const _variant=variant.convertToNumberObjectValue();if(_variant.isError())return _variant}const rowCount=variant.isArray()?variant.getRowCount():1,columnCount=variant.isArray()?variant.getColumnCount():1;for(let r=0;r<rowCount;r++)for(let c=0;c<columnCount;c++){const valueObject=variant.isArray()?variant.get(r,c):variant;if(valueObject.isError())return valueObject;if(valueObject.isNull()||valueObject.isBoolean())continue;const value=valueObject.getValue();(0,src.DMQ)(value)&&(values.push(+value),sum+=+value)}}return values.length<=2?ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO):this._getResult(values,sum)}_getResult(values,sum){const n=values.length,mean=sum/n;let sum2=0;for(let i=0;i<n;i++)sum2+=(values[i]-mean)**2;const stdev=Math.sqrt(sum2/(n-1));if(0===stdev)return ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO);let sum3=0;for(let i=0;i<n;i++)sum3+=((values[i]-mean)/stdev)**3;const result=n/((n-1)*(n-2))*sum3;return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=255}},FUNCTION_NAMES_STATISTICAL.SKEW],[class SkewP extends base_function_BaseFunction{calculate(...variants){const values=[];let sum=0;for(let i=0;i<variants.length;i++){const variant=variants[i];if(variant.isError())return variant;if(variant.isString()){const _variant=variant.convertToNumberObjectValue();if(_variant.isError())return _variant}const rowCount=variant.isArray()?variant.getRowCount():1,columnCount=variant.isArray()?variant.getColumnCount():1;for(let r=0;r<rowCount;r++)for(let c=0;c<columnCount;c++){const valueObject=variant.isArray()?variant.get(r,c):variant;if(valueObject.isError())return valueObject;if(valueObject.isNull()||valueObject.isBoolean())continue;const value=valueObject.getValue();(0,src.DMQ)(value)&&(values.push(+value),sum+=+value)}}return values.length<=2?ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO):this._getResult(values,sum)}_getResult(values,sum){const n=values.length,mean=sum/n;let sum2=0;for(let i=0;i<n;i++)sum2+=(values[i]-mean)**2;const stdev=Math.sqrt(sum2/n);if(0===stdev)return ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO);let sum3=0;for(let i=0;i<n;i++)sum3+=((values[i]-mean)/stdev)**3;const result=sum3/n;return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=255}},FUNCTION_NAMES_STATISTICAL.SKEW_P],[class Slope extends base_function_BaseFunction{calculate(knownYs,knownXs){const knownYsRowCount=knownYs.isArray()?knownYs.getRowCount():1,knownYsColumnCount=knownYs.isArray()?knownYs.getColumnCount():1,knownXsRowCount=knownXs.isArray()?knownXs.getRowCount():1,knownXsColumnCount=knownXs.isArray()?knownXs.getColumnCount():1;let _knownYs=knownYs;if(knownYs.isArray()&&1===knownYsRowCount&&1===knownYsColumnCount&&(_knownYs=knownYs.get(0,0)),_knownYs.isError())return _knownYs;let _knownXs=knownXs;if(knownXs.isArray()&&1===knownXsRowCount&&1===knownXsColumnCount&&(_knownXs=knownXs.get(0,0)),_knownXs.isError())return _knownXs;if(knownYsRowCount*knownYsColumnCount==1||knownXsRowCount*knownXsColumnCount==1)return _knownYs.isNull()||_knownXs.isNull()?ErrorValueObject.create(error_type_ErrorType.VALUE):ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO);if(knownYsRowCount*knownYsColumnCount!=knownXsRowCount*knownXsColumnCount)return ErrorValueObject.create(error_type_ErrorType.NA);const{isError,errorObject,array1Values,array2Values,noCalculate}=getTwoArrayNumberValues(knownYs,knownXs,knownYsRowCount*knownYsColumnCount,knownYsColumnCount,knownXsColumnCount);return isError?errorObject:noCalculate?ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO):this._getResult(array1Values,array2Values)}_getResult(knownYs,knownXs){const n=knownYs.length;let knownYsSum=0,knownXsSum=0;for(let i=0;i<n;i++)knownYsSum+=knownYs[i],knownXsSum+=knownXs[i];const knownYsMean=knownYsSum/n,knownXsMean=knownXsSum/n;let num=0,den=0;for(let i=0;i<n;i++)num+=(knownYs[i]-knownYsMean)*(knownXs[i]-knownXsMean),den+=(knownXs[i]-knownXsMean)**2;if(0===den)return ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO);const result=num/den;return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_STATISTICAL.SLOPE],[class Small extends base_function_BaseFunction{calculate(array,k){const arrayValues=this._getValues(array);if(k.isArray()){const resultArray=k.mapValue((kObject=>this._handleSingleObject(arrayValues,kObject)));return 1===resultArray.getRowCount()&&1===resultArray.getColumnCount()?resultArray.get(0,0):resultArray}return this._handleSingleObject(arrayValues,k)}_handleSingleObject(array,k){if(array instanceof ErrorValueObject)return array;const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(k);if(isError)return errorObject;const[kObject]=variants;let kValue=+kObject.getValue();return kValue<1||kValue>array.length?ErrorValueObject.create(error_type_ErrorType.NUM):(kValue=Math.floor(kValue),NumberValueObject.create(array[kValue-1]))}_getValues(array){const rowCount=array.isArray()?array.getRowCount():1,columnCount=array.isArray()?array.getColumnCount():1,values=[];for(let r=0;r<rowCount;r++)for(let c=0;c<columnCount;c++){const valueObject=array.isArray()?array.get(r,c):array;if(valueObject.isError())return valueObject;if(valueObject.isNull()||valueObject.isBoolean()||valueObject.isString())continue;const value=valueObject.getValue();(0,src.DMQ)(value)&&values.push(+value)}return 0===values.length?ErrorValueObject.create(error_type_ErrorType.NUM):values.sort(((a,b)=>a-b))}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_STATISTICAL.SMALL],[class Standardize extends base_function_BaseFunction{calculate(x,mean,standardDev){const maxRowLength=Math.max(x.isArray()?x.getRowCount():1,mean.isArray()?mean.getRowCount():1,standardDev.isArray()?standardDev.getRowCount():1),maxColumnLength=Math.max(x.isArray()?x.getColumnCount():1,mean.isArray()?mean.getColumnCount():1,standardDev.isArray()?standardDev.getColumnCount():1),xArray=expandArrayValueObject(maxRowLength,maxColumnLength,x,ErrorValueObject.create(error_type_ErrorType.NA)),meanArray=expandArrayValueObject(maxRowLength,maxColumnLength,mean,ErrorValueObject.create(error_type_ErrorType.NA)),standardDevArray=expandArrayValueObject(maxRowLength,maxColumnLength,standardDev,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=xArray.mapValue(((xObject,rowIndex,columnIndex)=>{const meanObject=meanArray.get(rowIndex,columnIndex),standardDevObject=standardDevArray.get(rowIndex,columnIndex);return xObject.isError()?xObject:meanObject.isError()?meanObject:standardDevObject.isError()?standardDevObject:this._handleSignleObject(xObject,meanObject,standardDevObject)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_handleSignleObject(xObject,meanObject,standardDevObject){const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(xObject,meanObject,standardDevObject);if(isError)return errorObject;const[_xObject,_meanObject,_standardDevObject]=variants,xValue=+_xObject.getValue(),meanValue=+_meanObject.getValue(),standardDevValue=+_standardDevObject.getValue();if(standardDevValue<=0)return ErrorValueObject.create(error_type_ErrorType.NUM);const result=(xValue-meanValue)/standardDevValue;return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=3,this.maxParams=3}},FUNCTION_NAMES_STATISTICAL.STANDARDIZE],[StdevP,FUNCTION_NAMES_STATISTICAL.STDEV_P],[StdevS,FUNCTION_NAMES_STATISTICAL.STDEV_S],[class Stdeva extends base_function_BaseFunction{calculate(...variants){const flattenArray=this.flattenArray(variants,!1);return flattenArray.isError()?flattenArray:flattenArray.std(1)}constructor(...args){super(...args),this.minParams=1,this.maxParams=255}},FUNCTION_NAMES_STATISTICAL.STDEVA],[class Stdevpa extends base_function_BaseFunction{calculate(...variants){const flattenArray=this.flattenArray(variants,!1);return flattenArray.isError()?flattenArray:flattenArray.std()}constructor(...args){super(...args),this.minParams=1,this.maxParams=255}},FUNCTION_NAMES_STATISTICAL.STDEVPA],[class Steyx extends base_function_BaseFunction{calculate(knownYs,knownXs){const knownYsRowCount=knownYs.isArray()?knownYs.getRowCount():1,knownYsColumnCount=knownYs.isArray()?knownYs.getColumnCount():1,knownXsRowCount=knownXs.isArray()?knownXs.getRowCount():1,knownXsColumnCount=knownXs.isArray()?knownXs.getColumnCount():1;let _knownYs=knownYs;if(knownYs.isArray()&&1===knownYsRowCount&&1===knownYsColumnCount&&(_knownYs=knownYs.get(0,0)),_knownYs.isError())return _knownYs;let _knownXs=knownXs;if(knownXs.isArray()&&1===knownXsRowCount&&1===knownXsColumnCount&&(_knownXs=knownXs.get(0,0)),_knownXs.isError())return _knownXs;if((knownYsRowCount*knownYsColumnCount==1||knownXsRowCount*knownXsColumnCount==1)&&(_knownYs.isNull()||_knownXs.isNull()))return ErrorValueObject.create(error_type_ErrorType.VALUE);if(knownYsRowCount*knownYsColumnCount!=knownXsRowCount*knownXsColumnCount)return ErrorValueObject.create(error_type_ErrorType.NA);const{isError,errorObject,array1Values,array2Values,noCalculate}=getTwoArrayNumberValues(knownYs,knownXs,knownYsRowCount*knownYsColumnCount,knownYsColumnCount,knownXsColumnCount);return isError?errorObject:noCalculate?ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO):this._getResult(array1Values,array2Values)}_getResult(knownYs,knownXs){const n=knownYs.length;if(n<=2)return ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO);let knownYsSum=0,knownXsSum=0;for(let i=0;i<n;i++)knownYsSum+=knownYs[i],knownXsSum+=knownXs[i];const knownYsMean=knownYsSum/n,knownXsMean=knownXsSum/n;let num=0,knownYsPowSum=0,knownXsPowSum=0;for(let i=0;i<n;i++)num+=(knownYs[i]-knownYsMean)*(knownXs[i]-knownXsMean),knownYsPowSum+=(knownYs[i]-knownYsMean)**2,knownXsPowSum+=(knownXs[i]-knownXsMean)**2;if(0===knownXsPowSum)return ErrorValueObject.create(error_type_ErrorType.DIV_BY_ZERO);const result=Math.sqrt((knownYsPowSum-num**2/knownXsPowSum)/(n-2));return Number.isNaN(result)||!Number.isFinite(result)?ErrorValueObject.create(error_type_ErrorType.NUM):NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_STATISTICAL.STEYX],[class TDist extends base_function_BaseFunction{calculate(x,degFreedom,cumulative){const maxRowLength=Math.max(x.isArray()?x.getRowCount():1,degFreedom.isArray()?degFreedom.getRowCount():1,cumulative.isArray()?cumulative.getRowCount():1),maxColumnLength=Math.max(x.isArray()?x.getColumnCount():1,degFreedom.isArray()?degFreedom.getColumnCount():1,cumulative.isArray()?cumulative.getColumnCount():1),xArray=expandArrayValueObject(maxRowLength,maxColumnLength,x,ErrorValueObject.create(error_type_ErrorType.NA)),degFreedomArray=expandArrayValueObject(maxRowLength,maxColumnLength,degFreedom,ErrorValueObject.create(error_type_ErrorType.NA)),cumulativeArray=expandArrayValueObject(maxRowLength,maxColumnLength,cumulative,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=xArray.mapValue(((xObject,rowIndex,columnIndex)=>{const degFreedomObject=degFreedomArray.get(rowIndex,columnIndex),cumulativeObject=cumulativeArray.get(rowIndex,columnIndex);return xObject.isError()?xObject:degFreedomObject.isError()?degFreedomObject:cumulativeObject.isError()?cumulativeObject:this._handleSignleObject(xObject,degFreedomObject,cumulativeObject)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_handleSignleObject(xObject,degFreedomObject,cumulativeObject){const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(xObject,degFreedomObject,cumulativeObject);if(isError)return errorObject;const[_xObject,_degFreedomObject,_cumulativeObject]=variants,xValue=+_xObject.getValue(),degFreedomValue=Math.floor(+_degFreedomObject.getValue()),cumulativeValue=+_cumulativeObject.getValue();if(degFreedomValue<1)return ErrorValueObject.create(error_type_ErrorType.NUM);let result;return result=cumulativeValue?studentTCDF(xValue,degFreedomValue):function studentTPDF(x,degFreedom){const pow=(1+x**2/degFreedom)**(-(degFreedom+1)/2);return 1/(Math.sqrt(degFreedom)*betaFunction(.5,degFreedom/2))*pow}(xValue,degFreedomValue),Number.isNaN(result)||!Number.isFinite(result)?ErrorValueObject.create(error_type_ErrorType.NUM):NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=3,this.maxParams=3}},FUNCTION_NAMES_STATISTICAL.T_DIST],[class TDist2t extends base_function_BaseFunction{calculate(x,degFreedom){const maxRowLength=Math.max(x.isArray()?x.getRowCount():1,degFreedom.isArray()?degFreedom.getRowCount():1),maxColumnLength=Math.max(x.isArray()?x.getColumnCount():1,degFreedom.isArray()?degFreedom.getColumnCount():1),xArray=expandArrayValueObject(maxRowLength,maxColumnLength,x,ErrorValueObject.create(error_type_ErrorType.NA)),degFreedomArray=expandArrayValueObject(maxRowLength,maxColumnLength,degFreedom,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=xArray.mapValue(((xObject,rowIndex,columnIndex)=>{const degFreedomObject=degFreedomArray.get(rowIndex,columnIndex);return xObject.isError()?xObject:degFreedomObject.isError()?degFreedomObject:this._handleSignleObject(xObject,degFreedomObject)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_handleSignleObject(xObject,degFreedomObject){const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(xObject,degFreedomObject);if(isError)return errorObject;const[_xObject,_degFreedomObject]=variants,xValue=+_xObject.getValue(),degFreedomValue=Math.floor(+_degFreedomObject.getValue());if(xValue<0||degFreedomValue<1||degFreedomValue>10**10)return ErrorValueObject.create(error_type_ErrorType.NUM);const result=2*studentTCDF(-xValue,degFreedomValue);return Number.isNaN(result)||!Number.isFinite(result)?ErrorValueObject.create(error_type_ErrorType.NUM):NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_STATISTICAL.T_DIST_2T],[class TDistRt extends base_function_BaseFunction{calculate(x,degFreedom){const maxRowLength=Math.max(x.isArray()?x.getRowCount():1,degFreedom.isArray()?degFreedom.getRowCount():1),maxColumnLength=Math.max(x.isArray()?x.getColumnCount():1,degFreedom.isArray()?degFreedom.getColumnCount():1),xArray=expandArrayValueObject(maxRowLength,maxColumnLength,x,ErrorValueObject.create(error_type_ErrorType.NA)),degFreedomArray=expandArrayValueObject(maxRowLength,maxColumnLength,degFreedom,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=xArray.mapValue(((xObject,rowIndex,columnIndex)=>{const degFreedomObject=degFreedomArray.get(rowIndex,columnIndex);return xObject.isError()?xObject:degFreedomObject.isError()?degFreedomObject:this._handleSignleObject(xObject,degFreedomObject)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_handleSignleObject(xObject,degFreedomObject){const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(xObject,degFreedomObject);if(isError)return errorObject;const[_xObject,_degFreedomObject]=variants,xValue=+_xObject.getValue(),degFreedomValue=Math.floor(+_degFreedomObject.getValue());if(degFreedomValue<1||degFreedomValue>10**10)return ErrorValueObject.create(error_type_ErrorType.NUM);const result=studentTCDF(-xValue,degFreedomValue);return Number.isNaN(result)||!Number.isFinite(result)?ErrorValueObject.create(error_type_ErrorType.NUM):NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_STATISTICAL.T_DIST_RT],[class TInv extends base_function_BaseFunction{calculate(probability,degFreedom){const maxRowLength=Math.max(probability.isArray()?probability.getRowCount():1,degFreedom.isArray()?degFreedom.getRowCount():1),maxColumnLength=Math.max(probability.isArray()?probability.getColumnCount():1,degFreedom.isArray()?degFreedom.getColumnCount():1),probabilityArray=expandArrayValueObject(maxRowLength,maxColumnLength,probability,ErrorValueObject.create(error_type_ErrorType.NA)),degFreedomArray=expandArrayValueObject(maxRowLength,maxColumnLength,degFreedom,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=probabilityArray.mapValue(((probabilityObject,rowIndex,columnIndex)=>{const degFreedomObject=degFreedomArray.get(rowIndex,columnIndex);return probabilityObject.isError()?probabilityObject:degFreedomObject.isError()?degFreedomObject:this._handleSignleObject(probabilityObject,degFreedomObject)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_handleSignleObject(probabilityObject,degFreedomObject){const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(probabilityObject,degFreedomObject);if(isError)return errorObject;const[_probabilityObject,_degFreedomObject]=variants,probabilityValue=+_probabilityObject.getValue(),degFreedomValue=Math.floor(+_degFreedomObject.getValue());if(probabilityValue<=0||probabilityValue>1||degFreedomValue<1||degFreedomValue>10**10)return ErrorValueObject.create(error_type_ErrorType.NUM);const result=studentTINV(probabilityValue,degFreedomValue);return Number.isNaN(result)||!Number.isFinite(result)?ErrorValueObject.create(error_type_ErrorType.NUM):NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_STATISTICAL.T_INV],[TInv2t,FUNCTION_NAMES_STATISTICAL.T_INV_2T],[TTest,FUNCTION_NAMES_STATISTICAL.T_TEST],[class Trend extends base_function_BaseFunction{calculate(knownYs,knownXs,newXs,constb){const{isError,errorObject}=checkKnownsArrayDimensions(knownYs,knownXs,newXs);if(isError)return errorObject;const knownYsValues=getKnownsArrayValues(knownYs);if(knownYsValues instanceof ErrorValueObject)return knownYsValues;const knownXsValues=this._getKnownXsValues(knownYsValues,knownXs);if(knownXsValues instanceof ErrorValueObject)return knownXsValues;const newXsValues=this._getNewXsValues(knownXsValues,newXs);if(newXsValues instanceof ErrorValueObject)return newXsValues;let _constb=constb??BooleanValueObject.create(!0);if(_constb.isArray()&&(_constb=_constb.get(0,0)),_constb.isString()&&(_constb=_constb.convertToNumberObjectValue()),_constb.isError())return _constb;const constbValue=+_constb.getValue();return this._getResult(knownYsValues,knownXsValues,newXsValues,constbValue)}_getResult(knownYsValues,knownXsValues,newXsValues,constb){if(1===knownYsValues.length&&knownXsValues.length>1||1===knownYsValues[0].length&&knownXsValues[0].length>1){if(1===knownYsValues.length&&knownXsValues.length>1){if((constb?knownXsValues.length+1:knownXsValues.length)>knownYsValues[0].length)return ErrorValueObject.create(error_type_ErrorType.NA)}if(1===knownYsValues[0].length&&knownXsValues[0].length>1){if((constb?knownXsValues[0].length+1:knownXsValues[0].length)>knownYsValues.length)return ErrorValueObject.create(error_type_ErrorType.NA)}return this._getResultByMultipleVariables(knownYsValues,knownXsValues,newXsValues,constb)}return this._getResultBySimpleVariables(knownYsValues,knownXsValues,newXsValues,constb)}_getResultByMultipleVariables(knownYsValues,knownXsValues,newXsValues,constb){const isOneRow=1===knownYsValues.length&&knownYsValues[0].length>1,_coefficients=getKnownsArrayCoefficients(knownYsValues,knownXsValues,newXsValues,constb,!1);if(_coefficients instanceof ErrorValueObject)return _coefficients;const{coefficients,newX}=_coefficients,cl=coefficients[0].length,b=coefficients[0][cl-1];let result=[];for(let i=0;i<newX.length;i++){result[i]=[];let value=b;for(let j=cl-2;j>=0;j--)value+=coefficients[0][cl-2-j]*newX[i][j];result[i].push(value)}return isOneRow&&(result=matrixTranspose(result)),ArrayValueObject.createByArray(result)}_getResultBySimpleVariables(knownYsValues,knownXsValues,newXsValues,constb){const knownYsValuesFlat=knownYsValues.flat(),knownXsValuesFlat=knownXsValues.flat(),{slope:m,intercept:b}=getSlopeAndIntercept(knownXsValuesFlat,knownYsValuesFlat,constb,!1);if(Number.isNaN(m))return ErrorValueObject.create(error_type_ErrorType.NA);const result=newXsValues.map((row=>row.map((value=>m*value+b))));return ArrayValueObject.createByArray(result)}_getKnownXsValues(knownYsValues,knownXs){return!knownXs||knownXs.isNull()?getSerialNumbersByRowsColumns(knownYsValues.length,knownYsValues[0].length):getKnownsArrayValues(knownXs)}_getNewXsValues(knownXsValues,newXs){return!newXs||newXs.isNull()?knownXsValues:getKnownsArrayValues(newXs)}constructor(...args){super(...args),this.minParams=1,this.maxParams=4}},FUNCTION_NAMES_STATISTICAL.TREND],[class Trimmean extends base_function_BaseFunction{calculate(array,percent){const arrayValues=this._getValues(array);if(percent.isArray()){const resultArray=percent.mapValue((percentObject=>this._handleSingleObject(arrayValues,percentObject)));return 1===resultArray.getRowCount()&&1===resultArray.getColumnCount()?resultArray.get(0,0):resultArray}return this._handleSingleObject(arrayValues,percent)}_handleSingleObject(array,percent){if(array instanceof ErrorValueObject)return array;const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(percent);if(isError)return errorObject;const[percentObject]=variants,percentValue=+percentObject.getValue();if(percentValue<0||percentValue>=1)return ErrorValueObject.create(error_type_ErrorType.NUM);const count=2*floor(array.length*percentValue/2,0),newArray=array.slice(count/2,array.length-count/2),result=newArray.reduce(((acc,cur)=>acc+cur),0)/newArray.length;return NumberValueObject.create(result)}_getValues(array){const rowCount=array.isArray()?array.getRowCount():1,columnCount=array.isArray()?array.getColumnCount():1,values=[];for(let r=0;r<rowCount;r++)for(let c=0;c<columnCount;c++){const valueObject=array.isArray()?array.get(r,c):array;if(valueObject.isError())return valueObject;if(valueObject.isNull()||valueObject.isBoolean())continue;const value=valueObject.getValue();(0,src.DMQ)(value)&&values.push(+value)}return 0===values.length?ErrorValueObject.create(error_type_ErrorType.NUM):values.sort(((a,b)=>a-b))}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_STATISTICAL.TRIMMEAN],[VarP,FUNCTION_NAMES_STATISTICAL.VAR_P],[VarS,FUNCTION_NAMES_STATISTICAL.VAR_S],[class Vara extends base_function_BaseFunction{calculate(...variants){const flattenArray=this.flattenArray(variants,!1);return flattenArray.isError()?flattenArray:flattenArray.var(1)}constructor(...args){super(...args),this.minParams=1,this.maxParams=255}},FUNCTION_NAMES_STATISTICAL.VARA],[class Varpa extends base_function_BaseFunction{calculate(...variants){const flattenArray=this.flattenArray(variants,!1);return flattenArray.isError()?flattenArray:flattenArray.var()}constructor(...args){super(...args),this.minParams=1,this.maxParams=255}},FUNCTION_NAMES_STATISTICAL.VARPA],[WeibullDist,FUNCTION_NAMES_STATISTICAL.WEIBULL_DIST],[ZTest,FUNCTION_NAMES_STATISTICAL.Z_TEST]];const filterCodeArray=Object.values(src.gqw).filter((value=>[src.gqw.TABLE_START,src.gqw.TABLE_ROW_START,src.gqw.TABLE_CELL_START,src.gqw.TABLE_CELL_END,src.gqw.TABLE_ROW_END,src.gqw.TABLE_END,src.gqw.CUSTOM_BLOCK].includes(value)));const getFormatPreview=(pattern,value)=>src.gIL.format(pattern,value,{throws:!1}),getTextValueOfNumberFormat=text=>{let textValue=`${text.getValue()}`;return text.isNull()&&(textValue=""),text.isBoolean()&&(textValue=textValue.toLocaleUpperCase()),text.isNumber()&&(textValue=""!==text.getPattern()?getFormatPreview(text.getPattern(),+text.getValue()):`${stripErrorMargin(+text.getValue())}`),textValue};function charLenByte(text){let byteCount=0;for(let i=0;i<text.length;i++)byteCount+=getCharLenByteInText(text,i);return byteCount}function getCharLenByteInText(text,charIndex,direction="ltr"){const codePoint=function getCodePoint(str,index,direction="ltr"){const charCode=str.charCodeAt(index);if("ltr"===direction&&highSurrogate(charCode)&&index+1<str.length){const nextCharCode=str.charCodeAt(index+1);if(lowSurrogate(nextCharCode))return surrogatePair(charCode,nextCharCode)}if("rtl"===direction&&lowSurrogate(charCode)&&index-1>=0){const prevCharCode=str.charCodeAt(index-1);if(highSurrogate(prevCharCode))return surrogatePair(prevCharCode,charCode)}return charCode}(text,charIndex,direction);return codePoint>255?2:1}function highSurrogate(charCode){return charCode>=55296&&charCode<=56319}function lowSurrogate(charCode){return charCode>=56320&&charCode<=57343}function surrogatePair(highSurrogate,lowSurrogate){return((1023&highSurrogate)<<10)+(1023&lowSurrogate)+65536}const chineseLowercaseNumbers=["〇","一","二","三","四","五","六","七","八","九"],chineseUppercaseNumbers=["零","壹","贰","叁","肆","伍","陆","柒","捌","玖"],chineseLowercaseUnits=["","十","百","千"],chineseUppercaseUnits=["","拾","佰","仟"],suffixUnits=["","万","亿","兆"];function tokenizer(regExpString){const root={type:0,stack:[]};let currentScope=root,stack=root.stack;const groups=[],references=[];let captureCount=0;const throwError=index=>{throw new SyntaxError(`Invalid regular expression: /${regExpString}/: Nothing to repeat at column ${index-1}`)},strChars=function strToChars(str){return str.replace(/(\[\\b\])|(\\)?\\(?:u([A-F0-9]{4})|x([A-F0-9]{2})|c([@A-Z[\\\]^?])|([0tnvfr]))/g,((match,backspace,escapeChar,unicode,hex,ctrl,special)=>{if(escapeChar)return match;let charCode;if(backspace)charCode=8;else if(unicode)charCode=Number.parseInt(unicode,16);else if(hex)charCode=Number.parseInt(hex,16);else if(ctrl)charCode="@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^ ?".indexOf(ctrl);else{charCode={0:0,t:9,n:10,v:11,f:12,r:13}[special]}const char=String.fromCharCode(charCode);return/[[\]{}^$.|?*+()]/.test(char)?`\\${char}`:char}))}(regExpString);let char,i=0;for(;i<strChars.length;)switch(char=strChars[i++],char){case"\\":if(i===strChars.length)throw new SyntaxError(`Invalid regular expression: /${regExpString}/: \\ at end of pattern`);switch(char=strChars[i++],char){case"b":stack.push({type:2,value:"b"});break;case"B":stack.push({type:2,value:"B"});break;case"w":stack.push({type:3,set:[{type:7,value:95},{type:4,from:97,to:122},{type:4,from:65,to:90},{type:4,from:48,to:57}],not:!1});break;case"W":stack.push({type:3,set:[{type:7,value:95},{type:4,from:97,to:122},{type:4,from:65,to:90},{type:4,from:48,to:57}],not:!0});break;case"d":stack.push({type:3,set:[{type:4,from:48,to:57}],not:!1});break;case"D":stack.push({type:3,set:[{type:4,from:48,to:57}],not:!0});break;case"s":stack.push({type:3,set:[{type:7,value:9},{type:7,value:10},{type:7,value:11},{type:7,value:12},{type:7,value:13},{type:7,value:32},{type:7,value:160},{type:7,value:5760},{type:4,from:8192,to:8202},{type:7,value:8232},{type:7,value:8233},{type:7,value:8239},{type:7,value:8287},{type:7,value:12288},{type:7,value:65279}],not:!1});break;case"S":stack.push({type:3,set:[{type:7,value:9},{type:7,value:10},{type:7,value:11},{type:7,value:12},{type:7,value:13},{type:7,value:32},{type:7,value:160},{type:7,value:5760},{type:4,from:8192,to:8202},{type:7,value:8232},{type:7,value:8233},{type:7,value:8239},{type:7,value:8287},{type:7,value:12288},{type:7,value:65279}],not:!0});break;default:if(/\d/.test(char)){for(;/\d/.test(strChars[i])&&i<strChars.length;)char+=strChars[i++];const num=Number.parseInt(char,10);stack.push({type:6,value:num}),references.push({reference:{type:6,value:num},stack,index:stack.length-1})}else stack.push({type:7,value:char.charCodeAt(0)})}break;case"^":stack.push({type:2,value:"^"});break;case"$":stack.push({type:2,value:"$"});break;case"[":{const negated="^"===strChars[i];negated&&i++;const classTokens=tokenizeClass(strChars.slice(i),regExpString);i+=classTokens[1],stack.push({type:3,set:classTokens[0],not:negated});break}case".":stack.push({type:3,set:[{type:7,value:10},{type:7,value:13},{type:7,value:8232},{type:7,value:8233}],not:!0});break;case"(":{const group={type:1,stack:[],remember:!0};if("?"===strChars[i]){const nextChar=strChars[i+1];if(i+=2,"="===nextChar)group.followedBy=!0;else if("!"===nextChar)group.notFollowedBy=!0;else if(":"!==nextChar)throw new SyntaxError(`Invalid regular expression: /${regExpString}/: Invalid group, character '${nextChar}' after '?' at column ${i-1}`);group.remember=!1}else captureCount+=1;stack.push(group),groups.push(currentScope),currentScope=group,stack=group.stack;break}case")":if(0===groups.length)throw new SyntaxError(`Invalid regular expression: /${regExpString}/: Unmatched ) at column ${i-1}`);currentScope=groups.pop(),stack=currentScope.options?currentScope.options[currentScope.options.length-1]:currentScope.stack;break;case"|":{currentScope.options||(currentScope.options=[currentScope.stack],delete currentScope.stack);const newOption=[];currentScope.options.push(newOption),stack=newOption;break}case"{":{const match=/^(\d+)(,(\d+)?)?\}/.exec(strChars.slice(i));if(match){0===stack.length&&throwError(i);const min=Number.parseInt(match[1],10),max=match[2]?match[3]?Number.parseInt(match[3],10):1/0:min;i+=match[0].length,stack.push({type:5,min,max,value:stack.pop()})}else stack.push({type:7,value:123});break}case"?":0===stack.length&&throwError(i),stack.push({type:5,min:0,max:1,value:stack.pop()});break;case"+":0===stack.length&&throwError(i),stack.push({type:5,min:1,max:1/0,value:stack.pop()});break;case"*":0===stack.length&&throwError(i),stack.push({type:5,min:0,max:1/0,value:stack.pop()});break;default:stack.push({type:7,value:char.charCodeAt(0)})}if(groups.length>0)throw new SyntaxError(`Invalid regular expression: /${regExpString}/: Unterminated group`);return function processReferences(references,captureCount){for(const ref of references.reverse()){const value=ref.reference.value;if(captureCount<value){ref.reference.type=7;const valueStr=value.toString();if(ref.reference.value=Number.parseInt(valueStr,8),!/^[0-7]+$/.test(valueStr)){let startIndex=0;for(;"8"!==valueStr[startIndex]&&"9"!==valueStr[startIndex]&&startIndex<valueStr.length;)startIndex+=1;if(0===startIndex?(ref.reference.value=valueStr.charCodeAt(0),startIndex+=1):ref.reference.value=Number.parseInt(valueStr.slice(0,startIndex),8),valueStr.length>startIndex){const remainingStack=ref.stack.splice(ref.index+1);for(const char of valueStr.slice(startIndex))ref.stack.push({type:7,value:char.charCodeAt(0)});ref.stack.push(...remainingStack)}}}}}(references,captureCount),root}function tokenizeClass(input,pattern){let match;const tokens=[],regex=/\\(?:(w)|(d)|(s)|(W)|(D)|(S))|((?:(?:\\)(.)|([^\]\\]))-(((?:\\)])|(((?:\\)?([^\]])))))|(\])|(?:\\)?([^])/g;for(;null!==(match=regex.exec(input));){let token=null;const[,_words,_digit,_space,_notWords,_notDigit,_notSpace,range,rangeFrom,rangeTo,char]=match;if(_words||_digit||_space||_notWords||_notDigit||_notSpace?token=(()=>{let result={type:3,set:[],not:!1};return _words?result={type:3,set:[{type:7,value:95},{type:4,from:97,to:122},{type:4,from:65,to:90},{type:4,from:48,to:57}],not:!1}:_digit?result={type:3,set:[{type:4,from:48,to:57}],not:!1}:_space?result={type:3,set:[{type:7,value:9},{type:7,value:10},{type:7,value:11},{type:7,value:12},{type:7,value:13},{type:7,value:32},{type:7,value:160},{type:7,value:5760},{type:4,from:8192,to:8202},{type:7,value:8232},{type:7,value:8233},{type:7,value:8239},{type:7,value:8287},{type:7,value:12288},{type:7,value:65279}],not:!1}:_notWords?result={type:3,set:[{type:7,value:95},{type:4,from:97,to:122},{type:4,from:65,to:90},{type:4,from:48,to:57}],not:!0}:_notDigit?result={type:3,set:[{type:4,from:48,to:57}],not:!0}:_notSpace&&(result={type:3,set:[{type:7,value:9},{type:7,value:10},{type:7,value:11},{type:7,value:12},{type:7,value:13},{type:7,value:32},{type:7,value:160},{type:7,value:5760},{type:4,from:8192,to:8202},{type:7,value:8232},{type:7,value:8233},{type:7,value:8239},{type:7,value:8287},{type:7,value:12288},{type:7,value:65279}],not:!0}),result})():range&&char?token={type:4,from:(rangeFrom||rangeTo).charCodeAt(0),to:char.charCodeAt(char.length-1)}:match[16]&&(token={type:7,value:match[16].charCodeAt(0)}),!token)return[tokens,regex.lastIndex];tokens.push(token)}throw new SyntaxError(`Invalid regular expression: /${pattern}/: Unterminated character class`)}function handleRegExp(regExpString,isGlobal){if(!function isValidRegExp(regExpString){return!(/\(\?<=.*?\)/g.test(regExpString)&&!/\[.*?(\?<=.*?)\]/g.test(regExpString)||/\(\?<!.*?\)/g.test(regExpString)&&!/\[.*?(\?<!.*?)\]/g.test(regExpString))}(regExpString))return{isError:!0,regExp:null};try{const regExp=new RegExp(regExpString,isGlobal?"ug":"u");return function isSafeRegExp(regExp,options){const limit=options?.limit??25;let str,tokens;"[object RegExp]"===Object.prototype.toString.call(regExp)?str=regExp.source:regExp&&"string"!=typeof regExp&&(str=`${regExp}`);try{tokens=tokenizer(str)}catch(error){return!1}let count=0;const validateToken=(token,depth)=>{let _depth=depth;if(5===token.type){if(_depth++,count++,_depth>1)return!1;if(count>limit)return!1}if(token.options)for(const option of token.options){if(!validateToken({stack:option},_depth))return!1}const stack=token.stack||token.value&&token.value.stack;if(!stack)return!0;for(const item of stack){if(!validateToken(item,_depth))return!1}return!0};return validateToken(tokens,0)}(regExp)?{isError:!1,regExp}:{isError:!0,regExp:null}}catch(error){return{isError:!0,regExp:null}}}const unichar_filterCodeArray=Object.values(src.gqw).filter((value=>[src.gqw.TABLE_START,src.gqw.TABLE_ROW_START,src.gqw.TABLE_CELL_START,src.gqw.TABLE_CELL_END,src.gqw.TABLE_ROW_END,src.gqw.TABLE_END,src.gqw.CUSTOM_BLOCK].includes(value)));const functionText=[[class Asc extends base_function_BaseFunction{calculate(text){if(text.isArray()){const resultArray=text.mapValue((textObject=>this._handleSingleObject(textObject)));return 1===resultArray.getRowCount()&&1===resultArray.getColumnCount()?resultArray.get(0,0):resultArray}return this._handleSingleObject(text)}_handleSingleObject(text){if(text.isError()||text.isNull()||text.isBoolean()||text.isNumber())return text;const textValue=text.getValue().toLocaleString();let result="";for(let i=0;i<textValue.length;i++){let charCode=textValue.charCodeAt(i);12288===charCode?charCode=32:charCode>=65281&&charCode<=65374&&(charCode-=65248),result+=String.fromCharCode(charCode)}return StringValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_TEXT.ASC],[class Arraytotext extends base_function_BaseFunction{calculate(array,format){let _format=format??NumberValueObject.create(0);if(format?.isNull()&&(_format=NumberValueObject.create(0)),_format.isArray()){const resultArray=_format.mapValue((formatObject=>this._handleSingleObject(array,formatObject)));return 1===resultArray.getRowCount()&&1===resultArray.getColumnCount()?resultArray.get(0,0):resultArray}return this._handleSingleObject(array,_format)}_handleSingleObject(array,format){const _array=this._checkArray(array);if(_array.isError())return _array;const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(format);if(isError)return errorObject;const[formatObject]=variants,formatValue=+formatObject.getValue(),arrayRowCount=array.isArray()?array.getRowCount():1,arrayColumnCount=array.isArray()?array.getColumnCount():1;let result="";for(let r=0;r<arrayRowCount;r++)for(let c=0;c<arrayColumnCount;c++){const valueObject=array.isArray()?array.get(r,c):array;let value=`${valueObject.getValue()}`;valueObject.isNull()&&(value=""),valueObject.isBoolean()&&(value=value.toLocaleUpperCase()),valueObject.isString()&&formatValue?result+=`"${value}"`:result+=value,r===arrayRowCount-1&&c===arrayColumnCount-1||(result+=formatValue?c===arrayColumnCount-1?";":",":", ")}return formatValue&&(result=`{${result}}`),result.length>32767?ErrorValueObject.create(error_type_ErrorType.CALC):StringValueObject.create(result)}_checkArray(array){if(array.isArray()){const arrayRowCount=array.getRowCount(),arrayColumnCount=array.getColumnCount();return arrayRowCount>1||arrayColumnCount>1?array:array.get(0,0)}return array}constructor(...args){super(...args),this.minParams=1,this.maxParams=2}},FUNCTION_NAMES_TEXT.ARRAYTOTEXT],[class Bahttext extends base_function_BaseFunction{calculate(number){if(number.isArray()){const resultArray=number.mapValue((numberObject=>this._handleSingleObject(numberObject)));return 1===resultArray.getRowCount()&&1===resultArray.getColumnCount()?resultArray.get(0,0):resultArray}return this._handleSingleObject(number)}_handleSingleObject(number){const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(number);if(isError)return errorObject;const[numberObject]=variants,numberValue=+numberObject.getValue(),integerPart=Math.abs(Number.parseInt(numberValue.toString(),10)),decimalPart=Number.parseFloat((Math.abs(numberValue)-integerPart).toFixed(2));let result="";return result=0===integerPart?0!==decimalPart?`${numberValue<0?"ลบ":""}${this._convertNumberToThaiText(100*decimalPart)}สตางค์`:"ศูนย์บาทถ้วน":0===decimalPart?`${numberValue<0?"ลบ":""}${this._convertNumberToThaiText(integerPart)}บาทถ้วน`:`${numberValue<0?"ลบ":""}${this._convertNumberToThaiText(integerPart)}บาท${this._convertNumberToThaiText(100*decimalPart)}สตางค์`,StringValueObject.create(result)}_convertNumberToThaiText(number){const units=["ล้าน","สิบ","ร้อย","พัน","หมื่น","แสน",""],digits=["ศูนย์","หนึ่ง","สอง","สาม","สี่","ห้า","หก","เจ็ด","แปด","เก้า"],special=["ลบ","บาท","ถ้วน","สตางค์","ยี่","เอ็ด",","," ","฿"],numberText=number.toString(),n=numberText.length;let result="";for(let i=n;i>0;i--){const digit=Number.parseInt(numberText.charAt(n-i),10);let digitText=digits[digit];const position=i>1?(i-1)%6:6;if(1===position&&2===digit&&(digitText=special[4]),1===digit)switch(position){case 0:case 6:result+=i<n?special[5]:digitText;break;case 1:break;default:result+=digitText}else{if(0===digit){0===position&&(result+=units[position]);continue}result+=digitText}result+=units[position]}return result}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_TEXT.BAHTTEXT],[class Char extends base_function_BaseFunction{calculate(number){if(number.isArray()){const resultArray=number.mapValue((numberObject=>this._handleSingleObject(numberObject)));return 1===resultArray.getRowCount()&&1===resultArray.getColumnCount()?resultArray.get(0,0):resultArray}return this._handleSingleObject(number)}_handleSingleObject(number){const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(number);if(isError)return errorObject;const[numberObject]=variants,numberValue=Math.floor(+numberObject.getValue());if(numberValue<=0)return ErrorValueObject.create(error_type_ErrorType.VALUE);let result=String.fromCharCode(numberValue);return filterCodeArray.some((value=>value===result))&&(result=String.fromCharCode(1)),StringValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_TEXT.CHAR],[class Clean extends base_function_BaseFunction{calculate(text){if(text.isArray()){const resultArray=text.mapValue((textObject=>this._handleSingleObject(textObject)));return 1===resultArray.getRowCount()&&1===resultArray.getColumnCount()?resultArray.get(0,0):resultArray}return this._handleSingleObject(text)}_handleSingleObject(text){if(text.isError()||text.isBoolean()||text.isNumber())return text;if(text.isNull())return StringValueObject.create("");const result=`${text.getValue()}`.replace(/[\0-\x1F]/g,"");return StringValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_TEXT.CLEAN],[class Code extends base_function_BaseFunction{calculate(text){if(text.isArray()){const resultArray=text.mapValue((textObject=>this._handleSingleObject(textObject)));return 1===resultArray.getRowCount()&&1===resultArray.getColumnCount()?resultArray.get(0,0):resultArray}return this._handleSingleObject(text)}_handleSingleObject(text){if(text.isError())return text;if(text.isNull())return ErrorValueObject.create(error_type_ErrorType.VALUE);let textValue=text.getValue().toLocaleString();if(text.isBoolean()&&(textValue=textValue.toLocaleUpperCase()),""===textValue)return ErrorValueObject.create(error_type_ErrorType.VALUE);const result=textValue.charCodeAt(0);return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_TEXT.CODE],[class Concat extends base_function_BaseFunction{calculate(...textValues){let concatenatedString="",isError=null;for(const textValue of textValues)if(textValue.isArray()){if(textValue.iterator((valueObject=>!(null!=valueObject&&!valueObject.isNull())||(valueObject.isError()?(isError=valueObject,!1):void(valueObject.isBoolean()?concatenatedString+=`${valueObject.getValue()}`.toLocaleUpperCase():(valueObject.isString()||valueObject.isNumber())&&(concatenatedString+=valueObject.getValue()))))),isError)return isError}else textValue.isError()||textValue.isNull()||(concatenatedString+=textValue.getValue());return StringValueObject.create(concatenatedString)}constructor(...args){super(...args),this.minParams=1,this.maxParams=255}},FUNCTION_NAMES_TEXT.CONCAT],[class Concatenate extends base_function_BaseFunction{calculate(...textValues){let maxRowLength=0,maxColumnLength=0;textValues.forEach((textValue=>{if(textValue.isArray()){const arrayValue=textValue;maxRowLength=Math.max(maxRowLength,arrayValue.getRowCount()),maxColumnLength=Math.max(maxColumnLength,arrayValue.getColumnCount())}else maxRowLength=Math.max(maxRowLength,1),maxColumnLength=Math.max(maxColumnLength,1)}));let result=null;for(const textValue of textValues){const textValueArray=expandArrayValueObject(maxRowLength,maxColumnLength,textValue,ErrorValueObject.create(error_type_ErrorType.NA));result=textValueArray.mapValue(((textValueObject,rowIndex,columnIndex)=>{const resultValueObject=result&&result.get(rowIndex,columnIndex);if(resultValueObject?.isError())return resultValueObject;if(textValueObject.isError())return textValueObject;let resultValue=resultValueObject?.getValue(),textValue=textValueObject?.getValue();resultValueObject?.isBoolean()&&(resultValue=`${resultValue}`.toLocaleUpperCase()),textValueObject?.isBoolean()&&(textValue=`${textValue}`.toLocaleUpperCase());const resultValueObjectString=resultValueObject?.isNull()?"":resultValue??"",textValueObjectString=textValueObject?.isNull()?"":textValue??"";return StringValueObject.create(`${resultValueObjectString}${textValueObjectString}`)}))}return result||ErrorValueObject.create(error_type_ErrorType.VALUE)}constructor(...args){super(...args),this.minParams=1,this.maxParams=255}},FUNCTION_NAMES_TEXT.CONCATENATE],[class Dbcs extends base_function_BaseFunction{calculate(text){if(text.isArray()){const resultArray=text.mapValue((textObject=>this._handleSingleObject(textObject)));return 1===resultArray.getRowCount()&&1===resultArray.getColumnCount()?resultArray.get(0,0):resultArray}return this._handleSingleObject(text)}_handleSingleObject(text){if(text.isError())return text;if(text.isNull())return StringValueObject.create("");let textValue=`${text.getValue()}`;text.isBoolean()&&(textValue=textValue.toLocaleUpperCase());let result="";for(let i=0;i<textValue.length;i++){const char=textValue.charCodeAt(i);result+=char>=33&&char<=126?String.fromCharCode(char+65248):32===char?String.fromCharCode(12288):textValue.charAt(i)}return StringValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_TEXT.DBCS],[class Dollar extends base_function_BaseFunction{calculate(number,decimals){let _decimals=decimals??NumberValueObject.create(2);_decimals.isNull()&&(_decimals=NumberValueObject.create(2));const maxRowLength=Math.max(number.isArray()?number.getRowCount():1,_decimals.isArray()?_decimals.getRowCount():1),maxColumnLength=Math.max(number.isArray()?number.getColumnCount():1,_decimals.isArray()?_decimals.getColumnCount():1),numberArray=expandArrayValueObject(maxRowLength,maxColumnLength,number,ErrorValueObject.create(error_type_ErrorType.NA)),decimalsArray=expandArrayValueObject(maxRowLength,maxColumnLength,_decimals,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=numberArray.mapValue(((numberObject,rowIndex,columnIndex)=>{const decimalsObject=decimalsArray.get(rowIndex,columnIndex);return numberObject.isError()?numberObject:decimalsObject.isError()?decimalsObject:this._handleSingleObject(numberObject,decimalsObject)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_handleSingleObject(number,decimals){const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(number,decimals);if(isError)return errorObject;const[numberObject,decimalsObject]=variants;let numberValue=+numberObject.getValue(),decimalsValue=Math.trunc(+decimalsObject.getValue());if(decimalsValue>127)return ErrorValueObject.create(error_type_ErrorType.VALUE);decimalsValue<0&&(numberValue=`${numberValue}`.length<Math.abs(decimalsValue)?0:numberValue<0?-round(Math.abs(numberValue),decimalsValue):round(numberValue,decimalsValue),decimalsValue=0);const result=function applyCurrencyFormat(locale,number,numberDigits=2){return src.gIL.format(getCurrencyFormat(locale,numberDigits),number)}(this.getLocale(),numberValue,decimalsValue);return StringValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=2,this.needsLocale=!0}},FUNCTION_NAMES_TEXT.DOLLAR],[class Exact extends base_function_BaseFunction{calculate(text1,text2){const maxRowLength=Math.max(text1.isArray()?text1.getRowCount():1,text2.isArray()?text2.getRowCount():1),maxColumnLength=Math.max(text1.isArray()?text1.getColumnCount():1,text2.isArray()?text2.getColumnCount():1),text1Array=expandArrayValueObject(maxRowLength,maxColumnLength,text1,NullValueObject.create()),text2Array=expandArrayValueObject(maxRowLength,maxColumnLength,text2,NullValueObject.create()),resultArray=text1Array.mapValue(((text1Object,rowIndex,columnIndex)=>{const text2Object=text2Array.get(rowIndex,columnIndex);return text1Object.isError()?text1Object:text2Object.isError()?text2Object:this._handleSingleObject(text1Object,text2Object)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_handleSingleObject(text1,text2){if(text1.isNull()||text2.isNull()){const result=text1.isNull()&&text2.isNull();return BooleanValueObject.create(result)}let text1Value=`${text1.getValue()}`;text1.isBoolean()&&(text1Value=text1Value.toLocaleUpperCase());let text2Value=`${text2.getValue()}`;text2.isBoolean()&&(text2Value=text2Value.toLocaleUpperCase());const result=text1Value===text2Value;return BooleanValueObject.create(result)}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_TEXT.EXACT],[class Find extends base_function_BaseFunction{calculate(findText,withinText,startNum){const _startNum=startNum??NumberValueObject.create(1),maxRowLength=Math.max(findText.isArray()?findText.getRowCount():1,withinText.isArray()?withinText.getRowCount():1,_startNum.isArray()?_startNum.getRowCount():1),maxColumnLength=Math.max(findText.isArray()?findText.getColumnCount():1,withinText.isArray()?withinText.getColumnCount():1,_startNum.isArray()?_startNum.getColumnCount():1),findTextArray=expandArrayValueObject(maxRowLength,maxColumnLength,findText,ErrorValueObject.create(error_type_ErrorType.NA)),withinTextArray=expandArrayValueObject(maxRowLength,maxColumnLength,withinText,ErrorValueObject.create(error_type_ErrorType.NA)),startNumArray=expandArrayValueObject(maxRowLength,maxColumnLength,_startNum,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=findTextArray.mapValue(((findTextObject,rowIndex,columnIndex)=>{const withinTextObject=withinTextArray.get(rowIndex,columnIndex),startNumObject=startNumArray.get(rowIndex,columnIndex);return findTextObject.isError()?findTextObject:withinTextObject.isError()?withinTextObject:startNumObject.isError()?startNumObject:this._handleSingleObject(findTextObject,withinTextObject,startNumObject)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_handleSingleObject(findText,withinText,startNum){const findTextValue=getTextValueOfNumberFormat(findText),withinTextValue=getTextValueOfNumberFormat(withinText),{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(startNum);if(isError)return errorObject;const[startNumObject]=variants,startNumValue=Math.floor(+startNumObject.getValue());if(withinText.isNull()||startNumValue<=0||startNumValue>withinTextValue.length)return ErrorValueObject.create(error_type_ErrorType.VALUE);if(findText.isNull()||0===findTextValue.length)return NumberValueObject.create(startNumValue);const result=withinTextValue.indexOf(findTextValue,startNumValue-1);return-1===result?ErrorValueObject.create(error_type_ErrorType.VALUE):NumberValueObject.create(result+1)}constructor(...args){super(...args),this.minParams=2,this.maxParams=3}},FUNCTION_NAMES_TEXT.FIND],[class Findb extends base_function_BaseFunction{calculate(findText,withinText,startNum){const _startNum=startNum??NumberValueObject.create(1),maxRowLength=Math.max(findText.isArray()?findText.getRowCount():1,withinText.isArray()?withinText.getRowCount():1,_startNum.isArray()?_startNum.getRowCount():1),maxColumnLength=Math.max(findText.isArray()?findText.getColumnCount():1,withinText.isArray()?withinText.getColumnCount():1,_startNum.isArray()?_startNum.getColumnCount():1),findTextArray=expandArrayValueObject(maxRowLength,maxColumnLength,findText,ErrorValueObject.create(error_type_ErrorType.NA)),withinTextArray=expandArrayValueObject(maxRowLength,maxColumnLength,withinText,ErrorValueObject.create(error_type_ErrorType.NA)),startNumArray=expandArrayValueObject(maxRowLength,maxColumnLength,_startNum,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=findTextArray.mapValue(((findTextObject,rowIndex,columnIndex)=>{const withinTextObject=withinTextArray.get(rowIndex,columnIndex),startNumObject=startNumArray.get(rowIndex,columnIndex);return findTextObject.isError()?findTextObject:withinTextObject.isError()?withinTextObject:startNumObject.isError()?startNumObject:this._handleSingleObject(findTextObject,withinTextObject,startNumObject)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_handleSingleObject(findText,withinText,startNum){const findTextValue=getTextValueOfNumberFormat(findText),withinTextValue=getTextValueOfNumberFormat(withinText),{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(startNum);if(isError)return errorObject;const[startNumObject]=variants,startNumValue=Math.floor(+startNumObject.getValue());if(withinText.isNull()||startNumValue<=0||startNumValue>withinTextValue.length)return ErrorValueObject.create(error_type_ErrorType.VALUE);if(findText.isNull()||0===findTextValue.length)return NumberValueObject.create(startNumValue);const index=withinTextValue.indexOf(findTextValue,startNumValue-1);if(-1===index)return ErrorValueObject.create(error_type_ErrorType.VALUE);const result=charLenByte(withinTextValue.substring(0,index))+1;return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=2,this.maxParams=3}},FUNCTION_NAMES_TEXT.FINDB],[class Fixed extends base_function_BaseFunction{calculate(number,decimals,noCommas){let _decimals=decimals??NumberValueObject.create(2);_decimals.isNull()&&(_decimals=NumberValueObject.create(2));let _noCommas=noCommas??BooleanValueObject.create(!1);_noCommas.isNull()&&(_noCommas=BooleanValueObject.create(!1));const maxRowLength=Math.max(number.isArray()?number.getRowCount():1,_decimals.isArray()?_decimals.getRowCount():1,_noCommas.isArray()?_noCommas.getRowCount():1),maxColumnLength=Math.max(number.isArray()?number.getColumnCount():1,_decimals.isArray()?_decimals.getColumnCount():1,_noCommas.isArray()?_noCommas.getColumnCount():1),numberArray=expandArrayValueObject(maxRowLength,maxColumnLength,number,ErrorValueObject.create(error_type_ErrorType.NA)),decimalsArray=expandArrayValueObject(maxRowLength,maxColumnLength,_decimals,ErrorValueObject.create(error_type_ErrorType.NA)),noCommasArray=expandArrayValueObject(maxRowLength,maxColumnLength,_noCommas,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=numberArray.mapValue(((numberObject,rowIndex,columnIndex)=>{const decimalsObject=decimalsArray.get(rowIndex,columnIndex),noCommasObject=noCommasArray.get(rowIndex,columnIndex);return numberObject.isError()?numberObject:decimalsObject.isError()?decimalsObject:noCommasObject.isError()?noCommasObject:this._handleSingleObject(numberObject,decimalsObject,noCommasObject)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_handleSingleObject(number,decimals,noCommas){const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(number,decimals,noCommas);if(isError)return errorObject;const[numberObject,decimalsObject,noCommasObject]=variants;let numberValue=+numberObject.getValue(),decimalsValue=Math.trunc(+decimalsObject.getValue());const noCommasValue=+noCommasObject.getValue();if(decimalsValue>127)return ErrorValueObject.create(error_type_ErrorType.VALUE);decimalsValue<0&&(numberValue=`${numberValue}`.length<Math.abs(decimalsValue)?0:numberValue<0?-round(Math.abs(numberValue),decimalsValue):round(numberValue,decimalsValue),decimalsValue=0);let pattern=noCommasValue?"###0":"#,##0";decimalsValue>0&&(pattern+=`.${"0".repeat(decimalsValue)}`);const result=getFormatPreview(pattern,numberValue);return StringValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=3}},FUNCTION_NAMES_TEXT.FIXED],[class Left extends base_function_BaseFunction{calculate(text,numChars){const _numChars=numChars??NumberValueObject.create(1),maxRowLength=Math.max(text.isArray()?text.getRowCount():1,_numChars.isArray()?_numChars.getRowCount():1),maxColumnLength=Math.max(text.isArray()?text.getColumnCount():1,_numChars.isArray()?_numChars.getColumnCount():1),textArray=expandArrayValueObject(maxRowLength,maxColumnLength,text,ErrorValueObject.create(error_type_ErrorType.NA)),numCharsArray=expandArrayValueObject(maxRowLength,maxColumnLength,_numChars,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=textArray.mapValue(((textObject,rowIndex,columnIndex)=>{const numCharsObject=numCharsArray.get(rowIndex,columnIndex);return textObject.isError()?textObject:numCharsObject.isError()?numCharsObject:this._handleSingleObject(textObject,numCharsObject)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_handleSingleObject(text,numChars){const textValue=getTextValueOfNumberFormat(text),{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(numChars);if(isError)return errorObject;const[numCharsObject]=variants,numCharsValue=Math.floor(+numCharsObject.getValue());if(numCharsValue<0)return ErrorValueObject.create(error_type_ErrorType.VALUE);if(text.isNull()||0===numCharsValue)return StringValueObject.create("");if(numCharsValue>=textValue.length)return StringValueObject.create(textValue);const result=textValue.substring(0,numCharsValue);return StringValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=2}},FUNCTION_NAMES_TEXT.LEFT],[class Leftb extends base_function_BaseFunction{calculate(text,numBytes){const _numBytes=numBytes??NumberValueObject.create(1),maxRowLength=Math.max(text.isArray()?text.getRowCount():1,_numBytes.isArray()?_numBytes.getRowCount():1),maxColumnLength=Math.max(text.isArray()?text.getColumnCount():1,_numBytes.isArray()?_numBytes.getColumnCount():1),textArray=expandArrayValueObject(maxRowLength,maxColumnLength,text,NullValueObject.create()),numBytesArray=expandArrayValueObject(maxRowLength,maxColumnLength,_numBytes,NullValueObject.create()),resultArray=textArray.mapValue(((textObject,rowIndex,columnIndex)=>{const numBytesObject=numBytesArray.get(rowIndex,columnIndex);return textObject.isError()?textObject:numBytesObject.isError()?numBytesObject:this._handleSingleObject(textObject,numBytesObject)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_handleSingleObject(text,numBytes){const textValue=getTextValueOfNumberFormat(text),{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(numBytes);if(isError)return errorObject;const[numBytesObject]=variants,numBytesValue=Math.floor(+numBytesObject.getValue());if(numBytesValue<0)return ErrorValueObject.create(error_type_ErrorType.VALUE);if(text.isNull()||0===numBytesValue)return StringValueObject.create("");let index=0,lenByte=0,result="";for(;lenByte<numBytesValue&&index<textValue.length;)lenByte+=getCharLenByteInText(textValue,index),result+=textValue.charAt(index),index++;return StringValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=2}},FUNCTION_NAMES_TEXT.LEFTB],[class Len extends base_function_BaseFunction{calculate(text){if(text.isArray()){const resultArray=text.mapValue((textValue=>this._handleSingleText(textValue)));return 1===resultArray.getRowCount()&&1===resultArray.getColumnCount()?resultArray.get(0,0):resultArray}return this._handleSingleText(text)}_handleSingleText(text){if(text.isError())return text;const textValue=getTextValueOfNumberFormat(text);return NumberValueObject.create(textValue.length)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_TEXT.LEN],[class Lenb extends base_function_BaseFunction{calculate(text){if(text.isArray()){const resultArray=text.mapValue((textValue=>this._handleSingleText(textValue)));return 1===resultArray.getRowCount()&&1===resultArray.getColumnCount()?resultArray.get(0,0):resultArray}return this._handleSingleText(text)}_handleSingleText(text){if(text.isError())return text;const textByteLen=charLenByte(getTextValueOfNumberFormat(text));return NumberValueObject.create(textByteLen)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_TEXT.LENB],[class Lower extends base_function_BaseFunction{calculate(text){if(text.isArray()){const resultArray=text.mapValue((textObject=>this._handleSingleObject(textObject)));return 1===resultArray.getRowCount()&&1===resultArray.getColumnCount()?resultArray.get(0,0):resultArray}return this._handleSingleObject(text)}_handleSingleObject(text){if(text.isError())return text;if(text.isNull())return StringValueObject.create("");const result=`${text.getValue()}`.toLocaleLowerCase();return StringValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_TEXT.LOWER],[class Mid extends base_function_BaseFunction{calculate(text,startNum,numChars){const maxRowLength=Math.max(text.isArray()?text.getRowCount():1,startNum.isArray()?startNum.getRowCount():1,numChars.isArray()?numChars.getRowCount():1),maxColumnLength=Math.max(text.isArray()?text.getColumnCount():1,startNum.isArray()?startNum.getColumnCount():1,numChars.isArray()?numChars.getColumnCount():1),textArray=expandArrayValueObject(maxRowLength,maxColumnLength,text,ErrorValueObject.create(error_type_ErrorType.NA)),startNumArray=expandArrayValueObject(maxRowLength,maxColumnLength,startNum,ErrorValueObject.create(error_type_ErrorType.NA)),numCharsArray=expandArrayValueObject(maxRowLength,maxColumnLength,numChars,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=textArray.mapValue(((textObject,rowIndex,columnIndex)=>{const startNumObject=startNumArray.get(rowIndex,columnIndex),numCharsObject=numCharsArray.get(rowIndex,columnIndex);return textObject.isError()?textObject:startNumObject.isError()?startNumObject:numCharsObject.isError()?numCharsObject:this._handleSingleObject(textObject,startNumObject,numCharsObject)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_handleSingleObject(text,startNum,numChars){const textValue=getTextValueOfNumberFormat(text),{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(startNum,numChars);if(isError)return errorObject;const[startNumObject,numCharsObject]=variants,startNumValue=Math.floor(+startNumObject.getValue()),numCharsValue=Math.floor(+numCharsObject.getValue());if(startNumValue<=0||numCharsValue<0)return ErrorValueObject.create(error_type_ErrorType.VALUE);if(text.isNull()||startNumValue>textValue.length||0===numCharsValue)return StringValueObject.create("");const result=textValue.substring(startNumValue-1,startNumValue-1+numCharsValue);return StringValueObject.create(result)}constructor(...args){super(...args),this.minParams=3,this.maxParams=3}},FUNCTION_NAMES_TEXT.MID],[class Midb extends base_function_BaseFunction{calculate(text,startNum,numBytes){const maxRowLength=Math.max(text.isArray()?text.getRowCount():1,startNum.isArray()?startNum.getRowCount():1,numBytes.isArray()?numBytes.getRowCount():1),maxColumnLength=Math.max(text.isArray()?text.getColumnCount():1,startNum.isArray()?startNum.getColumnCount():1,numBytes.isArray()?numBytes.getColumnCount():1),textArray=expandArrayValueObject(maxRowLength,maxColumnLength,text,ErrorValueObject.create(error_type_ErrorType.NA)),startNumArray=expandArrayValueObject(maxRowLength,maxColumnLength,startNum,ErrorValueObject.create(error_type_ErrorType.NA)),numBytesArray=expandArrayValueObject(maxRowLength,maxColumnLength,numBytes,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=textArray.mapValue(((textObject,rowIndex,columnIndex)=>{const startNumObject=startNumArray.get(rowIndex,columnIndex),numBytesObject=numBytesArray.get(rowIndex,columnIndex);return textObject.isError()?textObject:startNumObject.isError()?startNumObject:numBytesObject.isError()?numBytesObject:this._handleSingleObject(textObject,startNumObject,numBytesObject)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_handleSingleObject(text,startNum,numBytes){let textValue=getTextValueOfNumberFormat(text);const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(startNum,numBytes);if(isError)return errorObject;const[startNumObject,numBytesObject]=variants,startNumValue=Math.floor(+startNumObject.getValue()),numBytesValue=Math.floor(+numBytesObject.getValue());if(startNumValue<=0||numBytesValue<0)return ErrorValueObject.create(error_type_ErrorType.VALUE);if(text.isNull()||startNumValue>textValue.length||0===numBytesValue)return StringValueObject.create("");textValue=textValue.substring(startNumValue-1);let index=0,lenByte=0,result="";for(;lenByte<numBytesValue&&index<textValue.length;)lenByte+=getCharLenByteInText(textValue,index),result+=textValue.charAt(index),index++;return StringValueObject.create(result)}constructor(...args){super(...args),this.minParams=3,this.maxParams=3}},FUNCTION_NAMES_TEXT.MIDB],[class Numberstring extends base_function_BaseFunction{calculate(number,type){const maxRowLength=Math.max(number.isArray()?number.getRowCount():1,type.isArray()?type.getRowCount():1),maxColumnLength=Math.max(number.isArray()?number.getColumnCount():1,type.isArray()?type.getColumnCount():1),numberArray=expandArrayValueObject(maxRowLength,maxColumnLength,number,ErrorValueObject.create(error_type_ErrorType.NA)),typeArray=expandArrayValueObject(maxRowLength,maxColumnLength,type,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=numberArray.mapValue(((numberObject,rowIndex,columnIndex)=>{const typeObject=typeArray.get(rowIndex,columnIndex);return numberObject.isError()?numberObject:typeObject.isError()?typeObject:this._handleSingleObject(numberObject,typeObject)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_handleSingleObject(number,type){const _number=number.convertToNumberObjectValue();if(_number.isError())return _number;const _type=type.convertToNumberObjectValue();if(_type.isError())return _type;let numberValue=_number.getValue();const typeValue=Math.trunc(_type.getValue());if(numberValue<0||![1,2,3].includes(typeValue))return ErrorValueObject.create(error_type_ErrorType.NUM);numberValue=Math.round(numberValue);const numberString=numberValue.toString(),len=numberString.length;let result="",hasZero=!1;for(let i=0;i<len;i++){const num=Number(numberString[i]);if(1===len&&0===num){result+=2===typeValue?chineseUppercaseNumbers[0]:chineseLowercaseNumbers[0];break}if(3===typeValue){result+=chineseLowercaseNumbers[num];continue}const pos=len-i-1,unit=pos%4,suffixUnit=Math.trunc(pos/4);if(len>=17&&suffixUnit>2){if(result+=1===typeValue?chineseLowercaseNumbers[num]:chineseUppercaseNumbers[num],suffixUnit>3)continue}else 0===num?hasZero=0!==unit:(hasZero&&(result+=1===typeValue?chineseLowercaseNumbers[0]:chineseUppercaseNumbers[0],hasZero=!1),result+=1===typeValue?chineseLowercaseNumbers[num]+chineseLowercaseUnits[unit]:chineseUppercaseNumbers[num]+chineseUppercaseUnits[unit]);if(0===unit&&suffixUnit>0){"0000"!==numberString.slice(Math.max(0,i-3),i+1)&&(result+=suffixUnits[suffixUnit])}}return StringValueObject.create(result)}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_TEXT.NUMBERSTRING],[class Numbervalue extends base_function_BaseFunction{calculate(text,decimalSeparator,groupSeparator){const _decimalSeparator=decimalSeparator??StringValueObject.create("."),maxRowLength=Math.max(text.isArray()?text.getRowCount():1,_decimalSeparator.isArray()?_decimalSeparator.getRowCount():1,groupSeparator?.isArray()?groupSeparator.getRowCount():1),maxColumnLength=Math.max(text.isArray()?text.getColumnCount():1,_decimalSeparator.isArray()?_decimalSeparator.getColumnCount():1,groupSeparator?.isArray()?groupSeparator.getColumnCount():1),textArray=expandArrayValueObject(maxRowLength,maxColumnLength,text,ErrorValueObject.create(error_type_ErrorType.NA)),decimalSeparatorArray=expandArrayValueObject(maxRowLength,maxColumnLength,_decimalSeparator,ErrorValueObject.create(error_type_ErrorType.NA)),groupSeparatorArray=groupSeparator?expandArrayValueObject(maxRowLength,maxColumnLength,groupSeparator,ErrorValueObject.create(error_type_ErrorType.NA)):void 0,resultArray=textArray.mapValue(((textObject,rowIndex,columnIndex)=>{const decimalSeparatorObject=decimalSeparatorArray.get(rowIndex,columnIndex),groupSeparatorObject=groupSeparator?groupSeparatorArray.get(rowIndex,columnIndex):void 0;return textObject.isError()?textObject:decimalSeparatorObject.isError()?decimalSeparatorObject:groupSeparatorObject?.isError()?groupSeparatorObject:decimalSeparatorObject.isNull()||groupSeparatorObject?.isNull()?ErrorValueObject.create(error_type_ErrorType.VALUE):textObject.isNull()?NumberValueObject.create(0):this._handleSingleObject(textObject,decimalSeparatorObject,groupSeparatorObject)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_handleSingleObject(text,decimalSeparator,groupSeparator){let textValue=`${text.getValue()}`;textValue=textValue.replace(/\s+/g,"");let groupSeparatorValue,decimalSeparatorValue=`${decimalSeparator.getValue()}`;if(decimalSeparator.isBoolean()&&(decimalSeparatorValue=decimalSeparatorValue.toLocaleUpperCase()),decimalSeparatorValue=decimalSeparatorValue.charAt(0),groupSeparator&&(groupSeparatorValue=`${groupSeparator.getValue()}`,groupSeparator.isBoolean()&&(groupSeparatorValue=groupSeparatorValue.toLocaleUpperCase()),groupSeparatorValue=groupSeparatorValue.charAt(0),decimalSeparatorValue===groupSeparatorValue))return ErrorValueObject.create(error_type_ErrorType.VALUE);if(""===textValue.trim())return NumberValueObject.create(0);if(!textValue.match(/^\s*[+-]?\s*(?:(?:\d+(?:\.\d*)?)|(?:\.\d+))(?:[eE][+-]?\d+)?[ \t]*/))return ErrorValueObject.create(error_type_ErrorType.VALUE);const splitText=textValue.split(decimalSeparatorValue);if(splitText.length>2)return ErrorValueObject.create(error_type_ErrorType.VALUE);let integerPart=splitText[0].replace(/,/g,"");groupSeparator&&(integerPart=integerPart.split(groupSeparatorValue).join(""));let result=0;if(1===splitText.length){","===decimalSeparatorValue&&(integerPart=integerPart.replace(/\./g,""));let percentageCount=0;for(;integerPart.endsWith("%");)integerPart=integerPart.slice(0,-1),percentageCount++;result=percentageCount>0?+integerPart/100**percentageCount:+integerPart}else{if(!(0,src.DMQ)(integerPart))return ErrorValueObject.create(error_type_ErrorType.VALUE);let decimalPart=splitText[1],percentageCount=0;for(;decimalPart.endsWith("%");)decimalPart=decimalPart.slice(0,-1),percentageCount++;const resultText=`${integerPart}.${decimalPart}`;if(!(0,src.DMQ)(resultText))return ErrorValueObject.create(error_type_ErrorType.VALUE);result=percentageCount>0?+resultText/100**percentageCount:+resultText}return Number.isNaN(result)?ErrorValueObject.create(error_type_ErrorType.VALUE):NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=3}},FUNCTION_NAMES_TEXT.NUMBERVALUE],[class Regexextract extends base_function_BaseFunction{calculate(text,regularExpression){const{isError,errorObject,variants}=checkVariantsErrorIsArray(text,regularExpression);if(isError)return errorObject;const[textObject,regularExpressionObject]=variants;let textValue=textObject.getValue();textObject.isNull()&&(textValue=""),textObject.isBoolean()&&(textValue=textValue?"TRUE":"FALSE"),textValue=`${textValue}`;let regularExpressionValue=regularExpressionObject.getValue();regularExpressionObject.isNull()&&(regularExpressionValue=""),regularExpressionObject.isBoolean()&&(regularExpressionValue=regularExpressionValue?"TRUE":"FALSE"),regularExpressionValue=`${regularExpressionValue}`;const{isError:isError_regExp,regExp}=handleRegExp(regularExpressionValue,!1);if(isError_regExp)return ErrorValueObject.create(error_type_ErrorType.REF);const result=textValue.match(regExp);if(null===result)return ErrorValueObject.create(error_type_ErrorType.NA);if(result.length>1){const resultArray=result.slice(1).map((item=>StringValueObject.create(item)));return resultArray.length>1?ArrayValueObject.create({calculateValueList:[resultArray],rowCount:1,columnCount:resultArray.length,unitId:this.unitId,sheetId:this.subUnitId,row:this.row,column:this.column}):resultArray[0]}return StringValueObject.create(result[0])}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_TEXT.REGEXEXTRACT],[class Regexmatch extends base_function_BaseFunction{calculate(text,regularExpression){const{isError,errorObject,variants}=checkVariantsErrorIsArray(text,regularExpression);if(isError)return errorObject;const[textObject,regularExpressionObject]=variants;let textValue=textObject.getValue();textObject.isNull()&&(textValue=""),textObject.isBoolean()&&(textValue=textValue?"TRUE":"FALSE"),textValue=`${textValue}`;let regularExpressionValue=regularExpressionObject.getValue();regularExpressionObject.isNull()&&(regularExpressionValue=""),regularExpressionObject.isBoolean()&&(regularExpressionValue=regularExpressionValue?"TRUE":"FALSE"),regularExpressionValue=`${regularExpressionValue}`;const{isError:isError_regExp,regExp}=handleRegExp(regularExpressionValue,!1);if(isError_regExp)return ErrorValueObject.create(error_type_ErrorType.REF);return null===textValue.match(regExp)?BooleanValueObject.create(!1):BooleanValueObject.create(!0)}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_TEXT.REGEXMATCH],[class Regexreplace extends base_function_BaseFunction{calculate(text,regularExpression,replacement){const{isError,errorObject,variants}=checkVariantsErrorIsArray(text,regularExpression,replacement);if(isError)return errorObject;const[textObject,regularExpressionObject,replacementObject]=variants;let textValue=textObject.getValue();textObject.isNull()&&(textValue=""),textObject.isBoolean()&&(textValue=textValue?"TRUE":"FALSE"),textValue=`${textValue}`;let regularExpressionValue=regularExpressionObject.getValue();regularExpressionObject.isNull()&&(regularExpressionValue=""),regularExpressionObject.isBoolean()&&(regularExpressionValue=regularExpressionValue?"TRUE":"FALSE"),regularExpressionValue=`${regularExpressionValue}`;let replacementValue=replacementObject.getValue();replacementObject.isNull()&&(replacementValue=""),replacementObject.isBoolean()&&(replacementValue=replacementValue?"TRUE":"FALSE"),replacementValue=`${replacementValue}`;const{isError:isError_regExp,regExp}=handleRegExp(regularExpressionValue,!0);if(isError_regExp)return ErrorValueObject.create(error_type_ErrorType.REF);const result=textValue.replace(regExp,replacementValue);return StringValueObject.create(result)}constructor(...args){super(...args),this.minParams=3,this.maxParams=3}},FUNCTION_NAMES_TEXT.REGEXREPLACE],[class Proper extends base_function_BaseFunction{calculate(text){if(text.isArray()){const resultArray=text.mapValue((textObject=>this._handleSingleObject(textObject)));return 1===resultArray.getRowCount()&&1===resultArray.getColumnCount()?resultArray.get(0,0):resultArray}return this._handleSingleObject(text)}_handleSingleObject(text){if(text.isError()||text.isNull()||text.isBoolean()||text.isNumber())return text;const result=text.getValue().toLocaleString().toLocaleLowerCase().replace(/(^|\b|\W|\d|_)[a-z]/g,(txt=>txt.toLocaleUpperCase()));return StringValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_TEXT.PROPER],[class Replace extends base_function_BaseFunction{calculate(oldText,startNum,numChars,newText){const maxRowLength=Math.max(oldText.isArray()?oldText.getRowCount():1,startNum.isArray()?startNum.getRowCount():1,numChars.isArray()?numChars.getRowCount():1,newText.isArray()?newText.getRowCount():1),maxColumnLength=Math.max(oldText.isArray()?oldText.getColumnCount():1,startNum.isArray()?startNum.getColumnCount():1,numChars.isArray()?numChars.getColumnCount():1,newText.isArray()?newText.getColumnCount():1),oldTextArray=expandArrayValueObject(maxRowLength,maxColumnLength,oldText,ErrorValueObject.create(error_type_ErrorType.NA)),startNumArray=expandArrayValueObject(maxRowLength,maxColumnLength,startNum,ErrorValueObject.create(error_type_ErrorType.NA)),numCharsArray=expandArrayValueObject(maxRowLength,maxColumnLength,numChars,ErrorValueObject.create(error_type_ErrorType.NA)),newTextArray=expandArrayValueObject(maxRowLength,maxColumnLength,newText,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=oldTextArray.mapValue(((oldTextObject,rowIndex,columnIndex)=>{const startNumObject=startNumArray.get(rowIndex,columnIndex),numCharsObject=numCharsArray.get(rowIndex,columnIndex),newTextObject=newTextArray.get(rowIndex,columnIndex);return oldTextObject.isError()?oldTextObject:startNumObject.isError()?startNumObject:numCharsObject.isError()?numCharsObject:newTextObject.isError()?newTextObject:this._handleSingleObject(oldTextObject,startNumObject,numCharsObject,newTextObject)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_handleSingleObject(oldText,startNum,numChars,newText){const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(startNum,numChars);if(isError)return errorObject;const[startNumObject,numCharsObject]=variants,startNumValue=Math.floor(+startNumObject.getValue()),numCharsValue=Math.floor(+numCharsObject.getValue());if(startNumValue<=0||numCharsValue<0)return ErrorValueObject.create(error_type_ErrorType.VALUE);const oldTextValue=getTextValueOfNumberFormat(oldText),newTextValue=getTextValueOfNumberFormat(newText),result=oldTextValue.substring(0,startNumValue-1)+newTextValue+oldTextValue.substring(startNumValue-1+numCharsValue);return StringValueObject.create(result)}constructor(...args){super(...args),this.minParams=4,this.maxParams=4}},FUNCTION_NAMES_TEXT.REPLACE],[class Replaceb extends base_function_BaseFunction{calculate(oldText,startNum,numBytes,newText){const maxRowLength=Math.max(oldText.isArray()?oldText.getRowCount():1,startNum.isArray()?startNum.getRowCount():1,numBytes.isArray()?numBytes.getRowCount():1,newText.isArray()?newText.getRowCount():1),maxColumnLength=Math.max(oldText.isArray()?oldText.getColumnCount():1,startNum.isArray()?startNum.getColumnCount():1,numBytes.isArray()?numBytes.getColumnCount():1,newText.isArray()?newText.getColumnCount():1),oldTextArray=expandArrayValueObject(maxRowLength,maxColumnLength,oldText,ErrorValueObject.create(error_type_ErrorType.NA)),startNumArray=expandArrayValueObject(maxRowLength,maxColumnLength,startNum,ErrorValueObject.create(error_type_ErrorType.NA)),numBytesArray=expandArrayValueObject(maxRowLength,maxColumnLength,numBytes,ErrorValueObject.create(error_type_ErrorType.NA)),newTextArray=expandArrayValueObject(maxRowLength,maxColumnLength,newText,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=oldTextArray.mapValue(((oldTextObject,rowIndex,columnIndex)=>{const startNumObject=startNumArray.get(rowIndex,columnIndex),numBytesObject=numBytesArray.get(rowIndex,columnIndex),newTextObject=newTextArray.get(rowIndex,columnIndex);return oldTextObject.isError()?oldTextObject:startNumObject.isError()?startNumObject:numBytesObject.isError()?numBytesObject:newTextObject.isError()?newTextObject:this._handleSingleObject(oldTextObject,startNumObject,numBytesObject,newTextObject)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_handleSingleObject(oldText,startNum,numBytes,newText){const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(startNum,numBytes);if(isError)return errorObject;const[startNumObject,numBytesObject]=variants,startNumValue=Math.floor(+startNumObject.getValue()),numBytesValue=Math.floor(+numBytesObject.getValue());if(startNumValue<=0||numBytesValue<0)return ErrorValueObject.create(error_type_ErrorType.VALUE);let oldTextValue=getTextValueOfNumberFormat(oldText);const newTextValue=getTextValueOfNumberFormat(newText);let result=oldTextValue.substring(0,startNumValue-1);oldTextValue=oldTextValue.substring(startNumValue-1);let index=0,lenByte=0;for(;lenByte<numBytesValue&&index<oldTextValue.length;)lenByte+=getCharLenByteInText(oldTextValue,index),index++;return result+=newTextValue+oldTextValue.substring(index),StringValueObject.create(result)}constructor(...args){super(...args),this.minParams=4,this.maxParams=4}},FUNCTION_NAMES_TEXT.REPLACEB],[class Rept extends base_function_BaseFunction{calculate(text,numberTimes){if(text.isError())return text;if(numberTimes.isError())return numberTimes;const maxRowLength=Math.max(text.isArray()?text.getRowCount():1,numberTimes.isArray()?numberTimes.getRowCount():1),maxColumnLength=Math.max(text.isArray()?text.getColumnCount():1,numberTimes.isArray()?numberTimes.getColumnCount():1),textArray=expandArrayValueObject(maxRowLength,maxColumnLength,text,ErrorValueObject.create(error_type_ErrorType.NA)),numberTimesArray=expandArrayValueObject(maxRowLength,maxColumnLength,numberTimes,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=textArray.map(((textObject,rowIndex,columnIndex)=>{let numberTimesObject=numberTimesArray.get(rowIndex,columnIndex);if(textObject.isError())return textObject;let textValue=textObject.getValue();if(textObject.isNull()&&(textValue=""),textObject.isBoolean()&&(textValue=textValue?"TRUE":"FALSE"),textValue+="",numberTimesObject.isString()&&(numberTimesObject=numberTimesObject.convertToNumberObjectValue()),numberTimesObject.isError())return numberTimesObject;const numberTimesValue=Math.floor(+numberTimesObject.getValue());if(numberTimesValue<0||numberTimesValue>32767/textValue.length)return ErrorValueObject.create(error_type_ErrorType.VALUE);const result=textValue.repeat(numberTimesValue);return StringValueObject.create(result)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_TEXT.REPT],[class Right extends base_function_BaseFunction{calculate(text,numChars){const _numChars=numChars??NumberValueObject.create(1),maxRowLength=Math.max(text.isArray()?text.getRowCount():1,_numChars.isArray()?_numChars.getRowCount():1),maxColumnLength=Math.max(text.isArray()?text.getColumnCount():1,_numChars.isArray()?_numChars.getColumnCount():1),textArray=expandArrayValueObject(maxRowLength,maxColumnLength,text,ErrorValueObject.create(error_type_ErrorType.NA)),numCharsArray=expandArrayValueObject(maxRowLength,maxColumnLength,_numChars,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=textArray.mapValue(((textObject,rowIndex,columnIndex)=>{const numCharsObject=numCharsArray.get(rowIndex,columnIndex);return textObject.isError()?textObject:numCharsObject.isError()?numCharsObject:this._handleSingleObject(textObject,numCharsObject)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_handleSingleObject(text,numChars){const textValue=getTextValueOfNumberFormat(text),{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(numChars);if(isError)return errorObject;const[numCharsObject]=variants,numCharsValue=Math.floor(+numCharsObject.getValue());if(numCharsValue<0)return ErrorValueObject.create(error_type_ErrorType.VALUE);if(text.isNull()||0===numCharsValue)return StringValueObject.create("");if(numCharsValue>=textValue.length)return StringValueObject.create(textValue);const result=textValue.substring(textValue.length-numCharsValue);return StringValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=2}},FUNCTION_NAMES_TEXT.RIGHT],[class Rightb extends base_function_BaseFunction{calculate(text,numBytes){const _numBytes=numBytes??NumberValueObject.create(1),maxRowLength=Math.max(text.isArray()?text.getRowCount():1,_numBytes.isArray()?_numBytes.getRowCount():1),maxColumnLength=Math.max(text.isArray()?text.getColumnCount():1,_numBytes.isArray()?_numBytes.getColumnCount():1),textArray=expandArrayValueObject(maxRowLength,maxColumnLength,text,ErrorValueObject.create(error_type_ErrorType.NA)),numBytesArray=expandArrayValueObject(maxRowLength,maxColumnLength,_numBytes,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=textArray.mapValue(((textObject,rowIndex,columnIndex)=>{const numBytesObject=numBytesArray.get(rowIndex,columnIndex);return textObject.isError()?textObject:numBytesObject.isError()?numBytesObject:this._handleSingleObject(textObject,numBytesObject)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_handleSingleObject(text,numBytes){const textValue=getTextValueOfNumberFormat(text),{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(numBytes);if(isError)return errorObject;const[numBytesObject]=variants,numBytesValue=Math.floor(+numBytesObject.getValue());if(numBytesValue<0)return ErrorValueObject.create(error_type_ErrorType.VALUE);if(text.isNull()||0===numBytesValue)return StringValueObject.create("");let index=textValue.length-1,lenByte=0,result="";for(;lenByte<numBytesValue&&index>=0;)lenByte+=getCharLenByteInText(textValue,index,"rtl"),result=textValue.charAt(index)+result,index--;return StringValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=2}},FUNCTION_NAMES_TEXT.RIGHTB],[class Search extends base_function_BaseFunction{calculate(findText,withinText,startNum){const _startNum=startNum??NumberValueObject.create(1),maxRowLength=Math.max(findText.isArray()?findText.getRowCount():1,withinText.isArray()?withinText.getRowCount():1,_startNum.isArray()?_startNum.getRowCount():1),maxColumnLength=Math.max(findText.isArray()?findText.getColumnCount():1,withinText.isArray()?withinText.getColumnCount():1,_startNum.isArray()?_startNum.getColumnCount():1),findTextArray=expandArrayValueObject(maxRowLength,maxColumnLength,findText,ErrorValueObject.create(error_type_ErrorType.NA)),withinTextArray=expandArrayValueObject(maxRowLength,maxColumnLength,withinText,ErrorValueObject.create(error_type_ErrorType.NA)),startNumArray=expandArrayValueObject(maxRowLength,maxColumnLength,_startNum,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=findTextArray.mapValue(((findTextObject,rowIndex,columnIndex)=>{const withinTextObject=withinTextArray.get(rowIndex,columnIndex),startNumObject=startNumArray.get(rowIndex,columnIndex);return findTextObject.isError()?findTextObject:withinTextObject.isError()?withinTextObject:startNumObject.isError()?startNumObject:this._handleSingleObject(findTextObject,withinTextObject,startNumObject)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_handleSingleObject(findText,withinText,startNum){const findTextValue=getTextValueOfNumberFormat(findText).toLocaleUpperCase(),withinTextValue=getTextValueOfNumberFormat(withinText).toLocaleUpperCase(),{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(startNum);if(isError)return errorObject;const[startNumObject]=variants,startNumValue=Math.floor(+startNumObject.getValue());if(withinText.isNull()||startNumValue<=0||startNumValue>withinTextValue.length)return ErrorValueObject.create(error_type_ErrorType.VALUE);if(findText.isNull()||0===findTextValue.length)return NumberValueObject.create(startNumValue);const result=withinTextValue.indexOf(findTextValue,startNumValue-1);return-1===result?ErrorValueObject.create(error_type_ErrorType.VALUE):NumberValueObject.create(result+1)}constructor(...args){super(...args),this.minParams=2,this.maxParams=3}},FUNCTION_NAMES_TEXT.SEARCH],[class Searchb extends base_function_BaseFunction{calculate(findText,withinText,startNum){const _startNum=startNum??NumberValueObject.create(1),maxRowLength=Math.max(findText.isArray()?findText.getRowCount():1,withinText.isArray()?withinText.getRowCount():1,_startNum.isArray()?_startNum.getRowCount():1),maxColumnLength=Math.max(findText.isArray()?findText.getColumnCount():1,withinText.isArray()?withinText.getColumnCount():1,_startNum.isArray()?_startNum.getColumnCount():1),findTextArray=expandArrayValueObject(maxRowLength,maxColumnLength,findText,ErrorValueObject.create(error_type_ErrorType.NA)),withinTextArray=expandArrayValueObject(maxRowLength,maxColumnLength,withinText,ErrorValueObject.create(error_type_ErrorType.NA)),startNumArray=expandArrayValueObject(maxRowLength,maxColumnLength,_startNum,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=findTextArray.mapValue(((findTextObject,rowIndex,columnIndex)=>{const withinTextObject=withinTextArray.get(rowIndex,columnIndex),startNumObject=startNumArray.get(rowIndex,columnIndex);return findTextObject.isError()?findTextObject:withinTextObject.isError()?withinTextObject:startNumObject.isError()?startNumObject:this._handleSingleObject(findTextObject,withinTextObject,startNumObject)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_handleSingleObject(findText,withinText,startNum){const findTextValue=getTextValueOfNumberFormat(findText).toLocaleUpperCase(),withinTextValue=getTextValueOfNumberFormat(withinText).toLocaleUpperCase(),{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(startNum);if(isError)return errorObject;const[startNumObject]=variants,startNumValue=Math.floor(+startNumObject.getValue());if(withinText.isNull()||startNumValue<=0||startNumValue>withinTextValue.length)return ErrorValueObject.create(error_type_ErrorType.VALUE);if(findText.isNull()||0===findTextValue.length)return NumberValueObject.create(startNumValue);const index=withinTextValue.indexOf(findTextValue,startNumValue-1);if(-1===index)return ErrorValueObject.create(error_type_ErrorType.VALUE);const result=charLenByte(withinTextValue.substring(0,index))+1;return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=2,this.maxParams=3}},FUNCTION_NAMES_TEXT.SEARCHB],[class Substitute extends base_function_BaseFunction{calculate(text,oldText,newText,instanceNum){const maxRowLength=Math.max(text.isArray()?text.getRowCount():1,oldText.isArray()?oldText.getRowCount():1,newText.isArray()?newText.getRowCount():1,instanceNum?.isArray()?instanceNum.getRowCount():1),maxColumnLength=Math.max(text.isArray()?text.getColumnCount():1,oldText.isArray()?oldText.getColumnCount():1,newText.isArray()?newText.getColumnCount():1,instanceNum?.isArray()?instanceNum.getColumnCount():1),textArray=expandArrayValueObject(maxRowLength,maxColumnLength,text,ErrorValueObject.create(error_type_ErrorType.NA)),oldTextArray=expandArrayValueObject(maxRowLength,maxColumnLength,oldText,ErrorValueObject.create(error_type_ErrorType.NA)),newTextArray=expandArrayValueObject(maxRowLength,maxColumnLength,newText,ErrorValueObject.create(error_type_ErrorType.NA)),instanceNumArray=instanceNum?expandArrayValueObject(maxRowLength,maxColumnLength,instanceNum,ErrorValueObject.create(error_type_ErrorType.NA)):void 0,resultArray=textArray.mapValue(((textObject,rowIndex,columnIndex)=>{const oldTextObject=oldTextArray.get(rowIndex,columnIndex),newTextObject=newTextArray.get(rowIndex,columnIndex);let instanceNumObject=instanceNum?instanceNumArray.get(rowIndex,columnIndex):void 0;return textObject.isError()?textObject:oldTextObject.isError()?oldTextObject:newTextObject.isError()?newTextObject:instanceNumObject?.isError()?instanceNumObject:instanceNumObject?.isNull()||instanceNumObject?.isBoolean()?ErrorValueObject.create(error_type_ErrorType.VALUE):(instanceNumObject?.isString()&&(instanceNumObject=instanceNumObject.convertToNumberObjectValue()),instanceNumObject?.isError()?instanceNumObject:this._handleSingleObject(textObject,oldTextObject,newTextObject,instanceNumObject))}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_handleSingleObject(text,oldText,newText,instanceNum){const textValue=this._getObjectString(text),oldTextValue=this._getObjectString(oldText),newTextValue=this._getObjectString(newText),instanceNumValue=instanceNum?Math.floor(+instanceNum.getValue()):void 0;if(instanceNum&&instanceNumValue<=0)return ErrorValueObject.create(error_type_ErrorType.VALUE);if(""===oldTextValue)return StringValueObject.create(textValue);let result="",num=0;for(let i=0;i<textValue.length;i++){const str=textValue.substr(i,oldTextValue.length);if(str===oldTextValue||str.length===oldTextValue.length&&str.trim()===oldTextValue.trim()){if(num++,num===instanceNumValue){result=textValue.substr(0,i)+newTextValue+textValue.substr(i+oldTextValue.length);break}void 0===instanceNumValue&&(result+=newTextValue),i+=oldTextValue.length-1}else void 0===instanceNumValue&&(result+=textValue[i])}return instanceNumValue&&num<instanceNumValue&&(result=textValue),StringValueObject.create(result)}_getObjectString(variant){let value=`${variant.getValue()}`;return variant.isNull()&&(value=""),variant.isBoolean()&&(value=value.toLocaleUpperCase()),value}constructor(...args){super(...args),this.minParams=3,this.maxParams=4}},FUNCTION_NAMES_TEXT.SUBSTITUTE],[class T extends base_function_BaseFunction{calculate(value){let _value=value;return value.isReferenceObject()&&(_value=value.toArrayValueObject().get(0,0)),_value.isArray()?_value.mapValue((valueObject=>this._handleSingleObject(valueObject))):this._handleSingleObject(_value)}_handleSingleObject(value){return value.isError()?value:value.isNull()||value.isBoolean()||value.isNumber()?StringValueObject.create(""):value}constructor(...args){super(...args),this.minParams=1,this.maxParams=1,this.needsReferenceObject=!0}},FUNCTION_NAMES_TEXT.T],[class Text extends base_function_BaseFunction{calculate(text,formatText){if(text.isError())return text;if(formatText.isError())return formatText;const maxRowLength=Math.max(text.isArray()?text.getRowCount():1,formatText.isArray()?formatText.getRowCount():1),maxColumnLength=Math.max(text.isArray()?text.getColumnCount():1,formatText.isArray()?formatText.getColumnCount():1),textArray=expandArrayValueObject(maxRowLength,maxColumnLength,text),formatTextArray=expandArrayValueObject(maxRowLength,maxColumnLength,formatText);return textArray.map(((textValue,rowIndex,columnIndex)=>{if(textValue.isError())return textValue;let formatTextValue=formatTextArray.get(rowIndex,columnIndex)||StringValueObject.create(" ");if(formatTextValue.isError())return formatTextValue;if(formatTextValue.isBoolean())return ErrorValueObject.create(error_type_ErrorType.VALUE);if(textValue.isBoolean())return textValue;let textValueNumber=textValue.getValue();if(textValue.isNull()&&(textValueNumber=0),textValue.isString()){if(!(0,src.DMQ)(textValueNumber))return textValue;textValueNumber=Number(textValueNumber)}formatTextValue.isNull()&&(formatTextValue=StringValueObject.create(" "));const formatTextValueString=`${formatTextValue.getValue()}`,previewText=getFormatPreview(formatTextValueString,textValueNumber);return StringValueObject.create(" "===formatTextValueString?previewText.trimEnd():previewText)}))}constructor(...args){super(...args),this.minParams=2,this.maxParams=2}},FUNCTION_NAMES_TEXT.TEXT],[class Textafter extends base_function_BaseFunction{calculate(text,delimiter,instanceNum,matchMode,matchEnd,ifNotFound){let instanceNumIsNull=!1,_instanceNum=instanceNum??NumberValueObject.create(1);_instanceNum.isNull()&&(instanceNumIsNull=!0,_instanceNum=NumberValueObject.create(1));const onlyThreeVariant=!matchMode,_matchMode=matchMode??NumberValueObject.create(0),_matchEnd=matchEnd??NumberValueObject.create(0),_ifNotFound=ifNotFound??ErrorValueObject.create(error_type_ErrorType.NA),maxRowLength=Math.max(text.isArray()?text.getRowCount():1,_instanceNum.isArray()?_instanceNum.getRowCount():1,_matchMode.isArray()?_matchMode.getRowCount():1,_matchEnd.isArray()?_matchEnd.getRowCount():1,_ifNotFound.isArray()?_ifNotFound.getRowCount():1),maxColumnLength=Math.max(text.isArray()?text.getColumnCount():1,_instanceNum.isArray()?_instanceNum.getColumnCount():1,_matchMode.isArray()?_matchMode.getColumnCount():1,_matchEnd.isArray()?_matchEnd.getColumnCount():1,_ifNotFound.isArray()?_ifNotFound.getColumnCount():1),textArray=expandArrayValueObject(maxRowLength,maxColumnLength,text,ErrorValueObject.create(error_type_ErrorType.NA)),instanceNumArray=expandArrayValueObject(maxRowLength,maxColumnLength,_instanceNum,ErrorValueObject.create(error_type_ErrorType.NA)),matchModeArray=expandArrayValueObject(maxRowLength,maxColumnLength,_matchMode,ErrorValueObject.create(error_type_ErrorType.NA)),matchEndArray=expandArrayValueObject(maxRowLength,maxColumnLength,_matchEnd,ErrorValueObject.create(error_type_ErrorType.NA)),ifNotFoundArray=expandArrayValueObject(maxRowLength,maxColumnLength,_ifNotFound,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=this._getResultArray(textArray,delimiter,instanceNumArray,matchModeArray,matchEndArray,ifNotFoundArray,instanceNumIsNull,onlyThreeVariant);return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_getResultArray(textArray,delimiter,instanceNumArray,matchModeArray,matchEndArray,ifNotFoundArray,instanceNumIsNull,onlyThreeVariant){return textArray.map(((textObject,rowIndex,columnIndex)=>{const instanceNumObject=instanceNumArray.get(rowIndex,columnIndex),matchModeObject=matchModeArray.get(rowIndex,columnIndex),matchEndObject=matchEndArray.get(rowIndex,columnIndex),ifNotFoundObject=ifNotFoundArray.get(rowIndex,columnIndex),_variantsError=this._checkVariantsError(textObject,instanceNumObject,matchModeObject,matchEndObject);if(_variantsError.isError())return _variantsError;const textValue=this._getStringValue(textObject),delimiterValue=this._getDelimiterValue(delimiter);if(delimiterValue instanceof ErrorValueObject)return delimiterValue;const _variantsNumberFloorValue=this._getVariantsNumberFloorValue(instanceNumObject,matchModeObject,matchEndObject);if(_variantsNumberFloorValue instanceof ErrorValueObject)return _variantsNumberFloorValue;const[instanceNumValue,matchModeValue,matchEndValue]=_variantsNumberFloorValue;return 0===instanceNumValue||matchModeValue<0||matchModeValue>1||matchEndValue<0||matchEndValue>1?ErrorValueObject.create(error_type_ErrorType.VALUE):delimiterValue.includes("")?instanceNumValue>0?StringValueObject.create(textValue):StringValueObject.create(""):!instanceNumIsNull&&Math.abs(instanceNumValue)>textValue.length?ErrorValueObject.create(error_type_ErrorType.VALUE):delimiterValue.every((item=>item.length>textValue.length))?ErrorValueObject.create(error_type_ErrorType.NA):this._getResult(textValue,delimiterValue,instanceNumValue,matchModeValue,matchEndValue,ifNotFoundObject,onlyThreeVariant)}))}_checkVariantsError(...variantas){for(let i=0;i<variantas.length;i++){const variant=variantas[i];if(variant.isError())return variant}return BooleanValueObject.create(!0)}_getStringValue(variant){let value=`${variant.getValue()}`;return variant.isNull()&&(value=""),variant.isBoolean()&&(value=value.toLocaleUpperCase()),value}_getDelimiterValue(delimiter){const delimiterValue=[];if(delimiter.isArray()){let isError=!1,errorObject=ErrorValueObject.create(error_type_ErrorType.VALUE);if(delimiter.iterator((delimiterObject=>{const _delimiterObject=delimiterObject;if(_delimiterObject.isError())return isError=!0,errorObject=_delimiterObject,!1;delimiterValue.push(this._getStringValue(_delimiterObject))})),isError)return errorObject}else{if(delimiter.isError())return delimiter;delimiterValue.push(this._getStringValue(delimiter))}return delimiterValue}_getVariantsNumberFloorValue(...variants){const values=[];for(let i=0;i<variants.length;i++){let variant=variants[i];if(variant.isString()&&(variant=variant.convertToNumberObjectValue()),variant.isError())return variant;const value=Math.floor(+variant.getValue());values.push(value)}return values}_getResult(textValue,delimiterValue,instanceNumValue,matchModeValue,matchEndValue,ifNotFoundObject,onlyThreeVariant){let substrText=matchModeValue?textValue.toLocaleLowerCase():textValue;const _delimiterValue=matchModeValue?delimiterValue.map((item=>item.toLocaleLowerCase())):delimiterValue;let resultIndex=0,matchNum=0,preDelimiterLength=0;for(let i=0;i<Math.abs(instanceNumValue);i++)if(instanceNumValue<0){const delimiterItem=_delimiterValue.map((item=>({index:substrText.lastIndexOf(item),length:item.length}))).filter((item=>-1!==item.index)).sort(((a,b)=>b.index-a.index))[0];if(!delimiterItem)break;resultIndex=delimiterItem.index,substrText=substrText.substr(0,delimiterItem.index),preDelimiterLength=delimiterItem.length,matchNum++}else{const delimiterItem=_delimiterValue.map((item=>({index:substrText.indexOf(item),length:item.length}))).filter((item=>-1!==item.index)).sort(((a,b)=>a.index-b.index))[0];if(!delimiterItem)break;resultIndex+=delimiterItem.index+preDelimiterLength,substrText=substrText.substr(delimiterItem.index+delimiterItem.length),preDelimiterLength=delimiterItem.length,matchNum++}if(matchNum&&matchNum<Math.abs(instanceNumValue)&&onlyThreeVariant)return ErrorValueObject.create(error_type_ErrorType.NA);if(!matchNum||matchNum<Math.abs(instanceNumValue))return matchEndValue?instanceNumValue>0?StringValueObject.create(""):StringValueObject.create(textValue):ifNotFoundObject;const result=textValue.substr(resultIndex+preDelimiterLength);return StringValueObject.create(result)}constructor(...args){super(...args),this.minParams=2,this.maxParams=6}},FUNCTION_NAMES_TEXT.TEXTAFTER],[class Textbefore extends base_function_BaseFunction{calculate(text,delimiter,instanceNum,matchMode,matchEnd,ifNotFound){let instanceNumIsNull=!1,_instanceNum=instanceNum??NumberValueObject.create(1);_instanceNum.isNull()&&(instanceNumIsNull=!0,_instanceNum=NumberValueObject.create(1));const onlyThreeVariant=!matchMode,_matchMode=matchMode??NumberValueObject.create(0),_matchEnd=matchEnd??NumberValueObject.create(0),_ifNotFound=ifNotFound??ErrorValueObject.create(error_type_ErrorType.NA),maxRowLength=Math.max(text.isArray()?text.getRowCount():1,_instanceNum.isArray()?_instanceNum.getRowCount():1,_matchMode.isArray()?_matchMode.getRowCount():1,_matchEnd.isArray()?_matchEnd.getRowCount():1,_ifNotFound.isArray()?_ifNotFound.getRowCount():1),maxColumnLength=Math.max(text.isArray()?text.getColumnCount():1,_instanceNum.isArray()?_instanceNum.getColumnCount():1,_matchMode.isArray()?_matchMode.getColumnCount():1,_matchEnd.isArray()?_matchEnd.getColumnCount():1,_ifNotFound.isArray()?_ifNotFound.getColumnCount():1),textArray=expandArrayValueObject(maxRowLength,maxColumnLength,text,ErrorValueObject.create(error_type_ErrorType.NA)),instanceNumArray=expandArrayValueObject(maxRowLength,maxColumnLength,_instanceNum,ErrorValueObject.create(error_type_ErrorType.NA)),matchModeArray=expandArrayValueObject(maxRowLength,maxColumnLength,_matchMode,ErrorValueObject.create(error_type_ErrorType.NA)),matchEndArray=expandArrayValueObject(maxRowLength,maxColumnLength,_matchEnd,ErrorValueObject.create(error_type_ErrorType.NA)),ifNotFoundArray=expandArrayValueObject(maxRowLength,maxColumnLength,_ifNotFound,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=this._getResultArray(textArray,delimiter,instanceNumArray,matchModeArray,matchEndArray,ifNotFoundArray,instanceNumIsNull,onlyThreeVariant);return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_getResultArray(textArray,delimiter,instanceNumArray,matchModeArray,matchEndArray,ifNotFoundArray,instanceNumIsNull,onlyThreeVariant){return textArray.map(((textObject,rowIndex,columnIndex)=>{const instanceNumObject=instanceNumArray.get(rowIndex,columnIndex),matchModeObject=matchModeArray.get(rowIndex,columnIndex),matchEndObject=matchEndArray.get(rowIndex,columnIndex),ifNotFoundObject=ifNotFoundArray.get(rowIndex,columnIndex),_variantsError=this._checkVariantsError(textObject,instanceNumObject,matchModeObject,matchEndObject);if(_variantsError.isError())return _variantsError;const textValue=this._getStringValue(textObject),delimiterValue=this._getDelimiterValue(delimiter);if(delimiterValue instanceof ErrorValueObject)return delimiterValue;const _variantsNumberFloorValue=this._getVariantsNumberFloorValue(instanceNumObject,matchModeObject,matchEndObject);if(_variantsNumberFloorValue instanceof ErrorValueObject)return _variantsNumberFloorValue;const[instanceNumValue,matchModeValue,matchEndValue]=_variantsNumberFloorValue;return 0===instanceNumValue||matchModeValue<0||matchModeValue>1||matchEndValue<0||matchEndValue>1?ErrorValueObject.create(error_type_ErrorType.VALUE):delimiterValue.includes("")?instanceNumValue>0?StringValueObject.create(""):StringValueObject.create(textValue):!instanceNumIsNull&&Math.abs(instanceNumValue)>textValue.length?ErrorValueObject.create(error_type_ErrorType.VALUE):delimiterValue.every((item=>item.length>textValue.length))?ErrorValueObject.create(error_type_ErrorType.NA):this._getResult(textValue,delimiterValue,instanceNumValue,matchModeValue,matchEndValue,ifNotFoundObject,onlyThreeVariant)}))}_checkVariantsError(...variantas){for(let i=0;i<variantas.length;i++){const variant=variantas[i];if(variant.isError())return variant}return BooleanValueObject.create(!0)}_getStringValue(variant){let value=`${variant.getValue()}`;return variant.isNull()&&(value=""),variant.isBoolean()&&(value=value.toLocaleUpperCase()),value}_getDelimiterValue(delimiter){const delimiterValue=[];if(delimiter.isArray()){let isError=!1,errorObject=ErrorValueObject.create(error_type_ErrorType.VALUE);if(delimiter.iterator((delimiterObject=>{const _delimiterObject=delimiterObject;if(_delimiterObject.isError())return isError=!0,errorObject=_delimiterObject,!1;delimiterValue.push(this._getStringValue(_delimiterObject))})),isError)return errorObject}else{if(delimiter.isError())return delimiter;delimiterValue.push(this._getStringValue(delimiter))}return delimiterValue}_getVariantsNumberFloorValue(...variants){const values=[];for(let i=0;i<variants.length;i++){let variant=variants[i];if(variant.isString()&&(variant=variant.convertToNumberObjectValue()),variant.isError())return variant;const value=Math.floor(+variant.getValue());values.push(value)}return values}_getResult(textValue,delimiterValue,instanceNumValue,matchModeValue,matchEndValue,ifNotFoundObject,onlyThreeVariant){let substrText=matchModeValue?textValue.toLocaleLowerCase():textValue;const _delimiterValue=matchModeValue?delimiterValue.map((item=>item.toLocaleLowerCase())):delimiterValue;let resultIndex=0,matchNum=0,preDelimiterLength=0;for(let i=0;i<Math.abs(instanceNumValue);i++)if(instanceNumValue<0){const delimiterItem=_delimiterValue.map((item=>({index:substrText.lastIndexOf(item),length:item.length}))).filter((item=>-1!==item.index)).sort(((a,b)=>b.index-a.index))[0];if(!delimiterItem)break;resultIndex=delimiterItem.index,substrText=substrText.substr(0,delimiterItem.index),matchNum++}else{const delimiterItem=_delimiterValue.map((item=>({index:substrText.indexOf(item),length:item.length}))).filter((item=>-1!==item.index)).sort(((a,b)=>a.index-b.index))[0];if(!delimiterItem)break;resultIndex+=delimiterItem.index+preDelimiterLength,substrText=substrText.substr(delimiterItem.index+delimiterItem.length),preDelimiterLength=delimiterItem.length,matchNum++}if(matchNum&&matchNum<Math.abs(instanceNumValue)&&onlyThreeVariant)return ErrorValueObject.create(error_type_ErrorType.NA);if(!matchNum||matchNum<Math.abs(instanceNumValue))return matchEndValue?instanceNumValue>0?StringValueObject.create(textValue):StringValueObject.create(""):ifNotFoundObject;const result=textValue.substr(0,resultIndex);return StringValueObject.create(result)}constructor(...args){super(...args),this.minParams=2,this.maxParams=6}},FUNCTION_NAMES_TEXT.TEXTBEFORE],[class Textjoin extends base_function_BaseFunction{calculate(delimiter,ignoreEmpty,...variants){const delimiterValues=this._getDelimiterValues(delimiter),textValues=this._getTextValues(variants);if(ignoreEmpty.isArray()){const resultArray=ignoreEmpty.mapValue((ignoreEmptyObject=>this._handleSingleObject(delimiterValues,ignoreEmptyObject,textValues)));return 1===resultArray.getRowCount()&&1===resultArray.getColumnCount()?resultArray.get(0,0):resultArray}const _ignoreEmpty=ignoreEmpty;if(_ignoreEmpty.isString()){const ignoreEmptyValue=`${_ignoreEmpty.getValue()}`.toLocaleUpperCase();if("TRUE"===ignoreEmptyValue)return this._handleSingleObject(delimiterValues,BooleanValueObject.create(!0),textValues);if("FALSE"===ignoreEmptyValue)return this._handleSingleObject(delimiterValues,BooleanValueObject.create(!1),textValues)}return this._handleSingleObject(delimiterValues,ignoreEmpty,textValues)}_handleSingleObject(delimiterValues,ignoreEmpty,textValues){if(delimiterValues instanceof ErrorValueObject)return delimiterValues;const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(ignoreEmpty);if(isError)return errorObject;if(textValues instanceof ErrorValueObject)return textValues;const[ignoreEmptyObject]=variants;let _textValues=textValues;+ignoreEmptyObject.getValue()&&(_textValues=textValues.filter((value=>null!==value)));let result="";for(let i=0;i<_textValues.length;i++)null!==_textValues[i]&&(result+=_textValues[i]),i<_textValues.length-1&&(result+=delimiterValues[i%delimiterValues.length]);return StringValueObject.create(result)}_getDelimiterValues(delimiter){const delimiterValues=[],rowCount=delimiter.isArray()?delimiter.getRowCount():1,columnCount=delimiter.isArray()?delimiter.getColumnCount():1;for(let r=0;r<rowCount;r++)for(let c=0;c<columnCount;c++){const valueObject=delimiter.isArray()?delimiter.get(r,c):delimiter;if(valueObject.isError())return valueObject;let value=`${valueObject.getValue()}`;valueObject.isNull()&&(value=""),valueObject.isBoolean()&&(value=value.toLocaleUpperCase()),delimiterValues.push(value)}return delimiterValues}_getTextValues(variants){const textValues=[];for(const variant of variants){const rowCount=variant.isArray()?variant.getRowCount():1,columnCount=variant.isArray()?variant.getColumnCount():1;for(let r=0;r<rowCount;r++)for(let c=0;c<columnCount;c++){const valueObject=variant.isArray()?variant.get(r,c):variant;if(valueObject.isError())return valueObject;if(valueObject.isNull()){textValues.push(null);continue}let value=`${valueObject.getValue()}`;valueObject.isBoolean()&&(value=value.toLocaleUpperCase()),textValues.push(value)}}return textValues}constructor(...args){super(...args),this.minParams=3,this.maxParams=255}},FUNCTION_NAMES_TEXT.TEXTJOIN],[class Textsplit extends base_function_BaseFunction{calculate(text,colDelimiter,rowDelimiter,ignoreEmpty,matchMode,padWith){let _rowDelimiter=rowDelimiter??StringValueObject.create("\\s");const _ignoreEmpty=ignoreEmpty??NumberValueObject.create(0),_matchMode=matchMode??NumberValueObject.create(0),_padWith=padWith??StringValueObject.create(error_type_ErrorType.NA),{_variant:_colDelimiter,values:colDelimiterValue}=this._getStringValues(colDelimiter),{_variant,values:rowDelimiterValue}=this._getStringValues(_rowDelimiter,!1);_rowDelimiter=_variant;const maxRowLength=Math.max(text.isArray()?text.getRowCount():1,_ignoreEmpty.isArray()?_ignoreEmpty.getRowCount():1,_matchMode.isArray()?_matchMode.getRowCount():1),maxColumnLength=Math.max(text.isArray()?text.getColumnCount():1,_ignoreEmpty.isArray()?_ignoreEmpty.getColumnCount():1,_matchMode.isArray()?_matchMode.getColumnCount():1),textArray=expandArrayValueObject(maxRowLength,maxColumnLength,text,ErrorValueObject.create(error_type_ErrorType.NA)),ignoreEmptyArray=expandArrayValueObject(maxRowLength,maxColumnLength,_ignoreEmpty,ErrorValueObject.create(error_type_ErrorType.NA)),matchModeArray=expandArrayValueObject(maxRowLength,maxColumnLength,_matchMode,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=this._getResultArray(textArray,_colDelimiter,_rowDelimiter,ignoreEmptyArray,matchModeArray,_padWith,colDelimiterValue,rowDelimiterValue);return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray.map((item=>item.get(0,0)))}_getStringValues(variant,isNotNull=!0){let _variant=variant;const values=[];if(_variant.isArray())_variant.iterator((variantObject=>{if(variantObject?.isError())return _variant=variantObject,!1;if(variantObject?.isNull()&&isNotNull)return _variant=ErrorValueObject.create(error_type_ErrorType.VALUE),!1;const value=this._getRegExpStringValue(variantObject);if(""===value)return _variant=ErrorValueObject.create(error_type_ErrorType.VALUE),!1;values.push(value)}));else{_variant.isNull()&&isNotNull&&(_variant=ErrorValueObject.create(error_type_ErrorType.VALUE));const value=this._getRegExpStringValue(_variant);""===value&&(_variant=ErrorValueObject.create(error_type_ErrorType.VALUE)),values.push(value)}return{_variant,values}}_getResultArray(textArray,colDelimiter,rowDelimiter,ignoreEmptyArray,matchModeArray,padWith,colDelimiterValue,rowDelimiterValue){return textArray.map(((textObject,rowIndex,columnIndex)=>{let ignoreEmptyObject=ignoreEmptyArray.get(rowIndex,columnIndex),matchModeObject=matchModeArray.get(rowIndex,columnIndex);const _variantsError=this._checkVariantsError(textObject,colDelimiter,rowDelimiter,ignoreEmptyObject,matchModeObject);if(_variantsError.isError())return _variantsError;if(textObject.isNull())return ErrorValueObject.create(error_type_ErrorType.VALUE);let _padWith=padWith;if(_padWith.isArray()){const padWithRowCount=_padWith.getRowCount(),padWithColumnCount=_padWith.getColumnCount();if(padWithRowCount>1||padWithColumnCount>1)return ErrorValueObject.create(error_type_ErrorType.VALUE);_padWith=_padWith.get(0,0)}let textValue=`${textObject.getValue()}`;if(textObject.isBoolean()&&(textValue=textValue.toLocaleUpperCase()),ignoreEmptyObject.isString()&&(ignoreEmptyObject=ignoreEmptyObject.convertToNumberObjectValue(),ignoreEmptyObject.isError()))return ignoreEmptyObject;const ignoreEmptyValue=Math.floor(+ignoreEmptyObject.getValue());if(matchModeObject.isString()&&(matchModeObject=matchModeObject.convertToNumberObjectValue(),matchModeObject.isError()))return matchModeObject;const matchModeValue=Math.floor(+matchModeObject.getValue());if(matchModeValue<0||matchModeValue>1)return ErrorValueObject.create(error_type_ErrorType.VALUE);let padWithValue=`${_padWith.getValue()}`;return _padWith.isBoolean()&&(padWithValue=padWithValue.toLocaleUpperCase()),this._getResult(textValue,colDelimiterValue,rowDelimiterValue,ignoreEmptyValue,matchModeValue,padWithValue)}))}_getResult(textValue,colDelimiterValue,rowDelimiterValue,ignoreEmptyValue,matchModeValue,padWithValue){const rowDelimiterRegExp=new RegExp(rowDelimiterValue.join("|"),"g"+(matchModeValue?"i":"")),colDelimiterRegExp=new RegExp(colDelimiterValue.join("|"),"g"+(matchModeValue?"i":"")),resultRows=textValue.split(rowDelimiterRegExp);let resultColsMaxCount=1,result=resultRows.map((row=>{let cols=row.split(colDelimiterRegExp);return ignoreEmptyValue&&(cols=cols.filter((col=>""!==col))),resultColsMaxCount=Math.max(resultColsMaxCount,cols.length),cols}));return result=result.map((row=>{let _row=row;return _row.length<resultColsMaxCount&&(_row=_row.concat(new Array(resultColsMaxCount-_row.length).fill(padWithValue))),_row})),ArrayValueObject.createByArray(result)}_checkVariantsError(...variantas){for(let i=0;i<variantas.length;i++){const variant=variantas[i];if(variant.isError())return variant}return BooleanValueObject.create(!0)}_getRegExpStringValue(valueObject){let value=valueObject.getValue();return valueObject.isNull()&&(value="\\s"),valueObject.isBoolean()&&(value=value?"TRUE":"FALSE"),value+="",this._escapeRegExp(value)}_escapeRegExp(string){return string.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}constructor(...args){super(...args),this.minParams=2,this.maxParams=6}},FUNCTION_NAMES_TEXT.TEXTSPLIT],[class Trim extends base_function_BaseFunction{calculate(text){if(text.isArray()){const resultArray=text.mapValue((textObject=>this._handleSingleObject(textObject)));return 1===resultArray.getRowCount()&&1===resultArray.getColumnCount()?resultArray.get(0,0):resultArray}return this._handleSingleObject(text)}_handleSingleObject(text){if(text.isError())return text;if(text.isNull())return StringValueObject.create("");let textValue=`${text.getValue()}`;return text.isBoolean()&&(textValue=textValue.toLocaleUpperCase()),textValue=textValue.trim().replace(/\s+/g," "),StringValueObject.create(textValue)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_TEXT.TRIM],[class Unichar extends base_function_BaseFunction{calculate(number){if(number.isArray()){const resultArray=number.mapValue((numberObject=>this._handleSingleObject(numberObject)));return 1===resultArray.getRowCount()&&1===resultArray.getColumnCount()?resultArray.get(0,0):resultArray}return this._handleSingleObject(number)}_handleSingleObject(number){const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(number);if(isError)return errorObject;const[numberObject]=variants,numberValue=Math.floor(+numberObject.getValue());if(numberValue<1||numberValue>1114111)return ErrorValueObject.create(error_type_ErrorType.VALUE);if(1114111===numberValue||1114110===numberValue)return ErrorValueObject.create(error_type_ErrorType.NA);let result=String.fromCharCode(numberValue);return unichar_filterCodeArray.some((value=>value===result))&&(result=String.fromCharCode(1)),StringValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_TEXT.UNICHAR],[class Unicode extends base_function_BaseFunction{calculate(text){if(text.isArray()){const resultArray=text.mapValue((textObject=>this._handleSingleObject(textObject)));return 1===resultArray.getRowCount()&&1===resultArray.getColumnCount()?resultArray.get(0,0):resultArray}return this._handleSingleObject(text)}_handleSingleObject(text){if(text.isError())return text;if(text.isNull())return ErrorValueObject.create(error_type_ErrorType.VALUE);let textValue=text.getValue().toLocaleString();text.isBoolean()&&(textValue=textValue.toLocaleUpperCase());const result=textValue.charCodeAt(0);return NumberValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_TEXT.UNICODE],[class Upper extends base_function_BaseFunction{calculate(text){if(text.isArray()){const resultArray=text.mapValue((textObject=>this._handleSingleObject(textObject)));return 1===resultArray.getRowCount()&&1===resultArray.getColumnCount()?resultArray.get(0,0):resultArray}return this._handleSingleObject(text)}_handleSingleObject(text){if(text.isError())return text;if(text.isNull())return StringValueObject.create("");const result=`${text.getValue()}`.toLocaleUpperCase();return StringValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_TEXT.UPPER],[class Value extends base_function_BaseFunction{calculate(text){if(text.isArray()){const resultArray=text.mapValue((textObject=>this._handleSingleObject(textObject)));return 1===resultArray.getRowCount()&&1===resultArray.getColumnCount()?resultArray.get(0,0):resultArray}return this._handleSingleObject(text)}_handleSingleObject(text){if(text.isError())return text;if(text.isBoolean())return ErrorValueObject.create(error_type_ErrorType.VALUE);let _text=text;if(text.isString()&&(_text=_text.convertToNumberObjectValue(),_text.isError()))return _text;const textValue=+_text.getValue();return NumberValueObject.create(textValue)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_TEXT.VALUE],[class Valuetotext extends base_function_BaseFunction{calculate(value,format){const _format=format??NumberValueObject.create(0),maxRowLength=Math.max(value.isArray()?value.getRowCount():1,_format.isArray()?_format.getRowCount():1),maxColumnLength=Math.max(value.isArray()?value.getColumnCount():1,_format.isArray()?_format.getColumnCount():1),valueArray=expandArrayValueObject(maxRowLength,maxColumnLength,value,ErrorValueObject.create(error_type_ErrorType.NA)),formatArray=expandArrayValueObject(maxRowLength,maxColumnLength,_format,ErrorValueObject.create(error_type_ErrorType.NA)),resultArray=valueArray.mapValue(((valueObject,rowIndex,columnIndex)=>{const formatObject=formatArray.get(rowIndex,columnIndex);return valueObject.isError()?valueObject:formatObject.isError()?formatObject:this._handleSingleObject(valueObject,formatObject)}));return 1===maxRowLength&&1===maxColumnLength?resultArray.get(0,0):resultArray}_handleSingleObject(value,format){const{isError,errorObject,variants}=checkVariantsErrorIsStringToNumber(format);if(isError)return errorObject;const[formatObject]=variants,formatValue=Math.floor(+formatObject.getValue());if(formatValue<0||formatValue>1)return ErrorValueObject.create(error_type_ErrorType.VALUE);if(value.isNull())return StringValueObject.create("");if(value.isBoolean())return value;if(value.isNumber())return NumberValueObject.create(value.getValue());const result=formatValue?`"${value.getValue()}"`:`${value.getValue()}`;return StringValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=2}},FUNCTION_NAMES_TEXT.VALUETOTEXT]];var FUNCTION_NAMES_WEB=function(FUNCTION_NAMES_WEB){return FUNCTION_NAMES_WEB.ENCODEURL="ENCODEURL",FUNCTION_NAMES_WEB.FILTERXML="FILTERXML",FUNCTION_NAMES_WEB.WEBSERVICE="WEBSERVICE",FUNCTION_NAMES_WEB}({});const functionWeb=[[class Encodeurl extends base_function_BaseFunction{calculate(text){if(text.isArray()){const resultArray=text.mapValue((textObject=>this._handleSingleObject(textObject)));return 1===resultArray.getRowCount()&&1===resultArray.getColumnCount()?resultArray.get(0,0):resultArray}return this._handleSingleObject(text)}_handleSingleObject(text){if(text.isError())return text;const textValue=getTextValueOfNumberFormat(text),result=encodeURIComponent(textValue).replace(/[!~'()*]/g,(c=>`%${c.charCodeAt(0).toString(16).toLocaleUpperCase()}`));return StringValueObject.create(result)}constructor(...args){super(...args),this.minParams=1,this.maxParams=1}},FUNCTION_NAMES_WEB.ENCODEURL]];var Observable=__webpack_require__("../../node_modules/.pnpm/rxjs@7.8.1/node_modules/rxjs/dist/esm5/internal/Observable.js"),distinctUntilChanged=__webpack_require__("../../node_modules/.pnpm/rxjs@7.8.1/node_modules/rxjs/dist/esm5/internal/operators/distinctUntilChanged.js"),shareReplay=__webpack_require__("../../node_modules/.pnpm/rxjs@7.8.1/node_modules/rxjs/dist/esm5/internal/operators/shareReplay.js"),BehaviorSubject=__webpack_require__("../../node_modules/.pnpm/rxjs@7.8.1/node_modules/rxjs/dist/esm5/internal/BehaviorSubject.js"),combineLatest=__webpack_require__("../../node_modules/.pnpm/rxjs@7.8.1/node_modules/rxjs/dist/esm5/internal/observable/combineLatest.js"),map=__webpack_require__("../../node_modules/.pnpm/rxjs@7.8.1/node_modules/rxjs/dist/esm5/internal/operators/map.js");class GlobalComputingStatusService extends src.jGt{get computingStatus(){return this._computingStatus$.getValue()}dispose(){super.dispose(),this._computingSubscription?.unsubscribe(),this._computingStatus$.next(!0),this._computingStatus$.complete(),this._allSubjects.forEach((subject=>{subject.complete()}))}pushComputingStatusSubject(subject){return this._allSubjects.push(subject),this._updateComputingObservable(),{dispose:()=>{const index=this._allSubjects.indexOf(subject);-1!==index&&this._allSubjects.splice(index,1),this._updateComputingObservable()}}}_updateComputingObservable(){this._computingSubscription?.unsubscribe(),0!==this._allSubjects.length?this._computingSubscription=(0,combineLatest.z)(this._allSubjects).pipe((0,map.T)((values=>values.every((v=>v))))).subscribe((computing=>this._computingStatus$.next(computing))):this._computingStatus$.next(!0)}constructor(...args){super(...args),this._allSubjects=[],this._computingStatus$=new BehaviorSubject.t(!0),this.computingStatus$=this._computingStatus$.pipe((0,distinctUntilChanged.F)())}}function computing_status_controller_ts_metadata(k,v){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(k,v)}function computing_status_controller_ts_param(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}}class ComputingStatusReporterController extends src.jGt{constructor(_commandService,_globalComputingSrv){super(),this._commandService=_commandService,this._globalComputingSrv=_globalComputingSrv,this._computingCompleted$=new Observable.c((observe=>{this._commandService.onCommandExecuted((command=>{if(command.id!==SetFormulaCalculationNotificationMutation.id)return;const params=command.params;return params.stageInfo?observe.next(params.stageInfo.stage===FormulaExecuteStageType.IDLE||params.stageInfo.stage===FormulaExecuteStageType.CALCULATION_COMPLETED):void 0}))})).pipe((0,distinctUntilChanged.F)(),(0,shareReplay.t)());const disposables=new src.VdD,subject=new BehaviorSubject.t(!0);disposables.add(this._globalComputingSrv.pushComputingStatusSubject(subject)),disposables.add(this._computingCompleted$.subscribe((completed=>subject.next(completed)))),disposables.add((()=>subject.complete())),this.disposeWithMe(disposables)}}ComputingStatusReporterController=function computing_status_controller_ts_decorate(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r}([computing_status_controller_ts_param(0,src.wTY),computing_status_controller_ts_param(1,(0,src.y_5)(GlobalComputingStatusService)),computing_status_controller_ts_metadata("design:type",Function),computing_status_controller_ts_metadata("design:paramtypes",[void 0===src.wTY?Object:src.wTY,void 0===GlobalComputingStatusService?Object:GlobalComputingStatusService])],ComputingStatusReporterController);var rpc_src=__webpack_require__("../../packages/rpc/src/index.ts");const functionCube=[],functionUniver=[];function formula_controller_ts_metadata(k,v){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(k,v)}function formula_controller_ts_param(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}}class FormulaController extends src.jGt{constructor(_commandService,_functionService,_configService,_dataSyncPrimaryController){super(),this._commandService=_commandService,this._functionService=_functionService,this._configService=_configService,this._dataSyncPrimaryController=_dataSyncPrimaryController,this._initialize()}_initialize(){this._registerCommands(),this._registerFunctions()}_registerCommands(){[SetFormulaDataMutation,SetArrayFormulaDataMutation,SetFormulaCalculationStartMutation,SetFormulaCalculationStopMutation,SetFormulaCalculationNotificationMutation,SetFormulaCalculationResultMutation,SetDefinedNameMutation,RemoveDefinedNameMutation,SetFeatureCalculationMutation,RemoveFeatureCalculationMutation,SetOtherFormulaMutation,RemoveOtherFormulaMutation,SetSuperTableMutation,RemoveSuperTableMutation,SetSuperTableOptionMutation,RegisterFunctionMutation].forEach((mutation=>{this._commandService.registerCommand(mutation),this._dataSyncPrimaryController?.registerSyncingMutations(mutation)}))}_registerFunctions(){const config=this._configService.getConfig("engine-formula.config"),functions=[...functionArray,...functionCompatibility,...functionCube,...functionDatabase,...functionDate,...functionEngineering,...functionFinancial,...functionInformation,...functionLogical,...functionLookup,...functionMath,...functionMeta,...functionStatistical,...functionText,...functionUniver,...functionWeb].concat(config?.function??[]).map((registerObject=>new(0,registerObject[0])(registerObject[1])));this._functionService.registerExecutors(...functions)}}function set_dependency_controller_ts_metadata(k,v){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(k,v)}function set_dependency_controller_ts_param(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}}FormulaController=function formula_controller_ts_decorate(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r}([formula_controller_ts_param(0,src.wTY),formula_controller_ts_param(1,IFunctionService),formula_controller_ts_param(2,src.J0C),formula_controller_ts_param(3,(0,src.Xx1)(rpc_src.Y7)),formula_controller_ts_metadata("design:type",Function),formula_controller_ts_metadata("design:paramtypes",[void 0===src.wTY?Object:src.wTY,void 0===IFunctionService?Object:IFunctionService,void 0===src.J0C?Object:src.J0C,void 0===rpc_src.Y7?Object:rpc_src.Y7])],FormulaController);class SetDependencyController extends src.jGt{constructor(_commandService,_dependencyManagerService,_featureCalculationManagerService){super(),this._commandService=_commandService,this._dependencyManagerService=_dependencyManagerService,this._featureCalculationManagerService=_featureCalculationManagerService,this._initialize()}_initialize(){this._commandExecutedListener(),this._featureCalculationManagerServiceListener()}_featureCalculationManagerServiceListener(){this.disposeWithMe(this._featureCalculationManagerService.onChanged$.subscribe((params=>{const{unitId,subUnitId,featureIds}=params;this._dependencyManagerService.removeFeatureFormulaDependency(unitId,subUnitId,featureIds)})))}_commandExecutedListener(){this.disposeWithMe(this._commandService.onCommandExecuted((command=>{if(command.id===RemoveFeatureCalculationMutation.id){const params=command.params;if(null==params)return;const{featureIds,unitId,subUnitId}=params;this._dependencyManagerService.removeFeatureFormulaDependency(unitId,subUnitId,featureIds)}else if(command.id===SetFeatureCalculationMutation.id){const params=command.params;if(null==params)return;const{featureId,calculationParam}=params,{unitId,subUnitId}=calculationParam;this._dependencyManagerService.removeFeatureFormulaDependency(unitId,subUnitId,[featureId])}else if(command.id===RemoveOtherFormulaMutation.id){const params=command.params;if(null==params)return;this._dependencyManagerService.removeOtherFormulaDependency(params.unitId,params.subUnitId,params.formulaIdList)}else if(command.id===SetOtherFormulaMutation.id){const params=command.params;if(null==params)return;const formulaMap=params.formulaMap,formulaIdList=[];Object.keys(formulaMap).forEach((formulaId=>{formulaIdList.push(formulaId)})),this._dependencyManagerService.removeOtherFormulaDependency(params.unitId,params.subUnitId,formulaIdList)}else if(command.id===SetFormulaDataMutation.id){const formulaData=command.params.formulaData;Object.keys(formulaData).forEach((unitId=>{const unitFormulaData=formulaData[unitId];void 0!==unitFormulaData&&(null!==unitFormulaData?Object.keys(unitFormulaData).forEach((subUnitId=>{const formulaDataItem=unitFormulaData[subUnitId];if(void 0!==formulaDataItem)return null===formulaDataItem?(this._dependencyManagerService.clearFormulaDependency(unitId,subUnitId),!0):void new src.hDc(formulaDataItem).forValue(((row,column)=>{this._dependencyManagerService.removeFormulaDependency(unitId,subUnitId,row,column)}))})):this._dependencyManagerService.clearFormulaDependency(unitId))}))}else command.id===SetDefinedNameMutation.id&&this._handleSetDefinedName(command)})))}_handleSetDefinedName(command){const params=command.params;if(null==params)return;const{unitId,name}=params;this._dependencyManagerService.removeFormulaDependencyByDefinedName(unitId,name)}}function set_feature_calculation_controller_ts_metadata(k,v){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(k,v)}function set_feature_calculation_controller_ts_param(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}}SetDependencyController=function set_dependency_controller_ts_decorate(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r}([set_dependency_controller_ts_param(0,src.wTY),set_dependency_controller_ts_param(1,IFeatureCalculationManagerService),set_dependency_controller_ts_param(1,IDependencyManagerService),set_dependency_controller_ts_param(2,IFeatureCalculationManagerService),set_dependency_controller_ts_metadata("design:type",Function),set_dependency_controller_ts_metadata("design:paramtypes",[void 0===src.wTY?Object:src.wTY,void 0===IDependencyManagerService?Object:IDependencyManagerService,void 0===IFeatureCalculationManagerService?Object:IFeatureCalculationManagerService])],SetDependencyController);class SetFeatureCalculationController extends src.jGt{constructor(_commandService,_featureCalculationManagerService){super(),this._commandService=_commandService,this._featureCalculationManagerService=_featureCalculationManagerService,this._initialize()}_initialize(){this._commandExecutedListener()}_commandExecutedListener(){this.disposeWithMe(this._commandService.onCommandExecuted((command=>{if(command.id===SetFeatureCalculationMutation.id){const params=command.params;if(null==params)return;const{featureId,calculationParam}=params,{unitId,subUnitId}=calculationParam;this._featureCalculationManagerService.register(unitId,subUnitId,featureId,calculationParam)}else if(command.id===RemoveFeatureCalculationMutation.id){const params=command.params;if(null==params)return;const{featureIds,unitId,subUnitId}=params;this._featureCalculationManagerService.remove(unitId,subUnitId,featureIds)}})))}}function set_other_formula_controller_ts_metadata(k,v){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(k,v)}function set_other_formula_controller_ts_param(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}}SetFeatureCalculationController=function set_feature_calculation_controller_ts_decorate(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r}([set_feature_calculation_controller_ts_param(0,src.wTY),set_feature_calculation_controller_ts_param(1,IFeatureCalculationManagerService),set_feature_calculation_controller_ts_metadata("design:type",Function),set_feature_calculation_controller_ts_metadata("design:paramtypes",[void 0===src.wTY?Object:src.wTY,void 0===IFeatureCalculationManagerService?Object:IFeatureCalculationManagerService])],SetFeatureCalculationController);class SetOtherFormulaController extends src.jGt{constructor(_commandService,_otherFormulaManagerService,_dependencyManagerService){super(),this._commandService=_commandService,this._otherFormulaManagerService=_otherFormulaManagerService,this._dependencyManagerService=_dependencyManagerService,this._initialize()}_initialize(){this._commandExecutedListener()}_commandExecutedListener(){this.disposeWithMe(this._commandService.onCommandExecuted((command=>{if(command.id===SetOtherFormulaMutation.id){const params=command.params;if(null==params)return;const config={[params.unitId]:{[params.subUnitId]:params.formulaMap}};this._otherFormulaManagerService.batchRegister(config)}else if(command.id===RemoveOtherFormulaMutation.id){const params=command.params;if(null==params)return;const obj={};params.formulaIdList.forEach((id=>obj[id]=!0));const config={[params.unitId]:{[params.subUnitId]:obj}};this._otherFormulaManagerService.batchRemove(config)}})))}}SetOtherFormulaController=function set_other_formula_controller_ts_decorate(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r}([set_other_formula_controller_ts_param(0,src.wTY),set_other_formula_controller_ts_param(1,IOtherFormulaManagerService),set_other_formula_controller_ts_param(2,IDependencyManagerService),set_other_formula_controller_ts_metadata("design:type",Function),set_other_formula_controller_ts_metadata("design:paramtypes",[void 0===src.wTY?Object:src.wTY,void 0===IOtherFormulaManagerService?Object:IOtherFormulaManagerService,void 0===IDependencyManagerService?Object:IDependencyManagerService])],SetOtherFormulaController);class SuperTableService extends src.jGt{dispose(){super.dispose(),this._tableMap.clear(),this._tableOptionMap.clear()}remove(unitId,tableName){this._tableMap.get(unitId)?.delete(tableName)}getTableMap(unitId){return this._tableMap.get(unitId)}getTableOptionMap(){return this._tableOptionMap}registerTable(unitId,tableName,reference){null==this._tableMap.get(unitId)&&this._tableMap.set(unitId,new Map),this._tableMap.get(unitId)?.set(tableName,reference)}registerTableOptionMap(tableOption,tableOptionType){this._tableOptionMap.set(tableOption,tableOptionType)}constructor(...args){super(...args),this._tableMap=new Map,this._tableOptionMap=new Map}}const ISuperTableService=(0,src.Qmd)("univer.formula.super-table.service");function set_super_table_controller_ts_metadata(k,v){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(k,v)}function set_super_table_controller_ts_param(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}}class SetSuperTableController extends src.jGt{constructor(_commandService,_superTableService){super(),this._commandService=_commandService,this._superTableService=_superTableService,this._initialize()}_initialize(){this._commandExecutedListener()}_commandExecutedListener(){this.disposeWithMe(this._commandService.onCommandExecuted((command=>{if(command.id===SetDefinedNameMutation.id){const params=command.params;if(null==params)return;const{unitId,tableName,reference}=params;this._superTableService.registerTable(unitId,tableName,reference)}else if(command.id===RemoveDefinedNameMutation.id){const params=command.params;if(null==params)return;const{unitId,tableName}=params;this._superTableService.remove(unitId,tableName)}else if(command.id===SetSuperTableOptionMutation.id){const params=command.params;if(null==params)return;const{tableOption,tableOptionType}=params;this._superTableService.registerTableOptionMap(tableOption,tableOptionType)}})))}}SetSuperTableController=function set_super_table_controller_ts_decorate(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r}([set_super_table_controller_ts_param(0,src.wTY),set_super_table_controller_ts_param(1,ISuperTableService),set_super_table_controller_ts_metadata("design:type",Function),set_super_table_controller_ts_metadata("design:paramtypes",[void 0===src.wTY?Object:src.wTY,void 0===ISuperTableService?Object:ISuperTableService])],SetSuperTableController);class ActiveDirtyManagerService extends src.jGt{dispose(){this._dirtyConversionMap.clear()}remove(commandId){this._dirtyConversionMap.delete(commandId)}get(commandId){return this._dirtyConversionMap.get(commandId)}has(commandId){return this._dirtyConversionMap.has(commandId)}register(commandId,dirtyConversion){this._dirtyConversionMap.set(commandId,dirtyConversion)}getDirtyConversionMap(){return this._dirtyConversionMap}constructor(...args){super(...args),this._dirtyConversionMap=new Map}}const IActiveDirtyManagerService=(0,src.Qmd)("univer.formula.active-dirty-manager.service");function plugin_ts_metadata(k,v){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(k,v)}function plugin_ts_param(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}}class UniverFormulaEnginePlugin extends src.k_1{static#_=this.pluginName="UNIVER_ENGINE_FORMULA_PLUGIN";constructor(_config=defaultPluginConfig,_injector,_configService){super(),this._config=_config,this._injector=_injector,this._configService=_configService;const{...rest}=(0,src.h1I)({},defaultPluginConfig,this._config);this._configService.setConfig("engine-formula.config",rest)}onStarting(){this._initialize(),this._initializeWithOverride()}onReady(){(0,src.HLP)(this._injector,[[FormulaController],[SetSuperTableController]]),this._config?.notExecuteFormula||(0,src.HLP)(this._injector,[[SetOtherFormulaController],[SetFeatureCalculationController],[SetDependencyController],[CalculateController]])}onRendered(){this._config?.notExecuteFormula||(0,src.HLP)(this._injector,[[ICalculateFormulaService],[IFormulaDependencyGenerator]])}_initialize(){const shouldPerformComputing=!this._config.notExecuteFormula,dependencies=[[IFunctionService,{useClass:FunctionService}],[IDefinedNamesService,{useClass:DefinedNamesService}],[IActiveDirtyManagerService,{useClass:ActiveDirtyManagerService}],[ISuperTableService,{useClass:SuperTableService}],[GlobalComputingStatusService],[FormulaDataModel],[LexerTreeBuilder],[FormulaController],[SetSuperTableController],[ComputingStatusReporterController]];shouldPerformComputing&&dependencies.push([IOtherFormulaManagerService,{useClass:OtherFormulaManagerService}],[IFormulaRuntimeService,{useClass:FormulaRuntimeService}],[IFormulaCurrentConfigService,{useClass:FormulaCurrentConfigService}],[IFeatureCalculationManagerService,{useClass:FeatureCalculationManagerService}],[CalculateController],[SetOtherFormulaController],[SetDependencyController],[SetFeatureCalculationController],[Interpreter],[AstTreeBuilder],[Lexer],[AstRootNodeFactory],[FunctionNodeFactory],[LambdaNodeFactory],[LambdaParameterNodeFactory],[OperatorNodeFactory],[PrefixNodeFactory],[ReferenceNodeFactory],[SuffixNodeFactory],[UnionNodeFactory],[ValueNodeFactory]),dependencies.forEach((dependency=>this._injector.add(dependency)))}_initializeWithOverride(){if(!this._config?.notExecuteFormula){[[ICalculateFormulaService,{useClass:CalculateFormulaService}],[IDependencyManagerService,{useClass:DependencyManagerService}],[IFormulaDependencyGenerator,{useClass:FormulaDependencyGenerator}]].forEach((dependency=>this._injector.add(dependency)))}}}UniverFormulaEnginePlugin=function plugin_ts_decorate(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r}([plugin_ts_param(1,(0,src.y_5)(src.zZn)),plugin_ts_param(2,src.J0C),plugin_ts_metadata("design:type",Function),plugin_ts_metadata("design:paramtypes",["undefined"==typeof Partial?Object:Partial,void 0===src.zZn?Object:src.zZn,void 0===src.J0C?Object:src.J0C])],UniverFormulaEnginePlugin)},"../../packages/engine-numfmt/src/util.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{Z:()=>isTextFormat});const DEFAULT_TEXT_FORMAT="@@@",DEFAULT_TEXT_FORMAT_EXCEL="@";function isTextFormat(pattern){return pattern===DEFAULT_TEXT_FORMAT||pattern===DEFAULT_TEXT_FORMAT_EXCEL}},"../../packages/rpc/src/index.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{Y7:()=>DataSyncPrimaryController});var src=__webpack_require__("../../packages/core/src/index.ts");Symbol("rpc.main-thread.config");const defaultPluginMainThreadConfig={},defaultPluginWorkerThreadConfig=(Symbol("rpc.worker-thread.config"),{});var takeUntil=__webpack_require__("../../node_modules/.pnpm/rxjs@7.8.1/node_modules/rxjs/dist/esm5/internal/operators/takeUntil.js");function _ts_decorate(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r}function _ts_metadata(k,v){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(k,v)}function _ts_param(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}}const IRemoteSyncService=(0,src.Qmd)("rpc.remote-sync.service");class RemoteSyncPrimaryService{constructor(_commandService){this._commandService=_commandService}async syncMutation(params){return this._commandService.syncExecuteCommand(params.mutationInfo.id,params.mutationInfo.params,{onlyLocal:!0,fromSync:!0})}}RemoteSyncPrimaryService=_ts_decorate([_ts_param(0,src.wTY),_ts_metadata("design:type",Function),_ts_metadata("design:paramtypes",[void 0===src.wTY?Object:src.wTY])],RemoteSyncPrimaryService);const IRemoteInstanceService=(0,src.Qmd)("univer.remote-instance-service");class WebWorkerRemoteInstanceService{constructor(_univerInstanceService,_commandService,_logService){this._univerInstanceService=_univerInstanceService,this._commandService=_commandService,this._logService=_logService}whenReady(){return Promise.resolve(!0)}async syncMutation(params){return this._applyMutation(params.mutationInfo)}async createInstance(params){const{type,snapshot}=params;try{if(type===src.Zy$.UNIVER_SHEET)return this._univerInstanceService.createUnit(src.Zy$.UNIVER_SHEET,snapshot),!0;throw new Error(`[WebWorkerRemoteInstanceService]: cannot create replica for document type: ${type}.`)}catch(err){throw err instanceof Error?err:new TypeError(`${err}`)}}async disposeInstance(params){return this._univerInstanceService.disposeUnit(params.unitID)}_applyMutation(mutationInfo){const{id,params:mutationParams}=mutationInfo;return this._commandService.syncExecuteCommand(id,mutationParams,{onlyLocal:!0,fromSync:!0})}}WebWorkerRemoteInstanceService=_ts_decorate([_ts_param(0,src.HCr),_ts_param(1,src.wTY),_ts_param(2,src.rrK),_ts_metadata("design:type",Function),_ts_metadata("design:paramtypes",[void 0===src.HCr?Object:src.HCr,void 0===src.wTY?Object:src.wTY,void 0===src.rrK?Object:src.rrK])],WebWorkerRemoteInstanceService);var isObservable=__webpack_require__("../../node_modules/.pnpm/rxjs@7.8.1/node_modules/rxjs/dist/esm5/internal/util/isObservable.js"),of=__webpack_require__("../../node_modules/.pnpm/rxjs@7.8.1/node_modules/rxjs/dist/esm5/internal/observable/of.js"),BehaviorSubject=__webpack_require__("../../node_modules/.pnpm/rxjs@7.8.1/node_modules/rxjs/dist/esm5/internal/BehaviorSubject.js"),firstValueFrom=__webpack_require__("../../node_modules/.pnpm/rxjs@7.8.1/node_modules/rxjs/dist/esm5/internal/firstValueFrom.js"),Observable=__webpack_require__("../../node_modules/.pnpm/rxjs@7.8.1/node_modules/rxjs/dist/esm5/internal/Observable.js"),filter=__webpack_require__("../../node_modules/.pnpm/rxjs@7.8.1/node_modules/rxjs/dist/esm5/internal/operators/filter.js"),take=__webpack_require__("../../node_modules/.pnpm/rxjs@7.8.1/node_modules/rxjs/dist/esm5/internal/operators/take.js");function fromModule(module){const handler=module;return new class{call(method,args){const target=handler[method];if("function"==typeof target){let res=args?target.apply(handler,args):target.call(handler);return res instanceof Promise||(res=Promise.resolve(res)),res}throw new Error(`[RPC]: method not found for ${method}!`)}subscribe(eventMethod,args){const target=handler[eventMethod];if("function"==typeof target){const res=args?target.apply(handler,args):target.call(handler);return(0,isObservable.A)(res)?res:(0,of.of)(res)}throw new Error(`[RPC]: observable method not found for ${eventMethod}!`)}}}function toModule(channel){return new Proxy({},{get(_,propKey){if("dispose"!==propKey)return function(...args){if(function propertyIsEventSource(name){return name.endsWith("$")}(propKey)){return channel.subscribe(propKey,args)}return channel.call(propKey,args)}}})}class ChannelClient extends src.hy_{constructor(_protocol){super(),this._protocol=_protocol,this._initialized=new BehaviorSubject.t(!1),this._lastRequestCounter=0,this._pendingRequests=new Map,this._protocol.send({type:50}),this._protocol.onMessage.pipe((0,takeUntil.Q)(this.dispose$)).subscribe((message=>this._onMessage(message)))}dispose(){this._pendingRequests.clear()}getChannel(channelName){const self=this;return{call:(method,args)=>self._disposed?Promise.reject():self._remoteCall(channelName,method,args),subscribe(eventMethod,args){if(self._disposed)throw new Error("[ChannelClient]: client is disposed!");return self._remoteSubscribe(channelName,eventMethod,args)}}}_whenReady(){return(0,firstValueFrom._)(this._initialized.pipe((0,filter.p)((v=>v)),(0,take.s)(1)))}async _remoteCall(channelName,method,args){await this._whenReady();const sequence=++this._lastRequestCounter,request={seq:sequence,type:100,channelName,method,args},client=this;return new Promise(((resolve,reject)=>{const responseHandler={handle(response){switch(response.type){case 201:client._pendingRequests.delete(sequence),resolve(response.data);break;case 202:client._pendingRequests.delete(sequence),reject(response.data);break;default:throw new Error("[ChannelClient]: unknown response type!")}}};this._pendingRequests.set(sequence,responseHandler),this._sendRequest(request)}))}_remoteSubscribe(channelName,method,args){return new Observable.c((subscriber=>{let sequence=-1;return this._whenReady().then((()=>{sequence=++this._lastRequestCounter;const request={seq:sequence,type:101,channelName,method,args},responseHandler={handle(response){switch(response.type){case 300:subscriber.next(response.data);break;case 301:subscriber.error(response.data);break;case 302:subscriber.complete();break;default:throw new Error("[ChannelClient]: unknown response type!")}}};this._pendingRequests.set(sequence,responseHandler),this._sendRequest(request)})),()=>{if(-1===sequence)return;const cancelSubscriptionRequest={type:102,seq:sequence,channelName,method};this._sendRequest(cancelSubscriptionRequest)}}))}_sendRequest(request){this._protocol.send(request)}_onMessage(response){switch(response.type){case 0:this._initialized.next(!0);break;case 201:case 202:case 300:case 302:case 301:this._pendingRequests.get(response.seq)?.handle(response)}}}class ChannelServer extends src.hy_{constructor(_protocol){super(),this._protocol=_protocol,this._channels=new Map,this._subscriptions=new Map,this._protocol.onMessage.pipe((0,takeUntil.Q)(this.dispose$)).subscribe((message=>this._onRequest(message))),this._sendInitialize()}dispose(){super.dispose(),this._subscriptions.clear(),this._channels.clear()}registerChannel(channelName,channel){this._channels.set(channelName,channel)}_onRequest(request){switch(request.type){case 50:this._sendInitialize();break;case 100:this._onMethodCall(request);break;case 101:this._onSubscribe(request);break;case 102:this._onUnsubscribe(request)}}_sendInitialize(){this._sendResponse({seq:-1,type:0})}_onMethodCall(request){const{channelName,method,args}=request,channel=this._channels.get(channelName);let promise;try{if(!channel)throw new Error(`[ChannelServer]: Channel ${channelName} not found!`);promise=args?channel.call(method,args):channel.call(method)}catch(err){promise=Promise.reject(err)}promise.then((data=>{this._sendResponse({seq:request.seq,type:201,data})})).catch((err=>{err instanceof Error?this._sendResponse({seq:request.seq,type:202,data:err.message}):this._sendResponse({seq:request.seq,type:202,data:String(err)})}))}_onSubscribe(request){const{channelName,seq}=request,channel=this._channels.get(channelName);try{if(!channel)throw new Error(`[ChannelServer]: Channel ${channelName} not found!`);const subscription=channel.subscribe(request.method,request.args).subscribe({next:data=>{this._sendResponse({seq,type:300,data})},error:err=>{this._sendResponse({seq,type:301,data:err.message}),this._sendResponse({seq,type:302})},complete:()=>{this._sendResponse({seq,type:302})}});this._subscriptions.set(request.seq,subscription)}catch(err){err instanceof Error?this._sendResponse({seq:request.seq,type:301,data:err.message}):this._sendResponse({seq:request.seq,type:301,data:String(err)})}}_onUnsubscribe(request){const subscription=this._subscriptions.get(request.seq);subscription&&(subscription.unsubscribe(),this._subscriptions.delete(request.seq))}_sendResponse(response){this._protocol.send(response)}}const IRPCChannelService=(0,src.Qmd)("IRPCChannelService");class ChannelService{constructor(_messageProtocol){this._client=new ChannelClient(_messageProtocol),this._server=new ChannelServer(_messageProtocol)}dispose(){this._client.dispose(),this._server.dispose()}requestChannel(name){return this._client.getChannel(name)}registerChannel(name,channel){this._server.registerChannel(name,channel)}}function data_sync_primary_controller_ts_metadata(k,v){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(k,v)}function data_sync_primary_controller_ts_param(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}}class DataSyncPrimaryController extends src.hy_{constructor(_injector,_commandService,_univerInstanceService,_rpcChannelService,_remoteSyncService){super(),this._injector=_injector,this._commandService=_commandService,this._univerInstanceService=_univerInstanceService,this._rpcChannelService=_rpcChannelService,this._remoteSyncService=_remoteSyncService,this._syncingUnits=new Set,this._syncingMutations=new Set,this._initRPCChannels(),this._init()}registerSyncingMutations(mutation){this._syncingMutations.add(mutation.id)}syncUnit(unitId){return this._syncingUnits.add(unitId),(0,src.saO)((()=>this._syncingUnits.delete(unitId)))}_initRPCChannels(){this._rpcChannelService.registerChannel("rpc.remote-sync.service",fromModule(this._remoteSyncService)),this._injector.add([IRemoteInstanceService,{useFactory:()=>toModule(this._rpcChannelService.requestChannel("univer.remote-instance-service"))}]),this._remoteInstanceService=this._injector.get(IRemoteInstanceService)}_init(){this._univerInstanceService.getTypeOfUnitAdded$(src.Zy$.UNIVER_SHEET).pipe((0,takeUntil.Q)(this.dispose$)).subscribe((sheet=>{this._syncingUnits.add(sheet.getUnitId()),this._remoteInstanceService.createInstance({unitID:sheet.getUnitId(),type:src.Zy$.UNIVER_SHEET,snapshot:sheet.getSnapshot()})})),this._univerInstanceService.getTypeOfUnitDisposed$(src.Zy$.UNIVER_SHEET).pipe((0,takeUntil.Q)(this.dispose$)).subscribe((workbook=>{this._syncingUnits.delete(workbook.getUnitId()),this._remoteInstanceService.disposeInstance({unitID:workbook.getUnitId()})})),this.disposeWithMe(this._commandService.onCommandExecuted(((commandInfo,options)=>{const{type,params,id}=commandInfo,unitId=params?.unitId||"";type!==src.g4t.MUTATION||unitId&&!this._syncingUnits.has(unitId)||options?.fromSync||!this._syncingMutations.has(id)||this._remoteInstanceService.syncMutation({mutationInfo:commandInfo})})))}}function data_sync_replica_controller_ts_metadata(k,v){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(k,v)}function data_sync_replica_controller_ts_param(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}}DataSyncPrimaryController=function data_sync_primary_controller_ts_decorate(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r}([data_sync_primary_controller_ts_param(0,(0,src.y_5)(src.zZn)),data_sync_primary_controller_ts_param(1,src.wTY),data_sync_primary_controller_ts_param(2,src.HCr),data_sync_primary_controller_ts_param(3,IRPCChannelService),data_sync_primary_controller_ts_param(4,IRemoteSyncService),data_sync_primary_controller_ts_metadata("design:type",Function),data_sync_primary_controller_ts_metadata("design:paramtypes",[void 0===src.zZn?Object:src.zZn,void 0===src.wTY?Object:src.wTY,void 0===src.HCr?Object:src.HCr,void 0===IRPCChannelService?Object:IRPCChannelService,void 0===IRemoteSyncService?Object:IRemoteSyncService])],DataSyncPrimaryController);class DataSyncReplicaController extends src.jGt{constructor(_injector,_remoteInstanceService,_commandService,_rpcChannelService){super(),this._injector=_injector,this._remoteInstanceService=_remoteInstanceService,this._commandService=_commandService,this._rpcChannelService=_rpcChannelService,this._initRPCChannels(),this._init()}_initRPCChannels(){this._rpcChannelService.registerChannel("univer.remote-instance-service",fromModule(this._remoteInstanceService)),this._injector.add([IRemoteSyncService,{useFactory:()=>toModule(this._rpcChannelService.requestChannel("rpc.remote-sync.service"))}]),this._remoteSyncService=this._injector.get(IRemoteSyncService)}_init(){this.disposeWithMe(this._commandService.onCommandExecuted(((commandInfo,options)=>{commandInfo.type!==src.g4t.MUTATION||options?.fromSync||this._remoteSyncService.syncMutation({mutationInfo:commandInfo})})))}}DataSyncReplicaController=function data_sync_replica_controller_ts_decorate(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r}([data_sync_replica_controller_ts_param(0,(0,src.y_5)(src.zZn)),data_sync_replica_controller_ts_param(1,IRemoteInstanceService),data_sync_replica_controller_ts_param(2,src.wTY),data_sync_replica_controller_ts_param(3,IRPCChannelService),data_sync_replica_controller_ts_metadata("design:type",Function),data_sync_replica_controller_ts_metadata("design:paramtypes",[void 0===src.zZn?Object:src.zZn,void 0===IRemoteInstanceService?Object:IRemoteInstanceService,void 0===src.wTY?Object:src.wTY,void 0===IRPCChannelService?Object:IRPCChannelService])],DataSyncReplicaController);var shareReplay=__webpack_require__("../../node_modules/.pnpm/rxjs@7.8.1/node_modules/rxjs/dist/esm5/internal/operators/shareReplay.js");function plugin_ts_decorate(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r}function plugin_ts_metadata(k,v){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(k,v)}function plugin_ts_param(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}}class UniverRPCMainThreadPlugin extends src.k_1{static#_=this.pluginName="UNIVER_RPC_MAIN_THREAD_PLUGIN";constructor(_config=defaultPluginMainThreadConfig,_injector,_configService){super(),this._config=_config,this._injector=_injector,this._configService=_configService,this._internalWorker=null;const{...rest}=(0,src.h1I)({},defaultPluginMainThreadConfig,this._config);this._configService.setConfig("rpc.main-thread.config",rest)}dispose(){super.dispose(),this._internalWorker&&(this._internalWorker.terminate(),this._internalWorker=null)}onStarting(){const{workerURL}=this._config;if(!workerURL)throw new Error("[UniverRPCMainThreadPlugin]: The workerURL is required for the RPC main thread plugin.");const worker=workerURL instanceof Worker?workerURL:new Worker(workerURL);this._internalWorker=workerURL instanceof Worker?null:worker;const messageProtocol=function createWebWorkerMessagePortOnMain(worker){return{send(message){worker.postMessage(message)},onMessage:new Observable.c((subscriber=>{const handler=event=>{subscriber.next(event.data)};return worker.addEventListener("message",handler),()=>worker.removeEventListener("message",handler)})).pipe((0,shareReplay.t)(1))}}(worker);[[IRPCChannelService,{useFactory:()=>new ChannelService(messageProtocol)}],[DataSyncPrimaryController],[IRemoteSyncService,{useClass:RemoteSyncPrimaryService}]].forEach((dependency=>this._injector.add(dependency))),this._injector.get(DataSyncPrimaryController)}}UniverRPCMainThreadPlugin=plugin_ts_decorate([plugin_ts_param(1,(0,src.y_5)(src.zZn)),plugin_ts_param(2,src.J0C),plugin_ts_metadata("design:type",Function),plugin_ts_metadata("design:paramtypes",["undefined"==typeof Partial?Object:Partial,void 0===src.zZn?Object:src.zZn,void 0===src.J0C?Object:src.J0C])],UniverRPCMainThreadPlugin);class UniverRPCWorkerThreadPlugin extends src.k_1{static#_=this.pluginName="UNIVER_RPC_WORKER_THREAD_PLUGIN";constructor(_config=defaultPluginWorkerThreadConfig,_injector,_configService){super(),this._config=_config,this._injector=_injector,this._configService=_configService;const{...rest}=(0,src.h1I)({},defaultPluginWorkerThreadConfig,this._config);this._configService.setConfig("rpc.worker-thread.config",rest)}onStarting(){[[DataSyncReplicaController],[IRPCChannelService,{useFactory:()=>new ChannelService(function createWebWorkerMessagePortOnWorker(){return{send(message){postMessage(message)},onMessage:new Observable.c((subscriber=>{const handler=event=>{subscriber.next(event.data)};return addEventListener("message",handler),()=>removeEventListener("message",handler)})).pipe((0,shareReplay.t)(1))}}())}],[IRemoteInstanceService,{useClass:WebWorkerRemoteInstanceService}]].forEach((dependency=>this._injector.add(dependency))),this._injector.get(DataSyncReplicaController)}}UniverRPCWorkerThreadPlugin=plugin_ts_decorate([plugin_ts_param(1,(0,src.y_5)(src.zZn)),plugin_ts_param(2,src.J0C),plugin_ts_metadata("design:type",Function),plugin_ts_metadata("design:paramtypes",["undefined"==typeof Partial?Object:Partial,void 0===src.zZn?Object:src.zZn,void 0===src.J0C?Object:src.J0C])],UniverRPCWorkerThreadPlugin)},"../../packages/sheets/src/index.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{ifA:()=>AddMergeRedoSelectionsOperationFactory,PL:()=>AddMergeUndoMutationFactory,sRA:()=>AddMergeUndoSelectionsOperationFactory,ZVQ:()=>AddRangeProtectionCommand,BAP:()=>add_range_protection_mutation_AddRangeProtectionMutation,amR:()=>AddWorksheetMergeAllCommand,zVg:()=>AddWorksheetMergeCommand,PF:()=>AddWorksheetMergeHorizontalCommand,zo2:()=>AddWorksheetMergeMutation,F3Z:()=>AddWorksheetMergeVerticalCommand,c7$:()=>AddWorksheetProtectionCommand,Yhg:()=>BEFORE_CELL_EDIT,wm$:()=>BorderStyleManagerService,Izd:()=>COMMAND_LISTENER_SKELETON_CHANGE,_nP:()=>COMMAND_LISTENER_VALUE_CHANGE,mtZ:()=>CancelFrozenCommand,sd6:()=>ClearSelectionAllCommand,kyo:()=>ClearSelectionContentCommand,igE:()=>ClearSelectionFormatCommand,y2Q:()=>CopySheetCommand,Ehw:()=>delete_range_move_left_command_DeleteRangeMoveLeftCommand,kHF:()=>delete_range_move_up_command_DeleteRangeMoveUpCommand,bt0:()=>DeleteRangeProtectionCommand,h5E:()=>delete_range_protection_mutation_DeleteRangeProtectionMutation,ImT:()=>DeleteWorksheetProtectionCommand,WnP:()=>DeltaColumnWidthCommand,j71:()=>DeltaRowHeightCommand,v2u:()=>EditStateEnum,WfV:()=>type_EffectRefRangId,oJ9:()=>IExclusiveRangeService,ZoP:()=>INTERCEPTOR_POINT,C$8:()=>INumfmtService,BcG:()=>IRefSelectionsService,OXv:()=>InsertColBeforeCommand,Xuv:()=>InsertColCommand,RmT:()=>InsertColMutation,xDg:()=>InsertDefinedNameCommand,Csr:()=>InsertMultiColsLeftCommand,hOx:()=>InsertMultiColsRightCommand,ih3:()=>InsertMultiRowsAboveCommand,L6E:()=>InsertMultiRowsAfterCommand,H7i:()=>insert_range_move_down_command_InsertRangeMoveDownCommand,TKH:()=>InsertRangeMoveRightCommand,ET4:()=>InsertRowBeforeCommand,$h8:()=>InsertRowCommand,bS1:()=>InsertRowMutation,cz2:()=>InsertSheetCommand,eUO:()=>InsertSheetMutation,cym:()=>InterceptCellContentPriority,QM2:()=>MAX_CELL_PER_SHEET_KEY,fik:()=>MERGE_CELL_INTERCEPTOR_CHECK,TSy:()=>MergeCellController,GU8:()=>MoveColsCommand,YJl:()=>MoveColsMutation,Kft:()=>MoveRangeCommand,o2G:()=>MoveRangeMutation,wAI:()=>MoveRowsCommand,yNb:()=>MoveRowsMutation,C5D:()=>REF_SELECTIONS_ENABLED,vL8:()=>RangeProtectionCache,o9h:()=>edit_RangeProtectionPermissionEditPoint,fGp:()=>RangeProtectionPermissionViewPoint,qI9:()=>range_protection_rule_model_RangeProtectionRuleModel,u7_:()=>RefRangeService,mOY:()=>RefSelectionsService,G7y:()=>RemoveColCommand,MIN:()=>RemoveColMutation,EIv:()=>RemoveDefinedNameCommand,IX1:()=>RemoveMergeUndoMutationFactory,J2H:()=>RemoveNumfmtMutation,UJ9:()=>RemoveRowCommand,G4z:()=>RemoveRowMutation,J0n:()=>RemoveSheetCommand,fyw:()=>RemoveSheetMutation,Mkw:()=>RemoveWorksheetMergeCommand,_L3:()=>RemoveWorksheetMergeMutation,yzM:()=>ReorderRangeCommand,mkI:()=>ResetBackgroundColorCommand,nms:()=>ResetTextColorCommand,Gjg:()=>SCOPE_WORKBOOK_VALUE_DEFINED_NAME,a_m:()=>SELECTIONS_ENABLED,VwB:()=>SELECTION_CONTROL_BORDER_BUFFER_COLOR,ybH:()=>SELECTION_CONTROL_BORDER_BUFFER_WIDTH,Q8V:()=>ScrollToCellOperation,kFf:()=>SelectionMoveType,H6w:()=>SetBackgroundColorCommand,ftS:()=>SetBoldCommand,Sdr:()=>SetBorderBasicCommand,yCk:()=>SetColHiddenCommand,q4N:()=>SetColHiddenMutation,Sys:()=>SetColVisibleMutation,Mim:()=>SetColWidthCommand,iAm:()=>SetDefinedNameCommand,B7g:()=>SetFontFamilyCommand,QPx:()=>SetFontSizeCommand,UK8:()=>SetFrozenCommand,MOW:()=>SetFrozenMutation,kJ6:()=>SetFrozenMutationFactory,y$j:()=>SetHorizontalTextAlignCommand,kBM:()=>SetItalicCommand,dD6:()=>SetNumfmtMutation,$tU:()=>SetProtectionCommand,NXV:()=>SetRangeValuesCommand,N48:()=>SetRangeValuesMutation,hro:()=>SetRangeValuesUndoMutationFactory,fC2:()=>SetRowHeightCommand,ccO:()=>SetRowHiddenCommand,avX:()=>SetRowHiddenMutation,QAK:()=>SetRowVisibleMutation,MeW:()=>SetSelectedColsVisibleCommand,QvT:()=>SetSelectedRowsVisibleCommand,NSB:()=>SetSelectionsOperation,d7m:()=>SetSpecificColsVisibleCommand,dMo:()=>SetSpecificRowsVisibleCommand,HoN:()=>SetStrikeThroughCommand,Fe6:()=>SetStyleCommand,uN4:()=>SetTabColorCommand,CBb:()=>SetTabColorMutation,YHk:()=>SetTextColorCommand,hti:()=>SetTextRotationCommand,TDI:()=>SetTextWrapCommand,U0d:()=>SetUnderlineCommand,slJ:()=>SetVerticalTextAlignCommand,LlJ:()=>SetWorksheetActivateCommand,_M5:()=>SetWorksheetActiveOperation,Cay:()=>SetWorksheetColWidthMutation,Kbx:()=>SetWorksheetHideCommand,seI:()=>SetWorksheetHideMutation,JP6:()=>SetWorksheetNameCommand,H7b:()=>SetWorksheetNameMutation,YPi:()=>SetWorksheetOrderCommand,yif:()=>SetWorksheetOrderMutation,OZe:()=>SetWorksheetPermissionPointsCommand,wXn:()=>SetWorksheetRowAutoHeightMutation,w45:()=>SetWorksheetRowAutoHeightMutationFactory,BtL:()=>SetWorksheetRowHeightMutation,iOM:()=>SetWorksheetRowIsAutoHeightCommand,iqY:()=>SetWorksheetRowIsAutoHeightMutation,dSt:()=>SetWorksheetShowCommand,e5R:()=>SheetInterceptorService,zP0:()=>SheetPermissionCheckController,TNT:()=>SheetPermissionInitController,QsU:()=>SheetSkeletonService,Fal:()=>selection_service_SheetsSelectionsService,Pxm:()=>ToggleCellCheckboxCommand,vf2:()=>ToggleGridlinesCommand,HYc:()=>ToggleGridlinesMutation,pS2:()=>es.pS,_mD:()=>es._m,nDU:()=>UniverSheetsPlugin,kLo:()=>ViewStateEnum,FB8:()=>WorkbookCopyPermission,l5B:()=>WorkbookCreateProtectPermission,ZZ1:()=>WorkbookCreateSheetPermission,mVR:()=>WorkbookDeleteSheetPermission,W30:()=>editable_WorkbookEditablePermission,LGU:()=>WorkbookHideSheetPermission,d0P:()=>WorkbookManageCollaboratorPermission,fzU:()=>WorkbookRenameSheetPermission,$Rn:()=>WorksheetCopyPermission,bjH:()=>WorksheetDeleteColumnPermission,i6_:()=>WorksheetDeleteProtectionPermission,FlU:()=>WorksheetDeleteRowPermission,qGK:()=>edit_WorksheetEditPermission,XMo:()=>WorksheetInsertColumnPermission,v9P:()=>WorksheetInsertRowPermission,rou:()=>WorksheetManageCollaboratorPermission,fON:()=>WorksheetProtectionPointModel,$af:()=>WorksheetProtectionRuleModel,nhd:()=>WorksheetSetCellStylePermission,r$W:()=>WorksheetSetCellValuePermission,lLG:()=>WorksheetSetColumnStylePermission,Frs:()=>WorksheetSetRowStylePermission,R4Q:()=>WorksheetViewPermission,nlb:()=>adjustRangeOnMutation,rUp:()=>alignToMergedCellsBorders,Wlz:()=>baseProtectionActions,u6j:()=>checkCellValueType,Y9H:()=>convertSelectionDataToRange,OqS:()=>expand_range_expandToContinuousRange,xNO:()=>factoryRemoveNumfmtUndoMutation,lqf:()=>factorySetNumfmtUndoMutation,w5F:()=>generateNullCellValue,h9R:()=>getAddMergeMutationRangeByType,tSr:()=>getAllWorksheetPermissionPoint,Oqq:()=>getCellAtRowCol,fCg:()=>getPrimaryForRange,jy0:()=>getSelectionsService,go2:()=>target_util_getSheetCommandTarget,$zM:()=>isSingleCellSelection,yzp:()=>rangeMerge,tQu:()=>rangeToDiscreteRange,cpS:()=>setEndForRange,wOQ:()=>transformCellsToRange});var src=__webpack_require__("../../packages/core/src/index.ts"),engine_formula_src=__webpack_require__("../../packages/engine-formula/src/index.ts"),rpc_src=__webpack_require__("../../packages/rpc/src/index.ts"),Subject=__webpack_require__("../../node_modules/.pnpm/rxjs@7.8.1/node_modules/rxjs/dist/esm5/internal/Subject.js"),BehaviorSubject=__webpack_require__("../../node_modules/.pnpm/rxjs@7.8.1/node_modules/rxjs/dist/esm5/internal/BehaviorSubject.js"),ViewStateEnum=function(ViewStateEnum){return ViewStateEnum.OthersCanView="othersCanView",ViewStateEnum.NoOneElseCanView="noOneElseCanView",ViewStateEnum}({}),EditStateEnum=function(EditStateEnum){return EditStateEnum.DesignedUserCanEdit="designedUserCanEdit",EditStateEnum.OnlyMe="onlyMe",EditStateEnum}({});class range_protection_rule_model_RangeProtectionRuleModel{dispose(){this._ruleChange$.complete(),this._ruleRefresh$.complete()}ruleRefresh(id){this._ruleRefresh$.next(id)}getRangeRuleInitState(){return this._rangeRuleInitStateChange.value}changeRuleInitState(state){this._rangeRuleInitStateChange.next(state)}addRule(unitId,subUnitId,rule){this._ensureRuleMap(unitId,subUnitId).set(rule.id,rule),this._ruleChange$.next({unitId,subUnitId,rule,type:"add"})}deleteRule(unitId,subUnitId,id){const rule=this._model.get(unitId)?.get(subUnitId)?.get(id);rule&&(this._model.get(unitId)?.get(subUnitId)?.delete(id),this._ruleChange$.next({unitId,subUnitId,rule,type:"delete"}))}setRule(unitId,subUnitId,id,rule){const oldRule=this.getRule(unitId,subUnitId,id);oldRule&&(this._model.get(unitId)?.get(subUnitId)?.set(id,rule),this._ruleChange$.next({unitId,subUnitId,oldRule,rule,type:"set"}))}getRule(unitId,subUnitId,id){return this._model.get(unitId)?.get(subUnitId)?.get(id)}getSubunitRuleList(unitId,subUnitId){return[...(this._model.get(unitId)?.get(subUnitId)||new Map).values()]}getSubunitRuleListLength(unitId,subUnitId){const map=this._model.get(unitId)?.get(subUnitId);return map?map.size:0}_ensureRuleMap(unitId,subUnitId){let subUnitMap=this._model.get(unitId);subUnitMap||(subUnitMap=new Map,this._model.set(unitId,subUnitMap));let ruleMap=subUnitMap.get(subUnitId);return ruleMap||(ruleMap=new Map,subUnitMap.set(subUnitId,ruleMap)),ruleMap}toObject(){const result={};return[...this._model.keys()].forEach((unitId=>{const submitMap=this._model.get(unitId),subUnitKeys=[...submitMap.keys()];result[unitId]={},subUnitKeys.forEach((subunitId=>{const ruleMap=submitMap.get(subunitId);result[unitId][subunitId]=[...ruleMap.values()]}))})),result}fromObject(obj){const result=new Map;Object.keys(obj).forEach((unitId=>{const subUnitObj=obj[unitId],map=new Map;Object.keys(subUnitObj).forEach((subunitId=>{const ruleMap=subUnitObj[subunitId].reduce(((result,cur)=>(result.set(cur.id,cur),result)),new Map);map.set(subunitId,ruleMap)})),result.set(unitId,map)})),this._model=result}deleteUnitModel(unitId){this._model.delete(unitId)}createRuleId(unitId,subUnitId){let id=src.S0q.generateRandomId(4);const ruleMap=this._ensureRuleMap(unitId,subUnitId);for(;ruleMap.has(id);)id=src.S0q.generateRandomId(4);return id}getTargetByPermissionId(unitId,permissionId){const subUnitMap=this._model.get(unitId);if(!subUnitMap)return null;for(const[subUnitId,ruleMap]of subUnitMap)for(const rule of ruleMap.values())if(rule.permissionId===permissionId)return[unitId,subUnitId];return null}constructor(){this._model=new Map,this._ruleChange$=new Subject.B,this.ruleChange$=this._ruleChange$.asObservable(),this._ruleRefresh$=new Subject.B,this.ruleRefresh$=this._ruleRefresh$.asObservable(),this._rangeRuleInitStateChange=new BehaviorSubject.t(!1),this.rangeRuleInitStateChange$=this._rangeRuleInitStateChange.asObservable()}}const delete_range_protection_mutation_DeleteRangeProtectionMutation={id:"sheet.mutation.delete-range-protection",type:src.g4t.MUTATION,handler:(accessor,params)=>{const{unitId,subUnitId,ruleIds}=params,selectionProtectionRuleModel=accessor.get(range_protection_rule_model_RangeProtectionRuleModel);return ruleIds.forEach((id=>{selectionProtectionRuleModel.deleteRule(unitId,subUnitId,id)})),!0}},add_range_protection_mutation_AddRangeProtectionMutation={id:"sheet.mutation.add-range-protection",type:src.g4t.MUTATION,handler:(accessor,params)=>{const{unitId,subUnitId,rules}=params,selectionProtectionRuleModel=accessor.get(range_protection_rule_model_RangeProtectionRuleModel);return rules.forEach((rule=>{selectionProtectionRuleModel.addRule(unitId,subUnitId,rule)})),!0}},AddRangeProtectionCommand={type:src.g4t.COMMAND,id:"sheet.command.add-range-protection",async handler(accessor,params){if(!params)return!1;const commandService=accessor.get(src.wTY),undoRedoService=accessor.get(src.$Dz),selectionProtectionModel=accessor.get(range_protection_rule_model_RangeProtectionRuleModel),{rule,permissionId}=params,{unitId,subUnitId,ranges,description,viewState,editState}=rule,rules=[{ranges,permissionId,id:selectionProtectionModel.createRuleId(unitId,subUnitId),description,unitType:rule.unitType,unitId,subUnitId,viewState,editState}];if(await commandService.executeCommand(add_range_protection_mutation_AddRangeProtectionMutation.id,{unitId,subUnitId,rules})){const redoMutations=[{id:add_range_protection_mutation_AddRangeProtectionMutation.id,params:{unitId,subUnitId,rules}}],undoMutations=[{id:delete_range_protection_mutation_DeleteRangeProtectionMutation.id,params:{unitId,subUnitId,ruleIds:rules.map((rule=>rule.id))}}];undoRedoService.pushUndoRedo({unitID:unitId,redoMutations,undoMutations})}return!0}};class WorksheetProtectionRuleModel{changeRuleInitState(state){this._worksheetRuleInitStateChange.next(state)}getSheetRuleInitState(){return this._worksheetRuleInitStateChange.value}addRule(unitId,rule){this._ensureSubUnitMap(unitId).set(rule.subUnitId,rule),this._ruleChange.next({unitId,rule,type:"add",subUnitId:rule.subUnitId})}deleteRule(unitId,subUnitId){const rule=this._model?.get(unitId)?.get(subUnitId);rule&&(this._model.get(unitId)?.delete(subUnitId),this._ruleChange.next({unitId,rule,type:"delete",subUnitId}))}setRule(unitId,subUnitId,rule){const oldRule=this.getRule(unitId,subUnitId);oldRule&&(this._model?.get(unitId)?.set(subUnitId,rule),this._ruleChange.next({unitId,oldRule,rule,type:"set",subUnitId}))}getRule(unitId,subUnitId){return this._model?.get(unitId)?.get(subUnitId)}toObject(){const result={};return[...this._model.keys()].forEach((unitId=>{const subUnitMap=this._model.get(unitId);if(subUnitMap?.size){result[unitId]=[];[...subUnitMap.keys()].forEach((subUnitId=>{const rule=subUnitMap.get(subUnitId);rule&&result[unitId].push(rule)}))}})),result}fromObject(obj){const result=new Map;Object.keys(obj).forEach((unitId=>{const subUnitList=obj[unitId];if(subUnitList?.length){const subUnitMap=new Map;subUnitList.forEach((rule=>{subUnitMap.set(rule.subUnitId,rule)})),result.set(unitId,subUnitMap)}})),this._model=result}deleteUnitModel(unitId){this._model.delete(unitId)}_ensureSubUnitMap(unitId){let subUnitMap=this._model.get(unitId);return subUnitMap||(subUnitMap=new Map,this._model.set(unitId,subUnitMap)),subUnitMap}ruleRefresh(permissionId){this._ruleRefresh.next(permissionId)}resetOrder(){this._resetOrder.next(Math.random())}getTargetByPermissionId(unitId,permissionId){const subUnitMap=this._model.get(unitId);if(!subUnitMap)return null;for(const[subUnitId,rule]of subUnitMap)if(rule.permissionId===permissionId)return[unitId,subUnitId]}constructor(){this._model=new Map,this._ruleChange=new Subject.B,this._ruleRefresh=new Subject.B,this._resetOrder=new Subject.B,this.ruleChange$=this._ruleChange.asObservable(),this.ruleRefresh$=this._ruleRefresh.asObservable(),this.resetOrder$=this._resetOrder.asObservable(),this._worksheetRuleInitStateChange=new BehaviorSubject.t(!1),this.worksheetRuleInitStateChange$=this._worksheetRuleInitStateChange.asObservable()}}const AddWorksheetProtectionMutation={id:"sheet.mutation.add-worksheet-protection",type:src.g4t.MUTATION,handler:(accessor,params)=>{const{unitId,rule}=params;return accessor.get(WorksheetProtectionRuleModel).addRule(unitId,rule),!0}},DeleteWorksheetProtectionMutation={id:"sheet.mutation.delete-worksheet-protection",type:src.g4t.MUTATION,handler:(accessor,params)=>{const{unitId,subUnitId}=params;return accessor.get(WorksheetProtectionRuleModel).deleteRule(unitId,subUnitId),!0}},AddWorksheetProtectionCommand={type:src.g4t.COMMAND,id:"sheet.command.add-worksheet-protection",async handler(accessor,params){if(!params)return!1;const commandService=accessor.get(src.wTY),undoRedoService=accessor.get(src.$Dz),{rule,unitId}=params,subUnitId=rule.subUnitId;if(await commandService.executeCommand(AddWorksheetProtectionMutation.id,{unitId,rule,subUnitId:rule.subUnitId})){const redoMutations=[{id:AddWorksheetProtectionMutation.id,params:{unitId,rule,subUnitId:rule.subUnitId}}],undoMutations=[{id:DeleteWorksheetProtectionMutation.id,params:{unitId,subUnitId}}];undoRedoService.pushUndoRedo({unitID:unitId,redoMutations,undoMutations})}return!0}},INTERCEPTOR_POINT={CELL_CONTENT:(0,src.nwg)("CELL_CONTENT"),ROW_FILTERED:(0,src.nwg)("ROW_FILTERED")};var InterceptCellContentPriority=function(InterceptCellContentPriority){return InterceptCellContentPriority[InterceptCellContentPriority.DATA_VALIDATION=9]="DATA_VALIDATION",InterceptCellContentPriority[InterceptCellContentPriority.NUMFMT=10]="NUMFMT",InterceptCellContentPriority[InterceptCellContentPriority.CELL_IMAGE=11]="CELL_IMAGE",InterceptCellContentPriority}({});function _ts_metadata(k,v){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(k,v)}const BEFORE_CELL_EDIT=(0,src.nwg)("BEFORE_CELL_EDIT"),AFTER_CELL_EDIT=(0,src.nwg)("AFTER_CELL_EDIT"),VALIDATE_CELL=(0,src.nwg)("VALIDATE_CELL");class SheetInterceptorService extends src.jGt{constructor(_univerInstanceService){super(),this._univerInstanceService=_univerInstanceService,this._interceptorsByName=new Map,this._commandInterceptors=[],this._rangeInterceptors=[],this._beforeCommandInterceptor=[],this._afterCommandInterceptors=[],this._workbookDisposables=new Map,this._worksheetDisposables=new Map,this._interceptorsDirty=!1,this._composedInterceptorByKey=new Map,this.writeCellInterceptor=new src.vY4({BEFORE_CELL_EDIT,AFTER_CELL_EDIT,VALIDATE_CELL}),this.disposeWithMe(this._univerInstanceService.getTypeOfUnitAdded$(src.Zy$.UNIVER_SHEET).subscribe((workbook=>{this._interceptWorkbook(workbook)}))),this.disposeWithMe(this._univerInstanceService.getTypeOfUnitDisposed$(src.Zy$.UNIVER_SHEET).subscribe((workbook=>this._disposeWorkbookInterceptor(workbook)))),this.intercept(INTERCEPTOR_POINT.CELL_CONTENT,{priority:-1,effect:src._w8.Style|src._w8.Value,handler(value,context){const rawData=context.worksheet.getCellRaw(context.row,context.col);return value?{...rawData,...value}:rawData}}),this.disposeWithMe(this.writeCellInterceptor.intercept(AFTER_CELL_EDIT,{priority:-1,handler:_value=>_value})),this.disposeWithMe(this.writeCellInterceptor.intercept(BEFORE_CELL_EDIT,{priority:-1,handler:_value=>_value})),this.disposeWithMe(this.writeCellInterceptor.intercept(VALIDATE_CELL,{priority:-1,handler:_value=>_value}))}dispose(){super.dispose(),this._workbookDisposables.forEach((disposable=>disposable.dispose())),this._workbookDisposables.clear(),this._worksheetDisposables.clear(),this._interceptorsByName.clear()}interceptCommand(interceptor){if(this._commandInterceptors.includes(interceptor))throw new Error("[SheetInterceptorService]: Interceptor already exists!");return this._commandInterceptors.push(interceptor),this._commandInterceptors.sort(((a,b)=>(b.priority??0)-(a.priority??0))),this.disposeWithMe((0,src.saO)((()=>(0,src.TFI)(this._commandInterceptors,interceptor))))}onCommandExecute(info){const infos=this._commandInterceptors.map((i=>i.getMutations(info)));return{preUndos:infos.map((i=>i.preUndos??[])).flat(),undos:infos.map((i=>i.undos)).flat(),preRedos:infos.map((i=>i.preRedos??[])).flat(),redos:infos.map((i=>i.redos)).flat()}}interceptAfterCommand(interceptor){if(this._afterCommandInterceptors.includes(interceptor))throw new Error("[SheetInterceptorService]: Interceptor already exists!");return this._afterCommandInterceptors.push(interceptor),this._afterCommandInterceptors.sort(((a,b)=>(b.priority??0)-(a.priority??0))),this.disposeWithMe((0,src.saO)((()=>(0,src.TFI)(this._afterCommandInterceptors,interceptor))))}afterCommandExecute(info){const infos=this._afterCommandInterceptors.map((i=>i.getMutations(info)));return{undos:infos.map((i=>i.undos)).flat(),redos:infos.map((i=>i.redos)).flat()}}interceptBeforeCommand(interceptor){if(this._beforeCommandInterceptor.includes(interceptor))throw new Error("[SheetInterceptorService]: Interceptor already exists!");return this._beforeCommandInterceptor.push(interceptor),this._beforeCommandInterceptor.sort(((a,b)=>(b.priority??0)-(a.priority??0))),this.disposeWithMe((0,src.saO)((()=>(0,src.TFI)(this._beforeCommandInterceptor,interceptor))))}async beforeCommandExecute(info){return(await Promise.all(this._beforeCommandInterceptor.map((i=>i.performCheck(info))))).every((perform=>perform))}interceptRanges(interceptor){if(this._rangeInterceptors.includes(interceptor))throw new Error("[SheetInterceptorService]: Interceptor already exists!");return this._rangeInterceptors.push(interceptor),this._rangeInterceptors.sort(((a,b)=>(b.priority??0)-(a.priority??0))),this.disposeWithMe((0,src.saO)((()=>(0,src.TFI)(this._rangeInterceptors,interceptor))))}generateMutationsByRanges(info){const infos=this._rangeInterceptors.map((i=>i.getMutations(info)));return{preUndos:infos.map((i=>i.preUndos??[])).flat(),undos:infos.map((i=>i.undos)).flat(),preRedos:infos.map((i=>i.preRedos??[])).flat(),redos:infos.map((i=>i.redos)).flat()}}onWriteCell(workbook,worksheet,row,col,cellData){const context={subUnitId:worksheet.getSheetId(),unitId:workbook.getUnitId(),workbook,worksheet,row,col,origin:src.S0q.deepClone(cellData)};return this.writeCellInterceptor.fetchThroughInterceptors(AFTER_CELL_EDIT)(cellData,context)}onValidateCell(workbook,worksheet,row,col){const context={subUnitId:worksheet.getSheetId(),unitId:workbook.getUnitId(),workbook,worksheet,row,col};return this.writeCellInterceptor.fetchThroughInterceptors(VALIDATE_CELL)(Promise.resolve(!0),context)}intercept(name,interceptor){const key=name;this._interceptorsByName.has(key)||this._interceptorsByName.set(key,[]);const interceptors=this._interceptorsByName.get(key);interceptors.push(interceptor);const sortedInterceptors=interceptors.sort(((a,b)=>(b.priority??0)-(a.priority??0)));if(this._interceptorsDirty=!0,key===INTERCEPTOR_POINT.CELL_CONTENT){const JOINED_EFFECT=src._w8.Style|src._w8.Value;this._interceptorsByName.set(`${key}-${JOINED_EFFECT}`,sortedInterceptors);const BOTH_EFFECT=src._w8.Style|src._w8.Value;return this._interceptorsByName.set(`${key}-${src._w8.Style}`,sortedInterceptors.filter((i=>((i.effect||BOTH_EFFECT)&src._w8.Style)>0))),this._interceptorsByName.set(`${key}-${src._w8.Value}`,sortedInterceptors.filter((i=>((i.effect||BOTH_EFFECT)&src._w8.Value)>0))),this.disposeWithMe((0,src.saO)((()=>{(0,src.TFI)(this._interceptorsByName.get(key),interceptor),(0,src.TFI)(this._interceptorsByName.get(`${key}-${JOINED_EFFECT}`),interceptor),(0,src.TFI)(this._interceptorsByName.get(`${key}-${src._w8.Style}`),interceptor),(0,src.TFI)(this._interceptorsByName.get(`${key}-${src._w8.Value}`),interceptor)})))}return this._interceptorsByName.set(key,sortedInterceptors),this.disposeWithMe((0,src.saO)((()=>(0,src.TFI)(this._interceptorsByName.get(key),interceptor))))}fetchThroughInterceptors(name,effect,_key,filter){const byNamesKey=void 0===effect?name:`${name}-${effect}`,key=_key??byNamesKey;let composed=this._composedInterceptorByKey.get(key);if(!composed||this._interceptorsDirty){let interceptors=this._interceptorsByName.get(byNamesKey);interceptors&&filter&&(interceptors=interceptors.filter(filter)),composed=(0,src.pF5)(interceptors||[]),this._composedInterceptorByKey.set(key,composed)}return composed}_interceptWorkbook(workbook){const disposables=new src.VdD,unitId=workbook.getUnitId(),sheetInterceptorService=this,interceptViewModel=worksheet=>{const subUnitId=worksheet.getSheetId();worksheet.__interceptViewModel((viewModel=>{const sheetDisposables=new src.VdD;sheetInterceptorService._worksheetDisposables.set(getWorksheetDisposableID(unitId,worksheet),sheetDisposables),sheetDisposables.add(viewModel.registerCellContentInterceptor({getCell(row,col,effect,key,filter){const rawData=worksheet.getCellRaw(row,col);return sheetInterceptorService.fetchThroughInterceptors(INTERCEPTOR_POINT.CELL_CONTENT,effect,key,filter)(rawData,{unitId,subUnitId,row,col,worksheet,workbook,rawData})}})),sheetDisposables.add(viewModel.registerRowFilteredInterceptor({getRowFiltered:row=>!!sheetInterceptorService.fetchThroughInterceptors(INTERCEPTOR_POINT.ROW_FILTERED)(!1,{unitId,subUnitId,row,workbook,worksheet})}))}))};workbook.getSheets().forEach((worksheet=>interceptViewModel(worksheet))),disposables.add(workbook.sheetCreated$.subscribe((worksheet=>interceptViewModel(worksheet)))),disposables.add((0,src.saO)((()=>workbook.getSheets().forEach((worksheet=>this._disposeSheetInterceptor(unitId,worksheet)))))),disposables.add(workbook.sheetDisposed$.subscribe((worksheet=>this._disposeSheetInterceptor(unitId,worksheet)))),this._workbookDisposables.set(unitId,disposables)}_disposeWorkbookInterceptor(workbook){const unitId=workbook.getUnitId(),disposable=this._workbookDisposables.get(unitId);disposable&&(disposable.dispose(),this._workbookDisposables.delete(unitId))}_disposeSheetInterceptor(unitId,worksheet){const disposableId=getWorksheetDisposableID(unitId,worksheet),disposable=this._worksheetDisposables.get(disposableId);disposable&&(disposable.dispose(),this._worksheetDisposables.delete(disposableId))}}function getWorksheetDisposableID(unitId,worksheet){return`${unitId}|${worksheet.getSheetId()}`}SheetInterceptorService=function _ts_decorate(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r}([function _ts_param(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}}(0,src.HCr),_ts_metadata("design:type",Function),_ts_metadata("design:paramtypes",[void 0===src.HCr?Object:src.HCr])],SheetInterceptorService);const serializeRangeStyle=style=>{const result={};return style.bg&&(result.bg={...style.bg}),style.ol&&(result.ol={...style.ol}),style.bd&&(result.bd={...style.bd}),style.cl&&(result.cl={...style.cl}),style.ht&&(result.ht=style.ht),style.vt&&(result.vt=style.vt),void 0!==style.bl&&(result.bl=style.bl),result};const STYLE_MAP_wholeStyle=1,STYLE_MAP_headerRowStyle=2,STYLE_MAP_headerColumnStyle=4,STYLE_MAP_firstRowStyle=8,STYLE_MAP_secondRowStyle=16,STYLE_MAP_lastRowStyle=32,STYLE_MAP_firstColumnStyle=128,STYLE_MAP_secondColumnStyle=256,STYLE_MAP_lastColumnStyle=512;class RangeThemeStyle{constructor(name,options){this.wholeStyle=null,this.headerRowStyle=null,this.headerColumnStyle=null,this.firstRowStyle=null,this.secondRowStyle=null,this.lastRowStyle=null,this.firstColumnStyle=null,this.secondColumnStyle=null,this.lastColumnStyle=null,this._mergeCacheMap=new Map,options&&this.fromJson({...options,name}),this._name=name}getName(){return this._name}getWholeStyle(){return this.wholeStyle}setWholeStyle(style){this.wholeStyle=style}getFirstRowStyle(){return this.firstRowStyle}setFirstRowStyle(style){this.firstRowStyle=style}getSecondRowStyle(){return this.secondRowStyle}setSecondRowStyle(style){this.secondRowStyle=style}getLastRowStyle(){return this.lastRowStyle}setLastRowStyle(style){this.lastRowStyle=style}getFirstColumnStyle(){return this.firstColumnStyle}setFirstColumnStyle(style){this.firstColumnStyle=style}getSecondColumnStyle(){return this.secondColumnStyle}setSecondColumnStyle(style){this.secondColumnStyle=style}getLastColumnStyle(){return this.lastColumnStyle}setLastColumnStyle(style){this.lastColumnStyle=style}getHeaderRowStyle(){return this.headerRowStyle}setHeaderRowStyle(style){this.headerRowStyle=style}getHeaderColumnStyle(){return this.headerColumnStyle}setHeaderColumnStyle(style){this.headerColumnStyle=style}getStyle(offsetRow,offsetCol,isLastRow,isLastCol){let mergeNumber=0;return isLastRow&&(mergeNumber|=STYLE_MAP_lastRowStyle),isLastCol&&(mergeNumber|=STYLE_MAP_lastColumnStyle),offsetRow>=0&&offsetCol>=0&&(mergeNumber|=STYLE_MAP_wholeStyle),offsetRow%2==1&&(mergeNumber|=STYLE_MAP_firstRowStyle),offsetRow%2==0&&(mergeNumber|=STYLE_MAP_secondRowStyle),0===offsetRow&&(mergeNumber|=STYLE_MAP_headerRowStyle),0===offsetCol&&(mergeNumber|=STYLE_MAP_headerColumnStyle),offsetCol%2==1&&(mergeNumber|=STYLE_MAP_firstColumnStyle),offsetCol%2==0&&(mergeNumber|=STYLE_MAP_secondColumnStyle),0===mergeNumber?null:this._getMergeStyle(mergeNumber)}_getMergeStyle(mergeNumber){let style=this._mergeCacheMap.get(mergeNumber);return style||(style=this._mergeStyle(mergeNumber),this._mergeCacheMap.set(mergeNumber,style)),style}_mergeStyle(mergeNumber){const rs=[];return this.wholeStyle&&mergeNumber&STYLE_MAP_wholeStyle&&rs.push(this.wholeStyle),this.firstColumnStyle&&mergeNumber&STYLE_MAP_firstColumnStyle&&rs.push(this.firstColumnStyle),this.secondColumnStyle&&mergeNumber&STYLE_MAP_secondColumnStyle&&rs.push(this.secondColumnStyle),this.firstRowStyle&&mergeNumber&STYLE_MAP_firstRowStyle&&rs.push(this.firstRowStyle),this.secondRowStyle&&mergeNumber&STYLE_MAP_secondRowStyle&&rs.push(this.secondRowStyle),this.headerColumnStyle&&mergeNumber&STYLE_MAP_headerColumnStyle&&rs.push(this.headerColumnStyle),this.lastColumnStyle&&mergeNumber&STYLE_MAP_lastColumnStyle&&rs.push(this.lastColumnStyle),this.headerRowStyle&&mergeNumber&STYLE_MAP_headerRowStyle&&rs.push(this.headerRowStyle),this.lastRowStyle&&mergeNumber&STYLE_MAP_lastRowStyle&&rs.push(this.lastRowStyle),function composeStyles(styles){const composedStyle={};if(1===styles.length)return styles[0];for(const style of styles)style.bg&&(composedStyle.bg=style.bg),style.ol&&(composedStyle.ol=style.ol),style.bd&&(composedStyle.bd={...composedStyle.bd,...style.bd}),style.cl&&(composedStyle.cl=style.cl),style.ht&&(composedStyle.ht=style.ht),style.vt&&(composedStyle.vt=style.vt),void 0!==style.bl&&(composedStyle.bl=style.bl);return composedStyle}(rs)}toJson(){const jsonData={name:this._name};return this.wholeStyle&&(jsonData.wholeStyle=serializeRangeStyle(this.wholeStyle)),this.headerRowStyle&&(jsonData.headerRowStyle=serializeRangeStyle(this.headerRowStyle)),this.headerColumnStyle&&(jsonData.headerColumnStyle=serializeRangeStyle(this.headerColumnStyle)),this.firstRowStyle&&(jsonData.firstRowStyle=serializeRangeStyle(this.firstRowStyle)),this.secondRowStyle&&(jsonData.secondRowStyle=serializeRangeStyle(this.secondRowStyle)),this.lastRowStyle&&(jsonData.lastRowStyle=serializeRangeStyle(this.lastRowStyle)),this.firstColumnStyle&&(jsonData.firstColumnStyle=serializeRangeStyle(this.firstColumnStyle)),this.secondColumnStyle&&(jsonData.secondColumnStyle=serializeRangeStyle(this.secondColumnStyle)),this.lastColumnStyle&&(jsonData.lastColumnStyle=serializeRangeStyle(this.lastColumnStyle)),jsonData}fromJson(json){this._name=json.name,json.wholeStyle&&(this.wholeStyle=serializeRangeStyle(json.wholeStyle)),json.headerRowStyle&&(this.headerRowStyle=serializeRangeStyle(json.headerRowStyle)),json.headerColumnStyle&&(this.headerColumnStyle=serializeRangeStyle(json.headerColumnStyle)),json.firstRowStyle&&(this.firstRowStyle=serializeRangeStyle(json.firstRowStyle)),json.secondRowStyle&&(this.secondRowStyle=serializeRangeStyle(json.secondRowStyle)),json.lastRowStyle&&(this.lastRowStyle=serializeRangeStyle(json.lastRowStyle)),json.firstColumnStyle&&(this.firstColumnStyle=serializeRangeStyle(json.firstColumnStyle)),json.secondColumnStyle&&(this.secondColumnStyle=serializeRangeStyle(json.secondColumnStyle)),json.lastColumnStyle&&(this.lastColumnStyle=serializeRangeStyle(json.lastColumnStyle))}dispose(){this._mergeCacheMap.clear()}}const buildInThemes=[...[{baseName:"blue",header:"rgb(164, 202, 254)",color:"rgb(225, 239, 254)"},{baseName:"grey",header:"rgb(205, 208, 216)",color:"rgb(238, 239, 241)"},{baseName:"red",header:"rgb(248, 180, 180)",color:"rgb(253, 232, 232)"},{baseName:"orange",header:"rgb(253, 186, 140)",color:"rgb(254, 236, 220)"},{baseName:"yellow",header:"rgb(250, 200, 21)",color:"rgb(255, 244, 185)"},{baseName:"green",header:"rgb(132, 225, 188)",color:"rgb(222, 247, 236)"},{baseName:"azure",header:"rgb(126, 220, 226)",color:"rgb(213, 245, 246)"},{baseName:"indigo",header:"rgb(186, 198, 248)",color:"rgb(233, 237, 255)"},{baseName:"purple",header:"rgb(202, 191, 253)",color:"rgb(237, 235, 254)"},{baseName:"magenta",header:"rgb(248, 180, 217)",color:"rgb(252, 232, 243)"}].map((({baseName,header,color})=>((baseName,header,color)=>new RangeThemeStyle(`light-${baseName}`,{headerRowStyle:{bg:{rgb:header}},firstColumnStyle:{bg:{rgb:"rgb(255, 255, 255)"}},secondColumnStyle:{bg:{rgb:color}},lastRowStyle:{bg:{rgb:header}}}))(baseName,header,color))),...[{baseName:"blue",rowHeader:"rgb(63, 131, 248)",colHeader:"rgb(195, 221, 253)"},{baseName:"grey",rowHeader:"rgb(95, 101, 116)",colHeader:"rgb(227, 229, 234)"},{baseName:"red",rowHeader:"rgb(240, 82, 82)",colHeader:"rgb(251, 213, 213)"},{baseName:"orange",rowHeader:"rgb(255, 90, 31)",colHeader:"rgb(252, 217, 189)"},{baseName:"yellow",rowHeader:"rgb(212, 157, 15)",colHeader:"rgb(252, 220, 106)"},{baseName:"green",rowHeader:"rgb(13, 164, 113)",colHeader:"rgb(188, 240, 218)"},{baseName:"azure",rowHeader:"rgb(6, 148, 162)",colHeader:"rgb(175, 236, 239)"},{baseName:"indigo",rowHeader:"rgb(70, 106, 247)",colHeader:"rgb(210, 218, 250)"},{baseName:"purple",rowHeader:"rgb(144, 97, 249)",colHeader:"rgb(220, 215, 254)"},{baseName:"magenta",rowHeader:"rgb(231, 70, 148)",colHeader:"rgb(250, 209, 232)"}].map((({baseName,rowHeader,colHeader})=>((baseName,rowHeader,colHeader)=>new RangeThemeStyle(`middle-${baseName}`,{headerRowStyle:{bg:{rgb:rowHeader}},headerColumnStyle:{bg:{rgb:colHeader}},secondRowStyle:{bg:{rgb:colHeader}},lastRowStyle:{bg:{rgb:rowHeader}},lastColumnStyle:{bg:{rgb:colHeader}}}))(baseName,rowHeader,colHeader))),...[{baseName:"blue",rowHeader:"rgb(30, 66, 159)",firstRow:"rgb(195, 221, 253)",secondRow:"rgb(118, 169, 250)"},{baseName:"grey",rowHeader:"rgb(44, 48, 64)",firstRow:"rgb(227, 229, 234)",secondRow:"rgb(151, 157, 172)"},{baseName:"red",rowHeader:"rgb(155, 28, 28)",firstRow:"rgb(251, 213, 213)",secondRow:"rgb(249, 128, 128)"},{baseName:"orange",rowHeader:"rgb(180, 52, 3)",firstRow:"rgb(252, 217, 189)",secondRow:"rgb(255, 138, 76)"},{baseName:"yellow",rowHeader:"rgb(154, 109, 21)",firstRow:"rgb(252, 220, 106)",secondRow:"rgb(212, 157, 15)"},{baseName:"green",rowHeader:"rgb(4, 108, 78)",firstRow:"rgb(188, 240, 218)",secondRow:"rgb(49, 196, 141)"},{baseName:"azure",rowHeader:"rgb(3, 102, 114)",firstRow:"rgb(175, 236, 239)",secondRow:"rgb(22, 189, 202)"},{baseName:"indigo",rowHeader:"rgb(16, 51, 191)",firstRow:"rgb(210, 218, 250)",secondRow:"rgb(98, 128, 249)"},{baseName:"purple",rowHeader:"rgb(74, 29, 150)",firstRow:"rgb(220, 215, 254)",secondRow:"rgb(172, 148, 250)"},{baseName:"magenta",rowHeader:"rgb(153, 21, 75)",firstRow:"rgb(250, 209, 232)",secondRow:"rgb(241, 126, 184)"}].map((({baseName,rowHeader,firstRow,secondRow})=>((baseName,rowHeader,firstRow,secondRow)=>new RangeThemeStyle(`dark-${baseName}`,{headerRowStyle:{bg:{rgb:rowHeader},cl:{rgb:"rgb(255, 255, 255)"},ht:src.wqs.CENTER,bl:src.OdA.TRUE},firstRowStyle:{bg:{rgb:firstRow}},secondRowStyle:{bg:{rgb:secondRow}},lastRowStyle:{bg:{rgb:rowHeader}}}))(baseName,rowHeader,firstRow,secondRow)))],defaultRangeThemeStyleJSON={headerRowStyle:{bg:{rgb:"rgb(68,114,196)"},cl:{rgb:"rgb(255,255,255)"},ht:src.wqs.CENTER,bl:src.OdA.TRUE},firstRowStyle:{bg:{rgb:"rgb(217,225,242)"}}},defaultRangeThemeStyle=new RangeThemeStyle("default",defaultRangeThemeStyleJSON),defaultRangeThemeStyleJSONWithLastRowStyle=new RangeThemeStyle("default-last-row",{...defaultRangeThemeStyleJSON,lastRowStyle:{bd:{t:{s:src.jBF.THIN,cl:{rgb:"rgb(68,114,196)"}}},ht:src.wqs.CENTER,bl:src.OdA.TRUE}});function range_theme_model_ts_metadata(k,v){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(k,v)}function range_theme_model_ts_param(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}}class SheetRangeThemeModel extends src.jGt{constructor(_sheetInterceptorService,_resourceManagerService){super(),this._sheetInterceptorService=_sheetInterceptorService,this._resourceManagerService=_resourceManagerService,this._rangeThemeStyleMap=new Map,this._rangeThemeStyleRuleMap=new Map,this._rTreeCollection=new Map,this._defaultRangeThemeMap=new Map,this._registerIntercept(),this._initSnapshot(),this._initDefaultTheme()}_initDefaultTheme(){this.registerDefaultRangeTheme(defaultRangeThemeStyle),this.registerDefaultRangeTheme(defaultRangeThemeStyleJSONWithLastRowStyle);for(const theme of buildInThemes)this.registerDefaultRangeTheme(theme)}_ensureRangeThemeStyleMap(unitId){return this._rangeThemeStyleMap.has(unitId)||this._rangeThemeStyleMap.set(unitId,new Map),this._rangeThemeStyleMap.get(unitId)}_ensureRangeThemeStyleRuleMap(unitId){return this._rangeThemeStyleRuleMap.has(unitId)||this._rangeThemeStyleRuleMap.set(unitId,new Map),this._rangeThemeStyleRuleMap.get(unitId)}_ensureRTreeCollection(unitId){return this._rTreeCollection.has(unitId)||this._rTreeCollection.set(unitId,new src.hm5),this._rTreeCollection.get(unitId)}getDefaultRangeThemeStyle(name){return this._defaultRangeThemeMap.get(name)}registerRangeThemeRule(themeName,rangeInfo){const{unitId,subUnitId,range}=rangeInfo,id=(0,src.MZQ)(),ruleMap=this._ensureRangeThemeStyleRuleMap(unitId),rTreeCollection=this._ensureRTreeCollection(unitId);ruleMap.set(id,{rangeInfo,themeName}),rTreeCollection.insert({unitId,sheetId:subUnitId,range,id})}getRegisteredRangeThemeStyle(rangeInfo){const{unitId,subUnitId,range}=rangeInfo,rTreeCollection=this._ensureRTreeCollection(unitId),themes=Array.from(rTreeCollection.bulkSearch([{unitId,sheetId:subUnitId,range}]));if(themes[0]){const themeRule=this._ensureRangeThemeStyleRuleMap(unitId).get(themes[0]);if(themeRule)return themeRule.themeName}}removeRangeThemeRule(themeName,rangeInfo){const{unitId,subUnitId,range}=rangeInfo,rTreeCollection=this._ensureRTreeCollection(unitId),themes=Array.from(rTreeCollection.bulkSearch([{unitId,sheetId:subUnitId,range}]));if(themes[0]){const themeRuleMap=this._ensureRangeThemeStyleRuleMap(unitId),themeRule=themeRuleMap.get(themes[0]);themeRule&&themeRule.themeName===themeName&&(themeRuleMap.delete(themes[0]),rTreeCollection.remove({unitId,sheetId:subUnitId,range,id:themes[0]}))}}registerDefaultRangeTheme(rangeThemeStyle){this._defaultRangeThemeMap.set(rangeThemeStyle.getName(),rangeThemeStyle)}getRegisteredRangeThemes(){return Array.from(this._defaultRangeThemeMap.keys())}registerRangeThemeStyle(unitId,rangeThemeStyle){this._ensureRangeThemeStyleMap(unitId).set(rangeThemeStyle.getName(),rangeThemeStyle)}unregisterRangeThemeStyle(unitId,name){this._ensureRangeThemeStyleMap(unitId).delete(name)}getALLRegisteredTheme(){return Array.from(this._rangeThemeStyleMap.keys())}getRangeThemeStyle(unitId,name){return this._defaultRangeThemeMap.has(name)?this._defaultRangeThemeMap.get(name):this._ensureRangeThemeStyleMap(unitId).get(name)}getCellStyle(unitId,subUnitId,row,col){const range={startRow:row,startColumn:col,endRow:row,endColumn:col},rTreeCollection=this._ensureRTreeCollection(unitId),themes=Array.from(rTreeCollection.bulkSearch([{unitId,sheetId:subUnitId,range}]));if(themes[0]){const themeRule=this._ensureRangeThemeStyleRuleMap(unitId).get(themes[0]);if(themeRule){const{rangeInfo,themeName}=themeRule,offsetRow=row-rangeInfo.range.startRow,offsetCol=col-rangeInfo.range.startColumn;return this.getRangeThemeStyle(unitId,themeName).getStyle(offsetRow,offsetCol,row===rangeInfo.range.endRow,col===rangeInfo.range.endColumn)}}}_registerIntercept(){this.disposeWithMe(this._sheetInterceptorService.intercept(INTERCEPTOR_POINT.CELL_CONTENT,{id:"sheet.interceptor.range-theme-id",effect:src._w8.Style,handler:(cell,context,next)=>{const{row,col,unitId,subUnitId}=context,style=this.getCellStyle(unitId,subUnitId,row,col);if(style){const newCell={...cell};return newCell.themeStyle=style,next(newCell)}return next(cell)}}))}toJson(unitId){const ruleMap=this._ensureRangeThemeStyleRuleMap(unitId),rangeThemeStyleMap=this._ensureRangeThemeStyleMap(unitId);if(0===rangeThemeStyleMap.size&&0===ruleMap.size)return"{}";const rangeThemeStyleRuleMap={};ruleMap.forEach(((value,key)=>{rangeThemeStyleRuleMap[key]=value}));const rangeThemeStyleMapJson={};return rangeThemeStyleMap.forEach(((value,key)=>{rangeThemeStyleMapJson[key]=value.toJson()})),JSON.stringify({rangeThemeStyleRuleMap,rangeThemeStyleMapJson})}fromJSON(unitId,json){const{rangeThemeStyleRuleMap:rangeThemeStyleRuleMapJSON,rangeThemeStyleMapJson}=json;rangeThemeStyleRuleMapJSON&&Object.keys(rangeThemeStyleRuleMapJSON).forEach((key=>{const ruleMap=rangeThemeStyleRuleMapJSON[key],{themeName,rangeInfo}=ruleMap;this.registerRangeThemeRule(themeName,rangeInfo);this._ensureRTreeCollection(rangeInfo.unitId).insert({unitId:key,sheetId:rangeInfo.subUnitId,range:rangeInfo.range,id:key})})),rangeThemeStyleMapJson&&Object.keys(rangeThemeStyleMapJson).forEach((key=>{const styleMap=rangeThemeStyleMapJson[key],style=new RangeThemeStyle(styleMap.name);style.fromJson(styleMap),this._ensureRangeThemeStyleMap(unitId).set(style.getName(),style)}))}deleteUnitId(unitId){this._rangeThemeStyleMap.delete(unitId),this._rangeThemeStyleRuleMap.delete(unitId),this._rTreeCollection.delete(unitId)}_initSnapshot(){this.disposeWithMe(this._resourceManagerService.registerPluginResource({toJson:unitId=>this.toJson(unitId),parseJson:json=>{if(!json)return{};try{return JSON.parse(json)}catch(error){return{}}},businesses:[src.Zy$.UNIVER_SHEET],pluginName:"SHEET_RANGE_THEME_MODEL_PLUGIN",onLoad:(unitId,resources)=>{this.fromJSON(unitId,resources)},onUnLoad:unitId=>{this.deleteUnitId(unitId)}}))}dispose(){super.dispose(),this._rangeThemeStyleMap.clear(),this._rangeThemeStyleRuleMap.clear(),this._defaultRangeThemeMap.clear(),this._rTreeCollection.clear()}}function target_util_getSheetCommandTarget(univerInstanceService,params={}){const{unitId,subUnitId}=params,workbook=unitId?univerInstanceService.getUniverSheetInstance(unitId):univerInstanceService.getCurrentUnitForType(src.Zy$.UNIVER_SHEET);if(!workbook)return null;const worksheet=subUnitId?workbook.getSheetBySheetId(subUnitId):workbook.getActiveSheet(!0);return worksheet?{worksheet,workbook,unitId:workbook.getUnitId(),subUnitId:worksheet.getSheetId()}:null}function target_util_getSheetMutationTarget(univerInstanceService,params){const{unitId,subUnitId}=params,workbook=univerInstanceService.getUniverSheetInstance(unitId);if(!workbook)return null;const worksheet=workbook.getSheetBySheetId(subUnitId);return worksheet?{worksheet,workbook}:null}SheetRangeThemeModel=function range_theme_model_ts_decorate(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r}([range_theme_model_ts_param(0,(0,src.y_5)(SheetInterceptorService)),range_theme_model_ts_param(1,(0,src.y_5)(src.Gvw)),range_theme_model_ts_metadata("design:type",Function),range_theme_model_ts_metadata("design:paramtypes",[void 0===SheetInterceptorService?Object:SheetInterceptorService,void 0===src.Gvw?Object:src.Gvw])],SheetRangeThemeModel);const SetWorksheetRangeThemeStyleMutation={id:"sheet.mutation.set-worksheet-range-theme-style",type:src.g4t.MUTATION,handler:(accessor,params)=>{const{unitId,subUnitId,range,themeName}=params,target=target_util_getSheetCommandTarget(accessor.get(src.HCr)),sheetRangeThemeModel=accessor.get(SheetRangeThemeModel);return!!target&&(sheetRangeThemeModel.registerRangeThemeRule(themeName,{range,unitId,subUnitId}),!0)}},DeleteWorksheetRangeThemeStyleMutation={id:"sheet.mutation.remove-worksheet-range-theme-style",type:src.g4t.MUTATION,handler:(accessor,params)=>{const{unitId,subUnitId,range,themeName}=params,target=target_util_getSheetCommandTarget(accessor.get(src.HCr)),sheetRangeThemeModel=accessor.get(SheetRangeThemeModel);return!!target&&(sheetRangeThemeModel.removeRangeThemeRule(themeName,{range,unitId,subUnitId}),!0)}},SetWorksheetRangeThemeStyleCommand={type:src.g4t.COMMAND,id:"sheet.command.set-worksheet-range-theme-style",handler:(accessor,params)=>{const commandService=accessor.get(src.wTY),undoRedoService=accessor.get(src.$Dz),{unitId}=params,undoMutationParams=((accessor,params)=>{const target=target_util_getSheetMutationTarget(accessor.get(src.HCr),params);if(!target)throw new Error("[SetWorksheetRangeThemeStyleMutation]: worksheet is null error!");const{worksheet}=target;return{unitId:params.unitId,subUnitId:worksheet.getSheetId(),range:params.range,themeName:params.themeName}})(accessor,params);return!!commandService.syncExecuteCommand(SetWorksheetRangeThemeStyleMutation.id,params)&&(undoRedoService.pushUndoRedo({unitID:unitId,undoMutations:[{id:DeleteWorksheetRangeThemeStyleMutation.id,params:undoMutationParams}],redoMutations:[{id:SetWorksheetRangeThemeStyleMutation.id,params}]}),!0)}},InsertRowMutationUndoFactory=(accessor,params)=>{if(null==accessor.get(src.HCr).getUniverSheetInstance(params.unitId))throw new Error("universheet is null error!");return{unitId:params.unitId,subUnitId:params.subUnitId,range:params.range}},InsertRowMutation={id:"sheet.mutation.insert-row",type:src.g4t.MUTATION,handler:(accessor,params)=>{const{unitId,subUnitId,range,rowInfo}=params,universheet=accessor.get(src.HCr).getUniverSheetInstance(unitId);if(null==universheet)throw new Error("universheet is null error!");const worksheet=universheet.getSheetBySheetId(subUnitId);if(null==worksheet)throw new Error("worksheet is null error!");const rowWrapper=worksheet.getRowManager().getRowData(),defaultRowInfo={h:worksheet.getConfig().defaultRowHeight,hd:0},rowIndex=range.startRow,rowCount=range.endRow-range.startRow+1;for(let j=rowIndex;j<rowIndex+rowCount;j++)rowInfo?(0,src.ckn)(j,rowInfo[j-range.startRow]??defaultRowInfo,rowWrapper):(0,src.ckn)(j,defaultRowInfo,rowWrapper);worksheet.setRowCount(worksheet.getRowCount()+range.endRow-range.startRow+1);return worksheet.getCellMatrix().insertRows(range.startRow,rowCount),!0}},InsertColMutationUndoFactory=(accessor,params)=>{if(null==accessor.get(src.HCr).getUniverSheetInstance(params.unitId))throw new Error("universheet is null error!");return{unitId:params.unitId,subUnitId:params.subUnitId,range:params.range}},InsertColMutation={id:"sheet.mutation.insert-col",type:src.g4t.MUTATION,handler:(accessor,params)=>{const universheet=accessor.get(src.HCr).getUniverSheetInstance(params.unitId);if(null==universheet)throw new Error("universheet is null error!");const worksheet=universheet.getSheetBySheetId(params.subUnitId);if(!worksheet)return!1;const manager=worksheet.getColumnManager(),{range,colInfo}=params,columnWrapper=manager.getColumnData(),colIndex=range.startColumn,colCount=range.endColumn-range.startColumn+1,defaultColWidth=worksheet.getConfig().defaultColumnWidth;for(let j=colIndex;j<colIndex+colCount;j++){const defaultColInfo={w:defaultColWidth,hd:0};colInfo?(0,src.ckn)(j,colInfo[j-range.startColumn]??defaultColInfo,columnWrapper):(0,src.ckn)(j,defaultColInfo,columnWrapper)}worksheet.setColumnCount(worksheet.getColumnCount()+range.endColumn-range.startColumn+1);return worksheet.getCellMatrix().insertColumns(range.startColumn,colCount),!0}},RemoveRowMutation={id:"sheet.mutation.remove-rows",type:src.g4t.MUTATION,handler:(accessor,params)=>{const universheet=accessor.get(src.HCr).getUniverSheetInstance(params.unitId);if(null==universheet)throw new Error("universheet is null error!");const worksheet=universheet.getSheetBySheetId(params.subUnitId);if(!worksheet)return!1;const range=params.range,rowPrimitive=worksheet.getRowManager().getRowData(),filterOutRows=[];for(let i=range.startRow;i<=range.endRow;i++)worksheet.getRowFiltered(i)&&filterOutRows.push(i);const rowCount=range.endRow-range.startRow+1;(0,src.eLK)(range.startRow,rowCount,rowPrimitive);return worksheet.getCellMatrix().removeRows(range.startRow,rowCount),worksheet.setRowCount(worksheet.getRowCount()-rowCount),!0}},RemoveColMutation={id:"sheet.mutation.remove-col",type:src.g4t.MUTATION,handler:(accessor,params)=>{const universheet=accessor.get(src.HCr).getUniverSheetInstance(params.unitId);if(null==universheet)throw new Error("universheet is null error!");const worksheet=universheet.getSheetBySheetId(params.subUnitId);if(!worksheet)return!1;const range=params.range,colPrimitive=worksheet.getColumnManager().getColumnData(),colCount=range.endColumn-range.startColumn+1;(0,src.eLK)(range.startColumn,colCount,colPrimitive),worksheet.setColumnCount(worksheet.getColumnCount()-colCount);return worksheet.getCellMatrix().removeColumns(range.startColumn,colCount),!0}};function handleStyle(styles,oldVal,newVal){const oldStyle=styles.getStyleByCell(oldVal);null==oldStyle&&delete oldVal.s,"string"==typeof newVal.s&&(newVal.s=styles.get(newVal.s));const merge=mergeStyle(oldStyle,newVal.s?newVal.s:null);merge&&(src.S0q.removeNull(merge),Object.entries(merge).forEach((([key,val])=>{"object"==typeof val&&null!==val&&0===Object.keys(val).length&&delete merge[key]}))),src.S0q.isEmptyObject(merge)?delete oldVal.s:oldVal.s=styles.setValue(merge);const newValueStream=newVal.v?`${newVal.v}\r\n`:"";!newVal.p&&oldVal.p&&(newValueStream&&newValueStream!==oldVal.p.body?.dataStream?delete oldVal.p:function mergeRichTextStyle(p,newStyle){if(null==p.body)return;Array.isArray(p.body.textRuns)||(p.body.textRuns=[]);let index=0;const newTextRuns=[],paragraphs=p.body?.paragraphs||[];for(const textRun of p.body.textRuns){const{st,ed,ts={}}=textRun;if(index<st){const tr={st:index,ed:st},merge=mergeStyle({},newStyle,!0);merge&&src.S0q.removeNull(merge),src.S0q.isEmptyObject(merge)||(tr.ts=merge),newTextRuns.push(tr)}const merge=mergeStyle(ts,newStyle,!0);merge&&src.S0q.removeNull(merge),src.S0q.isEmptyObject(merge)?delete textRun.ts:textRun.ts=merge,newTextRuns.push(textRun),index=skipParagraphs(paragraphs,ed)}const endIndex=p.body.dataStream.endsWith("\r\n")?p.body.dataStream.length-2:p.body.dataStream.length;if(index<endIndex){const tr={st:index,ed:endIndex},merge=mergeStyle({},newStyle,!0);merge&&src.S0q.removeNull(merge),src.S0q.isEmptyObject(merge)||(tr.ts=merge),newTextRuns.push(tr)}p.body.textRuns=(0,src.Vu0)(newTextRuns)}(oldVal.p,newVal.s?newVal.s:null))}function transformBorders(oldBorders,newBorders){if(!newBorders||!Object.keys(newBorders).length)return oldBorders;for(const k in newBorders)k in oldBorders||(oldBorders[k]=null);return oldBorders}function mergeStyle(oldStyle,newStyle,isRichText=!1){if(null===newStyle)return newStyle;if(void 0===newStyle)return oldStyle;const backupStyle=src.S0q.deepClone(oldStyle)||{};for(const k in newStyle)isRichText&&["bd","tr","td","ht","vt","tb","pd","bg"].includes(k)||(backupStyle[k]=k in backupStyle&&"bd"===k?Object.assign(backupStyle[k],newStyle[k]):newStyle[k]);return"cl"in backupStyle&&("ul"in backupStyle&&backupStyle.ul&&(backupStyle.ul.cl=backupStyle.cl),"ol"in backupStyle&&backupStyle.ol&&(backupStyle.ol.cl=backupStyle.cl),"st"in backupStyle&&backupStyle.st&&(backupStyle.st.cl=backupStyle.cl)),backupStyle}function skipParagraphs(paragraphs,offset){return paragraphs.some((p=>p.startIndex===offset))?skipParagraphs(paragraphs,offset+1):offset}var util=__webpack_require__("../../packages/engine-numfmt/src/util.ts");function checkCellValueTypeByValue(newVal,oldVal){return void 0!==newVal.v?checkCellValueType(newVal.v,newVal.t):checkCellValueType(oldVal.v,oldVal.t)}function checkCellValueType(v,type){return null===v?null:"string"==typeof v?(0,src.DMQ)(v)?0!=+v&&1!=+v||type!==src.scd.BOOLEAN?src.scd.NUMBER:src.scd.BOOLEAN:(0,src.oiQ)(v)?src.scd.BOOLEAN:src.scd.STRING:"number"==typeof v?0!==v&&1!==v||type!==src.scd.BOOLEAN?src.scd.NUMBER:src.scd.BOOLEAN:"boolean"==typeof v?src.scd.BOOLEAN:src.scd.FORCE_STRING}function getCellValue(type,cell){return type===src.scd.NUMBER?Number(cell.v):type===src.scd.BOOLEAN?function extractBooleanValue(value){if("string"==typeof value){if("TRUE"===value.toUpperCase())return!0;if("FALSE"===value.toUpperCase())return!1;if((0,src.$_H)(value)){if(0===Number(value))return!1;if(1===Number(value))return!0}}if("number"==typeof value){if(0===value)return!1;if(1===value)return!0}if("boolean"==typeof value)return value;return null}(cell.v)?1:0:type===src.scd.STRING||type===src.scd.FORCE_STRING?`${cell.v}`:cell.v}const SetRangeValuesUndoMutationFactory=(accessor,params)=>{const{unitId,subUnitId,cellValue}=params,workbook=accessor.get(src.HCr).getUniverSheetInstance(unitId);if(null==workbook)throw new Error("workbook is null error!");const worksheet=workbook.getSheetBySheetId(subUnitId);if(null==worksheet)throw new Error("worksheet is null error!");const cellMatrix=worksheet.getCellMatrix(),styles=workbook.getStyles(),undoData=new src.hDc;return new src.hDc(cellValue).forValue(((row,col,newVal)=>{const cell=src.S0q.deepClone(cellMatrix?.getValue(row,col))||{},oldStyle=styles.getStyleByCell(cell),newStyle=styles.getStyleByCell(newVal);cell.s=function transformStyle(oldStyle,newStyle){if(!newStyle||!Object.keys(newStyle).length)return oldStyle;const backupStyle=oldStyle||{};for(const k in newStyle)"bd"===k?backupStyle[k]=transformBorders(backupStyle[k]||{},newStyle[k]):k in backupStyle||(backupStyle[k]=null);return backupStyle}(oldStyle,newStyle),undoData.setValue(row,col,function setNull(value){return null==value?null:(void 0===value.f&&(value.f=null),void 0===value.si&&(value.si=null),void 0===value.p&&(value.p=null),void 0===value.v&&(value.v=null),void 0===value.t&&(value.t=null),void 0===value.s&&(value.s=null),void 0===value.custom&&(value.custom=null),value)}(cell))})),{...params,options:{},cellValue:undoData.getMatrix()}},SetRangeValuesMutation={id:"sheet.mutation.set-range-values",type:src.g4t.MUTATION,handler:(accessor,params)=>{const{cellValue,subUnitId,unitId}=params,workbook=accessor.get(src.HCr).getUnit(unitId);if(!workbook)return!1;const worksheet=workbook.getSheetBySheetId(subUnitId);if(!worksheet)return!1;const cellMatrix=worksheet.getCellMatrix(),styles=workbook.getStyles();return new src.hDc(cellValue).forValue(((row,col,newVal)=>{if(newVal){const oldVal=cellMatrix.getValue(row,col)||{},type=function getCellType(styles,newVal,oldVal){if(newVal.t)return newVal.t;if(null===newVal.v)return null;const newStyle=styles.getStyleByCell(newVal),oldStyle=styles.getStyleByCell(oldVal);if(oldVal.t===src.scd.FORCE_STRING){if(!(0,util.Z)(oldStyle?.n?.pattern)&&void 0!==newVal.v){if((0,src.DMQ)(newVal.v))return src.scd.NUMBER;if((0,src.oiQ)(`${newVal.v}`))return src.scd.BOOLEAN}return src.scd.FORCE_STRING}return function hasNumberFormat(style){return!!style?.n?.pattern}(newStyle)?(0,util.Z)(newStyle?.n?.pattern)?src.scd.STRING:checkCellValueTypeByValue(newVal,oldVal):(0,util.Z)(oldStyle?.n?.pattern)?src.scd.STRING:checkCellValueTypeByValue(newVal,oldVal)}(styles,newVal,oldVal);void 0!==newVal.f&&(oldVal.f=newVal.f),void 0!==newVal.si&&(oldVal.si=newVal.si),void 0!==newVal.p&&(oldVal.p=newVal.p),void 0!==newVal.v&&(oldVal.v=getCellValue(type,newVal)),void 0!==oldVal.v&&(oldVal.t=type,oldVal.v=getCellValue(type,oldVal)),void 0!==newVal.s&&handleStyle(styles,oldVal,newVal),void 0!==newVal.custom&&(oldVal.custom=newVal.custom),cellMatrix.setValue(row,col,src.S0q.removeNull(oldVal))}else cellMatrix?.setValue(row,col,{})})),!0}},AppendRowCommand={type:src.g4t.COMMAND,id:"sheet.command.append-row",handler:(accessor,params)=>{const commandService=accessor.get(src.wTY),undoRedoService=accessor.get(src.$Dz),{unitId,subUnitId,cellValue,insertRowNums,insertColumnNums,maxRows,maxColumns}=params,setRangeValuesMutationRedoParams={unitId,subUnitId,cellValue},setRangeValuesMutationUndoParams=SetRangeValuesUndoMutationFactory(accessor,setRangeValuesMutationRedoParams),redoMutations=[{id:SetRangeValuesMutation.id,params:setRangeValuesMutationRedoParams}],undoMutations=[{id:SetRangeValuesMutation.id,params:setRangeValuesMutationUndoParams}];if(insertRowNums){const insertRowRedoParams={unitId,subUnitId,range:{startRow:maxRows,endRow:maxRows,startColumn:0,endColumn:maxColumns-1}},insertRowUndoParams=InsertRowMutationUndoFactory(accessor,insertRowRedoParams);redoMutations.unshift({id:InsertRowMutation.id,params:insertRowRedoParams}),undoMutations.push({id:RemoveRowMutation.id,params:insertRowUndoParams})}if(insertColumnNums){const insertColRedoParams={unitId,subUnitId,range:{startRow:0,endRow:maxRows-1,startColumn:maxColumns,endColumn:maxColumns-1+insertColumnNums}},insertColUndoParams=InsertColMutationUndoFactory(accessor,insertColRedoParams);redoMutations.unshift({id:InsertColMutation.id,params:insertColRedoParams}),undoMutations.push({id:RemoveColMutation.id,params:insertColUndoParams})}return!!(0,src.PkI)(redoMutations,commandService).result&&(undoRedoService.pushUndoRedo({unitID:unitId,undoMutations,redoMutations}),!0)}};function generateNullCell(range){const cellValue=new src.hDc;return range.forEach((range=>{const{startRow,startColumn,endRow,endColumn}=range;for(let i=startRow;i<=endRow;i++)for(let j=startColumn;j<=endColumn;j++)cellValue.setValue(i,j,null)})),cellValue.clone()}function generateNullCellValue(range){const cellValue=new src.hDc;return range.forEach((range=>{const{startRow,startColumn,endRow,endColumn}=range;for(let i=startRow;i<=endRow;i++)for(let j=startColumn;j<=endColumn;j++)cellValue.setValue(i,j,{v:null,p:null,f:null,si:null,custom:null})})),cellValue.clone()}function generateNullCellStyle(ranges){const cellValue=new src.hDc;return ranges.forEach((range=>{const{startRow,startColumn,endRow,endColumn}=range;for(let i=startRow;i<=endRow;i++)for(let j=startColumn;j<=endColumn;j++)cellValue.setValue(i,j,{s:null})})),cellValue.clone()}function rangeToDiscreteRange(range,accessor,unitId,subUnitId,considerHide){const univerInstanceService=accessor.get(src.HCr),workbook=unitId?univerInstanceService.getUnit(unitId,src.Zy$.UNIVER_SHEET):univerInstanceService.getCurrentUnitForType(src.Zy$.UNIVER_SHEET),worksheet=subUnitId?workbook?.getSheetBySheetId(subUnitId):workbook?.getActiveSheet();if(!worksheet)return null;const{startRow,endRow,startColumn,endColumn}=range,rows=[],cols=[];for(let r=startRow;r<=endRow;r++)worksheet.getRowFiltered(r)||(considerHide?worksheet.getRowRawVisible(r)&&rows.push(r):rows.push(r));for(let c=startColumn;c<=endColumn;c++)considerHide?worksheet.getColVisible(c)&&cols.push(c):cols.push(c);return{rows,cols}}function getVisibleRanges(ranges,accessor,unitId,subUnitId){const allRows=[],allCols=[];for(const range of ranges){const discreteRange=rangeToDiscreteRange(range,accessor,unitId,subUnitId,!0);discreteRange&&(allRows.push(...discreteRange.rows),allCols.push(...discreteRange.cols))}const uniqueRows=Array.from(new Set(allRows)).sort(((a,b)=>a-b)),uniqueCols=Array.from(new Set(allCols)).sort(((a,b)=>a-b)),visibleRanges=[];function findContinuousSegments(arr){const segments=[];let start=arr[0];for(let i=1;i<arr.length;i++)arr[i]!==arr[i-1]+1&&(segments.push([start,arr[i-1]]),start=arr[i]);return segments.push([start,arr[arr.length-1]]),segments}const rowSegments=findContinuousSegments(uniqueRows),colSegments=findContinuousSegments(uniqueCols);for(const[startRow,endRow]of rowSegments)for(const[startCol,endCol]of colSegments)visibleRanges.push({startRow,endRow,startColumn:startCol,endColumn:endCol});return visibleRanges}var shareReplay=__webpack_require__("../../node_modules/.pnpm/rxjs@7.8.1/node_modules/rxjs/dist/esm5/internal/operators/shareReplay.js"),takeUntil=__webpack_require__("../../node_modules/.pnpm/rxjs@7.8.1/node_modules/rxjs/dist/esm5/internal/operators/takeUntil.js"),switchMap=__webpack_require__("../../node_modules/.pnpm/rxjs@7.8.1/node_modules/rxjs/dist/esm5/internal/operators/switchMap.js"),of=__webpack_require__("../../node_modules/.pnpm/rxjs@7.8.1/node_modules/rxjs/dist/esm5/internal/observable/of.js"),distinctUntilChanged=__webpack_require__("../../node_modules/.pnpm/rxjs@7.8.1/node_modules/rxjs/dist/esm5/internal/operators/distinctUntilChanged.js"),skip=__webpack_require__("../../node_modules/.pnpm/rxjs@7.8.1/node_modules/rxjs/dist/esm5/internal/operators/skip.js"),merge=__webpack_require__("../../node_modules/.pnpm/rxjs@7.8.1/node_modules/rxjs/dist/esm5/internal/observable/merge.js"),SelectionMoveType=function(SelectionMoveType){return SelectionMoveType[SelectionMoveType.MOVE_START=0]="MOVE_START",SelectionMoveType[SelectionMoveType.MOVING=1]="MOVING",SelectionMoveType[SelectionMoveType.MOVE_END=2]="MOVE_END",SelectionMoveType[SelectionMoveType.ONLY_SET=3]="ONLY_SET",SelectionMoveType}({});class WorkbookSelectionModel extends src.jGt{constructor(_workbook){super(),this._workbook=_workbook,this._worksheetSelections=new Map,this._selectionMoveStart$=new Subject.B,this.selectionMoveStart$=this._selectionMoveStart$.asObservable(),this._selectionMoving$=new Subject.B,this.selectionMoving$=this._selectionMoving$.asObservable(),this._selectionMoveEnd$=new BehaviorSubject.t([]),this.selectionMoveEnd$=this._selectionMoveEnd$.asObservable(),this._selectionSet$=new BehaviorSubject.t([]),this.selectionSet$=this._selectionSet$.asObservable(),this._beforeSelectionMoveEnd$=new BehaviorSubject.t([]),this.beforeSelectionMoveEnd$=this._beforeSelectionMoveEnd$.asObservable(),this.selectionChanged$=(0,merge.h)(this._selectionMoveEnd$,this._selectionSet$)}dispose(){super.dispose(),this._beforeSelectionMoveEnd$.complete(),this._selectionMoveEnd$.complete(),this._selectionMoving$.complete(),this._selectionMoveStart$.complete(),this._selectionSet$.complete()}addSelections(sheetId,selectionDatas){const selections=this.getSelectionsOfWorksheet(sheetId);selections.push(...selectionDatas),this._selectionSet$.next(selections)}setSelections(sheetId,selectionDatas=[],type){switch(this.setSelectionsOfWorksheet(sheetId,selectionDatas),type){case SelectionMoveType.MOVE_START:this._selectionMoveStart$.next(selectionDatas);break;case SelectionMoveType.MOVING:this._selectionMoving$.next(selectionDatas);break;case SelectionMoveType.MOVE_END:this._beforeSelectionMoveEnd$.next(selectionDatas),this._selectionMoveEnd$.next(selectionDatas);break;case SelectionMoveType.ONLY_SET:default:this._selectionSet$.next(selectionDatas)}}getCurrentSelections(){return this._getCurrentSelections()}getSelectionOfWorksheet(sheetId){return this.getSelectionsOfWorksheet(sheetId)}getSelectionsOfWorksheet(sheetId){return this._worksheetSelections.has(sheetId)||this._worksheetSelections.set(sheetId,[]),this._worksheetSelections.get(sheetId)}setSelectionsOfWorksheet(sheetId,selections){this._worksheetSelections.set(sheetId,[...selections])}deleteSheetSelection(sheetId){this._worksheetSelections.set(sheetId,[])}clear(){this._worksheetSelections.clear(),this._selectionSet$.next([])}_getCurrentSelections(){return this.getSelectionsOfWorksheet(this._workbook.getActiveSheet().getSheetId())}getCurrentLastSelection(){const selectionData=this._getCurrentSelections();return selectionData[selectionData.length-1]}}function selection_service_ts_metadata(k,v){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(k,v)}class selection_service_SheetsSelectionsService extends src.hy_{get _currentSelectionPos(){const workbook=this._instanceSrv.getCurrentUnitForType(src.Zy$.UNIVER_SHEET);if(!workbook)return null;const worksheet=workbook.getActiveSheet();return{unitId:workbook.getUnitId(),sheetId:worksheet.getSheetId()}}get currentSelectionParam(){return this._currentSelectionPos}constructor(_instanceSrv){super(),this._instanceSrv=_instanceSrv,this._workbookSelections=new Map,this._init()}_init(){const c$=this._instanceSrv.getCurrentTypeOfUnit$(src.Zy$.UNIVER_SHEET).pipe((0,shareReplay.t)(1),(0,takeUntil.Q)(this.dispose$));this.selectionMoveStart$=c$.pipe((0,switchMap.n)((workbook=>workbook?this._ensureWorkbookSelection(workbook.getUnitId()).selectionMoveStart$:(0,of.of)()))),this.selectionMoving$=c$.pipe((0,switchMap.n)((workbook=>workbook?this._ensureWorkbookSelection(workbook.getUnitId()).selectionMoving$:(0,of.of)()))),this.selectionMoveEnd$=c$.pipe((0,switchMap.n)((workbook=>workbook?this._ensureWorkbookSelection(workbook.getUnitId()).selectionMoveEnd$:(0,of.of)([])))),this.selectionSet$=c$.pipe((0,switchMap.n)((workbook=>workbook?this._ensureWorkbookSelection(workbook.getUnitId()).selectionSet$:(0,of.of)([])))),this.selectionChanged$=c$.pipe((0,switchMap.n)((workbook=>workbook?this._ensureWorkbookSelection(workbook.getUnitId()).selectionChanged$:(0,of.of)([])))).pipe((0,distinctUntilChanged.F)(((prev,curr)=>prev.length===curr.length&&(0===prev.length&&0===curr.length||prev.every(((item,index)=>JSON.stringify(item)===JSON.stringify(curr[index])))))),(0,skip.i)(1)),this._instanceSrv.getTypeOfUnitDisposed$(src.Zy$.UNIVER_SHEET).pipe((0,takeUntil.Q)(this.dispose$)).subscribe((workbook=>{this._removeWorkbookSelection(workbook.getUnitId())}))}clear(){this._workbookSelections.forEach((wbSelection=>wbSelection.clear()))}getCurrentSelections(){return this._getCurrentSelections()}getCurrentLastSelection(){const selectionData=this._getCurrentSelections();return selectionData?.[selectionData.length-1]}addSelections(unitIdOrSelections,worksheetId,selectionDatas){if("string"==typeof unitIdOrSelections)return void this._ensureWorkbookSelection(unitIdOrSelections).addSelections(worksheetId,selectionDatas);const current=this._currentSelectionPos;if(!current)throw new Error("[SheetsSelectionsService]: cannot find current selection position!");const{unitId,sheetId}=current;this._ensureWorkbookSelection(unitId).addSelections(sheetId,unitIdOrSelections)}setSelections(unitIdOrSelections,worksheetIdOrType,selectionDatas,type){if("string"==typeof unitIdOrSelections&&"string"==typeof worksheetIdOrType){const unitId=unitIdOrSelections;return void this._ensureWorkbookSelection(unitId).setSelections(worksheetIdOrType,selectionDatas||[],type??SelectionMoveType.ONLY_SET)}const current=this._currentSelectionPos;if(!current)throw new Error("[SheetsSelectionsService]: cannot find current selection position!");const{unitId,sheetId}=current;if("object"==typeof unitIdOrSelections){const selectionData=unitIdOrSelections??selectionDatas,type=worksheetIdOrType??SelectionMoveType.ONLY_SET;this._ensureWorkbookSelection(unitId).setSelections(sheetId,selectionData,type)}}clearCurrentSelections(){this._getCurrentSelections().splice(0)}isOverlapping(){const selectionDataList=this.getCurrentSelections();return null!=selectionDataList&&selectionDataList.some((({range},index)=>selectionDataList.some((({range:range2},index2)=>index!==index2&&(range.startRow<=range2.endRow&&range.endRow>=range2.startRow&&range.startColumn<=range2.endColumn&&range.endColumn>=range2.startColumn)))))}_getCurrentSelections(){const current=this._currentSelectionPos;if(!current)return[];const{unitId,sheetId}=current;return this._ensureWorkbookSelection(unitId).getSelectionsOfWorksheet(sheetId)}getWorkbookSelections(unitId){return this._ensureWorkbookSelection(unitId)}_ensureWorkbookSelection(unitId){let wbSelection=this._workbookSelections.get(unitId);if(!wbSelection){const workbook=this._instanceSrv.getUnit(unitId);if(!workbook)throw new Error(`[SheetsSelectionsService]: cannot resolve unit with id "${unitId}"!`);wbSelection=new WorkbookSelectionModel(workbook),this._workbookSelections.set(unitId,wbSelection)}return wbSelection}_removeWorkbookSelection(unitId){this._workbookSelections.delete(unitId)}}selection_service_SheetsSelectionsService=function selection_service_ts_decorate(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r}([function selection_service_ts_param(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}}(0,src.HCr),selection_service_ts_metadata("design:type",Function),selection_service_ts_metadata("design:paramtypes",[void 0===src.HCr?Object:src.HCr])],selection_service_SheetsSelectionsService);const SELECTIONS_ENABLED="SELECTIONS_ENABLED",REF_SELECTIONS_ENABLED="REF_SELECTIONS_ENABLED";const ClearSelectionAllCommand={id:"sheet.command.clear-selection-all",type:src.g4t.COMMAND,handler:(accessor,params)=>{const univerInstanceService=accessor.get(src.HCr),commandService=accessor.get(src.wTY),selectionManagerService=accessor.get(selection_service_SheetsSelectionsService),undoRedoService=accessor.get(src.$Dz),sheetInterceptorService=accessor.get(SheetInterceptorService),workbook=univerInstanceService.getCurrentUnitForType(src.Zy$.UNIVER_SHEET);if(!workbook)return!1;const unitId=params?.unitId||workbook.getUnitId(),worksheet=workbook.getActiveSheet();if(!worksheet)return!1;const subUnitId=params?.subUnitId||worksheet.getSheetId(),selections=params?.ranges||selectionManagerService.getCurrentSelections()?.map((s=>s.range));if(!selections?.length)return!1;const sequenceExecuteList=[],sequenceExecuteUndoList=[],clearMutationParams={subUnitId,unitId,cellValue:generateNullCell(getVisibleRanges(selections,accessor,unitId,subUnitId))},undoClearMutationParams=SetRangeValuesUndoMutationFactory(accessor,clearMutationParams);sequenceExecuteList.push({id:SetRangeValuesMutation.id,params:clearMutationParams}),sequenceExecuteUndoList.push({id:SetRangeValuesMutation.id,params:undoClearMutationParams});const intercepted=sheetInterceptorService.onCommandExecute({id:ClearSelectionAllCommand.id});sequenceExecuteList.push(...intercepted.redos),sequenceExecuteUndoList.unshift(...intercepted.undos);return!!(0,src.PkI)(sequenceExecuteList,commandService)&&(undoRedoService.pushUndoRedo({unitID:unitId,undoMutations:sequenceExecuteUndoList,redoMutations:sequenceExecuteList}),!0)}},ClearSelectionContentCommand={id:"sheet.command.clear-selection-content",type:src.g4t.COMMAND,handler:(accessor,params)=>{const univerInstanceService=accessor.get(src.HCr),commandService=accessor.get(src.wTY),selectionManagerService=accessor.get(selection_service_SheetsSelectionsService),undoRedoService=accessor.get(src.$Dz),sheetInterceptorService=accessor.get(SheetInterceptorService),workbook=univerInstanceService.getCurrentUnitForType(src.Zy$.UNIVER_SHEET);if(!workbook)return!1;const unitId=params?.unitId||workbook.getUnitId(),worksheet=workbook.getActiveSheet();if(!worksheet)return!1;const subUnitId=params?.subUnitId||worksheet.getSheetId(),ranges=params?.ranges||selectionManagerService.getCurrentSelections()?.map((s=>s.range));if(!ranges?.length)return!1;const clearMutationParams={subUnitId,unitId,cellValue:generateNullCellValue(getVisibleRanges(ranges,accessor,unitId,subUnitId))},undoClearMutationParams=SetRangeValuesUndoMutationFactory(accessor,clearMutationParams),intercepted=sheetInterceptorService.onCommandExecute({id:ClearSelectionContentCommand.id}),redos=[{id:SetRangeValuesMutation.id,params:clearMutationParams},...intercepted.redos],undos=[...intercepted.undos,{id:SetRangeValuesMutation.id,params:undoClearMutationParams}];return!!(0,src.PkI)(redos,commandService).result&&(undoRedoService.pushUndoRedo({unitID:unitId,undoMutations:undos,redoMutations:redos}),!0)}},ClearSelectionFormatCommand={id:"sheet.command.clear-selection-format",type:src.g4t.COMMAND,handler:(accessor,params)=>{const univerInstanceService=accessor.get(src.HCr),commandService=accessor.get(src.wTY),selectionManagerService=accessor.get(selection_service_SheetsSelectionsService),undoRedoService=accessor.get(src.$Dz),sheetInterceptorService=accessor.get(SheetInterceptorService),workbook=univerInstanceService.getCurrentUnitForType(src.Zy$.UNIVER_SHEET);if(!workbook)return!1;const unitId=params?.unitId||workbook.getUnitId(),worksheet=workbook.getActiveSheet();if(!worksheet)return!1;const subUnitId=params?.subUnitId||worksheet.getSheetId(),ranges=params?.ranges||selectionManagerService.getCurrentSelections()?.map((s=>s.range));if(!ranges?.length)return!1;const sequenceExecuteList=[],sequenceExecuteUndoList=[],clearMutationParams={subUnitId,unitId,cellValue:generateNullCellStyle(getVisibleRanges(ranges,accessor,unitId,subUnitId))},undoClearMutationParams=SetRangeValuesUndoMutationFactory(accessor,clearMutationParams);sequenceExecuteList.push({id:SetRangeValuesMutation.id,params:clearMutationParams}),sequenceExecuteUndoList.push({id:SetRangeValuesMutation.id,params:undoClearMutationParams});const intercepted=sheetInterceptorService.onCommandExecute({id:ClearSelectionFormatCommand.id});sequenceExecuteList.push(...intercepted.redos),sequenceExecuteUndoList.unshift(...intercepted.undos);return!!(0,src.PkI)(sequenceExecuteList,commandService)&&(undoRedoService.pushUndoRedo({unitID:unitId,undoMutations:sequenceExecuteUndoList,redoMutations:sequenceExecuteList}),!0)}},InsertSheetUndoMutationFactory=(_accessor,params)=>({subUnitId:params.sheet.id,unitId:params.unitId,subUnitName:params.sheet.name}),InsertSheetMutation={id:"sheet.mutation.insert-sheet",type:src.g4t.MUTATION,handler:(accessor,params)=>{const univerInstanceService=accessor.get(src.HCr),{sheet,index,unitId}=params,workbook=univerInstanceService.getUniverSheetInstance(unitId);return!!workbook&&workbook.addWorksheet(sheet.id,index,sheet)}},RemoveSheetMutation={id:"sheet.mutation.remove-sheet",type:src.g4t.MUTATION,handler:(accessor,params)=>{const univerInstanceService=accessor.get(src.HCr),{subUnitId,unitId}=params,workbook=univerInstanceService.getUniverSheetInstance(unitId);return!!workbook&&workbook.removeSheet(subUnitId)}},CopySheetCommand={type:src.g4t.COMMAND,id:"sheet.command.copy-sheet",handler:(accessor,params)=>{const commandService=accessor.get(src.wTY),undoRedoService=accessor.get(src.$Dz),univerInstanceService=accessor.get(src.HCr),sheetInterceptorService=accessor.get(SheetInterceptorService),localeService=accessor.get(src.iH9),target=target_util_getSheetCommandTarget(univerInstanceService,params);if(!target)return!1;const{workbook,worksheet,unitId,subUnitId}=target,config=src.S0q.deepClone(worksheet.getConfig());config.name=function getCopyUniqueSheetName(workbook,localeService,name){let output=name+localeService.t("sheets.tabs.sheetCopy",""),count=2;for(;workbook.checkSheetName(output);)output=name+localeService.t("sheets.tabs.sheetCopy",`${count}`),count++;return output}(workbook,localeService,config.name),config.id=src.S0q.generateRandomId();const insertSheetMutationParams={index:workbook.getSheetIndex(worksheet)+1,sheet:config,unitId},removeSheetMutationParams=InsertSheetUndoMutationFactory(0,insertSheetMutationParams),intercepted=sheetInterceptorService.onCommandExecute({id:CopySheetCommand.id,params:{unitId,subUnitId,targetSubUnitId:config.id}}),redos=[...intercepted.preRedos??[],{id:InsertSheetMutation.id,params:insertSheetMutationParams},...intercepted.redos],undos=[...intercepted.preUndos??[],{id:RemoveSheetMutation.id,params:removeSheetMutationParams},...intercepted.undos];return!!(0,src.PkI)(redos,commandService).result&&(undoRedoService.pushUndoRedo({unitID:unitId,undoMutations:undos,redoMutations:redos}),!0)}};const MoveRangeMutation={id:"sheet.mutation.move-range",type:src.g4t.MUTATION,handler:(accessor,params)=>{const{from,to}=params;if(!from||!to)return!1;const workbook=accessor.get(src.HCr).getCurrentUnitForType(src.Zy$.UNIVER_SHEET);if(!workbook)return!1;const fromWorksheet=workbook.getSheetBySheetId(params.from.subUnitId),toWorksheet=workbook.getSheetBySheetId(params.to.subUnitId);if(!fromWorksheet||!toWorksheet)return!1;const fromCellMatrix=fromWorksheet.getCellMatrix(),toCellMatrix=toWorksheet.getCellMatrix();return new src.hDc(from.value).forValue(((row,col,newVal)=>{fromCellMatrix.setValue(row,col,newVal)})),new src.hDc(to.value).forValue(((row,col,newVal)=>{toCellMatrix.setValue(row,col,newVal)})),!0}};function alignToMergedCellsBorders(startRange,worksheet,shouldRecursive=!0){const coveredMergedCells=worksheet.getMatrixWithMergedCells(...(0,src.xMb)(startRange)),exceededMergedCells=[];if(coveredMergedCells.forValue(((row,col,value)=>{if(void 0!==value.colSpan&&void 0!==value.rowSpan){const mergedCellRange={startRow:row,startColumn:col,endRow:row+value.rowSpan-1,endColumn:col+value.colSpan-1};src.M_G.contains(startRange,mergedCellRange)||exceededMergedCells.push(mergedCellRange)}})),0===exceededMergedCells.length)return startRange;const union=src.M_G.union(startRange,...exceededMergedCells);return shouldRecursive?alignToMergedCellsBorders(union,worksheet,shouldRecursive):union}function getCellAtRowCol(row,col,worksheet){let destRange=null;return worksheet.getMatrixWithMergedCells(row,col,row,col).forValue(((row,col,value)=>(destRange={actualRow:row,actualColumn:col,startRow:row,startColumn:col,isMerged:void 0!==value.rowSpan||void 0!==value.colSpan,isMergedMainCell:void 0!==value.rowSpan&&void 0!==value.colSpan,endRow:row+(void 0!==value.rowSpan?value.rowSpan-1:0),endColumn:col+(void 0!==value.colSpan?value.colSpan-1:0),rangeType:src.$uV.NORMAL},!1))),destRange||{actualColumn:col,actualRow:row,startRow:row,startColumn:col,endRow:row,endColumn:col,isMerged:!1,isMergedMainCell:!1,rangeType:src.$uV.NORMAL}}function setEndForRange(range,rowCount,columnCount){const{startRow,startColumn,endRow,endColumn}=range;return Number.isNaN(startRow)&&(range.startRow=0),Number.isNaN(endRow)&&(range.endRow=rowCount-1),Number.isNaN(startColumn)&&(range.startColumn=0),Number.isNaN(endColumn)&&(range.endColumn=columnCount-1),range}function getPrimaryForRange(range,worksheet){const startRow=Number.isNaN(range.startRow)?0:range.startRow,startColumn=Number.isNaN(range.startColumn)?0:range.startColumn,mergedRange=worksheet.getMergedCell(startRow,startColumn);return mergedRange?{...mergedRange,actualRow:startRow,actualColumn:startColumn,rangeType:src.$uV.NORMAL,isMerged:!0,isMergedMainCell:!0}:{startRow,startColumn,endRow:range.startRow,endColumn:range.startColumn,actualRow:startRow,actualColumn:startColumn,rangeType:src.$uV.NORMAL,isMerged:!1,isMergedMainCell:!1}}const followSelectionOperation=(range,workbook,worksheet)=>({id:SetSelectionsOperation.id,params:{unitId:workbook.getUnitId(),subUnitId:worksheet.getSheetId(),reveal:!0,selections:[{range,primary:getPrimaryForRange(range,worksheet)}]}});function isSingleCellSelection(selection){if(!selection)return!1;const{range,primary}=selection;return src.M_G.equals(range,primary)}const ignoreRangeThemeInterceptorFilter=interceptor=>"sheet.interceptor.range-theme-id"!==interceptor.id;function copyRangeStyles(worksheet,startRow,endRow,startColumn,endColumn,isRow,sourceRangeIndex){const cellValue={};for(let row=startRow;row<=endRow;row++)for(let column=startColumn;column<=endColumn;column++){const cell=isRow?worksheet.getCellWithFilteredInterceptors(sourceRangeIndex,column,"sheet.interceptor.ignore-range-theme",ignoreRangeThemeInterceptorFilter):worksheet.getCellWithFilteredInterceptors(row,sourceRangeIndex,"sheet.interceptor.ignore-range-theme",ignoreRangeThemeInterceptorFilter);cell&&cell.s&&(cellValue[row]||(cellValue[row]={}),cellValue[row][column]={s:cell.s})}return cellValue}var map=__webpack_require__("../../node_modules/.pnpm/rxjs@7.8.1/node_modules/rxjs/dist/esm5/internal/operators/map.js");function ref_selections_service_ts_metadata(k,v){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(k,v)}const IRefSelectionsService=(0,src.Qmd)("sheets-formula.ref-selections.service");class RefSelectionsService extends selection_service_SheetsSelectionsService{constructor(_instanceSrv){super(_instanceSrv)}_init(){const $=this._getAliveWorkbooks$().pipe((0,takeUntil.Q)(this.dispose$));this.selectionMoveStart$=$.pipe((0,switchMap.n)((ss=>(0,merge.h)(...ss.map((s=>s.selectionMoveStart$)))))),this.selectionMoving$=$.pipe((0,switchMap.n)((ss=>(0,merge.h)(...ss.map((s=>s.selectionMoving$)))))),this.selectionMoveEnd$=$.pipe((0,switchMap.n)((ss=>(0,merge.h)(...ss.map((s=>s.selectionMoveEnd$)))))),this.selectionSet$=$.pipe((0,switchMap.n)((ss=>(0,merge.h)(...ss.map((s=>s.selectionSet$))))))}_getAliveWorkbooks$(){const aliveWorkbooks=this._instanceSrv.getAllUnitsForType(src.Zy$.UNIVER_SHEET);aliveWorkbooks.forEach((workbook=>this._ensureWorkbookSelection(workbook.getUnitId())));const workbooks$=new BehaviorSubject.t(aliveWorkbooks);return this.disposeWithMe(this._instanceSrv.getTypeOfUnitAdded$(src.Zy$.UNIVER_SHEET).subscribe((workbook=>{this._ensureWorkbookSelection(workbook.getUnitId()),workbooks$.next([...workbooks$.getValue(),workbook])}))),this.disposeWithMe(this._instanceSrv.getTypeOfUnitDisposed$(src.Zy$.UNIVER_SHEET).subscribe((workbook=>{this._removeWorkbookSelection(workbook.getUnitId()),workbooks$.next(workbooks$.getValue().filter((unit=>unit!==workbook)))}))),workbooks$.pipe((0,map.T)((workbooks=>workbooks.map((w=>this._ensureWorkbookSelection(w.getUnitId()))))))}}function getSelectionsService(accessor,fromCurrentSelection){const isInRefSelectionMode=accessor.get(src.oaf).getContextValue(REF_SELECTIONS_ENABLED);return accessor.get(isInRefSelectionMode&&!fromCurrentSelection?IRefSelectionsService:selection_service_SheetsSelectionsService)}RefSelectionsService=function ref_selections_service_ts_decorate(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r}([function ref_selections_service_ts_param(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}}(0,src.HCr),ref_selections_service_ts_metadata("design:type",Function),ref_selections_service_ts_metadata("design:paramtypes",[void 0===src.HCr?Object:src.HCr])],RefSelectionsService);const SetSelectionsOperation={id:"sheet.operation.set-selections",type:src.g4t.OPERATION,handler:(accessor,params)=>{if(!params)return!1;const{selections,type,unitId,subUnitId}=params;return getSelectionsService(accessor).setSelections(unitId,subUnitId,[...selections],type),!0}},SelectRangeCommand={id:"sheet.command.select-range",type:src.g4t.COMMAND,handler:(accessor,params)=>{if(!params)return!1;const{unitId,subUnit,range}=params,commandService=accessor.get(src.wTY),target=target_util_getSheetCommandTarget(accessor.get(src.HCr),params);if(!target)return!1;const selections=[{range,primary:getPrimaryForRange(range,target.worksheet),style:null}];return commandService.syncExecuteCommand(SetSelectionsOperation.id,{unitId,subUnitId:subUnit,selections})}},MoveRangeCommand={type:src.g4t.COMMAND,id:"sheet.command.move-range",handler:async(accessor,params)=>{const commandService=accessor.get(src.wTY),undoRedoService=accessor.get(src.$Dz),univerInstanceService=accessor.get(src.HCr),errorService=accessor.get(src.IvX),localeService=accessor.get(src.iH9),sheetInterceptorService=accessor.get(SheetInterceptorService),target=target_util_getSheetCommandTarget(univerInstanceService);if(!target)return!1;if(!await sheetInterceptorService.beforeCommandExecute({id:MoveRangeCommand.id,params}))return!1;const{worksheet,subUnitId,unitId}=target,moveRangeMutations=getMoveRangeUndoRedoMutations(accessor,{unitId,subUnitId,range:params.fromRange},{unitId,subUnitId,range:params.toRange});if(null===moveRangeMutations)return errorService.emit(localeService.t("sheets.info.acrossMergedCell")),!1;const interceptorCommands=sheetInterceptorService.onCommandExecute({id:MoveRangeCommand.id,params:{...params}}),redos=[...interceptorCommands.preRedos??[],...moveRangeMutations.redos,...interceptorCommands.redos,{id:SetSelectionsOperation.id,params:{unitId,subUnitId,selections:[{range:params.toRange,primary:getPrimaryAfterMove(params.fromRange,params.toRange,worksheet)}],type:SelectionMoveType.MOVE_END}}],undos=[...interceptorCommands.preUndos??[],...moveRangeMutations.undos,...interceptorCommands.undos,{id:SetSelectionsOperation.id,params:{unitId,subUnitId,selections:[{range:params.fromRange,primary:getPrimaryForRange(params.fromRange,worksheet)}],type:SelectionMoveType.MOVE_END}}],result=(0,src.PkI)(redos,commandService).result,afterInterceptors=sheetInterceptorService.afterCommandExecute({id:MoveRangeCommand.id,params:{...params}});return!!result&&((0,src.PkI)(afterInterceptors.redos,commandService),undoRedoService.pushUndoRedo({unitID:unitId,undoMutations:[...undos,...afterInterceptors.undos],redoMutations:[...redos,...afterInterceptors.redos]}),!0)}};function getMoveRangeUndoRedoMutations(accessor,from,to,ignoreMerge=!1){const redos=[],undos=[],{range:fromRange,subUnitId:fromSubUnitId,unitId}=from,{range:toRange,subUnitId:toSubUnitId}=to,workbook=accessor.get(src.HCr).getUniverSheetInstance(unitId),toWorksheet=workbook?.getSheetBySheetId(toSubUnitId),fromWorksheet=workbook?.getSheetBySheetId(fromSubUnitId),toCellMatrix=toWorksheet?.getCellMatrix(),fromCellMatrix=fromWorksheet?.getCellMatrix();if(toWorksheet&&fromWorksheet&&toCellMatrix&&fromCellMatrix){const alignedRangeWithToRange=alignToMergedCellsBorders(toRange,toWorksheet,!1);if(!src.M_G.equals(toRange,alignedRangeWithToRange)&&!ignoreMerge)return null;const fromCellValue=new src.hDc,newFromCellValue=new src.hDc,fromCellStyle=new src.hDc;src.Q6t.foreach(fromRange,((row,col)=>{const cellData=fromCellMatrix.getValue(row,col);if(fromCellValue.setValue(row,col,src.S0q.deepClone(cellData)),cellData){const style=workbook?.getStyles().get(cellData.s);fromCellStyle.setValue(row,col,src.S0q.deepClone(style))}newFromCellValue.setValue(row,col,null)}));const toCellValue=new src.hDc,newToCellValue=new src.hDc;src.Q6t.foreach(toRange,((row,col)=>{toCellValue.setValue(row,col,src.S0q.deepClone(toCellMatrix.getValue(row,col)))})),src.Q6t.foreach(fromRange,((row,col)=>{const cellRange=(0,src.PJ)(row,col),relativeRange=src.M_G.getRelativeRange(cellRange,fromRange),range=src.M_G.getPositionRange(relativeRange,toRange),styleValue=src.S0q.deepClone(fromCellStyle.getValue(row,col)),cellValue=src.S0q.deepClone(fromCellValue.getValue(row,col));cellValue&&styleValue&&(cellValue.s=styleValue),newToCellValue.setValue(range.startRow,range.startColumn,cellValue)}));const doMoveRangeMutation={fromRange:from.range,toRange:to.range,from:{value:newFromCellValue.getMatrix(),subUnitId:fromSubUnitId},to:{value:newToCellValue.getMatrix(),subUnitId:toSubUnitId},unitId},undoMoveRangeMutation={fromRange:to.range,toRange:from.range,from:{value:fromCellValue.getMatrix(),subUnitId:fromSubUnitId},to:{value:toCellValue.getMatrix(),subUnitId:toSubUnitId},unitId};redos.push({id:MoveRangeMutation.id,params:doMoveRangeMutation}),undos.push({id:MoveRangeMutation.id,params:undoMoveRangeMutation})}return{redos,undos}}function getPrimaryAfterMove(fromRange,toRange,worksheet){const startRow=fromRange.startRow,startColumn=fromRange.startColumn,mergeInfo=worksheet.getMergedCell(startRow,startColumn),res=getPrimaryForRange(toRange,worksheet);if(mergeInfo){const mergeRowCount=mergeInfo.endRow-mergeInfo.startRow+1,mergeColCount=mergeInfo.endColumn-mergeInfo.startColumn+1;res.endRow=res.startRow+mergeRowCount-1,res.endColumn=res.startColumn+mergeColCount-1,res.actualRow=res.startRow,res.actualColumn=res.startColumn,res.isMerged=!1,res.isMergedMainCell=!0}return res}var es=__webpack_require__("../../node_modules/.pnpm/@univerjs+protocol@0.1.44_@grpc+grpc-js@1.10.9_rxjs@7.8.1/node_modules/@univerjs/protocol/lib/es/index.js");class edit_RangeProtectionPermissionEditPoint{constructor(unitId,subUnitId,permissionId){this.type=es._m.SelectRange,this.subType=es.pS.Edit,this.status=src.W2c.INIT,this.value=!0,this.unitId=unitId,this.subUnitId=subUnitId,this.permissionId=permissionId,this.id=`${es._m.SelectRange}.${es.pS.Edit}.${permissionId}`}}class RangeProtectionPermissionViewPoint{constructor(unitId,subUnitId,permissionId){this.type=es._m.SelectRange,this.subType=es.pS.View,this.status=src.W2c.INIT,this.value=!0,this.unitId=unitId,this.subUnitId=subUnitId,this.permissionId=permissionId,this.id=`${es._m.SelectRange}.${es.pS.View}.${permissionId}`}}class WorkbookCommentPermission{constructor(unitId){this.unitId=unitId,this.value=!0,this.type=es._m.Workbook,this.status=src.W2c.INIT,this.subType=es.pS.Comment,this.unitId=unitId,this.id=`${this.type}.${es.pS.Comment}_${unitId}`}}class WorkbookCopyPermission{constructor(unitId){this.unitId=unitId,this.value=!0,this.type=es._m.Workbook,this.status=src.W2c.INIT,this.subType=es.pS.Copy,this.unitId=unitId,this.id=`${this.type}.${es.pS.Copy}_${unitId}`}}class WorkbookCopySheetPermission{constructor(unitId){this.unitId=unitId,this.value=!0,this.type=es._m.Workbook,this.subType=es.pS.CopySheet,this.status=src.W2c.INIT,this.unitId=unitId,this.id=`${this.type}.${es.pS.CopySheet}_${unitId}`}}class WorkbookCreateProtectPermission{constructor(unitId){this.unitId=unitId,this.value=!0,this.type=es._m.Workbook,this.status=src.W2c.INIT,this.subType=es.pS.CreatePermissionObject,this.unitId=unitId,this.id=`${this.type}.${es.pS.CreatePermissionObject}_${unitId}`}}class WorkbookCreateSheetPermission{constructor(unitId){this.unitId=unitId,this.value=!0,this.type=es._m.Workbook,this.status=src.W2c.INIT,this.subType=es.pS.CreateSheet,this.unitId=unitId,this.id=`${this.type}.${es.pS.CreateSheet}_${unitId}`}}class WorkbookDeleteSheetPermission{constructor(unitId){this.unitId=unitId,this.value=!0,this.type=es._m.Workbook,this.status=src.W2c.INIT,this.subType=es.pS.DeleteSheet,this.unitId=unitId,this.id=`${this.type}.${es.pS.DeleteSheet}_${unitId}`}}class WorkbookDuplicatePermission{constructor(unitId){this.unitId=unitId,this.value=!0,this.type=es._m.Workbook,this.status=src.W2c.INIT,this.subType=es.pS.Duplicate,this.unitId=unitId,this.id=`${this.type}.${es.pS.Duplicate}_${unitId}`}}class editable_WorkbookEditablePermission{constructor(unitId){this.unitId=unitId,this.value=!0,this.type=es._m.Workbook,this.status=src.W2c.INIT,this.subType=es.pS.Edit,this.unitId=unitId,this.id=`${this.type}.${es.pS.Edit}_${unitId}`}}class WorkbookExportPermission{constructor(unitId){this.unitId=unitId,this.value=!0,this.type=es._m.Workbook,this.status=src.W2c.INIT,this.subType=es.pS.Export,this.unitId=unitId,this.id=`${this.type}.${es.pS.Export}_${unitId}`}}class WorkbookHideSheetPermission{constructor(unitId){this.unitId=unitId,this.value=!0,this.type=es._m.Workbook,this.status=src.W2c.INIT,this.subType=es.pS.HideSheet,this.unitId=unitId,this.id=`${this.type}.${es.pS.HideSheet}_${unitId}`}}class WorkbookManageCollaboratorPermission{constructor(unitId){this.unitId=unitId,this.value=!0,this.type=es._m.Workbook,this.status=src.W2c.INIT,this.subType=es.pS.ManageCollaborator,this.unitId=unitId,this.id=`${this.type}.${es.pS.ManageCollaborator}_${unitId}`}}class WorkbookMoveSheetPermission{constructor(unitId){this.unitId=unitId,this.value=!0,this.type=es._m.Workbook,this.status=src.W2c.INIT,this.subType=es.pS.MoveSheet,this.unitId=unitId,this.id=`${this.type}.${es.pS.MoveSheet}_${unitId}`}}class WorkbookPrintPermission{constructor(unitId){this.unitId=unitId,this.value=!0,this.type=es._m.Workbook,this.status=src.W2c.INIT,this.subType=es.pS.Print,this.unitId=unitId,this.id=`${this.type}.${es.pS.Print}_${unitId}`}}class WorkbookRecoverHistoryPermission{constructor(unitId){this.unitId=unitId,this.value=!0,this.type=es._m.Workbook,this.status=src.W2c.INIT,this.subType=es.pS.RecoverHistory,this.unitId=unitId,this.id=`${this.type}.${es.pS.RecoverHistory}_${unitId}`}}class WorkbookRenameSheetPermission{constructor(unitId){this.unitId=unitId,this.value=!0,this.type=es._m.Workbook,this.status=src.W2c.INIT,this.subType=es.pS.RenameSheet,this.unitId=unitId,this.id=`${this.type}.${es.pS.RenameSheet}_${unitId}`}}class WorkbookSharePermission{constructor(unitId){this.unitId=unitId,this.value=!0,this.type=es._m.Workbook,this.status=src.W2c.INIT,this.subType=es.pS.Share,this.unitId=unitId,this.id=`${this.type}.${es.pS.Share}_${unitId}`}}class WorkbookViewPermission{constructor(unitId){this.unitId=unitId,this.value=!0,this.type=es._m.Workbook,this.status=src.W2c.INIT,this.subType=es.pS.View,this.unitId=unitId,this.id=`${this.type}.${es.pS.View}_${unitId}`}}class WorkbookViewHistoryPermission{constructor(unitId){this.unitId=unitId,this.value=!0,this.type=es._m.Workbook,this.status=src.W2c.INIT,this.subType=es.pS.ViewHistory,this.unitId=unitId,this.id=`${this.type}.${es.pS.ViewHistory}_${unitId}`}}class WorksheetCopyPermission{constructor(unitId,subUnitId){this.unitId=unitId,this.subUnitId=subUnitId,this.value=!0,this.type=es._m.Worksheet,this.status=src.W2c.INIT,this.subType=es.pS.Copy,this.id=`${this.type}.${es.pS.Copy}_${unitId}_${subUnitId}`}}class WorksheetDeleteColumnPermission{constructor(unitId,subUnitId){this.unitId=unitId,this.subUnitId=subUnitId,this.value=!0,this.type=es._m.Worksheet,this.status=src.W2c.INIT,this.subType=es.pS.DeleteColumn,this.id=`${this.type}.${es.pS.DeleteColumn}_${unitId}_${subUnitId}`}}class WorksheetDeleteProtectionPermission{constructor(unitId,subUnitId){this.unitId=unitId,this.subUnitId=subUnitId,this.value=!0,this.type=es._m.Worksheet,this.status=src.W2c.INIT,this.subType=es.pS.Delete,this.id=`${this.type}.${es.pS.Delete}_${unitId}_${subUnitId}`}}class WorksheetDeleteRowPermission{constructor(unitId,subUnitId){this.unitId=unitId,this.subUnitId=subUnitId,this.value=!0,this.type=es._m.Worksheet,this.status=src.W2c.INIT,this.subType=es.pS.DeleteRow,this.id=`${this.type}.${es.pS.DeleteRow}_${unitId}_${subUnitId}`}}class edit_WorksheetEditPermission{constructor(unitId,subUnitId){this.unitId=unitId,this.subUnitId=subUnitId,this.value=!0,this.type=es._m.Worksheet,this.status=src.W2c.INIT,this.subType=es.pS.Edit,this.id=`${this.type}.${es.pS.Edit}_${unitId}_${subUnitId}`}}class WorksheetEditExtraObjectPermission{constructor(unitId,subUnitId){this.unitId=unitId,this.subUnitId=subUnitId,this.value=!0,this.type=es._m.Worksheet,this.status=src.W2c.INIT,this.subType=es.pS.EditExtraObject,this.id=`${this.type}.${es.pS.EditExtraObject}_${unitId}_${subUnitId}`}}class WorksheetFilterPermission{constructor(unitId,subUnitId){this.unitId=unitId,this.subUnitId=subUnitId,this.value=!0,this.type=es._m.Worksheet,this.status=src.W2c.INIT,this.subType=es.pS.Filter,this.id=`${this.type}.${es.pS.Filter}_${unitId}_${subUnitId}`}}class WorksheetInsertColumnPermission{constructor(unitId,subUnitId){this.unitId=unitId,this.subUnitId=subUnitId,this.value=!0,this.type=es._m.Worksheet,this.status=src.W2c.INIT,this.subType=es.pS.InsertColumn,this.id=`${this.type}.${es.pS.InsertColumn}_${unitId}_${subUnitId}`}}class WorksheetInsertHyperlinkPermission{constructor(unitId,subUnitId){this.unitId=unitId,this.subUnitId=subUnitId,this.value=!0,this.type=es._m.Worksheet,this.status=src.W2c.INIT,this.subType=es.pS.InsertHyperlink,this.id=`${this.type}.${es.pS.InsertHyperlink}_${unitId}_${subUnitId}`}}class WorksheetInsertRowPermission{constructor(unitId,subUnitId){this.unitId=unitId,this.subUnitId=subUnitId,this.value=!0,this.type=es._m.Worksheet,this.status=src.W2c.INIT,this.subType=es.pS.InsertRow,this.id=`${this.type}.${es.pS.InsertRow}_${unitId}_${subUnitId}`}}class WorksheetManageCollaboratorPermission{constructor(unitId,subUnitId){this.unitId=unitId,this.subUnitId=subUnitId,this.value=!0,this.type=es._m.Worksheet,this.status=src.W2c.INIT,this.subType=es.pS.ManageCollaborator,this.id=`${this.type}.${es.pS.ManageCollaborator}_${unitId}_${subUnitId}`}}class WorksheetPivotTablePermission{constructor(unitId,subUnitId){this.unitId=unitId,this.subUnitId=subUnitId,this.value=!0,this.type=es._m.Worksheet,this.status=src.W2c.INIT,this.subType=es.pS.PivotTable,this.id=`${this.type}.${es.pS.PivotTable}_${unitId}_${subUnitId}`}}class WorksheetSetCellStylePermission{constructor(unitId,subUnitId){this.unitId=unitId,this.subUnitId=subUnitId,this.value=!0,this.type=es._m.Worksheet,this.status=src.W2c.INIT,this.subType=es.pS.SetCellStyle,this.id=`${this.type}.${es.pS.SetCellStyle}_${unitId}_${subUnitId}`}}class WorksheetSetCellValuePermission{constructor(unitId,subUnitId){this.unitId=unitId,this.subUnitId=subUnitId,this.value=!0,this.type=es._m.Worksheet,this.status=src.W2c.INIT,this.subType=es.pS.SetCellValue,this.id=`${this.type}.${es.pS.SetCellValue}_${unitId}_${subUnitId}`}}class WorksheetSetColumnStylePermission{constructor(unitId,subUnitId){this.unitId=unitId,this.subUnitId=subUnitId,this.value=!0,this.type=es._m.Worksheet,this.status=src.W2c.INIT,this.subType=es.pS.SetColumnStyle,this.id=`${this.type}.${es.pS.SetColumnStyle}_${unitId}_${subUnitId}`}}class WorksheetSetRowStylePermission{constructor(unitId,subUnitId){this.unitId=unitId,this.subUnitId=subUnitId,this.value=!0,this.type=es._m.Worksheet,this.status=src.W2c.INIT,this.subType=es.pS.SetRowStyle,this.id=`${this.type}.${es.pS.SetRowStyle}_${unitId}_${subUnitId}`}}class WorksheetSortPermission{constructor(unitId,subUnitId){this.unitId=unitId,this.subUnitId=subUnitId,this.value=!0,this.type=es._m.Worksheet,this.status=src.W2c.INIT,this.subType=es.pS.Sort,this.id=`${this.type}.${es.pS.Sort}_${unitId}_${subUnitId}`}}class WorksheetViewPermission{constructor(unitId,subUnitId){this.unitId=unitId,this.subUnitId=subUnitId,this.value=!0,this.type=es._m.Worksheet,this.status=src.W2c.INIT,this.subType=es.pS.View,this.id=`${this.type}.${es.pS.View}_${unitId}_${subUnitId}`}}const SetRangeValuesCommand={id:"sheet.command.set-range-values",type:src.g4t.COMMAND,handler:(accessor,params)=>{const commandService=accessor.get(src.wTY),undoRedoService=accessor.get(src.$Dz),univerInstanceService=accessor.get(src.HCr),selectionManagerService=accessor.get(selection_service_SheetsSelectionsService),sheetInterceptorService=accessor.get(SheetInterceptorService),permissionService=accessor.get(src.QWp),target=target_util_getSheetCommandTarget(univerInstanceService,params);if(!target)return!1;const{subUnitId,unitId,workbook,worksheet}=target,{value,range,redoUndoId}=params,currentSelections=range?[range]:selectionManagerService.getCurrentSelections()?.map((s=>s.range));if(!currentSelections||!currentSelections.length)return!1;if(!permissionService.getPermissionPoint(new edit_WorksheetEditPermission(unitId,subUnitId).id))return!1;const cellValue=new src.hDc;let realCellValue;if(src.S0q.isArray(value))for(let i=0;i<currentSelections.length;i++){const{startRow,startColumn,endRow,endColumn}=currentSelections[i];for(let r=0;r<=endRow-startRow;r++)for(let c=0;c<=endColumn-startColumn;c++)cellValue.setValue(r+startRow,c+startColumn,value[r][c])}else if((0,src.SoT)(value))for(let i=0;i<currentSelections.length;i++){const{startRow,startColumn,endRow,endColumn}=currentSelections[i];for(let r=startRow;r<=endRow;r++)for(let c=startColumn;c<=endColumn;c++)cellValue.setValue(r,c,value)}else realCellValue=value;const setRangeValuesMutationParams={subUnitId,unitId,cellValue:realCellValue??cellValue.getMatrix()},redoParams=SetRangeValuesUndoMutationFactory(accessor,setRangeValuesMutationParams);if(!commandService.syncExecuteCommand(SetRangeValuesMutation.id,setRangeValuesMutationParams))return!1;const{undos,redos}=sheetInterceptorService.onCommandExecute({id:SetRangeValuesCommand.id,params:{...setRangeValuesMutationParams,range:currentSelections}});if((0,src.PkI)([...redos],commandService).result){const selectionOperation=followSelectionOperation(range??cellValue.getRange(),workbook,worksheet);return undoRedoService.pushUndoRedo({unitID:unitId,undoMutations:[{id:SetRangeValuesMutation.id,params:redoParams},...undos,selectionOperation],redoMutations:[{id:SetRangeValuesMutation.id,params:setRangeValuesMutationParams},...redos,src.S0q.deepClone(selectionOperation)],id:redoUndoId}),!0}return!1}};function getInsertRangeMutations(accessor,params){const redo=[],undo=[],{unitId,subUnitId,range,shiftDimension,cellValue={}}=params,instanceService=accessor.get(src.HCr),sheetInterceptorService=accessor.get(SheetInterceptorService),workbook=instanceService.getUniverSheetInstance(unitId),worksheet=workbook?.getSheetBySheetId(subUnitId);if(worksheet){const cellMatrix=worksheet.getCellMatrix(),dataRange=cellMatrix.getDataRange();if(range.startColumn<=dataRange.endColumn||range.startRow<=dataRange.endRow){let moveFromRange,moveToRange;if(shiftDimension===src.fgB.COLUMNS){const endRow=Math.min(range.endRow,dataRange.endRow);let endColumn=0;for(let row=range.startRow;row<=endRow;row++){const rowData=cellMatrix.getRow(row),rowLength=rowData?(0,src.aeI)(rowData)-1:0;endColumn=Math.max(endColumn,rowLength)}moveFromRange={startRow:range.startRow,startColumn:range.startColumn,endRow,endColumn};const shift=range.endColumn-range.startColumn+1;moveToRange={startRow:range.startRow,startColumn:moveFromRange.startColumn+shift,endRow,endColumn:moveFromRange.endColumn+shift}}else{const endColumn=Math.min(range.endColumn,dataRange.endColumn),endRow=dataRange.endRow;moveFromRange={startRow:range.startRow,startColumn:range.startColumn,endRow,endColumn};const shift=range.endRow-range.startRow+1;moveToRange={startRow:moveFromRange.startRow+shift,startColumn:range.startColumn,endRow:moveFromRange.endRow+shift,endColumn}}const moveRangeMutations=getMoveRangeUndoRedoMutations(accessor,{unitId,subUnitId,range:moveFromRange},{unitId,subUnitId,range:moveToRange},!0);moveRangeMutations&&(redo.push(...moveRangeMutations.redos),undo.push(...moveRangeMutations.undos))}if(0===Object.entries(cellValue).length)for(let row=range.startRow;row<=range.endRow;row++){cellValue[row]||(cellValue[row]={});for(let column=range.startColumn;column<=range.endColumn;column++)cellValue[row][column]=null}const setRangeValuesMutationParams={subUnitId,unitId,cellValue},undoSetRangeValuesMutationParams=SetRangeValuesUndoMutationFactory(accessor,setRangeValuesMutationParams),{undos:interceptorUndos,redos:interceptorRedos}=sheetInterceptorService.onCommandExecute({id:SetRangeValuesCommand.id,params:{...setRangeValuesMutationParams,range}});redo.push({id:SetRangeValuesMutation.id,params:setRangeValuesMutationParams},...interceptorRedos),undo.push({id:SetRangeValuesMutation.id,params:undoSetRangeValuesMutationParams},...interceptorUndos)}return{redo,undo}}function getRemoveRangeMutations(accessor,params){const redo=[],undo=[],{unitId,subUnitId,range,shiftDimension}=params,instanceService=accessor.get(src.HCr),sheetInterceptorService=accessor.get(SheetInterceptorService),workbook=instanceService.getUniverSheetInstance(unitId),worksheet=workbook?.getSheetBySheetId(subUnitId);if(worksheet){const cellMatrix=worksheet.getCellMatrix(),dataRange=cellMatrix.getDataRange(),setRangeValuesMutationParams={subUnitId,unitId,cellValue:generateNullCell([range])},undoSetRangeValuesMutationParams=SetRangeValuesUndoMutationFactory(accessor,setRangeValuesMutationParams),intercepted=sheetInterceptorService.onCommandExecute({id:SetRangeValuesCommand.id,params:setRangeValuesMutationParams});if(redo.push({id:SetRangeValuesMutation.id,params:setRangeValuesMutationParams},...intercepted.redos),undo.push(...intercepted.undos,{id:SetRangeValuesMutation.id,params:undoSetRangeValuesMutationParams}),range.startColumn<=dataRange.endColumn||range.startRow<=dataRange.endRow){let moveFromRange=null,moveToRange=null;if(shiftDimension===src.fgB.COLUMNS&&range.endColumn<dataRange.endColumn){const endRow=Math.min(range.endRow,dataRange.endRow);let endColumn=0;for(let row=range.startRow;row<=endRow;row++){const rowData=cellMatrix.getRow(row),rowLength=rowData?(0,src.aeI)(rowData)-1:0;endColumn=Math.max(endColumn,rowLength)}moveFromRange={startRow:range.startRow,startColumn:range.endColumn+1,endRow,endColumn};const shift=range.endColumn-range.startColumn+1;moveToRange={startRow:range.startRow,startColumn:moveFromRange.startColumn-shift,endRow,endColumn:moveFromRange.endColumn-shift}}if(shiftDimension===src.fgB.ROWS&&range.endRow<dataRange.endRow){const endColumn=Math.min(range.endColumn,dataRange.endColumn),endRow=dataRange.endRow;moveFromRange={startRow:range.endRow+1,startColumn:range.startColumn,endRow,endColumn};const shift=range.endRow-range.startRow+1;moveToRange={startRow:moveFromRange.startRow-shift,startColumn:range.startColumn,endRow:moveFromRange.endRow-shift,endColumn}}if(moveFromRange&&moveToRange){const moveRangeMutations=getMoveRangeUndoRedoMutations(accessor,{unitId,subUnitId,range:moveFromRange},{unitId,subUnitId,range:moveToRange},!0);moveRangeMutations&&(redo.push(...moveRangeMutations.redos),undo.push(...moveRangeMutations.undos))}}}return{redo,undo}}const delete_range_move_left_command_DeleteRangeMoveLeftCommand={type:src.g4t.COMMAND,id:"sheet.command.delete-range-move-left",handler:async(accessor,params)=>{const commandService=accessor.get(src.wTY),undoRedoService=accessor.get(src.$Dz),univerInstanceService=accessor.get(src.HCr),selectionManagerService=accessor.get(selection_service_SheetsSelectionsService),sheetInterceptorService=accessor.get(SheetInterceptorService),target=target_util_getSheetCommandTarget(univerInstanceService);if(!target)return!1;const{worksheet,workbook,subUnitId,unitId}=target;let range=params?.range;if(range||(range=selectionManagerService.getCurrentLastSelection()?.range),!range)return!1;const deleteRangeMutationParams={range,subUnitId,unitId,shiftDimension:src.fgB.COLUMNS},sheetInterceptor=sheetInterceptorService.onCommandExecute({id:delete_range_move_left_command_DeleteRangeMoveLeftCommand.id,params:{range}}),{redo:removeRangeRedo,undo:removeRangeUndo}=getRemoveRangeMutations(accessor,deleteRangeMutationParams),redos=[...sheetInterceptor.preRedos??[],...removeRangeRedo],undos=[...sheetInterceptor.undos,...removeRangeUndo];redos.push(...sheetInterceptor.redos),redos.push(followSelectionOperation(range,workbook,worksheet)),undos.push(...sheetInterceptor.preUndos??[]);return!!(0,src.PkI)(redos,commandService).result&&(undoRedoService.pushUndoRedo({unitID:unitId,undoMutations:undos.reverse(),redoMutations:redos}),!0)}},delete_range_move_up_command_DeleteRangeMoveUpCommand={type:src.g4t.COMMAND,id:"sheet.command.delete-range-move-up",handler:async(accessor,params)=>{const commandService=accessor.get(src.wTY),undoRedoService=accessor.get(src.$Dz),univerInstanceService=accessor.get(src.HCr),selectionManagerService=accessor.get(selection_service_SheetsSelectionsService),sheetInterceptorService=accessor.get(SheetInterceptorService),target=target_util_getSheetCommandTarget(univerInstanceService);if(!target)return!1;const{unitId,subUnitId,workbook,worksheet}=target;let range=params?.range;if(range||(range=selectionManagerService.getCurrentLastSelection()?.range),!range)return!1;const deleteRangeMutationParams={range,subUnitId,unitId,shiftDimension:src.fgB.ROWS},sheetInterceptor=sheetInterceptorService.onCommandExecute({id:delete_range_move_up_command_DeleteRangeMoveUpCommand.id,params:{range}}),{redo:removeRangeRedo,undo:removeRangeUndo}=getRemoveRangeMutations(accessor,deleteRangeMutationParams),redos=[...sheetInterceptor.preRedos??[],...removeRangeRedo],undos=[...sheetInterceptor.undos,...removeRangeUndo];redos.push(...sheetInterceptor.redos),redos.push(followSelectionOperation(range,workbook,worksheet)),undos.push(...sheetInterceptor.preUndos??[]);return!!(0,src.PkI)(redos,commandService).result&&(undoRedoService.pushUndoRedo({unitID:unitId,undoMutations:undos.reverse(),redoMutations:redos}),!0)}},DeleteRangeProtectionCommand={type:src.g4t.COMMAND,id:"sheet.command.delete-range-protection",async handler(accessor,params){if(!params)return!1;const commandService=accessor.get(src.wTY),undoRedoService=accessor.get(src.$Dz),{unitId,subUnitId,rule}=params,redoMutationParam={unitId,subUnitId,ruleIds:[rule.id]};return await commandService.executeCommand(delete_range_protection_mutation_DeleteRangeProtectionMutation.id,redoMutationParam)&&undoRedoService.pushUndoRedo({unitID:unitId,redoMutations:[{id:delete_range_protection_mutation_DeleteRangeProtectionMutation.id,params:redoMutationParam}],undoMutations:[{id:add_range_protection_mutation_AddRangeProtectionMutation.id,params:{unitId,subUnitId,rules:[rule]}}]}),!0}},DeleteWorksheetProtectionCommand={type:src.g4t.COMMAND,id:"sheet.command.delete-worksheet-protection",handler(accessor,params){if(!params)return!1;const commandService=accessor.get(src.wTY),undoRedoService=accessor.get(src.$Dz),{rule,unitId,subUnitId}=params;commandService.executeCommand(DeleteWorksheetProtectionMutation.id,{unitId,subUnitId});const redoMutations=[{id:DeleteWorksheetProtectionMutation.id,params:{unitId,subUnitId}}],undoMutations=[{id:AddWorksheetProtectionMutation.id,params:{unitId,rule,subUnitId}}];return undoRedoService.pushUndoRedo({unitID:unitId,redoMutations,undoMutations}),!0}},DeleteWorksheetRangeThemeStyleCommand={type:src.g4t.COMMAND,id:"sheet.command.remove-worksheet-range-theme-style",handler:(accessor,params)=>{const commandService=accessor.get(src.wTY),undoRedoService=accessor.get(src.$Dz),{unitId}=params,undoMutationParams=((accessor,params)=>{const target=target_util_getSheetMutationTarget(accessor.get(src.HCr),params);if(!target)throw new Error("[DeleteWorksheetRangeThemeStyleMutationFactory]: worksheet is null error!");const{worksheet}=target;return{unitId:params.unitId,subUnitId:worksheet.getSheetId(),range:params.range,themeName:params.themeName}})(accessor,params);return!!commandService.syncExecuteCommand(DeleteWorksheetRangeThemeStyleMutation.id,params)&&(undoRedoService.pushUndoRedo({unitID:unitId,undoMutations:[{id:SetWorksheetRangeThemeStyleMutation.id,params:undoMutationParams}],redoMutations:[{id:DeleteWorksheetRangeThemeStyleMutation.id,params}]}),!0)}},InsertDefinedNameCommand={id:"sheet.command.insert-defined-name",type:src.g4t.COMMAND,handler:(accessor,params)=>{const commandService=accessor.get(src.wTY),undoRedoService=accessor.get(src.$Dz);if(!params)return!1;const insertSheetMutationParams={...params};return!!commandService.syncExecuteCommand(engine_formula_src.gn.id,insertSheetMutationParams)&&(undoRedoService.pushUndoRedo({unitID:params.unitId,undoMutations:[{id:engine_formula_src.gE.id,params:insertSheetMutationParams}],redoMutations:[{id:engine_formula_src.gn.id,params:insertSheetMutationParams}]}),!0)}},insert_range_move_down_command_InsertRangeMoveDownCommand={type:src.g4t.COMMAND,id:"sheet.command.insert-range-move-down",handler:async(accessor,params)=>{const commandService=accessor.get(src.wTY),undoRedoService=accessor.get(src.$Dz),univerInstanceService=accessor.get(src.HCr),selectionManagerService=accessor.get(selection_service_SheetsSelectionsService),sheetInterceptorService=accessor.get(SheetInterceptorService),errorService=accessor.get(src.IvX),localeService=accessor.get(src.iH9);if(selectionManagerService.isOverlapping())return errorService.emit(localeService.t("sheets.info.overlappingSelections")),!1;const target=target_util_getSheetCommandTarget(univerInstanceService);if(!target)return!1;const{unitId,subUnitId,worksheet,workbook}=target;let range=params?.range;if(range||(range=selectionManagerService.getCurrentLastSelection()?.range),!range)return!1;const redoMutations=[],undoMutations=[],cellMatrix=worksheet.getCellMatrix(),dataRange=cellMatrix.getDataRange(),sliceMaxRow=cellMatrix.getSlice(dataRange.startRow,dataRange.endRow,range.startColumn,range.endColumn).getDataRange().endRow,insertRowCount=Math.max(sliceMaxRow+(range.endRow-range.startRow+1)-dataRange.endRow,0);if(insertRowCount>0){const anchorRow=range.startRow-1,height=worksheet.getRowHeight(anchorRow),insertRowParams={unitId,subUnitId,range:{startRow:dataRange.endRow+1,endRow:dataRange.endRow+insertRowCount,startColumn:dataRange.startColumn,endColumn:dataRange.endColumn},rowInfo:new Array(insertRowCount).fill(void 0).map((()=>({h:height,hd:src.OdA.FALSE})))};redoMutations.push({id:InsertRowMutation.id,params:insertRowParams});const undoRowInsertionParams=InsertRowMutationUndoFactory(accessor,insertRowParams);undoMutations.push({id:RemoveRowMutation.id,params:undoRowInsertionParams})}const cellValue={};src.Q6t.foreach(range,((row,col)=>{const cell=worksheet.getCell(row,col);cell&&(cellValue[row]||(cellValue[row]={}),cellValue[row][col]={s:cell.s})}));const insertRangeMutationParams={range,subUnitId,unitId,shiftDimension:src.fgB.ROWS,cellValue},{redo:insertRangeRedo,undo:insertRangeUndo}=getInsertRangeMutations(accessor,insertRangeMutationParams);redoMutations.push(...insertRangeRedo),undoMutations.push(...insertRangeUndo);const sheetInterceptor=sheetInterceptorService.onCommandExecute({id:insert_range_move_down_command_InsertRangeMoveDownCommand.id,params:{range}});redoMutations.push(...sheetInterceptor.redos),redoMutations.push(followSelectionOperation(range,workbook,worksheet)),undoMutations.push(...sheetInterceptor.preUndos??[]),redoMutations.unshift(...sheetInterceptor.preRedos??[]),undoMutations.unshift(...sheetInterceptor.undos);return!!(0,src.PkI)(redoMutations,commandService)&&(undoRedoService.pushUndoRedo({unitID:unitId,undoMutations:undoMutations.reverse(),redoMutations}),!0)}},InsertRangeMoveRightCommand={type:src.g4t.COMMAND,id:"sheet.command.insert-range-move-right",handler:async(accessor,params)=>{const commandService=accessor.get(src.wTY),undoRedoService=accessor.get(src.$Dz),univerInstanceService=accessor.get(src.HCr),selectionManagerService=accessor.get(selection_service_SheetsSelectionsService),sheetInterceptorService=accessor.get(SheetInterceptorService),errorService=accessor.get(src.IvX),localeService=accessor.get(src.iH9);if(selectionManagerService.isOverlapping())return errorService.emit(localeService.t("sheets.info.overlappingSelections")),!1;const target=target_util_getSheetCommandTarget(univerInstanceService);if(!target)return!1;const{workbook,worksheet,unitId,subUnitId}=target;let range=params?.range;if(range||(range=selectionManagerService.getCurrentLastSelection()?.range),!range)return!1;const redoMutations=[],undoMutations=[],cellMatrix=worksheet.getCellMatrix(),dataRange=cellMatrix.getDataRange(),sliceMaxCol=cellMatrix.getSlice(range.startRow,range.endRow,dataRange.startColumn,dataRange.endColumn).getDataRange().endColumn,insertColCount=Math.max(sliceMaxCol+(range.endColumn-range.startColumn+1)-dataRange.endColumn,0);if(insertColCount>0){const anchorCol=range.startColumn-1,width=worksheet.getColumnWidth(anchorCol),insertColParams={unitId,subUnitId,range:{startRow:dataRange.startRow+1,endRow:dataRange.endRow,startColumn:dataRange.endColumn+1,endColumn:dataRange.endColumn+insertColCount},colInfo:new Array(insertColCount).fill(void 0).map((()=>({w:width,hd:src.OdA.FALSE})))};redoMutations.push({id:InsertColMutation.id,params:insertColParams});const undoColInsertionParams=InsertColMutationUndoFactory(accessor,insertColParams);undoMutations.push({id:RemoveColMutation.id,params:undoColInsertionParams})}const cellValue={};src.Q6t.foreach(range,((row,col)=>{const cell=worksheet.getCell(row,col);cell&&cell.s&&(cellValue[row]||(cellValue[row]={}),cellValue[row][col]={s:cell.s})}));const insertRangeMutationParams={range,subUnitId,unitId,shiftDimension:src.fgB.COLUMNS,cellValue},{redo:insertRangeRedo,undo:insertRangeUndo}=getInsertRangeMutations(accessor,insertRangeMutationParams);redoMutations.push(...insertRangeRedo),undoMutations.push(...insertRangeUndo);const sheetInterceptor=sheetInterceptorService.onCommandExecute({id:InsertRangeMoveRightCommand.id,params:{range}});redoMutations.push(...sheetInterceptor.redos),redoMutations.push(followSelectionOperation(range,workbook,worksheet)),undoMutations.push(...sheetInterceptor.preUndos??[]),redoMutations.unshift(...sheetInterceptor.preRedos??[]),undoMutations.unshift(...sheetInterceptor.undos);return!!(0,src.PkI)(redoMutations,commandService).result&&(undoRedoService.pushUndoRedo({unitID:unitId,undoMutations:undoMutations.reverse(),redoMutations}),!0)}},InsertRowCommand={type:src.g4t.COMMAND,id:"sheet.command.insert-row",handler:async(accessor,params)=>{const commandService=accessor.get(src.wTY),sheetInterceptorService=accessor.get(SheetInterceptorService),{range,direction,unitId,subUnitId,cellValue}=params;return!!await sheetInterceptorService.beforeCommandExecute({id:InsertRowCommand.id,params})&&commandService.syncExecuteCommand(InsertRowByRangeCommand.id,{range,direction,unitId,subUnitId,cellValue})}},InsertRowByRangeCommand={type:src.g4t.COMMAND,id:"sheet.command.insert-row-by-range",handler:(accessor,params)=>{const commandService=accessor.get(src.wTY),undoRedoService=accessor.get(src.$Dz),univerInstanceService=accessor.get(src.HCr),sheetInterceptorService=accessor.get(SheetInterceptorService),target=target_util_getSheetCommandTarget(univerInstanceService,params);if(!target)return!1;const{workbook,worksheet}=target,{range,direction,unitId,subUnitId,cellValue}=params,{startRow,endRow}=range;range.rangeType=src.$uV.ROW;const anchorRow=direction===src.OP3.UP?startRow:startRow-1,height=worksheet.getRowHeight(anchorRow),insertRowParams={unitId,subUnitId,range,rowInfo:new Array(endRow-startRow+1).fill(void 0).map((()=>({h:height,hd:src.OdA.FALSE})))},undoRowInsertionParams=InsertRowMutationUndoFactory(accessor,insertRowParams),redos=[{id:InsertRowMutation.id,params:insertRowParams}],undos=[{id:RemoveRowMutation.id,params:undoRowInsertionParams}];cellValue&&redos.push({id:SetRangeValuesMutation.id,params:{unitId,subUnitId,cellValue}});const intercepted=sheetInterceptorService.onCommandExecute({id:InsertRowCommand.id,params});redos.unshift(...intercepted.preRedos??[]),redos.push(...intercepted.redos??[]),redos.push(followSelectionOperation(range,workbook,worksheet)),undos.unshift(...intercepted.preUndos??[]),undos.push(...intercepted.undos??[]);return!!(0,src.PkI)(redos,commandService).result&&(undoRedoService.pushUndoRedo({unitID:params.unitId,undoMutations:undos,redoMutations:redos}),!0)}},InsertRowBeforeCommand={type:src.g4t.COMMAND,id:"sheet.command.insert-row-before",handler:async accessor=>{const selectionManagerService=accessor.get(selection_service_SheetsSelectionsService),selections=selectionManagerService.getCurrentSelections()?.map((s=>s.range));let range;if(1!==selections?.length)return!1;range=selections[0];const target=target_util_getSheetCommandTarget(accessor.get(src.HCr));if(!target)return!1;const{worksheet,subUnitId,unitId}=target,{startRow,endRow}=range,endColumn=worksheet.getColumnCount()-1,insertRowParams={unitId,subUnitId,direction:src.OP3.UP,range:{startRow,endRow,startColumn:0,endColumn},cellValue:copyRangeStyles(worksheet,startRow,endRow,0,endColumn,!0,startRow-1)};return accessor.get(src.wTY).executeCommand(InsertRowCommand.id,insertRowParams)}},InsertRowAfterCommand={type:src.g4t.COMMAND,id:"sheet.command.insert-row-after",handler:async accessor=>{const selectionManagerService=accessor.get(selection_service_SheetsSelectionsService),selections=selectionManagerService.getCurrentSelections()?.map((s=>s.range));let range;if(1!==selections?.length)return!1;range=selections[0];const target=target_util_getSheetCommandTarget(accessor.get(src.HCr));if(!target)return!1;const{worksheet,unitId,subUnitId}=target,count=range.endRow-range.startRow+1,startRow=range.endRow+1,endRow=range.endRow+count,endColumn=worksheet.getColumnCount()-1,insertRowParams={unitId,subUnitId,direction:src.OP3.DOWN,range:{startRow,endRow,startColumn:0,endColumn,rangeType:src.$uV.ROW},cellValue:copyRangeStyles(worksheet,startRow,endRow,0,endColumn,!0,range.endRow)};return accessor.get(src.wTY).executeCommand(InsertRowCommand.id,insertRowParams)}},InsertMultiRowsAboveCommand={type:src.g4t.COMMAND,id:"sheet.command.insert-multi-rows-above",handler:async(accessor,params)=>{const selectionManagerService=accessor.get(selection_service_SheetsSelectionsService),selections=selectionManagerService.getCurrentSelections()?.map((s=>s.range));let range;if(1!==selections?.length)return!1;range=selections[0];const target=target_util_getSheetCommandTarget(accessor.get(src.HCr));if(!target)return!1;const{worksheet,unitId,subUnitId}=target,count=params.value||0,startRow=range.startRow,endRow=range.startRow+count-1,endColumn=worksheet.getColumnCount()-1,copiedStyle=copyRangeStyles(worksheet,startRow,endRow,0,endColumn,!0,startRow-1),insertRowParams={unitId,subUnitId,direction:src.OP3.UP,range:{startRow,endRow,startColumn:0,endColumn,rangeType:src.$uV.ROW},cellValue:copiedStyle};return accessor.get(src.wTY).executeCommand(InsertRowCommand.id,insertRowParams)}},InsertMultiRowsAfterCommand={type:src.g4t.COMMAND,id:"sheet.command.insert-multi-rows-after",handler:async(accessor,params)=>{const selectionManagerService=accessor.get(selection_service_SheetsSelectionsService),selections=selectionManagerService.getCurrentSelections()?.map((s=>s.range));let range;if(1!==selections?.length)return!1;range=selections[0];const target=target_util_getSheetCommandTarget(accessor.get(src.HCr));if(!target)return!1;const{worksheet,unitId,subUnitId}=target,count=params.value||0,startRow=range.endRow+1,endRow=range.endRow+count,endColumn=worksheet.getColumnCount()-1,insertRowParams={unitId,subUnitId,direction:src.OP3.DOWN,range:{startRow,endRow,startColumn:0,endColumn,rangeType:src.$uV.ROW},cellValue:copyRangeStyles(worksheet,startRow,endRow,0,endColumn,!0,range.endRow)};return accessor.get(src.wTY).executeCommand(InsertRowCommand.id,insertRowParams)}},InsertColCommand={type:src.g4t.COMMAND,id:"sheet.command.insert-col",handler:async(accessor,params)=>{const commandService=accessor.get(src.wTY),sheetInterceptorService=accessor.get(SheetInterceptorService),{range,direction,subUnitId,unitId,cellValue}=params;return!!await sheetInterceptorService.beforeCommandExecute({id:InsertColCommand.id,params})&&commandService.syncExecuteCommand(InsertColByRangeCommand.id,{range,direction,unitId,subUnitId,cellValue})}},InsertColByRangeCommand={type:src.g4t.COMMAND,id:"sheet.command.insert-col-by-range",handler:(accessor,params)=>{const commandService=accessor.get(src.wTY),undoRedoService=accessor.get(src.$Dz),univerInstanceService=accessor.get(src.HCr),sheetInterceptorService=accessor.get(SheetInterceptorService),{range,direction,subUnitId,unitId,cellValue}=params,{startColumn,endColumn}=params.range;range.rangeType=src.$uV.COLUMN;const workbook=univerInstanceService.getUniverSheetInstance(params.unitId),worksheet=workbook.getSheetBySheetId(params.subUnitId),anchorCol=direction===src.OP3.LEFT?startColumn:startColumn-1,width=worksheet.getColumnWidth(anchorCol),insertColParams={unitId,subUnitId,range,colInfo:new Array(endColumn-startColumn+1).fill(void 0).map((()=>({w:width,hd:src.OdA.FALSE})))},undoColInsertionParams=InsertColMutationUndoFactory(accessor,insertColParams),redos=[{id:InsertColMutation.id,params:insertColParams}],undos=[{id:RemoveColMutation.id,params:undoColInsertionParams}];cellValue&&redos.push({id:SetRangeValuesMutation.id,params:{unitId,subUnitId,cellValue}});const intercepted=sheetInterceptorService.onCommandExecute({id:InsertColCommand.id,params});redos.unshift(...intercepted.preRedos??[]),redos.push(...intercepted.redos??[]),redos.push(followSelectionOperation(range,workbook,worksheet)),undos.unshift(...intercepted.preUndos??[]),undos.push(...intercepted.undos??[]);return!!(0,src.PkI)(redos,commandService).result&&(undoRedoService.pushUndoRedo({unitID:params.unitId,undoMutations:undos.filter(Boolean),redoMutations:redos.filter(Boolean)}),!0)}},InsertColBeforeCommand={type:src.g4t.COMMAND,id:"sheet.command.insert-col-before",handler:async accessor=>{const selections=accessor.get(selection_service_SheetsSelectionsService).getCurrentSelections();let range;if(1!==selections?.length)return!1;range=selections[0].range;const target=target_util_getSheetCommandTarget(accessor.get(src.HCr));if(!target)return!1;const{worksheet,unitId,subUnitId}=target,{startColumn,endColumn}=range,endRow=worksheet.getRowCount()-1,insertColParams={unitId,subUnitId,direction:src.OP3.LEFT,range:{startColumn,endColumn,startRow:0,endRow,rangeType:src.$uV.COLUMN},cellValue:copyRangeStyles(worksheet,0,endRow,startColumn,endColumn,!1,startColumn-1)};return accessor.get(src.wTY).executeCommand(InsertColCommand.id,insertColParams)}},InsertColAfterCommand={type:src.g4t.COMMAND,id:"sheet.command.insert-col-after",handler:async accessor=>{const selections=accessor.get(selection_service_SheetsSelectionsService).getCurrentSelections();let range;if(1!==selections?.length)return!1;range=selections[0].range;const target=target_util_getSheetCommandTarget(accessor.get(src.HCr));if(!target)return!1;const{worksheet,unitId,subUnitId}=target,count=range.endColumn-range.startColumn+1,startColumn=range.endColumn+1,endColumn=range.endColumn+count,endRow=worksheet.getRowCount()-1,insertColParams={unitId,subUnitId,direction:src.OP3.RIGHT,range:{startColumn,endColumn,startRow:0,endRow},cellValue:copyRangeStyles(worksheet,0,endRow,startColumn,endColumn,!1,range.endColumn)};return accessor.get(src.wTY).executeCommand(InsertColCommand.id,insertColParams)}},InsertMultiColsLeftCommand={type:src.g4t.COMMAND,id:"sheet.command.insert-multi-cols-before",handler:async(accessor,params)=>{const selections=accessor.get(selection_service_SheetsSelectionsService).getCurrentSelections();let range;if(1!==selections?.length)return!1;range=selections[0].range;const target=target_util_getSheetCommandTarget(accessor.get(src.HCr));if(!target)return!1;const{worksheet,unitId,subUnitId}=target,count=params.value||0,startColumn=range.startColumn,endColumn=range.startColumn+count-1,endRow=worksheet.getRowCount()-1,insertColParams={unitId,subUnitId,direction:src.OP3.LEFT,range:{startColumn,endColumn,startRow:0,endRow,rangeType:src.$uV.COLUMN},cellValue:copyRangeStyles(worksheet,0,endRow,startColumn,endColumn,!1,startColumn-1)};return accessor.get(src.wTY).executeCommand(InsertColCommand.id,insertColParams)}},InsertMultiColsRightCommand={type:src.g4t.COMMAND,id:"sheet.command.insert-multi-cols-right",handler:async(accessor,params)=>{const selections=accessor.get(selection_service_SheetsSelectionsService).getCurrentSelections();let range;if(1!==selections?.length)return!1;range=selections[0].range;const target=target_util_getSheetCommandTarget(accessor.get(src.HCr));if(!target)return!1;const{worksheet,unitId,subUnitId}=target,count=params.value||0,startColumn=range.endColumn+1,endColumn=range.endColumn+count,endRow=worksheet.getRowCount()-1,insertColParams={unitId,subUnitId,direction:src.OP3.RIGHT,range:{startColumn,endColumn,startRow:0,endRow},cellValue:copyRangeStyles(worksheet,0,endRow,startColumn,endColumn,!1,range.endColumn)};return accessor.get(src.wTY).executeCommand(InsertColCommand.id,insertColParams)}},InsertSheetCommand={id:"sheet.command.insert-sheet",type:src.g4t.COMMAND,handler:(accessor,params)=>{const commandService=accessor.get(src.wTY),undoRedoService=accessor.get(src.$Dz),univerInstanceService=accessor.get(src.HCr),localeService=accessor.get(src.iH9),target=function getSheetCommandTargetWorkbook(univerInstanceService,params){const{unitId}=params,workbook=unitId?univerInstanceService.getUniverSheetInstance(unitId):univerInstanceService.getCurrentUnitForType(src.Zy$.UNIVER_SHEET);return workbook?{workbook,unitId:workbook.getUnitId()}:null}(univerInstanceService,{unitId:params?.unitId});if(!target)return!1;const{unitId,workbook}=target;let index=workbook.getSheets().length;const sheet=params?.sheet,sheetId=sheet?.id,sheetConfig=(0,src.qvj)(sheet||{});params?(index=params.index??index,sheetConfig.id=sheetId||src.S0q.generateRandomId(),sheetConfig.name=sheet?.name||workbook.generateNewSheetName(`${localeService.t("sheets.tabs.sheet")}`)):(sheetConfig.id=src.S0q.generateRandomId(),sheetConfig.name=workbook.generateNewSheetName(`${localeService.t("sheets.tabs.sheet")}`));const insertSheetMutationParams={index,sheet:sheetConfig,unitId},removeSheetMutationParams=InsertSheetUndoMutationFactory(0,insertSheetMutationParams);return!!commandService.syncExecuteCommand(InsertSheetMutation.id,insertSheetMutationParams)&&(undoRedoService.pushUndoRedo({unitID:unitId,undoMutations:[{id:RemoveSheetMutation.id,params:removeSheetMutationParams}],redoMutations:[{id:InsertSheetMutation.id,params:insertSheetMutationParams}]}),!0)}};const MoveRowsMutation={id:"sheet.mutation.move-rows",type:src.g4t.MUTATION,handler:(accessor,params)=>{const{unitId,subUnitId,sourceRange,targetRange}=params,univerSheet=accessor.get(src.HCr).getUniverSheetInstance(unitId);if(!univerSheet)throw new Error("[MoveRowMutation] univerSheet is null!");const worksheet=univerSheet.getSheetBySheetId(subUnitId);if(!worksheet)throw new Error("[MoveRowMutation] worksheet is null!");const fromRow=sourceRange.startRow,count=sourceRange.endRow-sourceRange.startRow+1,toRow=targetRange.startRow,rowWrapper=worksheet.getRowManager().getRowData();(0,src.Kbr)(fromRow,count,toRow,rowWrapper);return worksheet.getCellMatrix().moveRows(fromRow,count,toRow),!0}};const MoveColsMutation={id:"sheet.mutation.move-columns",type:src.g4t.MUTATION,handler:(accessor,params)=>{const{unitId,subUnitId,sourceRange,targetRange}=params,univerSheet=accessor.get(src.HCr).getUniverSheetInstance(unitId);if(!univerSheet)throw new Error("[MoveColumnMutation] univerSheet is null!");const worksheet=univerSheet.getSheetBySheetId(subUnitId);if(!worksheet)throw new Error("[MoveColumnMutation] worksheet is null!");const fromCol=sourceRange.startColumn,count=sourceRange.endColumn-sourceRange.startColumn+1,toCol=targetRange.startColumn,columnWrapper=worksheet.getColumnManager().getColumnData();(0,src.Kbr)(fromCol,count,toCol,columnWrapper);return worksheet.getCellMatrix().moveColumns(fromCol,count,toCol),!0}};const MoveRowsCommand={id:"sheet.command.move-rows",type:src.g4t.COMMAND,handler:(accessor,params)=>{const selectionManagerService=accessor.get(selection_service_SheetsSelectionsService),{fromRange:{startRow:fromRow},toRange:{startRow:toRow},range}=params,selections=range?[covertRangeToSelection(range)]:selectionManagerService.getCurrentSelections(),filteredSelections=selections?.filter((selection=>selection.range.rangeType===src.$uV.ROW&&selection.range.startRow<=fromRow&&fromRow<=selection.range.endRow));if(1!==filteredSelections?.length)return!1;const sheetInterceptorService=accessor.get(SheetInterceptorService),target=target_util_getSheetCommandTarget(accessor.get(src.HCr),params);if(!target)return!1;const{workbook,worksheet}=target,unitId=workbook.getUnitId(),subUnitId=worksheet.getSheetId(),errorService=accessor.get(src.IvX),localeService=accessor.get(src.iH9),rangeToMove=filteredSelections[0].range,beforePrimary=filteredSelections[0].primary,alignedRange=alignToMergedCellsBorders(rangeToMove,worksheet,!1);if(!src.M_G.equals(rangeToMove,alignedRange))return errorService.emit(localeService.t("sheets.info.partOfCell")),!1;if(function rowAcrossMergedCell(row,worksheet){return worksheet.getMergeData().some((mergedCell=>mergedCell.startRow<row&&row<=mergedCell.endRow))}(toRow,worksheet))return errorService.emit(localeService.t("sheets.info.acrossMergedCell")),!1;const destinationRange={...rangeToMove,startRow:toRow,endRow:toRow+rangeToMove.endRow-rangeToMove.startRow},moveRowsParams={unitId,subUnitId,sourceRange:rangeToMove,targetRange:destinationRange},undoMoveRowsParams=function MoveRowsMutationUndoFactory(_accessor,params){const{unitId,subUnitId,sourceRange,targetRange}=params,movingBackward=sourceRange.startRow>targetRange.startRow,count=sourceRange.endRow-sourceRange.startRow+1;return movingBackward?{unitId,subUnitId,sourceRange:src.M_G.clone(targetRange),targetRange:{...sourceRange,endRow:sourceRange.endRow+count,startRow:sourceRange.startRow+count}}:{unitId,subUnitId,targetRange:src.M_G.clone(sourceRange),sourceRange:{...targetRange,endRow:targetRange.endRow-count,startRow:targetRange.startRow-count}}}(0,moveRowsParams),commandService=accessor.get(src.wTY),interceptorCommands=sheetInterceptorService.onCommandExecute({id:MoveRowsCommand.id,params}),redos=[...interceptorCommands.preRedos??[],{id:MoveRowsMutation.id,params:moveRowsParams}],undos=[...interceptorCommands.preUndos??[],{id:MoveRowsMutation.id,params:undoMoveRowsParams}];if(beforePrimary){const moveBackward=toRow-fromRow<0,count=rangeToMove.endRow-rangeToMove.startRow+1,destSelection=moveBackward?destinationRange:{...destinationRange,startRow:destinationRange.startRow-count,endRow:destinationRange.endRow-count},setSelectionsParam={unitId,subUnitId,type:SelectionMoveType.MOVE_END,selections:[{range:destSelection,primary:getPrimaryForRange(destSelection,worksheet),style:null}]},undoSetSelectionsParam={unitId,subUnitId,type:SelectionMoveType.MOVE_END,selections:[{range:rangeToMove,primary:beforePrimary,style:null}]};redos.push({id:SetSelectionsOperation.id,params:setSelectionsParam}),undos.push({id:SetSelectionsOperation.id,params:undoSetSelectionsParam})}redos.push(...interceptorCommands.redos),undos.push(...interceptorCommands.undos);if((0,src.PkI)(redos,commandService).result){return accessor.get(src.$Dz).pushUndoRedo({unitID:unitId,undoMutations:undos,redoMutations:redos}),!0}return!1}},MoveColsCommand={id:"sheet.command.move-cols",type:src.g4t.COMMAND,handler:(accessor,params)=>{const selectionManagerService=accessor.get(selection_service_SheetsSelectionsService),{fromRange:{startColumn:fromCol},toRange:{startColumn:toCol},range}=params,selections=range?[covertRangeToSelection(range)]:selectionManagerService.getCurrentSelections(),filteredSelections=selections?.filter((selection=>selection.range.rangeType===src.$uV.COLUMN&&selection.range.startColumn<=fromCol&&fromCol<=selection.range.endColumn));if(1!==filteredSelections?.length)return!1;const sheetInterceptorService=accessor.get(SheetInterceptorService),target=target_util_getSheetCommandTarget(accessor.get(src.HCr),params);if(!target)return!1;const{workbook,worksheet}=target,unitId=workbook.getUnitId(),subUnitId=worksheet.getSheetId(),errorService=accessor.get(src.IvX),localeService=accessor.get(src.iH9),rangeToMove=filteredSelections[0].range,beforePrimary=filteredSelections[0].primary,alignedRange=alignToMergedCellsBorders(rangeToMove,worksheet,!1);if(!src.M_G.equals(rangeToMove,alignedRange))return errorService.emit(localeService.t("sheets.info.partOfCell")),!1;if(function columnAcrossMergedCell(col,worksheet){return worksheet.getMergeData().some((mergedCell=>mergedCell.startColumn<col&&col<=mergedCell.endColumn))}(toCol,worksheet))return errorService.emit(localeService.t("sheets.info.acrossMergedCell")),!1;const destinationRange={...rangeToMove,startColumn:toCol,endColumn:toCol+rangeToMove.endColumn-rangeToMove.startColumn},moveColsParams={unitId,subUnitId,sourceRange:rangeToMove,targetRange:destinationRange},undoMoveColsParams=function MoveColsMutationUndoFactory(_accessor,params){const{unitId,subUnitId,sourceRange,targetRange}=params,movingBackward=sourceRange.startColumn>targetRange.startColumn,count=sourceRange.endColumn-sourceRange.startColumn+1;return movingBackward?{unitId,subUnitId,sourceRange:src.M_G.clone(targetRange),targetRange:{...sourceRange,endColumn:sourceRange.endColumn+count,startColumn:sourceRange.startColumn+count}}:{unitId,subUnitId,targetRange:src.M_G.clone(sourceRange),sourceRange:{...targetRange,startColumn:targetRange.startColumn-count,endColumn:targetRange.endColumn-count}}}(0,moveColsParams),commandService=accessor.get(src.wTY),interceptorCommands=sheetInterceptorService.onCommandExecute({id:MoveColsCommand.id,params}),redos=[...interceptorCommands.preRedos??[],{id:MoveColsMutation.id,params:moveColsParams}],undos=[...interceptorCommands.preUndos??[],{id:MoveColsMutation.id,params:undoMoveColsParams}];if(beforePrimary){const count=rangeToMove.endColumn-rangeToMove.startColumn+1,destSelection=toCol-fromCol<0?destinationRange:{...destinationRange,startColumn:destinationRange.startColumn-count,endColumn:destinationRange.endColumn-count},setSelectionsParam={unitId,subUnitId,type:SelectionMoveType.MOVE_END,selections:[{range:destSelection,primary:getPrimaryForRange(destSelection,worksheet),style:null}]},undoSetSelectionsParam={unitId,subUnitId,type:SelectionMoveType.MOVE_END,selections:[{range:rangeToMove,primary:beforePrimary,style:null}]};redos.push({id:SetSelectionsOperation.id,params:setSelectionsParam}),undos.push({id:SetSelectionsOperation.id,params:undoSetSelectionsParam})}redos.push(...interceptorCommands.redos),undos.push(...interceptorCommands.undos);if((0,src.PkI)(redos,commandService).result){return accessor.get(src.$Dz).pushUndoRedo({unitID:unitId,undoMutations:undos,redoMutations:redos}),!0}return!0}};function covertRangeToSelection(range){return{range,primary:null,style:null}}const RegisterWorksheetRangeThemeStyleMutation={id:"sheet.mutation.register-worksheet-range-theme-style",type:src.g4t.MUTATION,handler:(accessor,params)=>{const{unitId,rangeThemeStyleJson,themeName}=params,target=target_util_getSheetCommandTarget(accessor.get(src.HCr)),sheetRangeThemeModel=accessor.get(SheetRangeThemeModel);if(!target)return!1;const rangeThemeStyle=new RangeThemeStyle(themeName,rangeThemeStyleJson);return sheetRangeThemeModel.registerRangeThemeStyle(unitId,rangeThemeStyle),!0}},UnregisterWorksheetRangeThemeStyleMutation={id:"sheet.mutation.unregister-worksheet-range-theme-style",type:src.g4t.MUTATION,handler:(accessor,params)=>{const{unitId,themeName}=params,target=target_util_getSheetCommandTarget(accessor.get(src.HCr)),sheetRangeThemeModel=accessor.get(SheetRangeThemeModel);return!!target&&(sheetRangeThemeModel.unregisterRangeThemeStyle(unitId,themeName),!0)}},RegisterWorksheetRangeThemeStyleCommand={id:"sheet.command.register-worksheet-range-theme-style",type:src.g4t.COMMAND,handler:(accessor,params)=>{if(!params)return!1;const{unitId,rangeThemeStyle}=params,univerInstanceService=accessor.get(src.HCr),commandService=accessor.get(src.wTY),undoRedoService=accessor.get(src.$Dz);if(!target_util_getSheetCommandTarget(univerInstanceService))return!1;const redoParam={unitId,themeName:rangeThemeStyle.getName(),rangeThemeStyleJson:rangeThemeStyle.toJson()},undoParam={unitId,themeName:rangeThemeStyle.getName()};return commandService.syncExecuteCommand(RegisterWorksheetRangeThemeStyleMutation.id,redoParam)&&undoRedoService.pushUndoRedo({unitID:unitId,undoMutations:[{id:UnregisterWorksheetRangeThemeStyleMutation.id,params:undoParam}],redoMutations:[{id:RegisterWorksheetRangeThemeStyleMutation.id,params:redoParam}]}),!0}},RemoveDefinedNameCommand={id:"sheet.command.remove-defined-name",type:src.g4t.COMMAND,handler:(accessor,params)=>{const commandService=accessor.get(src.wTY),undoRedoService=accessor.get(src.$Dz),sheetInterceptorService=accessor.get(SheetInterceptorService);if(!params)return!1;const removeSheetMutationParams={...params},interceptorCommands=sheetInterceptorService.onCommandExecute({id:RemoveDefinedNameCommand.id,params}),redos=[...interceptorCommands.preRedos??[],{id:engine_formula_src.gE.id,params:removeSheetMutationParams},...interceptorCommands.redos],undos=[...interceptorCommands.preUndos??[],{id:engine_formula_src.gn.id,params:removeSheetMutationParams},...interceptorCommands.undos];return!!(0,src.PkI)(redos,commandService)&&(undoRedoService.pushUndoRedo({unitID:params.unitId,undoMutations:undos.filter(Boolean),redoMutations:redos.filter(Boolean)}),!0)}},RemoveRowByRangeCommand={type:src.g4t.COMMAND,id:"sheet.command.remove-row-by-range",handler:(accessor,params)=>{if(!params)return!1;const target=target_util_getSheetCommandTarget(accessor.get(src.HCr),params);if(!target)return!1;const{workbook,worksheet}=target,sheetInterceptorService=accessor.get(SheetInterceptorService),{range,unitId,subUnitId}=params,visibleRanges=getVisibleRanges([range],accessor,unitId,subUnitId).reverse(),undoMutations=[],redoMutations=[];visibleRanges.forEach((visibleRange=>{const undos=[],redos=[],removeRowsParams={unitId,subUnitId,range:visibleRange},undoRemoveRowsParams=((params,worksheet)=>{const rowWrapper=worksheet.getRowManager().getRowData(),range=params.range,slice=(0,src.$xj)(range.startRow,range.endRow,rowWrapper),_rowInfo=(0,src.Vc9)({},slice);return{unitId:params.unitId,subUnitId:params.subUnitId,range:params.range,rowInfo:_rowInfo}})(removeRowsParams,worksheet),removedRows=worksheet.getCellMatrix().getSlice(visibleRange.startRow,visibleRange.endRow,0,worksheet.getColumnCount()-1),undoSetRangeValuesParams={unitId,subUnitId,cellValue:removedRows.getMatrix()},intercepted=sheetInterceptorService.onCommandExecute({id:"sheet.command.remove-row",params:{range:visibleRange}});redos.push(...intercepted.preRedos??[]),redos.push({id:RemoveRowMutation.id,params:removeRowsParams}),redos.push(...intercepted.redos??[]),undos.push(...intercepted.preUndos??[]),undos.push({id:InsertRowMutation.id,params:undoRemoveRowsParams}),undos.push({id:SetRangeValuesMutation.id,params:undoSetRangeValuesParams}),undos.push(...intercepted.undos??[]),redoMutations.push(...redos),undoMutations.unshift(...undos)})),redoMutations.push(followSelectionOperation(range,workbook,worksheet));const commandService=accessor.get(src.wTY);if((0,src.PkI)(redoMutations,commandService).result){return accessor.get(src.$Dz).pushUndoRedo({unitID:unitId,undoMutations,redoMutations}),!0}return!1}},RemoveRowCommand={type:src.g4t.COMMAND,id:"sheet.command.remove-row",handler:async(accessor,params)=>{const selectionManagerService=accessor.get(selection_service_SheetsSelectionsService),sheetInterceptorService=accessor.get(SheetInterceptorService),commandService=accessor.get(src.wTY);let range=params?.range;if(range||(range=selectionManagerService.getCurrentLastSelection()?.range),!range)return!1;const target=target_util_getSheetCommandTarget(accessor.get(src.HCr));if(!target)return!1;const{worksheet,subUnitId,unitId}=target;range={...range,startColumn:0,endColumn:Math.max(worksheet.getMaxColumns()-1,0)};return!!await sheetInterceptorService.beforeCommandExecute({id:RemoveRowCommand.id,params:{range}})&&commandService.syncExecuteCommand(RemoveRowByRangeCommand.id,{range,unitId,subUnitId})}},RemoveColByRangeCommand={type:src.g4t.COMMAND,id:"sheet.command.remove-col-by-range",handler:(accessor,parmas)=>{if(!parmas)return!1;const target=target_util_getSheetCommandTarget(accessor.get(src.HCr),parmas);if(!target)return!1;const{workbook,worksheet}=target,sheetInterceptorService=accessor.get(SheetInterceptorService),{range,unitId,subUnitId}=parmas,removeColParams={unitId,subUnitId,range},undoRemoveColParams=((accessor,params)=>{const universheet=accessor.get(src.HCr).getUniverSheetInstance(params.unitId);if(null==universheet)throw new Error("universheet is null error!");const worksheet=universheet.getSheetBySheetId(params.subUnitId);if(null==worksheet)throw new Error("worksheet is null error!");const columnWrapper=worksheet.getColumnManager().getColumnData(),range=params.range,slice=(0,src.$xj)(range.startColumn,range.endColumn,columnWrapper),_colInfo=(0,src.Vc9)({},slice);return{unitId:params.unitId,subUnitId:params.subUnitId,range:params.range,colInfo:_colInfo}})(accessor,removeColParams),undoSetRangeValuesParams={unitId,subUnitId,cellValue:worksheet.getCellMatrix().getSlice(0,worksheet.getRowCount()-1,range.startColumn,range.endColumn).getMatrix()},intercepted=sheetInterceptorService.onCommandExecute({id:"sheet.command.remove-col",params:{range}}),commandService=accessor.get(src.wTY);if((0,src.PkI)([...intercepted.preRedos??[],{id:RemoveColMutation.id,params:removeColParams},...intercepted.redos,followSelectionOperation(range,workbook,worksheet)],commandService).result){return accessor.get(src.$Dz).pushUndoRedo({unitID:unitId,undoMutations:[...intercepted.preUndos??[],{id:InsertColMutation.id,params:undoRemoveColParams},{id:SetRangeValuesMutation.id,params:undoSetRangeValuesParams},...intercepted.undos],redoMutations:[...intercepted.preRedos??[],{id:RemoveColMutation.id,params:removeColParams},...intercepted.redos]}),!0}return!1}},RemoveColCommand={type:src.g4t.COMMAND,id:"sheet.command.remove-col",handler:async(accessor,params)=>{const selectionManagerService=accessor.get(selection_service_SheetsSelectionsService),sheetInterceptorService=accessor.get(SheetInterceptorService),commandService=accessor.get(src.wTY);let range=params?.range;if(range||(range=selectionManagerService.getCurrentLastSelection()?.range),!range)return!1;const target=target_util_getSheetCommandTarget(accessor.get(src.HCr));if(!target)return!1;const{worksheet,subUnitId,unitId}=target;range={...range,startRow:0,endRow:Math.max(worksheet.getMaxRows()-1,0)};return!!await sheetInterceptorService.beforeCommandExecute({id:RemoveColCommand.id,params:{range}})&&commandService.syncExecuteCommand(RemoveColByRangeCommand.id,{range,unitId,subUnitId})}},RemoveSheetCommand={id:"sheet.command.remove-sheet",type:src.g4t.COMMAND,handler:(accessor,params)=>{const commandService=accessor.get(src.wTY),undoRedoService=accessor.get(src.$Dz),univerInstanceService=accessor.get(src.HCr),sheetInterceptorService=accessor.get(SheetInterceptorService),target=target_util_getSheetCommandTarget(univerInstanceService,params);if(!target)return!1;const{unitId,subUnitId,workbook,worksheet}=target;if(workbook.getSheets().length<=1)return!1;const RemoveSheetMutationParams={subUnitId,unitId,subUnitName:worksheet.getName()},InsertSheetMutationParams=((accessor,params)=>{const univerInstanceService=accessor.get(src.HCr),{subUnitId,unitId}=params,target=target_util_getSheetMutationTarget(univerInstanceService,params);if(!target)throw new Error("[RemoveSheetUndoMutationFactory]: Worksheet is null error!");const{workbook,worksheet}=target,sheet=worksheet.getConfig();return{index:workbook.getConfig().sheetOrder.findIndex((id=>id===subUnitId)),sheet,unitId}})(accessor,RemoveSheetMutationParams),intercepted=sheetInterceptorService.onCommandExecute({id:RemoveSheetCommand.id,params:{unitId,subUnitId}}),redos=[...intercepted.preRedos??[],{id:RemoveSheetMutation.id,params:RemoveSheetMutationParams},...intercepted.redos],undos=[...intercepted.preUndos??[],{id:InsertSheetMutation.id,params:InsertSheetMutationParams},...intercepted.undos];return!!(0,src.PkI)(redos,commandService).result&&(undoRedoService.pushUndoRedo({unitID:unitId,undoMutations:undos,redoMutations:redos}),!0)}},AddMergeUndoMutationFactory=(accessor,params)=>{if(null==accessor.get(src.HCr).getUniverSheetInstance(params.unitId))throw new Error("universheet is null error!");return{unitId:params.unitId,subUnitId:params.subUnitId,ranges:src.S0q.deepClone(params.ranges)}},AddWorksheetMergeMutation={id:"sheet.mutation.add-worksheet-merge",type:src.g4t.MUTATION,handler:(accessor,params)=>{const universheet=accessor.get(src.HCr).getUniverSheetInstance(params.unitId);if(null==universheet)throw new Error("universheet is null error!");const worksheet=universheet.getSheetBySheetId(params.subUnitId);if(!worksheet)return!1;const mergeConfigData=worksheet.getConfig().mergeData,mergeAppendData=params.ranges;for(let i=0;i<mergeAppendData.length;i++)mergeConfigData.push(mergeAppendData[i]);return worksheet.getSpanModel().rebuild(mergeConfigData),!0}},RemoveMergeUndoMutationFactory=(accessor,params)=>{const universheet=accessor.get(src.HCr).getUniverSheetInstance(params.unitId);if(null==universheet)throw new Error("universheet is null error!");const worksheet=universheet.getSheetBySheetId(params.subUnitId);if(null==worksheet)throw new Error("worksheet is null error!");const mergeConfigData=worksheet.getConfig().mergeData,mergeRemoveData=params.ranges,ranges=[];for(let j=0;j<mergeRemoveData.length;j++)for(let i=mergeConfigData.length-1;i>=0;i--){const configMerge=mergeConfigData[i],removeMerge=mergeRemoveData[j];src.M_G.intersects(configMerge,removeMerge)&&ranges.push(mergeConfigData[i])}return{unitId:params.unitId,subUnitId:params.subUnitId,ranges}},RemoveWorksheetMergeMutation={id:"sheet.mutation.remove-worksheet-merge",type:src.g4t.MUTATION,handler:(accessor,params)=>{const universheet=accessor.get(src.HCr).getUniverSheetInstance(params.unitId);if(null==universheet)throw new Error("universheet is null error!");const worksheet=universheet.getSheetBySheetId(params.subUnitId);if(!worksheet)return!1;const mergeConfigData=worksheet.getConfig().mergeData,mergeRemoveData=params.ranges;for(let j=0;j<mergeRemoveData.length;j++)for(let i=mergeConfigData.length-1;i>=0;i--){const configMerge=mergeConfigData[i],removeMerge=mergeRemoveData[j];src.M_G.intersects(configMerge,removeMerge)&&mergeConfigData.splice(i,1)}return worksheet.getSpanModel().rebuild(mergeConfigData),!0}},RemoveWorksheetMergeCommand={type:src.g4t.COMMAND,id:"sheet.command.remove-worksheet-merge",handler:(accessor,params)=>{const selectionManagerService=accessor.get(selection_service_SheetsSelectionsService),commandService=accessor.get(src.wTY),undoRedoService=accessor.get(src.$Dz),univerInstanceService=accessor.get(src.HCr),selections=params?.ranges||selectionManagerService.getCurrentSelections()?.map((s=>s.range));if(!selections?.length)return!1;const target=target_util_getSheetCommandTarget(univerInstanceService);if(!target)return!1;const{subUnitId,unitId,worksheet}=target,removeMergeMutationParams={unitId,subUnitId,ranges:selections},intersectsMerges=worksheet.getConfig().mergeData.filter((merge=>selections.some((selection=>src.M_G.intersects(selection,merge)))));if(!intersectsMerges.length)return!1;const undoredoMutationParams=RemoveMergeUndoMutationFactory(accessor,removeMergeMutationParams),nowSelections=selectionManagerService.getCurrentSelections();if(!nowSelections?.length)return!1;const undoSelections=src.S0q.deepClone(nowSelections),redoSelections=src.S0q.deepClone(nowSelections),redoLastSelection=redoSelections[redoSelections.length-1],{startRow,startColumn}=redoLastSelection.range;redoLastSelection.primary={startRow,startColumn,endRow:startRow,endColumn:startColumn,actualRow:startRow,actualColumn:startColumn,isMerged:!1,isMergedMainCell:!1};const getSetRangeValuesParams=function getSetRangeStyleParamsForRemoveMerge(worksheet,ranges){const styleRedoMatrix=new src.hDc,styleUndoMatrix=new src.hDc;return ranges.forEach((range=>{const{startRow,startColumn,endColumn,endRow}=range,cellValue=worksheet.getCellMatrix().getValue(startRow,startColumn);if(cellValue?.s)for(let i=startRow;i<=endRow;i++)for(let j=startColumn;j<=endColumn;j++)i===startRow&&j===startColumn||(styleRedoMatrix.setValue(i,j,{s:cellValue.s}),styleUndoMatrix.setValue(i,j,null))})),{redoParams:styleRedoMatrix,undoParams:styleUndoMatrix}}(worksheet,intersectsMerges),redoSetRangeValueParams={unitId,subUnitId,cellValue:getSetRangeValuesParams.redoParams.getMatrix()},undoSetRangeValueParams={unitId,subUnitId,cellValue:getSetRangeValuesParams.undoParams.getMatrix()},redoMutations=[{id:RemoveWorksheetMergeMutation.id,params:undoredoMutationParams},{id:SetRangeValuesMutation.id,params:redoSetRangeValueParams},{id:SetSelectionsOperation.id,params:{selections:redoSelections}}],undoMutations=[{id:AddWorksheetMergeMutation.id,params:undoredoMutationParams},{id:SetRangeValuesMutation.id,params:undoSetRangeValueParams},{id:SetSelectionsOperation.id,params:{selections:undoSelections}}];return!!(0,src.PkI)(redoMutations,commandService)&&(undoRedoService.pushUndoRedo({unitID:unitId,undoMutations,redoMutations}),!0)}};const ReorderRangeUndoMutationFactory=params=>{const{order}=params,newOrder={};return Object.keys(order).forEach((key=>{newOrder[order[Number(key)]]=Number(key)})),{...params,order:newOrder}},ReorderRangeMutation={id:"sheet.mutation.reorder-range",type:src.g4t.MUTATION,handler:(accessor,params)=>{const{subUnitId,unitId,range,order}=params,worksheet=accessor.get(src.HCr).getUnit(unitId).getSheetBySheetId(subUnitId);if(!worksheet)return!1;const cellDataMatrix=new src.hDc;src.Q6t.foreach(range,((row,col)=>{if(order.hasOwnProperty(row)){const targetRow=order[row],cloneCell=src.S0q.deepClone(worksheet.getCellRaw(targetRow,col));cellDataMatrix.setValue(row,col,cloneCell)}}));const worksheetCellDataMatrix=worksheet.getCellMatrix();return cellDataMatrix.forValue(((row,col,cellData)=>{worksheetCellDataMatrix.setValue(row,col,cellData)})),!0}},ReorderRangeCommand={id:"sheet.command.reorder-range",type:src.g4t.COMMAND,handler:(accessor,params)=>{const{subUnitId,unitId,range,order}=params,commandService=accessor.get(src.wTY),reorderMutation={id:ReorderRangeMutation.id,params:{unitId,subUnitId,order,range}},undoReorderMutation={id:ReorderRangeMutation.id,params:ReorderRangeUndoMutationFactory(reorderMutation.params)},sheetInterceptorService=accessor.get(SheetInterceptorService),interceptorCommands=sheetInterceptorService.onCommandExecute({id:ReorderRangeCommand.id,params}),redos=[...interceptorCommands.preRedos??[],reorderMutation,...interceptorCommands.redos],undos=[...interceptorCommands.preUndos??[],undoReorderMutation,...interceptorCommands.undos],result=(0,src.PkI)(redos,commandService),reoderAfterIntercepted=sheetInterceptorService.afterCommandExecute({id:ReorderRangeCommand.id,params});if(result.result){(0,src.PkI)(reoderAfterIntercepted.redos,commandService);return accessor.get(src.$Dz).pushUndoRedo({unitID:unitId,undoMutations:[...undos,...reoderAfterIntercepted.undos],redoMutations:[...redos,...reoderAfterIntercepted.redos]}),!0}return!1}};class BorderStyleManagerService{dispose(){this._borderInfo$.complete()}setType(type){this._borderInfo.type=type,this.setActiveBorderType(!0),this._refresh()}setColor(color){this._borderInfo.color=color,this._refresh()}setStyle(style){this._borderInfo.style=style,this._refresh()}setActiveBorderType(status){this._borderInfo.activeBorderType=status}getBorderInfo(){return this._borderInfo}_refresh(){this._borderInfo$.next(this._borderInfo)}constructor(){this._borderInfo={type:src.xbc.ALL,color:"#000000",style:src.jBF.THIN,activeBorderType:!1},this._borderInfo$=new BehaviorSubject.t(this._borderInfo),this.borderInfo$=this._borderInfo$.asObservable()}}function forEach(range,action){const{startRow,startColumn,endRow,endColumn}=range;for(let i=startRow;i<=endRow;i++)for(let j=startColumn;j<=endColumn;j++)action(i,j)}const setBorderStyleForRange=(borderContext,range,defaultStyle,reserve)=>{const{mr,worksheet}=borderContext;range.startRow<0||range.startColumn<0||forEach(range,((row,column)=>{const rectangle=worksheet.getMergedCell(row,column);let bdStyle=defaultStyle;if(rectangle&&(defaultStyle.bc_tr||defaultStyle.ml_tr||defaultStyle.bl_tr||defaultStyle.tl_mr||defaultStyle.tl_bc||defaultStyle.tl_br)){if(reserve){const style=src.S0q.deepClone(mr.getValue(rectangle.startRow,rectangle.startColumn)?.s);bdStyle=style?.bd?Object.assign(style.bd,defaultStyle):defaultStyle}mr.setValue(rectangle.startRow,rectangle.startColumn,{s:{bd:bdStyle}})}else{if(reserve){const style=src.S0q.deepClone(mr.getValue(row,column)?.s);bdStyle=style?.bd?Object.assign(style.bd,defaultStyle):defaultStyle}mr.setValue(row,column,{s:{bd:bdStyle}})}}))};const SetBorderCommand={id:"sheet.command.set-border",type:src.g4t.COMMAND,handler:(accessor,params)=>{const commandService=accessor.get(src.wTY),undoRedoService=accessor.get(src.$Dz),univerInstanceService=accessor.get(src.HCr),selectionManagerService=accessor.get(selection_service_SheetsSelectionsService),borderStyleManagerService=accessor.get(BorderStyleManagerService),target=target_util_getSheetCommandTarget(univerInstanceService,params);if(!target)return!1;const ranges=params?.ranges||selectionManagerService.getCurrentSelections()?.map((s=>s.range));if(!ranges?.length)return!1;const{activeBorderType}=borderStyleManagerService.getBorderInfo();if(!activeBorderType)return!1;const borderContext=function getBorderContext(borderStyleManagerService,target,selections){const{style,color,type}=borderStyleManagerService.getBorderInfo(),top=type===src.xbc.TOP||type===src.xbc.ALL||type===src.xbc.OUTSIDE,left=type===src.xbc.LEFT||type===src.xbc.ALL||type===src.xbc.OUTSIDE,bottom=type===src.xbc.BOTTOM||type===src.xbc.ALL||type===src.xbc.OUTSIDE,right=type===src.xbc.RIGHT||type===src.xbc.ALL||type===src.xbc.OUTSIDE,vertical=type===src.xbc.VERTICAL||type===src.xbc.ALL||type===src.xbc.INSIDE,horizontal=type===src.xbc.HORIZONTAL||type===src.xbc.ALL||type===src.xbc.INSIDE,tl_br=type.indexOf("tlbr")>-1,tl_bc=type.indexOf("tlbc")>-1,tl_mr=type.indexOf("tlmr")>-1,bl_tr=type.indexOf("bltr")>-1,ml_tr=type.indexOf("mltr")>-1,bc_tr=type.indexOf("bctr")>-1,range=selections[0],{topRangeOut,leftRangeOut,bottomRangeOut,rightRangeOut,topRange,leftRange,bottomRange,rightRange}=(range=>({topRangeOut:{startRow:range.startRow-1,startColumn:range.startColumn,endRow:range.startRow-1,endColumn:range.endColumn},leftRangeOut:{startRow:range.startRow,startColumn:range.startColumn-1,endRow:range.endRow,endColumn:range.startColumn-1},bottomRangeOut:{startRow:range.endRow+1,startColumn:range.startColumn,endRow:range.endRow+1,endColumn:range.endColumn},rightRangeOut:{startRow:range.startRow,startColumn:range.endColumn+1,endRow:range.endRow,endColumn:range.endColumn+1},topRange:{startRow:range.startRow,startColumn:range.startColumn,endRow:range.startRow,endColumn:range.endColumn},leftRange:{startRow:range.startRow,startColumn:range.startColumn,endRow:range.endRow,endColumn:range.startColumn},bottomRange:{startRow:range.endRow,startColumn:range.startColumn,endRow:range.endRow,endColumn:range.endColumn},rightRange:{startRow:range.startRow,startColumn:range.endColumn,endRow:range.endRow,endColumn:range.endColumn}}))(range),mr=new src.hDc,{worksheet,unitId,subUnitId}=target;return{worksheet,unitId,subUnitId,style,color,type,top,left,right,bottom,vertical,horizontal,tl_br,tl_bc,tl_mr,bl_tr,ml_tr,bc_tr,topRangeOut,leftRangeOut,bottomRangeOut,rightRangeOut,topRange,leftRange,bottomRange,rightRange,range,mr,borderStyle:{s:style,cl:{rgb:color}}}}(borderStyleManagerService,target,ranges);(borderContext=>{const{range,mr,borderStyle,vertical,horizontal,worksheet}=borderContext;vertical&&forEach(range,((row,column)=>{const mergedRange=worksheet.getMergedCell(row,column);if(mergedRange){const topLeftStyle=mr.getValue(mergedRange.startRow,mergedRange.startColumn)?.s;mergedRange.startColumn!==range.startColumn&&mr.setValue(row,column,{s:{bd:topLeftStyle?.bd?Object.assign(topLeftStyle.bd,{l:src.S0q.deepClone(borderStyle)}):{l:src.S0q.deepClone(borderStyle)}}})}else{if(column!==range.endColumn){const style=mr.getValue(row,column)?.s;mr.setValue(row,column,{s:{bd:style?.bd?Object.assign(style.bd,{r:src.S0q.deepClone(borderStyle)}):{r:src.S0q.deepClone(borderStyle)}}})}if(column!==range.startColumn){const style=mr.getValue(row,column)?.s;mr.setValue(row,column,{s:{bd:style?.bd?Object.assign(style.bd,{l:src.S0q.deepClone(borderStyle)}):{l:src.S0q.deepClone(borderStyle)}}})}}})),horizontal&&forEach(range,((row,column)=>{const mergedRange=worksheet.getMergedCell(row,column);if(mergedRange){const topLeftStyle=mr.getValue(mergedRange.startRow,mergedRange.startColumn)?.s;mergedRange.startRow!==range.startRow&&mr.setValue(row,column,{s:{bd:topLeftStyle?.bd?Object.assign(topLeftStyle.bd,{t:src.S0q.deepClone(borderStyle)}):{t:src.S0q.deepClone(borderStyle)}}})}else{if(row!==range.endRow){const style=mr.getValue(row,column)?.s;mr.setValue(row,column,{s:{bd:style?.bd?Object.assign(style.bd,{b:src.S0q.deepClone(borderStyle)}):{b:src.S0q.deepClone(borderStyle)}}})}if(row!==range.startRow){const style=mr.getValue(row,column)?.s;mr.setValue(row,column,{s:{bd:style?.bd?Object.assign(style.bd,{t:src.S0q.deepClone(borderStyle)}):{t:src.S0q.deepClone(borderStyle)}}})}}}))})(borderContext),(borderContext=>{const{top,left,right,bottom,borderStyle,bottomRange,topRange,leftRange,rightRange,bottomRangeOut,topRangeOut,leftRangeOut,rightRangeOut}=borderContext,setBorderStyle=(range,defaultStyle,reserve)=>{setBorderStyleForRange(borderContext,range,defaultStyle,reserve)};top&&(setBorderStyle(topRangeOut,{b:null}),setBorderStyle(topRange,{t:src.S0q.deepClone(borderStyle)},!0)),bottom&&(setBorderStyle(bottomRangeOut,{t:null}),setBorderStyle(bottomRange,{b:src.S0q.deepClone(borderStyle)},!0)),left&&(setBorderStyle(leftRangeOut,{r:null}),setBorderStyle(leftRange,{l:src.S0q.deepClone(borderStyle)},!0)),right&&(setBorderStyle(rightRangeOut,{l:null}),setBorderStyle(rightRange,{r:src.S0q.deepClone(borderStyle)},!0))})(borderContext),function otherBorders(borderContext){const{borderStyle,tl_br,tl_bc,tl_mr,bl_tr,ml_tr,bc_tr}=borderContext,setBorderStyle=(range,defaultStyle,reserve)=>{setBorderStyleForRange(borderContext,range,defaultStyle,reserve)};tl_br&&setBorderStyle(borderContext.range,{tl_br:src.S0q.deepClone(borderStyle)},!0),tl_bc&&setBorderStyle(borderContext.range,{tl_bc:src.S0q.deepClone(borderStyle)},!0),tl_mr&&setBorderStyle(borderContext.range,{tl_mr:src.S0q.deepClone(borderStyle)},!0),bl_tr&&setBorderStyle(borderContext.range,{bl_tr:src.S0q.deepClone(borderStyle)},!0),ml_tr&&setBorderStyle(borderContext.range,{ml_tr:src.S0q.deepClone(borderStyle)},!0),bc_tr&&setBorderStyle(borderContext.range,{bc_tr:src.S0q.deepClone(borderStyle)},!0)}(borderContext),(borderContext=>{const{range,worksheet,mr,top,bottom,left,right,vertical,horizontal,tl_br,tl_bc,tl_mr,bl_tr,ml_tr,bc_tr,topRange,bottomRange,leftRange,rightRange,topRangeOut,bottomRangeOut,leftRangeOut,rightRangeOut}=borderContext,setBorderStyle=(range,defaultStyle,reserve)=>{setBorderStyleForRange(borderContext,range,defaultStyle,reserve)};top||bottom||left||right||vertical||horizontal||tl_br||tl_bc||tl_mr||bl_tr||ml_tr||bc_tr||(forEach(range,((row,column)=>{const mergedRange=worksheet.getMergedCell(row,column);if(mergedRange){if(mergedRange.endColumn!==range.endColumn){const style=mr.getValue(mergedRange.startRow,mergedRange.startColumn)?.s;mr.setValue(row,column,{s:{bd:style?.bd?Object.assign(style.bd,{r:null}):{r:null}}})}if(mergedRange.startColumn!==range.startColumn){const style=mr.getValue(mergedRange.startRow,mergedRange.startColumn)?.s;mr.setValue(row,column,{s:{bd:style?.bd?Object.assign(style.bd,{l:null}):{l:null}}})}if(mergedRange.endRow!==range.endRow){const style=mr.getValue(mergedRange.startRow,mergedRange.startColumn)?.s;mr.setValue(row,column,{s:{bd:style?.bd?Object.assign(style.bd,{b:null}):{b:null}}})}if(mergedRange.startRow!==range.startRow){const style=mr.getValue(mergedRange.startRow,mergedRange.startColumn)?.s;mr.setValue(row,column,{s:{bd:style?.bd?Object.assign(style.bd,{t:null}):{t:null}}})}}else{if(column!==range.endColumn){const style=mr.getValue(row,column)?.s;mr.setValue(row,column,{s:{bd:style?.bd?Object.assign(style.bd,{r:null}):{r:null}}})}if(column!==range.startColumn){const style=mr.getValue(row,column)?.s;mr.setValue(row,column,{s:{bd:style?.bd?Object.assign(style.bd,{l:null}):{l:null}}})}if(row!==range.endRow){const style=mr.getValue(row,column)?.s;mr.setValue(row,column,{s:{bd:style?.bd?Object.assign(style.bd,{b:null}):{b:null}}})}if(row!==range.startRow){const style=mr.getValue(row,column)?.s;mr.setValue(row,column,{s:{bd:style?.bd?Object.assign(style.bd,{t:null}):{t:null}}})}}})),setBorderStyle(topRangeOut,{b:null}),setBorderStyle(topRange,{t:null},!0),setBorderStyle(bottomRangeOut,{t:null}),setBorderStyle(bottomRange,{b:null},!0),setBorderStyle(leftRangeOut,{r:null}),setBorderStyle(leftRange,{l:null},!0),setBorderStyle(rightRangeOut,{l:null}),setBorderStyle(rightRange,{r:null},!0),setBorderStyle(range,{tl_br:null},!0),setBorderStyle(range,{tl_bc:null},!0),setBorderStyle(range,{tl_mr:null},!0),setBorderStyle(range,{bl_tr:null},!0),setBorderStyle(range,{ml_tr:null},!0),setBorderStyle(range,{bc_tr:null},!0))})(borderContext);const{unitId,subUnitId,mr}=borderContext,setRangeValuesMutationParams={unitId,subUnitId,cellValue:mr.getData()},undoSetRangeValuesMutationParams=SetRangeValuesUndoMutationFactory(accessor,setRangeValuesMutationParams);return!!commandService.syncExecuteCommand(SetRangeValuesMutation.id,setRangeValuesMutationParams)&&(undoRedoService.pushUndoRedo({unitID:unitId,undoMutations:[{id:SetRangeValuesMutation.id,params:undoSetRangeValuesMutationParams}],redoMutations:[{id:SetRangeValuesMutation.id,params:setRangeValuesMutationParams}]}),!0)}},SetBorderPositionCommand={id:"sheet.command.set-border-position",type:src.g4t.COMMAND,handler:(accessor,params)=>{if(!params.value)return!1;const commandService=accessor.get(src.wTY);return accessor.get(BorderStyleManagerService).setType(params.value),commandService.syncExecuteCommand(SetBorderCommand.id)}},SetBorderStyleCommand={id:"sheet.command.set-border-style",type:src.g4t.COMMAND,handler:(accessor,params)=>{const commandService=accessor.get(src.wTY);return accessor.get(BorderStyleManagerService).setStyle(params.value),commandService.syncExecuteCommand(SetBorderCommand.id)}},SetBorderColorCommand={id:"sheet.command.set-border-color",type:src.g4t.COMMAND,handler:(accessor,params)=>{const commandService=accessor.get(src.wTY);return accessor.get(BorderStyleManagerService).setColor(params.value),commandService.syncExecuteCommand(SetBorderCommand.id)}},SetBorderBasicCommand={id:"sheet.command.set-border-basic",type:src.g4t.COMMAND,handler:(accessor,params)=>{const{unitId,subUnitId,value,ranges}=params,{type,color,style}=value,commandService=accessor.get(src.wTY),borderManager=accessor.get(BorderStyleManagerService);return borderManager.setType(type),color&&borderManager.setColor(color),borderManager.setStyle(style),commandService.syncExecuteCommand(SetBorderCommand.id,{unitId,subUnitId,ranges})}};function getOldRowData(currentRow,newRow){if(null==currentRow)return currentRow;const row=src.S0q.deepClone(currentRow);if(null==newRow)return row;const oldRow={};return"h"in newRow&&(oldRow.h=row.h),"ia"in newRow&&(oldRow.ia=row.ia),"ah"in newRow&&(oldRow.ah=row.ah),"hd"in newRow&&(oldRow.hd=row.hd),"s"in newRow&&(oldRow.s=row.s),"custom"in newRow&&(oldRow.custom=row.custom),oldRow}function getOldColumnData(currenColumn,newColumn){if(null==currenColumn)return currenColumn;const column=src.S0q.deepClone(currenColumn);if(null==newColumn)return column;const oldColumn={};return"w"in newColumn&&(oldColumn.w=column.w),"hd"in newColumn&&(oldColumn.hd=column.hd),"s"in newColumn&&(oldColumn.s=column.s),"custom"in newColumn&&(oldColumn.custom=column.custom),oldColumn}const SetColDataMutation={id:"sheet.mutation.set-col-data",type:src.g4t.MUTATION,handler:(accessor,params)=>{const{columnData}=params,target=target_util_getSheetCommandTarget(accessor.get(src.HCr),params);if(!target)return!1;const{worksheet}=target,manager=worksheet.getColumnManager();for(const colIndex in columnData){const col=columnData[colIndex];if(null==col){manager.removeColumn(Number(colIndex));continue}const currentCol=manager.getColumnOrCreate(Number(colIndex));Object.assign(currentCol,col)}return!0}},SetColDataCommand={type:src.g4t.COMMAND,id:"sheet.command.set-col-data",handler:(accessor,params)=>{const commandService=accessor.get(src.wTY),undoRedoService=accessor.get(src.$Dz),target=target_util_getSheetCommandTarget(accessor.get(src.HCr),params);if(!target)return!1;const{columnData}=params,{unitId,subUnitId,worksheet}=target,redoMutationParams={subUnitId,unitId,columnData},undoMutationParams=((params,worksheet)=>{const{unitId,subUnitId,columnData}=params,oldColData={},manager=worksheet.getColumnManager();for(const colIndex in columnData){const newCol=columnData[colIndex],currentCol=manager.getColumn(Number(colIndex));oldColData[colIndex]=getOldColumnData(currentCol,newCol)}return{unitId,subUnitId,columnData:oldColData}})(redoMutationParams,worksheet);return!!commandService.syncExecuteCommand(SetColDataMutation.id,redoMutationParams)&&(undoRedoService.pushUndoRedo({unitID:unitId,undoMutations:[{id:SetColDataMutation.id,params:undoMutationParams}],redoMutations:[{id:SetColDataMutation.id,params:redoMutationParams}]}),!0)}},SetColHiddenMutation={id:"sheet.mutation.set-col-hidden",type:src.g4t.MUTATION,handler:(accessor,params)=>{const universheet=accessor.get(src.HCr).getUniverSheetInstance(params.unitId);if(!universheet)return!1;const manager=universheet.getSheetBySheetId(params.subUnitId).getColumnManager();for(let i=0;i<params.ranges.length;i++){const range=params.ranges[i];for(let j=range.startColumn;j<range.endColumn+1;j++){const column=manager.getColumnOrCreate(j);null!=column&&(column.hd=src.OdA.TRUE)}}return!0}},SetColVisibleMutation={id:"sheet.mutation.set-col-visible",type:src.g4t.MUTATION,handler:(accessor,params)=>{const universheet=accessor.get(src.HCr).getUniverSheetInstance(params.unitId);if(!universheet)return!1;const manager=universheet.getSheetBySheetId(params.subUnitId).getColumnManager();for(let i=0;i<params.ranges.length;i++){const range=params.ranges[i];for(let j=range.startColumn;j<range.endColumn+1;j++){const column=manager.getColumnOrCreate(j);null!=column&&(column.hd=src.OdA.FALSE)}}return!0}},SetSpecificColsVisibleCommand={type:src.g4t.COMMAND,id:"sheet.command.set-col-visible-on-cols",handler:(accessor,params)=>{const{unitId,subUnitId,ranges}=params,sheetInterceptorService=accessor.get(SheetInterceptorService),commandService=accessor.get(src.wTY),target=target_util_getSheetCommandTarget(accessor.get(src.HCr),{unitId,subUnitId});if(!target)return!1;const{worksheet}=target,redoMutationParams={unitId,subUnitId,ranges},setSelectionOperationParams={unitId,subUnitId,reveal:!0,selections:ranges.map((r=>({range:r,primary:getPrimaryForRange(r,worksheet),style:null})))},undoMutationParams=((accessor,params)=>{if(null==accessor.get(src.HCr).getUniverSheetInstance(params.unitId))throw new Error("universheet is null error!");return{unitId:params.unitId,subUnitId:params.subUnitId,ranges:params.ranges}})(accessor,redoMutationParams),undoSetSelectionsOperationParams={unitId,subUnitId,selections:getSelectionsAfterHiding(ranges).map((range=>({range,primary:getPrimaryForRange(range,worksheet),style:null})))},result=(0,src.PkI)([{id:SetColVisibleMutation.id,params:redoMutationParams},{id:SetSelectionsOperation.id,params:setSelectionOperationParams}],commandService),intercepted=sheetInterceptorService.onCommandExecute({id:SetSpecificColsVisibleCommand.id,params}),interceptedResult=(0,src.PkI)([...intercepted.redos],commandService);if(result.result&&interceptedResult.result){return accessor.get(src.$Dz).pushUndoRedo({unitID:unitId,undoMutations:[{id:SetColHiddenMutation.id,params:undoMutationParams},{id:SetSelectionsOperation.id,params:undoSetSelectionsOperationParams},...intercepted.undos??[]],redoMutations:[...intercepted.preRedos??[],{id:SetColVisibleMutation.id,params:redoMutationParams},{id:SetSelectionsOperation.id,params:setSelectionOperationParams},...intercepted.redos]}),!0}return!0}},SetSelectedColsVisibleCommand={type:src.g4t.COMMAND,id:"sheet.command.set-selected-cols-visible",handler:accessor=>{const selectionManagerService=accessor.get(selection_service_SheetsSelectionsService),commandService=accessor.get(src.wTY),ranges=selectionManagerService.getCurrentSelections()?.map((s=>s.range)).filter((r=>r.rangeType===src.$uV.COLUMN));if(!ranges?.length)return!1;const target=target_util_getSheetCommandTarget(accessor.get(src.HCr));if(!target)return!1;const{worksheet,unitId,subUnitId}=target,hiddenRanges=ranges.map((r=>worksheet.getHiddenCols(r.startColumn,r.endColumn))).flat();return commandService.executeCommand(SetSpecificColsVisibleCommand.id,{unitId,subUnitId,ranges:hiddenRanges})}},SetColHiddenCommand={type:src.g4t.COMMAND,id:"sheet.command.set-col-hidden",handler:(accessor,params)=>{const selectionManagerService=accessor.get(selection_service_SheetsSelectionsService),sheetInterceptorService=accessor.get(SheetInterceptorService),univerInstanceService=accessor.get(src.HCr),commandService=accessor.get(src.wTY);let ranges=params?.ranges?.length?params.ranges:selectionManagerService.getCurrentSelections()?.map((s=>s.range)).filter((r=>r.rangeType===src.$uV.COLUMN));if(!ranges?.length)return!1;const target=target_util_getSheetCommandTarget(univerInstanceService,params);if(!target)return!1;const{worksheet,unitId,subUnitId}=target;ranges=function divideRangesByHiddenCols(worksheet,ranges){const endRow=worksheet.getRowCount()-1,hiddenCols=worksheet.getHiddenCols(),divided=[];return ranges.forEach((range=>{const hiddenColsInSelection=hiddenCols.filter((c=>c.startColumn>=range.startColumn&&c.endColumn<=range.endColumn));if(hiddenColsInSelection.length){let startColumn=range.startColumn;hiddenColsInSelection.forEach((hiddenRange=>{hiddenRange.startColumn>startColumn&&(divided.push({startColumn,endColumn:hiddenRange.startColumn-1,startRow:0,endRow}),startColumn=hiddenRange.endColumn+1)})),startColumn<=range.endColumn&&divided.push({startColumn,endColumn:range.endColumn,startRow:0,endRow})}else divided.push(range)})),divided}(target.worksheet,ranges);const redoMutationParams={unitId,subUnitId,ranges},setSelectionOperationParams={unitId,subUnitId,selections:getSelectionsAfterHiding(ranges).map((range=>({range,primary:getPrimaryForRange(range,worksheet),style:null})))},undoMutationParams=((accessor,params)=>{if(null==accessor.get(src.HCr).getUniverSheetInstance(params.unitId))throw new Error("universheet is null error!");return{unitId:params.unitId,subUnitId:params.subUnitId,ranges:params.ranges}})(accessor,redoMutationParams),undoSetSelectionsOperationParams={unitId,subUnitId,reveal:!0,selections:ranges.map((range=>({range,primary:getPrimaryForRange(range,worksheet),style:null})))},result=(0,src.PkI)([{id:SetColHiddenMutation.id,params:redoMutationParams},{id:SetSelectionsOperation.id,params:setSelectionOperationParams}],commandService),intercepted=sheetInterceptorService.onCommandExecute({id:SetColHiddenCommand.id,params:redoMutationParams}),interceptedResult=(0,src.PkI)([...intercepted.redos],commandService);if(result.result&&interceptedResult.result){return accessor.get(src.$Dz).pushUndoRedo({unitID:unitId,undoMutations:[{id:SetColVisibleMutation.id,params:undoMutationParams},{id:SetSelectionsOperation.id,params:undoSetSelectionsOperationParams},...intercepted.undos??[]],redoMutations:[...intercepted.preRedos??[],{id:SetColHiddenMutation.id,params:redoMutationParams},{id:SetSelectionsOperation.id,params:setSelectionOperationParams},...intercepted.redos]}),!0}return!1}};function getSelectionsAfterHiding(ranges){const merged=function mergeSelections(ranges){const merged=[];let current;return ranges.sort(((a,b)=>a.startColumn-b.startColumn)).forEach((range=>{current?current.endColumn===range.startColumn-1?current.endColumn=range.endColumn:(merged.push(current),current=range):current=range})),merged.push(current),merged}(ranges);return merged.map((range=>{const column=0===range.startColumn?range.endColumn+1:range.startColumn-1;return{...range,startColumn:column,endColumn:column}}))}const SetDefinedNameCommand={id:"sheet.command.set-defined-name",type:src.g4t.COMMAND,handler:(accessor,params)=>{const commandService=accessor.get(src.wTY),undoRedoService=accessor.get(src.$Dz),sheetInterceptorService=accessor.get(SheetInterceptorService);if(!params)return!1;const newDefinedNameMutationParams={...params},oldDefinedNameMutationParams=(0,engine_formula_src.mJ)(accessor,params),interceptorCommands=sheetInterceptorService.onCommandExecute({id:SetDefinedNameCommand.id,params}),redos=[...interceptorCommands.preRedos??[],{id:engine_formula_src.gE.id,params:oldDefinedNameMutationParams},{id:engine_formula_src.gn.id,params:newDefinedNameMutationParams},...interceptorCommands.redos],undos=[...interceptorCommands.preUndos??[],{id:engine_formula_src.gE.id,params:newDefinedNameMutationParams},{id:engine_formula_src.gn.id,params:oldDefinedNameMutationParams},...interceptorCommands.undos];return!!(0,src.PkI)(redos,commandService)&&(undoRedoService.pushUndoRedo({unitID:params.unitId,undoMutations:undos.filter(Boolean),redoMutations:redos.filter(Boolean)}),!0)}},SetFrozenMutationFactory=(accessor,params)=>{const universheet=accessor.get(src.HCr).getUniverSheetInstance(params.unitId);if(null==universheet)throw new Error("universheet is null error!");const worksheet=universheet.getSheetBySheetId(params.subUnitId);if(null==worksheet)throw new Error("worksheet is null error!");const freeze=worksheet.getConfig().freeze;return{unitId:params.unitId,subUnitId:params.subUnitId,...freeze}},SetFrozenMutation={id:"sheet.mutation.set-frozen",type:src.g4t.MUTATION,handler:(accessor,params)=>{const universheet=accessor.get(src.HCr).getUniverSheetInstance(params.unitId);if(null==universheet)throw new Error("universheet is null error!");const worksheet=universheet.getSheetBySheetId(params.subUnitId);if(!worksheet)return!1;const config=worksheet.getConfig(),{startRow,startColumn,ySplit,xSplit}=params;return config.freeze={startRow,startColumn,ySplit,xSplit},!0}},SetFrozenCommand={type:src.g4t.COMMAND,id:"sheet.command.set-frozen",handler:(accessor,params)=>{const commandService=accessor.get(src.wTY),undoRedoService=accessor.get(src.$Dz),target=target_util_getSheetCommandTarget(accessor.get(src.HCr),{unitId:params.unitId,subUnitId:params.subUnitId});if(!target)return!1;const{unitId,subUnitId,worksheet}=target,{startColumn,startRow,xSplit,ySplit}=params;if(startRow>=worksheet.getRowCount()||startColumn>=worksheet.getColumnCount()||xSplit>=worksheet.getColumnCount()||ySplit>=worksheet.getRowCount())return!1;const redoMutationParams={unitId,subUnitId,...params},undoMutationParams=SetFrozenMutationFactory(accessor,redoMutationParams);return!!commandService.syncExecuteCommand(SetFrozenMutation.id,redoMutationParams)&&(undoRedoService.pushUndoRedo({unitID:unitId,undoMutations:[{id:SetFrozenMutation.id,params:undoMutationParams}],redoMutations:[{id:SetFrozenMutation.id,params:redoMutationParams}]}),!0)}},CancelFrozenCommand={type:src.g4t.COMMAND,id:"sheet.command.cancel-frozen",handler:(accessor,params)=>{const commandService=accessor.get(src.wTY),univerInstanceService=accessor.get(src.HCr),undoRedoService=accessor.get(src.$Dz),target=target_util_getSheetCommandTarget(univerInstanceService,{unitId:params?.unitId,subUnitId:params?.subUnitId});if(!target)return!1;const{unitId,subUnitId}=target,redoMutationParams={unitId,subUnitId,startRow:-1,startColumn:-1,xSplit:0,ySplit:0},undoMutationParams=SetFrozenMutationFactory(accessor,redoMutationParams);return!commandService.syncExecuteCommand(SetFrozenMutation.id,redoMutationParams)||(undoRedoService.pushUndoRedo({unitID:unitId,undoMutations:[{id:SetFrozenMutation.id,params:undoMutationParams}],redoMutations:[{id:SetFrozenMutation.id,params:redoMutationParams}]}),!0)}},SetGridlinesColorMutation={id:"sheet.mutation.set-gridlines-color",type:src.g4t.MUTATION,handler:(accessor,params)=>{const target=target_util_getSheetCommandTarget(accessor.get(src.HCr),params);if(!target)return!1;const{worksheet}=target;return worksheet.getConfig().gridlinesColor=params.color,!0}},SetGridlinesColorCommand={type:src.g4t.COMMAND,id:"sheet.command.set-gridlines-color",handler:(accessor,params)=>{const commandService=accessor.get(src.wTY),undoRedoService=accessor.get(src.$Dz),target=target_util_getSheetCommandTarget(accessor.get(src.HCr));if(!target)return!1;const{worksheet}=target,currentlyColor=worksheet.getConfig().gridlinesColor;if(currentlyColor===params?.color)return!1;const{unitId,subUnitId}=target,doParams={color:params?.color,unitId,subUnitId},undoMutationParams={color:currentlyColor,unitId,subUnitId};return!!commandService.syncExecuteCommand(SetGridlinesColorMutation.id,doParams)&&(undoRedoService.pushUndoRedo({unitID:unitId,undoMutations:[{id:SetGridlinesColorMutation.id,params:undoMutationParams}],redoMutations:[{id:SetGridlinesColorMutation.id,params:doParams}]}),!0)}},SetRangeProtectionMutation={id:"sheet.mutation.set-range-protection",type:src.g4t.MUTATION,handler:(accessor,params)=>{const{unitId,subUnitId,rule,ruleId}=params;return accessor.get(range_protection_rule_model_RangeProtectionRuleModel).setRule(unitId,subUnitId,ruleId,rule),!0}},SetWorksheetProtectionMutation={id:"sheet.mutation.set-worksheet-protection",type:src.g4t.MUTATION,handler:(accessor,params)=>{const{unitId,subUnitId,rule}=params;return accessor.get(WorksheetProtectionRuleModel).setRule(unitId,subUnitId,rule),!0}},SetProtectionCommand={type:src.g4t.COMMAND,id:"sheet.command.set-protection",async handler(accessor,params){if(!params)return!1;const commandService=accessor.get(src.wTY),undoRedoService=accessor.get(src.$Dz),rangeProtectionRuleModel=accessor.get(range_protection_rule_model_RangeProtectionRuleModel),{rule,oldRule}=params,{unitId,subUnitId}=rule,redoMutations=[],undoMutations=[];oldRule?.unitType===rule.unitType?rule.unitType===es._m.Worksheet?(redoMutations.push({id:SetWorksheetProtectionMutation.id,params:{unitId,subUnitId,rule}}),undoMutations.push({id:SetWorksheetProtectionMutation.id,params:{unitId,subUnitId,rule:oldRule}})):(redoMutations.push({id:SetRangeProtectionMutation.id,params:{unitId,subUnitId,rule,ruleId:rule.id}}),undoMutations.push({id:SetRangeProtectionMutation.id,params:{unitId,subUnitId,ruleId:oldRule.id,rule:oldRule}})):(oldRule&&(oldRule.unitType===es._m.Worksheet?(redoMutations.push({id:DeleteWorksheetProtectionMutation.id,params:{unitId,subUnitId}}),undoMutations.push({id:AddWorksheetProtectionMutation.id,params:{unitId,rule:oldRule,subUnitId:oldRule.subUnitId}})):oldRule.unitType===es._m.SelectRange&&(redoMutations.push({id:delete_range_protection_mutation_DeleteRangeProtectionMutation.id,params:{unitId,subUnitId,ruleIds:[oldRule.id]}}),undoMutations.push({id:add_range_protection_mutation_AddRangeProtectionMutation.id,params:{unitId,subUnitId,rules:[oldRule]}}))),rule.unitType===es._m.Worksheet?(redoMutations.push({id:AddWorksheetProtectionMutation.id,params:{unitId,rule,subUnitId:rule.subUnitId}}),undoMutations.unshift({id:DeleteWorksheetProtectionMutation.id,params:{unitId,subUnitId}})):rule.unitType===es._m.SelectRange&&(rule.id=rangeProtectionRuleModel.createRuleId(unitId,subUnitId),redoMutations.push({id:add_range_protection_mutation_AddRangeProtectionMutation.id,params:{unitId,subUnitId,rules:[rule]}}),undoMutations.unshift({id:delete_range_protection_mutation_DeleteRangeProtectionMutation.id,params:{unitId,subUnitId,ruleIds:[rule.id]}})));return(0,src.PkI)(redoMutations,commandService)&&undoRedoService.pushUndoRedo({unitID:unitId,undoMutations,redoMutations}),!0}},SetRowDataMutation={id:"sheet.mutation.set-row-data",type:src.g4t.MUTATION,handler:(accessor,params)=>{const{rowData}=params,target=target_util_getSheetCommandTarget(accessor.get(src.HCr),params);if(!target)return!1;const{worksheet}=target,manager=worksheet.getRowManager();for(const rowIndex in rowData){const row=rowData[rowIndex];if(null==row){manager.removeRow(Number(rowIndex));continue}const currentRow=manager.getRowOrCreate(Number(rowIndex));Object.assign(currentRow,row)}return!0}},SetRowDataCommand={type:src.g4t.COMMAND,id:"sheet.command.set-row-data",handler:(accessor,params)=>{const commandService=accessor.get(src.wTY),undoRedoService=accessor.get(src.$Dz),target=target_util_getSheetCommandTarget(accessor.get(src.HCr),params);if(!target)return!1;const{rowData}=params,{unitId,subUnitId,worksheet}=target,redoMutationParams={subUnitId,unitId,rowData},undoMutationParams=((params,worksheet)=>{const{unitId,subUnitId,rowData}=params,oldRowData={},manager=worksheet.getRowManager();for(const rowIndex in rowData){const newRow=rowData[rowIndex],currentRow=manager.getRow(Number(rowIndex));oldRowData[rowIndex]=getOldRowData(currentRow,newRow)}return{unitId,subUnitId,rowData:oldRowData}})(redoMutationParams,worksheet);return!!commandService.syncExecuteCommand(SetRowDataMutation.id,redoMutationParams)&&(undoRedoService.pushUndoRedo({unitID:unitId,undoMutations:[{id:SetRowDataMutation.id,params:undoMutationParams}],redoMutations:[{id:SetRowDataMutation.id,params:redoMutationParams}]}),!0)}},SetRowVisibleMutation={id:"sheet.mutation.set-row-visible",type:src.g4t.MUTATION,handler:(accessor,params)=>{const universheet=accessor.get(src.HCr).getUniverSheetInstance(params.unitId);if(null==universheet)throw new Error("universheet is null error!");const manager=universheet.getSheetBySheetId(params.subUnitId).getRowManager();for(let i=0;i<params.ranges.length;i++){const range=params.ranges[i];for(let j=range.startRow;j<range.endRow+1;j++){const row=manager.getRowOrCreate(j);null!=row&&(row.hd=0)}}return!0}},SetRowHiddenMutation={id:"sheet.mutation.set-row-hidden",type:src.g4t.MUTATION,handler:(accessor,params)=>{const universheet=accessor.get(src.HCr).getUniverSheetInstance(params.unitId);if(null==universheet)throw new Error("universheet is null error!");const manager=universheet.getSheetBySheetId(params.subUnitId).getRowManager();for(let i=0;i<params.ranges.length;i++){const range=params.ranges[i];for(let j=range.startRow;j<range.endRow+1;j++){const row=manager.getRowOrCreate(j);null!=row&&(row.hd=1)}}return!0}},SetSpecificRowsVisibleCommand={type:src.g4t.COMMAND,id:"sheet.command.set-specific-rows-visible",handler:(accessor,params)=>{const{unitId,subUnitId,ranges}=params,commandService=accessor.get(src.wTY),undoRedoService=accessor.get(src.$Dz),sheetInterceptorService=accessor.get(SheetInterceptorService),target=target_util_getSheetCommandTarget(accessor.get(src.HCr),{unitId,subUnitId});if(!target)return!1;const{worksheet}=target,redoMutationParams={unitId,subUnitId,ranges},setSelectionOperationParams={unitId,subUnitId,reveal:!0,selections:ranges.map((range=>({range,primary:getPrimaryForRange(range,worksheet),style:null})))},undoMutationParams=((accessor,params)=>{if(null==accessor.get(src.HCr).getUniverSheetInstance(params.unitId))throw new Error("universheet is null error!");return{unitId:params.unitId,subUnitId:params.subUnitId,ranges:params.ranges}})(accessor,redoMutationParams),undoSetSelectionsOperationParams={unitId,subUnitId,selections:set_row_visible_command_getSelectionsAfterHiding(ranges).map((range=>({range,primary:getPrimaryForRange(range,worksheet),style:null})))},result=(0,src.PkI)([{id:SetRowVisibleMutation.id,params:redoMutationParams},{id:SetSelectionsOperation.id,params:setSelectionOperationParams}],commandService),intercepted=sheetInterceptorService.onCommandExecute({id:SetSpecificRowsVisibleCommand.id,params}),interceptedResult=(0,src.PkI)([...intercepted.redos],commandService);return!result.result||!interceptedResult.result||(undoRedoService.pushUndoRedo({unitID:unitId,undoMutations:[...intercepted.preUndos??[],{id:SetRowHiddenMutation.id,params:undoMutationParams},{id:SetSelectionsOperation.id,params:undoSetSelectionsOperationParams},...intercepted.undos??[]],redoMutations:[...intercepted.preRedos??[],{id:SetRowVisibleMutation.id,params:redoMutationParams},{id:SetSelectionsOperation.id,params:setSelectionOperationParams},...intercepted.redos]}),!0)}},SetSelectedRowsVisibleCommand={type:src.g4t.COMMAND,id:"sheet.command.set-selected-rows-visible",handler:async accessor=>{const selectionManagerService=accessor.get(selection_service_SheetsSelectionsService),univerInstanceService=accessor.get(src.HCr),commandService=accessor.get(src.wTY),ranges=selectionManagerService.getCurrentSelections()?.map((s=>s.range)).filter((r=>r.rangeType===src.$uV.ROW));if(!ranges?.length)return!1;const target=target_util_getSheetCommandTarget(univerInstanceService);if(!target)return!1;const{worksheet,unitId,subUnitId}=target,hiddenRanges=ranges.map((r=>worksheet.getHiddenRows(r.startRow,r.endRow))).flat();return commandService.executeCommand(SetSpecificRowsVisibleCommand.id,{unitId,subUnitId,ranges:hiddenRanges})}},SetRowHiddenCommand={type:src.g4t.COMMAND,id:"sheet.command.set-rows-hidden",handler:(accessor,params)=>{const selectionManagerService=accessor.get(selection_service_SheetsSelectionsService),commandService=accessor.get(src.wTY),undoRedoService=accessor.get(src.$Dz),univerInstanceService=accessor.get(src.HCr),sheetInterceptorService=accessor.get(SheetInterceptorService);let ranges=params?.ranges?.length?params.ranges:selectionManagerService.getCurrentSelections()?.map((s=>s.range)).filter((r=>r.rangeType===src.$uV.ROW));if(!ranges?.length)return!1;const target=target_util_getSheetCommandTarget(univerInstanceService,params);if(!target)return!1;ranges=function divideRangesByHiddenRows(worksheet,ranges){const endCol=worksheet.getMaxColumns()-1,hiddenRows=worksheet.getHiddenRows(),divided=[];return ranges.forEach((range=>{const hiddenRowsInThisRange=hiddenRows.filter((r=>r.startRow>=range.startRow&&r.endRow<=range.endRow));if(hiddenRowsInThisRange.length){let startRow=range.startRow;hiddenRowsInThisRange.forEach((hiddenRange=>{hiddenRange.startRow>startRow&&(divided.push({startRow,endRow:hiddenRange.startRow-1,startColumn:0,endColumn:endCol}),startRow=hiddenRange.endRow+1)})),startRow<=range.endRow&&divided.push({startRow,endRow:range.endRow,startColumn:0,endColumn:endCol})}else divided.push(range)})),divided}(target.worksheet,ranges);const{unitId,subUnitId,worksheet}=target,redoMutationParams={unitId,subUnitId,ranges},setSelectionOperationParams={unitId,subUnitId,selections:set_row_visible_command_getSelectionsAfterHiding(ranges).map((range=>({range,primary:getPrimaryForRange(range,worksheet),style:null})))},undoMutationParams=((accessor,params)=>{if(null==accessor.get(src.HCr).getUniverSheetInstance(params.unitId))throw new Error("universheet is null error!");return{unitId:params.unitId,subUnitId:params.subUnitId,ranges:params.ranges}})(accessor,redoMutationParams),undoSetSelectionsOperationParams={unitId,subUnitId,reveal:!0,selections:ranges.map((range=>({range,primary:getPrimaryForRange(range,worksheet),style:null})))},intercepted=sheetInterceptorService.onCommandExecute({id:SetRowHiddenCommand.id,params:redoMutationParams});return!(0,src.PkI)([...intercepted.preRedos??[],{id:SetRowHiddenMutation.id,params:redoMutationParams},{id:SetSelectionsOperation.id,params:setSelectionOperationParams},...intercepted.redos],commandService).result||(undoRedoService.pushUndoRedo({unitID:unitId,undoMutations:[...intercepted.preUndos??[],{id:SetRowVisibleMutation.id,params:undoMutationParams},{id:SetSelectionsOperation.id,params:undoSetSelectionsOperationParams},...intercepted.undos??[]],redoMutations:[...intercepted.preRedos??[],{id:SetRowHiddenMutation.id,params:redoMutationParams},{id:SetSelectionsOperation.id,params:setSelectionOperationParams},...intercepted.redos]}),!0)}};function set_row_visible_command_getSelectionsAfterHiding(ranges){const merged=function set_row_visible_command_mergeSelections(ranges){const merged=[];let current;return ranges.sort(((a,b)=>a.startRow-b.startRow)).forEach((range=>{current?range.startRow===current.endRow+1?current.endRow=range.endRow:(merged.push(current),current=range):current=range})),merged.push(current),merged}(ranges);return merged.map((range=>{const row=0===range.startRow?range.endRow+1:range.startRow-1;return{...range,startRow:row,endRow:row}}))}const SetStyleCommand={type:src.g4t.COMMAND,id:"sheet.command.set-style",handler:(accessor,params)=>{const target=target_util_getSheetCommandTarget(accessor.get(src.HCr),params);if(!target)return!1;const{unitId,subUnitId,worksheet}=target,{range,style}=params,commandService=accessor.get(src.wTY),undoRedoService=accessor.get(src.$Dz),selectionManagerService=accessor.get(selection_service_SheetsSelectionsService),ranges=range?[range]:selectionManagerService.getCurrentSelections()?.map((s=>s.range));if(!ranges?.length)return!1;const cellValue=new src.hDc,iterator=function createRangeIteratorWithSkipFilteredRows(sheet){return{forOperableEach:function forOperableEach(ranges,operator){!function iterate(range){for(let r=range.startRow;r<=range.endRow;r++)if(!sheet.getRowFiltered(r))for(let c=range.startColumn;c<=range.endColumn;c++)operator(r,c,range)}(ranges)}}}(worksheet);if(src.S0q.isArray(style.value))for(let i=0;i<ranges.length;i++)iterator.forOperableEach(ranges[i],((r,c,range)=>{cellValue.setValue(r,c,{s:{[style.type]:style.value[r-range.startRow][c-range.startColumn]}})}));else for(let i=0;i<ranges.length;i++){const styleObj={s:{[style.type]:style.value}};iterator.forOperableEach(ranges[i],((r,c)=>cellValue.setValue(r,c,styleObj)))}const setRangeValuesMutationParams={subUnitId,unitId,cellValue:cellValue.getMatrix()},undoSetRangeValuesMutationParams=SetRangeValuesUndoMutationFactory(accessor,setRangeValuesMutationParams),setRangeValuesResult=commandService.syncExecuteCommand(SetRangeValuesMutation.id,setRangeValuesMutationParams),{undos,redos}=accessor.get(SheetInterceptorService).onCommandExecute({id:SetStyleCommand.id,params}),result=(0,src.PkI)([...redos],commandService);return!(!setRangeValuesResult||!result.result)&&(undoRedoService.pushUndoRedo({unitID:setRangeValuesMutationParams.unitId,undoMutations:[{id:SetRangeValuesMutation.id,params:undoSetRangeValuesMutationParams},...undos],redoMutations:[{id:SetRangeValuesMutation.id,params:setRangeValuesMutationParams},...redos]}),!0)}},SetBoldCommand={type:src.g4t.COMMAND,id:"sheet.command.set-bold",handler:accessor=>{const selection=accessor.get(selection_service_SheetsSelectionsService).getCurrentLastSelection();if(!selection)return!1;const target=target_util_getSheetCommandTarget(accessor.get(src.HCr));if(!target)return!1;const{worksheet}=target,{actualRow,actualColumn}=selection.primary,setStyleParams={style:{type:"bl",value:worksheet.getRange(actualRow,actualColumn).getFontWeight()===src.ITE.BOLD?src.OdA.FALSE:src.OdA.TRUE}};return accessor.get(src.wTY).syncExecuteCommand(SetStyleCommand.id,setStyleParams)}},SetItalicCommand={type:src.g4t.COMMAND,id:"sheet.command.set-italic",handler:accessor=>{const selection=accessor.get(selection_service_SheetsSelectionsService).getCurrentLastSelection();if(!selection)return!1;const target=target_util_getSheetCommandTarget(accessor.get(src.HCr));if(!target)return!1;const{worksheet}=target;let currentlyItalic=!0;if(selection.primary){const{startRow,startColumn}=selection.primary;currentlyItalic=worksheet.getRange(startRow,startColumn).getFontStyle()===src.YfY.ITALIC}const setStyleParams={style:{type:"it",value:currentlyItalic?src.OdA.FALSE:src.OdA.TRUE}};return accessor.get(src.wTY).syncExecuteCommand(SetStyleCommand.id,setStyleParams)}},SetUnderlineCommand={type:src.g4t.COMMAND,id:"sheet.command.set-underline",handler:accessor=>{const selection=accessor.get(selection_service_SheetsSelectionsService).getCurrentLastSelection();if(!selection)return!1;const target=target_util_getSheetCommandTarget(accessor.get(src.HCr));if(!target)return!1;const{worksheet}=target;let currentlyUnderline=!0;selection.primary&&(currentlyUnderline=!!worksheet.getRange(selection.primary.startRow,selection.primary.startColumn).getUnderline().s);const setStyleParams={style:{type:"ul",value:{s:currentlyUnderline?src.OdA.FALSE:src.OdA.TRUE}}};return accessor.get(src.wTY).syncExecuteCommand(SetStyleCommand.id,setStyleParams)}},SetStrikeThroughCommand={type:src.g4t.COMMAND,id:"sheet.command.set-stroke",handler:accessor=>{const selection=accessor.get(selection_service_SheetsSelectionsService).getCurrentLastSelection();if(!selection)return!1;const target=target_util_getSheetCommandTarget(accessor.get(src.HCr));if(!target)return!1;const{worksheet}=target;let currentlyStrokeThrough=!0;selection.primary&&(currentlyStrokeThrough=!!worksheet.getRange(selection.primary.actualRow,selection.primary.actualColumn).getStrikeThrough().s);const setStyleParams={style:{type:"st",value:{s:currentlyStrokeThrough?src.OdA.FALSE:src.OdA.TRUE}}};return accessor.get(src.wTY).syncExecuteCommand(SetStyleCommand.id,setStyleParams)}},SetFontFamilyCommand=(src.g4t.COMMAND,{type:src.g4t.COMMAND,id:"sheet.command.set-font-family",handler:(accessor,params)=>{if(!params)return!1;const commandService=accessor.get(src.wTY),setStyleParams={style:{type:"ff",value:params.value}};return commandService.syncExecuteCommand(SetStyleCommand.id,setStyleParams)}}),SetFontSizeCommand={type:src.g4t.COMMAND,id:"sheet.command.set-font-size",handler:(accessor,params)=>{if(!params)return!1;const commandService=accessor.get(src.wTY),setStyleParams={style:{type:"fs",value:params.value}};return commandService.syncExecuteCommand(SetStyleCommand.id,setStyleParams)}},SetTextColorCommand={type:src.g4t.COMMAND,id:"sheet.command.set-text-color",handler:(accessor,params)=>{if(!params)return!1;const commandService=accessor.get(src.wTY),setStyleParams={style:{type:"cl",value:{rgb:params.value}}};return commandService.syncExecuteCommand(SetStyleCommand.id,setStyleParams)}},ResetTextColorCommand={type:src.g4t.COMMAND,id:"sheet.command.reset-text-color",handler:accessor=>accessor.get(src.wTY).syncExecuteCommand(SetStyleCommand.id,{style:{type:"cl",value:{rgb:null}}})},SetBackgroundColorCommand={type:src.g4t.COMMAND,id:"sheet.command.set-background-color",handler:(accessor,params)=>{if(!params||!params.value)return!1;const commandService=accessor.get(src.wTY),setStyleParams={style:{type:"bg",value:{rgb:params.value}}};return commandService.syncExecuteCommand(SetStyleCommand.id,setStyleParams)}},ResetBackgroundColorCommand={type:src.g4t.COMMAND,id:"sheet.command.reset-background-color",handler:accessor=>accessor.get(src.wTY).syncExecuteCommand(SetStyleCommand.id,{style:{type:"bg",value:{rgb:null}}})},SetVerticalTextAlignCommand={type:src.g4t.COMMAND,id:"sheet.command.set-vertical-text-align",handler:(accessor,params)=>{if(!params)return!1;const commandService=accessor.get(src.wTY),setStyleParams={unitId:params.unitId,subUnitId:params.subUnitId,range:params.range,style:{type:"vt",value:params.value}};return commandService.syncExecuteCommand(SetStyleCommand.id,setStyleParams)}},SetHorizontalTextAlignCommand={type:src.g4t.COMMAND,id:"sheet.command.set-horizontal-text-align",handler:(accessor,params)=>{if(!params)return!1;const commandService=accessor.get(src.wTY),setStyleParams={unitId:params.unitId,subUnitId:params.subUnitId,range:params.range,style:{type:"ht",value:params.value}};return commandService.syncExecuteCommand(SetStyleCommand.id,setStyleParams)}},SetTextWrapCommand={type:src.g4t.COMMAND,id:"sheet.command.set-text-wrap",handler:(accessor,params)=>{if(!params)return!1;const commandService=accessor.get(src.wTY),setStyleParams={unitId:params.unitId,subUnitId:params.subUnitId,range:params.range,style:{type:"tb",value:params.value}};return commandService.syncExecuteCommand(SetStyleCommand.id,setStyleParams)}},SetTextRotationCommand={type:src.g4t.COMMAND,id:"sheet.command.set-text-rotation",handler:(accessor,params)=>{if(!params)return!1;const value="number"==typeof params.value?{a:params.value}:{a:0,v:src.OdA.TRUE},commandService=accessor.get(src.wTY),setStyleParams={unitId:params.unitId,subUnitId:params.subUnitId,range:params.range,style:{type:"tr",value}};return commandService.syncExecuteCommand(SetStyleCommand.id,setStyleParams)}},SetTabColorMutation={id:"sheet.mutation.set-tab-color",type:src.g4t.MUTATION,handler:(accessor,params)=>{const workbook=accessor.get(src.HCr).getUniverSheetInstance(params.unitId);if(!workbook)return!1;const worksheet=workbook.getSheetBySheetId(params.subUnitId);return!!worksheet&&(worksheet.getConfig().tabColor=params.color,!0)}},SetTabColorCommand={type:src.g4t.COMMAND,id:"sheet.command.set-tab-color",handler:(accessor,params)=>{const commandService=accessor.get(src.wTY),undoRedoService=accessor.get(src.$Dz),target=target_util_getSheetCommandTarget(accessor.get(src.HCr));if(!target)return!1;const{unitId,subUnitId}=target,setTabColorMutationParams={color:params.value,unitId,subUnitId},undoMutationParams=((accessor,params)=>{const oldTabColor=accessor.get(src.HCr).getUniverSheetInstance(params.unitId).getSheetBySheetId(params.subUnitId).getConfig().tabColor;return{...src.S0q.deepClone(params),color:oldTabColor}})(accessor,setTabColorMutationParams);return!!commandService.syncExecuteCommand(SetTabColorMutation.id,setTabColorMutationParams)&&(undoRedoService.pushUndoRedo({unitID:unitId,undoMutations:[{id:SetTabColorMutation.id,params:undoMutationParams}],redoMutations:[{id:SetTabColorMutation.id,params:setTabColorMutationParams}]}),!0)}},SetWorkbookNameMutation={id:"sheet.mutation.set-workbook-name",type:src.g4t.MUTATION,handler:(accessor,params)=>{const workbook=accessor.get(src.HCr).getUnit(params.unitId,src.Zy$.UNIVER_SHEET);return!!workbook&&(workbook.setName(params.name),!0)}},SetWorkbookNameCommand={type:src.g4t.COMMAND,id:"sheet.command.set-workbook-name",handler:async(accessor,params)=>{if(!accessor.get(src.HCr).getUnit(params.unitId,src.Zy$.UNIVER_SHEET))return!1;const interceptedCommands=accessor.get(SheetInterceptorService).onCommandExecute({id:SetWorkbookNameCommand.id,params}),redoMutationParams={name:params.name,unitId:params.unitId},redos=[...interceptedCommands.preRedos??[],{id:SetWorkbookNameMutation.id,params:redoMutationParams},...interceptedCommands.redos],commandService=accessor.get(src.wTY);return(0,src.PkI)(redos,commandService).result}},SetWorksheetActiveOperation={id:"sheet.operation.set-worksheet-active",type:src.g4t.OPERATION,handler:(accessor,params)=>{const workbook=accessor.get(src.HCr).getUniverSheetInstance(params.unitId);if(!workbook)return!1;const worksheets=workbook.getWorksheets();for(const[,worksheet]of worksheets)if(worksheet.getSheetId()===params.subUnitId)return workbook.setActiveSheet(worksheet),!0;return!1}},SetWorksheetActivateCommand={type:src.g4t.COMMAND,id:"sheet.command.set-worksheet-activate",handler:(accessor,params,options)=>{const commandService=accessor.get(src.wTY),target=target_util_getSheetCommandTarget(accessor.get(src.HCr),params);if(!target)return!1;const{unitId,subUnitId}=target;return new Promise((resolve=>{setTimeout((()=>{const result=commandService.syncExecuteCommand(SetWorksheetActiveOperation.id,{unitId,subUnitId},options);resolve(result)}),4)}))}},SetWorksheetColWidthMutationFactory=(params,worksheet)=>{const{unitId,subUnitId,ranges}=params,colWidth={},manager=worksheet.getColumnManager();for(let i=0;i<ranges.length;i++){const range=ranges[i];for(let j=range.startColumn;j<range.endColumn+1;j++){const column=manager.getColumnOrCreate(j);colWidth[j]=column.w}}return{unitId,subUnitId,ranges,colWidth}},SetWorksheetColWidthMutation={id:"sheet.mutation.set-worksheet-col-width",type:src.g4t.MUTATION,handler:(accessor,params)=>{const target=target_util_getSheetCommandTarget(accessor.get(src.HCr),params);if(!target)return!1;const{worksheet}=target,defaultColumnWidth=worksheet.getConfig().defaultColumnWidth,manager=worksheet.getColumnManager(),ranges=params.ranges;for(let i=0;i<ranges.length;i++){const range=ranges[i];for(let j=range.startColumn;j<range.endColumn+1;j++){if(!worksheet.getColVisible(j))continue;const column=manager.getColumnOrCreate(j);"number"==typeof params.colWidth?column.w=params.colWidth:column.w=params.colWidth[j]??defaultColumnWidth}}return!0}},DeltaColumnWidthCommand={type:src.g4t.COMMAND,id:"sheet.command.delta-column-width",handler:async(accessor,params)=>{const selections=accessor.get(selection_service_SheetsSelectionsService).getCurrentSelections();if(!selections?.length)return!1;const commandService=accessor.get(src.wTY),undoRedoService=accessor.get(src.$Dz),target=target_util_getSheetCommandTarget(accessor.get(src.HCr));if(!target)return!1;const{worksheet,unitId,subUnitId}=target,{anchorCol,deltaX}=params,destColumnWidth=worksheet.getColumnWidth(anchorCol)+deltaX,isAllSheetRange=1===selections.length&&selections[0].range.rangeType===src.$uV.ALL,colSelections=selections.filter((s=>s.range.rangeType===src.$uV.COLUMN)),rangeType=isAllSheetRange?src.$uV.ALL:colSelections.some((({range})=>{const{startColumn,endColumn}=range;return startColumn<=anchorCol&&anchorCol<=endColumn}))?src.$uV.COLUMN:src.$uV.NORMAL;let redoMutationParams;if(rangeType===src.$uV.ALL){const rowCount=worksheet.getRowCount();redoMutationParams={subUnitId,unitId,colWidth:destColumnWidth,ranges:new Array(worksheet.getColumnCount()).fill(void 0).map(((_,index)=>({startRow:0,endRow:rowCount-1,startColumn:index,endColumn:index})))}}else redoMutationParams=rangeType===src.$uV.COLUMN?{subUnitId,unitId,ranges:colSelections.map((s=>src.M_G.clone(s.range))),colWidth:destColumnWidth}:{subUnitId,unitId,colWidth:destColumnWidth,ranges:[{startRow:0,endRow:worksheet.getMaxRows()-1,startColumn:anchorCol,endColumn:anchorCol}]};const{undos,redos}=accessor.get(SheetInterceptorService).onCommandExecute({id:DeltaColumnWidthCommand.id,params:redoMutationParams}),undoMutationParams=SetWorksheetColWidthMutationFactory(redoMutationParams,worksheet),setColWidthResult=commandService.syncExecuteCommand(SetWorksheetColWidthMutation.id,redoMutationParams),result=(0,src.PkI)([...redos],commandService);return!setColWidthResult||!result.result||(undoRedoService.pushUndoRedo({unitID:unitId,undoMutations:[{id:SetWorksheetColWidthMutation.id,params:undoMutationParams},...undos],redoMutations:[{id:SetWorksheetColWidthMutation.id,params:redoMutationParams},...redos]}),!0)}},SetColWidthCommand={type:src.g4t.COMMAND,id:"sheet.command.set-worksheet-col-width",handler:(accessor,params)=>{const selectionManagerService=accessor.get(selection_service_SheetsSelectionsService),commandService=accessor.get(src.wTY),undoRedoService=accessor.get(src.$Dz),sheetInterceptorService=accessor.get(SheetInterceptorService),selections=params?.ranges?.length?params.ranges:selectionManagerService.getCurrentSelections()?.map((s=>s.range));if(!selections?.length)return!1;const target=target_util_getSheetCommandTarget(accessor.get(src.HCr),params);if(!target)return!1;const{subUnitId,unitId,worksheet}=target,redoMutationParams={subUnitId,unitId,ranges:selections,colWidth:params.value},undoMutationParams=SetWorksheetColWidthMutationFactory(redoMutationParams,worksheet),setColWidthResult=commandService.syncExecuteCommand(SetWorksheetColWidthMutation.id,redoMutationParams),{undos,redos}=accessor.get(SheetInterceptorService).onCommandExecute({id:SetColWidthCommand.id,params:redoMutationParams}),intercepted=sheetInterceptorService.onCommandExecute({id:SetColWidthCommand.id,params:redoMutationParams}),result=(0,src.PkI)([...redos,...intercepted.redos],commandService);return!(!setColWidthResult||!result.result)&&(undoRedoService.pushUndoRedo({unitID:unitId,undoMutations:[...intercepted.preUndos??[],{id:SetWorksheetColWidthMutation.id,params:undoMutationParams},...undos],redoMutations:[...intercepted.preRedos??[],{id:SetWorksheetColWidthMutation.id,params:redoMutationParams},...redos]}),!0)}},SetWorksheetColIsAutoWidthCommand={type:src.g4t.COMMAND,id:"sheet.command.set-col-is-auto-width",handler:async(accessor,params)=>{const commandService=accessor.get(src.wTY),undoRedoService=accessor.get(src.$Dz),selectionManagerService=accessor.get(selection_service_SheetsSelectionsService),target=target_util_getSheetCommandTarget(accessor.get(src.HCr),params);if(!target)return!1;const{unitId,subUnitId}=target;let ranges=[];if(params?.ranges)ranges=[...params.ranges];else{const selections=selectionManagerService.getCurrentSelections();for(let i=0;i<selections.length;i++)ranges.push(selections[i].range)}if(!ranges?.length)return!1;const redoMutationParams={unitId,subUnitId,ranges},{undos,redos}=accessor.get(SheetInterceptorService).onCommandExecute({id:SetWorksheetColIsAutoWidthCommand.id,params:redoMutationParams});return!!(0,src.PkI)([...redos],commandService).result&&(undoRedoService.pushUndoRedo({unitID:unitId,undoMutations:[...undos],redoMutations:[...redos]}),!0)}},SetWorksheetDefaultStyleMutation={id:"sheet.mutation.set-worksheet-default-style",type:src.g4t.MUTATION,handler:(accessor,params)=>{const{defaultStyle}=params,target=target_util_getSheetCommandTarget(accessor.get(src.HCr));if(!target)return!1;const{worksheet}=target;return!!worksheet&&(worksheet.setDefaultCellStyle(defaultStyle),!0)}},SetWorksheetDefaultStyleCommand={type:src.g4t.COMMAND,id:"sheet.command.set-worksheet-default-style",handler:(accessor,params)=>{const commandService=accessor.get(src.wTY),undoRedoService=accessor.get(src.$Dz),{unitId}=params,undoMutationParams=((accessor,params)=>{const target=target_util_getSheetMutationTarget(accessor.get(src.HCr),params);if(!target)throw new Error("[SetWorksheetDefaultStyleMutationFactory]: worksheet is null error!");const{worksheet}=target;return{unitId:params.unitId,subUnitId:worksheet.getSheetId(),defaultStyle:worksheet.getDefaultCellStyle()}})(accessor,params);return!!commandService.syncExecuteCommand(SetWorksheetDefaultStyleMutation.id,params)&&(undoRedoService.pushUndoRedo({unitID:unitId,undoMutations:[{id:SetWorksheetDefaultStyleMutation.id,params:undoMutationParams}],redoMutations:[{id:SetWorksheetDefaultStyleMutation.id,params}]}),!0)}},SetWorksheetHideMutationFactory=(accessor,params)=>{const target=target_util_getSheetMutationTarget(accessor.get(src.HCr),params);if(!target)throw new Error("[SetWorksheetHideMutationFactory]: worksheet is null error!");const{worksheet}=target;return{hidden:worksheet.isSheetHidden(),unitId:params.unitId,subUnitId:worksheet.getSheetId()}},SetWorksheetHideMutation={id:"sheet.mutation.set-worksheet-hidden",type:src.g4t.MUTATION,handler:(accessor,params)=>{const universheet=accessor.get(src.HCr).getUniverSheetInstance(params.unitId);if(null==universheet)return!1;const worksheet=universheet.getSheetBySheetId(params.subUnitId);return!!worksheet&&(worksheet.getConfig().hidden=params.hidden,!0)}},SetWorksheetHideCommand={type:src.g4t.COMMAND,id:"sheet.command.set-worksheet-hidden",handler:(accessor,params)=>{const commandService=accessor.get(src.wTY),undoRedoService=accessor.get(src.$Dz),errorService=accessor.get(src.IvX),localeService=accessor.get(src.iH9),target=target_util_getSheetCommandTarget(accessor.get(src.HCr),params);if(!target)return!1;const{workbook,worksheet,unitId,subUnitId}=target;if(worksheet.getConfig().hidden===src.OdA.TRUE)return!1;const redoMutationParams={unitId,subUnitId,hidden:src.OdA.TRUE},undoMutationParams=SetWorksheetHideMutationFactory(accessor,redoMutationParams);if(1===workbook.getSheets().filter((sheet=>sheet.getConfig().hidden===src.OdA.FALSE)).length)return errorService.emit(localeService.t("sheets.info.hideSheet")),!1;return!!commandService.syncExecuteCommand(SetWorksheetHideMutation.id,redoMutationParams)&&(undoRedoService.pushUndoRedo({unitID:unitId,undoMutations:[{id:SetWorksheetHideMutation.id,params:undoMutationParams}],redoMutations:[{id:SetWorksheetHideMutation.id,params:redoMutationParams}]}),!0)}},SetWorksheetNameMutation={id:"sheet.mutation.set-worksheet-name",type:src.g4t.MUTATION,handler:(accessor,params)=>{const universheet=accessor.get(src.HCr).getUniverSheetInstance(params.unitId);if(null==universheet)return!1;const worksheet=universheet.getSheetBySheetId(params.subUnitId);return!!worksheet&&(worksheet.getConfig().name=params.name,!0)}},SetWorksheetNameCommand={type:src.g4t.COMMAND,id:"sheet.command.set-worksheet-name",handler:(accessor,params)=>{const commandService=accessor.get(src.wTY),undoRedoService=accessor.get(src.$Dz),sheetInterceptorService=accessor.get(SheetInterceptorService),target=target_util_getSheetCommandTarget(accessor.get(src.HCr),params);if(!target)return!1;const{unitId,subUnitId}=target,redoMutationParams={subUnitId,name:params.name,unitId},undoMutationParams=((accessor,params)=>{const target=target_util_getSheetMutationTarget(accessor.get(src.HCr),params);if(!target)throw new Error("[SetWorksheetNameMutationFactory]: worksheet is null error!");const{worksheet}=target;return{unitId:params.unitId,name:worksheet.getName(),subUnitId:worksheet.getSheetId()}})(accessor,redoMutationParams),interceptorCommands=sheetInterceptorService.onCommandExecute({id:SetWorksheetNameCommand.id,params}),redos=[...interceptorCommands.preRedos??[],{id:SetWorksheetNameMutation.id,params:redoMutationParams},...interceptorCommands.redos],undos=[...interceptorCommands.preUndos??[],{id:SetWorksheetNameMutation.id,params:undoMutationParams},...interceptorCommands.undos];return!!(0,src.PkI)(redos,commandService).result&&(undoRedoService.pushUndoRedo({unitID:unitId,undoMutations:undos,redoMutations:redos}),!0)}},SetWorksheetOrderMutation={id:"sheet.mutation.set-worksheet-order",type:src.g4t.MUTATION,handler:(accessor,params)=>{const workbook=accessor.get(src.HCr).getUniverSheetInstance(params.unitId);if(!workbook)return!1;const config=workbook.getConfig();return config.sheetOrder.splice(params.fromOrder,1),config.sheetOrder.splice(params.toOrder,0,params.subUnitId),!0}},SetWorksheetOrderCommand={type:src.g4t.COMMAND,id:"sheet.command.set-worksheet-order",handler:(accessor,params)=>{const commandService=accessor.get(src.wTY),undoRedoService=accessor.get(src.$Dz),target=target_util_getSheetCommandTarget(accessor.get(src.HCr),params);if(!target)return!1;const{workbook,unitId,subUnitId}=target,setWorksheetOrderMutationParams={fromOrder:workbook.getConfig().sheetOrder.indexOf(subUnitId),toOrder:params.order,unitId,subUnitId},undoMutationParams=((accessor,params)=>({...src.S0q.deepClone(params),toOrder:params.fromOrder,fromOrder:params.toOrder}))(0,setWorksheetOrderMutationParams);return!!commandService.syncExecuteCommand(SetWorksheetOrderMutation.id,setWorksheetOrderMutationParams)&&(undoRedoService.pushUndoRedo({unitID:unitId,undoMutations:[{id:SetWorksheetOrderMutation.id,params:undoMutationParams}],redoMutations:[{id:SetWorksheetOrderMutation.id,params:setWorksheetOrderMutationParams}]}),!0)}};class WorksheetProtectionPointModel{addRule(rule){this._ensureSubUnitMap(rule.unitId).set(rule.subUnitId,rule),this._pointChange.next(rule)}deleteRule(unitId,subUnitId){const rule=this._model.get(unitId)?.get(subUnitId);rule&&(this._model?.get(unitId)?.delete(subUnitId),this._pointChange.next(rule))}getRule(unitId,subUnitId){return this._model?.get(unitId)?.get(subUnitId)}toObject(){const result={};return[...this._model.keys()].forEach((unitId=>{const subUnitMap=this._model.get(unitId);if(subUnitMap?.size){result[unitId]=[];[...subUnitMap.keys()].forEach((subUnitId=>{const rule=subUnitMap.get(subUnitId);rule&&result[unitId].push(rule)}))}})),result}fromObject(obj){const result=new Map;Object.keys(obj).forEach((unitId=>{const subUnitList=obj[unitId];if(subUnitList?.length){const subUnitMap=new Map;subUnitList.forEach((rule=>{subUnitMap.set(rule.subUnitId,rule)})),result.set(unitId,subUnitMap)}})),this._model=result}deleteUnitModel(unitId){this._model.delete(unitId)}_ensureSubUnitMap(unitId){let subUnitMap=this._model.get(unitId);return subUnitMap||(subUnitMap=new Map,this._model.set(unitId,subUnitMap)),subUnitMap}getTargetByPermissionId(unitId,permissionId){const subUnitMap=this._model.get(unitId);if(!subUnitMap)return null;for(const[subUnitId,rule]of subUnitMap)if(rule.permissionId===permissionId)return[unitId,subUnitId]}constructor(){this._model=new Map,this._pointChange=new Subject.B,this.pointChange$=this._pointChange.asObservable()}}class RangeProtectionPermissionDeleteProtectionPoint{constructor(unitId,subUnitId,permissionId){this.type=es._m.SelectRange,this.subType=es.pS.Delete,this.status=src.W2c.INIT,this.value=!0,this.unitId=unitId,this.subUnitId=subUnitId,this.permissionId=permissionId,this.id=`${es._m.SelectRange}.${es.pS.Delete}.${permissionId}`}}class RangeProtectionPermissionManageCollaPoint{constructor(unitId,subUnitId,permissionId){this.type=es._m.SelectRange,this.subType=es.pS.ManageCollaborator,this.status=src.W2c.INIT,this.value=!0,this.unitId=unitId,this.subUnitId=subUnitId,this.permissionId=permissionId,this.id=`${es._m.SelectRange}.${es.pS.ManageCollaborator}.${permissionId}`}}const getAllRangePermissionPoint=()=>[RangeProtectionPermissionViewPoint,edit_RangeProtectionPermissionEditPoint,RangeProtectionPermissionManageCollaPoint,RangeProtectionPermissionDeleteProtectionPoint],baseProtectionActions=[es.pS.Edit,es.pS.View,es.pS.ManageCollaborator,es.pS.Delete],getAllWorkbookPermissionPoint=()=>[editable_WorkbookEditablePermission,WorkbookPrintPermission,WorkbookCommentPermission,WorkbookViewPermission,WorkbookCopyPermission,WorkbookExportPermission,WorkbookManageCollaboratorPermission,WorkbookCreateSheetPermission,WorkbookDeleteSheetPermission,WorkbookRenameSheetPermission,WorkbookHideSheetPermission,WorkbookDuplicatePermission,WorkbookSharePermission,WorkbookMoveSheetPermission,WorkbookCopySheetPermission,WorkbookViewHistoryPermission,WorkbookRecoverHistoryPermission,WorkbookCreateProtectPermission],defaultWorkbookPermissionPoints=[es.pS.Edit,es.pS.Print,es.pS.Comment,es.pS.View,es.pS.Copy,es.pS.Export,es.pS.ManageCollaborator,es.pS.CreateSheet,es.pS.DeleteSheet,es.pS.RenameSheet,es.pS.HideSheet,es.pS.Duplicate,es.pS.Share,es.pS.MoveSheet,es.pS.CopySheet,es.pS.RecoverHistory,es.pS.ViewHistory,es.pS.CreatePermissionObject],getAllWorksheetPermissionPoint=()=>[edit_WorksheetEditPermission,WorksheetViewPermission,WorksheetManageCollaboratorPermission,WorksheetDeleteProtectionPermission],getAllWorksheetPermissionPointByPointPanel=()=>[WorksheetCopyPermission,WorksheetDeleteColumnPermission,WorksheetDeleteRowPermission,WorksheetEditExtraObjectPermission,WorksheetFilterPermission,WorksheetInsertColumnPermission,WorksheetInsertRowPermission,WorksheetInsertHyperlinkPermission,WorksheetPivotTablePermission,WorksheetSetCellStylePermission,WorksheetSetCellValuePermission,WorksheetSetColumnStylePermission,WorksheetSetRowStylePermission,WorksheetSortPermission],defaultWorksheetPermissionPoint=[es.pS.Copy,es.pS.DeleteColumn,es.pS.DeleteRow,es.pS.EditExtraObject,es.pS.Filter,es.pS.InsertColumn,es.pS.InsertRow,es.pS.InsertHyperlink,es.pS.PivotTable,es.pS.SetCellStyle,es.pS.SetCellValue,es.pS.SetColumnStyle,es.pS.SetRowStyle,es.pS.Sort];function worksheet_permission_service_ts_metadata(k,v){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(k,v)}function worksheet_permission_service_ts_param(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}}class WorksheetPermissionService extends src.hy_{constructor(_permissionService,_univerInstanceService,_injector,_worksheetProtectionRuleModel,_worksheetProtectionPointRuleModel,_resourceManagerService,_rangeProtectionRuleModel,_logService){super(),this._permissionService=_permissionService,this._univerInstanceService=_univerInstanceService,this._injector=_injector,this._worksheetProtectionRuleModel=_worksheetProtectionRuleModel,this._worksheetProtectionPointRuleModel=_worksheetProtectionPointRuleModel,this._resourceManagerService=_resourceManagerService,this._rangeProtectionRuleModel=_rangeProtectionRuleModel,this._logService=_logService,this._init(),this._initRuleChange(),this._initRuleSnapshot(),this._initPointSnapshot()}_init(){const handleWorkbook=workbook=>{const unitId=workbook.getUnitId(),handleWorksheet=worksheet=>{const subUnitId=worksheet.getSheetId();[...getAllWorksheetPermissionPoint(),...getAllWorksheetPermissionPointByPointPanel()].forEach((F=>{const instance=new F(unitId,subUnitId);this._permissionService.addPermissionPoint(instance)})),this._logService.debug("[WorksheetPermissionService]","Initialization completed",unitId,subUnitId)};workbook.getSheets().forEach((worksheet=>{handleWorksheet(worksheet)})),workbook.sheetCreated$.subscribe((worksheet=>{handleWorksheet(worksheet)})),workbook.sheetDisposed$.subscribe((worksheet=>{const subUnitId=worksheet.getSheetId();this._rangeProtectionRuleModel.getSubunitRuleList(unitId,subUnitId).forEach((rule=>{[...getAllRangePermissionPoint()].forEach((F=>{const instance=new F(unitId,subUnitId,rule.permissionId);this._permissionService.deletePermissionPoint(instance.id)}))})),[...getAllWorksheetPermissionPoint(),...getAllWorksheetPermissionPointByPointPanel()].forEach((F=>{const instance=new F(unitId,subUnitId);this._permissionService.deletePermissionPoint(instance.id)}))}))};this._univerInstanceService.getAllUnitsForType(src.Zy$.UNIVER_SHEET).forEach((workbook=>{handleWorkbook(workbook)})),this._univerInstanceService.getTypeOfUnitAdded$(src.Zy$.UNIVER_SHEET).pipe((0,takeUntil.Q)(this.dispose$)).subscribe(handleWorkbook),this._univerInstanceService.getTypeOfUnitDisposed$(src.Zy$.UNIVER_SHEET).pipe((0,takeUntil.Q)(this.dispose$)).subscribe((workbook=>{workbook.getSheets().forEach((worksheet=>{const unitId=workbook.getUnitId(),subUnitId=worksheet.getSheetId();getAllWorksheetPermissionPoint().forEach((F=>{const instance=new F(unitId,subUnitId);this._permissionService.deletePermissionPoint(instance.id)}))}))}))}_initRuleChange(){this.disposeWithMe(this._worksheetProtectionRuleModel.ruleChange$.subscribe((info=>{switch(info.type){case"add":break;case"delete":getAllWorksheetPermissionPoint().forEach((F=>{const instance=new F(info.unitId,info.subUnitId);this._permissionService.updatePermissionPoint(instance.id,!0)}));break;case"set":getAllWorksheetPermissionPoint().forEach((F=>{const instance=new F(info.unitId,info.subUnitId);this._permissionService.updatePermissionPoint(instance.id,info.rule)}))}})))}_initRuleSnapshot(){this.disposeWithMe(this._resourceManagerService.registerPluginResource({toJson:()=>{const object=this._worksheetProtectionRuleModel.toObject();return JSON.stringify(object)},parseJson:json=>{if(!json)return{};try{return JSON.parse(json)}catch(err){return{}}},pluginName:"SHEET_WORKSHEET_PROTECTION_PLUGIN",businesses:[es.Wh.UNIVER_SHEET],onLoad:(unitId,resources)=>{this._worksheetProtectionRuleModel.fromObject(resources),Object.keys(resources).forEach((subUnitId=>{getAllWorksheetPermissionPoint().forEach((F=>{const instance=new F(unitId,subUnitId);instance.value=!1,this._permissionService.addPermissionPoint(instance)}))})),this._worksheetProtectionRuleModel.changeRuleInitState(!0)},onUnLoad:unitId=>{const workbook=this._univerInstanceService.getUnit(unitId);workbook&&(workbook.getSheets().forEach((worksheet=>{const subUnitId=worksheet.getSheetId();[...getAllWorksheetPermissionPoint(),...getAllWorksheetPermissionPointByPointPanel()].forEach((F=>{const instance=new F(unitId,subUnitId);this._permissionService.deletePermissionPoint(instance.id)}))})),getAllWorkbookPermissionPoint().forEach((F=>{const instance=new F(unitId);this._permissionService.deletePermissionPoint(instance.id)}))),this._worksheetProtectionRuleModel.deleteUnitModel(unitId)}}))}_initPointSnapshot(){this.disposeWithMe(this._resourceManagerService.registerPluginResource({toJson:()=>{const object=this._worksheetProtectionPointRuleModel.toObject();return JSON.stringify(object)},parseJson:json=>{if(!json)return{};try{return JSON.parse(json)}catch(err){return{}}},pluginName:"SHEET_WORKSHEET_PROTECTION_POINT_PLUGIN",businesses:[es.Wh.UNIVER_SHEET],onLoad:(unitId,resources)=>{this._worksheetProtectionPointRuleModel.fromObject(resources),Object.keys(resources).forEach((subUnitId=>{getAllWorksheetPermissionPointByPointPanel().forEach((F=>{const instance=new F(unitId,subUnitId);this._permissionService.addPermissionPoint(instance)}))}))},onUnLoad:unitId=>{this._worksheetProtectionPointRuleModel.deleteUnitModel(unitId)}}))}}WorksheetPermissionService=function worksheet_permission_service_ts_decorate(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r}([worksheet_permission_service_ts_param(0,(0,src.y_5)(src.QWp)),worksheet_permission_service_ts_param(1,(0,src.y_5)(src.HCr)),worksheet_permission_service_ts_param(2,(0,src.y_5)(src.zZn)),worksheet_permission_service_ts_param(3,(0,src.y_5)(WorksheetProtectionRuleModel)),worksheet_permission_service_ts_param(4,(0,src.y_5)(WorksheetProtectionPointModel)),worksheet_permission_service_ts_param(5,(0,src.y_5)(src.Gvw)),worksheet_permission_service_ts_param(6,(0,src.y_5)(range_protection_rule_model_RangeProtectionRuleModel)),worksheet_permission_service_ts_param(7,(0,src.y_5)(src.rrK)),worksheet_permission_service_ts_metadata("design:type",Function),worksheet_permission_service_ts_metadata("design:paramtypes",[void 0===src.QWp?Object:src.QWp,void 0===src.HCr?Object:src.HCr,void 0===src.zZn?Object:src.zZn,void 0===WorksheetProtectionRuleModel?Object:WorksheetProtectionRuleModel,void 0===WorksheetProtectionPointModel?Object:WorksheetProtectionPointModel,void 0===src.Gvw?Object:src.Gvw,void 0===range_protection_rule_model_RangeProtectionRuleModel?Object:range_protection_rule_model_RangeProtectionRuleModel,void 0===src.rrK?Object:src.rrK])],WorksheetPermissionService);const SetWorksheetPermissionPointsMutation={id:"sheet.mutation.set-worksheet-permission-points",type:src.g4t.MUTATION,handler:(accessor,params)=>{const{rule}=params;return accessor.get(WorksheetProtectionPointModel).addRule(rule),!0}},SetWorksheetPermissionPointsCommand={type:src.g4t.COMMAND,id:"sheet.command.set-worksheet-permission-points",async handler(accessor,params){if(!params)return!1;const commandService=accessor.get(src.wTY),{rule}=params;return commandService.executeCommand(SetWorksheetPermissionPointsMutation.id,{rule,unitId:rule.unitId,subUnitId:rule.subUnitId}),!0}},SetWorksheetProtectionCommand={type:src.g4t.COMMAND,id:"sheet.command.set-worksheet-protection",async handler(accessor,params){if(!params)return!1;const commandService=accessor.get(src.wTY),undoRedoService=accessor.get(src.$Dz),{rule,permissionId,oldRule}=params,{unitId,subUnitId}=rule,newRule={...rule,permissionId};if(await commandService.executeCommand(SetWorksheetProtectionMutation.id,{unitId,subUnitId,newRule})){const redoMutations=[{id:SetWorksheetProtectionMutation.id,params:{unitId,subUnitId,newRule}}],undoMutations=[{id:SetWorksheetProtectionMutation.id,params:{unitId,subUnitId,rule:oldRule}}];undoRedoService.pushUndoRedo({unitID:unitId,redoMutations,undoMutations})}return!0}},SetWorksheetRowHeightMutationFactory=(params,worksheet)=>{const{unitId,subUnitId,ranges}=params,rowHeight={},manager=worksheet.getRowManager();for(const{startRow,endRow}of ranges)for(let rowIndex=startRow;rowIndex<endRow+1;rowIndex++){const row=manager.getRowOrCreate(rowIndex);rowHeight[rowIndex]=row.h}return{unitId,subUnitId,ranges,rowHeight}},SetWorksheetRowIsAutoHeightMutationFactory=(params,worksheet)=>{const{unitId,subUnitId,ranges}=params,autoHeightHash={},manager=worksheet.getRowManager();for(const{startRow,endRow}of ranges)for(let rowIndex=startRow;rowIndex<=endRow;rowIndex++){const row=manager.getRowOrCreate(rowIndex);autoHeightHash[rowIndex]=row.ia}return{unitId,subUnitId,ranges,autoHeightInfo:autoHeightHash}},SetWorksheetRowAutoHeightMutationFactory=(params,worksheet)=>{const{unitId,subUnitId,rowsAutoHeightInfo}=params,results=[],manager=worksheet.getRowManager();for(const rowInfo of rowsAutoHeightInfo){const{row}=rowInfo,{ah}=manager.getRowOrCreate(row);results.push({row,autoHeight:ah})}return{unitId,subUnitId,rowsAutoHeightInfo:results}},SetWorksheetRowHeightMutation={id:"sheet.mutation.set-worksheet-row-height",type:src.g4t.MUTATION,handler:(accessor,params)=>{const{ranges,rowHeight}=params,target=target_util_getSheetCommandTarget(accessor.get(src.HCr),params);if(!target)return!1;const{worksheet}=target,manager=worksheet.getRowManager(),defaultRowHeight=worksheet.getConfig().defaultRowHeight;for(const{startRow,endRow}of ranges)for(let rowIndex=startRow;rowIndex<=endRow;rowIndex++){const row=manager.getRowOrCreate(rowIndex);row.h="number"==typeof rowHeight?rowHeight:rowHeight[rowIndex]??defaultRowHeight,row.h=Math.min(2e3,row.h)}return!0}},SetWorksheetRowIsAutoHeightMutation={id:"sheet.mutation.set-worksheet-row-is-auto-height",type:src.g4t.MUTATION,handler:(accessor,params)=>{const{ranges,autoHeightInfo}=params,target=target_util_getSheetCommandTarget(accessor.get(src.HCr),params);if(!target)return!1;const manager=target.worksheet.getRowManager();for(const{startRow,endRow}of ranges)for(let rowIndex=startRow;rowIndex<=endRow;rowIndex++){const row=manager.getRowOrCreate(rowIndex);row.ia="number"==typeof autoHeightInfo?autoHeightInfo:autoHeightInfo[rowIndex]??void 0}return!0}},SetWorksheetRowAutoHeightMutation={id:"sheet.mutation.set-worksheet-row-auto-height",type:src.g4t.MUTATION,handler:(accessor,params)=>{const{rowsAutoHeightInfo}=params,target=target_util_getSheetCommandTarget(accessor.get(src.HCr),params);if(!target)return!1;const rowManager=target.worksheet.getRowManager();for(const{row,autoHeight}of rowsAutoHeightInfo){rowManager.getRowOrCreate(row).ah=autoHeight}return!0}},DeltaRowHeightCommand={type:src.g4t.COMMAND,id:"sheet.command.delta-row-height",handler:async(accessor,params)=>{const selections=accessor.get(selection_service_SheetsSelectionsService).getCurrentSelections(),sheetInterceptorService=accessor.get(SheetInterceptorService);if(!selections?.length)return!1;const target=target_util_getSheetCommandTarget(accessor.get(src.HCr));if(!target)return!1;const{worksheet,subUnitId,unitId}=target,{anchorRow,deltaY}=params,destRowHeight=worksheet.getRowHeight(anchorRow)+deltaY,isAllSheetRange=1===selections.length&&selections[0].range.rangeType===src.$uV.ALL,rowSelections=selections.filter((s=>s.range.rangeType===src.$uV.ROW)),rangeType=isAllSheetRange?src.$uV.ALL:rowSelections.some((({range})=>{const{startRow,endRow}=range;return startRow<=anchorRow&&anchorRow<=endRow}))?src.$uV.ROW:src.$uV.NORMAL;let redoMutationParams;if(rangeType===src.$uV.ALL){const colCount=worksheet.getColumnCount();redoMutationParams={subUnitId,unitId,rowHeight:destRowHeight,ranges:new Array(worksheet.getRowCount()).fill(void 0).map(((_,index)=>({startRow:index,endRow:index,startColumn:0,endColumn:colCount-1})))}}else redoMutationParams=rangeType===src.$uV.ROW?{subUnitId,unitId,ranges:rowSelections.map((s=>src.M_G.clone(s.range))),rowHeight:destRowHeight}:{subUnitId,unitId,rowHeight:destRowHeight,ranges:[{startRow:anchorRow,endRow:anchorRow,startColumn:0,endColumn:worksheet.getMaxColumns()-1}]};const undoMutationParams=SetWorksheetRowHeightMutationFactory(redoMutationParams,worksheet),redoSetIsAutoHeightParams={unitId,subUnitId,ranges:redoMutationParams.ranges,autoHeightInfo:src.OdA.FALSE},undoSetIsAutoHeightParams=SetWorksheetRowIsAutoHeightMutationFactory(redoSetIsAutoHeightParams,worksheet),commandService=accessor.get(src.wTY),undoRedoService=accessor.get(src.$Dz),intercepted=sheetInterceptorService.onCommandExecute({id:DeltaRowHeightCommand.id,params:redoMutationParams}),result=(0,src.PkI)([{id:SetWorksheetRowHeightMutation.id,params:redoMutationParams},{id:SetWorksheetRowIsAutoHeightMutation.id,params:redoSetIsAutoHeightParams}],commandService),interceptedResult=(0,src.PkI)([...intercepted.redos],commandService);return!(!result.result||!interceptedResult.result)&&(undoRedoService.pushUndoRedo({unitID:unitId,undoMutations:[...intercepted.preUndos??[],{id:SetWorksheetRowHeightMutation.id,params:undoMutationParams},{id:SetWorksheetRowIsAutoHeightMutation.id,params:undoSetIsAutoHeightParams},...intercepted.undos],redoMutations:[...intercepted.preRedos??[],{id:SetWorksheetRowHeightMutation.id,params:redoMutationParams},{id:SetWorksheetRowIsAutoHeightMutation.id,params:redoSetIsAutoHeightParams},...intercepted.redos]}),!0)}},SetRowHeightCommand={type:src.g4t.COMMAND,id:"sheet.command.set-row-height",handler:(accessor,params)=>{const selectionManagerService=accessor.get(selection_service_SheetsSelectionsService),commandService=accessor.get(src.wTY),undoRedoService=accessor.get(src.$Dz),univerInstanceService=accessor.get(src.HCr),sheetInterceptorService=accessor.get(SheetInterceptorService),selections=params?.ranges?.length?params.ranges:selectionManagerService.getCurrentSelections()?.map((s=>s.range));if(!selections?.length)return!1;const target=target_util_getSheetCommandTarget(univerInstanceService,params);if(!target)return!1;const{unitId,subUnitId,worksheet}=target,redoMutationParams={subUnitId,unitId,ranges:selections,rowHeight:params.value},undoMutationParams=SetWorksheetRowHeightMutationFactory(redoMutationParams,worksheet),redoSetIsAutoHeightParams={unitId,subUnitId,ranges:redoMutationParams.ranges,autoHeightInfo:src.OdA.FALSE},undoSetIsAutoHeightParams=SetWorksheetRowIsAutoHeightMutationFactory(redoSetIsAutoHeightParams,worksheet),result=(0,src.PkI)([{id:SetWorksheetRowHeightMutation.id,params:redoMutationParams},{id:SetWorksheetRowIsAutoHeightMutation.id,params:redoSetIsAutoHeightParams}],commandService),intercepted=sheetInterceptorService.onCommandExecute({id:SetRowHeightCommand.id,params:redoMutationParams}),sheetInterceptorResult=(0,src.PkI)([...intercepted.redos],commandService);return!(!result.result||!sheetInterceptorResult.result)&&(undoRedoService.pushUndoRedo({unitID:unitId,undoMutations:[...intercepted.preRedos??[],{id:SetWorksheetRowHeightMutation.id,params:undoMutationParams},{id:SetWorksheetRowIsAutoHeightMutation.id,params:undoSetIsAutoHeightParams},...intercepted.undos],redoMutations:[...intercepted.preRedos??[],{id:SetWorksheetRowHeightMutation.id,params:redoMutationParams},{id:SetWorksheetRowIsAutoHeightMutation.id,params:redoSetIsAutoHeightParams},...intercepted.redos]}),!0)}},SetWorksheetRowIsAutoHeightCommand={type:src.g4t.COMMAND,id:"sheet.command.set-row-is-auto-height",handler:(accessor,params)=>{const commandService=accessor.get(src.wTY),undoRedoService=accessor.get(src.$Dz),selectionManagerService=accessor.get(selection_service_SheetsSelectionsService),target=target_util_getSheetCommandTarget(accessor.get(src.HCr),params);if(!target)return!1;const{unitId,subUnitId,worksheet}=target,ranges=params?.ranges?.length?params.ranges:selectionManagerService.getCurrentSelections()?.map((s=>s.range));if(!ranges?.length)return!1;const redoMutationParams={unitId,subUnitId,ranges,autoHeightInfo:src.OdA.TRUE},undoMutationParams=SetWorksheetRowIsAutoHeightMutationFactory(redoMutationParams,worksheet),setIsAutoHeightResult=commandService.syncExecuteCommand(SetWorksheetRowIsAutoHeightMutation.id,redoMutationParams),{undos,redos}=accessor.get(SheetInterceptorService).onCommandExecute({id:SetWorksheetRowIsAutoHeightCommand.id,params:redoMutationParams}),result=(0,src.PkI)([...redos],commandService);return!(!setIsAutoHeightResult||!result.result)&&(undoRedoService.pushUndoRedo({unitID:unitId,undoMutations:[{id:SetWorksheetRowIsAutoHeightMutation.id,params:undoMutationParams},...undos],redoMutations:[{id:SetWorksheetRowIsAutoHeightMutation.id,params:redoMutationParams},...redos]}),!0)}},SetWorksheetShowCommand={type:src.g4t.COMMAND,id:"sheet.command.set-worksheet-show",handler:(accessor,params)=>{const{unitId,subUnitId}=params,commandService=accessor.get(src.wTY),undoRedoService=accessor.get(src.$Dz),univerInstanceService=accessor.get(src.HCr);if(!target_util_getSheetCommandTarget(accessor.get(src.HCr)))return!1;const workbook=univerInstanceService.getCurrentUnitForType(src.Zy$.UNIVER_SHEET);if(!workbook)return!1;const worksheet=workbook.getSheetBySheetId(subUnitId);if(!worksheet)return!1;if(worksheet.getConfig().hidden===src.OdA.FALSE)return!1;const redoMutationParams={unitId,subUnitId,hidden:src.OdA.FALSE},undoMutationParams=SetWorksheetHideMutationFactory(accessor,redoMutationParams),result=commandService.syncExecuteCommand(SetWorksheetHideMutation.id,redoMutationParams),activeSheetMutationParams={unitId,subUnitId},activeResult=commandService.syncExecuteCommand(SetWorksheetActiveOperation.id,activeSheetMutationParams);return!(!result||!activeResult)&&(undoRedoService.pushUndoRedo({unitID:unitId,undoMutations:[{id:SetWorksheetHideMutation.id,params:undoMutationParams}],redoMutations:[{id:SetWorksheetHideMutation.id,params:redoMutationParams}]}),!0)}};class DelimiterCounter{add(delimiter){switch(delimiter){case"\t":this._tabCount++;break;case",":this._commaCount++;break;case";":this._semicolonCount++;break;case" ":this._spaceCount++}}update(cellText){cellText&&"string"==typeof cellText&&(cellText.includes("\t")&&this._tabCount++,cellText.includes(",")&&this._commaCount++,cellText.includes(";")&&this._semicolonCount++,cellText.trim().includes(" ")&&this._spaceCount++)}getDelimiter(){const maxCount=Math.max(this._tabCount,this._commaCount,this._semicolonCount,this._spaceCount);return 0===maxCount||maxCount===this._tabCount?1:maxCount===this._commaCount?2:maxCount===this._semicolonCount?4:maxCount===this._spaceCount?8:1}constructor(){this._tabCount=0,this._commaCount=0,this._semicolonCount=0,this._spaceCount=0}}function escapeRegExp(str){return str.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function cellValueToString(cellData){var data;if(null!=cellData)return cellData.p?(data=cellData.p,data.body?.dataStream.replace(/\r\n$/,"")||""):cellData.v&&"string"==typeof cellData.v?cellData.v:!cellData.t||cellData.t!==src.scd.FORCE_STRING&&cellData.t!==src.scd.STRING?void 0:String(cellData.v)}function splitRangeText(sheet,range,delimiter,customDelimiter,treatMultipleDelimitersAsOne=!1){const sourceRange=src.Q6t.transformRange(range,sheet),{startColumn,startRow,endColumn,endRow}=sourceRange;if(startColumn!==endColumn)throw new Error("The range must be in the same column.");if(delimiter&&(16&delimiter)>0&&(void 0===customDelimiter||1!==customDelimiter.length))throw new Error("The custom delimiter must a character.");const needAutoDelimiter=void 0===delimiter,delimiterCounter=needAutoDelimiter?new DelimiterCounter:null,textList=[];for(let i=startRow;i<=endRow;i++){const cellString=cellValueToString(sheet.getCell(i,startColumn));textList.push(cellString),delimiterCounter&&delimiterCounter.update(cellString)}const useDelimiterRegex=function getDelimiterRegexItem(delimiter,treatMultipleDelimitersAsOne,customDelimiter){const delimiterList=[];void 0!==customDelimiter&&(16&delimiter)>0&&delimiterList.push(customDelimiter),(1&delimiter)>0&&delimiterList.push("\t"),(2&delimiter)>0&&delimiterList.push(","),(4&delimiter)>0&&delimiterList.push(";"),(8&delimiter)>0&&delimiterList.push(" ");let str="";for(const delimiter of delimiterList)str+=escapeRegExp(delimiter);let allStr="[".concat(str,"]");return treatMultipleDelimitersAsOne&&(allStr+="+"),new RegExp(allStr)}(needAutoDelimiter?delimiterCounter.getDelimiter():delimiter,treatMultipleDelimitersAsOne,customDelimiter);let maxLength=-1,lastRow=0,index=0;const rs=[];for(const text of textList){if(void 0!==text){const cols=String(text).split(useDelimiterRegex);maxLength=maxLength<0?cols.length:Math.max(maxLength,cols.length),rs.push(cols),lastRow=index}else rs.push(void 0);index++}return{rs,maxLength:-1===maxLength?0:maxLength,lastRow}}const SplitTextToColumnsCommand={type:src.g4t.COMMAND,id:"sheet.command.split-text-to-columns",handler:(accessor,params)=>{const{unitId,subUnitId,range,delimiter,customDelimiter,treatMultipleDelimitersAsOne}=params,commandService=accessor.get(src.wTY),univerInstanceService=accessor.get(src.HCr),undoRedoService=accessor.get(src.$Dz);if(!target_util_getSheetCommandTarget(accessor.get(src.HCr)))return!1;const workbook=univerInstanceService.getCurrentUnitForType(src.Zy$.UNIVER_SHEET);if(!workbook)return!1;const worksheet=workbook.getSheetBySheetId(subUnitId);if(!worksheet)return!1;const{lastRow,rs,maxLength}=splitRangeText(worksheet,range,delimiter,customDelimiter,treatMultipleDelimitersAsOne),maxColumn=worksheet.getColumnCount(),{startColumn}=src.Q6t.transformRange(range,worksheet);if(range.startColumn!==range.endColumn)return!1;const redoMutations=[],undoMutations=[],insertColCount=startColumn+maxLength+1-maxColumn;if(insertColCount>0){const insertColParams={unitId,subUnitId,range:{startRow:0,endRow:worksheet.getRowCount()-1,startColumn:maxColumn-1,endColumn:maxColumn-1+insertColCount}};redoMutations.push({id:InsertColMutation.id,params:insertColParams});const undoColInsertionParams=InsertColMutationUndoFactory(accessor,insertColParams);undoMutations.push({id:RemoveColMutation.id,params:undoColInsertionParams})}const destRange={startRow:range.startRow,endRow:lastRow,startColumn,endColumn:startColumn+maxLength},cellValue=new src.hDc;for(let i=destRange.startRow;i<=destRange.endRow;i++)for(let j=destRange.startColumn;j<=destRange.endColumn;j++){const values=rs[i-destRange.startRow];0===j&&1===values?.length?cellValue.setValue(i,j,worksheet.getCell(i,j)):cellValue.setValue(i,j,{v:values?.[j-destRange.startColumn]||null,p:null,f:null,si:null,custom:null})}const setValuesParams={unitId,subUnitId,cellValue:cellValue.clone()},undoSetValuesParams=SetRangeValuesUndoMutationFactory(accessor,setValuesParams);redoMutations.push({id:SetRangeValuesMutation.id,params:setValuesParams}),undoMutations.unshift({id:SetRangeValuesMutation.id,params:undoSetValuesParams});return!!(0,src.PkI)(redoMutations,commandService).result&&(undoRedoService.pushUndoRedo({unitID:unitId,undoMutations,redoMutations}),!0)}},ToggleCellCheckboxCommand={id:"sheet.command.toggle-cell-checkbox",type:src.g4t.COMMAND,handler:(accessor,params)=>{if(!params)return!1;const{unitId,subUnitId,row,col,paragraphIndex}=params,workbook=accessor.get(src.HCr).getUnit(unitId,src.Zy$.UNIVER_SHEET),sheet=workbook?.getSheetBySheetId(subUnitId),undoRedoService=accessor.get(src.$Dz),commandService=accessor.get(src.wTY);if(!sheet)return!1;const cell=sheet.getCell(row,col);if(!cell?.p)return!1;const p=src.S0q.deepClone(cell.p),documentDataModel=new src.dKg(p),textX=src.Z4q.paragraph.bullet.toggleChecklist({document:documentDataModel,paragraphIndex});if(!textX)return!1;src.Uuf.apply(documentDataModel.getBody(),textX.serialize());const redoParams={unitId,subUnitId,cellValue:{[row]:{[col]:{p,t:src.scd.STRING}}}},redo={id:SetRangeValuesMutation.id,params:redoParams},undoParams=SetRangeValuesUndoMutationFactory(accessor,redoParams),redos=[redo],undos=[{id:SetRangeValuesMutation.id,params:undoParams}];return undoRedoService.pushUndoRedo({redoMutations:redos,undoMutations:undos,unitID:unitId}),commandService.syncExecuteCommand(redo.id,redo.params)}},ToggleGridlinesMutation={id:"sheet.mutation.toggle-gridlines",type:src.g4t.MUTATION,handler:(accessor,params)=>{const target=target_util_getSheetCommandTarget(accessor.get(src.HCr),params);if(!target)return!1;const{worksheet}=target;return worksheet.getConfig().showGridlines=params.showGridlines,!0}},ToggleGridlinesCommand={type:src.g4t.COMMAND,id:"sheet.command.toggle-gridlines",handler:(accessor,params)=>{const commandService=accessor.get(src.wTY),undoRedoService=accessor.get(src.$Dz),target=target_util_getSheetCommandTarget(accessor.get(src.HCr));if(!target)return!1;const{worksheet}=target,currentlyShow=worksheet.getConfig().showGridlines;if(currentlyShow===params?.showGridlines)return!1;const{unitId,subUnitId}=target,doParams={showGridlines:currentlyShow===src.OdA.TRUE?src.OdA.FALSE:src.OdA.TRUE,unitId,subUnitId},undoMutationParams={showGridlines:currentlyShow,unitId,subUnitId};return!!commandService.syncExecuteCommand(ToggleGridlinesMutation.id,doParams)&&(undoRedoService.pushUndoRedo({unitID:unitId,undoMutations:[{id:ToggleGridlinesMutation.id,params:undoMutationParams}],redoMutations:[{id:ToggleGridlinesMutation.id,params:doParams}]}),!0)}},UnregisterWorksheetRangeThemeStyleCommand={id:"sheet.command.unregister-worksheet-range-theme-style",type:src.g4t.COMMAND,handler:(accessor,params)=>{if(!params)return!1;const{unitId,themeName}=params,univerInstanceService=accessor.get(src.HCr),commandService=accessor.get(src.wTY),undoRedoService=accessor.get(src.$Dz),sheetRangeThemeModel=accessor.get(SheetRangeThemeModel);if(!target_util_getSheetCommandTarget(univerInstanceService))return!1;const redoParam={unitId,themeName},undoParam={unitId,themeName,rangeThemeStyleJson:sheetRangeThemeModel.getRangeThemeStyle(unitId,themeName)?.toJson()};return commandService.syncExecuteCommand(RegisterWorksheetRangeThemeStyleMutation.id,params)&&undoRedoService.pushUndoRedo({unitID:unitId,undoMutations:[{id:RegisterWorksheetRangeThemeStyleMutation.id,params:undoParam}],redoMutations:[{id:UnregisterWorksheetRangeThemeStyleMutation.id,params:redoParam}]}),!0}},EmptyMutation={id:"sheet.mutation.empty",type:src.g4t.MUTATION,handler:()=>!0},findMaximalRectangle=topMatrix=>{const res={area:0},checkArea=(area,range)=>res.area<area&&(res.area=area,res.range=range,!0);return topMatrix.forValue(((row,col,lineArea)=>{let cols=1,rows=lineArea;checkArea(cols*rows,{startRow:row-rows+1,endRow:row,startColumn:col,endColumn:col});const _range={startRow:row-rows+1,endRow:row,startColumn:0,endColumn:col};for(let k=col-1;k>=0&&topMatrix.getValue(row,k);k--){rows=Math.min(topMatrix.getValue(row,k)||0,rows),cols++;const area=rows*cols;_range.startColumn=k,_range.startRow=row-rows+1,checkArea(area,_range)}})),res},filterLeftMatrix=(topMatrix,range)=>{src.Q6t.foreach(range,((row,col)=>{topMatrix.realDeleteValue(row,col)}));for(let col=range.startColumn;col<=range.endColumn;col++){const row=range.endRow+1;if(topMatrix.getValue(row,col)>0){topMatrix.setValue(row,col,1);let nextRow=row+1;for(;topMatrix.getValue(nextRow,col)>0;)topMatrix.setValue(nextRow,col,topMatrix.getValue(nextRow-1,col)+1),nextRow++}}return topMatrix},findAllRectangle=topMatrix=>{const resultList=[];let result=findMaximalRectangle(topMatrix);for(;result.area>0;)result.range&&(resultList.push(result.range),filterLeftMatrix(topMatrix,result.range)),result=findMaximalRectangle(topMatrix);return resultList},rangeMerge=ranges=>{const topMatrix=(ranges=>{const matrix=new src.hDc;return ranges.forEach((range=>{src.Q6t.foreach(range,((row,col)=>{matrix.setValue(row,col,1)}))})),matrix.forValue(((row,col)=>{const theLastRowValue=matrix.getValue(row-1,col);theLastRowValue&&matrix.setValue(row,col,theLastRowValue+1)})),matrix})(ranges);return findAllRectangle(topMatrix)};const INumfmtService=(0,src.Qmd)("INumfmtService"),factorySetNumfmtUndoMutation=(accessor,option)=>{const numfmtService=accessor.get(INumfmtService),{values,unitId,subUnitId}=option,cells=[],removeCells=[];Object.keys(values).forEach((id=>{values[id].ranges.forEach((range=>{src.Q6t.foreach(range,((row,col)=>{const oldNumfmt=numfmtService.getValue(unitId,subUnitId,row,col);oldNumfmt?cells.push({pattern:oldNumfmt.pattern,row,col}):removeCells.push({startColumn:col,endColumn:col,startRow:row,endRow:row})}))}))}));const result=[];if(cells.length){const params=transformCellsToRange(unitId,subUnitId,cells);Object.keys(params.values).forEach((key=>{const v=params.values[key];v.ranges=rangeMerge(v.ranges)})),result.push({id:SetNumfmtMutation.id,params:transformCellsToRange(unitId,subUnitId,cells)})}return removeCells.length&&result.push({id:RemoveNumfmtMutation.id,params:{unitId,subUnitId,ranges:removeCells}}),result},SetNumfmtMutation={id:"sheet.mutation.set.numfmt",type:src.g4t.MUTATION,handler:(accessor,params)=>{if(!params)return!1;const{values,refMap}=params,numfmtService=accessor.get(INumfmtService),unitId=params.unitId,sheetId=params.subUnitId,setValues=Object.keys(values).reduce(((result,id)=>{const value=refMap[id],ranges=values[id].ranges;return value&&result.push({...value,ranges}),result}),[]);return numfmtService.setValues(unitId,sheetId,setValues),!0}},RemoveNumfmtMutation={id:"sheet.mutation.remove.numfmt",type:src.g4t.MUTATION,handler:(accessor,params)=>{if(!params)return!1;const{unitId,subUnitId,ranges}=params;return accessor.get(INumfmtService).deleteValues(unitId,subUnitId,ranges),!0}},factoryRemoveNumfmtUndoMutation=(accessor,option)=>{const numfmtService=accessor.get(INumfmtService),{ranges,unitId,subUnitId}=option,cells=[];if(ranges.forEach((range=>{src.Q6t.foreach(range,((row,col)=>{const oldNumfmt=numfmtService.getValue(unitId,subUnitId,row,col);oldNumfmt&&cells.push({pattern:oldNumfmt.pattern,row,col})}))})),!cells.length)return[];const params=transformCellsToRange(unitId,subUnitId,cells);return Object.keys(params.values).forEach((key=>{const v=params.values[key];v.ranges=rangeMerge(v.ranges)})),[{id:SetNumfmtMutation.id,params}]},transformCellsToRange=(unitId,subUnitId,cells)=>{const group=((arr,key,blankKey="")=>arr.reduce(((result,current)=>{const value=current&&current[key];return"string"!=typeof value?(console.warn(current,`${key} is not string`),result):(value?(result[value]||(result[value]=[]),result[value].push(current)):result[blankKey].push(current),result)}),{}))(cells,"pattern"),refMap={},values={},getKey=((initValue=0)=>{let _initValue=initValue;return function getKey(){return _initValue++}})();return Object.keys(group).forEach((pattern=>{const groupItem=group[pattern],key=getKey();refMap[key]={pattern},groupItem.forEach((item=>{values[key]||(values[key]={ranges:[]}),values[key].ranges.push((0,src.PJ)(item.row,item.col))}))})),{unitId,subUnitId,refMap,values}},ScrollToCellOperation={id:"sheet.operation.scroll-to-cell",type:src.g4t.OPERATION,handler:()=>!0},MAX_CELL_PER_SHEET_KEY="maxCellsPerSheet";function basic_worksheet_controller_ts_metadata(k,v){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(k,v)}function basic_worksheet_controller_ts_param(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}}class BasicWorksheetController extends src.jGt{constructor(_commandService,_configService,_dataSyncPrimaryController){super(),this._commandService=_commandService,this._configService=_configService,this._dataSyncPrimaryController=_dataSyncPrimaryController,[SetRangeValuesMutation,InsertColMutation,InsertRowMutation,InsertSheetMutation,MoveRangeMutation,MoveRowsMutation,MoveColsMutation,RemoveColMutation,RemoveRowMutation,RemoveSheetMutation,RemoveWorksheetMergeMutation,RemoveNumfmtMutation,AddWorksheetMergeMutation,SetWorkbookNameMutation,SetWorksheetNameMutation,SetNumfmtMutation,ReorderRangeMutation,EmptyMutation,SetRowHiddenMutation,SetRowVisibleMutation].forEach((mutation=>{this._commandService.registerCommand(mutation),this._dataSyncPrimaryController?.registerSyncingMutations(mutation)}));(this._configService.getConfig("ONLY_REGISTER_FORMULA_RELATED_MUTATIONS_KEY")??!1)||[AppendRowCommand,ClearSelectionAllCommand,ClearSelectionContentCommand,ClearSelectionFormatCommand,CopySheetCommand,delete_range_move_left_command_DeleteRangeMoveLeftCommand,delete_range_move_up_command_DeleteRangeMoveUpCommand,DeltaColumnWidthCommand,DeltaRowHeightCommand,InsertColAfterCommand,InsertColBeforeCommand,InsertMultiColsLeftCommand,InsertMultiColsRightCommand,InsertColByRangeCommand,InsertColCommand,insert_range_move_down_command_InsertRangeMoveDownCommand,InsertRangeMoveRightCommand,InsertRowAfterCommand,InsertRowBeforeCommand,InsertMultiRowsAfterCommand,InsertMultiRowsAboveCommand,InsertRowByRangeCommand,InsertRowCommand,InsertSheetCommand,MoveColsCommand,MoveRangeCommand,MoveRowsCommand,RemoveRowByRangeCommand,RemoveColCommand,RemoveColByRangeCommand,RemoveRowCommand,RemoveSheetCommand,ReorderRangeCommand,RemoveWorksheetMergeCommand,ResetBackgroundColorCommand,ResetTextColorCommand,SetBackgroundColorCommand,SetBorderBasicCommand,SetBorderColorCommand,SetBorderCommand,SetBorderPositionCommand,SetBorderStyleCommand,SetColHiddenCommand,SetColHiddenMutation,SetColVisibleMutation,SetColWidthCommand,SetColDataCommand,SetColDataMutation,SetFrozenCommand,SetFrozenMutation,CancelFrozenCommand,SetHorizontalTextAlignCommand,SetRangeValuesCommand,SetRowHeightCommand,SetRowHiddenCommand,SetRowDataCommand,SetRowDataMutation,SetSelectedColsVisibleCommand,SetSelectedRowsVisibleCommand,SetSpecificColsVisibleCommand,SetSpecificRowsVisibleCommand,SetStyleCommand,SetTabColorCommand,SetTabColorMutation,SetTextColorCommand,SetTextRotationCommand,SetTextWrapCommand,SetVerticalTextAlignCommand,SetWorkbookNameCommand,SetWorksheetActivateCommand,SetWorksheetActiveOperation,SetWorksheetHideCommand,SetWorksheetHideMutation,SetWorksheetNameCommand,SetWorksheetOrderCommand,SetWorksheetOrderMutation,SetWorksheetRowAutoHeightMutation,SetWorksheetRowHeightMutation,SetWorksheetRowIsAutoHeightCommand,SetWorksheetRowIsAutoHeightMutation,SetWorksheetColWidthMutation,SelectRangeCommand,SetSelectionsOperation,ScrollToCellOperation,InsertDefinedNameCommand,RemoveDefinedNameCommand,SetDefinedNameCommand,SetWorksheetShowCommand,ToggleGridlinesCommand,ToggleGridlinesMutation,SetGridlinesColorCommand,SetGridlinesColorMutation,SetWorksheetPermissionPointsCommand,AddWorksheetProtectionMutation,SetWorksheetProtectionMutation,DeleteWorksheetProtectionMutation,SetWorksheetPermissionPointsMutation,AddRangeProtectionCommand,SetProtectionCommand,DeleteRangeProtectionCommand,AddWorksheetProtectionCommand,DeleteWorksheetProtectionCommand,SetWorksheetProtectionCommand,add_range_protection_mutation_AddRangeProtectionMutation,delete_range_protection_mutation_DeleteRangeProtectionMutation,SetRangeProtectionMutation,ToggleCellCheckboxCommand,SetWorksheetDefaultStyleMutation,SetWorksheetDefaultStyleCommand,SplitTextToColumnsCommand,DeleteWorksheetRangeThemeStyleMutation,SetWorksheetRangeThemeStyleMutation,UnregisterWorksheetRangeThemeStyleMutation,RegisterWorksheetRangeThemeStyleMutation,UnregisterWorksheetRangeThemeStyleCommand,RegisterWorksheetRangeThemeStyleCommand,SetWorksheetRangeThemeStyleCommand,DeleteWorksheetRangeThemeStyleCommand].forEach((command=>this.disposeWithMe(this._commandService.registerCommand(command)))),this._configService.setConfig(MAX_CELL_PER_SHEET_KEY,3e6)}}function calculate_result_apply_controller_ts_metadata(k,v){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(k,v)}function calculate_result_apply_controller_ts_param(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}}BasicWorksheetController=function basic_worksheet_controller_ts_decorate(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r}([basic_worksheet_controller_ts_param(0,src.wTY),basic_worksheet_controller_ts_param(1,src.J0C),basic_worksheet_controller_ts_param(2,(0,src.Xx1)(rpc_src.Y7)),basic_worksheet_controller_ts_metadata("design:type",Function),basic_worksheet_controller_ts_metadata("design:paramtypes",[void 0===src.wTY?Object:src.wTY,void 0===src.J0C?Object:src.J0C,void 0===rpc_src.Y7?Object:rpc_src.Y7])],BasicWorksheetController);class CalculateResultApplyController extends src.jGt{constructor(_univerInstanceService,_commandService){super(),this._univerInstanceService=_univerInstanceService,this._commandService=_commandService,this._initialize()}_initialize(){this.disposeWithMe(this._commandService.onCommandExecuted((command=>{if(command.id!==engine_formula_src.Q.id)return;const params=command.params,{unitData}=params,unitIds=Object.keys(unitData),redoMutationsInfo=[];for(let i=0;i<unitIds.length;i++){const unitId=unitIds[i],sheetData=unitData[unitId];if(null==sheetData)continue;const sheetIds=Object.keys(sheetData);for(let j=0;j<sheetIds.length;j++){const sheetId=sheetIds[j],cellData=sheetData[sheetId];if(null==cellData)continue;const setRangeValuesMutation={subUnitId:sheetId,unitId,cellValue:this._getMergedCellData(unitId,sheetId,cellData)};redoMutationsInfo.push({id:SetRangeValuesMutation.id,params:setRangeValuesMutation})}}return redoMutationsInfo.every((m=>this._commandService.executeCommand(m.id,m.params,{onlyLocal:!0})))})))}_getMergedCellData(unitId,sheetId,cellData){const workbook=this._univerInstanceService.getUniverSheetInstance(unitId),styles=workbook?.getStyles(),worksheet=workbook?.getSheetBySheetId(sheetId),oldCellDataMatrix=worksheet?.getCellMatrix(),cellDataMatrix=new src.hDc(cellData);return cellDataMatrix.forValue(((row,col,cell)=>{const oldCell=oldCellDataMatrix?.getValue(row,col),newCell=(0,engine_formula_src.h9)(oldCell,cell,styles);cellDataMatrix.setValue(row,col,newCell)})),cellDataMatrix.getMatrix()}}CalculateResultApplyController=function calculate_result_apply_controller_ts_decorate(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r}([calculate_result_apply_controller_ts_param(0,(0,src.y_5)(src.HCr)),calculate_result_apply_controller_ts_param(1,src.wTY),calculate_result_apply_controller_ts_metadata("design:type",Function),calculate_result_apply_controller_ts_metadata("design:paramtypes",[void 0===src.HCr?Object:src.HCr,void 0===src.wTY?Object:src.wTY])],CalculateResultApplyController);Symbol("sheets.config");const defaultPluginConfig={};function defined_name_data_controller_ts_metadata(k,v){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(k,v)}function defined_name_data_controller_ts_param(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}}const SCOPE_WORKBOOK_VALUE_DEFINED_NAME="AllDefaultWorkbook";class DefinedNameDataController extends src.jGt{constructor(_definedNamesService,_resourceManagerService){super(),this._definedNamesService=_definedNamesService,this._resourceManagerService=_resourceManagerService,this._initialize()}_initialize(){this._initSnapshot()}_initSnapshot(){const toJson=unitId=>{const map=this._definedNamesService.getDefinedNameMap(unitId);return map?JSON.stringify(map):""};this.disposeWithMe(this._resourceManagerService.registerPluginResource({pluginName:"SHEET_DEFINED_NAME_PLUGIN",businesses:[src.Zy$.UNIVER_SHEET],toJson:unitId=>toJson(unitId),parseJson:json=>(json=>{if(!json)return{};try{return JSON.parse(json)}catch(err){return{}}})(json),onUnLoad:unitId=>{this._definedNamesService.removeUnitDefinedName(unitId)},onLoad:(unitId,value)=>{this._definedNamesService.registerDefinedNames(unitId,value)}}))}}DefinedNameDataController=function defined_name_data_controller_ts_decorate(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r}([defined_name_data_controller_ts_param(0,engine_formula_src.ke),defined_name_data_controller_ts_param(1,src.Gvw),defined_name_data_controller_ts_metadata("design:type",Function),defined_name_data_controller_ts_metadata("design:paramtypes",[void 0===engine_formula_src.ke?Object:engine_formula_src.ke,void 0===src.Gvw?Object:src.Gvw])],DefinedNameDataController);var first=__webpack_require__("../../node_modules/.pnpm/rxjs@7.8.1/node_modules/rxjs/dist/esm5/internal/operators/first.js");const type_EffectRefRangId={MoveRangeCommandId:"sheet.command.move-range",InsertRowCommandId:"sheet.command.insert-row",InsertColCommandId:"sheet.command.insert-col",RemoveColCommandId:"sheet.command.remove-col",RemoveRowCommandId:"sheet.command.remove-row",DeleteRangeMoveLeftCommandId:"sheet.command.delete-range-move-left",DeleteRangeMoveUpCommandId:"sheet.command.delete-range-move-up",InsertRangeMoveDownCommandId:"sheet.command.insert-range-move-down",InsertRangeMoveRightCommandId:"sheet.command.insert-range-move-right",MoveColsCommandId:"sheet.command.move-cols",MoveRowsCommandId:"sheet.command.move-rows",ReorderRangeCommandId:"sheet.command.reorder-range"};var type_OperatorType=function(OperatorType){return OperatorType[OperatorType.Set=0]="Set",OperatorType[OperatorType.Delete=1]="Delete",OperatorType[OperatorType.HorizontalMove=2]="HorizontalMove",OperatorType[OperatorType.VerticalMove=3]="VerticalMove",OperatorType[OperatorType.Unknown=4]="Unknown",OperatorType}({});const MAX_SAFE_INTEGER=Number.MAX_SAFE_INTEGER,handleRangeTypeInput=range=>{const _range={...range},isColumn=Number.isNaN(_range.startRow)&&Number.isNaN(_range.endRow)&&!Number.isNaN(_range.startColumn)&&!Number.isNaN(_range.endColumn),isRow=Number.isNaN(_range.startColumn)&&Number.isNaN(_range.endColumn)&&!Number.isNaN(_range.startRow)&&!Number.isNaN(_range.endRow);return(_range.rangeType===src.$uV.COLUMN||isColumn)&&(_range.startRow=0,_range.endRow=MAX_SAFE_INTEGER),(_range.rangeType===src.$uV.ROW||isRow)&&(_range.startColumn=0,_range.endColumn=MAX_SAFE_INTEGER),_range.rangeType===src.$uV.ALL&&(_range.startColumn=0,_range.endColumn=MAX_SAFE_INTEGER,_range.startRow=0,_range.endRow=MAX_SAFE_INTEGER),_range},rotateRange=range=>{let rangeType=range.rangeType;return range.rangeType===src.$uV.COLUMN?rangeType=src.$uV.ROW:range.rangeType===src.$uV.ROW&&(rangeType=src.$uV.COLUMN),{startRow:range.startColumn,endRow:range.endColumn,startColumn:range.startRow,endColumn:range.endRow,rangeType}},handleBaseMoveRowsCols=(fromRange,toRange,effectRange)=>{const _effectRange={...effectRange},_toRange={...toRange},getIntersects=(line1,line2)=>{const start=Math.max(line1.start,line2.start),end=Math.min(line1.end,line2.end);return end<start?null:{start,end}},getLength=line=>line.end-line.start+1,isToLargeFrom=toRange.start>fromRange.start;if(isToLargeFrom){const step=Math.min(fromRange.end,toRange.start)-fromRange.start+1;_toRange.start-=step,_toRange.end-=step}const fromRangeStep=getLength(fromRange),toRangeStep=fromRangeStep,fromRangeIntersectsEffectRange=getIntersects(fromRange,_effectRange),isFromRangeContainEffectRange=fromRangeIntersectsEffectRange&&getLength(fromRangeIntersectsEffectRange)>=getLength(_effectRange);if(fromRange.end<_effectRange.start)_effectRange.start-=fromRangeStep,_effectRange.end-=fromRangeStep;else if(fromRangeIntersectsEffectRange){const fromRangeIntersectsEffectRangeStep=getLength(fromRangeIntersectsEffectRange);if(isFromRangeContainEffectRange){const newLine=((line,origin)=>({start:origin.start+line.start,end:origin.start+line.start+line.end-line.start}))((origin=fromRange,{start:(line=_effectRange).start-origin.start,end:line.start-origin.start+line.end-line.start}),_toRange);_effectRange.start=newLine.start,_effectRange.end=newLine.end}else fromRangeIntersectsEffectRange.start>fromRange.start?isToLargeFrom?(_effectRange.end-=fromRangeIntersectsEffectRangeStep+fromRangeStep,_effectRange.start-=fromRangeStep):_effectRange.end-=fromRangeIntersectsEffectRangeStep:isToLargeFrom?_effectRange.end-=fromRangeIntersectsEffectRangeStep:_effectRange.start>fromRange.start&&_effectRange.end>fromRange.end?(_effectRange.start-=fromRangeStep,_effectRange.end-=fromRangeStep+fromRangeIntersectsEffectRangeStep):_effectRange.end-=fromRangeIntersectsEffectRangeStep}var line,origin;const toRangeIntersectsEffectRange=getIntersects(_toRange,_effectRange);return isFromRangeContainEffectRange||(_toRange.start<=_effectRange.start?(_effectRange.start+=toRangeStep,_effectRange.end+=toRangeStep):toRangeIntersectsEffectRange&&(isToLargeFrom?_toRange.end<=_effectRange.start||_toRange.start<=_effectRange.start&&_toRange.end>=_effectRange.start?(_effectRange.start+=toRangeStep,_effectRange.end+=toRangeStep):_toRange.start>=_effectRange.start&&_toRange.start<=_effectRange.end&&(_effectRange.end+=toRangeStep):_effectRange.start<_toRange.start&&_effectRange.end>_toRange.start?_effectRange.end+=toRangeStep:(_effectRange.start>=_toRange.end||_effectRange.start>=_toRange.start&&_effectRange.start<=_toRange.end)&&(_effectRange.end+=toRangeStep,_effectRange.start+=toRangeStep))),{step:_effectRange.start-effectRange.start,length:getLength(_effectRange)-getLength(effectRange)}},handleMoveRows=(params,targetRange)=>{const{fromRange,toRange}=params.params||{};if(!toRange||!fromRange)return[];const _fromRange=handleRangeTypeInput(fromRange),_toRange=handleRangeTypeInput(toRange),_targetRange=handleRangeTypeInput(targetRange),result=handleBaseMoveRowsCols({start:_fromRange.startRow,end:_fromRange.endRow},{start:_toRange.startRow,end:_toRange.endRow},{start:_targetRange.startRow,end:_targetRange.endRow});return null===result?[{type:type_OperatorType.Delete}]:[{type:type_OperatorType.VerticalMove,step:result.step||0,length:result.length||0}]},handleMoveCols=(params,targetRange)=>{const{fromRange,toRange}=params.params||{};if(!toRange||!fromRange)return[];const _fromRange=handleRangeTypeInput(fromRange),_toRange=handleRangeTypeInput(toRange),_targetRange=handleRangeTypeInput(targetRange),result=handleBaseMoveRowsCols({start:_fromRange.startColumn,end:_fromRange.endColumn},{start:_toRange.startColumn,end:_toRange.endColumn},{start:_targetRange.startColumn,end:_targetRange.endColumn});return null===result?[{type:type_OperatorType.Delete}]:[{type:type_OperatorType.HorizontalMove,step:result.step||0,length:result.length||0}]},handleBaseRemoveRange=(_removeRange,_targetRange)=>{const removeRange=handleRangeTypeInput(_removeRange),targetRange=handleRangeTypeInput(_targetRange),getLength=range=>range.endColumn-range.startColumn+1,getRowLength=range=>range.endRow-range.startRow+1;if(removeRange.startRow<=targetRange.startRow&&removeRange.endRow>=targetRange.endRow){if(targetRange.startColumn<removeRange.startColumn&&targetRange.endColumn>=removeRange.startColumn&&targetRange.endColumn<=removeRange.endColumn||targetRange.startColumn<removeRange.startColumn&&targetRange.endColumn>=removeRange.endColumn){const intersectedRange=src.M_G.getIntersects(targetRange,removeRange);if(intersectedRange){return{step:0,length:-getLength(intersectedRange)}}}if(targetRange.startColumn>=removeRange.startColumn&&targetRange.endColumn<=removeRange.endColumn&&getRowLength(removeRange)>=getRowLength(targetRange))return null;if(targetRange.startColumn>=removeRange.startColumn&&targetRange.startColumn<=removeRange.endColumn&&targetRange.endColumn>removeRange.endColumn){const intersectedRange=src.M_G.getIntersects(targetRange,removeRange);if(intersectedRange){const length=-getLength(intersectedRange);return{step:-(getLength(removeRange)-getLength(intersectedRange)),length}}}if(targetRange.startColumn>removeRange.endColumn){return{step:-getLength(removeRange),length:0}}}return{step:0,length:0}},handleBaseInsertRange=(_insertRange,_targetRange)=>{const insertRange=handleRangeTypeInput(_insertRange),targetRange=handleRangeTypeInput(_targetRange),getLength=range=>range.endColumn-range.startColumn+1;if(!(insertRange.startRow<=targetRange.startRow&&insertRange.endRow>=targetRange.endRow))return{step:0,length:0};if(targetRange.startColumn<insertRange.startColumn&&targetRange.endColumn>=insertRange.startColumn&&targetRange.endColumn<=insertRange.endColumn||targetRange.startColumn<insertRange.startColumn&&targetRange.endColumn>=insertRange.endColumn){return{step:0,length:getLength(insertRange)}}if(targetRange.startColumn>=insertRange.startColumn&&targetRange.endColumn<=insertRange.endColumn||targetRange.startColumn>=insertRange.startColumn&&targetRange.startColumn<=insertRange.endColumn&&targetRange.endColumn>insertRange.endColumn||targetRange.startColumn>=insertRange.endColumn){return{step:getLength(insertRange),length:0}}return{step:0,length:0}};const runRefRangeMutations=(operators,range)=>{let result={...range};return operators.forEach((operator=>{switch(operator.type){case type_OperatorType.Delete:result=null;break;case type_OperatorType.HorizontalMove:if(!result)return;result.startColumn+=operator.step,result.endColumn+=operator.step+(operator.length||0);break;case type_OperatorType.VerticalMove:if(!result)return;result.startRow+=operator.step,result.endRow+=operator.step+(operator.length||0);break;case type_OperatorType.Set:result=operator.range}})),result&&(result.endColumn<result.startColumn||result.endRow<result.startRow)?null:result};function adjustRangeOnMutation(range,mutation){const{id,params}=mutation;let baseRangeOperator={length:0,step:0,type:type_OperatorType.Unknown};switch(id){case RemoveSheetMutation.id:baseRangeOperator.type=type_OperatorType.Delete;break;case MoveRowsMutation.id:baseRangeOperator=handleBaseMoveRowsCols({start:params.sourceRange.startRow,end:params.sourceRange.endRow},{start:params.targetRange.startRow,end:params.targetRange.endRow},{start:range.startRow,end:range.endRow}),baseRangeOperator.type=type_OperatorType.VerticalMove;break;case MoveColsMutation.id:baseRangeOperator=handleBaseMoveRowsCols({start:params.sourceRange.startColumn,end:params.sourceRange.endColumn},{start:params.targetRange.startColumn,end:params.targetRange.endColumn},{start:range.startColumn,end:range.endColumn}),baseRangeOperator.type=type_OperatorType.HorizontalMove;break;case RemoveColMutation.id:baseRangeOperator=handleBaseRemoveRange(params.range,range),baseRangeOperator?baseRangeOperator.type=type_OperatorType.HorizontalMove:baseRangeOperator={step:0,length:0,type:type_OperatorType.Delete};break;case RemoveRowMutation.id:baseRangeOperator=handleBaseRemoveRange(rotateRange(params.range),rotateRange(range)),baseRangeOperator?baseRangeOperator.type=type_OperatorType.VerticalMove:baseRangeOperator={step:0,length:0,type:type_OperatorType.Delete};break;case InsertRowMutation.id:baseRangeOperator=handleBaseInsertRange(rotateRange(params.range),rotateRange(range)),baseRangeOperator.type=type_OperatorType.VerticalMove;break;case InsertColMutation.id:baseRangeOperator=handleBaseInsertRange(params.range,range),baseRangeOperator.type=type_OperatorType.HorizontalMove;break;case MoveRangeMutation.id:baseRangeOperator=function handleBaseMoveRange(fromRange,toRange,targetRange){const operators=[];if(src.M_G.contains(toRange,targetRange)&&operators.push({type:type_OperatorType.Delete}),src.M_G.contains(fromRange,targetRange)){operators.push({type:type_OperatorType.Delete});const relativeRange=src.M_G.getRelativeRange(targetRange,fromRange),positionRange=src.M_G.getPositionRange(relativeRange,toRange);return[{type:type_OperatorType.Set,range:positionRange}]}return operators}(params.fromRange||new src.hDc(params.from).getRange(),params.toRange||new src.hDc(params.to).getRange(),range)}return baseRangeOperator?Array.isArray(baseRangeOperator)?runRefRangeMutations(baseRangeOperator,range):runRefRangeMutations([baseRangeOperator],range):range}function ref_range_service_ts_metadata(k,v){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(k,v)}function ref_range_service_ts_param(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}}const MERGE_REDO=(0,src.nwg)("MERGE_REDO"),MERGE_UNDO=(0,src.nwg)("MERGE_UNDO"),MAX_ROW_COL=Math.floor(Number.MAX_SAFE_INTEGER/10);class WatchRange extends src.jGt{constructor(_unitId,_subUnitId,_range,_callback,_skipIntersects=!1){super(),this._unitId=_unitId,this._subUnitId=_subUnitId,this._range=_range,this._callback=_callback,this._skipIntersects=_skipIntersects}onMutation(mutation){if(mutation.params?.unitId!==this._unitId)return;if(mutation.id===MoveRangeMutation.id){const params=mutation.params;if(params.from.subUnitId!==this._subUnitId||params.to.subUnitId!==this._subUnitId)return}else if(mutation.params?.subUnitId!==this._subUnitId)return;if(!this._range)return;if(this._skipIntersects){if(mutation.id===RemoveSheetMutation.id)return;const effectRanges=function getEffectedRangesOnMutation(mutation){switch(mutation.id){case MoveColsMutation.id:{const params=mutation.params;return[params.sourceRange,{...params.targetRange,startColumn:params.targetRange.startColumn-.5,endColumn:params.targetRange.startColumn-.5}]}case MoveRowsMutation.id:{const params=mutation.params;return[params.sourceRange,{...params.targetRange,startRow:params.targetRange.startRow-.5,endRow:params.targetRange.startRow-.5}]}case MoveRangeMutation.id:{const params=mutation.params;return[new src.hDc(params.from.value).getRange(),new src.hDc(params.to.value).getRange()]}case InsertColMutation.id:{const range=mutation.params.range;return[{...range,startColumn:range.startColumn-.5,endColumn:range.startColumn-.5}]}case InsertRowMutation.id:{const range=mutation.params.range;return[{...range,startRow:range.startRow-.5,endRow:range.startRow-.5}]}case RemoveColMutation.id:case RemoveRowMutation.id:return[mutation.params.range]}}(mutation);if(effectRanges?.some((effectRange=>src.M_G.intersects(effectRange,this._range))))return}const afterRange=adjustRangeOnMutation(this._range,mutation);if(afterRange&&src.M_G.equals(afterRange,this._range))return!1;const beforeChange=this._range;this._range=afterRange,this._callback(beforeChange,afterRange)}}class RefRangeService extends src.jGt{constructor(_commandService,_sheetInterceptorService,_univerInstanceService,_selectionManagerService){super(),this._commandService=_commandService,this._sheetInterceptorService=_sheetInterceptorService,this._univerInstanceService=_univerInstanceService,this._selectionManagerService=_selectionManagerService,this.interceptor=new src.vY4({MERGE_REDO,MERGE_UNDO}),this._watchRanges=new Set,this._refRangeManagerMap=new Map,this._serializer=function createRangeSerializer(){const keyList=["startRow","startColumn","endRow","endColumn","rangeType"],SPLIT_CODE="_";return{deserialize:rangeString=>{const map=keyList.reduce(((preValue,currentValue,index)=>(preValue[String(index)]=currentValue,preValue)),{});return rangeString.split(SPLIT_CODE).reduce(((preValue,currentValue,_index)=>{const index=String(_index);return currentValue&&map[index]&&(preValue[map[index]]=currentValue),preValue}),{})},serialize:range=>keyList.reduce(((preValue,currentValue,index)=>{const value=range[currentValue];return void 0!==value?`${preValue}${index>0?SPLIT_CODE:""}${value}`:`${preValue}`}),"")}}(),this._onRefRangeChange=()=>{this._sheetInterceptorService.interceptCommand({getMutations:command=>{const worksheet=this._univerInstanceService.getCurrentUnitForType(src.Zy$.UNIVER_SHEET).getActiveSheet(),unitId=getUnitId(this._univerInstanceService),subUnitId=getSubUnitId(this._univerInstanceService);if(!worksheet||!unitId||!subUnitId)return{redos:[],undos:[],preRedos:[],preUndos:[]};const result=((()=>{switch(command.id){case type_EffectRefRangId.MoveColsCommandId:{const params=command.params,startColumn=Math.min(params.fromRange.startColumn,params.toRange.startColumn);return this._checkRange([{...params.fromRange,startColumn,endColumn:worksheet.getColumnCount()-1}],unitId,subUnitId)}case type_EffectRefRangId.MoveRowsCommandId:{const params=command.params,startRow=Math.min(params.fromRange.startRow,params.toRange.startRow);return this._checkRange([{...params.fromRange,startRow,endRow:worksheet.getRowCount()-1}],unitId,subUnitId)}case type_EffectRefRangId.MoveRangeCommandId:{const params=command;return this._checkRange([params.params.fromRange,params.params.toRange],unitId,subUnitId)}case type_EffectRefRangId.InsertRowCommandId:{const range={startRow:command.params.range.startRow,endRow:worksheet.getRowCount()-1,startColumn:0,endColumn:worksheet.getColumnCount()-1,rangeType:src.$uV.ROW};return this._checkRange([range],unitId,subUnitId)}case type_EffectRefRangId.InsertColCommandId:{const colStart=command.params.range.startColumn,range={startRow:0,endRow:worksheet.getRowCount()-1,startColumn:colStart,endColumn:worksheet.getColumnCount()-1,rangeType:src.$uV.COLUMN};return this._checkRange([range],unitId,subUnitId)}case type_EffectRefRangId.RemoveRowCommandId:{const range={startRow:command.params.range.startRow,endRow:worksheet.getRowCount()-1,startColumn:0,endColumn:worksheet.getColumnCount()-1,rangeType:src.$uV.ROW};return this._checkRange([range],unitId,subUnitId)}case type_EffectRefRangId.RemoveColCommandId:{const colStart=command.params.range.startColumn,range={startRow:0,endRow:worksheet.getRowCount()-1,startColumn:colStart,endColumn:worksheet.getColumnCount()-1,rangeType:src.$uV.COLUMN};return this._checkRange([range],unitId,subUnitId)}case type_EffectRefRangId.DeleteRangeMoveUpCommandId:case type_EffectRefRangId.InsertRangeMoveDownCommandId:{const range=command.params.range||getSelectionRanges(this._selectionManagerService)[0],effectRange={startRow:range.startRow,startColumn:range.startColumn,endColumn:range.endColumn,endRow:MAX_ROW_COL};return this._checkRange([effectRange],unitId,subUnitId)}case type_EffectRefRangId.DeleteRangeMoveLeftCommandId:case type_EffectRefRangId.InsertRangeMoveRightCommandId:{const range=command.params.range||getSelectionRanges(this._selectionManagerService)[0],effectRange={startRow:range.startRow,startColumn:range.startColumn,endColumn:MAX_ROW_COL,endRow:range.endRow};return this._checkRange([effectRange],unitId,subUnitId)}case type_EffectRefRangId.ReorderRangeCommandId:{const params=command,{range,order}=params.params,effectRanges=[];for(let row=range.startRow;row<=range.endRow;row++)row in order&&effectRanges.push({startRow:row,endRow:row,startColumn:range.startColumn,endColumn:range.endColumn});return this._checkRange(effectRanges,unitId,subUnitId)}}})()||[]).reduce(((result,currentFn)=>{const v=currentFn(command);return result.push(v),result}),[]).reduce(((result,currentValue)=>(result.redos.push(...currentValue.redos),result.undos.push(...currentValue.undos),result.preRedos.push(...currentValue.preRedos??[]),result.preUndos.push(...currentValue.preUndos??[]),result)),{redos:[],undos:[],preUndos:[],preRedos:[]}),preRedos=this.interceptor.fetchThroughInterceptors(this.interceptor.getInterceptPoints().MERGE_REDO)(result.preRedos,null)||[],redos=this.interceptor.fetchThroughInterceptors(this.interceptor.getInterceptPoints().MERGE_REDO)(result.redos,null)||[],preUndos=this.interceptor.fetchThroughInterceptors(this.interceptor.getInterceptPoints().MERGE_UNDO)(result.preUndos,null)||[];return{redos,undos:this.interceptor.fetchThroughInterceptors(this.interceptor.getInterceptPoints().MERGE_UNDO)(result.undos,null)||[],preRedos,preUndos}}})},this._checkRange=(effectRanges,unitId,subUnitId)=>{const managerId=getRefRangId(unitId,subUnitId),manager=this._refRangeManagerMap.get(managerId);if(manager){const callbackSet=new Set;return[...manager.keys()].forEach((key=>{const cbList=manager.get(key),range=this._serializer.deserialize(key),realRange={...range,startRow:+range.startRow,endRow:+range.endRow,startColumn:+range.startColumn,endColumn:+range.endColumn,rangeType:range.rangeType&&+range.rangeType};effectRanges.some((item=>src.M_G.intersects(item,realRange)))&&cbList&&cbList.forEach((callback=>{callbackSet.add(callback)}))})),[...callbackSet]}return[]},this.registerRefRange=(range,callback,_unitId,_subUnitId)=>{const unitId=_unitId||getUnitId(this._univerInstanceService),subUnitId=_subUnitId||getSubUnitId(this._univerInstanceService);if(!unitId||!subUnitId)return(0,src.saO)((()=>{}));const refRangeManagerId=getRefRangId(unitId,subUnitId),rangeString=this._serializer.serialize(range);let manager=this._refRangeManagerMap.get(refRangeManagerId);manager||(manager=new Map,this._refRangeManagerMap.set(refRangeManagerId,manager));const refRangeCallbackList=manager.get(rangeString);return refRangeCallbackList?refRangeCallbackList.add(callback):manager.set(rangeString,new Set([callback])),(0,src.saO)((()=>{const refRangeCallbackList=manager.get(rangeString);refRangeCallbackList&&(refRangeCallbackList.delete(callback),refRangeCallbackList.size||(manager.delete(rangeString),manager.size||this._refRangeManagerMap.delete(refRangeManagerId)))}))},this._onRefRangeChange(),this.interceptor.intercept(this.interceptor.getInterceptPoints().MERGE_REDO,{priority:-1,handler:list=>list}),this.interceptor.intercept(this.interceptor.getInterceptPoints().MERGE_UNDO,{priority:-1,handler:list=>list})}watchRange(unitId,subUnitId,range,callback,skipIntersects){let watchRangesListener;0===this._watchRanges.size&&(watchRangesListener=this._commandService.onCommandExecuted((command=>{if(command.type!==src.g4t.MUTATION)return!1;for(const watchRange of this._watchRanges)watchRange.onMutation(command)})));const watchRange=new WatchRange(unitId,subUnitId,range,callback,skipIntersects);this._watchRanges.add(watchRange);const teardownWatching=(0,src.saO)((()=>{this._watchRanges.delete(watchRange),0===this._watchRanges.size&&(watchRangesListener?.dispose(),watchRangesListener=null)})),registerToService=this.disposeWithMe(teardownWatching);return(0,src.saO)((()=>{registerToService.dispose(),teardownWatching.dispose()}))}}function getUnitId(univerInstanceService){return univerInstanceService.getCurrentUnitForType(src.Zy$.UNIVER_SHEET).getUnitId()}function getSubUnitId(univerInstanceService){return univerInstanceService.getCurrentUnitForType(src.Zy$.UNIVER_SHEET).getActiveSheet()?.getSheetId()}function getSelectionRanges(selectionManagerService){return selectionManagerService.getCurrentSelections()?.map((s=>s.range))||[]}function getRefRangId(unitId,subUnitId){return`${unitId}_${subUnitId}`}function merge_cell_controller_ts_metadata(k,v){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(k,v)}function merge_cell_controller_ts_param(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}}RefRangeService=function ref_range_service_ts_decorate(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r}([ref_range_service_ts_param(0,src.wTY),ref_range_service_ts_param(1,(0,src.y_5)(SheetInterceptorService)),ref_range_service_ts_param(2,(0,src.y_5)(src.HCr)),ref_range_service_ts_param(3,(0,src.y_5)(selection_service_SheetsSelectionsService)),ref_range_service_ts_metadata("design:type",Function),ref_range_service_ts_metadata("design:paramtypes",[void 0===src.wTY?Object:src.wTY,void 0===SheetInterceptorService?Object:SheetInterceptorService,void 0===src.HCr?Object:src.HCr,void 0===selection_service_SheetsSelectionsService?Object:selection_service_SheetsSelectionsService])],RefRangeService);const mutationIdByRowCol=[InsertColMutation.id,InsertRowMutation.id,RemoveColMutation.id,RemoveRowMutation.id],mutationIdArrByMove=[MoveRowsMutation.id,MoveColsMutation.id];function getAddMergeMutationRangeByType(selection,type){let ranges=selection;if(void 0!==type){const rectangles=[];for(let i=0;i<ranges.length;i++){const{startRow,endRow,startColumn,endColumn}=ranges[i];if(type===src.fgB.ROWS)for(let r=startRow;r<=endRow;r++){const data={startRow:r,endRow:r,startColumn,endColumn};rectangles.push(data)}else if(type===src.fgB.COLUMNS)for(let c=startColumn;c<=endColumn;c++){const data={startRow,endRow,startColumn:c,endColumn:c};rectangles.push(data)}}ranges=rectangles}return ranges}const MERGE_CELL_INTERCEPTOR_CHECK=(0,src.nwg)("mergeCellPermissionCheck");class MergeCellController extends src.jGt{constructor(_commandService,_refRangeService,_univerInstanceService,_injector,_sheetInterceptorService,_selectionManagerService){super(),this._commandService=_commandService,this._refRangeService=_refRangeService,this._univerInstanceService=_univerInstanceService,this._injector=_injector,this._sheetInterceptorService=_sheetInterceptorService,this._selectionManagerService=_selectionManagerService,this.disposableCollection=new src.VdD,this.interceptor=new src.vY4({MERGE_CELL_INTERCEPTOR_CHECK}),this._onRefRangeChange(),this._initCommandInterceptor(),this._commandExecutedListener()}_initCommandInterceptor(){const self=this;this._sheetInterceptorService.interceptCommand({getMutations(commandInfo){switch(commandInfo.id){case ClearSelectionAllCommand.id:case ClearSelectionFormatCommand.id:{const workbook=self._univerInstanceService.getCurrentUnitForType(src.Zy$.UNIVER_SHEET),unitId=workbook.getUnitId(),worksheet=workbook?.getActiveSheet();if(!worksheet)return{redos:[],undos:[]};const subUnitId=worksheet.getSheetId(),mergeData=worksheet.getConfig().mergeData,selections=self._selectionManagerService.getCurrentSelections()?.map((s=>s.range));if(selections&&selections.length>0){if(selections.some((range=>mergeData.some((item=>src.M_G.intersects(item,range)))))){const removeMergeParams={unitId,subUnitId,ranges:selections},undoRemoveMergeParams=RemoveMergeUndoMutationFactory(self._injector,removeMergeParams);return{redos:[{id:RemoveWorksheetMergeMutation.id,params:removeMergeParams}],undos:[{id:AddWorksheetMergeMutation.id,params:undoRemoveMergeParams}]}}}}}return{redos:[],undos:[]}}}),this._sheetInterceptorService.interceptRanges({getMutations:({unitId,subUnitId,ranges})=>{const redos=[],undos=[],emptyInterceptorArr={redos,undos};if(!ranges||!ranges.length)return emptyInterceptorArr;const target=target_util_getSheetCommandTarget(this._univerInstanceService,{unitId,subUnitId});if(!target)return emptyInterceptorArr;const{worksheet}=target,overlapRanges=worksheet.getMergeData().filter((item=>ranges.some((range=>src.M_G.intersects(item,range)))));return overlapRanges.length?(redos.push({id:RemoveWorksheetMergeMutation.id,params:{unitId,subUnitId,ranges:overlapRanges}}),undos.push({id:AddWorksheetMergeMutation.id,params:{unitId,subUnitId,ranges:overlapRanges}}),{undos,redos}):emptyInterceptorArr}})}refRangeHandle(config,unitId,subUnitId){switch(config.id){case type_EffectRefRangId.MoveColsCommandId:{const params=config.params;return this._handleMoveColsCommand(params,unitId,subUnitId)}case type_EffectRefRangId.MoveRowsCommandId:{const params=config.params;return this._handleMoveRowsCommand(params,unitId,subUnitId)}case InsertRowCommand.id:{const params=config.params,_unitId=params.unitId||unitId,_subUnitId=params.subUnitId||subUnitId;return this._handleInsertRowCommand(params,_unitId,_subUnitId)}case InsertColCommand.id:{const params=config.params,_unitId=params.unitId||unitId,_subUnitId=params.subUnitId||subUnitId;return this._handleInsertColCommand(params,_unitId,_subUnitId)}case RemoveColCommand.id:{const params=config.params;return this._handleRemoveColCommand(params,unitId,subUnitId)}case RemoveRowCommand.id:{const params=config.params;return this._handleRemoveRowCommand(params,unitId,subUnitId)}case MoveRangeCommand.id:{const params=config.params;return this._handleMoveRangeCommand(params,unitId,subUnitId)}case InsertRangeMoveRightCommand.id:{const params=config.params;return this._handleInsertRangeMoveRightCommand(params,unitId,subUnitId)}case insert_range_move_down_command_InsertRangeMoveDownCommand.id:{const params=config.params;return this._handleInsertRangeMoveDownCommand(params,unitId,subUnitId)}case delete_range_move_up_command_DeleteRangeMoveUpCommand.id:{const params=config.params;return this._handleDeleteRangeMoveUpCommand(params,unitId,subUnitId)}case delete_range_move_left_command_DeleteRangeMoveLeftCommand.id:{const params=config.params;return this._handleDeleteRangeMoveLeftCommand(params,unitId,subUnitId)}}return{redos:[],undos:[]}}_onRefRangeChange(){const registerRefRange=(unitId,subUnitId)=>{const workbook=this._univerInstanceService.getUniverSheetInstance(unitId);if(!workbook)return;const workSheet=workbook?.getSheetBySheetId(subUnitId);if(!workSheet)return;this.disposableCollection.dispose();const mergeData=workSheet.getMergeData(),handler=config=>this.refRangeHandle(config,unitId,subUnitId);mergeData.forEach((range=>{this.disposableCollection.add(this._refRangeService.registerRefRange(range,handler,unitId,subUnitId))}))};this.disposeWithMe(this._commandService.onCommandExecuted((commandInfo=>{if(commandInfo.id===SetWorksheetActiveOperation.id){const params=commandInfo.params,sheetId=params.subUnitId,unitId=params.unitId;if(!sheetId||!unitId)return;registerRefRange(unitId,sheetId)}if(commandInfo.id===AddWorksheetMergeMutation.id){const params=commandInfo.params,sheetId=params.subUnitId,unitId=params.unitId;if(!sheetId||!unitId)return;registerRefRange(params.unitId,params.subUnitId)}}))),this._univerInstanceService.getCurrentTypeOfUnit$(src.Zy$.UNIVER_SHEET).pipe((0,first.$)((workbook=>!!workbook))).subscribe((workbook=>{const sheet=workbook.getActiveSheet();sheet&&registerRefRange(workbook.getUnitId(),sheet.getSheetId())}))}_handleMoveRowsCommand(params,unitId,subUnitId){const workbook=getWorkbook(this._univerInstanceService,unitId);if(!workbook)return this._handleNull();const worksheet=getWorksheet(workbook,subUnitId);if(!worksheet)return this._handleNull();const mergeData=[...worksheet.getMergeData()],removeParams={unitId,subUnitId,ranges:[]},addParams={unitId,subUnitId,ranges:[]},{fromRange}=params,{startRow:sourceStart,endRow:sourceEnd}=fromRange;if(mergeData.forEach((range=>{if(sourceStart<=range.startRow&&sourceEnd>=range.endRow){removeParams.ranges.push(range);const operation=handleMoveRows({id:type_EffectRefRangId.MoveRowsCommandId,params},range),result=runRefRangeMutations(operation,range);result&&addParams.ranges.push(result)}})),0===removeParams.ranges.length)return this._handleNull();const removeUndo=RemoveMergeUndoMutationFactory(this._injector,removeParams),addUndo=AddMergeUndoMutationFactory(this._injector,addParams);return{preRedos:[{id:RemoveWorksheetMergeMutation.id,params:removeParams}],redos:[{id:AddWorksheetMergeMutation.id,params:addParams}],preUndos:[{id:RemoveWorksheetMergeMutation.id,params:addUndo}],undos:[{id:AddWorksheetMergeMutation.id,params:removeUndo}]}}_handleMoveColsCommand(params,unitId,subUnitId){const workbook=getWorkbook(this._univerInstanceService,unitId);if(!workbook)return this._handleNull();const worksheet=getWorksheet(workbook,subUnitId);if(!worksheet)return this._handleNull();const mergeData=[...worksheet.getMergeData()],removeParams={unitId,subUnitId,ranges:[]},addParams={unitId,subUnitId,ranges:[]},{fromRange}=params,{startColumn:sourceStart,endColumn:sourceEnd}=fromRange;if(mergeData.forEach((range=>{if(sourceStart<=range.startColumn&&sourceEnd>=range.endColumn){removeParams.ranges.push(range);const operation=handleMoveCols({id:type_EffectRefRangId.MoveColsCommandId,params},range),result=runRefRangeMutations(operation,range);result&&addParams.ranges.push(result)}})),0===removeParams.ranges.length)return this._handleNull();const removeUndo=RemoveMergeUndoMutationFactory(this._injector,removeParams),addUndo=AddMergeUndoMutationFactory(this._injector,addParams);return{preRedos:[{id:RemoveWorksheetMergeMutation.id,params:removeParams}],redos:[{id:AddWorksheetMergeMutation.id,params:addParams}],preUndos:[{id:RemoveWorksheetMergeMutation.id,params:addUndo}],undos:[{id:AddWorksheetMergeMutation.id,params:removeUndo}]}}_handleMoveRangeCommand(params,unitId,subUnitId){const workbook=getWorkbook(this._univerInstanceService,unitId);if(!workbook)return this._handleNull();const worksheet=getWorksheet(workbook,subUnitId);if(!worksheet)return this._handleNull();const mergeData=worksheet.getMergeData(),fromMergeRanges=mergeData.filter((item=>src.M_G.intersects(item,params.fromRange))),toMergeRanges=mergeData.filter((item=>src.M_G.intersects(item,params.toRange))),addMergeCellRanges=getAddMergeMutationRangeByType(fromMergeRanges.map((mergeRange=>src.M_G.getRelativeRange(mergeRange,params.fromRange))).map((relativeRange=>src.M_G.getPositionRange(relativeRange,params.toRange)))).filter((range=>!mergeData.some((mergeRange=>src.M_G.equals(range,mergeRange)))));return{redos:[{id:RemoveWorksheetMergeMutation.id,params:{unitId,subUnitId,ranges:fromMergeRanges}},{id:RemoveWorksheetMergeMutation.id,params:{unitId,subUnitId,ranges:toMergeRanges}},{id:AddWorksheetMergeMutation.id,params:{unitId,subUnitId,ranges:addMergeCellRanges}}],undos:[{id:RemoveWorksheetMergeMutation.id,params:{unitId,subUnitId,ranges:addMergeCellRanges}},{id:AddWorksheetMergeMutation.id,params:{unitId,subUnitId,ranges:toMergeRanges}},{id:AddWorksheetMergeMutation.id,params:{unitId,subUnitId,ranges:fromMergeRanges}}]}}_handleInsertRowCommand(config,unitId,subUnitId){const workbook=getWorkbook(this._univerInstanceService,unitId);if(!workbook)return this._handleNull();const worksheet=getWorksheet(workbook,subUnitId);if(!worksheet)return this._handleNull();const{range}=config,{startRow,endRow}=range,oldMergeCells=src.S0q.deepClone(worksheet.getMergeData()).reduce(((mergeCellsHasLapping,cell)=>(startRow>cell.startRow&&startRow<=cell.endRow&&mergeCellsHasLapping.push(cell),mergeCellsHasLapping)),[]);if(0===oldMergeCells.length)return this._handleNull();const newMergeCells=src.S0q.deepClone(worksheet.getMergeData()).reduce(((mergeCellsHasLapping,cell)=>{if(startRow>cell.startRow&&startRow<=cell.endRow){const count=endRow-startRow+1;cell.endRow+=count,this._checkIsMergeCell(cell)&&mergeCellsHasLapping.push(cell)}return mergeCellsHasLapping}),[]),removeMergeParams={unitId,subUnitId,ranges:oldMergeCells},undoRemoveMergeParams=RemoveMergeUndoMutationFactory(this._injector,removeMergeParams),addMergeParams={unitId,subUnitId,ranges:newMergeCells},undoAddMergeParams=AddMergeUndoMutationFactory(this._injector,addMergeParams);return{redos:[{id:RemoveWorksheetMergeMutation.id,params:removeMergeParams},{id:AddWorksheetMergeMutation.id,params:addMergeParams}],undos:[{id:RemoveWorksheetMergeMutation.id,params:undoAddMergeParams},{id:AddWorksheetMergeMutation.id,params:undoRemoveMergeParams}]}}_handleInsertColCommand(config,unitId,subUnitId){const{range}=config,workbook=getWorkbook(this._univerInstanceService,unitId);if(!workbook)return this._handleNull();const worksheet=getWorksheet(workbook,subUnitId);if(!worksheet)return this._handleNull();const{startColumn,endColumn}=range,oldMergeCells=src.S0q.deepClone(worksheet.getMergeData()).reduce(((mergeCellsHasLapping,cell)=>(startColumn>cell.startColumn&&startColumn<=cell.endColumn&&mergeCellsHasLapping.push(cell),mergeCellsHasLapping)),[]);if(0===oldMergeCells.length)return this._handleNull();const newMergeCells=src.S0q.deepClone(worksheet.getMergeData()).reduce(((mergeCellsHasLapping,cell)=>{if(startColumn>cell.startColumn&&startColumn<=cell.endColumn){const count=endColumn-startColumn+1;cell.endColumn+=count,this._checkIsMergeCell(cell)&&mergeCellsHasLapping.push(cell)}return mergeCellsHasLapping}),[]),removeMergeParams={unitId,subUnitId,ranges:oldMergeCells},undoRemoveMergeParams=RemoveMergeUndoMutationFactory(this._injector,removeMergeParams),addMergeParams={unitId,subUnitId,ranges:newMergeCells},undoAddMergeParams=AddMergeUndoMutationFactory(this._injector,addMergeParams);return{redos:[{id:RemoveWorksheetMergeMutation.id,params:removeMergeParams},{id:AddWorksheetMergeMutation.id,params:addMergeParams}],undos:[{id:RemoveWorksheetMergeMutation.id,params:undoAddMergeParams},{id:AddWorksheetMergeMutation.id,params:undoRemoveMergeParams}]}}_handleRemoveColCommand(config,unitId,subUnitId){const workbook=getWorkbook(this._univerInstanceService,unitId);if(!workbook)return this._handleNull();const worksheet=getWorksheet(workbook,subUnitId);if(!worksheet)return this._handleNull();const{range}=config,{startColumn,endColumn}=range,oldMergeCells=src.S0q.deepClone(worksheet.getMergeData()).reduce(((mergeCellsHasLapping,cell)=>(src.M_G.intersects(range,cell)&&mergeCellsHasLapping.push(cell),mergeCellsHasLapping)),[]);if(0===oldMergeCells.length)return this._handleNull();const newMergeCells=src.S0q.deepClone(worksheet.getMergeData()).reduce(((mergeCellsHasLapping,cell)=>{if(src.M_G.intersects(range,cell)){if(startColumn<=cell.startColumn&&endColumn>=cell.endColumn)return mergeCellsHasLapping;startColumn>=cell.startColumn&&endColumn<=cell.endColumn?cell.endColumn-=endColumn-startColumn+1:startColumn<cell.startColumn?(cell.startColumn=startColumn,cell.endColumn-=endColumn-startColumn+1):endColumn>cell.endColumn&&(cell.endColumn=startColumn-1),this._checkIsMergeCell(cell)&&mergeCellsHasLapping.push(cell)}return mergeCellsHasLapping}),[]),removeMergeMutationParams={unitId,subUnitId,ranges:oldMergeCells},undoRemoveMergeMutationParams=RemoveMergeUndoMutationFactory(this._injector,removeMergeMutationParams),addMergeMutationParams={unitId,subUnitId,ranges:newMergeCells},undoAddMergeParams=AddMergeUndoMutationFactory(this._injector,addMergeMutationParams),preRedos=[{id:RemoveWorksheetMergeMutation.id,params:removeMergeMutationParams}],redos=[{id:AddWorksheetMergeMutation.id,params:addMergeMutationParams}];return{preUndos:[{id:RemoveWorksheetMergeMutation.id,params:undoAddMergeParams}],undos:[{id:AddWorksheetMergeMutation.id,params:undoRemoveMergeMutationParams}],preRedos,redos}}_handleRemoveRowCommand(config,unitId,subUnitId){const{range}=config,workbook=getWorkbook(this._univerInstanceService,unitId);if(!workbook)return this._handleNull();const worksheet=getWorksheet(workbook,subUnitId);if(!worksheet)return this._handleNull();const{startRow,endRow}=range,oldMergeCells=src.S0q.deepClone(worksheet.getMergeData()).reduce(((mergeCellsHasLapping,cell)=>(src.M_G.intersects(range,cell)&&mergeCellsHasLapping.push(cell),mergeCellsHasLapping)),[]);if(0===oldMergeCells.length)return this._handleNull();const newMergeCells=src.S0q.deepClone(worksheet.getMergeData()).reduce(((mergeCellsHasLapping,cell)=>{if(src.M_G.intersects(range,cell)){if(startRow<=cell.startRow&&endRow>=cell.endRow)return mergeCellsHasLapping;startRow>=cell.startRow&&endRow<=cell.endRow?cell.endRow-=endRow-startRow+1:startRow<cell.startRow?(cell.startRow=startRow,cell.endRow-=endRow-startRow+1):endRow>cell.endRow&&(cell.endRow=startRow-1),this._checkIsMergeCell(cell)&&mergeCellsHasLapping.push(cell)}return mergeCellsHasLapping}),[]),removeMergeMutationParams={unitId,subUnitId,ranges:oldMergeCells},undoRemoveMergeMutationParams=RemoveMergeUndoMutationFactory(this._injector,removeMergeMutationParams),addMergeMutationParams={unitId,subUnitId,ranges:newMergeCells},undoAddMergeParams=AddMergeUndoMutationFactory(this._injector,addMergeMutationParams),preRedos=[{id:RemoveWorksheetMergeMutation.id,params:removeMergeMutationParams}],redos=[{id:AddWorksheetMergeMutation.id,params:addMergeMutationParams}];return{preUndos:[{id:RemoveWorksheetMergeMutation.id,params:undoAddMergeParams}],undos:[{id:AddWorksheetMergeMutation.id,params:undoRemoveMergeMutationParams}],preRedos,redos}}_handleInsertRangeMoveRightCommand(config,unitId,subUnitId){const workbook=getWorkbook(this._univerInstanceService,unitId);if(!workbook)return this._handleNull();const worksheet=getWorksheet(workbook,subUnitId);if(!worksheet)return this._handleNull();const range=config.range,maxCol=worksheet.getMaxColumns()-1,mergeData=worksheet.getMergeData(),removeMergeData=[],addMergeData=[];mergeData.forEach((rect=>{const{startRow,endRow,startColumn,endColumn}=range;if(src.M_G.intersects({startRow,startColumn,endRow,endColumn:maxCol},rect)){removeMergeData.push(rect);if(src.M_G.contains({startRow,startColumn,endRow,endColumn:maxCol},rect)){const currentColumnsCount=endColumn-startColumn+1;addMergeData.push({startRow:rect.startRow,startColumn:rect.startColumn+currentColumnsCount,endRow:rect.endRow,endColumn:rect.endColumn+currentColumnsCount})}}}));const removeMergeParams={unitId,subUnitId,ranges:removeMergeData},undoRemoveMergeParams=RemoveMergeUndoMutationFactory(this._injector,removeMergeParams),addMergeParams={unitId,subUnitId,ranges:addMergeData},undoAddMergeParams=AddMergeUndoMutationFactory(this._injector,addMergeParams);return{preRedos:[{id:RemoveWorksheetMergeMutation.id,params:removeMergeParams}],redos:[{id:AddWorksheetMergeMutation.id,params:addMergeParams}],preUndos:[{id:RemoveWorksheetMergeMutation.id,params:undoAddMergeParams}],undos:[{id:AddWorksheetMergeMutation.id,params:undoRemoveMergeParams}]}}_handleInsertRangeMoveDownCommand(config,unitId,subUnitId){const workbook=getWorkbook(this._univerInstanceService,unitId);if(!workbook)return this._handleNull();const worksheet=getWorksheet(workbook,subUnitId);if(!worksheet)return this._handleNull();const range=config.range,maxRow=worksheet.getMaxRows()-1,mergeData=worksheet.getMergeData(),removeMergeData=[],addMergeData=[];mergeData.forEach((rect=>{const{startRow,startColumn,endColumn,endRow}=range;if(src.M_G.intersects({startRow,startColumn,endRow:maxRow,endColumn},rect)){removeMergeData.push(rect);if(src.M_G.contains({startRow,startColumn,endRow:maxRow,endColumn},rect)){const rowCount=endRow-startRow+1;addMergeData.push({startRow:rect.startRow+rowCount,startColumn:rect.startColumn,endRow:rect.endRow+rowCount,endColumn:rect.endColumn})}}}));const removeMergeParams={unitId,subUnitId,ranges:removeMergeData},undoRemoveMergeParams=RemoveMergeUndoMutationFactory(this._injector,removeMergeParams),addMergeParams={unitId,subUnitId,ranges:addMergeData},undoAddMergeParams=AddMergeUndoMutationFactory(this._injector,addMergeParams),preRedos=[{id:RemoveWorksheetMergeMutation.id,params:removeMergeParams}],redos=[{id:AddWorksheetMergeMutation.id,params:addMergeParams}],preUndos=[{id:RemoveWorksheetMergeMutation.id,params:undoAddMergeParams}];return{redos,undos:[{id:AddWorksheetMergeMutation.id,params:undoRemoveMergeParams}],preRedos,preUndos}}_handleDeleteRangeMoveUpCommand(config,unitId,subUnitId){const workbook=getWorkbook(this._univerInstanceService,unitId);if(!workbook)return this._handleNull();const worksheet=getWorksheet(workbook,subUnitId);if(!worksheet)return this._handleNull();const range=config.range,maxRow=worksheet.getMaxRows()-1,mergeData=worksheet.getMergeData(),removeMergeData=[],addMergeData=[];mergeData.forEach((rect=>{const{startRow,startColumn,endColumn,endRow}=range;if(src.M_G.intersects({startRow,startColumn,endRow:maxRow,endColumn},rect)){removeMergeData.push(rect);if(src.M_G.contains({startRow,startColumn,endRow:maxRow,endColumn},rect)){const rowCount=endRow-startRow+1,range=src.M_G.moveVertical(rect,-rowCount);addMergeData.push(range)}}}));const removeMergeParams={unitId,subUnitId,ranges:removeMergeData},undoRemoveMergeParams=RemoveMergeUndoMutationFactory(this._injector,removeMergeParams),addMergeParams={unitId,subUnitId,ranges:addMergeData},undoAddMergeParams=AddMergeUndoMutationFactory(this._injector,addMergeParams),preRedos=[{id:RemoveWorksheetMergeMutation.id,params:removeMergeParams}],redos=[{id:AddWorksheetMergeMutation.id,params:addMergeParams}],preUndos=[{id:RemoveWorksheetMergeMutation.id,params:undoAddMergeParams}];return{redos,undos:[{id:AddWorksheetMergeMutation.id,params:undoRemoveMergeParams}],preRedos,preUndos}}_handleDeleteRangeMoveLeftCommand(config,unitId,subUnitId){const workbook=getWorkbook(this._univerInstanceService,unitId);if(!workbook)return this._handleNull();const worksheet=getWorksheet(workbook,subUnitId);if(!worksheet)return this._handleNull();const range=config.range,maxCol=worksheet.getMaxColumns()-1,mergeData=worksheet.getMergeData(),removeMergeData=[],addMergeData=[];mergeData.forEach((rect=>{const{startRow,endRow,startColumn,endColumn}=range;if(src.M_G.intersects({startRow,startColumn,endRow,endColumn:maxCol},rect)){removeMergeData.push(rect);if(src.M_G.contains({startRow,startColumn,endRow,endColumn:maxCol},rect)){const currentColumnsCount=endColumn-startColumn+1;addMergeData.push({startRow:rect.startRow,startColumn:rect.startColumn-currentColumnsCount,endRow:rect.endRow,endColumn:rect.endColumn-currentColumnsCount})}}}));const removeMergeParams={unitId,subUnitId,ranges:removeMergeData},undoRemoveMergeParams=RemoveMergeUndoMutationFactory(this._injector,removeMergeParams),addMergeParams={unitId,subUnitId,ranges:addMergeData},undoAddMergeParams=AddMergeUndoMutationFactory(this._injector,addMergeParams);return{preRedos:[{id:RemoveWorksheetMergeMutation.id,params:removeMergeParams}],redos:[{id:AddWorksheetMergeMutation.id,params:addMergeParams}],undos:[{id:AddWorksheetMergeMutation.id,params:undoRemoveMergeParams}],preUndos:[{id:RemoveWorksheetMergeMutation.id,params:undoAddMergeParams}]}}_checkIsMergeCell(cell){return!(cell.startRow===cell.endRow&&cell.startColumn===cell.endColumn)}_handleNull(){return{redos:[],undos:[]}}_commandExecutedListener(){this.disposeWithMe(this._commandService.onCommandExecuted((command=>{if(mutationIdArrByMove.includes(command.id)){if(!command.params)return;const workbook=this._univerInstanceService.getUniverSheetInstance(command.params.unitId);if(!workbook)return;const worksheet=workbook.getSheetBySheetId(command.params.subUnitId);if(!worksheet)return;const{sourceRange,targetRange}=command.params,isRowMove=sourceRange.startColumn===targetRange.startColumn&&sourceRange.endColumn===targetRange.endColumn,moveLength=isRowMove?sourceRange.endRow-sourceRange.startRow+1:sourceRange.endColumn-sourceRange.startColumn+1,sourceStart=isRowMove?sourceRange.startRow:sourceRange.startColumn,targetStart=isRowMove?targetRange.startRow:targetRange.startColumn,mergeData=worksheet.getConfig().mergeData,adjustedMergedCells=[];mergeData.forEach((merge=>{let{startRow,endRow,startColumn,endColumn,rangeType}=merge;src.M_G.intersects(merge,sourceRange)||(isRowMove?sourceStart<startRow&&targetStart>endRow?(startRow-=moveLength,endRow-=moveLength):sourceStart>endRow&&targetStart<=startRow&&(startRow+=moveLength,endRow+=moveLength):sourceStart<startColumn&&targetStart>endColumn?(startColumn-=moveLength,endColumn-=moveLength):sourceStart>endColumn&&targetStart<=startColumn&&(startColumn+=moveLength,endColumn+=moveLength)),merge.startRow===merge.endRow&&merge.startColumn===merge.endColumn||adjustedMergedCells.push({startRow,endRow,startColumn,endColumn,rangeType})})),worksheet.setMergeData(adjustedMergedCells),this.disposableCollection.dispose();const{unitId,subUnitId}=command.params,handler=config=>this.refRangeHandle(config,unitId,subUnitId);adjustedMergedCells.forEach((range=>{this.disposableCollection.add(this._refRangeService.registerRefRange(range,handler,unitId,subUnitId))}))}if(mutationIdByRowCol.includes(command.id)){const workbook=this._univerInstanceService.getUniverSheetInstance(command.params.unitId);if(!workbook)return;const worksheet=workbook.getSheetBySheetId(command.params.subUnitId);if(!worksheet)return;const mergeData=worksheet.getConfig().mergeData,params=command.params;if(!params)return;const{range}=params,isRowOperation=command.id.includes("row"),isAddOperation=command.id.includes("insert"),operationStart=isRowOperation?range.startRow:range.startColumn,operationEnd=isRowOperation?range.endRow:range.endColumn,operationCount=operationEnd-operationStart+1,adjustedMergedCells=[];mergeData.forEach((merge=>{let{startRow,endRow,startColumn,endColumn,rangeType}=merge;isAddOperation?isRowOperation?operationStart<=startRow&&(startRow+=operationCount,endRow+=operationCount):operationStart<=startColumn&&(startColumn+=operationCount,endColumn+=operationCount):isRowOperation?operationEnd<startRow&&(startRow-=operationCount,endRow-=operationCount):operationEnd<startColumn&&(startColumn-=operationCount,endColumn-=operationCount),merge.startRow===merge.endRow&&merge.startColumn===merge.endColumn||adjustedMergedCells.push({startRow,endRow,startColumn,endColumn,rangeType})})),worksheet.setMergeData(adjustedMergedCells),this.disposableCollection.dispose();const{unitId,subUnitId}=command.params,handler=config=>this.refRangeHandle(config,unitId,subUnitId);adjustedMergedCells.forEach((range=>{this.disposableCollection.add(this._refRangeService.registerRefRange(range,handler,unitId,subUnitId))}))}})))}}function getWorkbook(univerInstanceService,unitId){return unitId?univerInstanceService.getUniverSheetInstance(unitId):univerInstanceService.getCurrentUnitForType(src.Zy$.UNIVER_SHEET)}function getWorksheet(workbook,subUnitId){return subUnitId?workbook.getSheetBySheetId(subUnitId):workbook.getActiveSheet()}function number_cell_controller_ts_metadata(k,v){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(k,v)}MergeCellController=function merge_cell_controller_ts_decorate(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r}([merge_cell_controller_ts_param(0,(0,src.y_5)(src.wTY)),merge_cell_controller_ts_param(1,(0,src.y_5)(RefRangeService)),merge_cell_controller_ts_param(2,(0,src.y_5)(src.HCr)),merge_cell_controller_ts_param(3,(0,src.y_5)(src.zZn)),merge_cell_controller_ts_param(4,(0,src.y_5)(SheetInterceptorService)),merge_cell_controller_ts_param(5,(0,src.y_5)(selection_service_SheetsSelectionsService)),merge_cell_controller_ts_metadata("design:type",Function),merge_cell_controller_ts_metadata("design:paramtypes",[void 0===src.wTY?Object:src.wTY,void 0===RefRangeService?Object:RefRangeService,void 0===src.HCr?Object:src.HCr,void 0===src.zZn?Object:src.zZn,void 0===SheetInterceptorService?Object:SheetInterceptorService,void 0===selection_service_SheetsSelectionsService?Object:selection_service_SheetsSelectionsService])],MergeCellController);class NumberCellDisplayController extends src.jGt{constructor(_sheetInterceptorService){super(),this._sheetInterceptorService=_sheetInterceptorService,this._initialize()}_initialize(){this._initInterceptorCellContent()}_initInterceptorCellContent(){this.disposeWithMe(this._sheetInterceptorService.intercept(INTERCEPTOR_POINT.CELL_CONTENT,{priority:11,effect:src._w8.Value|src._w8.Style,handler:(cell,location,next)=>{const style=location.workbook.getStyles().getStyleByCell(cell);return style?.n?.pattern?next({...cell}):cell?.t===src.scd.NUMBER&&void 0!==cell.v&&null!==cell.v&&(0,src.DMQ)(cell.v)?next({...cell,v:(0,engine_formula_src.d9)(Number(cell.v))}):next({...cell})}}))}}function sheet_permission_check_controller_ts_metadata(k,v){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(k,v)}function sheet_permission_check_controller_ts_param(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}}NumberCellDisplayController=function number_cell_controller_ts_decorate(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r}([function number_cell_controller_ts_param(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}}(0,(0,src.y_5)(SheetInterceptorService)),number_cell_controller_ts_metadata("design:type",Function),number_cell_controller_ts_metadata("design:paramtypes",[void 0===SheetInterceptorService?Object:SheetInterceptorService])],NumberCellDisplayController);class SheetPermissionCheckController extends src.jGt{constructor(_commandService,_univerInstanceService,_permissionService,_selectionManagerService,_rangeProtectionRuleModel,_worksheetProtectionRuleModel,_localeService,_lexerTreeBuilder,_contextService,_definedNamesService){super(),this._commandService=_commandService,this._univerInstanceService=_univerInstanceService,this._permissionService=_permissionService,this._selectionManagerService=_selectionManagerService,this._rangeProtectionRuleModel=_rangeProtectionRuleModel,this._worksheetProtectionRuleModel=_worksheetProtectionRuleModel,this._localeService=_localeService,this._lexerTreeBuilder=_lexerTreeBuilder,this._contextService=_contextService,this._definedNamesService=_definedNamesService,this.disposableCollection=new src.VdD,this._triggerPermissionUIEvent$=new Subject.B,this.triggerPermissionUIEvent$=this._triggerPermissionUIEvent$.asObservable(),this._initialize()}blockExecuteWithoutPermission(errorMsg){throw this._triggerPermissionUIEvent$.next(errorMsg),new src.ZZl("have no permission")}_getPermissionCheck(id,params){let permission=!0,errorMsg="";switch(id){case SetRangeValuesCommand.id:(0,src.SoT)(params.value)&&params.value.f?(permission=this._permissionCheckWithFormula(params),errorMsg=this._localeService.t("permission.dialog.formulaErr")):permission=this._permissionCheckBySetRangeValue({workbookTypes:[editable_WorkbookEditablePermission],rangeTypes:[edit_RangeProtectionPermissionEditPoint],worksheetTypes:[WorksheetSetCellValuePermission,edit_WorksheetEditPermission]},params);break;case ClearSelectionContentCommand.id:permission=this.permissionCheckWithRanges({workbookTypes:[editable_WorkbookEditablePermission],rangeTypes:[edit_RangeProtectionPermissionEditPoint],worksheetTypes:[WorksheetSetCellValuePermission,edit_WorksheetEditPermission]}),errorMsg=this._localeService.t("permission.dialog.editErr");break;case DeltaColumnWidthCommand.id:case SetColWidthCommand.id:permission=this.permissionCheckWithoutRange({worksheetTypes:[WorksheetSetColumnStylePermission]}),errorMsg=this._localeService.t("permission.dialog.setRowColStyleErr");break;case DeltaRowHeightCommand.id:case SetRowHeightCommand.id:case SetWorksheetRowIsAutoHeightCommand.id:permission=this.permissionCheckWithoutRange({worksheetTypes:[WorksheetSetRowStylePermission]}),errorMsg=this._localeService.t("permission.dialog.setRowColStyleErr");break;case MoveColsCommand.id:case MoveRowsCommand.id:permission=this._permissionCheckByMoveCommand(params),errorMsg=this._localeService.t("permission.dialog.moveRowColErr");break;case MoveRangeCommand.id:permission=this._permissionCheckByMoveRangeCommand(params),errorMsg=this._localeService.t("permission.dialog.moveRangeErr");break;case SetWorksheetOrderCommand.id:permission=this._permissionCheckByWorksheetCommand([editable_WorkbookEditablePermission,WorkbookMoveSheetPermission]),errorMsg=this._localeService.t("permission.dialog.operatorSheetErr"),!1===permission&&this._worksheetProtectionRuleModel.resetOrder();break;case SetWorksheetNameCommand.id:permission=this._permissionCheckByWorksheetCommand([editable_WorkbookEditablePermission,WorkbookRenameSheetPermission]),errorMsg=this._localeService.t("permission.dialog.operatorSheetErr"),!1===permission&&this._worksheetProtectionRuleModel.resetOrder();break;case SetWorksheetShowCommand.id:{const{unitId,subUnitId}=params;permission=this._permissionCheckByWorksheetCommand([editable_WorkbookEditablePermission,WorkbookHideSheetPermission],unitId,subUnitId),errorMsg=this._localeService.t("permission.dialog.operatorSheetErr"),!1===permission&&this._worksheetProtectionRuleModel.resetOrder()}break;case SetSpecificColsVisibleCommand.id:permission=this.permissionCheckWithRanges({workbookTypes:[editable_WorkbookEditablePermission],rangeTypes:[edit_RangeProtectionPermissionEditPoint],worksheetTypes:[edit_WorksheetEditPermission,WorksheetSetColumnStylePermission]},params.ranges),errorMsg=this._localeService.t("permission.dialog.setRowColStyleErr");break;case SetSpecificRowsVisibleCommand.id:permission=this.permissionCheckWithRanges({workbookTypes:[editable_WorkbookEditablePermission],rangeTypes:[edit_RangeProtectionPermissionEditPoint],worksheetTypes:[edit_WorksheetEditPermission,WorksheetSetRowStylePermission]},params.ranges),errorMsg=this._localeService.t("permission.dialog.setRowColStyleErr");break;case SetSelectedColsVisibleCommand.id:permission=this.permissionCheckWithRanges({workbookTypes:[editable_WorkbookEditablePermission],rangeTypes:[edit_RangeProtectionPermissionEditPoint],worksheetTypes:[edit_WorksheetEditPermission,WorksheetSetColumnStylePermission]}),errorMsg=this._localeService.t("permission.dialog.setRowColStyleErr");break;case SetSelectedRowsVisibleCommand.id:permission=this.permissionCheckWithRanges({workbookTypes:[editable_WorkbookEditablePermission],rangeTypes:[edit_RangeProtectionPermissionEditPoint],worksheetTypes:[edit_WorksheetEditPermission,WorksheetSetRowStylePermission]}),errorMsg=this._localeService.t("permission.dialog.setRowColStyleErr");break;case InsertRangeMoveRightCommand.id:permission=this._permissionCheckWithInsertRangeMove("right"),errorMsg=this._localeService.t("permission.dialog.insertOrDeleteMoveRangeErr");break;case insert_range_move_down_command_InsertRangeMoveDownCommand.id:permission=this._permissionCheckWithInsertRangeMove("bottom"),errorMsg=this._localeService.t("permission.dialog.insertOrDeleteMoveRangeErr");break;case delete_range_move_left_command_DeleteRangeMoveLeftCommand.id:permission=this._permissionCheckWithInsertRangeMove("left"),errorMsg=this._localeService.t("permission.dialog.insertOrDeleteMoveRangeErr");break;case delete_range_move_up_command_DeleteRangeMoveUpCommand.id:permission=this._permissionCheckWithInsertRangeMove("top"),errorMsg=this._localeService.t("permission.dialog.insertOrDeleteMoveRangeErr")}permission||this.blockExecuteWithoutPermission(errorMsg)}_initialize(){this._commandExecutedListener()}_commandExecutedListener(){this.disposeWithMe(this._commandService.beforeCommandExecuted((command=>{this._getPermissionCheck(command.id,command?.params)}))),this.disposeWithMe(this._commandService.onCommandExecuted((command=>{if(command.id===SetWorksheetNameMutation.id){const params=command.params,{unitId=this._univerInstanceService.getCurrentUnitForType(src.Zy$.UNIVER_SHEET)?.getUnitId(),subUnitId}=params;if(!unitId||!subUnitId)return;const worksheetRule=this._worksheetProtectionRuleModel.getRule(unitId,subUnitId),selectionRuleList=this._rangeProtectionRuleModel.getSubunitRuleList(unitId,subUnitId);worksheetRule&&this._worksheetProtectionRuleModel.ruleRefresh(worksheetRule.permissionId),selectionRuleList.length&&this._rangeProtectionRuleModel.ruleRefresh(subUnitId)}})))}_permissionCheckWithInsertRangeMove(direction){const target=target_util_getSheetCommandTarget(this._univerInstanceService);if(!target)return!1;const{worksheet,unitId,subUnitId}=target,selectionRange=src.S0q.deepClone(this._selectionManagerService.getCurrentLastSelection()?.range);if(!selectionRange)return!1;"top"===direction||"bottom"===direction?selectionRange.endRow=worksheet.getRowCount()-1:"left"!==direction&&"right"!==direction||(selectionRange.endColumn=worksheet.getColumnCount()-1);return!this._rangeProtectionRuleModel.getSubunitRuleList(unitId,subUnitId).map((rule=>rule.ranges)).flat().some((range=>src.M_G.getIntersects(selectionRange,range)))}_permissionCheckByWorksheetCommand(types,targetUnitId,targetSubUnitId){const target=target_util_getSheetCommandTarget(this._univerInstanceService,{unitId:targetUnitId,subUnitId:targetSubUnitId});if(!target)return!1;const{unitId,subUnitId}=target,worksheetRule=this._worksheetProtectionRuleModel.getRule(unitId,subUnitId),selectionRule=this._rangeProtectionRuleModel.getSubunitRuleList(unitId,subUnitId).length>0;return worksheetRule||selectionRule?this._permissionService.getPermissionPoint(new WorkbookManageCollaboratorPermission(unitId).id)?.value??!1:this._permissionService.composePermission(types.map((F=>new F(unitId).id))).every((permission=>permission.value))}permissionCheckWithoutRange(permissionTypes){const target=target_util_getSheetCommandTarget(this._univerInstanceService);if(!target)return!1;const{worksheet,unitId,subUnitId}=target,selection=this._selectionManagerService.getCurrentLastSelection();if(!selection)return!0;const row=selection?.primary?.actualRow??0,col=selection?.primary?.actualColumn??0,{workbookTypes,worksheetTypes,rangeTypes}=permissionTypes;if(workbookTypes){if(!0===workbookTypes.some((F=>{const instance=new F(unitId);return!1===(this._permissionService.getPermissionPoint(instance.id)?.value??!1)})))return!1}if(worksheetTypes){if(!0===worksheetTypes.some((F=>{const instance=new F(unitId,subUnitId);return!1===(this._permissionService.getPermissionPoint(instance.id)?.value??!1)})))return!1}if(rangeTypes){if(!0===rangeTypes.some((F=>{const cellInfo=worksheet.getCell(row,col)?.selectionProtection?.[0];if(!cellInfo?.ruleId)return!1;const permissionId=this._rangeProtectionRuleModel.getRule(unitId,subUnitId,cellInfo.ruleId)?.permissionId;if(!permissionId)return!1;const instance=new F(unitId,subUnitId,permissionId);return!1===(this._permissionService.getPermissionPoint(instance.id)?.value??!1)})))return!1}return!0}permissionCheckWithRanges(permissionTypes,selectionRanges,unitId,subUnitId){const target=target_util_getSheetCommandTarget(this._univerInstanceService);if(!target)return!1;const{workbook,worksheet}=target;unitId||(unitId=workbook.getUnitId()),subUnitId||(subUnitId=worksheet.getSheetId());const ranges=selectionRanges??this._selectionManagerService.getCurrentSelections()?.map((selection=>selection.range));if(!ranges)return!1;const{workbookTypes,worksheetTypes,rangeTypes}=permissionTypes,permissionIds=[];return workbookTypes&&permissionIds.push(...workbookTypes.map((F=>new F(unitId).id))),worksheetTypes&&permissionIds.push(...worksheetTypes.map((F=>new F(unitId,subUnitId).id))),rangeTypes&&this._rangeProtectionRuleModel.getSubunitRuleList(unitId,subUnitId).forEach((rule=>{ranges.some((range=>rule.ranges.some((r=>src.M_G.intersects(r,range)))))&&permissionIds.push(...rangeTypes.map((F=>new F(unitId,subUnitId,rule.permissionId).id)))})),!permissionIds.length||this._permissionService.composePermission(permissionIds).every((permission=>permission.value))}_permissionCheckByMoveCommand(params){const target=target_util_getSheetCommandTarget(this._univerInstanceService);if(!target)return!1;const{worksheet,unitId,subUnitId}=target,toRange=params.toRange;toRange.endRow===worksheet.getRowCount()-1?toRange.endColumn=toRange.startColumn:toRange.endRow=toRange.startRow;const permissionLapRanges=this._rangeProtectionRuleModel.getSubunitRuleList(unitId,subUnitId).reduce(((p,c)=>[...p,...c.ranges]),[]).filter((range=>src.M_G.intersects(range,toRange)));return!(permissionLapRanges.length>0)&&(permissionLapRanges.forEach((range=>{for(let row=range.startRow;row<=range.endRow;row++)for(let col=range.startColumn;col<=range.endColumn;col++){const permission=worksheet.getCell(row,col)?.selectionProtection?.[0];if(!1===permission?.[es.pS.Edit])return!1}})),!0)}_permissionCheckByMoveRangeCommand(params){const target=target_util_getSheetCommandTarget(this._univerInstanceService);if(!target)return!1;const{worksheet,unitId,subUnitId}=target,toRange=params.toRange,permissionLapRanges=this._rangeProtectionRuleModel.getSubunitRuleList(unitId,subUnitId).reduce(((p,c)=>[...p,...c.ranges]),[]).filter((range=>src.M_G.intersects(range,toRange)));return!(permissionLapRanges.length>0)&&(permissionLapRanges.forEach((range=>{for(let row=range.startRow;row<=range.endRow;row++)for(let col=range.startColumn;col<=range.endColumn;col++){const permission=worksheet.getCell(row,col)?.selectionProtection?.[0];if(!1===permission?.[es.pS.Edit])return!1}})),!0)}_permissionCheckBySetRangeValue(permissionTypes,setRangeValueParams){let ranges=[];if(setRangeValueParams.range)ranges=[setRangeValueParams.range];else{ranges=[new src.hDc(setRangeValueParams.value).getDataRange()]}const{unitId,subUnitId}=setRangeValueParams;return this.permissionCheckWithRanges(permissionTypes,ranges,unitId,subUnitId)}_permissionCheckWithFormula(params){const value=params.value,range=params.range,formulaString=value.f;if(formulaString){const definedNameStr=formulaString.substring(1),workbook=this._univerInstanceService.getCurrentUnitForType(src.Zy$.UNIVER_SHEET),unitId=params.unitId??workbook.getUnitId(),definedName=this._definedNamesService.getValueByName(unitId,definedNameStr);if(definedName){let formulaOrRefString=definedName.formulaOrRefString;formulaOrRefString.startsWith(engine_formula_src.gm.EQUALS)&&(formulaOrRefString=formulaOrRefString.slice(1));const refRangesArr=formulaOrRefString.split(",");for(let i=0;i<refRangesArr.length;i++){const refRange=refRangesArr[i],sequenceGrid=(0,engine_formula_src.YJ)(refRange);if(sequenceGrid.sheetName){const targetSheet=workbook.getSheetBySheetName(sequenceGrid.sheetName);if(!targetSheet)return!0;const{startRow,endRow,startColumn,endColumn}=sequenceGrid.range;for(let i=startRow;i<=endRow;i++)for(let j=startColumn;j<=endColumn;j++){const permission=targetSheet.getCell(i,j)?.selectionProtection?.[0];if(!1===permission?.[es.pS.View])return!1}}}return!0}{const sequenceNodes=this._lexerTreeBuilder.sequenceNodesBuilder(formulaString);if(!sequenceNodes)return!0;for(let i=0;i<sequenceNodes.length;i++){const node=sequenceNodes[i];if("string"==typeof node||node.nodeType!==engine_formula_src.kx.REFERENCE)continue;const{token}=node,sequenceGrid=(0,engine_formula_src.YK)(token),workbook=sequenceGrid.unitId?this._univerInstanceService.getUnit(sequenceGrid.unitId):this._univerInstanceService.getCurrentUnitForType(src.Zy$.UNIVER_SHEET);if(!workbook)return!0;let targetSheet=sequenceGrid.sheetName?workbook.getSheetBySheetName(sequenceGrid.sheetName):workbook.getActiveSheet();const unitId=workbook.getUnitId();if(sequenceGrid.sheetName){if(targetSheet=workbook.getSheetBySheetName(sequenceGrid.sheetName),!targetSheet)return!0;const subUnitId=targetSheet?.getSheetId();if(!this._permissionService.getPermissionPoint(new WorksheetViewPermission(unitId,subUnitId).id))return!1}if(!targetSheet)return!0;const{startRow,endRow,startColumn,endColumn}=sequenceGrid.range;for(let i=startRow;i<=endRow;i++)for(let j=startColumn;j<=endColumn;j++){const permission=targetSheet.getCell(i,j)?.selectionProtection?.[0];if(!1===permission?.[es.pS.View])return!1}}return!0}}if(range){const target=target_util_getSheetCommandTarget(this._univerInstanceService);if(!target)return!1;const unitId=params.unitId||target.unitId,subunitId=params.subUnitId||target.subUnitId,permissionIds=this._rangeProtectionRuleModel.getSubunitRuleList(unitId,subunitId).filter((rule=>rule.ranges.some((ruleRange=>src.M_G.intersects(ruleRange,range))))).map((rule=>new edit_RangeProtectionPermissionEditPoint(unitId,subunitId,rule.permissionId).id));if(!this._permissionService.composePermission(permissionIds).every((permission=>permission.value)))return!1}return!0}}SheetPermissionCheckController=function sheet_permission_check_controller_ts_decorate(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r}([sheet_permission_check_controller_ts_param(0,src.wTY),sheet_permission_check_controller_ts_param(1,src.HCr),sheet_permission_check_controller_ts_param(2,src.QWp),sheet_permission_check_controller_ts_param(3,(0,src.y_5)(selection_service_SheetsSelectionsService)),sheet_permission_check_controller_ts_param(4,(0,src.y_5)(range_protection_rule_model_RangeProtectionRuleModel)),sheet_permission_check_controller_ts_param(5,(0,src.y_5)(WorksheetProtectionRuleModel)),sheet_permission_check_controller_ts_param(6,(0,src.y_5)(src.iH9)),sheet_permission_check_controller_ts_param(7,(0,src.y_5)(engine_formula_src.GM)),sheet_permission_check_controller_ts_param(8,src.oaf),sheet_permission_check_controller_ts_param(9,engine_formula_src.ke),sheet_permission_check_controller_ts_metadata("design:type",Function),sheet_permission_check_controller_ts_metadata("design:paramtypes",[void 0===src.wTY?Object:src.wTY,void 0===src.HCr?Object:src.HCr,void 0===src.QWp?Object:src.QWp,void 0===selection_service_SheetsSelectionsService?Object:selection_service_SheetsSelectionsService,void 0===range_protection_rule_model_RangeProtectionRuleModel?Object:range_protection_rule_model_RangeProtectionRuleModel,void 0===WorksheetProtectionRuleModel?Object:WorksheetProtectionRuleModel,void 0===src.iH9?Object:src.iH9,void 0===engine_formula_src.GM?Object:engine_formula_src.GM,void 0===src.oaf?Object:src.oaf,void 0===engine_formula_src.ke?Object:engine_formula_src.ke])],SheetPermissionCheckController);var filter=__webpack_require__("../../node_modules/.pnpm/rxjs@7.8.1/node_modules/rxjs/dist/esm5/internal/operators/filter.js");function range_protection_cache_ts_metadata(k,v){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(k,v)}function range_protection_cache_ts_param(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}}class RangeProtectionCache extends src.jGt{constructor(_ruleModel,_permissionService,_univerInstanceService){super(),this._ruleModel=_ruleModel,this._permissionService=_permissionService,this._univerInstanceService=_univerInstanceService,this._cellRuleCache=new Map,this._permissionIdCache=new Map,this._cellInfoCache=new Map,this._rowInfoCache=new Map,this._colInfoCache=new Map,this._initUpdateCellRuleCache(),this._initUpdateCellInfoCache(),this._initUpdateRowColInfoCache(),this._initCache()}_initCache(){this._univerInstanceService.getAllUnitsForType(src.Zy$.UNIVER_SHEET).forEach((workbook=>{workbook.getSheets().forEach((sheet=>{const unitId=workbook.getUnitId(),subUnitId=sheet.getSheetId();this.reBuildCache(unitId,subUnitId)}))}))}_initUpdateCellInfoCache(){this._permissionService.permissionPointUpdate$.pipe((0,filter.p)((permission=>permission.type===es._m.SelectRange)),(0,map.T)((permission=>permission))).subscribe((permission=>{const{subUnitId,unitId,permissionId}=permission,ruleId=this._permissionIdCache.get(permissionId);if(!ruleId)return;const ruleInstance=this._ruleModel.getRule(unitId,subUnitId,ruleId);if(!ruleInstance)return;const cellInfoMap=this._ensureCellInfoMap(unitId,subUnitId);ruleInstance.ranges.forEach((range=>{const{startRow,endRow,startColumn,endColumn}=range;for(let i=startRow;i<=endRow;i++)for(let j=startColumn;j<=endColumn;j++)cellInfoMap.delete(`${i}-${j}`)}))})),this._ruleModel.ruleChange$.subscribe((info=>{const{unitId,subUnitId}=info,cellInfoMap=this._ensureCellInfoMap(unitId,subUnitId);info.rule.ranges.forEach((range=>{src.Q6t.foreach(range,((row,col)=>{cellInfoMap.delete(`${row}-${col}`)}))})),"set"===info.type&&info.oldRule?.ranges.forEach((range=>{src.Q6t.foreach(range,((row,col)=>{this._cellInfoCache.delete(`${row}-${col}`)}))}))}))}_initUpdateCellRuleCache(){this._ruleModel.ruleChange$.subscribe((ruleChange=>{const{type}=ruleChange;"add"===type?this._addCellRuleCache(ruleChange):"delete"===type?this._deleteCellRuleCache(ruleChange):(this._deleteCellRuleCache({...ruleChange,rule:ruleChange.oldRule}),this._addCellRuleCache(ruleChange))}))}_ensureRuleMap(unitId,subUnitId){let subUnitMap=this._cellRuleCache.get(unitId);subUnitMap||(subUnitMap=new Map,this._cellRuleCache.set(unitId,subUnitMap));let cellMap=subUnitMap.get(subUnitId);return cellMap||(cellMap=new Map,subUnitMap.set(subUnitId,cellMap)),cellMap}_ensureCellInfoMap(unitId,subUnitId){let subUnitMap=this._cellInfoCache.get(unitId);subUnitMap||(subUnitMap=new Map,this._cellInfoCache.set(unitId,subUnitMap));let cellMap=subUnitMap.get(subUnitId);return cellMap||(cellMap=new Map,subUnitMap.set(subUnitId,cellMap)),cellMap}_ensureRowColInfoMap(unitId,subUnitId,type){let subUnitMap="row"===type?this._rowInfoCache.get(unitId):this._colInfoCache.get(unitId);subUnitMap||(subUnitMap=new Map,"row"===type?this._rowInfoCache.set(unitId,subUnitMap):this._colInfoCache.set(unitId,subUnitMap));let cellMap=subUnitMap.get(subUnitId);return cellMap||(cellMap=new Map,subUnitMap.set(subUnitId,cellMap)),cellMap}_addCellRuleCache(ruleChange){const{subUnitId,unitId,rule}=ruleChange,cellMap=this._ensureRuleMap(unitId,subUnitId);rule.ranges.forEach((range=>{const{startRow,endRow,startColumn,endColumn}=range;for(let i=startRow;i<=endRow;i++)for(let j=startColumn;j<=endColumn;j++)cellMap.set(`${i}-${j}`,rule.id)})),this._permissionIdCache.set(rule.permissionId,rule.id)}_deleteCellRuleCache(ruleChange){const{subUnitId,unitId,rule}=ruleChange,cellMap=this._ensureRuleMap(unitId,subUnitId),cellInfoMap=this._ensureCellInfoMap(unitId,subUnitId);rule.ranges.forEach((range=>{const{startRow,endRow,startColumn,endColumn}=range;for(let i=startRow;i<=endRow;i++)for(let j=startColumn;j<=endColumn;j++)cellMap.delete(`${i}-${j}`),cellInfoMap.delete(`${i}-${j}`)})),this._permissionIdCache.delete(rule.permissionId)}_getSelectionActions(unitId,subUnitId,rule){const edit=this._permissionService.getPermissionPoint(new edit_RangeProtectionPermissionEditPoint(unitId,subUnitId,rule.permissionId)?.id)?.value??!0,view=this._permissionService.getPermissionPoint(new RangeProtectionPermissionViewPoint(unitId,subUnitId,rule.permissionId)?.id)?.value??!0,manageProtection=this._permissionService.getPermissionPoint(new RangeProtectionPermissionManageCollaPoint(unitId,subUnitId,rule.permissionId)?.id)?.value??!1,deleteProtection=this._permissionService.getPermissionPoint(new RangeProtectionPermissionDeleteProtectionPoint(unitId,subUnitId,rule.permissionId)?.id)?.value??!1;return{[es.pS.Edit]:edit,[es.pS.View]:view,[es.pS.ManageCollaborator]:manageProtection,[es.pS.Delete]:deleteProtection}}reBuildCache(unitId,subUnitId){const cellRuleMap=this._ensureRuleMap(unitId,subUnitId),cellInfoMap=this._ensureCellInfoMap(unitId,subUnitId);cellRuleMap.clear(),cellInfoMap.clear();const rowInfoMap=this._ensureRowColInfoMap(unitId,subUnitId,"row"),colInfoMap=this._ensureRowColInfoMap(unitId,subUnitId,"col");rowInfoMap.clear(),colInfoMap.clear(),this._ruleModel.getSubunitRuleList(unitId,subUnitId).forEach((rule=>{const selectionActions=this._getSelectionActions(unitId,subUnitId,rule),selectionProtection={...selectionActions,ruleId:rule.id,ranges:rule.ranges};rule.ranges.forEach((range=>{const{startRow,endRow,startColumn,endColumn}=range;for(let i=startRow;i<=endRow;i++){const rowInfo=rowInfoMap.get(`${i}`);rowInfo?rowInfo.set(rule.id,selectionActions):rowInfoMap.set(`${i}`,new Map([[rule.id,selectionActions]]));for(let j=startColumn;j<=endColumn;j++){cellRuleMap.set(`${i}-${j}`,rule.id),cellInfoMap.set(`${i}-${j}`,selectionProtection);const colInfo=colInfoMap.get(`${j}`);colInfo?colInfo.set(rule.id,selectionActions):colInfoMap.set(`${j}`,new Map([[rule.id,selectionActions]]))}}})),this._permissionIdCache.set(rule.permissionId,rule.id)}))}getRowPermissionInfo(unitId,subUnitId,row,types){const rowInfo=this._rowInfoCache.get(unitId)?.get(subUnitId);if(!rowInfo)return!0;const info=rowInfo.get(`${row}`);return!info||types.every((type=>{for(const actionGroup of info.values())if(!1===actionGroup[type])return!1;return!0}))}getColPermissionInfo(unitId,subUnitId,col,types){const colInfo=this._colInfoCache.get(unitId)?.get(subUnitId);if(!colInfo)return!0;const info=colInfo.get(`${col}`);return!info||types.every((type=>{for(const actionGroup of info.values())if(!1===actionGroup[type])return!1;return!0}))}_initUpdateRowColInfoCache(){this._permissionService.permissionPointUpdate$.pipe((0,filter.p)((permission=>permission.type===es._m.SelectRange)),(0,map.T)((permission=>permission))).subscribe({next:permission=>{const{subUnitId,unitId,permissionId}=permission,ruleId=this._permissionIdCache.get(permissionId);if(!ruleId)return;const ruleInstance=this._ruleModel.getRule(unitId,subUnitId,ruleId);if(!ruleInstance)return;const rowInfoMap=this._ensureRowColInfoMap(unitId,subUnitId,"row"),colInfoMap=this._ensureRowColInfoMap(unitId,subUnitId,"col"),selectionActions=this._getSelectionActions(unitId,subUnitId,ruleInstance);ruleInstance.ranges.forEach((range=>{const{startRow,endRow,startColumn,endColumn}=range;for(let i=startRow;i<=endRow;i++){const rowInfo=rowInfoMap.get(`${i}`);rowInfo?rowInfo.set(ruleId,selectionActions):rowInfoMap.set(`${i}`,new Map([[ruleId,selectionActions]]));for(let j=startColumn;j<=endColumn;j++){const colInfo=colInfoMap.get(`${j}`);colInfo?colInfo.set(ruleId,selectionActions):colInfoMap.set(`${j}`,new Map([[ruleId,selectionActions]]))}}}))}}),this._ruleModel.ruleChange$.subscribe((info=>{if("delete"===info.type){const{unitId,subUnitId,rule}=info,rowInfoMap=this._ensureRowColInfoMap(unitId,subUnitId,"row"),colInfoMap=this._ensureRowColInfoMap(unitId,subUnitId,"col");rule.ranges.forEach((range=>{const{startRow,endRow,startColumn,endColumn}=range;for(let i=startRow;i<=endRow;i++){const rowInfo=rowInfoMap.get(`${i}`);rowInfo?.delete(rule.id);for(let j=startColumn;j<=endColumn;j++){const colInfo=colInfoMap.get(`${j}`);colInfo?.delete(rule.id)}}}))}}))}getCellInfo(unitId,subUnitId,row,col){const cellMap=this._ensureCellInfoMap(unitId,subUnitId),cacheValue=cellMap.get(`${row}-${col}`);if(cacheValue)return cacheValue;const ruleId=this._cellRuleCache.get(unitId)?.get(subUnitId)?.get(`${row}-${col}`);if(!ruleId)return;const rule=this._ruleModel.getRule(unitId,subUnitId,ruleId);if(rule){const selectionProtection={...this._getSelectionActions(unitId,subUnitId,rule),ruleId,ranges:rule.ranges};return cellMap.set(`${row}-${col}`,selectionProtection),selectionProtection}}deleteUnit(unitId){this._cellRuleCache.delete(unitId),this._cellInfoCache.delete(unitId),this._rowInfoCache.delete(unitId),this._colInfoCache.delete(unitId);const workbook=this._univerInstanceService.getUnit(unitId);workbook?.getSheets().forEach((sheet=>{const subUnitId=sheet.getSheetId();this._ruleModel.getSubunitRuleList(unitId,subUnitId).forEach((rule=>{this._permissionIdCache.delete(rule.permissionId)}))}))}}function sheet_permission_init_controller_ts_metadata(k,v){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(k,v)}function sheet_permission_init_controller_ts_param(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}}RangeProtectionCache=function range_protection_cache_ts_decorate(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r}([range_protection_cache_ts_param(0,(0,src.y_5)(range_protection_rule_model_RangeProtectionRuleModel)),range_protection_cache_ts_param(1,(0,src.y_5)(src.QWp)),range_protection_cache_ts_param(2,(0,src.y_5)(src.HCr)),range_protection_cache_ts_metadata("design:type",Function),range_protection_cache_ts_metadata("design:paramtypes",[void 0===range_protection_rule_model_RangeProtectionRuleModel?Object:range_protection_rule_model_RangeProtectionRuleModel,void 0===src.QWp?Object:src.QWp,void 0===src.HCr?Object:src.HCr])],RangeProtectionCache);class SheetPermissionInitController extends src.jGt{constructor(_univerInstanceService,_permissionService,_authzIoService,_rangeProtectionRuleModel,_worksheetProtectionRuleModel,_userManagerService,_worksheetProtectionPointRuleModel,_sheetInterceptorService,_undoRedoService,_commandService,_rangeProtectionCache){super(),this._univerInstanceService=_univerInstanceService,this._permissionService=_permissionService,this._authzIoService=_authzIoService,this._rangeProtectionRuleModel=_rangeProtectionRuleModel,this._worksheetProtectionRuleModel=_worksheetProtectionRuleModel,this._userManagerService=_userManagerService,this._worksheetProtectionPointRuleModel=_worksheetProtectionPointRuleModel,this._sheetInterceptorService=_sheetInterceptorService,this._undoRedoService=_undoRedoService,this._commandService=_commandService,this._rangeProtectionCache=_rangeProtectionCache}initPermission(){this._initRangePermissionFromSnapshot(),this._initRangePermissionChange(),this._initWorksheetPermissionFromSnapshot(),this._initWorksheetPermissionChange(),this._initWorksheetPermissionPointsChange(),this._initWorkbookPermissionFromSnapshot(),this._initUserChange(),this._refreshPermissionByCollaCreate()}async _initRangePermissionFromSnapshot(){const initRangePermissionFunc=async workbook=>{const allAllowedParams=[],unitId=workbook.getUnitId(),allSheets=workbook.getSheets(),permissionIdWithRuleInstanceMap=new Map;allSheets.forEach((sheet=>{const subunitId=sheet.getSheetId();this._rangeProtectionRuleModel.getSubunitRuleList(unitId,subunitId).forEach((rule=>{permissionIdWithRuleInstanceMap.set(rule.permissionId,rule),allAllowedParams.push({objectID:rule.permissionId,unitID:unitId,objectType:es._m.SelectRange,actions:baseProtectionActions})}))})),allAllowedParams.length?this._authzIoService.batchAllowed(allAllowedParams).then((permissionMap=>{permissionMap.forEach((item=>{const rule=permissionIdWithRuleInstanceMap.get(item.objectID);rule&&getAllRangePermissionPoint().forEach((F=>{const instance=new F(unitId,rule.subUnitId,item.objectID),unitActionName=instance.subType,result=item.actions.find((action=>action.action===unitActionName));void 0!==result?.allowed&&this._permissionService.updatePermissionPoint(instance.id,result.allowed)}))})),this._rangeProtectionRuleModel.changeRuleInitState(!0)})):this._rangeProtectionRuleModel.changeRuleInitState(!0)};await Promise.all(this._univerInstanceService.getAllUnitsForType(src.Zy$.UNIVER_SHEET).map((workbook=>initRangePermissionFunc(workbook)))),this._rangeProtectionRuleModel.changeRuleInitState(!0)}_initRangePermissionChange(){this.disposeWithMe(this._rangeProtectionRuleModel.ruleChange$.subscribe((info=>{if("delete"!==info.type)this._authzIoService.allowed({objectID:info.rule.permissionId,unitID:info.unitId,objectType:es._m.SelectRange,actions:baseProtectionActions}).then((actionList=>{getAllRangePermissionPoint().forEach((F=>{if("set"===info.type){const{rule,oldRule}=info;if(rule.permissionId===oldRule?.permissionId)return}const rule=info.rule,instance=new F(rule.unitId,rule.subUnitId,rule.permissionId),unitActionName=instance.subType,action=actionList.find((item=>item.action===unitActionName));action&&this._permissionService.updatePermissionPoint(instance.id,action.allowed)})),this._rangeProtectionRuleModel.ruleRefresh(info.rule.permissionId)}));else{0===this._rangeProtectionRuleModel.getSubunitRuleList(info.unitId,info.subUnitId).length&&(this._worksheetProtectionPointRuleModel.deleteRule(info.unitId,info.subUnitId),[...getAllWorksheetPermissionPointByPointPanel()].forEach((F=>{const instance=new F(info.unitId,info.subUnitId);this._permissionService.updatePermissionPoint(instance.id,instance.value)})))}})))}async initWorkbookPermissionChange(_unitId){const unitId=_unitId||this._univerInstanceService.getCurrentUnitForType(src.Zy$.UNIVER_SHEET)?.getUnitId();unitId&&this._authzIoService.allowed({objectID:unitId,objectType:es._m.Workbook,unitID:unitId,actions:defaultWorkbookPermissionPoints}).then((actionList=>{getAllWorkbookPermissionPoint().forEach((F=>{const instance=new F(unitId),unitActionName=instance.subType,action=actionList.find((item=>item.action===unitActionName));action&&this._permissionService.updatePermissionPoint(instance.id,action.allowed)}))}))}async _initWorkbookPermissionFromSnapshot(){await Promise.all(this._univerInstanceService.getAllUnitsForType(src.Zy$.UNIVER_SHEET).map((workbook=>this.initWorkbookPermissionChange(workbook.getUnitId()))))}_initWorksheetPermissionChange(){this.disposeWithMe(this._worksheetProtectionRuleModel.ruleChange$.subscribe((info=>{"delete"!==info.type?this._authzIoService.allowed({objectID:info.rule.permissionId,unitID:info.unitId,objectType:es._m.Worksheet,actions:baseProtectionActions}).then((actionList=>{getAllWorksheetPermissionPoint().forEach((F=>{const instance=new F(info.unitId,info.subUnitId),unitActionName=instance.subType,action=actionList.find((item=>item.action===unitActionName));action&&this._permissionService.updatePermissionPoint(instance.id,action.allowed)})),this._worksheetProtectionRuleModel.ruleRefresh(info.rule.permissionId)})):([...getAllWorksheetPermissionPoint(),...getAllWorksheetPermissionPointByPointPanel()].forEach((F=>{const instance=new F(info.unitId,info.subUnitId);this._permissionService.updatePermissionPoint(instance.id,!0)})),this._worksheetProtectionPointRuleModel.deleteRule(info.unitId,info.subUnitId))})))}_initWorksheetPermissionPointsChange(){this.disposeWithMe(this._worksheetProtectionPointRuleModel.pointChange$.subscribe((info=>{this._authzIoService.allowed({objectID:info.permissionId,unitID:info.unitId,objectType:es._m.Worksheet,actions:defaultWorksheetPermissionPoint}).then((actionList=>{getAllWorksheetPermissionPointByPointPanel().forEach((F=>{const instance=new F(info.unitId,info.subUnitId),unitActionName=instance.subType,action=actionList.find((item=>item.action===unitActionName));action&&this._permissionService.updatePermissionPoint(instance.id,action.allowed)}))}))})))}async _initWorksheetPermissionFromSnapshot(){const initSheetPermissionFunc=async workbook=>{const allAllowedParams=[],unitId=workbook.getUnitId(),allSheets=workbook.getSheets(),permissionIdWithRuleInstanceMap=new Map;allSheets.forEach((sheet=>{const subUnitId=sheet.getSheetId(),rule=this._worksheetProtectionRuleModel.getRule(unitId,subUnitId);rule&&(permissionIdWithRuleInstanceMap.set(rule.permissionId,rule),allAllowedParams.push({objectID:rule.permissionId,unitID:unitId,objectType:es._m.Worksheet,actions:baseProtectionActions}));const pointRule=this._worksheetProtectionPointRuleModel.getRule(unitId,subUnitId);pointRule&&(permissionIdWithRuleInstanceMap.set(pointRule.permissionId,pointRule),allAllowedParams.push({objectID:pointRule.permissionId,unitID:unitId,objectType:es._m.Worksheet,actions:defaultWorksheetPermissionPoint}))})),allAllowedParams.length?this._authzIoService.batchAllowed(allAllowedParams).then((permissionMap=>{permissionMap.forEach((item=>{const rule=permissionIdWithRuleInstanceMap.get(item.objectID);rule&&[...getAllWorksheetPermissionPoint(),...getAllWorksheetPermissionPointByPointPanel()].forEach((F=>{const instance=new F(unitId,rule.subUnitId),unitActionName=instance.subType,result=item.actions.find((action=>action.action===unitActionName));void 0!==result?.allowed&&this._permissionService.updatePermissionPoint(instance.id,result.allowed)}))})),this._worksheetProtectionRuleModel.changeRuleInitState(!0)})):this._worksheetProtectionRuleModel.changeRuleInitState(!0)};await Promise.all(this._univerInstanceService.getAllUnitsForType(src.Zy$.UNIVER_SHEET).map((workbook=>initSheetPermissionFunc(workbook)))),this._worksheetProtectionRuleModel.changeRuleInitState(!0)}_initUserChange(){this.disposeWithMe(this._userManagerService.currentUser$.pipe((0,skip.i)(1)).subscribe((()=>{const _map=this._permissionService.getAllPermissionPoint();this._permissionService.clearPermissionMap(),this._worksheetProtectionRuleModel.changeRuleInitState(!1);this._univerInstanceService.getAllUnitsForType(src.Zy$.UNIVER_SHEET).forEach((workbook=>{const unitId=workbook.getUnitId();getAllWorkbookPermissionPoint().forEach((F=>{let instance=new F(unitId);_map.has(instance.id)&&(instance=_map.get(instance.id)),this._permissionService.addPermissionPoint(instance)})),workbook.getSheets().forEach((sheet=>{const subUnitId=sheet.getSheetId();[...getAllWorksheetPermissionPoint(),...getAllWorksheetPermissionPointByPointPanel()].forEach((F=>{let instance=new F(unitId,subUnitId);_map.has(instance.id)&&(instance=_map.get(instance.id)),this._permissionService.addPermissionPoint(instance)}));this._rangeProtectionRuleModel.getSubunitRuleList(unitId,subUnitId).forEach((rule=>{getAllRangePermissionPoint().forEach((F=>{let instance=new F(unitId,subUnitId,rule.permissionId);_map.has(instance.id)&&(instance=_map.get(instance.id)),this._permissionService.addPermissionPoint(instance)}))}))})),this._initWorkbookPermissionFromSnapshot(),this._initWorksheetPermissionFromSnapshot(),this._initRangePermissionFromSnapshot()}))})))}refreshPermission(unitId,permissionId){const sheetRuleItem=this._worksheetProtectionRuleModel.getTargetByPermissionId(unitId,permissionId);let needClearUndoRedo=!1;if(sheetRuleItem){const[_,subUnitId]=sheetRuleItem;this._authzIoService.allowed({objectID:permissionId,unitID:unitId,objectType:es._m.Worksheet,actions:baseProtectionActions}).then((actionList=>{let key="";getAllWorksheetPermissionPoint().forEach((F=>{const instance=new F(unitId,subUnitId),unitActionName=instance.subType,action=actionList.find((item=>item.action===unitActionName));if(action){const originValue=this._permissionService.getPermissionPoint(instance.id)?.value;originValue!==action.allowed&&(needClearUndoRedo=!0),this._permissionService.updatePermissionPoint(instance.id,action.allowed),key+=`${action.action}_${action.allowed}`}})),this._worksheetProtectionRuleModel.ruleRefresh(`${permissionId}_${key}`),needClearUndoRedo&&this._undoRedoService.clearUndoRedo(unitId)}))}const sheetPointItem=this._worksheetProtectionPointRuleModel.getTargetByPermissionId(unitId,permissionId);if(sheetPointItem){const[_,subUnitId]=sheetPointItem;this._authzIoService.allowed({objectID:permissionId,unitID:unitId,objectType:es._m.Worksheet,actions:defaultWorksheetPermissionPoint}).then((actionList=>{getAllWorksheetPermissionPointByPointPanel().forEach((F=>{const instance=new F(unitId,subUnitId),unitActionName=instance.subType,action=actionList.find((item=>item.action===unitActionName));if(action){const originValue=this._permissionService.getPermissionPoint(instance.id)?.value;originValue!==action.allowed&&(needClearUndoRedo=!0),this._permissionService.updatePermissionPoint(instance.id,action.allowed)}})),needClearUndoRedo&&this._undoRedoService.clearUndoRedo(unitId)}))}const rangeRuleItem=this._rangeProtectionRuleModel.getTargetByPermissionId(unitId,permissionId);if(rangeRuleItem){const[_,subUnitId]=rangeRuleItem;this._authzIoService.allowed({objectID:permissionId,unitID:unitId,objectType:es._m.SelectRange,actions:baseProtectionActions}).then((actionList=>{let key="";getAllRangePermissionPoint().forEach((F=>{const instance=new F(unitId,subUnitId,permissionId),unitActionName=instance.subType,action=actionList.find((item=>item.action===unitActionName));if(action){const originValue=this._permissionService.getPermissionPoint(instance.id)?.value;originValue!==action.allowed&&(needClearUndoRedo=!0),this._permissionService.updatePermissionPoint(instance.id,action.allowed),key+=`${action.action}_${action.allowed}`}})),this._rangeProtectionRuleModel.ruleRefresh(`${permissionId}_${key}`),needClearUndoRedo&&this._undoRedoService.clearUndoRedo(unitId)}))}}_refreshPermissionByCollaCreate(){this.disposeWithMe(this._commandService.onCommandExecuted(((command,options)=>{if(options?.fromCollab&&(command.id===add_range_protection_mutation_AddRangeProtectionMutation.id||command.id===AddWorksheetProtectionMutation.id||command.id===SetWorksheetPermissionPointsMutation.id)){const params=command.params;this._undoRedoService.clearUndoRedo(params.unitId)}})))}}function sheet_permission_view_model_controller_ts_metadata(k,v){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(k,v)}function sheet_permission_view_model_controller_ts_param(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}}SheetPermissionInitController=function sheet_permission_init_controller_ts_decorate(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r}([sheet_permission_init_controller_ts_param(0,src.HCr),sheet_permission_init_controller_ts_param(1,src.QWp),sheet_permission_init_controller_ts_param(2,src.Jl7),sheet_permission_init_controller_ts_param(3,(0,src.y_5)(range_protection_rule_model_RangeProtectionRuleModel)),sheet_permission_init_controller_ts_param(4,(0,src.y_5)(WorksheetProtectionRuleModel)),sheet_permission_init_controller_ts_param(5,(0,src.y_5)(src.szM)),sheet_permission_init_controller_ts_param(6,(0,src.y_5)(WorksheetProtectionPointModel)),sheet_permission_init_controller_ts_param(7,(0,src.y_5)(SheetInterceptorService)),sheet_permission_init_controller_ts_param(8,(0,src.y_5)(src.$Dz)),sheet_permission_init_controller_ts_param(9,(0,src.y_5)(src.wTY)),sheet_permission_init_controller_ts_param(10,(0,src.y_5)(RangeProtectionCache)),sheet_permission_init_controller_ts_metadata("design:type",Function),sheet_permission_init_controller_ts_metadata("design:paramtypes",[void 0===src.HCr?Object:src.HCr,void 0===src.QWp?Object:src.QWp,void 0===src.Jl7?Object:src.Jl7,void 0===range_protection_rule_model_RangeProtectionRuleModel?Object:range_protection_rule_model_RangeProtectionRuleModel,void 0===WorksheetProtectionRuleModel?Object:WorksheetProtectionRuleModel,void 0===src.szM?Object:src.szM,void 0===WorksheetProtectionPointModel?Object:WorksheetProtectionPointModel,void 0===SheetInterceptorService?Object:SheetInterceptorService,void 0===src.$Dz?Object:src.$Dz,void 0===src.wTY?Object:src.wTY,void 0===RangeProtectionCache?Object:RangeProtectionCache])],SheetPermissionInitController);class SheetPermissionViewModelController extends src.jGt{constructor(_permissionService,_worksheetProtectionRuleModel,_sheetInterceptorService,_rangeProtectionCache){super(),this._permissionService=_permissionService,this._worksheetProtectionRuleModel=_worksheetProtectionRuleModel,this._sheetInterceptorService=_sheetInterceptorService,this._rangeProtectionCache=_rangeProtectionCache,this._initViewModelByRangeInterceptor(),this._initViewModelBySheetInterceptor()}_initViewModelByRangeInterceptor(){this.disposeWithMe(this._sheetInterceptorService.intercept(INTERCEPTOR_POINT.CELL_CONTENT,{priority:999,effect:src._w8.Value|src._w8.Style,handler:(cell={},context,next)=>{const{unitId,subUnitId,row,col}=context,selectionProtection=this._rangeProtectionCache.getCellInfo(unitId,subUnitId,row,col);if(selectionProtection){const isSkipRender=!1===selectionProtection[es.pS.View],_cellData={...cell,selectionProtection:[selectionProtection]};return isSkipRender?(delete _cellData.s,delete _cellData.v,delete _cellData.p,_cellData):next(_cellData)}return next(cell)}}))}_initViewModelBySheetInterceptor(){this.disposeWithMe(this._sheetInterceptorService.intercept(INTERCEPTOR_POINT.CELL_CONTENT,{priority:999,effect:src._w8.Value|src._w8.Style,handler:(cell={},context,next)=>{const{unitId,subUnitId}=context,worksheetRule=this._worksheetProtectionRuleModel.getRule(unitId,subUnitId);if(worksheetRule?.permissionId){const selectionProtection=[{[es.pS.View]:this._permissionService.getPermissionPoint(new WorksheetViewPermission(unitId,subUnitId).id)?.value??!1,[es.pS.Edit]:this._permissionService.getPermissionPoint(new edit_WorksheetEditPermission(unitId,subUnitId).id)?.value??!1}],isSkipRender=!selectionProtection[0]?.[es.pS.View],_cellData={...cell,hasWorksheetRule:!0,selectionProtection};return isSkipRender?(delete _cellData.s,delete _cellData.v,delete _cellData.p,_cellData):next(_cellData)}return next(cell)}}))}}function range_protection_render_model_ts_metadata(k,v){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(k,v)}function range_protection_render_model_ts_param(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}}SheetPermissionViewModelController=function sheet_permission_view_model_controller_ts_decorate(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r}([sheet_permission_view_model_controller_ts_param(0,src.QWp),sheet_permission_view_model_controller_ts_param(1,(0,src.y_5)(WorksheetProtectionRuleModel)),sheet_permission_view_model_controller_ts_param(2,(0,src.y_5)(SheetInterceptorService)),sheet_permission_view_model_controller_ts_param(3,(0,src.y_5)(RangeProtectionCache)),sheet_permission_view_model_controller_ts_metadata("design:type",Function),sheet_permission_view_model_controller_ts_metadata("design:paramtypes",[void 0===src.QWp?Object:src.QWp,void 0===WorksheetProtectionRuleModel?Object:WorksheetProtectionRuleModel,void 0===SheetInterceptorService?Object:SheetInterceptorService,void 0===RangeProtectionCache?Object:RangeProtectionCache])],SheetPermissionViewModelController);class RangeProtectionRenderModel{constructor(_selectionProtectionRuleModel,_permissionService){this._selectionProtectionRuleModel=_selectionProtectionRuleModel,this._permissionService=_permissionService,this._cache=new src.GcK(1e4),this._init()}_init(){this._permissionService.permissionPointUpdate$.pipe((0,filter.p)((permission=>permission.type===es._m.SelectRange)),(0,filter.p)((permission=>getAllRangePermissionPoint().some((F=>permission instanceof F)))),(0,map.T)((permission=>permission))).subscribe((permission=>{const ruleMap=this._selectionProtectionRuleModel.getSubunitRuleList(permission.unitId,permission.subUnitId);for(const rule of ruleMap)rule.permissionId===permission.permissionId&&rule.ranges.forEach((range=>{src.Q6t.foreach(range,((row,col)=>{const key=this._createKey(permission.unitId,permission.subUnitId,row,col);this._cache.delete(key)}))}))})),this._selectionProtectionRuleModel.ruleChange$.subscribe((info=>{info.rule.ranges.forEach((range=>{src.Q6t.foreach(range,((row,col)=>{const key=this._createKey(info.unitId,info.subUnitId,row,col);this._cache.delete(key)}))})),"set"===info.type&&info.oldRule?.ranges.forEach((range=>{src.Q6t.foreach(range,((row,col)=>{const key=this._createKey(info.unitId,info.subUnitId,row,col);this._cache.delete(key)}))}))}))}_createKey(unitId,subUnitId,row,col){return`${unitId}_${subUnitId}_${row}_${col}`}getCellInfo(unitId,subUnitId,row,col){const ruleMap=this._selectionProtectionRuleModel.getSubunitRuleList(unitId,subUnitId),defaultV=[];if(!ruleMap||!ruleMap.length)return defaultV;const key=this._createKey(unitId,subUnitId,row,col),cacheValue=this._cache.get(key);if(cacheValue)return cacheValue;const result=[];for(const rule of ruleMap)if(rule.ranges.some((range=>range.startRow<=row&&range.endRow>=row&&range.startColumn<=col&&range.endColumn>=col))){const permissionMap=getAllRangePermissionPoint().reduce(((result,F)=>{const instance=new F(unitId,subUnitId,rule.permissionId),permission=this._permissionService.getPermissionPoint(instance.id);return result[instance.subType]=permission?.value??instance.value,result}),{});result.push({...permissionMap,ruleId:rule.id,ranges:rule.ranges})}return this._cache.set(key,result),result}clear(){this._cache.clear()}}RangeProtectionRenderModel=function range_protection_render_model_ts_decorate(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r}([range_protection_render_model_ts_param(0,(0,src.y_5)(range_protection_rule_model_RangeProtectionRuleModel)),range_protection_render_model_ts_param(1,(0,src.y_5)(src.QWp)),range_protection_render_model_ts_metadata("design:type",Function),range_protection_render_model_ts_metadata("design:paramtypes",[void 0===range_protection_rule_model_RangeProtectionRuleModel?Object:range_protection_rule_model_RangeProtectionRuleModel,void 0===src.QWp?Object:src.QWp])],RangeProtectionRenderModel);const IExclusiveRangeService=(0,src.Qmd)("univer.exclusive-range-service");class ExclusiveRangeService extends src.jGt{_ensureUnitMap(unitId){return this._exclusiveRanges.has(unitId)||this._exclusiveRanges.set(unitId,new Map),this._exclusiveRanges.get(unitId)}_ensureSubunitMap(unitId,sheetId){const unitMap=this._ensureUnitMap(unitId);return unitMap.has(sheetId)||unitMap.set(sheetId,new Map),unitMap.get(sheetId)}_ensureFeature(unitId,sheetId,feature){const subunitMap=this._ensureSubunitMap(unitId,sheetId);return subunitMap.has(feature)||subunitMap.set(feature,[]),subunitMap.get(feature)}addExclusiveRange(unitId,sheetId,feature,ranges){const featureMap=this._ensureFeature(unitId,sheetId,feature);featureMap.push(...ranges),this._exclusiveRangesChange$.next({unitId,subUnitId:sheetId,ranges:featureMap.map((item=>item.range))})}getExclusiveRanges(unitId,sheetId,feature){return this._exclusiveRanges.get(unitId)?.get(sheetId)?.get(feature)}clearExclusiveRanges(unitId,sheetId,feature){const ranges=this.getExclusiveRanges(unitId,sheetId,feature);this._exclusiveRangesChange$.next({unitId,subUnitId:sheetId,ranges:ranges?.map((item=>item.range))||[]}),this._ensureFeature(unitId,sheetId,feature),this._exclusiveRanges.get(unitId).get(sheetId).set(feature,[])}clearExclusiveRangesByGroupId(unitId,sheetId,feature,groupId){const ranges=this.getExclusiveRanges(unitId,sheetId,feature);this._exclusiveRangesChange$.next({unitId,subUnitId:sheetId,ranges:ranges?.map((item=>item.range))||[]});const featureMap=this.getExclusiveRanges(unitId,sheetId,feature);if(featureMap){const newFeatureMap=featureMap.filter((item=>item.groupId!==groupId));this._exclusiveRanges.get(unitId).get(sheetId).set(feature,newFeatureMap)}}getInterestGroupId(selections){const interestGroupId=[];return selections.forEach((selection=>{const range=selection.range,{unitId,sheetId}=range;if(!unitId||!sheetId)return;const featureMap=this._exclusiveRanges.get(unitId)?.get(sheetId);if(featureMap)for(const feature of featureMap.keys()){const featureMapRanges=featureMap.get(feature);if(featureMapRanges)for(const featureMapRange of featureMapRanges)if(src.M_G.intersects(range,featureMapRange.range)){interestGroupId.push(feature);break}}})),interestGroupId}constructor(...args){super(...args),this._exclusiveRanges=new Map,this._exclusiveRangesChange$=new Subject.B,this.exclusiveRangesChange$=this._exclusiveRangesChange$.asObservable()}}function numfmt_service_ts_metadata(k,v){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(k,v)}function numfmt_service_ts_param(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}}class NumfmtService extends src.jGt{constructor(_resourceManagerService,_univerInstanceService,_logService){super(),this._resourceManagerService=_resourceManagerService,this._univerInstanceService=_univerInstanceService,this._logService=_logService}getValue(unitId,subUnitId,row,col){const workbook=this._univerInstanceService.getUniverSheetInstance(unitId);if(!workbook)return;const worksheet=workbook?.getSheetBySheetId(subUnitId);if(!worksheet)return;const styles=workbook.getStyles(),cell=worksheet.getCellRaw(row,col);if(cell?.s){const style=styles.get(cell.s);if(style?.n)return style.n}return null}deleteValues(unitId,subUnitId,values){const workbook=this._univerInstanceService.getUniverSheetInstance(unitId);if(!workbook)return;const worksheet=workbook?.getSheetBySheetId(subUnitId);if(!worksheet)return;const styles=workbook.getStyles();values.forEach((range=>{src.Q6t.foreach(range,((row,col)=>{const cell=worksheet.getCellRaw(row,col);if(!cell)return;const oldStyleId=cell?.s,newStyle={...oldStyleId&&styles.get(oldStyleId)||{}};delete newStyle.n;const newStyleId=styles.setValue(newStyle);cell.s=newStyleId}))}))}setValues(unitId,subUnitId,values){const workbook=this._univerInstanceService.getUniverSheetInstance(unitId);if(!workbook)return;const worksheet=workbook?.getSheetBySheetId(subUnitId);if(!worksheet)return;const styles=workbook.getStyles(),matrix=worksheet.getCellMatrix();values.forEach((value=>{value.ranges.forEach((range=>{src.Q6t.foreach(range,((row,col)=>{const cell=worksheet.getCellRaw(row,col);if(cell){const newStyle={...styles.getStyleByCell(cell)||{},n:{pattern:value.pattern}},styleId=styles.setValue(newStyle);cell.s=styleId}else{const style={n:{pattern:value.pattern}},styleId=styles.setValue(style);styleId&&matrix.setValue(row,col,{s:styleId})}}))}))}))}}function range_protection_ref_range_ts_metadata(k,v){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(k,v)}function range_protection_ref_range_ts_param(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}}NumfmtService=function numfmt_service_ts_decorate(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r}([numfmt_service_ts_param(0,src.Gvw),numfmt_service_ts_param(1,src.HCr),numfmt_service_ts_param(2,src.rrK),numfmt_service_ts_metadata("design:type",Function),numfmt_service_ts_metadata("design:paramtypes",[void 0===src.Gvw?Object:src.Gvw,void 0===src.HCr?Object:src.HCr,void 0===src.rrK?Object:src.rrK])],NumfmtService);const range_protection_ref_range_mutationIdByRowCol=[InsertColMutation.id,InsertRowMutation.id,RemoveColMutation.id,RemoveRowMutation.id],range_protection_ref_range_mutationIdArrByMove=[MoveRowsMutation.id,MoveColsMutation.id];class RangeProtectionRefRangeService extends src.jGt{constructor(_selectionProtectionRuleModel,_univerInstanceService,_commandService,_refRangeService,_selectionProtectionRenderModel,_rangeProtectionCache,_sheetInterceptorService,_rangeProtectionRuleModel){super(),this._selectionProtectionRuleModel=_selectionProtectionRuleModel,this._univerInstanceService=_univerInstanceService,this._commandService=_commandService,this._refRangeService=_refRangeService,this._selectionProtectionRenderModel=_selectionProtectionRenderModel,this._rangeProtectionCache=_rangeProtectionCache,this._sheetInterceptorService=_sheetInterceptorService,this._rangeProtectionRuleModel=_rangeProtectionRuleModel,this.disposableCollection=new src.VdD,this._onRefRangeChange(),this._correctPermissionRange(),this._initReBuildCache(),this._initRemoveSheet()}_onRefRangeChange(){const registerRefRange=(unitId,subUnitId)=>{const workbook=this._univerInstanceService.getCurrentUnitForType(src.Zy$.UNIVER_SHEET);if(!workbook)return;const workSheet=workbook?.getSheetBySheetId(subUnitId);if(!workSheet)return;this.disposableCollection.dispose();const handler=config=>this.refRangeHandle(config,unitId,subUnitId);this._selectionProtectionRuleModel.getSubunitRuleList(unitId,subUnitId).reduce(((p,c)=>[...p,...c.ranges]),[]).forEach((range=>{this.disposableCollection.add(this._refRangeService.registerRefRange(range,handler,unitId,subUnitId))}))};this.disposeWithMe(this._commandService.onCommandExecuted((commandInfo=>{if(commandInfo.id===SetWorksheetActivateCommand.id){const params=commandInfo.params,sheetId=params.subUnitId,unitId=params.unitId;if(!sheetId||!unitId)return;registerRefRange(unitId,sheetId)}if(commandInfo.id===SetRangeProtectionMutation.id||commandInfo.id===add_range_protection_mutation_AddRangeProtectionMutation.id){const params=commandInfo.params,subUnitId=params.subUnitId,unitId=params.unitId;if(!subUnitId||!unitId)return;registerRefRange(unitId,subUnitId)}})));const workbook=this._univerInstanceService.getCurrentUnitForType(src.Zy$.UNIVER_SHEET);if(workbook){const sheet=workbook.getActiveSheet();if(!sheet)return;registerRefRange(workbook.getUnitId(),sheet.getSheetId())}}refRangeHandle(config,unitId,subUnitId){switch(config.id){case MoveRowsCommand.id:return this._getRefRangeMutationsByMoveRows(config.params,unitId,subUnitId);case MoveColsCommand.id:return this._getRefRangeMutationsByMoveCols(config.params,unitId,subUnitId);case InsertRowCommand.id:return this._getRefRangeMutationsByInsertRows(config.params,unitId,subUnitId);case InsertColCommand.id:return this._getRefRangeMutationsByInsertCols(config.params,unitId,subUnitId);case RemoveColCommand.id:return this._getRefRangeMutationsByDeleteCols(config.params,unitId,subUnitId);case RemoveRowCommand.id:return this._getRefRangeMutationsByDeleteRows(config.params,unitId,subUnitId)}return{redos:[],undos:[]}}_getRefRangeMutationsByDeleteCols(params,unitId,subUnitId){const permissionRangeLapRules=this._selectionProtectionRuleModel.getSubunitRuleList(unitId,subUnitId).filter((rule=>rule.ranges.some((range=>src.M_G.intersects(range,params.range))))),removeRange=params.range;if(permissionRangeLapRules.length){const redoMutations=[],undoMutations=[];return permissionRangeLapRules.forEach((rule=>{const cloneRule=src.S0q.deepClone(rule),rangesByRemove=cloneRule.ranges.reduce(((p,c)=>{if(src.M_G.intersects(c,removeRange)){const cloneRange=src.S0q.deepClone(c),{startColumn,endColumn}=removeRange;if(startColumn<=cloneRange.startColumn&&endColumn>=cloneRange.endColumn)return p;startColumn>=cloneRange.startColumn&&endColumn<=cloneRange.endColumn?cloneRange.endColumn-=endColumn-startColumn+1:startColumn<cloneRange.startColumn?(cloneRange.startColumn=startColumn,cloneRange.endColumn-=endColumn-startColumn+1):endColumn>cloneRange.endColumn&&(cloneRange.endColumn=startColumn-1),this._checkIsRightRange(cloneRange)&&p.push(cloneRange)}return p}),[]);cloneRule.ranges=rangesByRemove,cloneRule.ranges.length?(redoMutations.push({id:SetRangeProtectionMutation.id,params:{unitId,subUnitId,rule:cloneRule,ruleId:rule.id}}),undoMutations.push({id:SetRangeProtectionMutation.id,params:{unitId,subUnitId,rule,ruleId:rule.id}})):(redoMutations.push({id:delete_range_protection_mutation_DeleteRangeProtectionMutation.id,params:{unitId,subUnitId,ruleIds:[rule.id]}}),undoMutations.push({id:add_range_protection_mutation_AddRangeProtectionMutation.id,params:{unitId,subUnitId,name:"",rules:[rule]}}))})),{redos:redoMutations,undos:undoMutations}}return{undos:[],redos:[]}}_getRefRangeMutationsByDeleteRows(params,unitId,subUnitId){const permissionRangeLapRules=this._selectionProtectionRuleModel.getSubunitRuleList(unitId,subUnitId).filter((rule=>rule.ranges.some((range=>src.M_G.intersects(range,params.range))))),removeRange=params.range;if(permissionRangeLapRules.length){const redoMutations=[],undoMutations=[];return permissionRangeLapRules.forEach((rule=>{const cloneRule=src.S0q.deepClone(rule),rangesByRemove=cloneRule.ranges.reduce(((p,c)=>{if(src.M_G.intersects(c,removeRange)){const cloneRange=src.S0q.deepClone(c),{startRow,endRow}=removeRange;if(startRow<=cloneRange.startRow&&endRow>=cloneRange.endRow)return p;startRow>=cloneRange.startRow&&endRow<=cloneRange.endRow?cloneRange.endRow-=endRow-startRow+1:startRow<cloneRange.startRow?(cloneRange.startRow=startRow,cloneRange.endRow-=endRow-startRow+1):endRow>cloneRange.endRow&&(cloneRange.endRow=startRow-1),this._checkIsRightRange(cloneRange)&&p.push(cloneRange)}return p}),[]);cloneRule.ranges=rangesByRemove,redoMutations.push({id:SetRangeProtectionMutation.id,params:{unitId,subUnitId,rule:cloneRule,ruleId:rule.id}}),undoMutations.push({id:SetRangeProtectionMutation.id,params:{unitId,subUnitId,rule,ruleId:rule.id}})})),{redos:redoMutations,undos:undoMutations}}return{undos:[],redos:[]}}_getRefRangeMutationsByInsertCols(params,unitId,subUnitId){const insertStart=params.range.startColumn,insertLength=params.range.endColumn-params.range.startColumn+1,permissionRangeLapRules=this._selectionProtectionRuleModel.getSubunitRuleList(unitId,subUnitId).filter((rule=>rule.ranges.some((range=>insertStart>range.startColumn&&insertStart<=range.endColumn))));if(permissionRangeLapRules.length){const redoMutations=[],undoMutations=[];return permissionRangeLapRules.forEach((rule=>{const cloneRule=src.S0q.deepClone(rule);let hasLap=!1;cloneRule.ranges.forEach((range=>{insertStart>range.startColumn&&insertStart<=range.endColumn&&(range.endColumn+=insertLength,hasLap=!0)})),hasLap&&(redoMutations.push({id:SetRangeProtectionMutation.id,params:{unitId,subUnitId,rule:cloneRule,ruleId:rule.id}}),undoMutations.push({id:SetRangeProtectionMutation.id,params:{unitId,subUnitId,rule,ruleId:rule.id}}))})),{redos:redoMutations,undos:undoMutations}}return{undos:[],redos:[]}}_getRefRangeMutationsByInsertRows(params,unitId,subUnitId){const insertStart=params.range.startRow,insertLength=params.range.endRow-params.range.startRow+1,permissionRangeLapRules=this._selectionProtectionRuleModel.getSubunitRuleList(unitId,subUnitId).filter((rule=>rule.ranges.some((range=>insertStart>range.startRow&&insertStart<=range.endRow))));if(permissionRangeLapRules.length){const redoMutations=[],undoMutations=[];return permissionRangeLapRules.forEach((rule=>{const cloneRule=src.S0q.deepClone(rule);let hasLap=!1;cloneRule.ranges.forEach((range=>{insertStart>range.startRow&&insertStart<=range.endRow&&(range.endRow+=insertLength,hasLap=!0)})),hasLap&&(redoMutations.push({id:SetRangeProtectionMutation.id,params:{unitId,subUnitId,rule:cloneRule,ruleId:rule.id}}),undoMutations.push({id:SetRangeProtectionMutation.id,params:{unitId,subUnitId,rule,ruleId:rule.id}}))})),{redos:redoMutations,undos:undoMutations}}return{undos:[],redos:[]}}_getRefRangeMutationsByMoveRows(params,unitId,subUnitId){const toRange=params.toRange,moveToStartRow=toRange.startRow,moveLength=toRange.endRow-toRange.startRow+1,permissionRangeLapRules=this._selectionProtectionRuleModel.getSubunitRuleList(unitId,subUnitId).filter((rule=>rule.ranges.some((range=>moveToStartRow>range.startRow&&moveToStartRow<=range.endRow))));if(permissionRangeLapRules.length){const redoMutations=[],undoMutations=[];return permissionRangeLapRules.forEach((rule=>{const cloneRule=src.S0q.deepClone(rule),moveFromStartRow=params.fromRange.startRow;let hasLap=!1;cloneRule.ranges.forEach((range=>{moveToStartRow>range.startRow&&moveToStartRow<=range.endRow&&(moveFromStartRow<range.startRow&&(range.startRow=range.startRow-moveLength,range.endRow=range.endRow-moveLength),range.endRow+=moveLength,hasLap=!0)})),hasLap&&(redoMutations.push({id:SetRangeProtectionMutation.id,params:{unitId,subUnitId,rule:cloneRule,ruleId:rule.id}}),undoMutations.push({id:SetRangeProtectionMutation.id,params:{unitId,subUnitId,rule,ruleId:rule.id}}))})),{redos:redoMutations,undos:undoMutations}}return{undos:[],redos:[]}}_getRefRangeMutationsByMoveCols(params,unitId,subUnitId){const toRange=params.toRange,moveToStartCol=toRange.startColumn,moveLength=toRange.endColumn-toRange.startColumn+1,permissionRangeLapRules=this._selectionProtectionRuleModel.getSubunitRuleList(unitId,subUnitId).filter((rule=>rule.ranges.some((range=>moveToStartCol>range.startColumn&&moveToStartCol<=range.endColumn))));if(permissionRangeLapRules.length){const redoMutations=[],undoMutations=[];return permissionRangeLapRules.forEach((rule=>{const cloneRule=src.S0q.deepClone(rule),moveFromStartCol=params.fromRange.startColumn;let hasLap=!1;cloneRule.ranges.forEach((range=>{moveToStartCol>range.startColumn&&moveToStartCol<=range.endColumn&&(moveFromStartCol<range.startColumn&&(range.startColumn=range.startColumn-moveLength,range.endColumn=range.endColumn-moveLength),range.endColumn+=moveLength,hasLap=!0)})),hasLap&&(redoMutations.push({id:SetRangeProtectionMutation.id,params:{unitId,subUnitId,rule:cloneRule,ruleId:rule.id}}),undoMutations.push({id:SetRangeProtectionMutation.id,params:{unitId,subUnitId,rule,ruleId:rule.id}}))})),{redos:redoMutations,undos:undoMutations}}return{undos:[],redos:[]}}_correctPermissionRange(){this.disposeWithMe(this._commandService.onCommandExecuted((command=>{if(range_protection_ref_range_mutationIdArrByMove.includes(command.id)){if(!command.params)return;const workbook=this._univerInstanceService.getCurrentUnitForType(src.Zy$.UNIVER_SHEET);if(!workbook)return;const worksheet=workbook.getSheetBySheetId(command.params.subUnitId);if(!worksheet)return;const{sourceRange,targetRange}=command.params,isRowMove=sourceRange.startColumn===targetRange.startColumn&&sourceRange.endColumn===targetRange.endColumn,moveLength=isRowMove?sourceRange.endRow-sourceRange.startRow+1:sourceRange.endColumn-sourceRange.startColumn+1,sourceStart=isRowMove?sourceRange.startRow:sourceRange.startColumn,targetStart=isRowMove?targetRange.startRow:targetRange.startColumn;this._selectionProtectionRuleModel.getSubunitRuleList(workbook.getUnitId(),worksheet.getSheetId()).forEach((rule=>{rule.ranges.forEach((range=>{let{startRow,endRow,startColumn,endColumn}=range;src.M_G.intersects(range,sourceRange)||(isRowMove?sourceStart<startRow&&targetStart>endRow?(startRow-=moveLength,endRow-=moveLength):sourceStart>endRow&&targetStart<=startRow&&(startRow+=moveLength,endRow+=moveLength):sourceStart<startColumn&&targetStart>endColumn?(startColumn-=moveLength,endColumn-=moveLength):sourceStart>endColumn&&targetStart<=startColumn&&(startColumn+=moveLength,endColumn+=moveLength)),this._checkIsRightRange({startRow,endRow,startColumn,endColumn})&&(range.startColumn=startColumn,range.endColumn=endColumn,range.startRow=startRow,range.endRow=endRow)}))})),this.disposableCollection.dispose();const{unitId,subUnitId}=command.params,handler=config=>this.refRangeHandle(config,unitId,subUnitId);this._selectionProtectionRuleModel.getSubunitRuleList(unitId,subUnitId).reduce(((p,c)=>[...p,...c.ranges]),[]).forEach((range=>{this.disposableCollection.add(this._refRangeService.registerRefRange(range,handler,unitId,subUnitId))})),this._selectionProtectionRenderModel.clear()}if(range_protection_ref_range_mutationIdByRowCol.includes(command.id)){const workbook=this._univerInstanceService.getUniverSheetInstance(command.params.unitId);if(!workbook)return;const worksheet=workbook.getSheetBySheetId(command.params.subUnitId);if(!worksheet)return;const params=command.params;if(!params)return;const{range}=params,isRowOperation=command.id.includes("row"),isAddOperation=command.id.includes("insert"),operationStart=isRowOperation?range.startRow:range.startColumn,operationEnd=isRowOperation?range.endRow:range.endColumn,operationCount=operationEnd-operationStart+1;this._selectionProtectionRuleModel.getSubunitRuleList(workbook.getUnitId(),worksheet.getSheetId()).forEach((rule=>{rule.ranges.forEach((range=>{let{startRow,endRow,startColumn,endColumn}=range;isAddOperation?isRowOperation?operationStart<=startRow&&(startRow+=operationCount,endRow+=operationCount):operationStart<=startColumn&&(startColumn+=operationCount,endColumn+=operationCount):isRowOperation?operationEnd<startRow&&(startRow-=operationCount,endRow-=operationCount):operationEnd<startColumn&&(startColumn-=operationCount,endColumn-=operationCount),this._checkIsRightRange({startRow,endRow,startColumn,endColumn})&&(range.startColumn=startColumn,range.endColumn=endColumn,range.startRow=startRow,range.endRow=endRow)}))})),this.disposableCollection.dispose();const{unitId,subUnitId}=command.params,handler=config=>this.refRangeHandle(config,unitId,subUnitId);this._selectionProtectionRuleModel.getSubunitRuleList(unitId,subUnitId).reduce(((p,c)=>[...p,...c.ranges]),[]).forEach((range=>{this.disposableCollection.add(this._refRangeService.registerRefRange(range,handler,unitId,subUnitId))})),this._selectionProtectionRenderModel.clear()}})))}_checkIsRightRange(range){return range.startRow<=range.endRow&&range.startColumn<=range.endColumn}_initReBuildCache(){this.disposeWithMe(this._commandService.onCommandExecuted((command=>{if(range_protection_ref_range_mutationIdByRowCol.includes(command.id)||range_protection_ref_range_mutationIdArrByMove.includes(command.id)){const{unitId,subUnitId}=command.params;this._rangeProtectionCache.reBuildCache(unitId,subUnitId)}})))}_initRemoveSheet(){this._sheetInterceptorService.interceptCommand({getMutations:commandInfo=>{const undos=[],preRedos=[];if(commandInfo.id===RemoveSheetCommand.id){const params=commandInfo.params,deleteRuleIds=[],addRuleArr=[];this._rangeProtectionRuleModel.getSubunitRuleList(params.unitId,params.subUnitId).forEach((rule=>{deleteRuleIds.push(rule.id),addRuleArr.push(rule)})),deleteRuleIds.length&&addRuleArr.length&&(preRedos.push({id:delete_range_protection_mutation_DeleteRangeProtectionMutation.id,params:{unitId:params.unitId,subUnitId:params.subUnitId,ruleIds:deleteRuleIds}}),undos.push({id:add_range_protection_mutation_AddRangeProtectionMutation.id,params:{unitId:params.unitId,subUnitId:params.subUnitId,name:"",rules:addRuleArr}}))}return{redos:[],undos,preRedos,preUndos:[]}}})}}function range_protection_service_ts_metadata(k,v){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(k,v)}function range_protection_service_ts_param(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}}RangeProtectionRefRangeService=function range_protection_ref_range_ts_decorate(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r}([range_protection_ref_range_ts_param(0,(0,src.y_5)(range_protection_rule_model_RangeProtectionRuleModel)),range_protection_ref_range_ts_param(1,(0,src.y_5)(src.HCr)),range_protection_ref_range_ts_param(2,src.wTY),range_protection_ref_range_ts_param(3,(0,src.y_5)(RefRangeService)),range_protection_ref_range_ts_param(4,(0,src.y_5)(RangeProtectionRenderModel)),range_protection_ref_range_ts_param(5,(0,src.y_5)(RangeProtectionCache)),range_protection_ref_range_ts_param(6,(0,src.y_5)(SheetInterceptorService)),range_protection_ref_range_ts_param(7,(0,src.y_5)(range_protection_rule_model_RangeProtectionRuleModel)),range_protection_ref_range_ts_metadata("design:type",Function),range_protection_ref_range_ts_metadata("design:paramtypes",[void 0===range_protection_rule_model_RangeProtectionRuleModel?Object:range_protection_rule_model_RangeProtectionRuleModel,void 0===src.HCr?Object:src.HCr,void 0===src.wTY?Object:src.wTY,void 0===RefRangeService?Object:RefRangeService,void 0===RangeProtectionRenderModel?Object:RangeProtectionRenderModel,void 0===RangeProtectionCache?Object:RangeProtectionCache,void 0===SheetInterceptorService?Object:SheetInterceptorService,void 0===range_protection_rule_model_RangeProtectionRuleModel?Object:range_protection_rule_model_RangeProtectionRuleModel])],RangeProtectionRefRangeService);class RangeProtectionService extends src.jGt{constructor(_selectionProtectionRuleModel,_permissionService,_resourceManagerService,_selectionProtectionCache,_univerInstanceService){super(),this._selectionProtectionRuleModel=_selectionProtectionRuleModel,this._permissionService=_permissionService,this._resourceManagerService=_resourceManagerService,this._selectionProtectionCache=_selectionProtectionCache,this._univerInstanceService=_univerInstanceService,this._initSnapshot(),this._initRuleChange()}_initRuleChange(){this.disposeWithMe(this._selectionProtectionRuleModel.ruleChange$.subscribe((info=>{switch(info.type){case"add":getAllRangePermissionPoint().forEach((F=>{const instance=new F(info.unitId,info.subUnitId,info.rule.permissionId);this._permissionService.addPermissionPoint(instance)}));break;case"delete":getAllRangePermissionPoint().forEach((F=>{const instance=new F(info.unitId,info.subUnitId,info.rule.permissionId);this._permissionService.deletePermissionPoint(instance.id)}));break;case"set":info.oldRule.permissionId!==info.rule.permissionId&&getAllRangePermissionPoint().forEach((F=>{const oldPermissionPoint=new F(info.unitId,info.subUnitId,info.oldRule.permissionId);this._permissionService.deletePermissionPoint(oldPermissionPoint.id);const newPermissionPoint=new F(info.unitId,info.subUnitId,info.rule.permissionId);this._permissionService.addPermissionPoint(newPermissionPoint)}))}})))}_initSnapshot(){this.disposeWithMe(this._resourceManagerService.registerPluginResource({toJson:unitID=>{const v=this._selectionProtectionRuleModel.toObject()[unitID];return v?JSON.stringify(v):""},parseJson:json=>{if(!json)return{};try{return JSON.parse(json)}catch(err){return{}}},pluginName:"SHEET_RANGE_PROTECTION_PLUGIN",businesses:[es.Wh.UNIVER_SHEET],onLoad:(unitId,resources)=>{const result=this._selectionProtectionRuleModel.toObject();result[unitId]=resources,this._selectionProtectionRuleModel.fromObject(result);const allAllowedParams=[];Object.keys(resources).forEach((subUnitId=>{const list=resources[subUnitId];this._selectionProtectionRuleModel.getSubunitRuleList(unitId,subUnitId).forEach((rule=>{allAllowedParams.push({objectID:rule.permissionId,unitID:unitId,objectType:es._m.SelectRange,actions:baseProtectionActions})})),list.forEach((rule=>{getAllRangePermissionPoint().forEach((Factor=>{const instance=new Factor(unitId,subUnitId,rule.permissionId);instance.value=!1,this._permissionService.addPermissionPoint(instance)}))})),this._selectionProtectionCache.reBuildCache(unitId,subUnitId)}))},onUnLoad:unitId=>{this._selectionProtectionCache.deleteUnit(unitId)}}))}}function workbook_permission_service_ts_metadata(k,v){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(k,v)}function workbook_permission_service_ts_param(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}}RangeProtectionService=function range_protection_service_ts_decorate(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r}([range_protection_service_ts_param(0,(0,src.y_5)(range_protection_rule_model_RangeProtectionRuleModel)),range_protection_service_ts_param(1,(0,src.y_5)(src.QWp)),range_protection_service_ts_param(2,(0,src.y_5)(src.Gvw)),range_protection_service_ts_param(3,(0,src.y_5)(RangeProtectionCache)),range_protection_service_ts_param(4,(0,src.y_5)(src.HCr)),range_protection_service_ts_metadata("design:type",Function),range_protection_service_ts_metadata("design:paramtypes",[void 0===range_protection_rule_model_RangeProtectionRuleModel?Object:range_protection_rule_model_RangeProtectionRuleModel,void 0===src.QWp?Object:src.QWp,void 0===src.Gvw?Object:src.Gvw,void 0===RangeProtectionCache?Object:RangeProtectionCache,void 0===src.HCr?Object:src.HCr])],RangeProtectionService);class WorkbookPermissionService extends src.jGt{constructor(_permissionService,_univerInstanceService,_rangeProtectionRuleModel,_worksheetProtectionRuleModel,_worksheetProtectionPointModel){super(),this._permissionService=_permissionService,this._univerInstanceService=_univerInstanceService,this._rangeProtectionRuleModel=_rangeProtectionRuleModel,this._worksheetProtectionRuleModel=_worksheetProtectionRuleModel,this._worksheetProtectionPointModel=_worksheetProtectionPointModel,this._init()}_init(){const handleWorkbook=workbook=>{const unitId=workbook.getUnitId();getAllWorkbookPermissionPoint().forEach((F=>{const instance=new F(unitId);this._permissionService.addPermissionPoint(instance)}))};this._univerInstanceService.getAllUnitsForType(src.Zy$.UNIVER_SHEET).forEach((workbook=>{handleWorkbook(workbook)})),this.disposeWithMe(this._univerInstanceService.getTypeOfUnitAdded$(src.Zy$.UNIVER_SHEET).subscribe((workbook=>{handleWorkbook(workbook)}))),this.disposeWithMe(this._univerInstanceService.getTypeOfUnitDisposed$(src.Zy$.UNIVER_SHEET).subscribe((workbook=>{const unitId=workbook.getUnitId();workbook.getSheets().forEach((worksheet=>{const subUnitId=worksheet.getSheetId();this._rangeProtectionRuleModel.getSubunitRuleList(unitId,subUnitId).forEach((rule=>{[...getAllRangePermissionPoint()].forEach((F=>{const instance=new F(unitId,subUnitId,rule.permissionId);this._permissionService.deletePermissionPoint(instance.id)}))})),[...getAllWorksheetPermissionPoint(),...getAllWorksheetPermissionPointByPointPanel()].forEach((F=>{const instance=new F(unitId,subUnitId);this._permissionService.deletePermissionPoint(instance.id)}))})),getAllWorkbookPermissionPoint().forEach((F=>{const instance=new F(unitId);this._permissionService.deletePermissionPoint(instance.id)})),this._rangeProtectionRuleModel.deleteUnitModel(unitId),this._worksheetProtectionPointModel.deleteUnitModel(unitId),this._worksheetProtectionRuleModel.deleteUnitModel(unitId)})))}}function range_theme_service_ts_metadata(k,v){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(k,v)}WorkbookPermissionService=function workbook_permission_service_ts_decorate(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r}([workbook_permission_service_ts_param(0,(0,src.y_5)(src.QWp)),workbook_permission_service_ts_param(1,(0,src.y_5)(src.HCr)),workbook_permission_service_ts_param(2,(0,src.y_5)(range_protection_rule_model_RangeProtectionRuleModel)),workbook_permission_service_ts_param(3,(0,src.y_5)(WorksheetProtectionRuleModel)),workbook_permission_service_ts_param(4,(0,src.y_5)(WorksheetProtectionPointModel)),workbook_permission_service_ts_metadata("design:type",Function),workbook_permission_service_ts_metadata("design:paramtypes",[void 0===src.QWp?Object:src.QWp,void 0===src.HCr?Object:src.HCr,void 0===range_protection_rule_model_RangeProtectionRuleModel?Object:range_protection_rule_model_RangeProtectionRuleModel,void 0===WorksheetProtectionRuleModel?Object:WorksheetProtectionRuleModel,void 0===WorksheetProtectionPointModel?Object:WorksheetProtectionPointModel])],WorkbookPermissionService);class SheetRangeThemeService extends src.jGt{constructor(_sheetRangeThemeModel){super(),this._sheetRangeThemeModel=_sheetRangeThemeModel}registerRangeTheme(unitId,rangeThemeStyle){this._sheetRangeThemeModel.registerRangeThemeStyle(unitId,rangeThemeStyle)}removeRangeThemeRule(themeName,rangeInfo){this._sheetRangeThemeModel.removeRangeThemeRule(themeName,rangeInfo)}getALLRegisterThemes(){return this._sheetRangeThemeModel.getALLRegisteredTheme()}registerRangeThemeStyle(themeName,rangeInfo){this._sheetRangeThemeModel.registerRangeThemeRule(themeName,rangeInfo)}getAppliedRangeThemeStyle(rangeInfo){return this._sheetRangeThemeModel.getRegisteredRangeThemeStyle(rangeInfo)}getRegisteredRangeThemes(){return this._sheetRangeThemeModel.getRegisteredRangeThemes()}}function skeleton_service_ts_metadata(k,v){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(k,v)}SheetRangeThemeService=function range_theme_service_ts_decorate(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r}([function range_theme_service_ts_param(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}}(0,(0,src.y_5)(SheetRangeThemeModel)),range_theme_service_ts_metadata("design:type",Function),range_theme_service_ts_metadata("design:paramtypes",[void 0===SheetRangeThemeModel?Object:SheetRangeThemeModel])],SheetRangeThemeService);class SheetSkeletonService extends src.jGt{constructor(_injector){super(),this._injector=_injector,this._sheetSkeletonStore=new Map,this.disposeWithMe((()=>{this._sheetSkeletonStore=new Map}))}getSkeleton(unitId,subUnitId){if(this._sheetSkeletonStore.has(unitId))return this._sheetSkeletonStore.get(unitId).get(subUnitId)}setSkeleton(unitId,subUnitId,skeleton){this._sheetSkeletonStore.has(unitId)||this._sheetSkeletonStore.set(unitId,new Map),this._sheetSkeletonStore.get(unitId).set(subUnitId,skeleton)}deleteSkeleton(unitId,subUnitId){this._sheetSkeletonStore.has(unitId)&&this._sheetSkeletonStore.get(unitId).delete(subUnitId)}}function sheets_plugin_ts_metadata(k,v){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(k,v)}function sheets_plugin_ts_param(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}}SheetSkeletonService=function skeleton_service_ts_decorate(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r}([function skeleton_service_ts_param(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}}(0,(0,src.y_5)(src.zZn)),skeleton_service_ts_metadata("design:type",Function),skeleton_service_ts_metadata("design:paramtypes",[void 0===src.zZn?Object:src.zZn])],SheetSkeletonService);class UniverSheetsPlugin extends src.k_1{static#_=this.pluginName="SHEET_PLUGIN";static#_2=this.type=src.Zy$.UNIVER_SHEET;constructor(_config=defaultPluginConfig,_injector,_configService){super(),this._config=_config,this._injector=_injector,this._configService=_configService;const{...rest}=(0,src.h1I)({},defaultPluginConfig,this._config);this._configService.setConfig("sheets.config",rest),this._initConfig(),this._initDependencies()}_initConfig(){this._config?.onlyRegisterFormulaRelatedMutations&&this._configService.setConfig("ONLY_REGISTER_FORMULA_RELATED_MUTATIONS_KEY",!0),this._config?.isRowStylePrecedeColumnStyle&&this._configService.setConfig(src._nk,!0),this._config?.autoHeightForMergedCells&&this._configService.setConfig(src.B3m,!0)}_initDependencies(){const dependencies=[[BorderStyleManagerService],[selection_service_SheetsSelectionsService],[RefRangeService],[WorkbookPermissionService],[INumfmtService,{useClass:NumfmtService}],[SheetInterceptorService],[SheetRangeThemeService],[SheetSkeletonService],[BasicWorksheetController],[MergeCellController],[NumberCellDisplayController],[DefinedNameDataController],[WorksheetPermissionService],[WorksheetProtectionRuleModel],[WorksheetProtectionPointModel],[SheetPermissionViewModelController],[SheetPermissionInitController],[SheetPermissionCheckController],[SheetRangeThemeModel],[RangeProtectionRenderModel],[range_protection_rule_model_RangeProtectionRuleModel],[RangeProtectionCache],[RangeProtectionRefRangeService],[RangeProtectionService],[IExclusiveRangeService,{useClass:ExclusiveRangeService,deps:[selection_service_SheetsSelectionsService]}]];this._config?.notExecuteFormula||dependencies.push([CalculateResultApplyController]),(0,src.tMf)(this._injector,(0,src.afw)(dependencies,this._config.override)),(0,src.HLP)(this._injector,[[SheetInterceptorService],[RangeProtectionService],[IExclusiveRangeService],[SheetPermissionInitController]])}onStarting(){(0,src.HLP)(this._injector,[[BasicWorksheetController],[MergeCellController],[WorkbookPermissionService],[WorksheetPermissionService],[SheetPermissionViewModelController],[SheetSkeletonService]])}onRendered(){(0,src.HLP)(this._injector,[[INumfmtService]])}onReady(){(0,src.HLP)(this._injector,[[CalculateResultApplyController],[DefinedNameDataController],[SheetRangeThemeModel],[NumberCellDisplayController],[RangeProtectionRenderModel],[RangeProtectionRefRangeService],[RefRangeService],[SheetPermissionCheckController]])}}UniverSheetsPlugin=function sheets_plugin_ts_decorate(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r}([(0,src.dCC)(engine_formula_src.LB),sheets_plugin_ts_param(1,(0,src.y_5)(src.zZn)),sheets_plugin_ts_param(2,src.J0C),sheets_plugin_ts_metadata("design:type",Function),sheets_plugin_ts_metadata("design:paramtypes",["undefined"==typeof Partial?Object:Partial,void 0===src.zZn?Object:src.zZn,void 0===src.J0C?Object:src.J0C])],UniverSheetsPlugin);const COMMAND_LISTENER_SKELETON_CHANGE=[SetWorksheetRowHeightMutation.id,SetWorksheetRowIsAutoHeightMutation.id,SetWorksheetRowAutoHeightMutation.id,SetWorksheetColWidthMutation.id,SetWorksheetActiveOperation.id,MoveRowsMutation.id,MoveColsMutation.id,SetColHiddenMutation.id,SetColVisibleMutation.id,SetRowHiddenMutation.id,SetRowVisibleMutation.id,InsertColMutation.id,InsertRowMutation.id,RemoveColMutation.id,RemoveRowMutation.id,ToggleGridlinesMutation.id,SetGridlinesColorMutation.id],COMMAND_LISTENER_VALUE_CHANGE=[SetRangeValuesMutation.id,MoveRangeMutation.id,RemoveWorksheetMergeMutation.id,AddWorksheetMergeMutation.id,ReorderRangeMutation.id,SetWorksheetDefaultStyleMutation.id,SetRowDataMutation.id,SetColDataMutation.id,SetWorksheetRangeThemeStyleMutation.id,DeleteWorksheetRangeThemeStyleMutation.id];const SELECTION_CONTROL_BORDER_BUFFER_WIDTH=1.5,SELECTION_CONTROL_BORDER_BUFFER_COLOR="rgba(255, 255, 255, 0.01)";function convertSelectionDataToRange(selectionWithCoordAndStyle){const{rangeWithCoord,primaryWithCoord,style}=selectionWithCoordAndStyle,result={range:{startRow:rangeWithCoord.startRow,startColumn:rangeWithCoord.startColumn,endRow:rangeWithCoord.endRow,endColumn:rangeWithCoord.endColumn,rangeType:rangeWithCoord.rangeType,unitId:rangeWithCoord.unitId,sheetId:rangeWithCoord.sheetId},primary:null,style};return null!=primaryWithCoord&&(result.primary=function convertPrimaryWithCoordToPrimary(primaryWithCoord){const{actualRow,actualColumn,isMerged,isMergedMainCell}=primaryWithCoord,{startRow,startColumn,endRow,endColumn}=primaryWithCoord.mergeInfo;return{actualRow,actualColumn,isMerged,isMergedMainCell,startRow,startColumn,endRow,endColumn}}(primaryWithCoord)),result}const AddMergeRedoSelectionsOperationFactory=(accessor,params,ranges)=>{const selectionsBeforeMutation=accessor.get(selection_service_SheetsSelectionsService).getCurrentSelections(),{value,selections,unitId,subUnitId}=params;if(selectionsBeforeMutation){const primaryBeforeMutation=selectionsBeforeMutation[selectionsBeforeMutation?.length-1].primary;if(primaryBeforeMutation){const{actualColumn,actualRow}=primaryBeforeMutation;let{startRow,startColumn,endRow,endColumn}=selections[selections.length-1];if(value===src.fgB.COLUMNS){const rangeByColumn=ranges.find((item=>item.startColumn===actualColumn&&item.endColumn===actualColumn&&actualRow===item.startRow));rangeByColumn&&(endColumn=rangeByColumn.endColumn,startRow=rangeByColumn.startRow,endRow=rangeByColumn.endRow)}else if(value===src.fgB.ROWS){const rangeByRow=ranges.find((item=>item.startRow===actualRow&&item.endRow===actualRow&&actualColumn===item.startColumn));rangeByRow&&(endRow=rangeByRow.endRow,startColumn=rangeByRow.startColumn,endColumn=rangeByRow.endColumn)}const primary={startRow,startColumn,endRow,endColumn,actualRow,actualColumn,isMerged:!0,isMergedMainCell:startRow===actualRow&&startColumn===actualColumn},selectionsByRedo=selectionsBeforeMutation.map(((selection,index,selections)=>({range:selection.range,style:null,primary:index===selections.length-1?primary:null}))),setSelectionsParamByRedo={unitId,subUnitId,type:SelectionMoveType.ONLY_SET,selections:selectionsByRedo};return{id:SetSelectionsOperation.id,params:setSelectionsParamByRedo}}return null}return null},AddMergeUndoSelectionsOperationFactory=(accessor,params)=>{const selectionsBeforeMutation=accessor.get(selection_service_SheetsSelectionsService).getCurrentSelections(),{unitId,subUnitId}=params;if(selectionsBeforeMutation){if(selectionsBeforeMutation[selectionsBeforeMutation?.length-1].primary){const setSelectionsParamByUndo={unitId,subUnitId,type:SelectionMoveType.ONLY_SET,selections:[...selectionsBeforeMutation]};return{id:SetSelectionsOperation.id,params:setSelectionsParamByUndo}}}return null};function expand_range_cellHasValue(cell){return null!=cell&&(void 0!==cell.v&&null!==cell.v&&""!==cell.v||void 0!==cell.p)}function hasValueFromMatrixWithSpanInfo(cell,matrix){return cell&&cell.spanAnchor?expand_range_cellHasValue(matrix.getValue(cell.spanAnchor.startRow,cell.spanAnchor.startColumn)):expand_range_cellHasValue(cell)}function getExpandedRangeLeft(range,allMatrixWithSpan,leftOffset,isWorksheetHasSpan){const{startRow,startColumn,endRow}=range;let spanAnchor=null,hasValue=!1;for(let i=startRow;i<=endRow;i++){const cell=allMatrixWithSpan.getValue(i,startColumn-leftOffset);if(hasValue=hasValue||hasValueFromMatrixWithSpanInfo(cell,allMatrixWithSpan),!isWorksheetHasSpan&&hasValue)break;cell&&cell.spanAnchor&&(spanAnchor=spanAnchor?{startRow:Math.min(cell.spanAnchor.startRow,spanAnchor.startRow),startColumn:Math.min(cell.spanAnchor.startColumn,spanAnchor.startColumn),endRow:Math.max(cell.spanAnchor.endRow,spanAnchor.endRow),endColumn:Math.max(cell.spanAnchor.endColumn,spanAnchor.endColumn)}:{startRow:cell.spanAnchor.startRow,startColumn:cell.spanAnchor.startColumn,endRow:cell.spanAnchor.endRow,endColumn:cell.spanAnchor.endColumn})}return hasValue?(range.startColumn=range.startColumn-leftOffset,{spanAnchor,hasValue:!0,range}):{spanAnchor:null,hasValue:!1,range}}function getExpandedRangeRight(range,allMatrixWithSpan,rightOffset,isWorksheetHasSpan){const{startRow,endColumn,endRow}=range;let spanAnchor=null,hasValue=!1;for(let i=startRow;i<=endRow;i++){const cell=allMatrixWithSpan.getValue(i,endColumn+rightOffset);if(hasValue=hasValue||hasValueFromMatrixWithSpanInfo(cell,allMatrixWithSpan),!isWorksheetHasSpan&&hasValue)break;cell&&cell.spanAnchor&&(spanAnchor=spanAnchor?{startRow:Math.min(cell.spanAnchor.startRow,spanAnchor.startRow),startColumn:Math.min(cell.spanAnchor.startColumn,spanAnchor.startColumn),endRow:Math.max(cell.spanAnchor.endRow,spanAnchor.endRow),endColumn:Math.max(cell.spanAnchor.endColumn,spanAnchor.endColumn)}:{startRow:cell.spanAnchor.startRow,startColumn:cell.spanAnchor.startColumn,endRow:cell.spanAnchor.endRow,endColumn:cell.spanAnchor.endColumn})}return hasValue?(range.endColumn=range.endColumn+rightOffset,{spanAnchor,hasValue:!0,range}):{spanAnchor:null,hasValue:!1,range}}function getExpandedRangeUp(range,allMatrixWithSpan,upOffset,isWorksheetHasSpan){const{startRow,startColumn,endColumn}=range;let spanAnchor=null,hasValue=!1;for(let i=startColumn;i<=endColumn;i++){const cell=allMatrixWithSpan.getValue(startRow-upOffset,i);if(hasValue=hasValue||hasValueFromMatrixWithSpanInfo(cell,allMatrixWithSpan),!isWorksheetHasSpan&&hasValue)break;cell&&cell.spanAnchor&&(spanAnchor=spanAnchor?{startRow:Math.min(cell.spanAnchor.startRow,spanAnchor.startRow),startColumn:Math.min(cell.spanAnchor.startColumn,spanAnchor.startColumn),endRow:Math.max(cell.spanAnchor.endRow,spanAnchor.endRow),endColumn:Math.max(cell.spanAnchor.endColumn,spanAnchor.endColumn)}:{startRow:cell.spanAnchor.startRow,startColumn:cell.spanAnchor.startColumn,endRow:cell.spanAnchor.endRow,endColumn:cell.spanAnchor.endColumn})}return hasValue?(range.startRow=range.startRow-upOffset,{spanAnchor,hasValue:!0,range}):{spanAnchor:null,hasValue:!1,range}}function getExpandedRangeDown(range,allMatrixWithSpan,downOffset,isWorksheetHasSpan){const{startColumn,endColumn,endRow}=range;let spanAnchor=null,hasValue=!1;for(let i=startColumn;i<=endColumn;i++){const cell=allMatrixWithSpan.getValue(endRow+downOffset,i);if(hasValue=hasValue||hasValueFromMatrixWithSpanInfo(cell,allMatrixWithSpan),!isWorksheetHasSpan&&hasValue)break;cell&&cell.spanAnchor&&(spanAnchor=spanAnchor?{startRow:Math.min(cell.spanAnchor.startRow,spanAnchor.startRow),startColumn:Math.min(cell.spanAnchor.startColumn,spanAnchor.startColumn),endRow:Math.max(cell.spanAnchor.endRow,spanAnchor.endRow),endColumn:Math.max(cell.spanAnchor.endColumn,spanAnchor.endColumn)}:{startRow:cell.spanAnchor.startRow,startColumn:cell.spanAnchor.startColumn,endRow:cell.spanAnchor.endRow,endColumn:cell.spanAnchor.endColumn})}return hasValue?(range.endRow=range.endRow+downOffset,{spanAnchor,hasValue:!0,range}):{spanAnchor:null,hasValue:!1,range}}function expand_range_expandToContinuousRange(startRange,directions,worksheet){const maxRow=worksheet.getMaxRows(),maxColumn=worksheet.getMaxColumns(),allMatrixWithSpan=function getMatrixWithSpanInfo(worksheet,startRow,startColumn,endRow,endColumn){const matrix=worksheet.getCellMatrix(),mergedCellsInRange=worksheet.getSpanModel().getMergedCellRange(startRow,startColumn,endRow,endColumn),returnCellMatrix=new src.hDc;return matrix.forValue(((row,col)=>{const v=matrix.getValue(row,col);v&&returnCellMatrix.setValue(row,col,v)})),mergedCellsInRange.forEach((mergedCell=>{const{startColumn,startRow,endColumn,endRow}=mergedCell;(0,src.bVi)(startRow,endRow,startColumn,endColumn).forEach(((row,col)=>{row===startRow&&col===startColumn&&returnCellMatrix.setValue(row,col,{...matrix.getValue(row,col),spanAnchor:{startRow,endRow,startColumn,endColumn}}),row===startRow&&col===startColumn||(returnCellMatrix.realDeleteValue(row,col),returnCellMatrix.setValue(row,col,{spanAnchor:{startRow,endRow,startColumn,endColumn}}))}))})),returnCellMatrix}(worksheet,0,0,maxRow-1,maxColumn-1),worksheetHasSpan=worksheet.getSnapshot().mergeData.length>0,{left,right,up,down}=directions;let changed=!0,destRange={...startRange};const spanAnchors=[];for(;changed;){if(changed=!1,up&&0!==destRange.startRow){const{hasValue,range,spanAnchor}=getExpandedRangeUp(destRange,allMatrixWithSpan,1,worksheetHasSpan);if(spanAnchor&&spanAnchors.push(spanAnchor),hasValue){destRange=range,changed=!0;continue}}if(down&&destRange.endRow!==maxRow-1){const{hasValue,range,spanAnchor}=getExpandedRangeDown(destRange,allMatrixWithSpan,1,worksheetHasSpan);if(spanAnchor&&spanAnchors.push(spanAnchor),hasValue){destRange=range,changed=!0;continue}}if(left&&0!==destRange.startColumn){const{hasValue,range,spanAnchor}=getExpandedRangeLeft(destRange,allMatrixWithSpan,1,worksheetHasSpan);if(spanAnchor&&spanAnchors.push(spanAnchor),hasValue){destRange=range,changed=!0;continue}}if(right&&destRange.endColumn!==maxColumn-1){const{hasValue,range,spanAnchor}=getExpandedRangeRight(destRange,allMatrixWithSpan,1,worksheetHasSpan);if(spanAnchor&&spanAnchors.push(spanAnchor),hasValue){destRange=range,changed=!0;continue}}}return spanAnchors.length>0&&(destRange=src.M_G.union(destRange,...spanAnchors)),destRange}function getClearContentMutationParamsForRanges(accessor,unitId,worksheet,ranges){const undos=[],redos=[],subUnitId=worksheet.getSheetId();return ranges.forEach((range=>{const redoMatrix=function getClearContentMutationParamForRange(worksheet,range){const{startRow,startColumn,endColumn,endRow}=range,cellMatrix=worksheet.getMatrixWithMergedCells(startRow,startColumn,endRow,endColumn,src.v2V.Intercepted),redoMatrix=new src.hDc;return cellMatrix.forValue(((row,col,cellData)=>{!cellData||row===startRow&&col===startColumn||redoMatrix.setValue(row,col,null)})),redoMatrix}(worksheet,range),redoMutationParams={unitId,subUnitId,cellValue:redoMatrix.getData()},undoMutationParams=SetRangeValuesUndoMutationFactory(accessor,redoMutationParams);undos.push({id:SetRangeValuesMutation.id,params:undoMutationParams}),redos.push({id:SetRangeValuesMutation.id,params:redoMutationParams})})),{undos,redos}}const AddWorksheetMergeCommand={type:src.g4t.COMMAND,id:"sheet.command.add-worksheet-merge",handler:(accessor,params)=>{const commandService=accessor.get(src.wTY),undoRedoService=accessor.get(src.$Dz),univerInstanceService=accessor.get(src.HCr),unitId=params.unitId,subUnitId=params.subUnitId,ranges=getAddMergeMutationRangeByType(params.selections,params.value),worksheet=univerInstanceService.getUniverSheetInstance(unitId).getSheetBySheetId(subUnitId),redoMutations=[],undoMutations=[],willRemoveSomeCell=function checkCellContentInRanges(worksheet,ranges){return ranges.some((range=>function checkCellContentInRange(worksheet,range){const{startRow,startColumn,endColumn,endRow}=range,cellMatrix=worksheet.getMatrixWithMergedCells(startRow,startColumn,endRow,endColumn);let someCellGoingToBeRemoved=!1;return cellMatrix.forValue(((row,col,cellData)=>{if(cellData&&(row!==startRow||col!==startColumn)&&worksheet.cellHasValue(cellData))return someCellGoingToBeRemoved=!0,!1})),someCellGoingToBeRemoved}(worksheet,range)))}(worksheet,ranges),removeMergeMutationParams={unitId,subUnitId,ranges},addMergeMutationParams={unitId,subUnitId,ranges};redoMutations.push({id:RemoveWorksheetMergeMutation.id,params:removeMergeMutationParams}),redoMutations.push({id:AddWorksheetMergeMutation.id,params:addMergeMutationParams});const undoRemoveMergeMutationParams=RemoveMergeUndoMutationFactory(accessor,removeMergeMutationParams),undoMutationParams=AddMergeUndoMutationFactory(accessor,addMergeMutationParams);if(undoMutations.push({id:RemoveWorksheetMergeMutation.id,params:undoMutationParams}),undoMutations.push({id:AddWorksheetMergeMutation.id,params:undoRemoveMergeMutationParams}),willRemoveSomeCell){const data=getClearContentMutationParamsForRanges(accessor,unitId,worksheet,ranges);redoMutations.unshift(...data.redos),undoMutations.push(...data.undos)}return!!(0,src.PkI)(redoMutations,commandService).result&&(undoRedoService.pushUndoRedo({unitID:unitId,undoMutations,redoMutations}),!0)}},AddWorksheetMergeAllCommand={type:src.g4t.COMMAND,id:"sheet.command.add-worksheet-merge-all",handler:async accessor=>{const commandService=accessor.get(src.wTY),selectionManagerService=accessor.get(selection_service_SheetsSelectionsService),selections=selectionManagerService.getCurrentSelections()?.map((s=>s.range));if(!selections?.length)return!1;const workbook=accessor.get(src.HCr).getCurrentUnitForType(src.Zy$.UNIVER_SHEET);if(!workbook)return!1;const workSheet=workbook.getActiveSheet();if(!workSheet)return!1;const unitId=workbook.getUnitId(),subUnitId=workSheet.getSheetId();return commandService.executeCommand(AddWorksheetMergeCommand.id,{selections,unitId,subUnitId})}},AddWorksheetMergeVerticalCommand={type:src.g4t.COMMAND,id:"sheet.command.add-worksheet-merge-vertical",handler:async accessor=>{const commandService=accessor.get(src.wTY),selectionManagerService=accessor.get(selection_service_SheetsSelectionsService),selections=selectionManagerService.getCurrentSelections()?.map((s=>s.range));if(!selections?.length)return!1;const workbook=accessor.get(src.HCr).getCurrentUnitForType(src.Zy$.UNIVER_SHEET);if(!workbook)return!1;const workSheet=workbook.getActiveSheet();if(!workSheet)return!1;const unitId=workbook.getUnitId(),subUnitId=workSheet.getSheetId();return commandService.executeCommand(AddWorksheetMergeCommand.id,{value:src.fgB.COLUMNS,selections,unitId,subUnitId})}},AddWorksheetMergeHorizontalCommand={type:src.g4t.COMMAND,id:"sheet.command.add-worksheet-merge-horizontal",handler:async accessor=>{const commandService=accessor.get(src.wTY),selectionManagerService=accessor.get(selection_service_SheetsSelectionsService),selections=selectionManagerService.getCurrentSelections()?.map((s=>s.range));if(!selections?.length)return!1;const workbook=accessor.get(src.HCr).getCurrentUnitForType(src.Zy$.UNIVER_SHEET);if(!workbook)return!1;const workSheet=workbook.getActiveSheet();if(!workSheet)return!1;const unitId=workbook.getUnitId(),subUnitId=workSheet.getSheetId();return commandService.executeCommand(AddWorksheetMergeCommand.id,{value:src.fgB.ROWS,selections,unitId,subUnitId})}};src.g4t.MUTATION,src.g4t.COMMAND}}]);